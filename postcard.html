<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pool Service Postcard Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@400;500;600;700;800;900&family=Poppins:wght@400;500;600;700;800;900&family=Montserrat:wght@400;500;600;700;800;900&family=Raleway:wght@400;500;600;700;800&family=Oswald:wght@400;500;600;700&family=Lora:wght@400;500;600;700&family=Roboto+Slab:wght@400;500;600;700;800;900&family=Merriweather:wght@400;700;900&family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Hide services checklist on front - moved to back per 80/20 visual rule */
    .postcard-front [ondblclick*="toggleLock('services')"],
    .postcard-front [ondblclick*="toggleLock(\\'services\\')"] {
      display: none !important;
    }

    /* Ensure all pool images display correctly */
    img { object-fit: cover; }
    img[src*="qr"], img[src*="logo"] { object-fit: contain; }

    /* Contenteditable styling - inherit alignment from parent */
    [contenteditable="true"] {
      text-align: inherit;
    }

    /* Headlines and sub-headlines - center only if not already styled */
    .postcard-front h1:not([style*="text-align"]),
    .postcard-front h2:not([style*="text-align"]),
    .postcard-back h1:not([style*="text-align"]) {
      text-align: center;
    }

    /* Prevent text breaking and overflow */
    .postcard-front, .postcard-back {
      word-wrap: break-word;
      overflow-wrap: break-word;
      position: relative;
    }

    /* All text must be fully visible â€” no truncation anywhere */
    .postcard-front [contenteditable="true"],
    .postcard-back [contenteditable="true"] {
      text-overflow: clip !important;
      max-width: 100%;
    }

    .postcard-front h1, .postcard-front h2,
    .postcard-back h1, .postcard-back h2,
    .postcard-front p, .postcard-back p,
    [contenteditable="true"] {
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
      max-width: 100%;
    }

    /* Postcard containers must clip content */
    .postcard-front,
    .postcard-back {
      overflow: hidden !important;
      position: relative !important;
    }

    .discount {
      word-wrap: break-word;
      overflow-wrap: break-word;
      z-index: 20 !important;
    }

    /* Front circular discount badges â€” fixed size */
    .postcard-front .discount[style*="border-radius: 50%"],
    .postcard-front .discount[style*="border-radius:50%"] {
      width: 80px !important;
      height: 80px !important;
      max-width: 80px !important;
      max-height: 80px !important;
      min-width: 65px !important;
      min-height: 65px !important;
      box-sizing: border-box !important;
      overflow: hidden !important;
    }

    /* Front rectangular discount badges â€” auto size */
    .postcard-front .discount:not([style*="border-radius: 50%"]):not([style*="border-radius:50%"]) {
      max-width: 140px !important;
      box-sizing: border-box !important;
      overflow: hidden !important;
    }

    /* Back-side discount badges â€” inline, no forced dimensions */
    .postcard-back .discount {
      box-sizing: border-box !important;
      overflow: hidden !important;
      flex-shrink: 0;
    }

    /* Text inside badges - scale to fit */
    .discount [contenteditable="true"],
    .discount span,
    .discount div {
      text-align: center !important;
      word-break: break-word !important;
      white-space: normal !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      line-height: 1.1 !important;
      max-width: 100% !important;
    }


    /* Badge text containers fill badge */
    .discount > span,
    .discount > div {
      width: 100% !important;
      height: auto !important;
    }

    /* Shield/badge containers */
    .postcard-front div[style*="border-radius"][style*="background"],
    .postcard-back div[style*="border-radius"][style*="background"] {
      overflow: hidden;
      min-width: fit-content;
    }

    /* Clip-path badges */
    .postcard-front div[style*="clip-path"],
    .postcard-back div[style*="clip-path"] {
      overflow: hidden;
    }

    /* Any element with transform */
    .postcard-front div[style*="transform"],
    .postcard-back div[style*="transform"] {
      overflow: hidden;
    }

    /* ===== FIX OVERLAPPING & POSITIONING ISSUES ===== */

    /* Ensure proper stacking order */
    .postcard-front > div,
    .postcard-back > div {
      position: relative;
    }

    /* Content layers should stack properly */
    .postcard-front [style*="position: absolute"],
    .postcard-back [style*="position: absolute"] {
      z-index: 1;
    }

    /* Text content should be above images */
    .postcard-front h1, .postcard-front h2, .postcard-front p,
    .postcard-back h1, .postcard-back h2, .postcard-back p {
      position: relative;
      z-index: 5;
    }

    /* Discount badges always on top */
    .postcard-front .discount,
    .postcard-back .discount,
    [data-movable="true"] {
      z-index: 25 !important;
      position: relative;
    }

    /* Contenteditable text containment */
    .postcard-front [contenteditable="true"],
    .postcard-back [contenteditable="true"] {
      min-height: 1em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
    }

    /* Headlines â€” clamp to 3 lines max */
    .postcard-front h1[contenteditable="true"],
    .postcard-back h1[contenteditable="true"] {
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      min-height: auto;
    }

    /* Flex containers clip overflow */
    .postcard-front [style*="display: flex"],
    .postcard-back [style*="display: flex"] {
      overflow: hidden;
    }

    /* Ensure CTA buttons are visible */
    .postcard-front [class*="cta"],
    .postcard-back [class*="cta"] {
      z-index: 15;
      position: relative;
    }

    /* Contact info visibility */
    .postcard-front [style*="font-weight: 800"],
    .postcard-back [style*="font-weight: 800"] {
      z-index: 10;
      position: relative;
    }

    /* Trust badges visibility */
    .postcard-front [style*="backdrop-filter"],
    .postcard-back [style*="backdrop-filter"] {
      z-index: 12;
    }

    /* Logo always visible */
    .postcard-front img[src*="logo"],
    .postcard-back img[src*="logo"],
    .postcard-front [style*="logo"],
    .postcard-back [style*="logo"] {
      z-index: 10;
      position: relative;
    }

    /* QR code visibility */
    .postcard-front [style*="qr"],
    .postcard-back [style*="qr"],
    .postcard-front img[src*="qr"],
    .postcard-back img[src*="qr"] {
      z-index: 10;
      position: relative;
    }

    /* Hide QR codes when disabled via class */
    .postcard.hide-qr img[src*="qr"],
    .postcard.hide-qr img[src*="QR"],
    .postcard.hide-qr img[src="qrcode.png"],
    .postcard.hide-qr [data-qr-container],
    .postcard-front.hide-qr img[src*="qr"],
    .postcard-front.hide-qr img[src*="QR"],
    .postcard-front.hide-qr img[src="qrcode.png"],
    .postcard-back.hide-qr img[src*="qr"],
    .postcard-back.hide-qr img[src*="QR"],
    .postcard-back.hide-qr img[src="qrcode.png"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      width: 0 !important;
      height: 0 !important;
    }

    /* Also hide parent containers of QR codes */
    .postcard.hide-qr div:has(> img[src*="qr"]),
    .postcard.hide-qr div:has(> img[src="qrcode.png"]),
    .postcard-front.hide-qr div:has(> img[src*="qr"]),
    .postcard-back.hide-qr div:has(> img[src*="qr"]) {
      display: none !important;
    }

    /* Watermark overlay */
    .watermark-overlay {
      position: absolute !important;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100 !important;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .watermark-overlay.diagonal {
      transform: rotate(-35deg);
    }

    .watermark-overlay span {
      font-size: 60px;
      font-weight: 900;
      color: rgba(255, 0, 0, 0.25);
      text-transform: uppercase;
      letter-spacing: 10px;
      white-space: nowrap;
    }

    .watermark-overlay.tiled {
      flex-wrap: wrap;
      transform: none;
    }

    .watermark-overlay.tiled span {
      font-size: 24px;
      margin: 20px;
    }

    /* Guarantee & Emergency badges */
    .guarantee-badge,
    .emergency-badge {
      position: absolute;
      z-index: 30 !important;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .guarantee-badge {
      bottom: 60px;
      right: 20px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }

    .emergency-badge {
      top: 20px;
      right: 100px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      animation: pulse-no-translate 2s infinite;
    }

    /* Referral box */
    .referral-box {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 25;
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    /* Bundle deal box */
    .bundle-deal-box {
      position: absolute;
      bottom: 60px;
      left: 20px;
      z-index: 24;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }

    /* Collapsible Tool Sections */
    .section-toggle {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-primary);
      border: none;
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .section-toggle:hover {
      background: var(--bg-secondary);
    }
    .toggle-arrow {
      transition: transform 0.2s;
    }
    .section-content {
      padding: 10px;
      background: var(--bg-secondary);
    }
    .mini-section {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    .mini-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: #202040;
      --accent: #0ea5e9;
      --accent-hover: #0284c7;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border: #334155;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      color: var(--text-primary);
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0;
    }

    /* Top Toolbar */
    .toolbar {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo svg {
      width: 28px;
      height: 28px;
      color: var(--accent);
    }

    .toolbar-center {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn svg {
      width: 16px;
      height: 16px;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text-primary);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #16a34a;
    }

    .btn-danger {
      background: transparent;
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .btn-icon {
      padding: 8px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .btn-icon:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text-primary);
    }

    /* Main Layout */
    .main-layout {
      display: flex;
      height: calc(100vh - 57px);
    }

    /* Sidebar */
    .sidebar {
      width: 320px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      flex-shrink: 0;
    }

    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    /* New Tabbed Sidebar */
    .sidebar-tabs {
      display: flex;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .sidebar-tab {
      flex: 1;
      padding: 12px 8px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      border-bottom: 2px solid transparent;
    }

    .sidebar-tab:hover {
      color: var(--text-secondary);
      background: rgba(255,255,255,0.02);
    }

    .sidebar-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: rgba(14, 165, 233, 0.05);
    }

    .sidebar-tab svg {
      width: 18px;
      height: 18px;
    }

    .sidebar-panel {
      display: none;
      padding: 16px;
      animation: fadeIn 0.2s ease;
    }

    .sidebar-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px currentColor; }
      50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
    }

    .panel-section {
      margin-bottom: 20px;
    }

    .panel-section:last-child {
      margin-bottom: 0;
    }

    .panel-section-title {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .panel-section-title svg {
      width: 12px;
      height: 12px;
    }

    /* Compact form elements */
    .compact-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .compact-row > * {
      flex: 1;
    }

    .compact-input {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      color: var(--text-primary);
      font-size: 12px;
    }

    .compact-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .compact-select {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      color: var(--text-primary);
      font-size: 12px;
    }

    .compact-label {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: block;
    }

    /* Quick action buttons */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 16px;
    }

    .quick-btn {
      padding: 10px 6px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 9px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .quick-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(14, 165, 233, 0.05);
    }

    .quick-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Color swatches compact */
    .color-swatches {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
    }

    .color-swatch {
      aspect-ratio: 1;
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.15s;
      border: 2px solid transparent;
    }

    .color-swatch:hover {
      transform: scale(1.15);
    }

    .color-swatch.selected {
      border-color: white;
      box-shadow: 0 0 0 2px var(--accent);
    }

    /* Compact image upload */
    .compact-upload {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg-primary);
      border: 1px dashed var(--border);
      border-radius: 6px;
      cursor: pointer;
    }

    .compact-upload:hover {
      border-color: var(--accent);
    }

    .compact-upload-preview {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .compact-upload-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .compact-upload-text {
      flex: 1;
    }

    .compact-upload-text p {
      font-size: 11px;
      color: var(--text-primary);
      margin: 0;
    }

    .compact-upload-text span {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* Legacy section support */
    .sidebar-section {
      border-bottom: 1px solid var(--border);
    }

    .section-header {
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s;
    }

    .section-header:hover {
      background: rgba(255,255,255,0.02);
    }

    .section-header h3 {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-header svg {
      width: 14px;
      height: 14px;
      transition: transform 0.2s;
    }

    .section-header.collapsed svg {
      transform: rotate(-90deg);
    }

    .section-content {
      padding: 0 16px 16px;
    }

    .section-content.collapsed {
      display: none;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 12px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .text-input, .select-input {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      color: var(--text-primary);
      font-size: 13px;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .text-input:focus, .select-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .text-input::placeholder {
      color: var(--text-muted);
    }

    /* Image Upload */
    .image-upload {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
      background: var(--bg-primary);
    }

    .image-upload:hover {
      border-color: var(--accent);
      background: rgba(14, 165, 233, 0.05);
    }

    .image-upload.has-image {
      padding: 8px;
      border-style: solid;
    }

    .image-upload img {
      max-width: 100%;
      max-height: 60px;
      border-radius: 4px;
    }

    .image-upload p {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 6px;
    }

    .image-upload .upload-icon {
      width: 32px;
      height: 32px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    /* Color Grid */
    .color-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 6px;
    }

    .color-swatch {
      aspect-ratio: 1;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s;
      position: relative;
    }

    .color-swatch:hover {
      transform: scale(1.1);
    }

    .color-swatch.active {
      border-color: white;
      box-shadow: 0 0 0 2px var(--accent);
    }

    /* Preview Area */
    .preview-area {
      flex: 1;
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .preview-toolbar {
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tabs {
      display: flex;
      gap: 4px;
      background: var(--bg-primary);
      padding: 4px;
      border-radius: 8px;
    }

    .tab {
      padding: 8px 20px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      background: transparent;
      color: var(--text-secondary);
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      background: var(--accent);
      color: white;
    }

    .preview-info {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .postcard-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: #0f0f1a;
      background-image:
        radial-gradient(circle at 1px 1px, var(--border) 1px, transparent 0);
      background-size: 20px 20px;
    }

    .postcard {
      width: 600px;
      height: 400px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 30px 60px rgba(0,0,0,0.5);
      position: relative;
      transition: width 0.3s, height 0.3s;
    }

    .postcard.hidden { display: none; }

    /* Postcard Size Options - Standard Direct Mail Sizes */
    .postcard.size-4x6 { width: 600px; height: 400px; }
    .postcard.size-4-25x6 { width: 600px; height: 425px; }
    .postcard.size-5x7 { width: 700px; height: 500px; }
    .postcard.size-5-5x8-5 { width: 680px; height: 440px; }
    .postcard.size-5x8-5 { width: 680px; height: 400px; }
    .postcard.size-4x9 { width: 675px; height: 300px; }
    .postcard.size-6x9 { width: 675px; height: 450px; }
    .postcard.size-6x11 { width: 733px; height: 400px; }

    /* Bleed & Safe Zone Guides */
    .postcard.show-bleed::before {
      content: '';
      position: absolute;
      inset: -12px;
      border: 12px solid rgba(255, 0, 0, 0.15);
      pointer-events: none;
      z-index: 1000;
      border-radius: 16px;
    }

    .postcard.show-safe-zone::after {
      content: '';
      position: absolute;
      inset: 25px;
      border: 2px dashed rgba(0, 150, 0, 0.6);
      pointer-events: none;
      z-index: 1000;
      border-radius: 4px;
    }

    /* USPS Clear Zone Guides */
    .usps-guides {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 1000;
      display: none;
    }
    .usps-guides.show {
      display: block;
    }
    .usps-zone {
      position: absolute;
      border: 2px dashed;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .usps-zone.addressing {
      border-color: rgba(220, 38, 38, 0.8);
      background: rgba(220, 38, 38, 0.1);
      color: rgba(220, 38, 38, 0.9);
    }
    .usps-zone.postage {
      border-color: rgba(37, 99, 235, 0.8);
      background: rgba(37, 99, 235, 0.1);
      color: rgba(37, 99, 235, 0.9);
    }
    .usps-zone.barcode {
      border-color: rgba(234, 88, 12, 0.8);
      background: rgba(234, 88, 12, 0.1);
      color: rgba(234, 88, 12, 0.9);
    }
    .usps-zone-label {
      background: white;
      padding: 2px 6px;
      border-radius: 3px;
      white-space: nowrap;
    }

    .bleed-label, .safe-label {
      position: absolute;
      font-size: 9px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      z-index: 1001;
      pointer-events: none;
    }

    .bleed-label {
      top: -24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.8);
      color: white;
    }

    .safe-label {
      bottom: 30px;
      right: 30px;
      background: rgba(0, 150, 0, 0.8);
      color: white;
    }

    /* Pulse animation for discount badges */
    @keyframes pulse {
      0%, 100% { transform: translateY(-50%) scale(1); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
      50% { transform: translateY(-50%) scale(1.03); box-shadow: 0 12px 35px rgba(0,0,0,0.4); }
    }
    @keyframes pulse-no-translate {
      0%, 100% { transform: scale(1); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
      50% { transform: scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
    }

    /* Rulers */
    .postcard-with-rulers {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .ruler {
      display: flex;
      font-size: 10px;
      color: #64748b;
      font-family: monospace;
    }

    .ruler-top {
      margin-left: 30px;
      width: 600px;
      justify-content: space-between;
      padding: 4px 0;
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent 99px,
        #475569 99px,
        #475569 100px
      );
      border-bottom: 2px solid #475569;
      margin-bottom: 4px;
    }

    .ruler-left {
      width: 26px;
      height: 400px;
      flex-direction: column;
      justify-content: space-between;
      padding: 0 4px;
      background: repeating-linear-gradient(
        180deg,
        transparent,
        transparent 99px,
        #475569 99px,
        #475569 100px
      );
      border-right: 2px solid #475569;
      margin-right: 4px;
      text-align: right;
    }

    .ruler-left span {
      transform: translateY(-5px);
    }

    .size-label {
      margin-top: 8px;
      margin-left: 30px;
      font-size: 12px;
      color: #94a3b8;
      font-weight: 600;
    }

    /* Dynamic Postcard Styles */
    .postcard-front,
    .postcard-back {
      width: 100%;
      height: 100%;
      display: flex;
      position: relative;
      overflow: visible;
      transform-origin: top left;
      transition: transform 0.2s ease;
    }

    /* Keep postcard wrapper clipped but allow inner content to be visible */
    .postcard {
      overflow: hidden;
    }

    .postcard-front > *,
    .postcard-back > * {
      position: relative;
      z-index: 2;
    }

    /* Content container inside postcard */
    .postcard-front > div:first-child,
    .postcard-back > div:first-child {
      overflow: visible;
    }

    /* Prevent text overflow in postcards */
    .postcard-front h1,
    .postcard-front h2,
    .postcard-front p,
    .postcard-front span,
    .postcard-back h1,
    .postcard-back h2,
    .postcard-back p,
    .postcard-back span {
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
      box-sizing: border-box;
      overflow: visible !important;
      text-overflow: clip !important;
    }

    /* Testimonial boxes - prevent text cutoff */
    .postcard-front div[style*="background: white"],
    .postcard-front div[style*="background:white"],
    .postcard-front div[style*="background: rgba(255"],
    .postcard-back div[style*="background: white"],
    .postcard-back div[style*="background:white"] {
      overflow: visible !important;
      min-height: auto;
    }

    .postcard-front div[style*="background: white"] p,
    .postcard-front div[style*="background:white"] p,
    .postcard-back div[style*="background: white"] p,
    .postcard-back div[style*="background:white"] p {
      overflow: visible !important;
      text-overflow: clip !important;
      white-space: normal !important;
      line-height: 1.3 !important;
    }

    /* Phone numbers - never truncate */
    .postcard-front p[contenteditable],
    .postcard-back p[contenteditable] {
      white-space: nowrap;
      overflow: visible !important;
    }

    /* Contact info containers */
    .postcard-front div[style*="font-weight: 800"],
    .postcard-front div[style*="font-weight:800"],
    .postcard-back div[style*="font-weight: 800"],
    .postcard-back div[style*="font-weight:800"] {
      overflow: visible !important;
      white-space: nowrap;
    }

    /* Ensure discount badges stay contained and visible */
    .postcard-front [data-movable="true"],
    .postcard-back [data-movable="true"] {
      z-index: 20 !important;
      box-sizing: border-box;
      flex-shrink: 0;
    }

    /* Headlines should not overlap with other content */
    .postcard-front h1 {
      line-height: 1.1;
      margin: 0;
      flex-shrink: 0;
    }

    /* Services list containment */
    .postcard-front [class*="services"] {
      flex-shrink: 1;
      min-height: 0;
    }

    /* Flex containers should have gap for spacing */
    .postcard-front > div > div[style*="flex-direction: column"] {
      gap: 8px;
    }

    /* Ensure elements don't shrink too much */
    .postcard-front img {
      flex-shrink: 0;
    }

    /* Logo images - consistent alignment across all layouts */
    .postcard-front img[src*="logo"],
    .postcard-back img[src*="logo"],
    .postcard-front img[src="logo.png"],
    .postcard-back img[src="logo.png"] {
      object-fit: contain;
      max-width: 100%;
      vertical-align: middle;
      flex-shrink: 0;
    }

    /* CTA buttons stay visible */
    .postcard-front [class*="cta"],
    .postcard-back [class*="cta"] {
      flex-shrink: 0;
    }

    /* Discount badges - only apply centering to circular badges */
    .postcard-front .discount[style*="border-radius: 50%"],
    .postcard-front .discount[style*="border-radius:50%"] {
      display: flex;
      flex-direction: column;
      text-align: center;
      justify-content: center;
      align-items: center;
    }
    .postcard-front .discount span,
    .postcard-front .discount div {
      text-align: center;
    }

    /* Hide QR codes when disabled */
    .postcard-front.hide-qr [data-qr-container],
    .postcard-back.hide-qr [data-qr-container] {
      display: none !important;
    }

    /* Bleed zone indicator */
    .bleed-zone {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 9px solid rgba(255, 0, 0, 0.3);
      pointer-events: none;
      z-index: 1000;
      box-sizing: border-box;
    }
    .bleed-zone::before {
      content: 'BLEED ZONE';
      position: absolute;
      top: 2px;
      left: 2px;
      font-size: 10px;
      color: rgba(255, 0, 0, 0.7);
      font-weight: bold;
    }

    /* Safe zone indicator */
    .safe-zone {
      position: absolute;
      top: 18px;
      left: 18px;
      right: 18px;
      bottom: 18px;
      border: 2px dashed rgba(0, 128, 0, 0.5);
      pointer-events: none;
      z-index: 1000;
      box-sizing: border-box;
    }
    .safe-zone::before {
      content: 'SAFE ZONE - Keep text inside';
      position: absolute;
      bottom: 2px;
      right: 2px;
      font-size: 10px;
      color: rgba(0, 128, 0, 0.8);
      font-weight: bold;
      background: rgba(255,255,255,0.8);
      padding: 1px 4px;
      border-radius: 2px;
    }

    /* Prevent content from overflowing postcard boundaries */
    .postcard-front > div {
      max-width: 100%;
      max-height: 100%;
      overflow: hidden;
    }

    /* Ensure headlines don't exceed container width */
    .postcard-front h1,
    .postcard-front h2 {
      max-width: 100%;
      text-overflow: ellipsis;
    }

    /* Contact info should stay on one line when possible */
    .postcard-front [style*="font-weight: 700"][contenteditable] {
      white-space: nowrap;
    }

    /* Ensure proper stacking order for layered elements */
    .postcard-front [style*="position: absolute"] {
      contain: layout;
    }

    /* Back of postcard - ensure no overflow */
    .postcard-back {
      overflow: hidden;
    }

    .postcard-back > div {
      max-width: 100%;
      max-height: 100%;
    }

    .postcard-back {
      width: 100%;
      height: 100%;
      background: white;
      padding: 24px;
      display: flex;
      position: relative;
      overflow: hidden;
    }

    .postcard-back > * {
      position: relative;
    }

    .postcard-back h1,
    .postcard-back h2,
    .postcard-back p,
    .postcard-back span {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .hidden-input { display: none; }

    [contenteditable="true"] {
      outline: none;
      border-radius: 4px;
    }

    [contenteditable="true"]:hover {
      outline: 2px dashed rgba(6, 182, 212, 0.5);
    }

    [contenteditable="true"]:focus {
      outline: 2px solid #06b6d4;
    }

    /* Lockable elements */
    .lockable {
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
    }

    .lockable:hover {
      outline: 2px dashed #f59e0b;
      outline-offset: 4px;
    }

    .lockable.locked {
      outline: 2px solid #f59e0b;
      outline-offset: 4px;
    }

    .lockable.locked::before {
      content: 'ðŸ”’';
      position: absolute;
      top: -8px;
      right: -8px;
      font-size: 14px;
      background: #f59e0b;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    /* Move mode styles */
    .move-mode-active [data-movable="true"] {
      cursor: move !important;
      outline: 2px dashed #3b82f6 !important;
      outline-offset: 2px;
      user-select: none;
    }

    .move-mode-active [data-movable="true"]:hover {
      outline: 2px solid #3b82f6 !important;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .move-mode-active [data-movable="true"].dragging {
      opacity: 0.85;
      outline: 3px solid #10b981 !important;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
      z-index: 1000 !important;
    }

    /* Disable lock interactions in move mode */
    .move-mode-active .lockable:hover {
      outline: none !important;
    }

    /* Move mode banner */
    .move-mode-banner {
      display: none;
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      padding: 10px 24px;
      border-radius: 30px;
      font-size: 13px;
      font-weight: 600;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
    }

    .move-mode-active .move-mode-banner {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .edit-mode-toggle {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
    }

    .edit-mode-toggle.active {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .lock-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1e293b;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      color: white;
      font-size: 13px;
      display: none;
      z-index: 100;
    }

    .lock-indicator.show { display: block; }

    .lock-indicator h4 {
      font-size: 12px;
      color: #f59e0b;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .lock-indicator ul {
      list-style: none;
      font-size: 11px;
      color: #94a3b8;
    }

    .lock-indicator li {
      padding: 4px 0;
    }

    /* Custom Color Picker */
    .color-picker-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .color-picker-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .color-picker-item label {
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .color-picker-item input[type="color"] {
      width: 100%;
      height: 36px;
      border: 2px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      background: var(--bg-card);
      padding: 2px;
    }

    .color-picker-item input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 2px;
    }

    .color-picker-item input[type="color"]::-webkit-color-swatch {
      border-radius: 4px;
      border: none;
    }

    /* Flip Animation */
    .postcard-flip-container {
      perspective: 1500px;
    }

    .postcard-flipper {
      position: relative;
      transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
    }

    .postcard-flipper.flipped {
      transform: rotateY(180deg);
    }

    .postcard-flipper .postcard {
      backface-visibility: hidden;
    }

    .postcard-flipper .postcard.back-side {
      position: absolute;
      top: 0;
      left: 0;
      transform: rotateY(180deg);
    }

    .flip-btn {
      background: linear-gradient(135deg, var(--accent), #6366f1);
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s;
    }

    .flip-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
    }

    /* Favorites System */
    .favorite-btn {
      background: transparent;
      border: 2px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }

    .favorite-btn:hover, .favorite-btn.favorited {
      border-color: #f59e0b;
      color: #f59e0b;
    }

    .favorite-btn.favorited svg {
      fill: #f59e0b;
    }

    .favorites-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      min-width: 250px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      display: none;
    }

    .favorites-dropdown.show {
      display: block;
    }

    .favorites-dropdown-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 13px;
      color: var(--text-primary);
    }

    .favorites-item {
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .favorites-item:hover {
      background: var(--bg-secondary);
    }

    .favorites-item-name {
      font-size: 12px;
      color: var(--text-primary);
    }

    .favorites-item-remove {
      color: var(--danger);
      opacity: 0.6;
      cursor: pointer;
    }

    .favorites-item-remove:hover {
      opacity: 1;
    }

    /* Image Filters */
    .filter-slider-group {
      margin-bottom: 12px;
    }

    .filter-slider-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .filter-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      appearance: none;
      cursor: pointer;
    }

    .filter-slider::-webkit-slider-thumb {
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    /* Share Design Link */
    .share-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .share-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .share-modal-content {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      border: 1px solid var(--border);
    }

    .share-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .share-modal-header h3 {
      font-size: 18px;
      color: var(--text-primary);
    }

    .share-modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 24px;
    }

    .share-url-box {
      display: flex;
      gap: 8px;
    }

    .share-url-input {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 12px;
    }

    .copy-btn {
      padding: 12px 20px;
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .copy-btn.copied {
      background: var(--success);
    }

    /* Bulk Text Replace */
    .bulk-replace-section {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }

    .bulk-replace-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .bulk-replace-row input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 12px;
    }

    .bulk-replace-btn {
      padding: 8px 16px;
      background: var(--accent);
      border: none;
      border-radius: 4px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
    }

    /* Design Tips Panel */
    .tips-panel {
      position: fixed;
      right: -320px;
      top: 60px;
      width: 300px;
      height: calc(100vh - 60px);
      background: var(--bg-card);
      border-left: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
      transition: right 0.3s ease;
      z-index: 500;
    }

    .tips-panel.show {
      right: 0;
    }

    .tips-toggle {
      position: fixed;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      background: var(--accent);
      border: none;
      padding: 12px 8px;
      border-radius: 8px 0 0 8px;
      color: white;
      cursor: pointer;
      z-index: 501;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-weight: 600;
      font-size: 11px;
      letter-spacing: 1px;
    }

    .tips-panel.show + .tips-toggle {
      right: 300px;
    }

    .tip-card {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 12px;
      border-left: 3px solid var(--accent);
    }

    .tip-card h4 {
      font-size: 13px;
      color: var(--text-primary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tip-card p {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .tip-stat {
      display: inline-block;
      background: var(--accent);
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 700;
      font-size: 10px;
      margin-left: 4px;
    }

    /* Compare Mode */
    .compare-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .compare-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .compare-header {
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 20px;
      align-items: center;
    }

    .compare-header h3 {
      color: white;
      font-size: 18px;
    }

    .compare-close {
      position: absolute;
      right: 20px;
      background: none;
      border: none;
      color: white;
      font-size: 32px;
      cursor: pointer;
    }

    .compare-container {
      display: flex;
      gap: 40px;
      align-items: center;
    }

    .compare-card {
      text-align: center;
    }

    .compare-card-label {
      color: white;
      font-size: 14px;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .compare-card .postcard {
      transform: scale(0.85);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .compare-vs {
      font-size: 32px;
      font-weight: 900;
      color: var(--accent);
      text-shadow: 0 0 20px var(--accent);
    }

    /* Print Styles */
    @media print {
      body { background: white; padding: 0; }
      .header, .sidebar, .tabs, .postcard-wrapper, .lock-indicator { display: none !important; }
      .postcard {
        border-radius: 0;
        box-shadow: none;
        page-break-after: always;
        display: block !important;
      }
      .postcard.hidden { display: block !important; }
      .lockable::before { display: none !important; }
      .lockable { outline: none !important; }
      @page { size: 6in 4in; margin: 0; }
    }

    @media (max-width: 1000px) {
      .main-layout { flex-direction: column; }
      .sidebar { width: 100%; max-height: none; }
      .postcard-wrapper { overflow-x: auto; }
    }

    @media (max-width: 768px) {
      .sidebar { padding: 12px; }
      .postcard-wrapper { transform: scale(0.7); transform-origin: top center; }
    }

    @media (max-width: 480px) {
      .postcard-wrapper { transform: scale(0.5); transform-origin: top center; }
      .sidebar { font-size: 13px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="4" width="20" height="16" rx="2"/>
            <path d="M2 8h20"/>
          </svg>
          Postcard Pro
        </div>
        <div style="height: 24px; width: 1px; background: var(--border);"></div>
        <select id="postcardSize" class="select-input" onchange="changePostcardSize(this.value)" style="width: auto; margin: 0; padding: 8px 12px;" title="Vistaprint Mailing Services Sizes">
          <option value="4x6">4Ã—6"</option>
          <option value="4-25x5-5">4.25Ã—5.5"</option>
          <option value="5x7">5Ã—7"</option>
          <option value="5-5x8-5">5.5Ã—8.5"</option>
          <option value="6x9" selected>6Ã—9"</option>
        </select>
      </div>

      <div class="toolbar-center">
        <button class="btn btn-secondary" id="historyBackBtn" onclick="goBack()" disabled style="opacity: 0.5;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back
        </button>
        <button class="btn btn-primary" onclick="generateNew()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>
          </svg>
          Generate New
        </button>
        <button class="btn btn-secondary" id="historyForwardBtn" onclick="goForward()" disabled style="opacity: 0.5;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
          Forward
        </button>
        <button class="btn btn-secondary" onclick="unlockAll()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2"/>
            <path d="M7 11V7a5 5 0 0 1 9.9-1"/>
          </svg>
          Unlock All
        </button>
        <button class="btn btn-secondary edit-mode-toggle" id="editModeBtn" onclick="toggleEditMode()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 3l14 9-14 9V3z" style="display:none" id="playIcon"/>
            <path d="M12 5v14M5 12h14" id="moveIcon"/>
          </svg>
          <span id="editModeText">Move</span>
        </button>
      </div>

      <div class="toolbar-right">
        <!-- Favorites Button -->
        <div style="position: relative;">
          <button class="favorite-btn" id="favoritesBtn" onclick="toggleFavoritesDropdown()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
            <span id="favoritesCount">0</span>
          </button>
          <div class="favorites-dropdown" id="favoritesDropdown">
            <div class="favorites-dropdown-header">Saved Favorites</div>
            <div id="favoritesList"></div>
          </div>
        </div>
        <!-- Save Current as Favorite -->
        <button class="btn btn-secondary" onclick="saveToFavorites()" title="Save Current Design">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
        </button>
        <!-- Compare Button -->
        <button class="btn btn-secondary" onclick="openCompareMode()" title="Compare Designs">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="9"/>
            <rect x="14" y="3" width="7" height="9"/>
            <path d="M10 12l2 2 2-2M12 14v7"/>
          </svg>
        </button>
        <!-- Share Button -->
        <button class="btn btn-secondary" onclick="openShareModal()" title="Share Design">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"/>
            <circle cx="6" cy="12" r="3"/>
            <circle cx="18" cy="19" r="3"/>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
          </svg>
        </button>
        <button class="btn btn-secondary" onclick="window.print()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
            <rect x="6" y="14" width="12" height="8"/>
          </svg>
          Print
        </button>
        <button class="btn btn-success" onclick="exportForVistaprint()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Export PNG
        </button>
      </div>
    </div>

    <div class="main-layout">
      <div class="sidebar">
        <!-- Sidebar Tabs -->
        <div class="sidebar-tabs">
          <button class="sidebar-tab active" onclick="showSidebarPanel('design', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            Design
          </button>
          <button class="sidebar-tab" onclick="showSidebarPanel('brand', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            Brand
          </button>
          <button class="sidebar-tab" onclick="showSidebarPanel('image', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
            Image
          </button>
          <button class="sidebar-tab" onclick="showSidebarPanel('tools', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
            Tools
          </button>
        </div>

        <!-- DESIGN PANEL -->
        <div class="sidebar-panel active" id="panel-design">
          <!-- Auto Preview Toggle -->
          <div style="margin-bottom:12px;">
            <button class="quick-btn" id="autoPreviewBtn" onclick="toggleAutoPreview()" style="width:100%;padding:12px;background:linear-gradient(135deg, var(--accent), #6366f1);">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              <span id="autoPreviewText">Auto Preview</span>
            </button>
          </div>
          <!-- Quick Actions -->
          <div class="quick-actions">
            <button class="quick-btn" onclick="generateNew()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
              Shuffle
            </button>
            <button class="quick-btn" onclick="openCompareMode()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="9"/></svg>
              Compare
            </button>
            <button class="quick-btn" onclick="saveToFavorites()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
              Save
            </button>
          </div>

          <!-- Lock Elements -->
          <div class="panel-section">
            <div class="panel-section-title">Lock Elements (Keep on Shuffle)</div>
            <div style="display:flex;flex-direction:column;gap:6px;">
              <label style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-secondary);cursor:pointer;">
                <input type="checkbox" id="lockLayout" onchange="toggleLock('layout'); this.checked = locked.layout;">
                <span>ðŸ”’ Layout</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-secondary);cursor:pointer;">
                <input type="checkbox" id="lockPoolImage" onchange="toggleLock('poolImage'); this.checked = locked.poolImage;">
                <span>ðŸ”’ Background Image</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-secondary);cursor:pointer;">
                <input type="checkbox" id="lockTheme" onchange="toggleLock('theme'); this.checked = locked.theme;">
                <span>ðŸ”’ Color Theme</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-secondary);cursor:pointer;">
                <input type="checkbox" id="lockDiscount" onchange="toggleLock('discount'); this.checked = locked.discount;">
                <span>ðŸ”’ Discount/Offer</span>
              </label>
            </div>
          </div>

          <!-- Colors -->
          <div class="panel-section">
            <div class="panel-section-title">Colors</div>
            <!-- Custom Colors -->
            <div class="compact-row">
              <div>
                <label class="compact-label">Primary</label>
                <input type="color" id="customPrimary" value="#0891b2" onchange="applyCustomColors()" style="width:100%;height:32px;border:1px solid var(--border);border-radius:4px;cursor:pointer;">
              </div>
              <div>
                <label class="compact-label">Secondary</label>
                <input type="color" id="customSecondary" value="#06b6d4" onchange="applyCustomColors()" style="width:100%;height:32px;border:1px solid var(--border);border-radius:4px;cursor:pointer;">
              </div>
              <div>
                <label class="compact-label">Accent</label>
                <input type="color" id="customAccent" value="#22d3ee" onchange="applyCustomColors()" style="width:100%;height:32px;border:1px solid var(--border);border-radius:4px;cursor:pointer;">
              </div>
            </div>
            <!-- Color Tools -->
            <div style="display:flex;gap:6px;margin-bottom:10px;">
              <div class="compact-upload" onclick="document.getElementById('paletteInput').click()" style="flex:1;margin:0;">
                <div class="compact-upload-preview" id="palettePreview" style="width:40px;height:40px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                </div>
                <div class="compact-upload-text">
                  <p style="font-size:10px;">Extract</p>
                  <span style="font-size:9px;">From image</span>
                </div>
              </div>
              <button class="quick-btn" onclick="generateHarmoniousPalette()" style="flex:1;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8"/></svg>
                Generate
              </button>
            </div>
            <input type="file" id="paletteInput" class="hidden-input" accept="image/*" onchange="extractColorsFromImage(this)">
            <!-- Collapsible Color Presets -->
            <div style="border:1px solid var(--border);border-radius:6px;overflow:hidden;">
              <button onclick="toggleColorPalette()" id="colorPaletteToggle" style="width:100%;padding:8px 12px;background:var(--bg-primary);border:none;color:var(--text-secondary);font-size:11px;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                <span>ðŸŽ¨ Color Presets</span>
                <span id="colorPaletteArrow" style="transition:transform 0.2s;">â–¼</span>
              </button>
              <div id="colorPaletteContent" style="display:none;padding:8px;background:var(--bg-secondary);">
                <div class="color-swatches" id="colorGrid"></div>
              </div>
            </div>
          </div>

          <!-- Font -->
          <div class="panel-section">
            <div class="panel-section-title">Font</div>
            <select class="compact-select" id="fontSelect" onchange="changeFont(this.value)">
              <option value="Playfair Display">Playfair Display</option>
              <option value="Poppins">Poppins</option>
              <option value="Montserrat">Montserrat</option>
              <option value="Inter">Inter</option>
              <option value="Oswald">Oswald</option>
              <option value="Roboto Slab">Roboto Slab</option>
            </select>
          </div>
        </div>

        <!-- BRAND PANEL -->
        <div class="sidebar-panel" id="panel-brand">
          <!-- Logo -->
          <div class="panel-section">
            <div class="panel-section-title">Logo</div>
            <div class="compact-upload" onclick="document.getElementById('logoInput').click()">
              <div class="compact-upload-preview" id="logoPreview">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
              </div>
              <div class="compact-upload-text">
                <p>Company Logo</p>
                <span>Click to upload</span>
              </div>
            </div>
            <input type="file" id="logoInput" class="hidden-input" accept="image/*" onchange="handleLogoUpload(this)">
            <div style="margin-top:8px;">
              <label class="compact-label">Size: <span id="logoSizeValue">40px</span></label>
              <input type="range" id="logoSizeSlider" min="20" max="200" value="40" class="filter-slider" oninput="updateLogoSize(this.value)">
            </div>
            <label style="display:flex;align-items:center;gap:8px;margin-top:8px;font-size:11px;color:var(--text-secondary);cursor:pointer;">
              <input type="checkbox" id="logoWhiteBox" onchange="toggleLogoWhiteBox(this.checked)">
              White background box
            </label>
          </div>

          <!-- Headline Text -->
          <div class="panel-section">
            <div class="panel-section-title">Headline Text</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <input type="text" class="compact-input" id="headlineMain" placeholder="Main Headline (e.g. Pool Serenity)" oninput="updateHeadlineText()">
              <input type="text" class="compact-input" id="headlineSub" placeholder="Sub Headline (e.g. Worry Less)" oninput="updateHeadlineText()">
            </div>
            <p style="font-size:10px;color:var(--text-secondary);margin-top:6px;">Or double-click text on postcard to edit directly</p>
          </div>

          <!-- Business Info -->
          <div class="panel-section">
            <div class="panel-section-title">Business Info</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <input type="text" class="compact-input" id="companyName" value="Clear Ripples" placeholder="Company Name" oninput="saveUserInfo(); updatePostcard()">
              <input type="text" class="compact-input" id="phoneNumber" value="(772) 307-8273" placeholder="Phone" oninput="saveUserInfo(); updatePostcard()">
              <label style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-secondary);cursor:pointer;">
                <input type="checkbox" id="showCallOrText" checked onchange="saveUserInfo(); renderPostcard()">
                Show "Call or Text" label
              </label>
              <input type="text" class="compact-input" id="website" value="clearripplespools.com" placeholder="Website" oninput="saveUserInfo(); updatePostcard()">
              <input type="text" class="compact-input" id="cityName" value="Port St. Lucie" placeholder="City/Area" oninput="saveUserInfo(); updatePostcard()">
            </div>
          </div>

          <!-- QR Code -->
          <div class="panel-section">
            <div class="panel-section-title">QR Code</div>
            <div style="display:flex;gap:6px;margin-bottom:8px;">
              <label style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-secondary);cursor:pointer;flex:1;">
                <input type="checkbox" id="showQRCode" checked onchange="toggleQRCodeVisibility(this.checked)">
                Show QR Code
              </label>
              <button class="quick-btn" onclick="removeQRCode()" style="padding:4px 8px;font-size:10px;background:#ef4444;">
                Remove QR
              </button>
            </div>
            <select id="qrType" class="compact-select" onchange="updateQRPlaceholder()" style="margin-bottom:8px;">
              <option value="url">Website URL</option>
              <option value="phone">Phone Number</option>
              <option value="email">Email</option>
            </select>
            <div class="compact-row">
              <input type="text" id="qrContent" class="compact-input" placeholder="https://..." oninput="generateQRCode()">
            </div>
            <div id="qrPreviewContainer" style="text-align:center;margin-top:8px;display:none;">
              <div id="qrCodeDisplay" style="display:inline-block;padding:6px;background:white;border-radius:4px;"></div>
            </div>
            <input type="file" id="qrInput" class="hidden-input" accept="image/*" onchange="handleQRUpload(this)">
          </div>

          <!-- Discount/Offer -->
          <div class="panel-section">
            <div class="panel-section-title">Discount/Offer</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <input type="text" class="compact-input" id="discountAmount" placeholder="Amount: $50 OFF, 20% OFF, FREE" oninput="updateDiscountFromSidebar()">
              <input type="text" class="compact-input" id="discountText" placeholder="For: First Service, First Month" oninput="updateDiscountFromSidebar()">
              <div>
                <label class="compact-label">Size: <span id="discountSizeValue">100%</span></label>
                <input type="range" id="discountSizeSlider" min="60" max="150" value="100" class="filter-slider" oninput="updateDiscountSize(this.value)">
              </div>
            </div>
          </div>

          <!-- Services -->
          <div class="panel-section">
            <div class="panel-section-title">Services List</div>
            <div id="servicesEditor" style="display:flex;flex-direction:column;gap:6px;">
              <input type="text" class="compact-input service-input" placeholder="Service 1" oninput="updateServicesFromSidebar()">
              <input type="text" class="compact-input service-input" placeholder="Service 2" oninput="updateServicesFromSidebar()">
              <input type="text" class="compact-input service-input" placeholder="Service 3" oninput="updateServicesFromSidebar()">
              <input type="text" class="compact-input service-input" placeholder="Service 4" oninput="updateServicesFromSidebar()">
            </div>
            <button onclick="addServiceInput()" style="margin-top:6px;padding:4px 8px;font-size:10px;background:var(--surface);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary);cursor:pointer;">+ Add Service</button>
          </div>

          <!-- Testimonial -->
          <div class="panel-section">
            <div class="panel-section-title">Testimonial</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <textarea class="compact-input" id="testimonialText" placeholder="Customer quote..." rows="2" style="resize:vertical;" oninput="updateTestimonialFromSidebar()"></textarea>
              <input type="text" class="compact-input" id="testimonialAuthor" placeholder="â€” Customer Name, City" oninput="updateTestimonialFromSidebar()">
            </div>
          </div>

          <!-- Urgency & CTA -->
          <div class="panel-section">
            <div class="panel-section-title">Urgency & CTA</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <input type="text" class="compact-input" id="urgencyText" placeholder="e.g. Limited Time Only!" oninput="updateUrgencyFromSidebar()">
              <input type="text" class="compact-input" id="ctaText" placeholder="e.g. Call Now For Free Quote!" oninput="updateCtaFromSidebar()">
            </div>
          </div>

          <!-- Marketing Fields -->
          <div class="panel-section">
            <div class="panel-section-title">Marketing Extras</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <div>
                <label class="compact-label">Coupon/Promo Code</label>
                <input type="text" class="compact-input" id="couponCode" placeholder="e.g. SUMMER25, POOL50" oninput="updateMarketingFields()">
              </div>
              <div>
                <label class="compact-label">Offer Expiration</label>
                <input type="date" class="compact-input" id="expirationDate" oninput="updateMarketingFields()">
              </div>
              <div>
                <label class="compact-label">Call Tracking Number</label>
                <input type="text" class="compact-input" id="callTrackingNumber" placeholder="e.g. (800) 555-POOL" oninput="updateMarketingFields()">
              </div>
            </div>
            <p style="font-size:9px;color:var(--text-muted);margin-top:6px;">These appear on postcard when filled in</p>
          </div>
        </div>

        <!-- IMAGE PANEL -->
        <div class="sidebar-panel" id="panel-image">
          <!-- Pool Image -->
          <div class="panel-section">
            <div class="panel-section-title">Background Image</div>
            <div class="compact-upload" onclick="document.getElementById('poolInput').click()">
              <div class="compact-upload-preview" id="poolPreview">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M2 10h20"/></svg>
              </div>
              <div class="compact-upload-text">
                <p>Pool Image</p>
                <span id="poolImageIndex">Stock #1</span>
              </div>
            </div>
            <input type="file" id="poolInput" class="hidden-input" accept="image/*" onchange="handlePoolUpload(this)">
            <div style="display:flex;gap:6px;margin-top:8px;">
              <button class="quick-btn" style="flex:1;padding:8px;" onclick="prevPoolImage()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                Prev
              </button>
              <button class="quick-btn" style="flex:1;padding:8px;background:#dc3545;color:white;" onclick="deleteCurrentPoolImage()" title="Remove this image permanently">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                Delete
              </button>
              <button class="quick-btn" style="flex:1;padding:8px;" onclick="nextPoolImage()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                Next
              </button>
            </div>
          </div>

          <!-- Image Adjustments -->
          <div class="panel-section">
            <div class="panel-section-title">Adjustments</div>
            <div class="filter-slider-group">
              <div class="filter-slider-label"><span>Brightness</span><span id="brightnessValue">100%</span></div>
              <input type="range" class="filter-slider" id="brightnessSlider" min="50" max="150" value="100" oninput="applyImageFilters()">
            </div>
            <div class="filter-slider-group">
              <div class="filter-slider-label"><span>Contrast</span><span id="contrastValue">100%</span></div>
              <input type="range" class="filter-slider" id="contrastSlider" min="50" max="150" value="100" oninput="applyImageFilters()">
            </div>
            <div class="filter-slider-group">
              <div class="filter-slider-label"><span>Saturation</span><span id="saturationValue">100%</span></div>
              <input type="range" class="filter-slider" id="saturationSlider" min="0" max="200" value="100" oninput="applyImageFilters()">
            </div>
            <button class="quick-btn" onclick="resetImageFilters()" style="width:100%;margin-top:8px;">Reset Filters</button>
          </div>
        </div>

        <!-- TOOLS PANEL - Reorganized with Collapsible Sections -->
        <div class="sidebar-panel" id="panel-tools">

          <!-- EXPORT & PRINT - Collapsible -->
          <div class="collapsible-section" style="border:1px solid var(--border);border-radius:6px;margin-bottom:10px;">
            <button onclick="toggleToolSection('exportPrint')" class="section-toggle">
              <span>ðŸ“¤ Export & Print</span>
              <span class="toggle-arrow" id="exportPrintArrow">â–¼</span>
            </button>
            <div id="exportPrintContent" class="section-content" style="display:none;">
              <!-- PDF Export -->
              <div class="mini-section">
                <button class="quick-btn" onclick="exportToPDF()" style="width:100%;background:linear-gradient(135deg, #ef4444, #dc2626);">Export as PDF</button>
              </div>
              <!-- Batch Export -->
              <div class="mini-section">
                <div style="display:flex;align-items:center;gap:6px;">
                  <select id="batchCount" class="compact-select" style="width:70px;">
                    <option value="3">3</option><option value="5" selected>5</option><option value="10">10</option>
                  </select>
                  <button class="quick-btn" onclick="batchExport()" style="flex:1;">Batch Export</button>
                </div>
              </div>
              <!-- Print Cost -->
              <div class="mini-section">
                <div style="display:flex;gap:4px;">
                  <select id="printQuantity" class="compact-select" style="flex:1;" onchange="calculatePrintCost()">
                    <option value="250">250</option><option value="500" selected>500</option><option value="1000">1K</option><option value="2500">2.5K</option>
                  </select>
                  <select id="paperType" class="compact-select" style="flex:1;" onchange="calculatePrintCost()">
                    <option value="standard">Gloss</option><option value="matte">Matte</option>
                  </select>
                </div>
                <div style="text-align:center;margin-top:6px;font-size:12px;color:var(--accent);font-weight:700;">Est: $<span id="estimatedCost">89</span></div>
              </div>
              <!-- Vendor Comparison -->
              <div class="mini-section">
                <button class="quick-btn" onclick="showVendorComparison()" style="width:100%;">Compare Print Vendors</button>
                <div id="vendorPrices" style="font-size:9px;display:none;margin-top:6px;"></div>
              </div>
              <!-- Paper Texture -->
              <div class="mini-section">
                <select id="paperTexture" class="compact-select" onchange="applyPaperTexture(this.value)">
                  <option value="none">Paper Preview: None</option>
                  <option value="glossy">Glossy</option>
                  <option value="matte">Matte</option>
                  <option value="uncoated">Uncoated</option>
                </select>
              </div>
              <!-- Print Marks -->
              <div class="mini-section">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="showCropMarks" onchange="toggleCropMarks(this.checked)"> Crop Marks
                </label>
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="showColorBars" onchange="toggleColorBars(this.checked)"> Color Bars
                </label>
              </div>
              <!-- Watermark Mode -->
              <div class="mini-section">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="watermarkMode" onchange="toggleWatermark(this.checked)"> Add PROOF Watermark
                </label>
                <select id="watermarkStyle" class="compact-select" style="margin-top:4px;" onchange="updateWatermarkStyle()">
                  <option value="diagonal">Diagonal</option>
                  <option value="center">Center</option>
                  <option value="tiled">Tiled</option>
                </select>
              </div>
              <!-- Vistaprint Link -->
              <div class="mini-section">
                <a href="https://www.vistaprint.com/marketing-materials/postcards" target="_blank" class="quick-btn" style="width:100%;text-decoration:none;background:#ff6600;">Order on Vistaprint</a>
              </div>
            </div>
          </div>

          <!-- MARKETING & CAMPAIGNS - Collapsible -->
          <div class="collapsible-section" style="border:1px solid var(--border);border-radius:6px;margin-bottom:10px;">
            <button onclick="toggleToolSection('marketing')" class="section-toggle">
              <span>ðŸ“Š Marketing & Campaigns</span>
              <span class="toggle-arrow" id="marketingArrow">â–¼</span>
            </button>
            <div id="marketingContent" class="section-content" style="display:none;">
              <!-- A/B Testing -->
              <div class="mini-section">
                <button class="quick-btn" onclick="startABTest()" style="width:100%;background:linear-gradient(135deg, #8b5cf6, #7c3aed);">A/B Test Designs</button>
              </div>
              <!-- ROI Calculator -->
              <div class="mini-section">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;">
                  <input type="number" id="roiQuantity" class="compact-input" value="500" placeholder="Qty" oninput="calculateROI()">
                  <input type="number" id="roiJobValue" class="compact-input" value="150" placeholder="Job $" oninput="calculateROI()">
                </div>
                <div style="text-align:center;margin-top:4px;font-size:11px;">ROI: <span id="roiPercent" style="color:var(--success);font-weight:700;">743%</span></div>
              </div>
              <!-- Campaign Manager -->
              <div class="mini-section">
                <div style="display:flex;gap:4px;">
                  <input type="text" id="campaignName" class="compact-input" placeholder="Campaign name" style="flex:1;">
                  <button class="quick-btn" onclick="saveCampaign()" style="padding:6px 10px;">Save</button>
                </div>
                <div id="campaignsList" style="max-height:60px;overflow-y:auto;margin-top:4px;"></div>
              </div>
              <!-- Drip Campaign -->
              <div class="mini-section">
                <div style="display:flex;gap:4px;">
                  <button class="quick-btn" onclick="createDripCard(1)" style="flex:1;padding:4px;font-size:9px;">Card 1</button>
                  <button class="quick-btn" onclick="createDripCard(2)" style="flex:1;padding:4px;font-size:9px;">Card 2</button>
                  <button class="quick-btn" onclick="createDripCard(3)" style="flex:1;padding:4px;font-size:9px;">Card 3</button>
                </div>
              </div>
              <!-- Response Tracking -->
              <div class="mini-section">
                <input type="text" id="trackingCode" class="compact-input" placeholder="Tracking code (e.g. SUMMER24)" oninput="updateTrackingCode()">
              </div>
              <!-- Seasonal Messaging -->
              <div class="mini-section">
                <select id="seasonSelect" class="compact-select" onchange="applySeasonalMessaging(this.value)">
                  <option value="">Seasonal Message...</option>
                  <option value="summer">â˜€ï¸ Summer</option>
                  <option value="spring">ðŸŒ¸ Spring</option>
                  <option value="fall">ðŸ‚ Fall</option>
                  <option value="winter">â„ï¸ Winter</option>
                </select>
              </div>
              <!-- Holiday/Event Themes -->
              <div class="mini-section">
                <select id="holidayTheme" class="compact-select" onchange="applyHolidayTheme(this.value)">
                  <option value="">Holiday Theme...</option>
                  <option value="memorial">ðŸ‡ºðŸ‡¸ Memorial Day</option>
                  <option value="july4th">ðŸŽ† July 4th</option>
                  <option value="labor">âš’ï¸ Labor Day</option>
                  <option value="poolopener">ðŸŠ Pool Season Opener</option>
                  <option value="backtoschool">ðŸ“š Back to School</option>
                  <option value="thanksgiving">ðŸ¦ƒ Thanksgiving</option>
                </select>
              </div>
              <!-- Referral Program -->
              <div class="mini-section">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="showReferral" onchange="toggleReferralBox(this.checked)"> Referral Program
                </label>
                <div style="display:flex;gap:4px;margin-top:4px;">
                  <input type="text" id="referralAmount" class="compact-input" value="25" style="width:50px;">
                  <select id="referralType" class="compact-select" style="flex:1;" onchange="updateReferralBox()">
                    <option value="both">Both Get $</option>
                    <option value="referrer">Referrer Gets $</option>
                    <option value="newcust">New Customer Gets $</option>
                  </select>
                </div>
              </div>
              <!-- Bundle Deals -->
              <div class="mini-section">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="showBundleDeal" onchange="toggleBundleDeal(this.checked)"> Show Bundle Deal
                </label>
                <select id="bundleType" class="compact-select" style="margin-top:4px;" onchange="updateBundleDeal()">
                  <option value="weekly-chemical">Weekly + Chemicals = 15% Off</option>
                  <option value="cleaning-repair">Cleaning + Repair = $50 Off</option>
                  <option value="annual">Annual Contract = 1 Month Free</option>
                  <option value="custom">Custom Bundle...</option>
                </select>
              </div>
            </div>
          </div>

          <!-- CONTENT & PERSONALIZATION - Collapsible -->
          <div class="collapsible-section" style="border:1px solid var(--border);border-radius:6px;margin-bottom:10px;">
            <button onclick="toggleToolSection('content')" class="section-toggle">
              <span>âœï¸ Content & Personalization</span>
              <span class="toggle-arrow" id="contentArrow">â–¼</span>
            </button>
            <div id="contentContent" class="section-content" style="display:none;">
              <!-- Find & Replace -->
              <div class="mini-section">
                <input type="text" id="findText" class="compact-input" placeholder="Find..." style="margin-bottom:4px;">
                <div style="display:flex;gap:4px;">
                  <input type="text" id="replaceText" class="compact-input" placeholder="Replace..." style="flex:1;">
                  <button class="quick-btn" onclick="bulkReplaceText()" style="padding:6px 10px;">Go</button>
                </div>
              </div>
              <!-- Neighborhood -->
              <div class="mini-section">
                <input type="text" id="neighborhoodName" class="compact-input" placeholder="Neighborhood name" oninput="updateNeighborhood()">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;margin-top:4px;">
                  <input type="checkbox" id="showNeighborhood" onchange="toggleNeighborhoodMsg(this.checked)"> "Your neighbors trust us!"
                </label>
              </div>
              <!-- Review Snippet -->
              <div class="mini-section">
                <textarea id="reviewSnippet" class="compact-input" rows="2" placeholder="Paste Google review..." style="resize:none;" oninput="updateReviewSnippet()"></textarea>
                <input type="text" id="reviewerName" class="compact-input" placeholder="Reviewer name" style="margin-top:4px;" oninput="updateReviewSnippet()">
              </div>
              <!-- Language Mode -->
              <div class="mini-section">
                <select id="languageMode" class="compact-select" onchange="changeLanguageMode(this.value)">
                  <option value="en">English</option>
                  <option value="es">Spanish</option>
                  <option value="bilingual">Bilingual</option>
                </select>
              </div>
              <!-- Font Selector -->
              <div class="mini-section">
                <select id="headlineFont" class="compact-select" style="margin-bottom:4px;" onchange="updateFonts()">
                  <option value="Poppins">Headline: Poppins</option>
                  <option value="Montserrat">Headline: Montserrat</option>
                  <option value="Oswald">Headline: Oswald</option>
                  <option value="Bebas Neue">Headline: Bebas Neue</option>
                  <option value="Playfair Display">Headline: Playfair</option>
                  <option value="Roboto Slab">Headline: Roboto Slab</option>
                </select>
                <select id="bodyFont" class="compact-select" onchange="updateFonts()">
                  <option value="Open Sans">Body: Open Sans</option>
                  <option value="Roboto">Body: Roboto</option>
                  <option value="Lato">Body: Lato</option>
                  <option value="Source Sans Pro">Body: Source Sans</option>
                  <option value="Nunito">Body: Nunito</option>
                </select>
              </div>
              <!-- Mailing List -->
              <div class="mini-section">
                <button class="quick-btn" onclick="document.getElementById('csvInput').click()" style="width:100%;">Import Mailing List (CSV)</button>
                <input type="file" id="csvInput" class="hidden-input" accept=".csv" onchange="handleCSVUpload(this)">
                <div id="csvStatus" style="font-size:9px;color:var(--text-muted);margin-top:4px;"></div>
              </div>
            </div>
          </div>

          <!-- MEDIA & VISUALS - Collapsible -->
          <div class="collapsible-section" style="border:1px solid var(--border);border-radius:6px;margin-bottom:10px;">
            <button onclick="toggleToolSection('media')" class="section-toggle">
              <span>ðŸ–¼ï¸ Media & Visuals</span>
              <span class="toggle-arrow" id="mediaArrow">â–¼</span>
            </button>
            <div id="mediaContent" class="section-content" style="display:none;">
              <!-- Before/After -->
              <div class="mini-section">
                <div style="display:flex;gap:4px;">
                  <button class="quick-btn" onclick="document.getElementById('beforePhotoInput').click()" style="flex:1;padding:6px;font-size:9px;">Before Photo</button>
                  <button class="quick-btn" onclick="document.getElementById('afterPhotoInput').click()" style="flex:1;padding:6px;font-size:9px;">After Photo</button>
                </div>
                <input type="file" id="beforePhotoInput" class="hidden-input" accept="image/*" onchange="handleBeforePhoto(this)">
                <input type="file" id="afterPhotoInput" class="hidden-input" accept="image/*" onchange="handleAfterPhoto(this)">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;margin-top:4px;">
                  <input type="checkbox" id="showBeforeAfter" onchange="toggleBeforeAfterPhotos(this.checked)"> Show on postcard
                </label>
              </div>
              <!-- Image Focus -->
              <div class="mini-section">
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:2px;">
                  <button class="quick-btn" onclick="setImageFocus('top-left')" style="padding:4px;font-size:8px;">â†–</button>
                  <button class="quick-btn" onclick="setImageFocus('top-center')" style="padding:4px;font-size:8px;">â†‘</button>
                  <button class="quick-btn" onclick="setImageFocus('top-right')" style="padding:4px;font-size:8px;">â†—</button>
                  <button class="quick-btn" onclick="setImageFocus('center-left')" style="padding:4px;font-size:8px;">â†</button>
                  <button class="quick-btn" onclick="setImageFocus('center')" style="padding:4px;font-size:8px;background:var(--accent);">â—</button>
                  <button class="quick-btn" onclick="setImageFocus('center-right')" style="padding:4px;font-size:8px;">â†’</button>
                  <button class="quick-btn" onclick="setImageFocus('bottom-left')" style="padding:4px;font-size:8px;">â†™</button>
                  <button class="quick-btn" onclick="setImageFocus('bottom-center')" style="padding:4px;font-size:8px;">â†“</button>
                  <button class="quick-btn" onclick="setImageFocus('bottom-right')" style="padding:4px;font-size:8px;">â†˜</button>
                </div>
              </div>
              <!-- Text Effects -->
              <div class="mini-section">
                <select id="headlineEffect" class="compact-select" onchange="applyTextEffect()" style="margin-bottom:4px;">
                  <option value="none">Headline Effect: None</option>
                  <option value="shadow">Drop Shadow</option>
                  <option value="outline">Outline</option>
                  <option value="glow">Glow</option>
                </select>
                <select id="discountEffect" class="compact-select" onchange="applyTextEffect()">
                  <option value="none">Badge Effect: None</option>
                  <option value="pulse">Pulse</option>
                  <option value="gradient">Gradient</option>
                </select>
              </div>
              <!-- Video QR -->
              <div class="mini-section">
                <input type="text" id="videoUrl" class="compact-input" placeholder="Video URL for QR" oninput="updateVideoQR()">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;margin-top:4px;">
                  <input type="checkbox" id="useVideoQR" onchange="toggleVideoQR(this.checked)"> Use video QR
                </label>
              </div>
              <!-- QR Code Customizer -->
              <div class="mini-section">
                <div style="font-size:9px;color:var(--text-muted);margin-bottom:4px;">QR Code Style</div>
                <div style="display:flex;gap:4px;margin-bottom:4px;">
                  <input type="color" id="qrFgColor" value="#000000" style="width:30px;height:24px;border:none;cursor:pointer;" onchange="updateQRStyle()">
                  <input type="color" id="qrBgColor" value="#ffffff" style="width:30px;height:24px;border:none;cursor:pointer;" onchange="updateQRStyle()">
                  <select id="qrStyle" class="compact-select" style="flex:1;" onchange="updateQRStyle()">
                    <option value="square">Square</option>
                    <option value="rounded">Rounded</option>
                    <option value="dots">Dots</option>
                  </select>
                </div>
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="qrWithLogo" onchange="updateQRStyle()"> Add logo in center
                </label>
              </div>
              <!-- Image Filters -->
              <div class="mini-section">
                <div style="font-size:9px;color:var(--text-muted);margin-bottom:4px;">Image Adjustments</div>
                <div style="display:flex;align-items:center;gap:4px;margin-bottom:4px;">
                  <span style="font-size:9px;width:50px;">Bright</span>
                  <input type="range" id="imgBrightness" min="50" max="150" value="100" style="flex:1;" oninput="applyImageFilters()">
                </div>
                <div style="display:flex;align-items:center;gap:4px;margin-bottom:4px;">
                  <span style="font-size:9px;width:50px;">Contrast</span>
                  <input type="range" id="imgContrast" min="50" max="150" value="100" style="flex:1;" oninput="applyImageFilters()">
                </div>
                <div style="display:flex;align-items:center;gap:4px;">
                  <span style="font-size:9px;width:50px;">Saturate</span>
                  <input type="range" id="imgSaturation" min="0" max="200" value="100" style="flex:1;" oninput="applyImageFilters()">
                </div>
                <button class="quick-btn" onclick="resetImageFilters()" style="width:100%;margin-top:4px;padding:4px;font-size:9px;">Reset Filters</button>
              </div>
              <!-- Border/Frame Styles -->
              <div class="mini-section">
                <select id="borderStyle" class="compact-select" onchange="applyBorderStyle(this.value)">
                  <option value="none">Border: None</option>
                  <option value="simple">Simple Line</option>
                  <option value="double">Double Line</option>
                  <option value="wave">Wave Pattern</option>
                  <option value="tropical">Tropical Leaves</option>
                  <option value="tile">Pool Tile</option>
                  <option value="splash">Water Splash</option>
                </select>
                <div style="display:flex;gap:4px;margin-top:4px;">
                  <input type="color" id="borderColor" value="#0066cc" style="width:30px;height:24px;border:none;cursor:pointer;" onchange="applyBorderStyle(document.getElementById('borderStyle').value)">
                  <select id="borderWidth" class="compact-select" style="flex:1;" onchange="applyBorderStyle(document.getElementById('borderStyle').value)">
                    <option value="2">Thin</option>
                    <option value="4" selected>Medium</option>
                    <option value="8">Thick</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- CREDENTIALS & TRUST - Collapsible -->
          <div class="collapsible-section" style="border:1px solid var(--border);border-radius:6px;margin-bottom:10px;">
            <button onclick="toggleToolSection('credentials')" class="section-toggle">
              <span>ðŸ›¡ï¸ Credentials & Trust</span>
              <span class="toggle-arrow" id="credentialsArrow">â–¼</span>
            </button>
            <div id="credentialsContent" class="section-content" style="display:none;">
              <!-- License/Insurance -->
              <div class="mini-section">
                <input type="text" id="licenseNumber" class="compact-input" placeholder="License # (e.g. CPC123456)" style="margin-bottom:4px;" oninput="updateCredentials()">
                <input type="text" id="insuranceInfo" class="compact-input" placeholder="Insurance (e.g. $1M Liability)" oninput="updateCredentials()">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;margin-top:4px;">
                  <input type="checkbox" id="showCredentials" onchange="toggleCredentials(this.checked)"> Show on postcard
                </label>
              </div>
              <!-- Certification Badges -->
              <div class="mini-section">
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:4px;">
                  <label style="font-size:9px;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;gap:4px;">
                    <input type="checkbox" id="badgeBBB" onchange="updateCertBadges()"> BBB
                  </label>
                  <label style="font-size:9px;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;gap:4px;">
                    <input type="checkbox" id="badgeAngi" onchange="updateCertBadges()"> Angi
                  </label>
                  <label style="font-size:9px;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;gap:4px;">
                    <input type="checkbox" id="badgeHomeAdvisor" onchange="updateCertBadges()"> HomeAdvisor
                  </label>
                  <label style="font-size:9px;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;gap:4px;">
                    <input type="checkbox" id="badgeYelp" onchange="updateCertBadges()"> Yelp 5â˜…
                  </label>
                  <label style="font-size:9px;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;gap:4px;">
                    <input type="checkbox" id="badgeVeteran" onchange="updateCertBadges()"> Veteran
                  </label>
                  <label style="font-size:9px;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;gap:4px;">
                    <input type="checkbox" id="badgeEco" onchange="updateCertBadges()"> Eco
                  </label>
                </div>
              </div>
              <!-- Social Media -->
              <div class="mini-section">
                <input type="text" id="facebookUrl" class="compact-input" placeholder="ðŸ“˜ Facebook URL" style="margin-bottom:4px;" oninput="updateSocialLinks()">
                <input type="text" id="instagramUrl" class="compact-input" placeholder="ðŸ“· Instagram URL" style="margin-bottom:4px;" oninput="updateSocialLinks()">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="showSocialIcons" onchange="toggleSocialIcons(this.checked)"> Show icons
                </label>
              </div>
              <!-- Guarantee Badge -->
              <div class="mini-section">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="showGuarantee" onchange="toggleGuaranteeBadge(this.checked)"> Guarantee Badge
                </label>
                <select id="guaranteeType" class="compact-select" style="margin-top:4px;" onchange="updateGuaranteeBadge()">
                  <option value="satisfaction">100% Satisfaction Guaranteed</option>
                  <option value="moneyback">Money-Back Guarantee</option>
                  <option value="pricematch">Price Match Guarantee</option>
                  <option value="quality">Quality Workmanship Guarantee</option>
                  <option value="ontime">On-Time or Free</option>
                </select>
              </div>
              <!-- Emergency Service Badge -->
              <div class="mini-section">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="showEmergency" onchange="toggleEmergencyBadge(this.checked)"> Emergency Service
                </label>
                <select id="emergencyType" class="compact-select" style="margin-top:4px;" onchange="updateEmergencyBadge()">
                  <option value="247">24/7 Emergency Service</option>
                  <option value="sameday">Same-Day Service Available</option>
                  <option value="weekend">Weekend Appointments</option>
                  <option value="rapid">Rapid Response Team</option>
                </select>
              </div>
            </div>
          </div>

          <!-- GUIDES & SETTINGS - Collapsible -->
          <div class="collapsible-section" style="border:1px solid var(--border);border-radius:6px;margin-bottom:10px;">
            <button onclick="toggleToolSection('guides')" class="section-toggle">
              <span>âš™ï¸ Guides & Settings</span>
              <span class="toggle-arrow" id="guidesArrow">â–¼</span>
            </button>
            <div id="guidesContent" class="section-content" style="display:none;">
              <!-- USPS/Print Guides -->
              <div class="mini-section">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="showUSPSGuides" onchange="toggleUSPSGuides(this.checked)"> USPS Mailing Zones
                </label>
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="showBleedZone" onchange="toggleBleedZone(this.checked)"> Bleed Zone
                </label>
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="showSafeZone" onchange="toggleSafeZone(this.checked)"> Safe Zone
                </label>
              </div>
              <!-- EDDM -->
              <div class="mini-section">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="eddmMode" onchange="toggleEDDMMode(this.checked)"> EDDM Format
                </label>
              </div>
              <!-- Dark Mode Preview -->
              <div class="mini-section">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="darkModePreview" onchange="toggleDarkModePreview(this.checked)"> Print Preview (Dark)
                </label>
              </div>
              <!-- Drag Mode -->
              <div class="mini-section">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="dragDropMode" onchange="toggleDragDropMode(this.checked)"> Drag to Reposition
                </label>
              </div>
              <!-- Service Area -->
              <div class="mini-section">
                <input type="text" id="serviceAreaCities" class="compact-input" placeholder="Service cities..." oninput="updateServiceArea()">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;margin-top:4px;">
                  <input type="checkbox" id="showServiceArea" onchange="toggleServiceArea(this.checked)"> Show on back
                </label>
              </div>
            </div>
          </div>

          <!-- TEMPLATES & HISTORY - Collapsible -->
          <div class="collapsible-section" style="border:1px solid var(--border);border-radius:6px;margin-bottom:10px;">
            <button onclick="toggleToolSection('templates')" class="section-toggle">
              <span>ðŸ’¾ Templates & History</span>
              <span class="toggle-arrow" id="templatesArrow">â–¼</span>
            </button>
            <div id="templatesContent" class="section-content" style="display:none;">
              <!-- Quick Presets -->
              <div class="mini-section">
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;">
                  <button class="quick-btn" onclick="applyPreset('summer')" style="padding:6px;font-size:9px;">â˜€ï¸</button>
                  <button class="quick-btn" onclick="applyPreset('tropical')" style="padding:6px;font-size:9px;">ðŸŒ´</button>
                  <button class="quick-btn" onclick="applyPreset('professional')" style="padding:6px;font-size:9px;">ðŸ’¼</button>
                  <button class="quick-btn" onclick="applyPreset('urgent')" style="padding:6px;font-size:9px;">ðŸ”¥</button>
                </div>
              </div>
              <!-- Save Template -->
              <div class="mini-section">
                <div style="display:flex;gap:4px;">
                  <input type="text" id="templateName" class="compact-input" placeholder="Template name" style="flex:1;">
                  <button class="quick-btn" onclick="saveTemplate()" style="padding:6px 10px;">Save</button>
                </div>
                <div id="savedTemplatesList" style="max-height:60px;overflow-y:auto;margin-top:4px;"></div>
              </div>
              <!-- History Gallery -->
              <div class="mini-section">
                <div id="designHistoryGallery" style="display:grid;grid-template-columns:repeat(4,1fr);gap:2px;max-height:60px;overflow-y:auto;"></div>
              </div>
              <!-- Favorites -->
              <div class="mini-section">
                <button class="quick-btn" onclick="saveToFavorites()" style="width:100%;">â­ Save to Favorites</button>
                <div id="favoritesList" style="max-height:60px;overflow-y:auto;margin-top:4px;"></div>
              </div>
              <!-- Auto-Save & Recovery -->
              <div class="mini-section">
                <label style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-secondary);cursor:pointer;">
                  <input type="checkbox" id="autoSaveEnabled" onchange="toggleAutoSave(this.checked)" checked> Auto-Save (every 30s)
                </label>
                <div style="display:flex;gap:4px;margin-top:4px;">
                  <button class="quick-btn" onclick="recoverLastDesign()" style="flex:1;padding:4px;font-size:9px;">Recover Last</button>
                  <button class="quick-btn" onclick="clearAutoSaves()" style="flex:1;padding:4px;font-size:9px;">Clear Backups</button>
                </div>
                <div id="autoSaveStatus" style="font-size:8px;color:var(--text-muted);margin-top:4px;">Last saved: Never</div>
              </div>
            </div>
          </div>

          <!-- Keyboard Shortcuts (always visible) -->
          <div style="font-size:9px;color:var(--text-muted);padding:8px;background:var(--bg-primary);border-radius:6px;">
            <strong>Shortcuts:</strong> Ctrl+Z Undo | Ctrl+S Save | Space Shuffle
          </div>
        </div>
      </div>

      <!-- Preview Area -->
      <div class="preview-area">
        <div class="preview-toolbar">
          <div class="tabs">
            <button class="tab active" onclick="showSide('front', this)">Front</button>
            <button class="tab" onclick="showSide('back', this)">Back</button>
            <button class="flip-btn" onclick="flipPostcard()" title="Flip Animation">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 1l4 4-4 4"/>
                <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                <path d="M7 23l-4-4 4-4"/>
                <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
              </svg>
              Flip
            </button>
          </div>
          <div class="preview-info">
            <span id="sizeDisplay">6Ã—9"</span>
            <span>â€¢</span>
            <span id="layoutDisplay">Premium</span>
            <span>â€¢</span>
            <span style="opacity: 0.7;">Click to lock â€¢ Double-click to edit text</span>
          </div>
        </div>

        <div class="postcard-wrapper">
          <div class="postcard-with-rulers">
            <div class="ruler ruler-top">
              <span>0"</span><span>1"</span><span>2"</span><span>3"</span><span>4"</span><span>5"</span><span>6"</span>
            </div>
            <div style="display: flex;">
              <div class="ruler ruler-left">
                <span>0"</span><span>1"</span><span>2"</span><span>3"</span><span>4"</span>
              </div>
              <div>
                <div class="postcard size-6x9" id="frontCard"></div>
                <div class="postcard size-6x9 hidden" id="backCard"></div>
              </div>
            </div>
            <div class="size-label">6" Ã— 9" (Direct Mail Standard)</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="lock-indicator" id="lockIndicator">
    <h4>ðŸ”’ Locked Elements</h4>
    <ul id="lockedList"></ul>
  </div>

  <div class="move-mode-banner">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/>
    </svg>
    Move Mode Active â€” Drag elements with blue outlines
  </div>

  <!-- Share Modal -->
  <div class="share-modal" id="shareModal" onclick="if(event.target === this) closeShareModal()">
    <div class="share-modal-content">
      <div class="share-modal-header">
        <h3>Share This Design</h3>
        <button class="share-modal-close" onclick="closeShareModal()">&times;</button>
      </div>
      <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 16px;">Copy this link to share your exact design settings with others:</p>
      <div class="share-url-box">
        <input type="text" class="share-url-input" id="shareUrlInput" readonly>
        <button class="copy-btn" id="copyBtn" onclick="copyShareUrl()">Copy Link</button>
      </div>
      <p style="font-size: 10px; color: var(--text-muted); margin-top: 12px;">Link includes: layout, colors, and text content</p>
    </div>
  </div>

  <!-- Compare Modal -->
  <div class="compare-modal" id="compareModal">
    <div class="compare-header">
      <h3>Compare Designs</h3>
      <button class="compare-close" onclick="closeCompareMode()">&times;</button>
    </div>
    <div class="compare-container">
      <div class="compare-card">
        <div class="compare-card-label">Current Design</div>
        <div class="postcard size-6x9" id="compareCard1"></div>
      </div>
      <div class="compare-vs">VS</div>
      <div class="compare-card">
        <div class="compare-card-label">Alternative</div>
        <div class="postcard size-6x9" id="compareCard2"></div>
      </div>
    </div>
    <div style="position: absolute; bottom: 30px; display: flex; gap: 12px;">
      <button class="btn btn-primary" onclick="generateCompareAlternative()">Generate New Alternative</button>
      <button class="btn btn-success" onclick="useAlternativeDesign()">Use Alternative</button>
    </div>
  </div>

  <!-- Design Tips Panel -->
  <div class="tips-panel" id="tipsPanel">
    <h3 style="font-size: 16px; margin-bottom: 20px; color: var(--text-primary);">Design Tips</h3>

    <div class="tip-card">
      <h4>Red CTAs Convert Better <span class="tip-stat">+21%</span></h4>
      <p>Red call-to-action buttons outperform other colors in direct mail. Use bold reds for your "Call Now" buttons.</p>
    </div>

    <div class="tip-card">
      <h4>Odd Prices Feel Like Deals <span class="tip-stat">$97 vs $100</span></h4>
      <p>Prices ending in 7 or 9 feel like better deals. Try "$97" instead of "$100" or "15% OFF" instead of "10% OFF".</p>
    </div>

    <div class="tip-card">
      <h4>Faces Increase Response <span class="tip-stat">+38%</span></h4>
      <p>Postcards with human faces get more attention. Consider adding your team photo to the back side.</p>
    </div>

    <div class="tip-card">
      <h4>Urgency Drives Action <span class="tip-stat">+27%</span></h4>
      <p>Limited-time offers create urgency. "Offer expires Friday" outperforms "Limited time offer".</p>
    </div>

    <div class="tip-card">
      <h4>Phone Numbers First <span class="tip-stat">Best Practice</span></h4>
      <p>Make your phone number the most prominent contact info. Most customers prefer to call for pool services.</p>
    </div>

    <div class="tip-card">
      <h4>QR Codes For Tracking <span class="tip-stat">Track ROI</span></h4>
      <p>Use unique QR codes to track which postcards drive traffic. Create landing pages specific to each mail campaign.</p>
    </div>

    <div class="tip-card">
      <h4>Seasonal Messaging <span class="tip-stat">+45% Response</span></h4>
      <p>Match your message to the season. "Pool Opening Special" in spring and "Winterization Service" in fall.</p>
    </div>

    <div class="tip-card">
      <h4>Social Proof Matters <span class="tip-stat">Trust Builder</span></h4>
      <p>Include review counts, years in business, or number of pools serviced. "Trusted by 500+ families" builds credibility.</p>
    </div>
  </div>
  <button class="tips-toggle" id="tipsToggle" onclick="toggleTipsPanel()">TIPS</button>

  <script>
    // ==================== SECURITY UTILITIES ====================
    function escapeHTML(str) {
      if (typeof str !== 'string') return '';
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }

    function sanitizeCSSUrl(url) {
      if (typeof url !== 'string') return '';
      const trimmed = url.trim();
      if (!trimmed) return '';
      try {
        const parsed = new URL(trimmed, window.location.origin);
        if (!['http:', 'https:', 'data:'].includes(parsed.protocol)) return '';
        return trimmed.replace(/['"()\\]/g, '');
      } catch {
        return '';
      }
    }

    function sanitizeColor(color) {
      if (typeof color !== 'string') return '#000000';
      const trimmed = color.trim();
      if (/^#[0-9a-fA-F]{3,8}$/.test(trimmed)) return trimmed;
      if (/^(rgb|hsl)a?\([^)]+\)$/.test(trimmed)) return trimmed;
      if (/^[a-zA-Z]+$/.test(trimmed)) return trimmed;
      return '#000000';
    }

    function safeJsonParse(str, fallback) {
      try { return JSON.parse(str); } catch { return fallback; }
    }

    function getVal(id, fallback = '') {
      const el = document.getElementById(id);
      return el ? (el.value || el.textContent || fallback) : fallback;
    }

    function autoFitText(container) {
      if (!container) return;
      const els = container.querySelectorAll('h1, h2, p, span, .headline, [contenteditable="true"]');
      for (const el of els) {
        const overflowsV = el.scrollHeight > el.clientHeight + 2;
        const overflowsH = el.scrollWidth > el.clientWidth + 2;
        if (!overflowsV && !overflowsH) continue;
        let size = parseFloat(getComputedStyle(el).fontSize);
        const min = 7;
        while (size > min && (el.scrollHeight > el.clientHeight + 2 || el.scrollWidth > el.clientWidth + 2)) {
          size -= 0.5;
          el.style.fontSize = size + 'px';
        }
      }
    }

    // ==================== DATA ====================
    // Pool images - Verified swimming pool images (pools, water, slides, diving boards, etc.)
    // PEXELS ONLY - Free commercial license, no people, pool water & empty pools
    // Original pool images - stored for reset functionality
    // PEXELS ONLY - Reliable URLs, verified pool/water images
    const originalPoolImages = [
      // Pool water & surfaces
      'https://images.pexels.com/photos/261327/pexels-photo-261327.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261102/pexels-photo-261102.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/221457/pexels-photo-221457.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261043/pexels-photo-261043.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261041/pexels-photo-261041.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261039/pexels-photo-261039.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/258154/pexels-photo-258154.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/1268871/pexels-photo-1268871.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/690597/pexels-photo-690597.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/273129/pexels-photo-273129.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261238/pexels-photo-261238.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261185/pexels-photo-261185.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261101/pexels-photo-261101.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261045/pexels-photo-261045.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261048/pexels-photo-261048.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261049/pexels-photo-261049.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261023/pexels-photo-261023.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261021/pexels-photo-261021.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261020/pexels-photo-261020.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261019/pexels-photo-261019.jpeg?auto=compress&w=800',
      // Resort & luxury pools
      'https://images.pexels.com/photos/189296/pexels-photo-189296.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261105/pexels-photo-261105.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261109/pexels-photo-261109.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261169/pexels-photo-261169.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261181/pexels-photo-261181.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261183/pexels-photo-261183.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261187/pexels-photo-261187.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261189/pexels-photo-261189.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261191/pexels-photo-261191.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261193/pexels-photo-261193.jpeg?auto=compress&w=800',
      // More pool views
      'https://images.pexels.com/photos/261195/pexels-photo-261195.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261197/pexels-photo-261197.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261199/pexels-photo-261199.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261201/pexels-photo-261201.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261203/pexels-photo-261203.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261036/pexels-photo-261036.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261034/pexels-photo-261034.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261032/pexels-photo-261032.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261030/pexels-photo-261030.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261028/pexels-photo-261028.jpeg?auto=compress&w=800',
      // Swimming pool lanes & tiles
      'https://images.pexels.com/photos/261026/pexels-photo-261026.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261024/pexels-photo-261024.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261017/pexels-photo-261017.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261015/pexels-photo-261015.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261013/pexels-photo-261013.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261011/pexels-photo-261011.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261009/pexels-photo-261009.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261007/pexels-photo-261007.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261005/pexels-photo-261005.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261003/pexels-photo-261003.jpeg?auto=compress&w=800',
      // Additional pool photos
      'https://images.pexels.com/photos/261001/pexels-photo-261001.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260999/pexels-photo-260999.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260997/pexels-photo-260997.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260995/pexels-photo-260995.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260922/pexels-photo-260922.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260920/pexels-photo-260920.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260918/pexels-photo-260918.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260689/pexels-photo-260689.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260687/pexels-photo-260687.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260598/pexels-photo-260598.jpeg?auto=compress&w=800',
      // Hotel & resort pools
      'https://images.pexels.com/photos/338504/pexels-photo-338504.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261395/pexels-photo-261395.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261393/pexels-photo-261393.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261391/pexels-photo-261391.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261389/pexels-photo-261389.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261387/pexels-photo-261387.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261385/pexels-photo-261385.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261383/pexels-photo-261383.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261381/pexels-photo-261381.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261379/pexels-photo-261379.jpeg?auto=compress&w=800',
      // Pool edges & decks
      'https://images.pexels.com/photos/261377/pexels-photo-261377.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261375/pexels-photo-261375.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261373/pexels-photo-261373.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261371/pexels-photo-261371.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261369/pexels-photo-261369.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261367/pexels-photo-261367.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261365/pexels-photo-261365.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261363/pexels-photo-261363.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261361/pexels-photo-261361.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261359/pexels-photo-261359.jpeg?auto=compress&w=800',
      // Backyard pools
      'https://images.pexels.com/photos/261357/pexels-photo-261357.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261355/pexels-photo-261355.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261353/pexels-photo-261353.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261351/pexels-photo-261351.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261349/pexels-photo-261349.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261347/pexels-photo-261347.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261345/pexels-photo-261345.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261343/pexels-photo-261343.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261341/pexels-photo-261341.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261339/pexels-photo-261339.jpeg?auto=compress&w=800',
      // Crystal clear water
      'https://images.pexels.com/photos/261337/pexels-photo-261337.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261335/pexels-photo-261335.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261333/pexels-photo-261333.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261331/pexels-photo-261331.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261329/pexels-photo-261329.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261325/pexels-photo-261325.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261323/pexels-photo-261323.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261321/pexels-photo-261321.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261319/pexels-photo-261319.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261317/pexels-photo-261317.jpeg?auto=compress&w=800',
      // Pool tiles & underwater
      'https://images.pexels.com/photos/261315/pexels-photo-261315.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261313/pexels-photo-261313.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261311/pexels-photo-261311.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261309/pexels-photo-261309.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261307/pexels-photo-261307.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261305/pexels-photo-261305.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261303/pexels-photo-261303.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261301/pexels-photo-261301.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261299/pexels-photo-261299.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261297/pexels-photo-261297.jpeg?auto=compress&w=800',
      // Infinity & luxury pools
      'https://images.pexels.com/photos/261295/pexels-photo-261295.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261293/pexels-photo-261293.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261291/pexels-photo-261291.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261289/pexels-photo-261289.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261287/pexels-photo-261287.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261285/pexels-photo-261285.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261283/pexels-photo-261283.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261281/pexels-photo-261281.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261279/pexels-photo-261279.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261277/pexels-photo-261277.jpeg?auto=compress&w=800',
      // Pool water surface
      'https://images.pexels.com/photos/261275/pexels-photo-261275.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261273/pexels-photo-261273.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261271/pexels-photo-261271.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261269/pexels-photo-261269.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261267/pexels-photo-261267.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261265/pexels-photo-261265.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261263/pexels-photo-261263.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261261/pexels-photo-261261.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261259/pexels-photo-261259.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261257/pexels-photo-261257.jpeg?auto=compress&w=800',
      // More pool views
      'https://images.pexels.com/photos/261255/pexels-photo-261255.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261253/pexels-photo-261253.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261251/pexels-photo-261251.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261249/pexels-photo-261249.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261247/pexels-photo-261247.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261245/pexels-photo-261245.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261243/pexels-photo-261243.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261241/pexels-photo-261241.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261239/pexels-photo-261239.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261237/pexels-photo-261237.jpeg?auto=compress&w=800',
      // === NEW BATCH - Swimming pools ===
      'https://images.pexels.com/photos/261235/pexels-photo-261235.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261233/pexels-photo-261233.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261231/pexels-photo-261231.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261229/pexels-photo-261229.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261227/pexels-photo-261227.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261225/pexels-photo-261225.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261223/pexels-photo-261223.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261221/pexels-photo-261221.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261219/pexels-photo-261219.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261217/pexels-photo-261217.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261215/pexels-photo-261215.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261213/pexels-photo-261213.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261211/pexels-photo-261211.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261209/pexels-photo-261209.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261207/pexels-photo-261207.jpeg?auto=compress&w=800',
      // === Pool water textures ===
      'https://images.pexels.com/photos/261205/pexels-photo-261205.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261163/pexels-photo-261163.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261161/pexels-photo-261161.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261159/pexels-photo-261159.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261157/pexels-photo-261157.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261155/pexels-photo-261155.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261153/pexels-photo-261153.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261151/pexels-photo-261151.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261149/pexels-photo-261149.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261147/pexels-photo-261147.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261145/pexels-photo-261145.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261143/pexels-photo-261143.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261141/pexels-photo-261141.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261139/pexels-photo-261139.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261137/pexels-photo-261137.jpeg?auto=compress&w=800',
      // === Resort & hotel pools ===
      'https://images.pexels.com/photos/261135/pexels-photo-261135.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261133/pexels-photo-261133.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261131/pexels-photo-261131.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261129/pexels-photo-261129.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261127/pexels-photo-261127.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261125/pexels-photo-261125.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261123/pexels-photo-261123.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261121/pexels-photo-261121.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261119/pexels-photo-261119.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261117/pexels-photo-261117.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261115/pexels-photo-261115.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261113/pexels-photo-261113.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261111/pexels-photo-261111.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261107/pexels-photo-261107.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261103/pexels-photo-261103.jpeg?auto=compress&w=800',
      // === Pool exteriors ===
      'https://images.pexels.com/photos/261099/pexels-photo-261099.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261097/pexels-photo-261097.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261095/pexels-photo-261095.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261093/pexels-photo-261093.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261091/pexels-photo-261091.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261089/pexels-photo-261089.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261087/pexels-photo-261087.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261085/pexels-photo-261085.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261083/pexels-photo-261083.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261081/pexels-photo-261081.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261079/pexels-photo-261079.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261077/pexels-photo-261077.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261075/pexels-photo-261075.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261073/pexels-photo-261073.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261071/pexels-photo-261071.jpeg?auto=compress&w=800',
      // === Luxury pools ===
      'https://images.pexels.com/photos/261069/pexels-photo-261069.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261067/pexels-photo-261067.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261065/pexels-photo-261065.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261063/pexels-photo-261063.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261061/pexels-photo-261061.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261059/pexels-photo-261059.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261057/pexels-photo-261057.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261055/pexels-photo-261055.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261053/pexels-photo-261053.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261051/pexels-photo-261051.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261047/pexels-photo-261047.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261046/pexels-photo-261046.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261044/pexels-photo-261044.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261042/pexels-photo-261042.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261040/pexels-photo-261040.jpeg?auto=compress&w=800',
      // === Pool close-ups ===
      'https://images.pexels.com/photos/261038/pexels-photo-261038.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261035/pexels-photo-261035.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261033/pexels-photo-261033.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261031/pexels-photo-261031.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261029/pexels-photo-261029.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261027/pexels-photo-261027.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261025/pexels-photo-261025.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261022/pexels-photo-261022.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261018/pexels-photo-261018.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261016/pexels-photo-261016.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261014/pexels-photo-261014.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261012/pexels-photo-261012.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261010/pexels-photo-261010.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261008/pexels-photo-261008.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261006/pexels-photo-261006.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261004/pexels-photo-261004.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261002/pexels-photo-261002.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/261000/pexels-photo-261000.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260998/pexels-photo-260998.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260996/pexels-photo-260996.jpeg?auto=compress&w=800',
      // === NEW BATCH 2 ===
      'https://images.pexels.com/photos/260994/pexels-photo-260994.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260992/pexels-photo-260992.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260990/pexels-photo-260990.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260988/pexels-photo-260988.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260986/pexels-photo-260986.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260984/pexels-photo-260984.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260982/pexels-photo-260982.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260980/pexels-photo-260980.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260978/pexels-photo-260978.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260976/pexels-photo-260976.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260974/pexels-photo-260974.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260972/pexels-photo-260972.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260970/pexels-photo-260970.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260968/pexels-photo-260968.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260966/pexels-photo-260966.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260964/pexels-photo-260964.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260962/pexels-photo-260962.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260960/pexels-photo-260960.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260958/pexels-photo-260958.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260956/pexels-photo-260956.jpeg?auto=compress&w=800',
      // === BATCH 3 ===
      'https://images.pexels.com/photos/260954/pexels-photo-260954.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260952/pexels-photo-260952.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260950/pexels-photo-260950.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260948/pexels-photo-260948.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260946/pexels-photo-260946.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260944/pexels-photo-260944.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260942/pexels-photo-260942.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260940/pexels-photo-260940.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260938/pexels-photo-260938.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260936/pexels-photo-260936.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260934/pexels-photo-260934.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260932/pexels-photo-260932.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260930/pexels-photo-260930.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260928/pexels-photo-260928.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260926/pexels-photo-260926.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260924/pexels-photo-260924.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260923/pexels-photo-260923.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260921/pexels-photo-260921.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260919/pexels-photo-260919.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260917/pexels-photo-260917.jpeg?auto=compress&w=800',
      // === BATCH 4 ===
      'https://images.pexels.com/photos/260915/pexels-photo-260915.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260913/pexels-photo-260913.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260911/pexels-photo-260911.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260909/pexels-photo-260909.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260907/pexels-photo-260907.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260905/pexels-photo-260905.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260903/pexels-photo-260903.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260901/pexels-photo-260901.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260899/pexels-photo-260899.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260897/pexels-photo-260897.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260895/pexels-photo-260895.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260893/pexels-photo-260893.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260891/pexels-photo-260891.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260889/pexels-photo-260889.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260887/pexels-photo-260887.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260885/pexels-photo-260885.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260883/pexels-photo-260883.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260881/pexels-photo-260881.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260879/pexels-photo-260879.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260877/pexels-photo-260877.jpeg?auto=compress&w=800',
      // === BATCH 5 ===
      'https://images.pexels.com/photos/260875/pexels-photo-260875.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260873/pexels-photo-260873.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260871/pexels-photo-260871.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260869/pexels-photo-260869.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260867/pexels-photo-260867.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260865/pexels-photo-260865.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260863/pexels-photo-260863.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260861/pexels-photo-260861.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260859/pexels-photo-260859.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260857/pexels-photo-260857.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260855/pexels-photo-260855.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260853/pexels-photo-260853.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260851/pexels-photo-260851.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260849/pexels-photo-260849.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260847/pexels-photo-260847.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260845/pexels-photo-260845.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260843/pexels-photo-260843.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260841/pexels-photo-260841.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260839/pexels-photo-260839.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/260837/pexels-photo-260837.jpeg?auto=compress&w=800',
      // === Additional High-Quality Pool Images ===
      // Tropical & Resort
      'https://images.pexels.com/photos/1032650/pexels-photo-1032650.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/1488327/pexels-photo-1488327.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/1488315/pexels-photo-1488315.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/2476632/pexels-photo-2476632.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/1457842/pexels-photo-1457842.jpeg?auto=compress&w=800',
      // Luxury Backyard
      'https://images.pexels.com/photos/1029599/pexels-photo-1029599.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/1080721/pexels-photo-1080721.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/1134176/pexels-photo-1134176.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/2724748/pexels-photo-2724748.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/2507010/pexels-photo-2507010.jpeg?auto=compress&w=800',
      // Evening & Night Pools
      'https://images.pexels.com/photos/2373201/pexels-photo-2373201.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/1838640/pexels-photo-1838640.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/2351286/pexels-photo-2351286.jpeg?auto=compress&w=800',
      // Family Pools
      'https://images.pexels.com/photos/1320684/pexels-photo-1320684.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/1001682/pexels-photo-1001682.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/1322185/pexels-photo-1322185.jpeg?auto=compress&w=800',
      // Pool Details
      'https://images.pexels.com/photos/2736173/pexels-photo-2736173.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/2091166/pexels-photo-2091166.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/2418664/pexels-photo-2418664.jpeg?auto=compress&w=800',
      // â”€â”€ New Pool Images (Legendary Import) â”€â”€
      // Infinity / Vanishing Edge
      'https://images.pexels.com/photos/8085310/pexels-photo-8085310.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/24807132/pexels-photo-24807132.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/30037427/pexels-photo-30037427.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/24807133/pexels-photo-24807133.jpeg?auto=compress&w=800',
      // Geometric & Modern
      'https://images.pexels.com/photos/31817156/pexels-photo-31817156.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/31359181/pexels-photo-31359181.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/11592813/pexels-photo-11592813.jpeg?auto=compress&w=800',
      // Freeform & Lagoon / Tropical
      'https://images.pexels.com/photos/29453302/pexels-photo-29453302.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/15994062/pexels-photo-15994062.jpeg?auto=compress&w=800',
      // Architectural / Luxury
      'https://images.pexels.com/photos/8134745/pexels-photo-8134745.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/8134744/pexels-photo-8134744.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/26859048/pexels-photo-26859048.jpeg?auto=compress&w=800',
      // Resort / Vacation
      'https://images.pexels.com/photos/2986231/pexels-photo-2986231.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/14024023/pexels-photo-14024023.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/15173304/pexels-photo-15173304.jpeg?auto=compress&w=800',
      // Nighttime / Illuminated
      'https://images.pexels.com/photos/4034153/pexels-photo-4034153.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/12934009/pexels-photo-12934009.jpeg?auto=compress&w=800',
      // Aerial / Drone
      'https://images.pexels.com/photos/8688163/pexels-photo-8688163.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/20329473/pexels-photo-20329473.jpeg?auto=compress&w=800',
      // Underwater / Macro / Texture
      'https://images.pexels.com/photos/13448277/pexels-photo-13448277.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/8974468/pexels-photo-8974468.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/7974837/pexels-photo-7974837.jpeg?auto=compress&w=800',
      // Water Features / Baja Shelves
      'https://images.pexels.com/photos/9043966/pexels-photo-9043966.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/8414418/pexels-photo-8414418.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/31591857/pexels-photo-31591857.jpeg?auto=compress&w=800',
      // Natural / Backyard
      'https://images.pexels.com/photos/19075377/pexels-photo-19075377.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/6667430/pexels-photo-6667430.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/6858600/pexels-photo-6858600.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/6858611/pexels-photo-6858611.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/6858665/pexels-photo-6858665.jpeg?auto=compress&w=800',
    ];

    // Working copy of pool images (will be filtered based on user deletions)
    let poolImages = [...originalPoolImages];
    let deletedPoolImages = []; // Track deleted images for persistence

    // Generate dynamic headlines from parts
    const headlineMainParts = [
      "Dive Into Crystal Clear", "Your Pool Paradise", "Sparkling Clean", "Pool Perfection", "Crystal Clear Results",
      "The Clear Choice", "Swim In Confidence", "Premium Pool Service", "Relax & Enjoy", "Expert Pool Care",
      "Making Waves", "Your Pool's Best Friend", "Stress-Free Swimming", "Pure Water Promise", "Pool Problems?",
      "Summer Ready", "Pristine Pools", "Blue Water Bliss", "Splash Into Savings", "Clear Water Ahead",
      "Pool Care Pros", "Refresh Your Pool", "Swim More", "Your Backyard Oasis", "Clean. Clear. Perfect.",
      "Pool Service Done Right", "Transform Your Pool", "Where Quality Meets", "Experience The Difference",
      "Life's Better Poolside", "Trusted Pool Experts", "Keep Calm", "Beyond Clean", "Pool Service Redefined",
      "Your Pool. Our Passion.", "Aqua Excellence", "The Pool Whisperers", "Water Works Wonders", "Pool Paradise Found",
      "Certified Clean", "The Blue Crew", "Pool Pros Unite", "Splash Zone Experts", "H2O Heroes",
      "Crystal Clarity", "Pool Patrol", "Dive In Ready", "Swim Season Saviors", "Pool Party Prep",
      "Backyard Bliss", "The Pool Doctors", "Water Wizards", "Pool Perfectionists", "Clean Machine",
      "Aquatic Excellence", "Pool Power", "The Deep Clean", "Water Works", "Pool Pioneers",
      "Liquid Luxury", "The Pool Masters", "Swim Smart", "Pool Zen", "Aqua Advantage",
      "The Clear Solution", "Pool Therapy", "Water Wellness", "Pool Pride", "Crystal Crew",
      "The Splash Squad", "Pool Harmony", "Aqua Elite", "Pure Pool", "The Ripple Effect",
      "Pool Serenity", "Water Winners", "Pool Prestige", "Swim Supreme", "Aqua Artisans",
      // More Catchy Headlines
      "Don't Sweat It", "We've Got This", "Splash Without Stress", "Your Oasis Awaits",
      "Summer's Calling", "Poolside Perfection", "Make A Splash", "Ready Set Swim",
      "Chill Out", "Beat The Heat", "Cool Down", "Dive Right In",
      "Pool Goals", "Living The Dream", "Paradise Found", "Weekend Ready",
      "Sun's Out", "Pool's Open", "Jump Right In", "Take The Plunge",
      "No More Green", "Say Goodbye To Algae", "Hello Crystal Clear", "Pool Problems Solved",
      "Stress-Free Pools", "Worry-Free Swimming", "Hassle-Free Service", "Effortless Pool Care",
      "Your Pool Deserves", "Treat Your Pool", "Love Your Pool Again", "Fall In Love",
      "Time To Relax", "You Deserve This", "Sit Back & Relax", "Leave It To Us",
      // Cliffhanger Headlines (Legendary) â€” force card flip
      "3 Things Destroying Your Pool", "Your Neighbors Know Something", "Is Your Pool Aging Twice As Fast?",
      "The #1 Pool Mistake", "What Your Pool Guy Won't Tell You", "Before Your Next Pool Party",
      "Warning: Pool Season Alert", "Don't Swim Until You Read This", "The Hidden Cost Of Ignoring Your Pool",
      "Your Pool Tested Positive For...", "1 in 3 Pools Have This Problem", "This Postcard Saves You $1,000"
    ];
    const headlineSubParts = [
      "Pool Care Excellence", "Awaits", "Guaranteed", "Delivered Weekly", "Every Time",
      "For Pool Care", "We Handle The Rest", "At Your Doorstep", "We've Got Your Pool", "You Can Trust",
      "In Pool Service", "Since Day One", "Starts Here", "100% Satisfaction", "We Solve Them All",
      "All Year Round", "Happy Families", "Professional Care", "Quality Service", "Expert Maintenance",
      "At Your Service", "Revive Your Summer", "Worry Less", "Deserves The Best", "Every Single Time",
      "The First Time", "Transform Your Life", "Crystal Clear Water", "Professional Pool Care",
      "We Make It Happen", "In Your Neighborhood", "And Swim On", "Beyond Compare", "Excellence Delivered",
      "Exceptional Results", "Water Perfected", "Making Splashes", "Done Right Daily", "Your Way",
      "No Stress Required", "Peace of Mind", "Reliability Guaranteed", "Family Approved", "Neighbor Recommended",
      "Value Driven", "Results Focused", "Quality Assured", "Trust Earned", "Service Perfected",
      "Care You Deserve", "Excellence Standard", "Premium Quality", "Top Tier Service", "Best In Class",
      "Industry Leaders", "Setting Standards", "Raising The Bar", "Above & Beyond", "Next Level Care"
    ];
    // Dynamically generate headlines by combining parts
    const headlines = [];
    for (let i = 0; i < headlineMainParts.length; i++) {
      headlines.push({ main: headlineMainParts[i], sub: headlineSubParts[i % headlineSubParts.length] });
      headlines.push({ main: headlineMainParts[i], sub: headlineSubParts[(i + 7) % headlineSubParts.length] });
      headlines.push({ main: headlineMainParts[i], sub: headlineSubParts[(i + 13) % headlineSubParts.length] });
    }

    const services = [
      "Weekly Chemical Balancing & Testing", "Professional Skimming & Brushing", "Filter Cleaning & Maintenance",
      "Equipment Inspection & Repair", "Green Pool Recovery", "Algae Prevention Treatment",
      "pH & Chlorine Optimization", "Pump & Motor Servicing", "Tile & Surface Cleaning",
      "Water Level Management", "Salt Cell Cleaning", "Digital Service Reports",
      "Vacation Pool Watch", "Emergency Pool Service", "Pool Opening & Closing",
      "Leak Detection Service", "Energy Efficiency Audit", "Child Safety Inspections",
      "Automatic Cleaner Service", "Heater Maintenance", "Pool Light Repair",
      "Deck Pressure Washing", "Calcium Removal", "Stain Treatment",
      "Water Feature Service", "Spa & Hot Tub Care", "Winterization Service",
      "De-Winterization Service", "Pool Resurfacing Consult", "Equipment Upgrades",
      "Variable Speed Pump Install", "LED Light Conversion", "Salt System Installation",
      "Robotic Cleaner Setup", "Pool Cover Service", "Safety Cover Installation",
      "Fence & Gate Inspection", "Drain & Acid Wash", "Bead Blasting",
      "Coping Repair", "Pool Deck Sealing", "Underwater Repair",
      "Plaster Patching", "Grout Restoration", "Skimmer Repair",
      "Main Drain Service", "Return Jet Optimization", "Suction Line Cleaning",
      "Pressure Line Service", "Valve Replacement", "O-Ring Service",
      "Gasket Replacement", "Impeller Cleaning", "Motor Bearing Service",
      "Capacitor Testing", "Timer Programming", "Automation Setup",
      "Remote Control Programming", "Chemical Automation", "pH Controller Install",
      "ORP Monitoring Setup", "Flow Meter Installation", "Pressure Gauge Service",
    ];

    // Generate dynamic discounts
    const discountAmounts = [
      "$25 OFF", "$50 OFF", "$75 OFF", "$99 OFF", "$100 OFF", "$125 OFF", "$150 OFF", "$175 OFF", "$200 OFF",
      "15% OFF", "20% OFF", "25% OFF", "30% OFF", "35% OFF", "40% OFF", "45% OFF", "50% OFF", "60% OFF", "70% OFF",
      "FREE", "BOGO", "2 FOR 1", "BUY 2", "BUY 3", "HALF OFF", "1/2 PRICE",
      "SAVE $25", "SAVE $50", "SAVE $75", "SAVE $100", "SAVE $150", "SAVE BIG",
      "1 WEEK", "2 WEEKS", "1 MONTH", "3 MONTHS", "6 MONTHS"
    ];
    const discountTexts = [
      // Short pool-specific texts (max ~12 chars to fit badge)
      "First Month!", "First Clean!", "New Client!", "Any Service!",
      "Pool Clean!", "Pool Service!", "Monthly!", "Weekly!",
      "Full Season!", "Annual Plan!", "Filter Fix!", "Water Test!",
      "Green Pool!", "Pool Shock!", "Tile Clean!", "Pump Fix!",
      "Pool Heater!", "Salt System!", "Pool Open!", "Pool Close!",
      "This Week!", "Act Now!", "Book Today!", "Call Now!",
      "Limited!", "Don't Wait!", "Local Deal!", "Intro Offer!",
    ];
    const discounts = [];
    for (let i = 0; i < discountAmounts.length; i++) {
      for (let j = 0; j < 3; j++) {
        discounts.push({ amount: discountAmounts[i], text: discountTexts[(i + j * 7) % discountTexts.length] });
      }
    }

    const taglines = [
      "Serving Winter Park & Surrounding Areas", "Locally Owned & Operated", "Trusted by 500+ Families", "Licensed & Insured", "5-Star Rated Service",
      "Family Owned Since 2020", "Your Neighbors Trust Us", "Satisfaction Guaranteed", "Same Day Service Available",
      "Serving Your Community", "Excellence in Every Detail", "Where Service Meets Quality", "Your Pool Care Partner",
      "Committed to Excellence", "Trusted Since Day One", "Professional & Reliable", "Quality You Can Count On",
      "Premier Pool Specialists", "Award-Winning Service", "Customer First Always", "The Neighborhood Choice",
      "Trusted by 1000+ Homes", "Serving Families Since 2015", "Your Local Pool Experts", "Reliability You Deserve",
      "Where Quality Matters", "Excellence is Our Standard", "Professional Pool Technicians", "Community Trusted",
      "Family Values, Pro Results", "Your Satisfaction, Our Mission", "Dedicated to Your Pool", "Service With Integrity",
      "Pool Care You Can Trust", "Excellence Guaranteed", "Neighbors Serving Neighbors", "Quality Without Compromise",
      "Your Pool, Our Priority", "Trusted Pool Professionals", "Service Excellence Daily", "Community First Always",
      "Where Pools Shine Bright", "Caring for Pools Since Day 1", "Your Trusted Pool Partner", "Service Beyond Expected",
      "Quality in Every Visit", "Professional Care Always", "Trusted by Your Neighbors", "Excellence in Pool Care",
      "Serving With Pride", "Quality Service Guaranteed", "Your Pool Deserves the Best", "Trusted Local Experts",
      "Family Owned, Community Loved", "Professional Results Every Time", "Dedicated Pool Specialists", "Service You Can Trust",
      "Where Excellence Meets Care", "Your Neighborhood Pool Pros", "Quality That Shows", "Trusted for Generations",
    ];

    // Generate dynamic testimonials
    const testimonialTexts = [
      "Best pool service in town! Crystal clear water every week.",
      "Finally found a reliable pool company. Highly recommend!",
      "Professional, punctual, and my pool has never looked better!",
      "They fixed issues other companies missed. True experts!",
      "Worth every penny. Our pool is always swim-ready!",
      "Responsive and thorough. Can't imagine using anyone else.",
      "Our pool went from green to pristine in one visit!",
      "The best decision we made for our pool. Outstanding!",
      "They treat our pool like it's their own. 10/10!",
      "Incredible attention to detail. Truly professionals!",
      "Saved us from a disaster. Quick, efficient, affordable!",
      "My neighbors are jealous of how clean our pool is!",
      "Five years with them and never a single issue!",
      "They explain everything clearly. No hidden surprises!",
      "Best investment for our backyard. Absolutely love them!",
      "Quick response, fair prices, amazing results!",
      "Our kids can swim safely thanks to their expertise!",
      "Pool parties are back! Thanks to their amazing work!",
      "Transformed our neglected pool into a sparkling oasis!",
      "Honest, reliable, and extremely knowledgeable!",
      "They go above and beyond every single time!",
      "Our pool has never been cleaner. Simply amazing!",
      "Wish we found them sooner. Game changer!",
      "Professional service from start to finish!",
      "They saved us thousands in potential repairs!",
      "Consistent quality service week after week!",
      "The only pool company we'll ever use!",
      "Exceeded all our expectations. Truly impressed!",
      "Fair pricing, exceptional results. Love them!",
      "Made pool ownership actually enjoyable!",
      "Our go-to pool experts. Highly trusted!",
      "They really know their stuff. Experts!",
      "Can't say enough good things about them!",
      "Reliable, professional, and always on time!",
      "Best customer service I've ever experienced!",
      "They treat every pool like it's their own!",
      "Finally, a company that delivers on promises!",
      "Our pool is the envy of the neighborhood!",
      "Stress-free pool ownership thanks to them!",
      "Worth every single penny. No regrets!",
    ];
    const testimonialAuthors = [
      "Sarah M.", "Mike R.", "Jennifer L.", "David K.", "Amanda T.", "Chris B.", "Robert H.", "Lisa P.",
      "James W.", "Maria G.", "Tom S.", "Karen D.", "Steve J.", "Nancy F.", "Paul A.", "Diana C.",
      "Mark T.", "Jessica R.", "Brian H.", "Sandra L.", "Kevin M.", "Patricia N.", "George O.", "Helen P.",
      "Frank Q.", "Linda R.", "Dennis S.", "Barbara T.", "Ronald U.", "Carol V.", "Gary W.", "Ruth X.",
      "Timothy Y.", "Sharon Z.", "Jason A.", "Michelle B.", "Eric C.", "Laura D.", "Scott E.", "Donna F.",
      "Raymond G.", "Cynthia H.", "Jeffrey I.", "Pamela J.", "Gregory K.", "Angela L.", "Edward M.", "Rebecca N.",
    ];
    const testimonialLocations = [
      "Happy Customer", "Satisfied Client", "5-Star Review", "Loyal Customer", "Verified Review", "Local Resident",
      "Amazed Customer", "Homeowner", "Regular Client", "Pool Owner", "Grateful Customer", "Proud Owner",
      "Long-time Client", "Happy Family", "Satisfied Dad", "New Customer", "Family Man", "Party Host",
      "Repeat Customer", "Neighbor", "Community Member", "First-time Buyer", "Returning Client", "VIP Member",
    ];
    const testimonials = [];
    for (let i = 0; i < testimonialTexts.length; i++) {
      testimonials.push({
        text: testimonialTexts[i],
        author: testimonialAuthors[i % testimonialAuthors.length],
        location: testimonialLocations[i % testimonialLocations.length]
      });
    }

    const urgencyTexts = [
      "LIMITED TIME OFFER!", "CALL TODAY!", "ACT NOW!", "DON'T MISS OUT!", "EXPIRES SOON!", "BOOK NOW!",
      "HURRY - LIMITED SPOTS!", "THIS WEEK ONLY!", "SPRING SPECIAL!", "SUMMER SAVINGS!", "NEIGHBORS ARE CALLING!",
      "OFFER ENDS FRIDAY!", "LAST CHANCE!", "WHILE SUPPLIES LAST!", "NEW CUSTOMER BONUS!", "EXCLUSIVE DEAL!",
      "SEASONAL DISCOUNT!", "RESERVE YOUR SPOT!", "ENDING SOON!", "HOT DEAL!", "FLASH SALE!", "TODAY ONLY!",
      "48 HOURS LEFT!", "WEEKEND SPECIAL!", "MONDAY MADNESS!", "FINAL DAYS!", "FIRST 50 ONLY!", "VIP EXCLUSIVE!",
      "MEMBERS SPECIAL!", "NEIGHBORS LOVE US!", "BOOKING FAST!", "LIMITED AVAILABILITY!", "SCHEDULE NOW!",
      "SPOTS FILLING UP!", "DON'T WAIT!", "PRICES GOING UP!", "LOCK IN SAVINGS!", "BEAT THE RUSH!",
      "EARLY BIRD DEAL!", "SUMMER IS HERE!", "POOL SEASON SPECIAL!", "NEIGHBORHOOD OFFER!", "LOCAL DEAL!",
      "COMMUNITY DISCOUNT!", "REFERRAL BONUS!", "LOYALTY REWARD!", "THANK YOU SALE!", "APPRECIATION DEAL!",
      "GRAND OPENING!", "NEW IN TOWN!", "INTRODUCING...", "JUST LAUNCHED!", "BRAND NEW OFFER!",
      // Professional date-based urgency
      "EXPIRES 01/31", "VALID THRU 02/28", "OFFER ENDS 03/15", "MUST CALL BY FRIDAY",
      "ONLY 10 SPOTS LEFT", "FIRST SERVICE FREE", "MENTION THIS CARD", "PRESENT TO REDEEM",
      "ONE-TIME OFFER", "EXCLUSIVE INVITATION", "BY APPOINTMENT ONLY", "PRIORITY BOOKING",
    ];

    const ctaTexts = [
      "Get Your FREE Quote!", "Schedule Your Service Today!", "Call Now for a Free Estimate!", "Book Your Free Inspection!",
      "Claim Your Discount Now!", "Start Your Free Trial!", "Request a Callback!", "Get Started Today!",
      "Unlock Your Savings!", "Join Happy Pool Owners!", "See the Difference!", "Transform Your Pool Now!",
      "Yes! I Want a Clean Pool!", "Claim My Free Quote!", "Schedule My Service!", "Get Pool-Ready Today!",
      "Start Saving Now!", "Book My Free Visit!", "Call Us Today!", "Get Your Quote!", "Book Online Now!",
      "Reserve Your Spot!", "Claim This Offer!", "Start My Service!", "Get My Discount!", "Schedule Now!",
      "Request Quote!", "Book Appointment!", "Claim Savings!", "Start Today!", "Call For Details!",
      "Learn More!", "Get Pricing!", "See What We Do!", "Contact Us!", "Reach Out Today!",
      "Let's Get Started!", "Ready to Swim?", "Make the Call!", "Take the Plunge!", "Dive In!",
      "Get Splashing!", "Experience Clean!", "Join the Club!", "Become a Member!", "Sign Up Now!",
      "Register Today!", "Apply Now!", "Redeem Offer!", "Activate Savings!", "Unlock Deal!",
      // Professional/elegant CTAs
      "Request Your Consultation", "Schedule a Visit", "Speak With an Expert", "Get Expert Advice",
      "Claim Your Offer", "Secure Your Spot", "Begin Your Service", "Start Your Journey",
      "Experience Excellence", "Discover the Difference", "Elevate Your Pool", "Transform Today",
      // Contextual / Cliffhanger CTAs (Legendary)
      "Is Your Pool Ready? Find Out \u2192", "Text POOL to Get Your Quote", "Scan. Book. Swim. \u2192",
      "3 Problems. 1 Call. \u2192", "Your Neighbors Already Called \u2192", "What's Hiding In Your Pool? \u2192",
      "Flip For Your Exclusive Offer \u2192", "Stop! Read The Back First \u2192", "Your Pool Score: ??? \u2192",
      "See What We Found \u2192", "Before & After Inside \u2192", "Unlock Your Pool's Potential \u2192",
      "Get Your Free Pool Report \u2192", "Don't Wait. Text Now. \u2192", "One Call Away From Clean \u2192",
    ];

    const trustBadges = [
      "Licensed & Insured", "100% Satisfaction Guaranteed", "5-Star Google Rating", "BBB Accredited", "Locally Owned",
      "Background Checked Techs", "Same Day Service", "No Contracts Required", "Free Estimates", "Certified Technicians",
      "EPA Compliant", "Award Winning", "Family Owned", "Eco-Friendly Products", "24/7 Support", "Veteran Owned",
      "10+ Years Experience", "Money Back Guarantee", "Top Rated 2024", "Trusted by 1000+ Homes", "A+ Rating",
      "Bonded & Insured", "CPO Certified", "APSP Member", "IPSSA Certified", "Pool Pro Certified",
      "5-Star Yelp Rating", "Angi Certified", "HomeAdvisor Approved", "Thumbtack Pro", "NextDoor Favorite",
      "Google Guaranteed", "Facebook Recommended", "Instagram Featured", "TikTok Verified", "YouTube Reviewed",
      "Fast Response Time", "On-Time Guarantee", "Clean Techs", "Uniformed Professionals", "Marked Vehicles",
      "GPS Tracked", "Real-Time Updates", "Photo Reports", "Digital Invoicing", "Online Booking",
      "Text Notifications", "Email Summaries", "Customer Portal", "Mobile App", "Live Chat Support",
      "Bilingual Staff", "Senior Discounts", "Military Discounts", "First Responder Deals", "Teacher Appreciation",
      // Social Proof - Review Counts
      "500+ 5-Star Reviews", "1000+ Happy Customers", "2000+ Pools Serviced", "5000+ Services Completed",
      "98% Customer Retention", "99% On-Time Rate", "100% Response Rate", "4.9â˜… Average Rating",
      // Social Proof - Google Specific
      "Google 5.0â˜… Rating", "200+ Google Reviews", "Google Local Guide Pick", "Google Screened",
      // Social Proof - Awards
      "Best of 2024", "Readers Choice Award", "Community Favorite", "Editor's Pick",
      "Top 10 Pool Company", "#1 Rated Locally", "Excellence Award", "Service Excellence",
      // Social Proof - Certifications
      "State Licensed", "Fully Bonded", "Workers Comp Covered", "Liability Insured",
      "Drug-Free Workplace", "Safety Certified", "Green Business Certified", "Quality Assured",
      // Social Proof - Trust Signals
      "Serving Since 2010", "3rd Generation", "Woman Owned", "Minority Owned",
      "Small Business", "Local Family", "Your Neighbors", "Community Partner",
    ];

    const colorThemes = [
      { primary: '#0891b2', secondary: '#06b6d4', accent: '#22d3ee', name: 'Ocean' },
      { primary: '#0d9488', secondary: '#14b8a6', accent: '#2dd4bf', name: 'Teal' },
      { primary: '#2563eb', secondary: '#3b82f6', accent: '#60a5fa', name: 'Royal' },
      { primary: '#7c3aed', secondary: '#8b5cf6', accent: '#a78bfa', name: 'Purple' },
      { primary: '#059669', secondary: '#10b981', accent: '#34d399', name: 'Emerald' },
      { primary: '#dc2626', secondary: '#ef4444', accent: '#f87171', name: 'Ruby' },
      { primary: '#ea580c', secondary: '#f97316', accent: '#fb923c', name: 'Sunset' },
      { primary: '#0284c7', secondary: '#0ea5e9', accent: '#38bdf8', name: 'Sky' },
      { primary: '#4f46e5', secondary: '#6366f1', accent: '#818cf8', name: 'Indigo' },
      { primary: '#be185d', secondary: '#ec4899', accent: '#f472b6', name: 'Pink' },
      { primary: '#047857', secondary: '#059669', accent: '#10b981', name: 'Forest' },
      { primary: '#1d4ed8', secondary: '#2563eb', accent: '#3b82f6', name: 'Sapphire' },
      { primary: '#9333ea', secondary: '#a855f7', accent: '#c084fc', name: 'Violet' },
      { primary: '#b91c1c', secondary: '#dc2626', accent: '#ef4444', name: 'Crimson' },
      { primary: '#c2410c', secondary: '#ea580c', accent: '#f97316', name: 'Tangerine' },
      { primary: '#0369a1', secondary: '#0284c7', accent: '#0ea5e9', name: 'Azure' },
      { primary: '#115e59', secondary: '#0f766e', accent: '#14b8a6', name: 'Deep Teal' },
      { primary: '#1e3a8a', secondary: '#1d4ed8', accent: '#2563eb', name: 'Navy' },
      { primary: '#166534', secondary: '#15803d', accent: '#22c55e', name: 'Grass' },
      { primary: '#9d174d', secondary: '#be185d', accent: '#db2777', name: 'Magenta' },
      { primary: '#0e7490', secondary: '#0891b2', accent: '#06b6d4', name: 'Cyan' },
      { primary: '#854d0e', secondary: '#a16207', accent: '#ca8a04', name: 'Gold' },
      { primary: '#374151', secondary: '#4b5563', accent: '#6b7280', name: 'Slate' },
      { primary: '#0f172a', secondary: '#1e293b', accent: '#334155', name: 'Midnight' },
      { primary: '#065f46', secondary: '#047857', accent: '#059669', name: 'Pine' },
      { primary: '#7e22ce', secondary: '#9333ea', accent: '#a855f7', name: 'Grape' },
      { primary: '#991b1b', secondary: '#b91c1c', accent: '#dc2626', name: 'Scarlet' },
      { primary: '#9a3412', secondary: '#c2410c', accent: '#ea580c', name: 'Rust' },
      { primary: '#1e40af', secondary: '#1d4ed8', accent: '#2563eb', name: 'Cobalt' },
      { primary: '#134e4a', secondary: '#115e59', accent: '#0f766e', name: 'Spruce' },
      { primary: '#312e81', secondary: '#3730a3', accent: '#4338ca', name: 'Iris' },
      { primary: '#831843', secondary: '#9d174d', accent: '#be185d', name: 'Rose' },
      { primary: '#78350f', secondary: '#92400e', accent: '#b45309', name: 'Amber' },
      { primary: '#064e3b', secondary: '#065f46', accent: '#047857', name: 'Jade' },
      { primary: '#581c87', secondary: '#6b21a8', accent: '#7e22ce', name: 'Plum' },
      { primary: '#7f1d1d', secondary: '#991b1b', accent: '#b91c1c', name: 'Maroon' },
      { primary: '#713f12', secondary: '#78350f', accent: '#92400e', name: 'Bronze' },
      { primary: '#022c22', secondary: '#064e3b', accent: '#065f46', name: 'Evergreen' },
      { primary: '#3b0764', secondary: '#581c87', accent: '#6b21a8', name: 'Eggplant' },
      { primary: '#450a0a', secondary: '#7f1d1d', accent: '#991b1b', name: 'Burgundy' },
      { primary: '#172554', secondary: '#1e3a8a', accent: '#1e40af', name: 'Sapphire Dark' },
      { primary: '#083344', secondary: '#164e63', accent: '#155e75', name: 'Petrol' },
      { primary: '#1a2e05', secondary: '#365314', accent: '#3f6212', name: 'Olive' },
      { primary: '#422006', secondary: '#713f12', accent: '#854d0e', name: 'Sepia' },
      { primary: '#27272a', secondary: '#3f3f46', accent: '#52525b', name: 'Charcoal' },
      { primary: '#18181b', secondary: '#27272a', accent: '#3f3f46', name: 'Onyx' },
      { primary: '#44403c', secondary: '#57534e', accent: '#78716c', name: 'Stone' },
      { primary: '#292524', secondary: '#44403c', accent: '#57534e', name: 'Espresso' },
      // Seasonal Themes - Summer
      { primary: '#f59e0b', secondary: '#fbbf24', accent: '#fcd34d', name: 'Summer Sun' },
      { primary: '#06b6d4', secondary: '#22d3ee', accent: '#67e8f9', name: 'Summer Sky' },
      { primary: '#10b981', secondary: '#34d399', accent: '#6ee7b7', name: 'Summer Grass' },
      { primary: '#f97316', secondary: '#fb923c', accent: '#fdba74', name: 'Summer Orange' },
      // Seasonal Themes - Tropical
      { primary: '#14b8a6', secondary: '#2dd4bf', accent: '#5eead4', name: 'Tropical Teal' },
      { primary: '#84cc16', secondary: '#a3e635', accent: '#bef264', name: 'Tropical Lime' },
      { primary: '#ec4899', secondary: '#f472b6', accent: '#f9a8d4', name: 'Tropical Pink' },
      { primary: '#8b5cf6', secondary: '#a78bfa', accent: '#c4b5fd', name: 'Tropical Violet' },
      // Seasonal Themes - Spring
      { primary: '#22c55e', secondary: '#4ade80', accent: '#86efac', name: 'Spring Green' },
      { primary: '#a855f7', secondary: '#c084fc', accent: '#d8b4fe', name: 'Spring Lilac' },
      { primary: '#f43f5e', secondary: '#fb7185', accent: '#fda4af', name: 'Spring Rose' },
      { primary: '#eab308', secondary: '#facc15', accent: '#fde047', name: 'Spring Yellow' },
      // Seasonal Themes - Fall
      { primary: '#c2410c', secondary: '#ea580c', accent: '#f97316', name: 'Fall Orange' },
      { primary: '#b45309', secondary: '#d97706', accent: '#f59e0b', name: 'Fall Amber' },
      { primary: '#a16207', secondary: '#ca8a04', accent: '#eab308', name: 'Fall Gold' },
      { primary: '#92400e', secondary: '#b45309', accent: '#d97706', name: 'Fall Harvest' },
      // Seasonal Themes - Winter
      { primary: '#0284c7', secondary: '#0ea5e9', accent: '#38bdf8', name: 'Winter Ice' },
      { primary: '#6366f1', secondary: '#818cf8', accent: '#a5b4fc', name: 'Winter Frost' },
      { primary: '#64748b', secondary: '#94a3b8', accent: '#cbd5e1', name: 'Winter Silver' },
      { primary: '#1e3a8a', secondary: '#1d4ed8', accent: '#3b82f6', name: 'Winter Night' },
      // Dark + Neon High-Contrast (Legendary)
      { primary: '#0a0a1a', secondary: '#1a1a2e', accent: '#00f0ff', name: 'Midnight Cyan' },
      { primary: '#111111', secondary: '#1a1a1a', accent: '#a3ff00', name: 'Obsidian Lime' },
      { primary: '#1a1510', secondary: '#2a2520', accent: '#ffd700', name: 'Dark Gold' },
      { primary: '#0d0008', secondary: '#1a0012', accent: '#ff2d6f', name: 'Noir Rose' },
      { primary: '#141414', secondary: '#1e1e1e', accent: '#ff4500', name: 'Carbon Fire' },
      { primary: '#0a0012', secondary: '#150020', accent: '#bf5af2', name: 'Stealth Purple' },
      { primary: '#0f1419', secondary: '#1a2332', accent: '#00d4ff', name: 'Arctic Steel' },
      { primary: '#1a0e08', secondary: '#2a1810', accent: '#ff6b35', name: 'Blood Orange' },
      { primary: '#0a1a14', secondary: '#102a20', accent: '#00ff88', name: 'Electric Mint' },
      { primary: '#0c1117', secondary: '#141c25', accent: '#4da6ff', name: 'Titanium Blue' },
      { primary: '#0f0f0f', secondary: '#1a1a1a', accent: '#d4af37', name: 'Onyx Gold' },
      { primary: '#001219', secondary: '#002635', accent: '#0af5e8', name: 'Deep Ocean Neon' },
    ];

    const layouts = [
      // Direct Mail (USPS Compliant)
      'clearRipples', 'directMailPro', 'eddmStandard', 'addressedMail',
      // Professional
      'premium', 'hero', 'directResponse', 'cleanModern', 'luxury', 'corporate', 'executive', 'consulting',
      // Classic
      'split', 'overlay', 'diagonal', 'framed', 'minimal', 'centered', 'asymmetric', 'thirds',
      // Creative
      'magazine', 'polaroid', 'geometric', 'bold', 'wave', 'collage', 'mosaic', 'stacked',
      // Modern
      'gradient', 'glassmorphism', 'neon', 'duotone', 'brutalist', 'swiss', 'techno', 'cyber',
      // Vintage
      'retro', 'artDeco', 'postmark', 'newspaper', 'vintage', 'classic', 'antique', 'sepia',
      // Marketing
      'coupon', 'ticket', 'ribbon', 'spotlight', 'comparison', 'testimonialFocus', 'guarantee', 'urgentSale',
      // Themed
      'sunset', 'nature', 'coastal', 'tropical', 'elegant', 'playful', 'industrial', 'rustic',
      // Shapes & Geometric
      'hexGrid', 'diamondCut', 'circleFrame', 'triangleSlice', 'chevronStack', 'honeycomb', 'prism', 'octagon',
      'pentagonPop', 'starBurst', 'arrowPoint', 'shieldBadge', 'ribbonBanner', 'cornerFold', 'stepLadder', 'pyramidStack',
      // Dynamic Cuts
      'slashDivide', 'curveSweep', 'zigzag', 'tornEdge', 'liquidBlob', 'mountainPeak', 'waveStack', 'ribbonFlow',
      'spiralCut', 'thunderBolt', 'heartCurve', 'splashZone', 'fireEdge', 'iceShards', 'cloudFloat', 'sunRays',
      // Premium Luxury
      'goldAccent', 'marbleTouch', 'velvetLux', 'champagne', 'blackGold', 'roseGold', 'platinumEdge', 'crystalClear',
      'diamondLux', 'pearlShine', 'bronzeAge', 'silverLining', 'obsidianNight', 'ivoryTower', 'sapphireBlue', 'emeraldCity',
      // Photo Focus
      'photoFrame', 'polaroidStack', 'filmStrip', 'windowPane', 'galleryWall', 'spotlight3D', 'lensFocus', 'doubleExposure',
      'vintageLens', 'bokehBlur', 'splitScreen', 'triPanel', 'circularReveal', 'peelBack', 'stackedPhotos', 'photoMontage',
      // Typography Bold
      'bigType', 'verticalText', 'overlappingText', 'outlineType', 'shadowType', 'cutoutText', 'neonSign', 'retroType',
      'scriptFlow', 'blockLetters', 'gradientText', 'glitchType', 'typewriter', 'stencilType', 'embossedText', 'stackedType',
      // Seasonal Pool
      'summerSplash', 'springFresh', 'autumnWarm', 'winterCrisp', 'poolParty', 'tropicalParadise', 'desertOasis', 'sunsetSwim',
      'beachVibes', 'palmSunset', 'oceanWave', 'starryNight', 'goldenHour', 'mistyMorning', 'rainbowBright', 'neonNight',
      // 3D & Depth
      'isometric', 'floatingCards', 'layeredDepth', 'shadowBox', 'popOut', 'foldedCorner', 'paperCraft', 'origami',
      'cubeStack', 'sphereFloat', 'ribbonTwist', 'pageFlip', 'cardFan', 'accordion', 'stairStep', 'tunnelDepth',
      // Pattern Based
      'dotMatrix', 'lineArt', 'crosshatch', 'circuitBoard', 'topographic', 'waterRipple', 'palmLeaves', 'tiledMosaic',
      'chevronPattern', 'scalePattern', 'brickWall', 'fishScale', 'arabesque', 'plaidCheck', 'polkaDots', 'stripeWave',
      // Unique Concepts
      'splitPersonality', 'beforeAfter', 'puzzlePiece', 'infographic', 'timeline', 'mapStyle', 'badgeHeavy', 'iconGrid',
      'newspaperAd', 'ticketStub', 'recipeCard', 'postcardVintage', 'gameCard', 'idBadge', 'couponBook', 'eventFlyer',
      // Pool Specific
      'poolsideView', 'underwaterBlue', 'splashAction', 'poolFloat', 'divingBoard', 'infinityEdge', 'nightSwim', 'familyFun',
      'crystalWater', 'tiledPool', 'palmReflection', 'poolPartyNight', 'lazyRiver', 'waterfallEdge', 'spaRetreat', 'olympicLanes',
      // Bold & Impactful
      'megaBold', 'contrastPop', 'neonGlow', 'electricShock', 'fireSale', 'iceBreaker', 'thunderStrike', 'explosionBurst',
      'spotlightHero', 'redCarpet', 'vipAccess', 'limitedEdition', 'flashSale', 'grandOpening', 'lastChance', 'actNow',
      // Artistic
      'watercolor', 'oilPaint', 'sketchStyle', 'comicBook', 'popArt', 'abstractArt', 'minimalistArt', 'geometricArt',
      'brushStroke', 'inkSplash', 'charcoalDraw', 'pastelDream', 'acrylicPour', 'mosaicArt', 'stainedGlass', 'graffiti',
      // Trust Building
      'testimonialCard', 'reviewHighlight', 'awardWinner', 'certifiedPro', 'familyOwned', 'localHero', 'communityChoice', 'guaranteeSeal',
      'beforeAfterSplit', 'statsShowcase', 'teamPhoto', 'yearsExperience', 'satisfactionBadge', 'moneyBack', 'freeQuote', 'noObligation'
    ];
    const fonts = [
      'Playfair Display', 'Poppins', 'Montserrat', 'Raleway', 'Inter', 'Oswald', 'Lora', 'Roboto Slab',
      'Merriweather', 'Libre Baskerville', 'Josefin Sans', 'Quicksand', 'Nunito', 'Open Sans', 'Source Sans Pro',
      'Work Sans', 'Rubik', 'Karla', 'Archivo', 'Barlow', 'DM Sans', 'Manrope', 'Space Grotesk', 'Sora',
      'Plus Jakarta Sans', 'Outfit', 'Lexend', 'Figtree', 'Geist', 'Satoshi'
    ];

    // Back side layout variations
    const backLayouts = [
      'lShape', 'twoColumn', 'centered', 'leftHeavy', 'gridServices',
      'testimonialFocus', 'mapStyle', 'couponStyle', 'minimal', 'bold',
      'stacked', 'horizontal', 'cardStyle', 'modern', 'classic'
    ];

    // ==================== STATE ====================
    let currentDesign = {
      layout: 'split',
      backLayout: 'lShape',
      theme: colorThemes[0],
      headline: headlines[0],
      services: [],
      discount: discounts[0],
      tagline: taglines[0],
      poolImage: poolImages[0],
      font: fonts[0],
      logoUrl: 'logo.png',
      logoSize: 40,
      logoWhiteBox: false,
      qrUrl: 'qrcode.png',
      testimonial: testimonials[0],
      urgency: urgencyTexts[0],
      cta: ctaTexts[0],
      trustBadge: trustBadges[0],
      trustBadge2: trustBadges[1],
      // Marketing fields
      couponCode: '',
      expirationDate: '',
      callTrackingNumber: '',
      // Language mode
      language: 'en', // 'en', 'es', 'bilingual'
      // New feature flags
      showWatermark: false,
      watermarkStyle: 'diagonal',
      showGuarantee: false,
      guaranteeType: 'satisfaction',
      showEmergency: false,
      emergencyType: '247',
      showReferral: false,
      referralAmount: '25',
      referralType: 'both',
      showBundleDeal: false,
      bundleType: 'weekly-chemical',
      headlineFont: '',
      bodyFont: '',
      qrStyle: null,
      imageFilters: null,
      borderStyle: null,
      showCredentials: false,
      credentials: { license: '', insurance: '' },
      trackingCode: '',
      showQRCode: true,
    };

    // Design history for back/forward navigation
    let designHistory = [];
    let historyIndex = -1;
    const maxHistorySize = 50;

    // Locked elements - these won't change on regenerate
    let locked = {
      layout: false,
      backLayout: false,
      theme: false,
      headline: false,
      services: false,
      discount: false,
      tagline: false,
      poolImage: false,
      font: false,
      testimonial: false,
      urgency: false,
      cta: false,
      trustBadge: false,
    };

    // Saved text content - preserves user edits
    let savedTextContent = {
      headlineMain: null,
      headlineSub: null,
      urgency: null,
      cta: null,
      discountAmount: null,
      discountText: null,
      testimonialText: null,
      testimonialAuthor: null,
      trustBadge: null,
      trustBadge2: null,
      services: null, // array
    };

    // ==================== FUNCTIONS ====================
    function random(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function shuffle(arr) {
      return [...arr].sort(() => Math.random() - 0.5);
    }

    // Deep clone the current design for history
    function cloneDesign(design) {
      return JSON.parse(JSON.stringify(design));
    }

    // Save current design to history
    function saveToHistory() {
      // If we're not at the end of history, truncate forward history
      if (historyIndex < designHistory.length - 1) {
        designHistory = designHistory.slice(0, historyIndex + 1);
      }
      // Add current design to history
      designHistory.push(cloneDesign(currentDesign));
      // Limit history size
      if (designHistory.length > maxHistorySize) {
        designHistory.shift();
      } else {
        historyIndex++;
      }
      updateHistoryButtons();
    }

    // Go back to previous design
    function goBack() {
      if (historyIndex > 0) {
        historyIndex--;
        currentDesign = cloneDesign(designHistory[historyIndex]);
        updateColorSwatches();
        updateBulletCount();
        updateLayoutSelect();
        updateLayoutDisplay();
        updateFontSelect();
        renderPostcard();
        updateHistoryButtons();
      }
    }

    // Go forward to next design
    function goForward() {
      if (historyIndex < designHistory.length - 1) {
        historyIndex++;
        currentDesign = cloneDesign(designHistory[historyIndex]);
        updateColorSwatches();
        updateBulletCount();
        updateLayoutSelect();
        updateLayoutDisplay();
        updateFontSelect();
        renderPostcard();
        updateHistoryButtons();
      }
    }

    // Update back/forward button states
    function updateHistoryButtons() {
      const backBtn = document.getElementById('historyBackBtn');
      const forwardBtn = document.getElementById('historyForwardBtn');
      if (backBtn) {
        backBtn.disabled = historyIndex <= 0;
        backBtn.style.opacity = historyIndex <= 0 ? '0.5' : '1';
      }
      if (forwardBtn) {
        forwardBtn.disabled = historyIndex >= designHistory.length - 1;
        forwardBtn.style.opacity = historyIndex >= designHistory.length - 1 ? '0.5' : '1';
      }
    }

    function generateNew() {
      // Save current design to history before generating new (but not on first call)
      if (designHistory.length > 0 && JSON.stringify(currentDesign) !== JSON.stringify(designHistory[historyIndex])) {
        saveToHistory();
      }
      // Only randomize unlocked elements
      if (!locked.layout) currentDesign.layout = random(layouts);
      if (!locked.backLayout) currentDesign.backLayout = random(backLayouts);
      if (!locked.theme) currentDesign.theme = random(colorThemes);
      if (!locked.headline) currentDesign.headline = random(headlines);
      if (!locked.services) currentDesign.services = shuffle(services).slice(0, 6);
      if (!locked.discount) currentDesign.discount = random(discounts);
      if (!locked.tagline) currentDesign.tagline = random(taglines);
      if (!locked.poolImage) currentDesign.poolImage = random(poolImages);
      if (!locked.font) {
        currentDesign.font = random(fonts);
        const fontPairs = {
          'Playfair Display': 'Inter', 'Lora': 'Manrope', 'Merriweather': 'Open Sans',
          'Libre Baskerville': 'Karla', 'Roboto Slab': 'DM Sans', 'Oswald': 'Nunito',
          'Montserrat': 'Work Sans', 'Space Grotesk': 'Plus Jakarta Sans', 'Sora': 'Figtree',
          'Geist': 'Satoshi', 'Satoshi': 'Geist', 'Poppins': 'Inter', 'Raleway': 'Source Sans Pro',
        };
        const pair = fontPairs[currentDesign.font];
        if (pair) currentDesign.bodyFont = pair;
        else currentDesign.bodyFont = '';
      }
      if (!locked.testimonial) currentDesign.testimonial = random(testimonials);
      if (!locked.urgency) currentDesign.urgency = random(urgencyTexts);
      if (!locked.cta) currentDesign.cta = random(ctaTexts);
      if (!locked.trustBadge) {
        const shuffledBadges = shuffle(trustBadges);
        currentDesign.trustBadge = shuffledBadges[0];
        currentDesign.trustBadge2 = shuffledBadges[1];
      }

      // Apply saved text content if locked
      if (locked.headline && savedTextContent.headlineMain) {
        currentDesign.headline = { main: savedTextContent.headlineMain, sub: savedTextContent.headlineSub || currentDesign.headline.sub };
      }
      if (locked.discount && (savedTextContent.discountAmount || savedTextContent.discountText)) {
        currentDesign.discount = {
          amount: savedTextContent.discountAmount || currentDesign.discount.amount,
          text: savedTextContent.discountText || currentDesign.discount.text
        };
      }
      if (locked.urgency && savedTextContent.urgency) {
        currentDesign.urgency = savedTextContent.urgency;
      }
      if (locked.cta && savedTextContent.cta) {
        currentDesign.cta = savedTextContent.cta;
      }
      if (locked.testimonial && savedTextContent.testimonialText) {
        currentDesign.testimonial = {
          text: savedTextContent.testimonialText,
          author: savedTextContent.testimonialAuthor || currentDesign.testimonial.author,
          location: currentDesign.testimonial.location
        };
      }
      if (locked.trustBadge && savedTextContent.trustBadge) {
        currentDesign.trustBadge = savedTextContent.trustBadge;
        currentDesign.trustBadge2 = savedTextContent.trustBadge2 || currentDesign.trustBadge2;
      }
      if (locked.services && savedTextContent.services && savedTextContent.services.length > 0) {
        // Keep exactly what user typed
        currentDesign.services = savedTextContent.services.filter(s => s && s.trim() !== '');
      } else if (!currentDesign.services || currentDesign.services.length === 0) {
        // No user services, generate random ones
        currentDesign.services = shuffle(services).slice(0, 6);
      }

      updateColorSwatches();
      updateBulletCount();
      updateLayoutSelect();
      updateLayoutDisplay();
      updateFontSelect();
      updatePoolImagePreview();
      syncAllSidebarInputs();
      renderPostcard();

      // Save the newly generated design to history
      saveToHistory();
    }

    function toggleLock(element) {
      // Don't toggle locks when in move mode
      if (editMode) return;
      locked[element] = !locked[element];
      updateLockIndicator();
      updateColorSwatches();
      renderPostcard();
    }

    function unlockAll() {
      Object.keys(locked).forEach(k => locked[k] = false);
      updateLockIndicator();
      updateColorSwatches();
      renderPostcard();
    }

    function updateLockIndicator() {
      const lockedItems = Object.entries(locked).filter(([_, v]) => v).map(([k]) => k);
      const indicator = document.getElementById('lockIndicator');
      const list = document.getElementById('lockedList');

      if (lockedItems.length > 0) {
        indicator.classList.add('show');
        list.innerHTML = lockedItems.map(item => `<li>${item.charAt(0).toUpperCase() + item.slice(1)}</li>`).join('');
      } else {
        indicator.classList.remove('show');
      }

      // Sync lock checkboxes in sidebar
      const lockCheckboxes = {
        lockLayout: 'layout',
        lockPoolImage: 'poolImage',
        lockTheme: 'theme',
        lockDiscount: 'discount'
      };
      Object.entries(lockCheckboxes).forEach(([checkboxId, lockKey]) => {
        const checkbox = document.getElementById(checkboxId);
        if (checkbox) checkbox.checked = locked[lockKey];
      });
    }

    function updatePostcard() {
      renderPostcard();
    }

    // Postcard size configuration - Official Vistaprint Mailing Services sizes only
    // All sizes use landscape orientation (width > height)
    // Dimensions are screen preview sizes, export at 300 DPI
    const postcardSizes = {
      '4x6': { width: 600, height: 400, label: '4" x 6"', dpi: 100,
        // Back mailing zone: bottom-right L-shape (USPS compliant)
        mailZone: { rightWidth: '50%', bottomHeight: '45%' } },
      '4-25x5-5': { width: 550, height: 425, label: '4.25" x 5.5"', dpi: 100,
        mailZone: { rightWidth: '48%', bottomHeight: '50%' } },
      '5x7': { width: 700, height: 500, label: '5" x 7"', dpi: 100,
        mailZone: { rightWidth: '48%', bottomHeight: '48%' } },
      '5-5x8-5': { width: 680, height: 440, label: '5.5" x 8.5"', dpi: 80,
        mailZone: { rightWidth: '45%', bottomHeight: '45%' } },
      '6x9': { width: 675, height: 450, label: '6" x 9"', dpi: 75,
        mailZone: { rightWidth: '44%', bottomHeight: '42%' } }
    };

    let currentSize = '6x9';
    let currentScale = 1;

    // Base size for scaling (6x9 is the default reference)
    const baseSize = { width: 675, height: 450 };

    function changePostcardSize(size) {
      currentSize = size;
      const sizeConfig = postcardSizes[size];

      // Calculate scale factor based on size compared to base
      const scaleX = sizeConfig.width / baseSize.width;
      const scaleY = sizeConfig.height / baseSize.height;
      const scale = Math.min(scaleX, scaleY); // Use the smaller scale to fit content

      // Update postcard dimensions
      const frontCard = document.getElementById('frontCard');
      const backCard = document.getElementById('backCard');

      // Remove all size classes
      const sizeClasses = Object.keys(postcardSizes).map(s => 'size-' + s);
      [frontCard, backCard].forEach(card => {
        sizeClasses.forEach(cls => card.classList.remove(cls));
        card.classList.add('size-' + size);
        card.style.width = sizeConfig.width + 'px';
        card.style.height = sizeConfig.height + 'px';
      });

      // Store scale for use during render
      currentScale = scale;

      // Update rulers
      updateRulers(sizeConfig);

      // Update size label
      const sizeLabel = document.querySelector('.size-label');
      if (sizeLabel) {
        sizeLabel.textContent = sizeConfig.label + ' (Direct Mail Standard)';
      }

      // Update size display in toolbar
      const sizeDisplay = document.getElementById('sizeDisplay');
      if (sizeDisplay) {
        sizeDisplay.textContent = sizeConfig.label.replace('" x ', 'Ã—').replace('"', '');
      }

      // Re-render to adjust layout
      renderPostcard();

      // Apply scale to content AFTER rendering
      applyContentScale(scale);

      // Update USPS zones if visible
      if (document.getElementById('showUSPSGuides')?.checked) {
        updateUSPSZones();
      }

      // Save preference
      localStorage.setItem('postcardSize', size);
    }

    function applyContentScale(scale) {
      // Set CSS variable for scale
      document.documentElement.style.setProperty('--content-scale', scale);

      const frontContent = document.querySelector('#frontCard .postcard-front');
      const backContent = document.querySelector('#backCard .postcard-back');

      [frontContent, backContent].forEach(content => {
        if (content) {
          // Use CSS transform for reliable scaling
          content.style.transform = `scale(${scale})`;
          content.style.transformOrigin = 'top left';
          // Adjust width/height to compensate for scale
          content.style.width = `${100 / scale}%`;
          content.style.height = `${100 / scale}%`;
        }
      });
    }

    function updateRulers(sizeConfig) {
      const rulerTop = document.querySelector('.ruler-top');
      const rulerLeft = document.querySelector('.ruler-left');

      if (rulerTop) {
        rulerTop.style.width = sizeConfig.width + 'px';
      }
      if (rulerLeft) {
        rulerLeft.style.height = sizeConfig.height + 'px';
      }
    }

    function renderPostcard() {
      const { layout, theme, headline, services, discount, tagline, poolImage, font, logoUrl, logoSize, logoWhiteBox, qrUrl, testimonial, urgency, cta, trustBadge, trustBadge2 } = currentDesign;
      // CTA color: red gradient (60%), orange solid (25%), theme accent (15%)
      const ctaRoll = Math.random();
      const ctaStyle = ctaRoll < 0.6
        ? 'background: linear-gradient(135deg, #ef4444, #dc2626); color: white;'
        : ctaRoll < 0.85
          ? 'background: #f97316; color: white;'
          : `background: ${safeAccent}; color: white;`;
      const serifFonts = ['Playfair Display', 'Lora', 'Merriweather', 'Libre Baskerville', 'Roboto Slab'];
      const fontFallback = serifFonts.includes(font) ? 'serif' : 'sans-serif';
      const companyName = document.getElementById('companyName').value;
      const rawPhone = document.getElementById('phoneNumber').value;
      const showCallOrText = document.getElementById('showCallOrText')?.checked ?? true;
      const phoneLabel = showCallOrText ? 'Call or Text: ' : '';
      const phone = rawPhone;
      const phoneDisplay = phoneLabel + rawPhone;
      const website = document.getElementById('website').value;
      const city = document.getElementById('cityName').value;

      // â”€â”€ Safe escaped values for template rendering â”€â”€
      const safeCompanyName = escapeHTML(companyName);
      const safePhone = escapeHTML(phone);
      const safePhoneDisplay = escapeHTML(phoneDisplay);
      const safeWebsite = escapeHTML(website);
      const safeCity = escapeHTML(city);
      const safeHeadline = escapeHTML(headline);
      const safeDiscount = escapeHTML(discount);
      const safeTagline = escapeHTML(tagline);
      const safeCta = escapeHTML(cta);
      const safeTestimonialText = escapeHTML(testimonial.text);
      const safeTestimonialAuthor = escapeHTML(testimonial.author);
      const safeTestimonialLocation = escapeHTML(testimonial.location);
      const safeUrgency = escapeHTML(urgency);
      const safeTrustBadge = escapeHTML(trustBadge);
      const safeTrustBadge2 = escapeHTML(trustBadge2 || '');
      const safeHeadlineMain = escapeHTML(headline.main);
      const safeHeadlineSub = escapeHTML(headline.sub);
      const safeDiscountAmount = escapeHTML(discount.amount);
      const safeDiscountText = escapeHTML(discount.text);
      const safePoolImage = sanitizeCSSUrl(poolImage);
      const safeLogoUrl = sanitizeCSSUrl(logoUrl);
      const safeQrUrl = sanitizeCSSUrl(qrUrl);
      const safePrimary = sanitizeColor(theme.primary);
      const safeSecondary = sanitizeColor(theme.secondary);
      const safeAccent = sanitizeColor(theme.accent);
      const showQRCode = (document.getElementById('showQRCode')?.checked ?? true) && (currentDesign.showQRCode !== false);

      // Helper function for QR code HTML - returns empty string if QR is disabled
      const qrHTML = (size = 45, extraStyle = '') => {
        if (!showQRCode || !qrUrl || qrUrl === '') return '';
        return `
          <div data-qr-container="true" style="width: ${size}px; height: ${size}px; border-radius: 6px; overflow: hidden; border: 2px solid ${safePrimary}20; background: white; flex-shrink: 0; ${extraStyle}">
            <img src="${safeQrUrl}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.parentElement.style.display='none'">
          </div>
        `;
      };

      // Lock classes for each element
      const lc = (el) => locked[el] ? 'lockable locked' : 'lockable';

      // Logo wrapper style for white box option
      const logoBoxStyle = logoWhiteBox ? 'background: white; padding: 8px 12px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: inline-flex; align-items: center; justify-content: center;' : 'display: inline-flex; align-items: center; justify-content: center;';

      // Helper function for logo HTML with optional white box - always centered within container
      const logoHTML = (extraStyle = '', imgStyle = '', sizeMultiplier = 1) => `
        <div style="${logoBoxStyle} ${extraStyle}">
          <img src="${safeLogoUrl}" style="height: ${logoSize * sizeMultiplier}px; width: auto; max-width: 100%; object-fit: contain; ${imgStyle}" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary};white-space:nowrap;\\'>${safeCompanyName}</div>'">
        </div>
      `;

      // Star rating HTML
      const starsHTML = `<span style="color: #fbbf24; font-size: 12px;">â˜…â˜…â˜…â˜…â˜…</span>`;

      let frontHTML = '';

      // Different layouts

      // ========== DIRECT MAIL LAYOUTS ==========
      if (layout === 'clearRipples') {
        // Clear Ripples Pro - 80% Visual, headline-dominant front with PRINT SAFE ZONES
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <!-- Full Bleed Pool Image -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('${safePoolImage}') center/cover;"></div>

            <!-- Dark Gradient Overlay -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.2) 30%, rgba(0,0,0,0.7) 100%);"></div>

            <!-- Content Layer - 25px padding for print safe zone -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; padding: 30px; display: flex; flex-direction: column; z-index: 1;">

              <!-- Top Row: Logo + Discount Badge -->
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <!-- Logo + Tagline -->
                <div data-movable="true" style="position: relative;">
                  <img src="${safeLogoUrl}" style="height: ${logoSize}px; width: auto; max-width: 200px; object-fit: contain; filter: brightness(0) invert(1);" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:800;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.3);\\'>${safeCompanyName}</div>'">
                  <p class="${lc('tagline')}" ondblclick="toggleLock('tagline')" style="font-size: 9px; color: rgba(255,255,255,0.9); margin: 4px 0 0 0; text-shadow: 0 1px 3px rgba(0,0,0,0.5);" contenteditable="true">${safeTagline}</p>
                </div>

                <!-- Discount Badge - Sized for print safety -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; width: 80px; height: 80px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 3px solid white; flex-shrink: 0;">
                  <span style="font-size: 16px; font-weight: 900; color: white; line-height: 1; text-align: center; width: 100%;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.95); text-transform: uppercase; text-align: center; width: 100%;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>

              <!-- BIG BOLD Headline - Dominant -->
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="flex: 1; display: flex; flex-direction: column; justify-content: center; text-align: center; padding: 10px 0;">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 38px; font-weight: 900; color: white; line-height: 1.1; text-shadow: 0 3px 15px rgba(0,0,0,0.6); margin: 0; text-align: center;" contenteditable="true">${safeHeadlineMain}</h1>
                <p style="font-size: 14px; color: rgba(255,255,255,0.95); text-shadow: 0 2px 6px rgba(0,0,0,0.5); font-weight: 600; margin: 10px 0 0 0; text-align: center;" contenteditable="true">${safeHeadlineSub}</p>
              </div>

              <!-- CTA Button -->
              <div class="${lc('cta')}" ondblclick="toggleLock('cta')" style="${ctaStyle} text-align: center; padding: 14px 20px; border-radius: 8px; font-weight: 800; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 12px;" contenteditable="true">${safeCta}</div>

              <!-- Contact & Trust Footer - Single Line -->
              <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                <div style="color: white; text-shadow: 0 1px 4px rgba(0,0,0,0.4); flex: 1; min-width: 0;">
                  <p style="font-size: 14px; font-weight: 900; margin: 0; letter-spacing: 0.5px;" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="font-size: 9px; opacity: 0.9; margin: 2px 0 0 0;" contenteditable="true">${safeWebsite}</p>
                </div>
                <!-- Trust Badge with Shield -->
                <div style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.15); backdrop-filter: blur(4px); padding: 6px 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); flex-shrink: 0;">
                  <span style="font-size: 14px;">ðŸ›¡ï¸</span>
                  <div style="color: white; text-align: left;">
                    <p style="font-size: 8px; font-weight: 800; margin: 0; white-space: nowrap;">Licensed & Insured</p>
                    <p style="font-size: 9px; opacity: 0.9; margin: 1px 0 0 0; white-space: nowrap;">Locally Owned</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'directMailPro') {
        // Direct Mail Pro â€” Asymmetric right-justified: badge LEFT, logo RIGHT
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.6) 100%);"></div>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; padding: 30px; display: flex; flex-direction: column; z-index: 1;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; width: 80px; height: 80px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 3px solid white; flex-shrink: 0;">
                  <span style="font-size: 16px; font-weight: 900; color: white; line-height: 1; text-align: center; width: 100%;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.95); text-transform: uppercase; text-align: center; width: 100%;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" style="text-align: right;">
                  <img src="${safeLogoUrl}" style="height: ${logoSize}px; width: auto; max-width: 200px; object-fit: contain; filter: brightness(0) invert(1);" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:800;color:white;\\'>${safeCompanyName}</div>'">
                  <p class="${lc('tagline')}" ondblclick="toggleLock('tagline')" style="font-size: 9px; color: rgba(255,255,255,0.9); margin: 4px 0 0 0; text-align: right;" contenteditable="true">${safeTagline}</p>
                </div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: flex-end; text-align: right; padding: 10px 0; min-height: 0; overflow: hidden;">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: clamp(20px, 5vw, 36px); font-weight: 900; color: white; line-height: 1.1; text-shadow: 0 3px 15px rgba(0,0,0,0.6); margin: 0;" contenteditable="true">${safeHeadlineMain}</h1>
                <p style="font-size: 14px; color: rgba(255,255,255,0.95); font-weight: 600; margin: 10px 0 0 0;" contenteditable="true">${safeHeadlineSub}</p>
              </div>
              <div class="${lc('cta')}" ondblclick="toggleLock('cta')" style="${ctaStyle} text-align: center; padding: 14px 20px; border-radius: 8px; font-weight: 800; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 12px;" contenteditable="true">${safeCta}</div>
              <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                <div style="color: white;">
                  <p style="font-size: 16px; font-weight: 900; margin: 0; letter-spacing: 0.5px;" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="font-size: 9px; opacity: 0.9; margin: 2px 0 0 0;" contenteditable="true">${safeWebsite}</p>
                </div>
                <div class="${lc('trustBadge')}" ondblclick="toggleLock('trustBadge')" style="background: rgba(255,255,255,0.15); backdrop-filter: blur(4px); padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 10px; font-weight: 700;" contenteditable="true">${safeTrustBadge}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'eddmStandard') {
        // EDDM Standard â€” Brutalist negative-space: white bg, centered offer, oversized phone
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: white;">
            <div style="height: 6px; background: ${safeAccent};"></div>
            <div style="padding: 30px; display: flex; flex-direction: column; height: calc(100% - 6px); box-sizing: border-box;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <img src="${safeLogoUrl}" style="height: ${Math.min(logoSize, 35)}px; width: auto; max-width: 140px; object-fit: contain;" onerror="this.outerHTML='<div style=\\'font-size:14px;font-weight:800;color:${safePrimary};\\'>${safeCompanyName}</div>'">
                <p class="${lc('tagline')}" ondblclick="toggleLock('tagline')" style="font-size: 9px; color: ${safeSecondary}; margin: 0; text-align: right; max-width: 50%;" contenteditable="true">${safeTagline}</p>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: 0; overflow: hidden;">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: clamp(24px, 6vw, 42px); font-weight: 900; color: ${safePrimary}; line-height: 1.05; margin: 0; letter-spacing: -1px;" contenteditable="true">${safeHeadlineMain}</h1>
                <div class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="margin: 12px 0; padding: 8px 24px; background: ${safePrimary}; color: white; font-size: clamp(12px, 3vw, 18px); font-weight: 900; display: inline-block; white-space: nowrap;" contenteditable="true">${safeDiscountAmount} ${safeDiscountText}</div>
              </div>
              <div style="text-align: center;">
                <div class="${lc('cta')}" ondblclick="toggleLock('cta')" style="${ctaStyle} display: inline-block; padding: 12px 32px; font-weight: 800; font-size: 14px; margin-bottom: 10px;" contenteditable="true">${safeCta}</div>
                <p style="font-size: 20px; font-weight: 900; color: ${safePrimary}; margin: 0; letter-spacing: 1px;" contenteditable="true">${safePhoneDisplay}</p>
                <p style="font-size: 9px; color: ${safeSecondary}; margin: 4px 0 0 0;" contenteditable="true">${safeWebsite}</p>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'addressedMail') {
        // Addressed Mail - 80% Visual, headline-dominant with brand colors and PRINT SAFE ZONES
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <!-- Full Bleed Pool Image -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('${safePoolImage}') center/cover;"></div>

            <!-- Brand Color Gradient Overlay -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(180deg, ${safePrimary}dd 0%, ${safePrimary}88 30%, ${safeSecondary}cc 100%);"></div>

            <!-- Content Layer - 25px padding for print safe zone -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; padding: 30px; display: flex; flex-direction: column; z-index: 1;">

              <!-- Top Row: Logo + Discount Badge -->
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <!-- Logo + Tagline -->
                <div data-movable="true" style="position: relative;">
                  <img src="${safeLogoUrl}" style="height: ${logoSize}px; width: auto; max-width: 200px; object-fit: contain; filter: brightness(0) invert(1);" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:800;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.3);\\'>${safeCompanyName}</div>'">
                  <p class="${lc('tagline')}" ondblclick="toggleLock('tagline')" style="font-size: 9px; color: rgba(255,255,255,0.9); margin: 4px 0 0 0; text-shadow: 0 1px 3px rgba(0,0,0,0.5);" contenteditable="true">${safeTagline}</p>
                </div>

                <!-- Discount Badge -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 8px 12px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); text-align: center; flex-shrink: 0; margin-right: 5px;">
                  <span style="font-size: 18px; font-weight: 900; color: ${safePrimary}; display: block; white-space: nowrap;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; font-weight: 700; color: ${safeSecondary}; white-space: nowrap;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>

              <!-- BIG BOLD Headline - Dominant -->
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 15px 0;">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 38px; font-weight: 900; color: white; line-height: 1.1; text-shadow: 0 3px 15px rgba(0,0,0,0.4); margin: 0;" contenteditable="true">${safeHeadlineMain}</h1>
                <p style="font-size: 14px; color: rgba(255,255,255,0.95); text-shadow: 0 2px 6px rgba(0,0,0,0.3); font-weight: 600; margin: 10px 0 0 0;" contenteditable="true">${safeHeadlineSub}</p>
              </div>

              <!-- CTA Button -->
              <div class="${lc('cta')}" ondblclick="toggleLock('cta')" style="background: white; color: ${safePrimary}; text-align: center; padding: 14px 20px; border-radius: 8px; font-weight: 800; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 12px;" contenteditable="true">${safeCta}</div>

              <!-- Contact & Trust Footer - Single Line -->
              <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                <div style="color: white; text-shadow: 0 1px 4px rgba(0,0,0,0.3);">
                  <p style="font-size: 12px; font-weight: 800; margin: 0;" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="font-size: 9px; opacity: 0.9; margin: 2px 0 0 0;" contenteditable="true">${safeWebsite}</p>
                </div>
                <!-- Trust Badge with Shield -->
                <div style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); padding: 8px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); flex-shrink: 0;">
                  <span style="font-size: 16px;">ðŸ›¡ï¸</span>
                  <div style="color: white; text-align: left;">
                    <p style="font-size: 9px; font-weight: 800; margin: 0; white-space: nowrap;">Licensed & Insured</p>
                    <p style="font-size: 10px; opacity: 0.9; margin: 1px 0 0 0; white-space: nowrap;">Locally Owned</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'split') {
        frontHTML = `
          <div style="width: 50%; padding: 20px; background: white; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden;">
            <div>
              <!-- Urgency Banner -->
              <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: linear-gradient(90deg, ${safePrimary}, ${safeSecondary}); color: white; font-size: 9px; font-weight: 800; padding: 4px 10px; border-radius: 3px; display: inline-block; margin-bottom: 10px; letter-spacing: 0.5px;" contenteditable="true">${safeUrgency}</div>

              <!-- Headline -->
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="margin-bottom: 12px;">
                <h1 style="font-family: '${font}', serif; font-size: 22px; color: ${safePrimary}; line-height: 1.1; margin-bottom: 2px;" contenteditable="true">${safeHeadlineMain}</h1>
                <h2 style="font-family: '${font}', serif; font-size: 14px; color: ${safeSecondary};" contenteditable="true">${safeHeadlineSub}</h2>
              </div>

              <!-- Services -->
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-bottom: 10px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px 6px;">
                  ${services.slice(0, 8).map(s => `
                    <div style="display: flex; align-items: flex-start; gap: 3px; font-size: 10px; color: #334155; font-family: Inter, sans-serif; line-height: 1.2;">
                      <span style="color: ${safePrimary}; font-weight: bold; flex-shrink: 0;">âœ“</span>
                      <span contenteditable="true" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s}</span>
                    </div>
                  `).join('')}
                </div>
              </div>

              <!-- Trust Badges -->
              <div class="${lc('trustBadge')}" ondblclick="toggleLock('trustBadge')" style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                <span style="background: ${safePrimary}15; color: ${safePrimary}; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 20px; display: flex; align-items: center; gap: 3px;">
                  <span>âœ“</span> <span contenteditable="true">${safeTrustBadge}</span>
                </span>
                <span style="background: ${safePrimary}15; color: ${safePrimary}; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 20px; display: flex; align-items: center; gap: 3px;">
                  <span>âœ“</span> <span contenteditable="true">${safeTrustBadge2}</span>
                </span>
              </div>
            </div>

            <!-- Bottom: CTA + Contact -->
            <div>
              <!-- CTA Button -->
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; text-align: center; padding: 10px 16px; border-radius: 6px; font-weight: 700; font-size: 12px; margin-bottom: 10px; cursor: pointer; box-shadow: 0 4px 12px ${safePrimary}40;" contenteditable="true">${safeCta}</div>

              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 42px; height: 42px; background: #f1f5f9; border-radius: 6px; overflow: hidden; flex-shrink: 0;">
                  <img src="${safeQrUrl}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='<div style=\\'padding:6px;font-size:7px;color:#94a3b8;text-align:center\\'>QR</div>'">
                </div>
                <div style="font-size: 10px; font-family: Inter, sans-serif;">
                  <p style="font-weight: 700; color: #1e293b;" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="color: ${safePrimary}; font-weight: 600;" contenteditable="true">${safeWebsite}</p>
                </div>
              </div>
              <!-- Trust Footer -->
              <p style="font-size: 9px; color: #94a3b8; text-align: center; margin-top: 6px;" contenteditable="true">Locally Owned, Licensed, and Insured</p>
            </div>
          </div>

          <!-- Right Side: Image + Overlays -->
          <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 50%; position: relative; background: url('${safePoolImage}') center/cover;">
            <!-- Gradient overlay for text readability -->
            <div style="position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%);"></div>

            <!-- Logo -->
            <div data-movable="true" style="position: absolute; top: 10px; right: 10px; background: white; padding: 6px 10px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; width: auto;" onerror="this.outerHTML='<div style=\\'font-size:12px;font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</div>'">
            </div>

            <!-- Discount Badge -->
            <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 10px; left: 10px; background: #ef4444; color: white; padding: 8px 12px; border-radius: 6px; text-align: center; box-shadow: 0 4px 15px rgba(239,68,68,0.4); transform: rotate(-3deg);">
              <div style="font-size: 16px; font-weight: 900; line-height: 1; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
              <div style="font-size: 10px; font-weight: 600; text-transform: uppercase; text-align: center;" contenteditable="true">${safeDiscountText}</div>
            </div>

            <!-- Testimonial at bottom -->
            <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: absolute; bottom: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
              <div style="margin-bottom: 4px;">${starsHTML}</div>
              <p style="font-size: 9px; color: #374151; font-style: italic; line-height: 1.3; margin-bottom: 4px;" contenteditable="true">"${safeTestimonialText}"</p>
              <p style="font-size: 10px; color: #6b7280; font-weight: 600;" contenteditable="true">â€” ${safeTestimonialAuthor}, ${safeTestimonialLocation}</p>
            </div>
          </div>
        `;
      } else if (layout === 'overlay') {
        frontHTML = `
          <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 100%; height: 100%; position: relative; background: url('${safePoolImage}') center/cover;">
            <div style="position: absolute; inset: 0; background: linear-gradient(135deg, ${safePrimary}ee 0%, ${safeSecondary}cc 50%, transparent 100%);"></div>
            <div style="position: absolute; inset: 0; padding: 20px; display: flex; flex-direction: column; justify-content: space-between;">

              <!-- Top Row -->
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <!-- Urgency Banner -->
                  <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: #ef4444; color: white; font-size: 9px; font-weight: 800; padding: 4px 12px; border-radius: 3px; display: inline-block; margin-bottom: 8px; letter-spacing: 0.5px;" contenteditable="true">${safeUrgency}</div>

                  <div data-movable="true" class="${lc('headline')}" onclick="event.stopPropagation(); toggleLock('headline')" style="position: relative;">
                    <h1 style="font-family: '${font}', serif; font-size: 28px; color: white; line-height: 1.1; text-shadow: 0 2px 10px rgba(0,0,0,0.3);" contenteditable="true">${safeHeadlineMain}</h1>
                    <h2 style="font-family: '${font}', serif; font-size: 18px; color: rgba(255,255,255,0.9);" contenteditable="true">${safeHeadlineSub}</h2>
                  </div>
                </div>
                <div data-movable="true" style="background: white; padding: 8px 12px; border-radius: 8px; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                  <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:12px;font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</div>'">
                </div>
              </div>

              <!-- Middle: Services + Testimonial -->
              <div style="display: flex; gap: 16px;">
                <div class="${lc('services')}" ondblclick="event.stopPropagation(); toggleLock('services')" style="flex: 1;">
                  <ul style="list-style: none;">
                    ${services.slice(0,3).map(s => `
                      <li style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: white; margin-bottom: 4px; font-family: Inter, sans-serif;">
                        <span style="color: #fcd34d;">âœ“</span>
                        <span contenteditable="true">${s}</span>
                      </li>
                    `).join('')}
                  </ul>
                </div>
                <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: relative; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 8px; max-width: 180px;">
                  <div style="margin-bottom: 3px;">${starsHTML}</div>
                  <p style="font-size: 9px; color: #374151; font-style: italic; line-height: 1.3;" contenteditable="true">"${safeTestimonialText}"</p>
                  <p style="font-size: 10px; color: #6b7280; font-weight: 600; margin-top: 4px;" contenteditable="true">â€” ${safeTestimonialAuthor}</p>
                </div>
              </div>

              <!-- Bottom Row -->
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div>
                  <!-- CTA Button -->
                  <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 10px 20px; border-radius: 6px; font-weight: 700; font-size: 12px; margin-bottom: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" contenteditable="true">${safeCta}</div>

                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 45px; height: 45px; background: white; border-radius: 6px; overflow: hidden;">
                      <img src="${safeQrUrl}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'">
                    </div>
                    <div style="font-size: 11px; color: white;">
                      <p style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                      <p style="font-weight: 600;" contenteditable="true">${safeWebsite}</p>
                    </div>
                  </div>
                </div>

                <!-- Discount Badge -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 12px 16px; border-radius: 8px; text-align: center; box-shadow: 0 8px 30px rgba(0,0,0,0.3);">
                  <div style="font-size: 20px; font-weight: 900; color: #ef4444; line-height: 1; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 9px; font-weight: 600; color: #64748b; text-transform: uppercase; text-align: center;" contenteditable="true">${safeDiscountText}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'diagonal') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -20%; left: -10%; width: 65%; height: 140%; background: ${safePrimary}; transform: skewX(-15deg);"></div>
            <div style="position: absolute; inset: 0; display: flex;">
              <div style="width: 50%; padding: 20px; position: relative; z-index: 1; display: flex; flex-direction: column; justify-content: space-between;">
                <div>
                  <!-- Logo + Urgency -->
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<div style=\\'font-size:14px;font-weight:700;color:white\\'>${safeCompanyName}</div>'">
                    <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: #ef4444; color: white; font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 3px;" contenteditable="true">${safeUrgency}</div>
                  </div>

                  <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                    <h1 style="font-family: '${font}', serif; font-size: 24px; color: white; line-height: 1.1;" contenteditable="true">${safeHeadlineMain}</h1>
                    <h2 style="font-family: '${font}', serif; font-size: 14px; color: rgba(255,255,255,0.85); margin-bottom: 12px;" contenteditable="true">${safeHeadlineSub}</h2>
                  </div>

                  <div class="${lc('services')}" ondblclick="toggleLock('services')">
                    <ul style="list-style: none;">
                      ${services.slice(0,4).map(s => `
                        <li style="font-size: 10px; color: rgba(255,255,255,0.9); margin-bottom: 4px; font-family: Inter, sans-serif;">
                          <span style="color: #fcd34d;">âœ“</span> <span contenteditable="true">${s}</span>
                        </li>
                      `).join('')}
                    </ul>
                  </div>

                  <!-- Trust Badge -->
                  <div class="${lc('trustBadge')}" ondblclick="toggleLock('trustBadge')" style="margin-top: 8px;">
                    <span style="background: rgba(255,255,255,0.2); color: white; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 20px;" contenteditable="true">âœ“ ${safeTrustBadge}</span>
                  </div>
                </div>

                <!-- Bottom: CTA + Contact -->
                <div>
                  <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 8px 16px; border-radius: 5px; font-weight: 700; font-size: 11px; margin-bottom: 8px; text-align: center;" contenteditable="true">${safeCta}</div>
                  <div style="font-size: 10px; color: white;">
                    <span style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</span> â€¢ <span style="font-weight: 600;" contenteditable="true">${safeWebsite}</span>
                  </div>
                </div>
              </div>

              <!-- Right: Image Side -->
              <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 50%; background: url('${safePoolImage}') center/cover; position: relative;">
                <!-- Gradient overlay -->
                <div style="position: absolute; inset: 0; background: linear-gradient(to left, transparent 50%, rgba(0,0,0,0.3) 100%);"></div>

                <!-- Discount Badge -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 12px; right: 12px; background: #ef4444; color: white; padding: 10px 14px; border-radius: 8px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transform: rotate(3deg);">
                  <div style="font-size: 18px; font-weight: 900; line-height: 1; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 10px; font-weight: 600; text-transform: uppercase; text-align: center;" contenteditable="true">${safeDiscountText}</div>
                </div>

                <!-- Testimonial -->
                <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: absolute; bottom: 12px; left: 12px; right: 12px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 8px;">
                  <div style="margin-bottom: 3px;">${starsHTML}</div>
                  <p style="font-size: 9px; color: #374151; font-style: italic; line-height: 1.3;" contenteditable="true">"${safeTestimonialText}"</p>
                  <p style="font-size: 10px; color: #6b7280; font-weight: 600; margin-top: 3px;" contenteditable="true">â€” ${safeTestimonialAuthor}</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'framed') {
        frontHTML = `
          <div style="width: 100%; height: 100%; background: white; padding: 12px;">
            <div style="width: 100%; height: 100%; border: 3px solid ${safePrimary}; border-radius: 8px; display: flex; overflow: hidden; position: relative;">

              <!-- Left Content -->
              <div style="width: 50%; padding: 16px; display: flex; flex-direction: column; justify-content: space-between;">
                <div>
                  <!-- Logo + Company + Urgency -->
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.style.display='none'">
                      <div style="font-size: 14px; font-weight: 700; color: ${safePrimary};" contenteditable="true">${safeCompanyName}</div>
                    </div>
                    <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: #ef4444; color: white; font-size: 9px; font-weight: 800; padding: 3px 8px; border-radius: 3px;" contenteditable="true">${safeUrgency}</div>
                  </div>

                  <!-- Headline -->
                  <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                    <h1 style="font-family: '${font}', serif; font-size: 20px; color: ${safePrimary}; line-height: 1.1;" contenteditable="true">${safeHeadlineMain}</h1>
                    <h2 style="font-family: '${font}', serif; font-size: 13px; color: ${safeSecondary}; margin-bottom: 10px;" contenteditable="true">${safeHeadlineSub}</h2>
                  </div>

                  <!-- Services in 2 columns -->
                  <div class="${lc('services')}" ondblclick="toggleLock('services')">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px 6px;">
                      ${services.slice(0, 8).map(s => `
                        <div style="display: flex; align-items: flex-start; gap: 3px; font-size: 10px; color: #334155; line-height: 1.2;">
                          <span style="color: ${safePrimary}; font-weight: bold; flex-shrink: 0;">âœ“</span>
                          <span contenteditable="true" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s}</span>
                        </div>
                      `).join('')}
                    </div>
                  </div>

                  <!-- Trust Badges -->
                  <div class="${lc('trustBadge')}" ondblclick="toggleLock('trustBadge')" style="display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px;">
                    <span style="background: ${safePrimary}15; color: ${safePrimary}; font-size: 9px; font-weight: 600; padding: 2px 6px; border-radius: 10px;" contenteditable="true">âœ“ ${safeTrustBadge}</span>
                    <span style="background: ${safePrimary}15; color: ${safePrimary}; font-size: 9px; font-weight: 600; padding: 2px 6px; border-radius: 10px;" contenteditable="true">âœ“ ${safeTrustBadge2}</span>
                  </div>
                </div>

                <!-- Bottom: CTA + QR + Contact -->
                <div>
                  <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 8px 12px; border-radius: 5px; font-weight: 700; font-size: 10px; margin-bottom: 8px; text-align: center;" contenteditable="true">${safeCta}</div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 38px; height: 38px; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden; flex-shrink: 0;">
                      <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
                    </div>
                    <div style="font-size: 9px;">
                      <p style="font-weight: 700; color: #1e293b;" contenteditable="true">${safePhoneDisplay}</p>
                      <p style="color: ${safePrimary}; font-weight: 600;" contenteditable="true">${safeWebsite}</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Right: Image Side -->
              <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 50%; position: relative; background: url('${safePoolImage}') center/cover;">
                <!-- Gradient overlay -->
                <div style="position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 40%);"></div>

                <!-- Discount Badge -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; padding: 8px 12px; border-radius: 6px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                  <div style="font-size: 16px; font-weight: 900; line-height: 1; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 10px; font-weight: 600; text-transform: uppercase; text-align: center;" contenteditable="true">${safeDiscountText}</div>
                </div>

                <!-- Testimonial at bottom -->
                <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: absolute; bottom: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 8px; border-radius: 6px;">
                  <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 3px;">
                    ${starsHTML}
                    <span style="font-size: 10px; color: #6b7280; font-weight: 600;" contenteditable="true">${safeTestimonialAuthor}</span>
                  </div>
                  <p style="font-size: 10px; color: #374151; font-style: italic; line-height: 1.3;" contenteditable="true">"${safeTestimonialText}"</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'minimal') {
        frontHTML = `
          <div style="width: 100%; height: 100%; background: linear-gradient(180deg, white 60%, ${safePrimary}10 100%); padding: 20px; display: flex; flex-direction: column; justify-content: space-between; position: relative;">

            <!-- Top Row: Logo + Urgency + Image -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                  <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</div>'">
                  <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: #ef4444; color: white; font-size: 10px; font-weight: 800; padding: 3px 10px; border-radius: 3px;" contenteditable="true">${safeUrgency}</div>
                </div>
                <p class="${lc('tagline')}" ondblclick="toggleLock('tagline')" style="font-size: 10px; color: #64748b;" contenteditable="true">${safeTagline}</p>
              </div>
              <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 140px; height: 90px; border-radius: 10px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.15); position: relative;">
                <img src="${safePoolImage}" style="width: 100%; height: 100%; object-fit: cover;">
                <!-- Discount overlay on image -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 6px; right: 6px; background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; text-align: center;">
                  <div style="font-size: 12px; font-weight: 900; line-height: 1; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 6px; font-weight: 600; text-align: center;" contenteditable="true">${safeDiscountText}</div>
                </div>
              </div>
            </div>

            <!-- Middle: Headline + Services -->
            <div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', serif; font-size: 26px; color: ${safePrimary}; line-height: 1;" contenteditable="true">${safeHeadlineMain}</h1>
                <h2 style="font-family: '${font}', serif; font-size: 16px; color: ${safeSecondary}; margin-bottom: 10px;" contenteditable="true">${safeHeadlineSub}</h2>
              </div>

              <!-- Services in row -->
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; gap: 8px 16px; flex-wrap: wrap; margin-bottom: 8px;">
                ${services.slice(0, 4).map(s => `<span style="font-size: 9px; color: #475569; display: flex; align-items: center; gap: 3px;"><span style="color: ${safePrimary}; font-weight: bold;">âœ“</span> <span contenteditable="true">${s}</span></span>`).join('')}
              </div>

              <!-- Trust Badges -->
              <div class="${lc('trustBadge')}" ondblclick="toggleLock('trustBadge')" style="display: flex; gap: 6px;">
                <span style="background: ${safePrimary}15; color: ${safePrimary}; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 20px;" contenteditable="true">âœ“ ${safeTrustBadge}</span>
                <span style="background: ${safePrimary}15; color: ${safePrimary}; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 20px;" contenteditable="true">âœ“ ${safeTrustBadge2}</span>
              </div>
            </div>

            <!-- Bottom: CTA + Contact + Testimonial -->
            <div style="display: flex; justify-content: space-between; align-items: flex-end; gap: 12px;">
              <div style="flex: 1;">
                <!-- CTA -->
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 8px 14px; border-radius: 6px; font-weight: 700; font-size: 11px; margin-bottom: 8px; text-align: center;" contenteditable="true">${safeCta}</div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 42px; height: 42px; background: white; border: 2px solid ${safePrimary}20; border-radius: 6px; overflow: hidden; flex-shrink: 0;">
                    <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.parentElement.innerHTML='<div style=\\'font-size:7px;color:#94a3b8;padding:6px;text-align:center\\'>QR</div>'">
                  </div>
                  <div style="font-size: 10px;">
                    <p style="font-weight: 700; color: #1e293b;" contenteditable="true">${safePhoneDisplay}</p>
                    <p style="color: ${safePrimary}; font-weight: 600;" contenteditable="true">${safeWebsite}</p>
                  </div>
                </div>
              </div>

              <!-- Mini Testimonial -->
              <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: relative; background: #f8fafc; padding: 10px; border-radius: 8px; max-width: 180px; border: 1px solid #e2e8f0;">
                <div style="margin-bottom: 3px;">${starsHTML}</div>
                <p style="font-size: 10px; color: #374151; font-style: italic; line-height: 1.3;" contenteditable="true">"${safeTestimonialText}"</p>
                <p style="font-size: 9px; color: #6b7280; font-weight: 600; margin-top: 3px;" contenteditable="true">â€” ${safeTestimonialAuthor}</p>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'magazine') {
        // MAGAZINE STYLE - Bold typography, editorial look
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <!-- Full bleed image -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <!-- Dark overlay -->
            <div style="position: absolute; inset: 0; background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.8) 100%);"></div>

            <!-- Content -->
            <div style="position: absolute; inset: 0; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <!-- Top bar -->
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div data-movable="true" style="position: relative; background: white; padding: 6px 12px; border-radius: 4px;">
                  <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<span style=\\'font-weight:800;color:${safePrimary}\\'>${safeCompanyName}</span>'">
                </div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: ${safePrimary}; color: white; padding: 8px 16px; border-radius: 0;">
                  <span style="font-size: 20px; font-weight: 900; letter-spacing: -1px; text-align: center; display: block;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 10px; display: block; text-transform: uppercase; letter-spacing: 2px; text-align: center;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>

              <!-- Giant headline -->
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', serif; font-size: 38px; color: white; line-height: 0.9; font-weight: 900; text-transform: uppercase; letter-spacing: -1px;" contenteditable="true">${safeHeadlineMain}</h1>
                <div style="width: 60px; height: 4px; background: ${safePrimary}; margin: 12px 0;"></div>
                <h2 style="font-family: Inter, sans-serif; font-size: 14px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 4px;" contenteditable="true">${safeHeadlineSub}</h2>
              </div>

              <!-- Bottom info -->
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div>
                  <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; gap: 16px; margin-bottom: 12px;">
                    ${services.slice(0,3).map(s => `<span style="font-size: 9px; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px;" contenteditable="true">${s}</span>`).join('')}
                  </div>
                  <div style="color: white;">
                    <span style="font-size: 14px; font-weight: 800;" contenteditable="true">${safePhoneDisplay}</span>
                    <span style="font-size: 10px; margin-left: 10px; opacity: 0.7;" contenteditable="true">${safeWebsite}</span>
                  </div>
                </div>
                <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: relative; max-width: 200px; text-align: right;">
                  <div style="color: #fbbf24; font-size: 14px; margin-bottom: 4px;">â˜…â˜…â˜…â˜…â˜…</div>
                  <p style="font-size: 9px; color: rgba(255,255,255,0.8); font-style: italic;" contenteditable="true">"${safeTestimonialText}"</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'polaroid') {
        // POLAROID STYLE - Photo frame look
        frontHTML = `
          <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #f5f5f4 0%, #e7e5e4 100%); padding: 20px; display: flex; gap: 20px;">
            <!-- Polaroid frame -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 50%; background: white; padding: 12px 12px 50px 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.1); transform: rotate(-2deg);">
              <div style="width: 100%; height: 100%; background: url('${safePoolImage}') center/cover; position: relative;">
                <!-- Discount sticker -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 5px; right: 5px; width: 85px; height: 85px; background: #ef4444; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transform: rotate(15deg); box-shadow: 0 4px 15px rgba(239,68,68,0.4);">
                  <span style="font-size: 14px; font-weight: 900; text-align: center; display: block;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; text-align: center; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <!-- Handwritten style caption -->
              <p style="position: absolute; bottom: 15px; left: 20px; font-family: 'Playfair Display', serif; font-style: italic; font-size: 14px; color: #374151;" contenteditable="true">${safeHeadlineMain} âœ¨</p>
            </div>

            <!-- Content side -->
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between; padding: 8px 0;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; margin-bottom: 12px;" onerror="this.outerHTML='<div style=\\'font-size:18px;font-weight:800;color:${safePrimary};margin-bottom:12px\\'>${safeCompanyName}</div>'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h2 style="font-family: '${font}', serif; font-size: 16px; color: ${safePrimary}; line-height: 1.2;" contenteditable="true">${safeHeadlineSub}</h2>
                </div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-top: 12px;">
                  ${services.slice(0,3).map(s => `<p style="font-size: 10px; color: #57534e; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;"><span style="color: ${safePrimary};">âœ“</span> <span contenteditable="true">${s}</span></p>`).join('')}
                </div>
              </div>

              <!-- Testimonial note -->
              <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: relative; background: #fef3c7; padding: 10px; border-radius: 2px; transform: rotate(1deg); box-shadow: 2px 2px 8px rgba(0,0,0,0.1);">
                <div style="color: #fbbf24; font-size: 10px; margin-bottom: 2px;">â˜…â˜…â˜…â˜…â˜…</div>
                <p style="font-size: 9px; color: #78716c; font-style: italic;" contenteditable="true">"${safeTestimonialText}"</p>
                <p style="font-size: 10px; color: #a8a29e; margin-top: 4px;" contenteditable="true">â€” ${safeTestimonialAuthor}</p>
              </div>

              <!-- Contact -->
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 40px; height: 40px; background: white; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                  <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
                </div>
                <div style="font-size: 11px;">
                  <p style="font-weight: 700; color: #292524;" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="color: ${safePrimary};" contenteditable="true">${safeWebsite}</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'geometric') {
        // GEOMETRIC STYLE - Abstract shapes
        frontHTML = `
          <div style="width: 100%; height: 100%; background: white; position: relative; overflow: hidden;">
            <!-- Geometric shapes -->
            <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: ${safePrimary}; border-radius: 50%; opacity: 0.1;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: ${safeSecondary}; transform: rotate(45deg); opacity: 0.1;"></div>
            <div style="position: absolute; top: 50%; left: 50%; width: 300px; height: 300px; border: 3px solid ${safePrimary}20; border-radius: 50%; transform: translate(-50%, -50%);"></div>

            <!-- Main content -->
            <div style="position: absolute; inset: 0; padding: 24px; display: flex;">
              <!-- Left: Text content -->
              <div style="width: 50%; display: flex; flex-direction: column; justify-content: space-between; z-index: 1;">
                <div>
                  <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; display: inline-block; background: ${safePrimary}; color: white; padding: 4px 12px; font-size: 10px; font-weight: 700; letter-spacing: 2px; margin-bottom: 16px;" contenteditable="true">${safeUrgency}</div>

                  <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                    <h1 style="font-family: '${font}', serif; font-size: 28px; color: #1e293b; line-height: 1;" contenteditable="true">${safeHeadlineMain}</h1>
                    <h2 style="font-family: '${font}', serif; font-size: 18px; color: ${safePrimary}; margin-top: 4px;" contenteditable="true">${safeHeadlineSub}</h2>
                  </div>

                  <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 4px 6px;">
                    ${services.slice(0, 8).map(s => `<span style="font-size: 10px; color: #64748b; display: flex; align-items: flex-start; gap: 4px; line-height: 1.2;"><span style="width: 6px; height: 6px; background: ${safePrimary}; border-radius: 50%; flex-shrink: 0; margin-top: 2px;"></span><span contenteditable="true" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s}</span></span>`).join('')}
                  </div>
                </div>

                <div style="display: flex; align-items: center; gap: 16px;">
                  <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 12px 20px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
                  <div style="font-size: 10px; color: #64748b;">
                    <p style="font-weight: 700; color: #1e293b;" contenteditable="true">${safePhoneDisplay}</p>
                    <p contenteditable="true">${safeWebsite}</p>
                  </div>
                </div>
              </div>

              <!-- Right: Image circle -->
              <div style="width: 50%; display: flex; align-items: center; justify-content: center; position: relative;">
                <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 180px; height: 180px; border-radius: 50%; background: url('${safePoolImage}') center/cover; box-shadow: 0 20px 50px ${safePrimary}30; border: 4px solid white;">
                </div>
                <!-- Floating discount -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 20px; right: 10px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); text-align: center;">
                  <div style="font-size: 22px; font-weight: 900; color: ${safePrimary}; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 10px; color: #64748b; text-transform: uppercase; text-align: center;" contenteditable="true">${safeDiscountText}</div>
                </div>
                <!-- Floating testimonial -->
                <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: absolute; bottom: 10px; left: 0; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); max-width: 140px;">
                  <div style="color: #fbbf24; font-size: 10px;">â˜…â˜…â˜…â˜…â˜…</div>
                  <p style="font-size: 10px; color: #64748b; margin-top: 4px;" contenteditable="true">"${testimonial.text.substring(0, 50)}..."</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'bold') {
        // BOLD STYLE - Color blocking
        frontHTML = `
          <div style="width: 100%; height: 100%; display: flex; overflow: hidden;">
            <!-- Left color block -->
            <div style="width: 50%; background: ${safePrimary}; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; position: relative;">
              <!-- Decorative circles -->
              <div style="position: absolute; top: -40px; left: -40px; width: 120px; height: 120px; border: 3px solid rgba(255,255,255,0.2); border-radius: 50%;"></div>
              <div style="position: absolute; bottom: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>

              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1); margin-bottom: 20px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:800;color:white;margin-bottom:20px\\'>${safeCompanyName}</div>'">

                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', serif; font-size: 32px; color: white; line-height: 0.95; font-weight: 800;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
              </div>

              <div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 12px 16px; font-weight: 800; font-size: 11px; display: inline-block; margin-bottom: 16px;" contenteditable="true">${safeCta}</div>
                <div style="color: white; font-size: 12px;">
                  <p style="font-weight: 700; font-size: 13px;" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="opacity: 0.8;" contenteditable="true">${safeWebsite}</p>
                </div>
              </div>
            </div>

            <!-- Right image section -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 50%; background: url('${safePoolImage}') center/cover; position: relative;">
              <!-- Overlay elements -->
              <div style="position: absolute; inset: 0; background: linear-gradient(to left, transparent 60%, ${safePrimary} 100%);"></div>

              <!-- Discount badge -->
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 20px; right: 20px; background: #fbbf24; color: #1e293b; padding: 16px; text-align: center; transform: rotate(5deg);">
                <div style="font-size: 24px; font-weight: 900; line-height: 1; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
                <div style="font-size: 9px; font-weight: 700; text-transform: uppercase; text-align: center;" contenteditable="true">${safeDiscountText}</div>
              </div>

              <!-- Services strip -->
              <div class="${lc('services')}" ondblclick="event.stopPropagation(); toggleLock('services')" style="position: absolute; bottom: 0; right: 0; left: 0; background: white; padding: 16px;">
                ${services.slice(0,3).map(s => `<p style="font-size: 10px; color: #374151; margin-bottom: 4px;"><span style="color: ${safePrimary}; font-weight: bold;">âœ“</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>

              <!-- Floating review -->
              <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: absolute; top: 50%; left: 20px; transform: translateY(-50%); background: white; padding: 12px; max-width: 140px; box-shadow: 0 8px 30px rgba(0,0,0,0.2);">
                <div style="color: #fbbf24; font-size: 12px; margin-bottom: 4px;">â˜…â˜…â˜…â˜…â˜…</div>
                <p style="font-size: 9px; color: #374151; font-style: italic;" contenteditable="true">"${testimonial.text.substring(0, 60)}..."</p>
                <p style="font-size: 10px; color: #64748b; margin-top: 4px;" contenteditable="true">â€” ${safeTestimonialAuthor}</p>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'wave') {
        // WAVE STYLE - Curved divider
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: white;">
            <!-- Background image with wave mask -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; top: 0; right: 0; width: 50%; height: 100%; background: url('${safePoolImage}') center/cover;">
              <div style="position: absolute; inset: 0; background: linear-gradient(to right, white 0%, transparent 30%);"></div>
            </div>

            <!-- Wave SVG divider -->
            <svg style="position: absolute; left: 45%; top: 0; height: 100%; width: 100px;" viewBox="0 0 100 400" preserveAspectRatio="none">
              <path d="M0,0 Q50,100 0,200 Q50,300 0,400 L100,400 L100,0 Z" fill="white"/>
            </svg>

            <!-- Content -->
            <div style="position: absolute; left: 0; top: 0; width: 50%; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                  <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<span style=\\'font-size:16px;font-weight:800;color:${safePrimary}\\'>${safeCompanyName}</span>'">
                  <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: #ef4444; color: white; padding: 3px 8px; font-size: 10px; font-weight: 700; border-radius: 2px;" contenteditable="true">${safeUrgency}</div>
                </div>

                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', serif; font-size: 26px; color: ${safePrimary}; line-height: 1.1;" contenteditable="true">${safeHeadlineMain}</h1>
                  <h2 style="font-family: '${font}', serif; font-size: 15px; color: ${safeSecondary}; margin-top: 4px;" contenteditable="true">${safeHeadlineSub}</h2>
                </div>

                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-top: 16px;">
                  ${services.slice(0,4).map(s => `<p style="font-size: 10px; color: #475569; margin-bottom: 5px; display: flex; align-items: center; gap: 6px;"><span style="width: 16px; height: 16px; background: ${safePrimary}15; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: ${safePrimary}; font-size: 10px;">âœ“</span> <span contenteditable="true">${s}</span></p>`).join('')}
                </div>
              </div>

              <div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 10px 18px; border-radius: 25px; font-weight: 700; font-size: 11px; display: inline-block; margin-bottom: 12px;" contenteditable="true">${safeCta}</div>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div style="width: 40px; height: 40px; border: 2px solid ${safePrimary}20; border-radius: 6px; overflow: hidden;">
                    <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
                  </div>
                  <div style="font-size: 11px;">
                    <p style="font-weight: 700; color: #1e293b;" contenteditable="true">${safePhoneDisplay}</p>
                    <p style="color: ${safePrimary};" contenteditable="true">${safeWebsite}</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Floating elements on image side -->
            <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 20px; right: 20px; background: white; padding: 14px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center;">
              <div style="font-size: 24px; font-weight: 900; color: ${safePrimary}; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
              <div style="font-size: 9px; color: #64748b; text-align: center;" contenteditable="true">${safeDiscountText}</div>
            </div>

            <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: absolute; bottom: 20px; right: 20px; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-width: 200px;">
              <div style="color: #fbbf24; font-size: 11px; margin-bottom: 4px;">â˜…â˜…â˜…â˜…â˜…</div>
              <p style="font-size: 9px; color: #374151; font-style: italic;" contenteditable="true">"${safeTestimonialText}"</p>
              <p style="font-size: 10px; color: #64748b; margin-top: 4px;" contenteditable="true">â€” ${safeTestimonialAuthor}</p>
            </div>
          </div>
        `;
      } else if (layout === 'premium') {
        // PREMIUM - Clean white space, elegant typography, high-end feel
        frontHTML = `
          <div style="width: 100%; height: 100%; background: #ffffff; display: flex; overflow: hidden;">
            <!-- Left: Premium image with subtle overlay -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 55%; position: relative; background: url('${safePoolImage}') center/cover;">
              <div style="position: absolute; inset: 0; background: linear-gradient(135deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 100%);"></div>
              <!-- Elegant badge -->
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 24px; left: 24px; background: ${safePrimary}; color: white; padding: 12px 18px;">
                <div style="font-size: 11px; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 4px; text-align: center; opacity: 0.9;">Special Offer</div>
                <div style="font-size: 28px; font-weight: 300; letter-spacing: -1px; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
                <div style="font-size: 9px; text-transform: uppercase; letter-spacing: 2px; text-align: center;" contenteditable="true">${safeDiscountText}</div>
              </div>
            </div>

            <!-- Right: Content with generous white space -->
            <div style="width: 45%; padding: 28px 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <!-- Minimal logo -->
                <img src="${safeLogoUrl}" style="height: ${logoSize + 8}px; margin-bottom: 20px;" onerror="this.outerHTML='<div style=\\'font-size:20px;font-weight:600;color:${safePrimary};margin-bottom:20px;letter-spacing:-0.5px\\'>${safeCompanyName}</div>'">

                <!-- Elegant headline -->
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="margin-bottom: 20px;">
                  <h1 style="font-family: 'Playfair Display', serif; font-size: 28px; color: #1a1a1a; line-height: 1.1; font-weight: 400; letter-spacing: -0.5px;" contenteditable="true">${safeHeadlineMain}</h1>
                  <div style="width: 40px; height: 2px; background: ${safePrimary}; margin: 12px 0;"></div>
                  <h2 style="font-family: 'Inter', sans-serif; font-size: 12px; color: #666; font-weight: 400; letter-spacing: 1px; text-transform: uppercase;" contenteditable="true">${safeHeadlineSub}</h2>
                </div>

                <!-- Clean services list -->
                <div class="${lc('services')}" ondblclick="toggleLock('services')">
                  ${services.slice(0, 3).map(s => `
                    <p style="font-size: 11px; color: #444; margin-bottom: 8px; padding-left: 16px; position: relative; font-family: 'Inter', sans-serif;">
                      <span style="position: absolute; left: 0; color: ${safePrimary};">â€”</span>
                      <span contenteditable="true">${s}</span>
                    </p>
                  `).join('')}
                </div>
              </div>

              <!-- Bottom CTA area -->
              <div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; border: 2px solid ${safePrimary}; color: ${safePrimary}; padding: 12px 20px; font-weight: 600; font-size: 11px; text-align: center; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 16px;" contenteditable="true">${safeCta}</div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="font-size: 11px; color: #1a1a1a;">
                    <p style="font-weight: 600; margin-bottom: 2px;" contenteditable="true">${safePhoneDisplay}</p>
                    <p style="color: #888;" contenteditable="true">${safeWebsite}</p>
                  </div>
                  <div style="width: 48px; height: 48px; border: 1px solid #e5e5e5; padding: 4px;">
                    <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'hero') {
        // HERO FOCAL - Large dominant image with bold overlay CTA
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <!-- Full bleed hero image -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <!-- Gradient overlay -->
            <div style="position: absolute; inset: 0; background: linear-gradient(180deg, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.6) 60%, rgba(0,0,0,0.85) 100%);"></div>

            <!-- Content overlay -->
            <div style="position: absolute; inset: 0; padding: 20px; display: flex; flex-direction: column; justify-content: space-between;">
              <!-- Top bar -->
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div data-movable="true" style="position: relative; background: white; padding: 8px 14px; border-radius: 4px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                  <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<span style=\\'font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</span>'">
                </div>
                <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: #ef4444; color: white; padding: 6px 14px; border-radius: 4px; font-size: 10px; font-weight: 700; box-shadow: 0 4px 20px rgba(239,68,68,0.4);" contenteditable="true">${safeUrgency}</div>
              </div>

              <!-- Hero content - bottom heavy for impact -->
              <div>
                <!-- Giant discount -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; margin-bottom: 16px;">
                  <div style="font-size: 42px; font-weight: 900; color: white; line-height: 0.9; text-shadow: 0 4px 30px rgba(0,0,0,0.5); text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 14px; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 4px; text-align: center;" contenteditable="true">${safeDiscountText}</div>
                </div>

                <!-- Headline -->
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="margin-bottom: 20px;">
                  <h1 style="font-family: '${font}', serif; font-size: 32px; color: white; line-height: 1; font-weight: 700; text-shadow: 0 2px 20px rgba(0,0,0,0.3);" contenteditable="true">${safeHeadlineMain}</h1>
                </div>

                <!-- CTA and Contact row -->
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                  <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 14px 28px; border-radius: 8px; font-weight: 700; font-size: 13px; box-shadow: 0 8px 30px ${safePrimary}60;" contenteditable="true">${safeCta}</div>
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 50px; height: 50px; background: white; border-radius: 8px; padding: 4px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                      <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.parentElement.innerHTML='<div style=\\'font-size:8px;text-align:center;padding-top:14px;color:#999\\'>SCAN</div>'">
                    </div>
                    <div style="color: white;">
                      <p style="font-size: 13px; font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                      <p style="font-size: 10px; opacity: 0.8;" contenteditable="true">${safeWebsite}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'directResponse') {
        // DIRECT RESPONSE - Optimized for action, clear hierarchy, proven format
        frontHTML = `
          <div style="width: 100%; height: 100%; background: white; position: relative; overflow: hidden;">
            <!-- Top urgency banner -->
            <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: absolute; top: 0; left: 0; right: 0; background: #ef4444; color: white; text-align: center; padding: 6px; font-size: 11px; font-weight: 700; letter-spacing: 1px; z-index: 10;" contenteditable="true">${safeUrgency}</div>

            <!-- Main content area -->
            <div style="display: flex; height: 100%; padding-top: 32px;">
              <!-- Left content column -->
              <div style="width: 55%; padding: 20px; display: flex; flex-direction: column; justify-content: space-between;">
                <div>
                  <!-- Logo -->
                  <img src="${safeLogoUrl}" style="height: ${logoSize}px; margin-bottom: 12px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:800;color:${safePrimary};margin-bottom:12px\\'>${safeCompanyName}</div>'">

                  <!-- Attention-grabbing headline -->
                  <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                    <h1 style="font-family: '${font}', serif; font-size: 26px; color: #1e293b; line-height: 1.05; font-weight: 800; margin-bottom: 4px;" contenteditable="true">${safeHeadlineMain}</h1>
                    <h2 style="font-size: 14px; color: ${safePrimary}; font-weight: 600;" contenteditable="true">${safeHeadlineSub}</h2>
                  </div>

                  <!-- Benefits with checkmarks -->
                  <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-top: 14px; background: #f8fafc; padding: 10px; border-radius: 8px; border-left: 4px solid ${safePrimary};">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px 8px;">
                      ${services.slice(0, 8).map(s => `
                        <div style="font-size: 9px; color: #334155; display: flex; align-items: flex-start; gap: 4px; line-height: 1.2;">
                          <span style="width: 14px; height: 14px; background: ${safePrimary}; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 9px; flex-shrink: 0;">âœ“</span>
                          <span contenteditable="true" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s}</span>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>

                <!-- Strong CTA area -->
                <div>
                  <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 12px 20px; border-radius: 6px; font-weight: 800; font-size: 14px; text-align: center; box-shadow: 0 4px 15px ${safePrimary}40; margin-bottom: 10px;" contenteditable="true">${safeCta}</div>
                  <div style="text-align: center; font-size: 12px;">
                    <span style="font-weight: 800; color: #1e293b;" contenteditable="true">${safePhoneDisplay}</span>
                    <span style="color: #64748b; margin: 0 6px;">|</span>
                    <span style="color: ${safePrimary}; font-weight: 600;" contenteditable="true">${safeWebsite}</span>
                  </div>
                </div>
              </div>

              <!-- Right image + offer column -->
              <div style="width: 45%; position: relative;">
                <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;">
                  <div style="position: absolute; inset: 0; background: linear-gradient(to left, transparent 50%, white 100%);"></div>
                </div>

                <!-- Floating offer box -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px 24px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; border: 3px solid ${safePrimary};">
                  <div style="font-size: 36px; font-weight: 900; color: ${safePrimary}; line-height: 1; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; text-align: center;" contenteditable="true">${safeDiscountText}</div>
                  <div style="width: 40px; height: 40px; margin: 10px auto 0; border: 2px solid ${safePrimary}20;">
                    <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
                  </div>
                </div>

                <!-- Review badge -->
                <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: absolute; bottom: 12px; right: 12px; background: rgba(255,255,255,0.95); padding: 10px 14px; border-radius: 8px; max-width: 140px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);">
                  <div style="color: #fbbf24; font-size: 12px; margin-bottom: 4px;">â˜…â˜…â˜…â˜…â˜…</div>
                  <p style="font-size: 9px; color: #374151;" contenteditable="true">"${testimonial.text.substring(0, 50)}..."</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'cleanModern') {
        // CLEAN MODERN - Z-pattern reading flow, minimal distractions
        frontHTML = `
          <div style="width: 100%; height: 100%; background: linear-gradient(180deg, #fafafa 0%, #f0f0f0 100%); padding: 20px; display: flex; flex-direction: column; justify-content: space-between;">
            <!-- Top row: Logo left, Offer right (Z-pattern start) -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize + 4}px; margin-bottom: 6px;" onerror="this.outerHTML='<div style=\\'font-size:18px;font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</div>'">
                <p style="font-size: 10px; color: #64748b;" contenteditable="true">${safeTagline}</p>
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 14px 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); text-align: center; border: 2px solid ${safePrimary}20;">
                <div style="font-size: 28px; font-weight: 800; color: ${safePrimary}; line-height: 1; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
                <div style="font-size: 10px; color: #64748b; margin-top: 4px; text-align: center;" contenteditable="true">${safeDiscountText}</div>
              </div>
            </div>

            <!-- Middle: Headline + Image (focal point) -->
            <div style="display: flex; align-items: center; gap: 20px; margin: 10px 0;">
              <div style="flex: 1;">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', serif; font-size: 30px; color: #1a1a1a; line-height: 1.05; font-weight: 700;" contenteditable="true">${safeHeadlineMain}</h1>
                  <h2 style="font-size: 14px; color: ${safeSecondary}; font-weight: 500; margin-top: 6px;" contenteditable="true">${safeHeadlineSub}</h2>
                </div>

                <!-- Inline services -->
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px;">
                  ${services.slice(0, 3).map(s => `
                    <span style="font-size: 10px; color: #475569; display: flex; align-items: center; gap: 4px;">
                      <span style="width: 6px; height: 6px; background: ${safePrimary}; border-radius: 50%;"></span>
                      <span contenteditable="true">${s}</span>
                    </span>
                  `).join('')}
                </div>
              </div>

              <!-- Circular image -->
              <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 160px; height: 160px; border-radius: 16px; background: url('${safePoolImage}') center/cover; box-shadow: 0 20px 50px rgba(0,0,0,0.15); flex-shrink: 0;"></div>
            </div>

            <!-- Bottom row: CTA left, Contact right (Z-pattern end) -->
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 700; font-size: 12px; box-shadow: 0 6px 20px ${safePrimary}40;" contenteditable="true">${safeCta}</div>
                <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: #fef3c7; color: #b45309; padding: 6px 12px; border-radius: 6px; font-size: 10px; font-weight: 600;" contenteditable="true">${safeUrgency}</div>
              </div>

              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="text-align: right;">
                  <p style="font-size: 14px; font-weight: 700; color: #1a1a1a;" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="font-size: 11px; color: ${safePrimary};" contenteditable="true">${safeWebsite}</p>
                </div>
                <div style="width: 50px; height: 50px; background: white; border-radius: 8px; padding: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                  <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.parentElement.style.display='none'">
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'luxury') {
        // LUXURY - Dark elegant theme, gold accents, sophisticated
        frontHTML = `
          <div style="width: 100%; height: 100%; background: #1a1a1a; position: relative; overflow: hidden;">
            <!-- Subtle pattern overlay -->
            <div style="position: absolute; inset: 0; opacity: 0.03; background-image: url('data:image/svg+xml,<svg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M30 0L60 30L30 60L0 30Z\" fill=\"white\" fill-opacity=\"0.5\"/></svg>');"></div>

            <!-- Gold accent line -->
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, transparent, #c9a962, transparent);"></div>

            <div style="position: relative; height: 100%; display: flex;">
              <!-- Left content -->
              <div style="width: 55%; padding: 28px; display: flex; flex-direction: column; justify-content: space-between;">
                <div>
                  <!-- Elegant logo area -->
                  <div style="margin-bottom: 20px;">
                    <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<div style=\\'font-family: Playfair Display, serif; font-size:22px;font-weight:400;color:#c9a962;letter-spacing:2px\\'>${safeCompanyName}</div>'">
                  </div>

                  <!-- Headline with gold accent -->
                  <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                    <h1 style="font-family: 'Playfair Display', serif; font-size: 32px; color: #ffffff; line-height: 1.1; font-weight: 400; letter-spacing: -0.5px;" contenteditable="true">${safeHeadlineMain}</h1>
                    <div style="width: 60px; height: 1px; background: #c9a962; margin: 14px 0;"></div>
                    <h2 style="font-family: 'Inter', sans-serif; font-size: 12px; color: #888; font-weight: 400; letter-spacing: 2px; text-transform: uppercase;" contenteditable="true">${safeHeadlineSub}</h2>
                  </div>

                  <!-- Minimal services -->
                  <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-top: 20px;">
                    ${services.slice(0, 3).map(s => `
                      <p style="font-size: 11px; color: #999; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                        <span style="color: #c9a962;">â—†</span>
                        <span contenteditable="true">${s}</span>
                      </p>
                    `).join('')}
                  </div>
                </div>

                <!-- Luxury CTA -->
                <div>
                  <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; border: 1px solid #c9a962; color: #c9a962; padding: 14px 24px; font-weight: 500; font-size: 11px; text-align: center; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 16px;" contenteditable="true">${safeCta}</div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 11px;">
                      <p style="font-weight: 500; color: #fff; letter-spacing: 1px;" contenteditable="true">${safePhoneDisplay}</p>
                      <p style="color: #666; margin-top: 2px;" contenteditable="true">${safeWebsite}</p>
                    </div>
                    <div style="width: 48px; height: 48px; border: 1px solid #333; padding: 4px; background: #0f0f0f;">
                      <img src="${safeQrUrl}" style="width: 100%; height: 100%; filter: invert(1);" onerror="this.style.display='none'">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Right image -->
              <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 45%; position: relative; background: url('${safePoolImage}') center/cover;">
                <div style="position: absolute; inset: 0; background: linear-gradient(to right, #1a1a1a 0%, transparent 30%);"></div>

                <!-- Elegant discount badge -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 24px; right: 24px; background: rgba(26,26,26,0.95); border: 1px solid #c9a962; padding: 16px 20px; text-align: center;">
                  <div style="font-family: 'Playfair Display', serif; font-size: 32px; color: #c9a962; line-height: 1; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 9px; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-top: 6px; text-align: center;" contenteditable="true">${safeDiscountText}</div>
                </div>

                <!-- Review -->
                <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: absolute; bottom: 24px; left: 20px; right: 24px; background: rgba(26,26,26,0.95); padding: 14px; border-left: 2px solid #c9a962;">
                  <div style="color: #c9a962; font-size: 10px; letter-spacing: 2px; margin-bottom: 6px;">â˜…â˜…â˜…â˜…â˜…</div>
                  <p style="font-size: 10px; color: #999; font-style: italic; line-height: 1.4;" contenteditable="true">"${safeTestimonialText}"</p>
                  <p style="font-size: 9px; color: #666; margin-top: 6px;" contenteditable="true">â€” ${safeTestimonialAuthor}</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'corporate') {
        // CORPORATE - Professional business style
        frontHTML = `
          <div style="width: 100%; height: 100%; background: #f8fafc; display: flex; overflow: hidden;">
            <div style="width: 6px; background: ${safePrimary};"></div>
            <div style="flex: 1; padding: 16px 18px; display: flex; flex-direction: column; justify-content: space-between; max-width: 55%;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; max-width: 120px; object-fit: contain;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</div>'">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: ${safePrimary}; color: white; padding: 8px 12px; text-align: center; flex-shrink: 0;">
                  <div style="font-size: 18px; font-weight: 700;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 10px; text-transform: uppercase;" contenteditable="true">${safeDiscountText}</div>
                </div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 22px; color: #1e293b; font-weight: 700; line-height: 1.1;" contenteditable="true">${safeHeadlineMain}</h1>
                <h2 style="font-size: 12px; color: ${safePrimary}; margin-top: 4px;" contenteditable="true">${safeHeadlineSub}</h2>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px 8px;">
                ${services.slice(0, 6).map(s => `<span style="font-size: 9px; color: #475569; display: flex; align-items: flex-start; gap: 4px; line-height: 1.2;"><span style="color: ${safePrimary}; flex-shrink: 0;">âœ“</span><span contenteditable="true">${s}</span></span>`).join('')}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 10px 16px; font-weight: 600; font-size: 11px; white-space: nowrap;" contenteditable="true">${safeCta}</div>
                <div style="text-align: right; font-size: 10px; flex-shrink: 0;">
                  <p style="font-weight: 700; color: #1e293b;" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="color: ${safePrimary};" contenteditable="true">${safeWebsite}</p>
                </div>
              </div>
            </div>
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="flex: 1; background: url('${safePoolImage}') center/cover;"></div>
          </div>
        `;
      } else if (layout === 'executive') {
        // EXECUTIVE - High-end business with pool image
        frontHTML = `
          <div style="width: 100%; height: 100%; display: flex; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 45%; background: url('${safePoolImage}') center/cover; position: relative;">
              <div style="position: absolute; inset: 0; background: linear-gradient(to right, transparent 0%, #0f172a 100%);"></div>
            </div>
            <div style="width: 55%; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 28px; display: flex; flex-direction: column; justify-content: space-between; position: relative;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<div style=\\'font-size:18px;font-weight:600;color:white;letter-spacing:1px\\'>${safeCompanyName}</div>'">
                <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; border: 1px solid ${safePrimary}; color: ${safePrimary}; padding: 6px 14px; font-size: 9px; font-weight: 600;" contenteditable="true">${safeUrgency}</div>
              </div>
              <div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', serif; font-size: 32px; color: white; font-weight: 400; line-height: 1;" contenteditable="true">${safeHeadlineMain}</h1>
                  <div style="width: 50px; height: 2px; background: ${safePrimary}; margin: 16px 0;"></div>
                </div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; flex-wrap: wrap; gap: 12px;">
                  ${services.slice(0, 3).map(s => `<span style="font-size: 11px; color: rgba(255,255,255,0.7);" contenteditable="true">${s}</span>`).join('')}
                </div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div>
                  <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; margin-bottom: 12px;">
                    <span style="font-size: 36px; font-weight: 300; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                    <span style="font-size: 11px; color: rgba(255,255,255,0.6); margin-left: 8px;" contenteditable="true">${safeDiscountText}</span>
                  </div>
                  <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 12px 24px; font-weight: 500; font-size: 11px; display: inline-block;" contenteditable="true">${safeCta}</div>
                </div>
                <div style="text-align: right; color: rgba(255,255,255,0.8); font-size: 11px;">
                  <p style="font-weight: 600;" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="opacity: 0.7;" contenteditable="true">${safeWebsite}</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'consulting') {
        // CONSULTING - Trust-focused professional
        frontHTML = `
          <div style="width: 100%; height: 100%; background: white; display: flex;">
            <div style="width: 55%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                  <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.style.display='none'">
                  <div style="height: 30px; width: 1px; background: #e2e8f0;"></div>
                  <div style="font-size: 10px; color: #64748b; line-height: 1.3;" contenteditable="true">Trusted Pool<br>Professionals</div>
                </div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', serif; font-size: 26px; color: #0f172a; line-height: 1.15;" contenteditable="true">${safeHeadlineMain}</h1>
                  <p style="font-size: 13px; color: #64748b; margin-top: 8px;" contenteditable="true">${safeHeadlineSub}</p>
                </div>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 3).map(s => `<div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;"><span style="width: 20px; height: 20px; background: ${safePrimary}10; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: ${safePrimary}; font-size: 10px;">âœ“</span><span style="font-size: 11px; color: #334155;" contenteditable="true">${s}</span></div>`).join('')}
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 12px 20px; border-radius: 6px; font-weight: 600; font-size: 11px;" contenteditable="true">${safeCta}</div>
                <div style="font-size: 11px;"><span style="font-weight: 700; color: #0f172a;" contenteditable="true">${safePhoneDisplay}</span></div>
              </div>
            </div>
            <div style="width: 45%; position: relative;">
              <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
              <div style="position: absolute; inset: 0; background: linear-gradient(to right, white 0%, transparent 20%);"></div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 20px; right: 20px; background: white; padding: 14px 18px; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); text-align: center;">
                <div style="font-size: 24px; font-weight: 800; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</div>
                <div style="font-size: 9px; color: #64748b;" contenteditable="true">${safeDiscountText}</div>
              </div>
              <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: absolute; bottom: 20px; left: 20px; right: 20px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
                <div style="color: #fbbf24; font-size: 10px; margin-bottom: 4px;">â˜…â˜…â˜…â˜…â˜…</div>
                <p style="font-size: 10px; color: #475569; font-style: italic;" contenteditable="true">"${safeTestimonialText}"</p>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'centered') {
        // CENTERED - Symmetric balanced design
        frontHTML = `
          <div style="width: 100%; height: 100%; background: linear-gradient(180deg, ${safePrimary}08 0%, white 50%, ${safePrimary}08 100%); padding: 24px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; text-align: center;">
            <div style="display: flex; align-items: center; gap: 16px;">
              <div style="width: 40px; height: 1px; background: ${safePrimary}40;"></div>
              <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</div>'">
              <div style="width: 40px; height: 1px; background: ${safePrimary}40;"></div>
            </div>
            <div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; display: inline-block; background: ${safePrimary}; color: white; padding: 8px 20px; border-radius: 30px; margin-bottom: 12px;">
                <span style="font-size: 18px; font-weight: 800;" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 10px; margin-left: 4px;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', serif; font-size: 32px; color: #1e293b; line-height: 1;" contenteditable="true">${safeHeadlineMain}</h1>
                <h2 style="font-size: 14px; color: ${safeSecondary}; margin-top: 8px;" contenteditable="true">${safeHeadlineSub}</h2>
              </div>
            </div>
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 200px; height: 100px; border-radius: 100px; background: url('${safePoolImage}') center/cover; box-shadow: 0 20px 50px ${safePrimary}30;"></div>
            <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
              ${services.slice(0, 4).map(s => `<span style="font-size: 10px; color: #475569;"><span style="color: ${safePrimary};">âœ“</span> <span contenteditable="true">${s}</span></span>`).join('')}
            </div>
            <div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 12px 32px; border-radius: 6px; font-weight: 700; font-size: 12px; margin-bottom: 8px;" contenteditable="true">${safeCta}</div>
              <p style="font-size: 12px; color: #64748b;"><span style="font-weight: 700; color: #1e293b;" contenteditable="true">${safePhoneDisplay}</span> â€¢ <span contenteditable="true">${safeWebsite}</span></p>
            </div>
          </div>
        `;
      } else if (layout === 'asymmetric') {
        // ASYMMETRIC - Dynamic unbalanced design
        frontHTML = `
          <div style="width: 100%; height: 100%; background: white; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; top: 0; right: 0; width: 65%; height: 70%; background: url('${safePoolImage}') center/cover; border-radius: 0 0 0 40px;"></div>
            <div style="position: absolute; bottom: 0; left: 0; width: 70%; height: 50%; background: ${safePrimary}; padding: 20px;">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', serif; font-size: 26px; color: white; line-height: 1.1;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; gap: 12px; margin-top: 10px;">
                ${services.slice(0, 3).map(s => `<span style="font-size: 9px; color: rgba(255,255,255,0.8);" contenteditable="true">${s}</span>`).join('')}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 10px 20px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
                <div style="color: white; font-size: 11px; text-align: right;">
                  <p style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="opacity: 0.8;" contenteditable="true">${safeWebsite}</p>
                </div>
              </div>
            </div>
            <div style="position: absolute; top: 20px; left: 20px;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</div>'">
            </div>
            <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 60%; right: 10%; background: white; padding: 16px 20px; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); text-align: center;">
              <div style="font-size: 28px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</div>
              <div style="font-size: 9px; color: #64748b;" contenteditable="true">${safeDiscountText}</div>
            </div>
          </div>
        `;
      } else if (layout === 'thirds') {
        // THIRDS - Rule of thirds grid
        frontHTML = `
          <div style="width: 100%; height: 100%; display: grid; grid-template-columns: 1fr 1fr 1fr; overflow: hidden;">
            <div style="background: ${safePrimary}; padding: 20px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<div style=\\'font-size:14px;font-weight:700;color:white\\'>${safeCompanyName}</div>'">
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 3).map(s => `<p style="font-size: 9px; color: rgba(255,255,255,0.8); margin-bottom: 6px;" contenteditable="true">â€¢ ${s}</p>`).join('')}
              </div>
              <div style="font-size: 10px; color: white;">
                <p style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                <p style="opacity: 0.7;" contenteditable="true">${safeWebsite}</p>
              </div>
            </div>
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="background: url('${safePoolImage}') center/cover; position: relative;">
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 16px 20px; border-radius: 50%; width: 90px; height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <div style="font-size: 22px; font-weight: 900; color: ${safePrimary}; text-align: center;" contenteditable="true">${safeDiscountAmount}</div>
                <div style="font-size: 10px; color: #64748b; text-align: center;" contenteditable="true">${safeDiscountText}</div>
              </div>
            </div>
            <div style="background: white; padding: 20px; display: flex; flex-direction: column; justify-content: space-between;">
              <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: #ef4444; color: white; padding: 6px 10px; font-size: 10px; font-weight: 700; text-align: center;" contenteditable="true">${safeUrgency}</div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', serif; font-size: 20px; color: #1e293b; line-height: 1.1;" contenteditable="true">${safeHeadlineMain}</h1>
                <h2 style="font-size: 11px; color: ${safePrimary}; margin-top: 6px;" contenteditable="true">${safeHeadlineSub}</h2>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 12px; font-weight: 700; font-size: 11px; text-align: center;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      } else if (layout === 'collage') {
        // COLLAGE - Multiple image feel
        frontHTML = `
          <div style="width: 100%; height: 100%; background: #f1f5f9; padding: 16px; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 12px;">
            <div style="background: white; padding: 16px; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:14px;font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</div>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', serif; font-size: 18px; color: #1e293b; line-height: 1.1;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
            </div>
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="background: url('${safePoolImage}') center/cover; border-radius: 8px; position: relative;">
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; bottom: 8px; right: 8px; background: ${safePrimary}; color: white; padding: 8px 12px; border-radius: 6px;">
                <span style="font-size: 16px; font-weight: 800;" contenteditable="true">${safeDiscountAmount}</span>
              </div>
            </div>
            <div style="background: ${safePrimary}; padding: 16px; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between;">
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 2).map(s => `<p style="font-size: 10px; color: white; margin-bottom: 4px;" contenteditable="true">âœ“ ${s}</p>`).join('')}
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 10px; font-weight: 700; font-size: 10px; text-align: center; border-radius: 4px;" contenteditable="true">${safeCta}</div>
            </div>
            <div style="background: white; padding: 16px; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between;">
              <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: relative;">
                <div style="color: #fbbf24; font-size: 10px;">â˜…â˜…â˜…â˜…â˜…</div>
                <p style="font-size: 9px; color: #475569; font-style: italic; margin-top: 4px;" contenteditable="true">"${testimonial.text.substring(0, 60)}..."</p>
              </div>
              <div style="font-size: 11px;">
                <p style="font-weight: 700; color: #1e293b;" contenteditable="true">${safePhoneDisplay}</p>
                <p style="color: ${safePrimary};" contenteditable="true">${safeWebsite}</p>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'gradient') {
        // GRADIENT - Modern gradient mesh
        frontHTML = `
          <div style="width: 100%; height: 100%; background: linear-gradient(135deg, ${safePrimary} 0%, ${safeSecondary} 50%, #1e293b 100%); position: relative; overflow: hidden;">
            <div style="position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);"></div>
            <div style="position: absolute; bottom: -50px; left: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);"></div>
            <div style="position: relative; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<div style=\\'font-size:18px;font-weight:700;color:white\\'>${safeCompanyName}</div>'">
                <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; padding: 6px 14px; border-radius: 20px; font-size: 9px; font-weight: 600;" contenteditable="true">${safeUrgency}</div>
              </div>
              <div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 36px; color: white; font-weight: 800; line-height: 1;" contenteditable="true">${safeHeadlineMain}</h1>
                  <h2 style="font-size: 14px; color: rgba(255,255,255,0.7); margin-top: 8px;" contenteditable="true">${safeHeadlineSub}</h2>
                </div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; display: inline-block; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 12px; margin-top: 16px;">
                  <span style="font-size: 32px; font-weight: 900; color: white;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 11px; color: rgba(255,255,255,0.8); margin-left: 8px;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 14px 28px; border-radius: 8px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
                <div style="text-align: right; color: white; font-size: 12px;">
                  <p style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="opacity: 0.7;" contenteditable="true">${safeWebsite}</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'neon') {
        // NEON - Glowing neon effect
        frontHTML = `
          <div style="width: 100%; height: 100%; background: #0a0a0a; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; opacity: 0.3;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(180deg, transparent 0%, #0a0a0a 100%);"></div>
            <div style="position: relative; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="color: ${safePrimary}; text-shadow: 0 0 10px ${safePrimary}, 0 0 20px ${safePrimary}, 0 0 40px ${safePrimary}; font-size: 16px; font-weight: 700;" contenteditable="true">${safeCompanyName}</div>
                <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; border: 1px solid ${safePrimary}; color: ${safePrimary}; padding: 6px 14px; font-size: 9px; font-weight: 600; box-shadow: 0 0 10px ${safePrimary}40, inset 0 0 10px ${safePrimary}20;" contenteditable="true">${safeUrgency}</div>
              </div>
              <div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 38px; color: white; font-weight: 900; line-height: 0.95; text-shadow: 0 0 20px rgba(255,255,255,0.5);" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; display: inline-block; margin-top: 16px;">
                  <span style="font-size: 38px; font-weight: 900; color: ${safePrimary}; text-shadow: 0 0 15px ${safePrimary}, 0 0 30px ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 12px; color: white; margin-left: 8px; opacity: 0.8;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 14px 28px; font-weight: 700; font-size: 12px; box-shadow: 0 0 20px ${safePrimary}, 0 0 40px ${safePrimary}60;" contenteditable="true">${safeCta}</div>
                <div style="text-align: right; color: white; font-size: 12px;">
                  <p style="font-weight: 700; text-shadow: 0 0 10px rgba(255,255,255,0.5);" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="opacity: 0.6;" contenteditable="true">${safeWebsite}</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'retro') {
        // RETRO - Vintage 70s/80s style
        frontHTML = `
          <div style="width: 100%; height: 100%; background: #fef3c7; position: relative; overflow: hidden;">
            <div style="position: absolute; inset: 0; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);"></div>
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 8px; background: linear-gradient(90deg, #ef4444, #f97316, #eab308, #22c55e, #3b82f6, #8b5cf6);"></div>
            <div style="position: relative; height: 100%; padding: 24px; display: flex;">
              <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
                <div>
                  <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #92400e; margin-bottom: 8px;" contenteditable="true">EST. 2024</div>
                  <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                    <h1 style="font-family: '${font}', serif; font-size: 32px; color: #78350f; line-height: 1; font-weight: 900;" contenteditable="true">${safeHeadlineMain}</h1>
                    <h2 style="font-size: 14px; color: #a16207; margin-top: 8px; font-style: italic;" contenteditable="true">${safeHeadlineSub}</h2>
                  </div>
                </div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${services.slice(0, 3).map(s => `<span style="background: #78350f; color: #fef3c7; padding: 4px 10px; font-size: 9px; font-weight: 600;" contenteditable="true">${s}</span>`).join('')}
                </div>
                <div style="display: flex; gap: 16px; align-items: center;">
                  <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: #78350f; color: #fef3c7; padding: 12px 24px; font-weight: 700; font-size: 12px; border: 3px solid #78350f;" contenteditable="true">${safeCta}</div>
                  <div style="font-size: 12px; color: #78350f;">
                    <p style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                  </div>
                </div>
              </div>
              <div style="width: 40%; position: relative;">
                <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; border: 4px solid #78350f; border-radius: 8px;"></div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; width: 75px; height: 75px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 3px solid #fef3c7; transform: rotate(15deg);">
                  <span style="font-size: 18px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'coupon') {
        // COUPON - Tear-off coupon style
        frontHTML = `
          <div style="width: 100%; height: 100%; background: white; display: flex; position: relative;">
            <div style="flex: 1; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; border-right: 2px dashed #d1d5db;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; margin-bottom: 12px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary};margin-bottom:12px\\'>${safeCompanyName}</div>'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', serif; font-size: 24px; color: #1e293b; line-height: 1.1;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-top: 12px;">
                  ${services.slice(0, 3).map(s => `<p style="font-size: 10px; color: #475569; margin-bottom: 4px;"><span style="color: ${safePrimary};">âœ“</span> <span contenteditable="true">${s}</span></p>`).join('')}
                </div>
              </div>
              <div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 10px 20px; font-weight: 700; font-size: 11px; text-align: center; margin-bottom: 8px;" contenteditable="true">${safeCta}</div>
                <p style="font-size: 11px; text-align: center;"><span style="font-weight: 700; color: #1e293b;" contenteditable="true">${safePhoneDisplay}</span> â€¢ <span style="color: ${safePrimary};" contenteditable="true">${safeWebsite}</span></p>
              </div>
            </div>
            <div style="width: 35%; background: linear-gradient(135deg, ${safePrimary} 0%, ${safeSecondary} 100%); padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; position: relative;">
              <div style="position: absolute; left: -8px; top: 20px; bottom: 20px; display: flex; flex-direction: column; justify-content: space-between;">
                ${Array(8).fill().map(() => `<div style="width: 16px; height: 16px; background: white; border-radius: 50%;"></div>`).join('')}
              </div>
              <div style="font-size: 10px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px;">Save</div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative;">
                <div style="font-size: 38px; font-weight: 900; color: white; line-height: 1;" contenteditable="true">${safeDiscountAmount}</div>
                <div style="font-size: 11px; color: rgba(255,255,255,0.9);" contenteditable="true">${safeDiscountText}</div>
              </div>
              <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: white; color: ${safePrimary}; padding: 6px 12px; font-size: 10px; font-weight: 700; margin-top: 12px;" contenteditable="true">${safeUrgency}</div>
            </div>
          </div>
        `;
      } else if (layout === 'glassmorphism') {
        // GLASSMORPHISM - Frosted glass effect
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; filter: brightness(1.1);"></div>
            <div style="position: absolute; inset: 20px; background: rgba(255,255,255,0.25); backdrop-filter: blur(20px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.3); padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:18px;font-weight:700;color:white;text-shadow:0 2px 10px rgba(0,0,0,0.3)\\'>${safeCompanyName}</div>'">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: rgba(255,255,255,0.3); backdrop-filter: blur(10px); padding: 12px 16px; border-radius: 12px; text-align: center;">
                  <div style="font-size: 24px; font-weight: 800; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.3);" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 9px; color: rgba(255,255,255,0.9);" contenteditable="true">${safeDiscountText}</div>
                </div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 32px; color: white; font-weight: 700; line-height: 1; text-shadow: 0 2px 20px rgba(0,0,0,0.3);" contenteditable="true">${safeHeadlineMain}</h1>
                <h2 style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 8px;" contenteditable="true">${safeHeadlineSub}</h2>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: #1e293b; padding: 12px 24px; border-radius: 10px; font-weight: 700; font-size: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);" contenteditable="true">${safeCta}</div>
                <div style="text-align: right; color: white; font-size: 12px; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                  <p style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                  <p style="opacity: 0.9;" contenteditable="true">${safeWebsite}</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'brutalist') {
        // BRUTALIST - Raw industrial design
        frontHTML = `
          <div style="width: 100%; height: 100%; background: #f5f5f5; padding: 16px; font-family: 'Courier New', monospace;">
            <div style="border: 3px solid black; height: 100%; padding: 16px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; border-bottom: 2px solid black; padding-bottom: 12px;">
                <div style="font-size: 14px; font-weight: 700; text-transform: uppercase;" contenteditable="true">${safeCompanyName}</div>
                <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: black; color: white; padding: 4px 10px; font-size: 10px;" contenteditable="true">${safeUrgency}</div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-size: 34px; color: black; font-weight: 900; line-height: 0.95; text-transform: uppercase;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; display: flex; align-items: baseline; gap: 8px;">
                <span style="font-size: 42px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 14px; text-transform: uppercase;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; gap: 16px; border-top: 2px solid black; padding-top: 12px;">
                ${services.slice(0, 3).map(s => `<span style="font-size: 10px; text-transform: uppercase;" contenteditable="true">[${s}]</span>`).join('')}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; border-top: 2px solid black; padding-top: 12px;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: black; color: white; padding: 12px 24px; font-size: 12px; text-transform: uppercase;" contenteditable="true">${safeCta}</div>
                <div style="font-size: 12px; text-align: right;">
                  <p style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                  <p contenteditable="true">${safeWebsite}</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'swiss') {
        // SWISS - Clean international style
        frontHTML = `
          <div style="width: 100%; height: 100%; background: white; padding: 24px; display: grid; grid-template-rows: auto 1fr auto; gap: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:14px;font-weight:700;color:black\\'>${safeCompanyName}</div>'">
              <div style="width: 60px; height: 60px; background: ${safePrimary}; display: flex; align-items: center; justify-content: center;">
                <span style="color: white; font-size: 20px; font-weight: 900;" contenteditable="true">${discount.amount.replace(/[^0-9%]/g, '')}</span>
              </div>
            </div>
            <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
              <h1 style="font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 36px; color: black; font-weight: 700; line-height: 0.95; letter-spacing: -1px;" contenteditable="true">${safeHeadlineMain}</h1>
              <div style="width: 100%; height: 4px; background: black; margin: 16px 0;"></div>
              <h2 style="font-size: 14px; color: #666; font-weight: 400;" contenteditable="true">${safeHeadlineSub}</h2>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 3).map((s, i) => `<p style="font-size: 11px; color: #333; margin-bottom: 4px;"><span style="color: ${safePrimary}; font-weight: 700;">${String(i + 1).padStart(2, '0')}</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div style="text-align: right;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: black; color: white; padding: 14px 24px; font-size: 11px; font-weight: 500; margin-bottom: 8px;" contenteditable="true">${safeCta}</div>
                <p style="font-size: 12px; color: #333;"><span style="font-weight: 600;" contenteditable="true">${safePhoneDisplay}</span></p>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'sunset') {
        // SUNSET - Warm gradient feel
        frontHTML = `
          <div style="width: 100%; height: 100%; background: linear-gradient(180deg, #fef3c7 0%, #fdba74 30%, #f97316 60%, #c2410c 100%); position: relative; overflow: hidden; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40%; background: rgba(0,0,0,0.3);"></div>
            <div style="position: relative; display: flex; justify-content: space-between; align-items: flex-start;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:18px;font-weight:700;color:#7c2d12\\'>${safeCompanyName}</div>'">
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 12px 16px; border-radius: 8px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                <div style="font-size: 24px; font-weight: 800; color: #c2410c;" contenteditable="true">${safeDiscountAmount}</div>
                <div style="font-size: 9px; color: #9a3412;" contenteditable="true">${safeDiscountText}</div>
              </div>
            </div>
            <div style="position: relative;">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', serif; font-size: 36px; color: white; font-weight: 700; line-height: 1; text-shadow: 0 4px 20px rgba(0,0,0,0.3);" contenteditable="true">${safeHeadlineMain}</h1>
                <h2 style="font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 8px;" contenteditable="true">${safeHeadlineSub}</h2>
              </div>
            </div>
            <div style="position: relative; display: flex; justify-content: space-between; align-items: flex-end;">
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: #c2410c; padding: 14px 28px; border-radius: 8px; font-weight: 700; font-size: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);" contenteditable="true">${safeCta}</div>
              <div style="text-align: right; color: white; font-size: 12px; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                <p style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                <p style="opacity: 0.9;" contenteditable="true">${safeWebsite}</p>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'coastal') {
        // COASTAL - Beach/ocean vibe
        frontHTML = `
          <div style="width: 100%; height: 100%; background: linear-gradient(180deg, #e0f2fe 0%, #7dd3fc 50%, #0ea5e9 100%); position: relative; overflow: hidden;">
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 30%; background: #fef9c3;"></div>
            <div style="position: relative; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:18px;font-weight:700;color:#0c4a6e\\'>${safeCompanyName}</div>'">
                <div data-movable="true" class="${lc('urgency')}" ondblclick="event.stopPropagation(); toggleLock('urgency');" style="position: relative; background: #0ea5e9; color: white; padding: 6px 14px; border-radius: 20px; font-size: 9px; font-weight: 600;" contenteditable="true">${safeUrgency}</div>
              </div>
              <div style="text-align: center;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; display: inline-block; background: white; padding: 16px 24px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); margin-bottom: 16px;">
                  <div style="font-size: 36px; font-weight: 900; color: #0ea5e9;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 10px; color: #0369a1;" contenteditable="true">${safeDiscountText}</div>
                </div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', serif; font-size: 30px; color: #0c4a6e; font-weight: 700; line-height: 1;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: #0ea5e9; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
                <div style="text-align: right; color: #0c4a6e; font-size: 12px;">
                  <p style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                  <p contenteditable="true">${safeWebsite}</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'playful') {
        // PLAYFUL - Fun colorful design
        frontHTML = `
          <div style="width: 100%; height: 100%; background: #fef3c7; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -30px; left: -30px; width: 120px; height: 120px; background: #f87171; border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -40px; right: -40px; width: 150px; height: 150px; background: #60a5fa; border-radius: 50%;"></div>
            <div style="position: absolute; top: 50%; left: 60%; width: 80px; height: 80px; background: #34d399; border-radius: 50%;"></div>
            <div style="position: relative; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:18px;font-weight:800;color:#1e293b\\'>${safeCompanyName}</div>'">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: #f87171; color: white; padding: 12px 16px; border-radius: 16px; transform: rotate(5deg);">
                  <div style="font-size: 24px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 9px;" contenteditable="true">${safeDiscountText}</div>
                </div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="max-width: 60%;">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 32px; color: #1e293b; font-weight: 800; line-height: 1;" contenteditable="true">${safeHeadlineMain}</h1>
                <h2 style="font-size: 14px; color: #64748b; margin-top: 8px;" contenteditable="true">${safeHeadlineSub}</h2>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: #1e293b; color: white; padding: 14px 28px; border-radius: 30px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
                <div style="text-align: right; font-size: 12px; color: #1e293b;">
                  <p style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                  <p contenteditable="true">${safeWebsite}</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'urgentSale') {
        // URGENT SALE - High urgency marketing
        frontHTML = `
          <div style="width: 100%; height: 100%; background: #ef4444; position: relative; overflow: hidden;">
            <div style="position: absolute; inset: 0; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px);"></div>
            <div style="position: absolute; top: 0; left: 0; right: 0; background: #fbbf24; padding: 8px; text-align: center;">
              <span style="font-size: 12px; font-weight: 900; color: #1e293b; text-transform: uppercase; letter-spacing: 2px;" contenteditable="true">${safeUrgency}</span>
            </div>
            <div style="position: relative; height: 100%; padding: 50px 24px 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="text-align: center;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative;">
                  <div style="font-size: 38px; font-weight: 900; color: white; line-height: 0.9; text-shadow: 2px 2px 0 rgba(0,0,0,0.2);" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 16px; color: #fef2f2; text-transform: uppercase; letter-spacing: 3px;" contenteditable="true">${safeDiscountText}</div>
                </div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="text-align: center;">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; color: white; font-weight: 800; line-height: 1; text-transform: uppercase;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: #ef4444; padding: 16px; font-weight: 900; font-size: 14px; text-align: center; text-transform: uppercase;" contenteditable="true">${safeCta}</div>
                <p style="text-align: center; color: white; font-size: 14px; margin-top: 12px;"><span style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</span> â€¢ <span contenteditable="true">${safeWebsite}</span></p>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'testimonialFocus') {
        // TESTIMONIAL FOCUS - Review-centered design
        frontHTML = `
          <div style="width: 100%; height: 100%; background: white; display: flex;">
            <div style="width: 45%; background: ${safePrimary}; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:white\\'>${safeCompanyName}</div>'">
              <div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; margin-bottom: 16px;">
                  <div style="font-size: 36px; font-weight: 800; color: white;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 10px; color: rgba(255,255,255,0.8);" contenteditable="true">${safeDiscountText}</div>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 12px 20px; font-weight: 700; font-size: 11px; text-align: center;" contenteditable="true">${safeCta}</div>
              </div>
              <div style="color: white; font-size: 11px;">
                <p style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                <p style="opacity: 0.8;" contenteditable="true">${safeWebsite}</p>
              </div>
            </div>
            <div style="flex: 1; padding: 24px; display: flex; flex-direction: column; justify-content: center;">
              <div style="color: ${safePrimary}; font-size: 48px; line-height: 0.8; margin-bottom: 12px;">"</div>
              <div data-movable="true" class="${lc('testimonial')}" ondblclick="event.stopPropagation(); toggleLock('testimonial');" style="position: relative;">
                <p style="font-family: '${font}', serif; font-size: 18px; color: #1e293b; line-height: 1.4; font-style: italic;" contenteditable="true">${safeTestimonialText}</p>
                <div style="display: flex; align-items: center; gap: 12px; margin-top: 16px;">
                  <div style="color: #fbbf24; font-size: 14px;">â˜…â˜…â˜…â˜…â˜…</div>
                  <div>
                    <p style="font-size: 12px; font-weight: 700; color: #1e293b;" contenteditable="true">${safeTestimonialAuthor}</p>
                    <p style="font-size: 10px; color: #64748b;" contenteditable="true">${safeTestimonialLocation}</p>
                  </div>
                </div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                <h2 style="font-size: 16px; color: ${safePrimary}; font-weight: 600;" contenteditable="true">${safeHeadlineMain}</h2>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'guarantee') {
        // GUARANTEE - Trust/guarantee focused
        frontHTML = `
          <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 24px; display: flex; flex-direction: column; justify-content: space-between; position: relative;">
            <div style="position: absolute; top: 20px; right: 20px; width: 80px; height: 80px; background: #16a34a; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; border: 4px solid #fef3c7; box-shadow: 0 10px 30px rgba(22,163,74,0.3);">
              <span style="font-size: 10px; font-weight: 600;">100%</span>
              <span style="font-size: 10px;">GUARANTEED</span>
            </div>
            <div>
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; margin-bottom: 16px;" onerror="this.outerHTML='<div style=\\'font-size:18px;font-weight:700;color:#166534;margin-bottom:16px\\'>${safeCompanyName}</div>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', serif; font-size: 28px; color: #166534; line-height: 1.1;" contenteditable="true">${safeHeadlineMain}</h1>
                <h2 style="font-size: 13px; color: #15803d; margin-top: 6px;" contenteditable="true">${safeHeadlineSub}</h2>
              </div>
            </div>
            <div class="${lc('services')}" ondblclick="toggleLock('services')" style="background: white; padding: 16px; border-radius: 12px; border-left: 4px solid #16a34a;">
              ${services.slice(0, 3).map(s => `<p style="font-size: 11px; color: #166534; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="color: #16a34a; font-size: 14px;">âœ“</span><span contenteditable="true">${s}</span></p>`).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; margin-bottom: 8px;">
                  <span style="font-size: 32px; font-weight: 800; color: #166534;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 12px; color: #15803d; margin-left: 4px;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: #16a34a; color: white; padding: 12px 24px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
              </div>
              <div style="text-align: right; font-size: 12px; color: #166534;">
                <p style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</p>
                <p contenteditable="true">${safeWebsite}</p>
              </div>
            </div>
          </div>
        `;

      // ========== SHAPES & GEOMETRIC LAYOUTS ==========
      } else if (layout === 'hexGrid') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(135deg, ${safePrimary}dd 0%, ${safeSecondary}cc 100%);"></div>
            <!-- Hexagon Pattern Overlay -->
            <svg style="position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0.1;" viewBox="0 0 100 100" preserveAspectRatio="none">
              <pattern id="hexPattern" width="20" height="17.32" patternUnits="userSpaceOnUse"><polygon points="10,0 20,5 20,15 10,20 0,15 0,5" fill="none" stroke="white" stroke-width="0.5"/></pattern>
              <rect width="100%" height="100%" fill="url(#hexPattern)"/>
            </svg>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:800;font-size:16px\\'>${safeCompanyName}</span>'">
                <!-- Hexagon Discount Badge -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; width: 110px; height: 100px; background: white; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                  <span style="font-size: 22px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 10px; font-weight: 600; color: ${safeSecondary}; text-align: center;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 800; color: white; line-height: 1.15;" contenteditable="true">${safeHeadlineMain}</h1>
                <p style="color: rgba(255,255,255,0.9); font-size: 12px; margin-top: 6px;" contenteditable="true">${safeHeadlineSub}</p>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; gap: 8px; flex-wrap: wrap;">
                ${services.slice(0, 4).map(s => `<span style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; font-size: 9px; padding: 6px 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3);" contenteditable="true">${s}</span>`).join('')}
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 12px 24px; font-weight: 700; font-size: 12px; clip-path: polygon(8% 0%, 100% 0%, 92% 100%, 0% 100%);" contenteditable="true">${safeCta}</div>
                <span style="color: white; font-weight: 700;" contenteditable="true">${safePhoneDisplay}</span>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'diamondCut') {
        frontHTML = `
          <div style="width: 100%; height: 100%; background: white; position: relative; overflow: hidden;">
            <!-- Diamond shaped image container -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; top: 50%; left: -10%; width: 70%; height: 140%; transform: translateY(-50%) rotate(45deg); background: url('${safePoolImage}') center/cover; box-shadow: 20px 20px 60px rgba(0,0,0,0.2);"></div>
            <div style="position: absolute; top: 50%; left: -10%; width: 70%; height: 140%; transform: translateY(-50%) rotate(45deg); background: ${safePrimary}40;"></div>
            <!-- Content on right -->
            <div style="position: absolute; right: 0; top: 0; bottom: 0; width: 50%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</div>'">
              <div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 24px; color: #1e293b; line-height: 1.15;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <!-- Diamond discount badge -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; margin-top: 12px; width: 80px; height: 80px; background: ${safePrimary}; transform: rotate(45deg); display: flex; align-items: center; justify-content: center; box-shadow: 5px 5px 20px ${safePrimary}40;">
                  <div style="transform: rotate(-45deg); text-align: center; color: white;">
                    <div style="font-size: 20px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</div>
                    <div style="font-size: 9px;" contenteditable="true">${safeDiscountText}</div>
                  </div>
                </div>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 4).map(s => `<p style="font-size: 10px; color: #475569; margin-bottom: 4px;"><span style="color: ${safePrimary};">â—†</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 12px 20px; font-weight: 700; font-size: 12px; text-align: center;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      } else if (layout === 'circleFrame') {
        frontHTML = `
          <div style="width: 100%; height: 100%; background: linear-gradient(135deg, ${safePrimary}10, ${safeSecondary}10); position: relative; overflow: hidden; padding: 20px;">
            <!-- Large circle with image -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; left: -20%; top: 50%; transform: translateY(-50%); width: 320px; height: 320px; border-radius: 50%; background: url('${safePoolImage}') center/cover; border: 8px solid white; box-shadow: 0 20px 60px rgba(0,0,0,0.2);"></div>
            <div style="position: absolute; left: -20%; top: 50%; transform: translateY(-50%); width: 320px; height: 320px; border-radius: 50%; background: linear-gradient(135deg, transparent 50%, ${safePrimary}20 100%);"></div>
            <!-- Content -->
            <div style="margin-left: 45%; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize * 0.9}px;" onerror="this.outerHTML='<span style=\\'font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</span>'">
                <!-- Circle discount -->
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; width: 85px; height: 85px; background: ${safePrimary}; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 8px 25px ${safePrimary}50;">
                  <span style="font-size: 18px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 22px; color: #1e293b; line-height: 1.2;" contenteditable="true">${safeHeadlineMain}</h1>
                <p style="font-size: 11px; color: ${safePrimary}; margin-top: 4px;" contenteditable="true">${safeHeadlineSub}</p>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                ${services.slice(0, 4).map(s => `<span style="font-size: 9px; color: #475569;"><span style="display: inline-block; width: 6px; height: 6px; background: ${safePrimary}; border-radius: 50%; margin-right: 4px;"></span><span contenteditable="true">${s}</span></span>`).join('')}
              </div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 10px 20px; border-radius: 25px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
                <span style="font-size: 12px; font-weight: 700; color: #1e293b;" contenteditable="true">${safePhoneDisplay}</span>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'triangleSlice') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <!-- Triangle overlay -->
            <div style="position: absolute; inset: 0; background: linear-gradient(135deg, white 45%, transparent 45%);"></div>
            <!-- Content in white triangle area -->
            <div style="position: relative; z-index: 1; padding: 24px; width: 55%; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; margin-bottom: 12px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary};margin-bottom:12px\\'>${safeCompanyName}</div>'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 22px; color: #1e293b; line-height: 1.15;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 3).map(s => `<p style="font-size: 10px; color: #475569; margin-bottom: 4px;"><span style="color: ${safePrimary};">â–¶</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 10px 20px; font-weight: 700; font-size: 11px; display: inline-block;" contenteditable="true">${safeCta}</div>
            </div>
            <!-- Discount badge on image side -->
            <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; bottom: 30px; right: 30px; width: 0; height: 0; border-left: 50px solid transparent; border-right: 50px solid transparent; border-bottom: 86px solid white;">
              <div style="position: absolute; top: 25px; left: -30px; text-align: center; width: 60px;">
                <div style="font-size: 18px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</div>
                <div style="font-size: 9px; color: ${safeSecondary};" contenteditable="true">${safeDiscountText}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'chevronStack') {
        frontHTML = `
          <div style="width: 100%; height: 100%; background: white; position: relative; overflow: hidden;">
            <!-- Stacked chevrons background -->
            <div style="position: absolute; right: 0; top: 0; bottom: 0; width: 55%;">
              <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; clip-path: polygon(20% 0%, 100% 0%, 100% 100%, 20% 100%, 0% 50%);"></div>
            </div>
            <!-- Chevron accents -->
            <div style="position: absolute; left: 42%; top: 0; bottom: 0; width: 30px; background: ${safePrimary}; clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%, 50% 50%); opacity: 0.8;"></div>
            <div style="position: absolute; left: 44%; top: 0; bottom: 0; width: 20px; background: ${safeAccent}; clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%, 50% 50%); opacity: 0.6;"></div>
            <!-- Content -->
            <div style="position: relative; z-index: 1; width: 45%; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; margin-bottom: 16px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary};margin-bottom:16px\\'>${safeCompanyName}</div>'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 24px; color: #1e293b; line-height: 1.15;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: ${safePrimary}; color: white; padding: 16px 20px; clip-path: polygon(0% 0%, 90% 0%, 100% 50%, 90% 100%, 0% 100%);">
                <span style="font-size: 24px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 10px; margin-left: 6px;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 4).map(s => `<p style="font-size: 10px; color: #475569; margin-bottom: 4px; padding-left: 12px; border-left: 3px solid ${safePrimary};"><span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: #1e293b; color: white; padding: 12px 20px; font-weight: 700; font-size: 12px; text-align: center;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;

      // ========== DYNAMIC CUTS LAYOUTS ==========
      } else if (layout === 'slashDivide') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <!-- Diagonal slash -->
            <div style="position: absolute; inset: 0; background: linear-gradient(155deg, white 48%, transparent 48%, transparent 52%, white 52%);"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(155deg, white 45%, transparent 45%);"></div>
            <!-- Content in white area -->
            <div style="position: relative; z-index: 1; padding: 24px; width: 50%; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; margin-bottom: 12px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary};margin-bottom:12px\\'>${safeCompanyName}</div>'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 22px; color: #1e293b; line-height: 1.15;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="background: ${safePrimary}10; padding: 12px; border-radius: 8px;">
                ${services.slice(0, 3).map(s => `<p style="font-size: 9px; color: #475569; margin-bottom: 3px;"><span style="color: ${safePrimary};">âœ“</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 10px 20px; font-weight: 700; font-size: 11px; transform: skewX(-5deg);" contenteditable="true">${safeCta}</div>
            </div>
            <!-- Discount on image side -->
            <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; bottom: 40px; right: 40px; background: white; padding: 16px 20px; transform: skewX(-5deg); box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
              <div style="transform: skewX(5deg); text-align: center;">
                <div style="font-size: 26px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</div>
                <div style="font-size: 9px; color: ${safeSecondary};" contenteditable="true">${safeDiscountText}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'curveSweep') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: white;">
            <!-- Curved image section -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; right: 0; top: 0; bottom: 0; width: 60%; background: url('${safePoolImage}') center/cover;"></div>
            <!-- SVG curve mask -->
            <svg style="position: absolute; left: 35%; top: 0; height: 100%; width: 100px;" viewBox="0 0 100 400" preserveAspectRatio="none">
              <path d="M100,0 Q0,200 100,400 L0,400 L0,0 Z" fill="white"/>
            </svg>
            <!-- Content -->
            <div style="position: relative; z-index: 1; width: 45%; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; margin-bottom: 16px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary};margin-bottom:16px\\'>${safeCompanyName}</div>'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 24px; color: #1e293b; line-height: 1.2;" contenteditable="true">${safeHeadlineMain}</h1>
                  <p style="font-size: 11px; color: ${safePrimary}; margin-top: 6px;" contenteditable="true">${safeHeadlineSub}</p>
                </div>
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: ${safePrimary}; color: white; padding: 16px; border-radius: 0 30px 30px 0; margin-left: -24px; padding-left: 40px;">
                <span style="font-size: 28px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 11px; margin-left: 8px;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 4).map(s => `<p style="font-size: 10px; color: #475569; margin-bottom: 5px;"><span style="color: ${safePrimary};">â—</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: #1e293b; color: white; padding: 12px 24px; border-radius: 25px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
                <span style="font-size: 12px; font-weight: 700; color: ${safePrimary};" contenteditable="true">${safePhoneDisplay}</span>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'waveStack') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.4);"></div>
            <!-- Wave layers -->
            <svg style="position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;" viewBox="0 0 1440 320" preserveAspectRatio="none">
              <path fill="${safePrimary}" fill-opacity="0.3" d="M0,160L48,144C96,128,192,96,288,106.7C384,117,480,171,576,181.3C672,192,768,160,864,138.7C960,117,1056,107,1152,128C1248,149,1344,203,1392,229.3L1440,256L1440,320L0,320Z"/>
              <path fill="${safeSecondary}" fill-opacity="0.5" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,218.7C672,235,768,245,864,234.7C960,224,1056,192,1152,181.3C1248,171,1344,181,1392,186.7L1440,192L1440,320L0,320Z"/>
              <path fill="white" d="M0,288L48,277.3C96,267,192,245,288,234.7C384,224,480,224,576,229.3C672,235,768,245,864,250.7C960,256,1056,256,1152,245.3C1248,235,1344,213,1392,202.7L1440,192L1440,320L0,320Z"/>
            </svg>
            <!-- Top content -->
            <div style="position: relative; z-index: 1; padding: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 12px 16px; border-radius: 8px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                  <div style="font-size: 22px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 10px; color: ${safeSecondary};" contenteditable="true">${safeDiscountText}</div>
                </div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="margin-top: 16px;">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 26px; font-weight: 800; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.3);" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
            </div>
            <!-- Bottom content on white wave -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; z-index: 2;">
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div class="${lc('services')}" ondblclick="toggleLock('services')">
                  ${services.slice(0, 3).map(s => `<span style="display: inline-block; font-size: 9px; color: #475569; margin-right: 12px;"><span style="color: ${safePrimary};">âœ“</span> <span contenteditable="true">${s}</span></span>`).join('')}
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 10px 20px; border-radius: 6px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;

      // ========== PREMIUM LUXURY LAYOUTS ==========
      } else if (layout === 'goldAccent') {
        frontHTML = `
          <div style="width: 100%; height: 100%; background: #1a1a2e; position: relative; overflow: hidden;">
            <!-- Gold accent lines -->
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, transparent, #d4af37, transparent);"></div>
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, transparent, #d4af37, transparent);"></div>
            <div style="position: absolute; left: 20px; top: 20px; bottom: 20px; width: 2px; background: linear-gradient(180deg, transparent, #d4af37, transparent);"></div>
            <!-- Pool image with gold border -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; right: 20px; top: 30px; bottom: 30px; width: 45%; background: url('${safePoolImage}') center/cover; border: 3px solid #d4af37;"></div>
            <!-- Content -->
            <div style="position: relative; z-index: 1; width: 50%; height: 100%; padding: 40px 30px 40px 40px; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<div style=\\'font-size:18px;font-weight:700;color:#d4af37;\\'>${safeCompanyName}</div>'">
                <div style="width: 60px; height: 2px; background: #d4af37; margin: 16px 0;"></div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', serif; font-size: 26px; color: white; line-height: 1.2;" contenteditable="true">${safeHeadlineMain}</h1>
                  <p style="color: #d4af37; font-size: 11px; margin-top: 8px; font-style: italic;" contenteditable="true">${safeHeadlineSub}</p>
                </div>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 4).map(s => `<p style="font-size: 10px; color: rgba(255,255,255,0.8); margin-bottom: 6px;"><span style="color: #d4af37;">â˜…</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; display: inline-block; margin-bottom: 12px;">
                  <span style="font-size: 32px; font-weight: 300; color: #d4af37;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 11px; color: rgba(255,255,255,0.7); margin-left: 8px;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: transparent; border: 2px solid #d4af37; color: #d4af37; padding: 12px 24px; font-weight: 600; font-size: 11px; letter-spacing: 2px; text-transform: uppercase;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'blackGold') {
        frontHTML = `
          <div style="width: 100%; height: 100%; background: #0a0a0a; position: relative; overflow: hidden;">
            <!-- Diagonal gold stripe -->
            <div style="position: absolute; top: -50%; left: 60%; width: 200%; height: 200%; background: linear-gradient(135deg, transparent 48%, #d4af37 48%, #d4af37 52%, transparent 52%); opacity: 0.3;"></div>
            <!-- Corner accents -->
            <div style="position: absolute; top: 0; left: 0; width: 80px; height: 80px; border-top: 3px solid #d4af37; border-left: 3px solid #d4af37;"></div>
            <div style="position: absolute; bottom: 0; right: 0; width: 80px; height: 80px; border-bottom: 3px solid #d4af37; border-right: 3px solid #d4af37;"></div>
            <!-- Content -->
            <div style="position: relative; z-index: 1; height: 100%; padding: 30px; display: flex;">
              <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
                <div>
                  <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<div style=\\'font-size:18px;font-weight:700;color:#d4af37;\\'>${safeCompanyName}</div>'">
                  <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="margin-top: 20px;">
                    <h1 style="font-family: '${font}', serif; font-size: 28px; color: white; line-height: 1.15;" contenteditable="true">${safeHeadlineMain}</h1>
                  </div>
                </div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${services.slice(0, 4).map(s => `<span style="background: #d4af3720; border: 1px solid #d4af3740; color: rgba(255,255,255,0.9); font-size: 9px; padding: 5px 12px;" contenteditable="true">${s}</span>`).join('')}
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                  <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: #d4af37; color: #0a0a0a; padding: 12px 24px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
                  <span style="color: #d4af37; font-weight: 600;" contenteditable="true">${safePhoneDisplay}</span>
                </div>
              </div>
              <div style="width: 40%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 160px; height: 160px; border-radius: 50%; background: url('${safePoolImage}') center/cover; border: 4px solid #d4af37; box-shadow: 0 0 40px #d4af3740;"></div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; margin-top: -20px; background: #d4af37; color: #0a0a0a; padding: 10px 20px; text-align: center;">
                  <span style="font-size: 22px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
            </div>
          </div>
        `;

      // ========== TYPOGRAPHY BOLD LAYOUTS ==========
      } else if (layout === 'bigType') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(180deg, ${safePrimary}ee 0%, ${safePrimary}dd 100%);"></div>
            <!-- Giant background text -->
            <div style="position: absolute; top: -20px; left: -10px; font-size: 180px; font-weight: 900; color: rgba(255,255,255,0.08); font-family: '${font}', ${fontFallback}; line-height: 0.8; pointer-events: none;">POOL</div>
            <!-- Content -->
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; text-align: right;">
                  <div style="font-size: 38px; font-weight: 900; color: white; line-height: 1;" contenteditable="true">${safeDiscountAmount}</div>
                  <div style="font-size: 11px; color: rgba(255,255,255,0.9);" contenteditable="true">${safeDiscountText}</div>
                </div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 32px; font-weight: 900; color: white; line-height: 1; text-transform: uppercase;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; gap: 16px;">
                ${services.slice(0, 4).map(s => `<span style="color: rgba(255,255,255,0.9); font-size: 10px; font-weight: 600;" contenteditable="true">${s}</span>`).join('')}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 14px 28px; font-weight: 900; font-size: 14px; text-transform: uppercase;" contenteditable="true">${safeCta}</div>
                <span style="color: white; font-size: 14px; font-weight: 700;" contenteditable="true">${safePhoneDisplay}</span>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'outlineType') {
        frontHTML = `
          <div style="width: 100%; height: 100%; background: white; position: relative; overflow: hidden; padding: 24px;">
            <!-- Outline text background -->
            <div style="position: absolute; top: 30px; left: -20px; font-size: 100px; font-weight: 900; color: transparent; -webkit-text-stroke: 2px ${safePrimary}20; font-family: '${font}', ${fontFallback}; pointer-events: none;">SERVICE</div>
            <!-- Pool image -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; right: 20px; bottom: 20px; width: 200px; height: 200px; border-radius: 20px; background: url('${safePoolImage}') center/cover; box-shadow: 0 20px 50px rgba(0,0,0,0.15);"></div>
            <!-- Content -->
            <div style="position: relative; z-index: 1; width: 60%; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</div>'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="margin-top: 20px;">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 32px; font-weight: 900; color: transparent; -webkit-text-stroke: 2px ${safePrimary}; line-height: 1.1;" contenteditable="true">${safeHeadlineMain}</h1>
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 32px; font-weight: 900; color: ${safePrimary}; line-height: 1.1; margin-top: -5px;" contenteditable="true">${safeHeadlineSub}</h1>
                </div>
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative;">
                <span style="font-size: 38px; font-weight: 900; color: transparent; -webkit-text-stroke: 2px ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 14px; color: ${safeSecondary}; margin-left: 8px;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 3).map(s => `<p style="font-size: 11px; color: #475569; margin-bottom: 4px; border-left: 3px solid ${safePrimary}; padding-left: 10px;"><span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 12px 24px; font-weight: 700; font-size: 12px; display: inline-block;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;

      // ========== SEASONAL POOL LAYOUTS ==========
      } else if (layout === 'summerSplash') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <!-- Splash overlay -->
            <svg style="position: absolute; inset: 0; width: 100%; height: 100%;" viewBox="0 0 400 300" preserveAspectRatio="none">
              <defs>
                <linearGradient id="splashGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:${safePrimary};stop-opacity:0.9"/>
                  <stop offset="100%" style="stop-color:${safeSecondary};stop-opacity:0.8"/>
                </linearGradient>
              </defs>
              <path d="M0,0 Q100,50 80,150 Q60,250 0,300 L0,0" fill="url(#splashGrad)"/>
              <circle cx="180" cy="60" r="8" fill="white" opacity="0.3"/>
              <circle cx="160" cy="100" r="5" fill="white" opacity="0.2"/>
              <circle cx="200" cy="140" r="6" fill="white" opacity="0.25"/>
            </svg>
            <!-- Content -->
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="max-width: 50%;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="margin-top: 16px;">
                  <p style="font-size: 10px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px;">â˜€ Summer Special</p>
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 26px; font-weight: 800; color: white; line-height: 1.15;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
              </div>
              <div style="max-width: 50%;">
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-bottom: 12px;">
                  ${services.slice(0, 3).map(s => `<span style="display: inline-block; background: rgba(255,255,255,0.2); color: white; font-size: 9px; padding: 4px 10px; border-radius: 15px; margin-right: 6px; margin-bottom: 4px;" contenteditable="true">${s}</span>`).join('')}
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 12px 24px; border-radius: 25px; font-weight: 700; font-size: 12px; display: inline-block;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
            <!-- Discount splash -->
            <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 20px; right: 20px; width: 100px; height: 100px; background: white; border-radius: 50% 50% 50% 0; transform: rotate(-15deg); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
              <span style="font-size: 22px; font-weight: 900; color: ${safePrimary}; transform: rotate(15deg);" contenteditable="true">${safeDiscountAmount}</span>
              <span style="font-size: 10px; color: ${safeSecondary}; transform: rotate(15deg);" contenteditable="true">${safeDiscountText}</span>
            </div>
          </div>
        `;

      // ========== 3D & DEPTH LAYOUTS ==========
      } else if (layout === 'floatingCards') {
        frontHTML = `
          <div style="width: 100%; height: 100%; background: linear-gradient(135deg, ${safePrimary}15 0%, ${safeSecondary}15 100%); position: relative; overflow: hidden; padding: 20px;">
            <!-- Floating image card -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; right: 30px; top: 30px; width: 220px; height: 160px; background: url('${safePoolImage}') center/cover; border-radius: 12px; box-shadow: 0 25px 50px rgba(0,0,0,0.2), 0 10px 20px rgba(0,0,0,0.1); transform: perspective(1000px) rotateY(-5deg) rotateX(5deg);"></div>
            <!-- Floating discount card -->
            <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; right: 60px; bottom: 80px; background: ${safePrimary}; color: white; padding: 20px 24px; border-radius: 12px; box-shadow: 0 20px 40px ${safePrimary}40; transform: perspective(1000px) rotateY(-8deg) rotateX(3deg);">
              <div style="font-size: 28px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</div>
              <div style="font-size: 10px; opacity: 0.9;" contenteditable="true">${safeDiscountText}</div>
            </div>
            <!-- Content -->
            <div style="position: relative; z-index: 1; width: 50%; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:700;color:${safePrimary}\\'>${safeCompanyName}</div>'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="margin-top: 16px;">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 26px; color: #1e293b; line-height: 1.15;" contenteditable="true">${safeHeadlineMain}</h1>
                  <p style="color: ${safePrimary}; font-size: 11px; margin-top: 6px;" contenteditable="true">${safeHeadlineSub}</p>
                </div>
              </div>
              <!-- Services as floating pills -->
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; flex-direction: column; gap: 8px;">
                ${services.slice(0, 4).map((s, i) => `<div style="background: white; padding: 10px 16px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); font-size: 10px; color: #475569; transform: translateX(${i * 8}px);"><span style="color: ${safePrimary}; margin-right: 6px;">âœ“</span><span contenteditable="true">${s}</span></div>`).join('')}
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: #1e293b; color: white; padding: 14px 28px; border-radius: 8px; font-weight: 700; font-size: 12px; box-shadow: 0 10px 30px rgba(30,41,59,0.3); display: inline-block;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;

      // ========== PATTERN BASED LAYOUTS ==========
      } else if (layout === 'waterRipple') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <!-- Ripple pattern overlay -->
            <svg style="position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0.4;" viewBox="0 0 400 300">
              <defs>
                <pattern id="ripples" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
                  <circle cx="50" cy="50" r="10" fill="none" stroke="white" stroke-width="1" opacity="0.3"/>
                  <circle cx="50" cy="50" r="25" fill="none" stroke="white" stroke-width="0.5" opacity="0.2"/>
                  <circle cx="50" cy="50" r="40" fill="none" stroke="white" stroke-width="0.3" opacity="0.1"/>
                </pattern>
              </defs>
              <rect width="100%" height="100%" fill="url(#ripples)"/>
            </svg>
            <div style="position: absolute; inset: 0; background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.6) 100%);"></div>
            <!-- Content -->
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
                <div class="${lc('urgency')}" ondblclick="toggleLock('urgency')" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; font-size: 9px; font-weight: 600; padding: 6px 12px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.3);" contenteditable="true">${safeUrgency}</div>
              </div>
              <div style="text-align: center;">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 32px; font-weight: 800; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.3);" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; display: inline-block; margin-top: 16px; background: white; padding: 16px 32px; border-radius: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                  <span style="font-size: 28px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 12px; color: ${safeSecondary}; margin-left: 8px;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div class="${lc('services')}" ondblclick="toggleLock('services')">
                  ${services.slice(0, 3).map(s => `<span style="display: inline-block; color: rgba(255,255,255,0.9); font-size: 10px; margin-right: 15px;"><span contenteditable="true">${s}</span></span>`).join('')}
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 12px 24px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;

      // ========== UNIQUE CONCEPTS LAYOUTS ==========
      } else if (layout === 'beforeAfter') {
        frontHTML = `
          <div style="width: 100%; height: 100%; display: flex; position: relative; overflow: hidden;">
            <!-- Before side -->
            <div style="width: 50%; background: #78716c; position: relative; overflow: hidden;">
              <div style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; filter: grayscale(100%) brightness(0.7);"></div>
              <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.4);"></div>
              <div style="position: absolute; top: 20px; left: 20px; background: #ef4444; color: white; padding: 6px 12px; font-size: 10px; font-weight: 700; text-transform: uppercase;">Before</div>
              <div style="position: absolute; bottom: 20px; left: 20px; right: 10px;">
                <p style="color: rgba(255,255,255,0.8); font-size: 10px;">Dirty â€¢ Neglected â€¢ Unsafe</p>
              </div>
            </div>
            <!-- Diagonal divider -->
            <div style="position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: white; transform: skewX(-5deg); z-index: 10;"></div>
            <!-- After side -->
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 50%; background: url('${safePoolImage}') center/cover; position: relative;">
              <div style="position: absolute; inset: 0; background: linear-gradient(180deg, transparent 50%, ${safePrimary}cc 100%);"></div>
              <div style="position: absolute; top: 20px; right: 20px; background: #22c55e; color: white; padding: 6px 12px; font-size: 10px; font-weight: 700; text-transform: uppercase;">After</div>
              <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; color: white;">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 20px; font-weight: 800; margin-bottom: 8px;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                  ${services.slice(0, 3).map(s => `<span style="font-size: 10px; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px;" contenteditable="true">${s}</span>`).join('')}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative;">
                    <span style="font-size: 24px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</span>
                    <span style="font-size: 9px; margin-left: 4px;" contenteditable="true">${safeDiscountText}</span>
                  </div>
                  <span style="font-weight: 700;" contenteditable="true">${safePhoneDisplay}</span>
                </div>
              </div>
            </div>
            <!-- Logo centered -->
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 10px 16px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 20;">
              <img src="${safeLogoUrl}" style="height: ${logoSize * 0.8}px;" onerror="this.outerHTML='<span style=\\'font-weight:700;color:${safePrimary};font-size:12px\\'>${safeCompanyName}</span>'">
            </div>
          </div>
        `;
      } else if (layout === 'infographic') {
        frontHTML = `
          <div style="width: 100%; height: 100%; background: white; padding: 20px; display: flex; gap: 20px;">
            <!-- Left: Image + Discount -->
            <div style="width: 40%; position: relative;">
              <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="width: 100%; height: 70%; background: url('${safePoolImage}') center/cover; border-radius: 12px;"></div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); background: ${safePrimary}; color: white; padding: 16px 24px; border-radius: 12px; text-align: center; box-shadow: 0 -10px 30px ${safePrimary}30;">
                <div style="font-size: 28px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</div>
                <div style="font-size: 9px; opacity: 0.9;" contenteditable="true">${safeDiscountText}</div>
              </div>
            </div>
            <!-- Right: Infographic content -->
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize * 0.8}px; margin-bottom: 10px;" onerror="this.outerHTML='<div style=\\'font-size:14px;font-weight:700;color:${safePrimary};margin-bottom:10px\\'>${safeCompanyName}</div>'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 20px; color: #1e293b; line-height: 1.2;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
              </div>
              <!-- Stats/Services as infographic -->
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                ${services.slice(0, 4).map((s, i) => `
                  <div style="background: ${safePrimary}${10 + i * 5}; padding: 12px; border-radius: 8px; border-left: 4px solid ${safePrimary};">
                    <div style="font-size: 20px; font-weight: 800; color: ${safePrimary};">${['01', '02', '03', '04'][i]}</div>
                    <div style="font-size: 9px; color: #475569; margin-top: 4px;" contenteditable="true">${s}</div>
                  </div>
                `).join('')}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 12px 24px; border-radius: 6px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
                <div style="text-align: right;">
                  <div style="font-size: 14px; font-weight: 800; color: #1e293b;" contenteditable="true">${safePhone}</div>
                  <div style="font-size: 10px; color: ${safePrimary};" contenteditable="true">${safeWebsite}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'badgeHeavy') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(135deg, ${safePrimary}dd 0%, ${safeSecondary}cc 100%);"></div>
            <!-- Badge cluster -->
            <div style="position: absolute; top: 15px; right: 15px; display: flex; flex-wrap: wrap; gap: 8px; max-width: 180px; justify-content: flex-end;">
              <div style="background: white; color: ${safePrimary}; padding: 8px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; display: flex; align-items: center; gap: 4px;"><span>â­</span> 5-Star Rated</div>
              <div style="background: #22c55e; color: white; padding: 8px 12px; border-radius: 20px; font-size: 10px; font-weight: 700;">Licensed & Insured</div>
              <div style="background: #f59e0b; color: white; padding: 8px 12px; border-radius: 20px; font-size: 10px; font-weight: 700;">10+ Years</div>
            </div>
            <!-- Content -->
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="margin-top: 40px;">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 800; color: white; line-height: 1.15;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
              </div>
              <!-- Large discount badge -->
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; width: 120px; height: 120px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 15px 40px rgba(0,0,0,0.3);">
                <span style="font-size: 32px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 9px; color: ${safeSecondary}; text-align: center;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div class="${lc('services')}" ondblclick="toggleLock('services')">
                  ${services.slice(0, 3).map(s => `<div style="display: inline-block; background: rgba(255,255,255,0.15); backdrop-filter: blur(5px); color: white; font-size: 9px; padding: 6px 12px; border-radius: 4px; margin-right: 6px; margin-bottom: 6px;" contenteditable="true">${s}</div>`).join('')}
                </div>
                <div style="text-align: right;">
                  <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 12px 24px; border-radius: 6px; font-weight: 700; font-size: 12px; margin-bottom: 8px;" contenteditable="true">${safeCta}</div>
                  <span style="color: white; font-weight: 600;" contenteditable="true">${safePhoneDisplay}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      // ==================== SHAPES & GEOMETRIC (NEW 8) ====================
      } else if (layout === 'pentagonPop') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(to right, ${safePrimary}ee 0%, transparent 60%);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 800; color: white; max-width: 60%;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; width: 120px; height: 115px; background: white; clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <span style="font-size: 22px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 10px; color: ${safeSecondary}; text-align: center; max-width: 70px;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; flex-wrap: wrap; gap: 6px;">
                  ${services.slice(0, 3).map(s => `<span style="background: rgba(255,255,255,0.2); color: white; font-size: 9px; padding: 6px 10px; border-radius: 4px;" contenteditable="true">${s}</span>`).join('')}
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 12px 20px; border-radius: 6px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'starBurst') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(135deg, ${safePrimary} 0%, ${safeSecondary} 100%);">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; right: 0; top: 0; width: 55%; height: 100%; background: url('${safePoolImage}') center/cover; clip-path: polygon(20% 0, 100% 0, 100% 100%, 0% 100%);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div>
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="margin-top: 20px;">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 26px; font-weight: 800; color: white; max-width: 55%;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 20px; right: 20px; width: 110px; height: 110px; background: #fbbf24; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <span style="font-size: 18px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 9px; color: ${safePrimary}; text-align: center; max-width: 50px;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-bottom: 12px;">
                  ${services.slice(0, 3).map(s => `<span style="display: inline-block; background: white; color: ${safePrimary}; font-size: 9px; padding: 6px 10px; border-radius: 4px; margin-right: 6px;" contenteditable="true">${s}</span>`).join('')}
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; display: inline-block; background: white; color: ${safePrimary}; padding: 12px 24px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'arrowPoint') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; left: 0; top: 0; width: 55%; height: 100%; background: ${safePrimary}; clip-path: polygon(0 0, 85% 0, 100% 50%, 85% 100%, 0 100%);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 24px; font-weight: 800; color: white; max-width: 50%;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="max-width: 45%;">
                ${services.slice(0, 3).map(s => `<p style="font-size: 10px; color: white; margin-bottom: 4px;"><span style="color: white; opacity: 0.7;">â†’</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 50%; right: 15%; transform: translateY(-50%); background: white; width: 100px; height: 100px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <span style="font-size: 24px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 10px; color: ${safeSecondary}; text-align: center;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; display: inline-block; max-width: fit-content; background: white; color: ${safePrimary}; padding: 12px 20px; border-radius: 6px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      } else if (layout === 'shieldBadge') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.5);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
              <div data-movable="true" style="position: relative; width: 220px; height: 260px; background: linear-gradient(180deg, ${safePrimary} 0%, ${safeSecondary} 100%); clip-path: polygon(50% 0%, 100% 12%, 100% 75%, 50% 100%, 0% 75%, 0% 12%); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px 20px;">
                <img src="${safeLogoUrl}" style="height: 35px; filter: brightness(0) invert(1); margin-bottom: 8px;" onerror="this.style.display='none'">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 14px; font-weight: 800; color: white; margin-bottom: 6px; line-height: 1.2;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="margin-top: 5px;">
                  <span style="font-size: 22px; font-weight: 900; color: white; display: block;" contenteditable="true">${safeDiscountAmount}</span>
                  <div style="font-size: 9px; color: rgba(255,255,255,0.9); margin-top: 2px;" contenteditable="true">${safeDiscountText}</div>
                </div>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; margin-top: 15px; background: white; color: ${safePrimary}; padding: 12px 30px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      } else if (layout === 'ribbonBanner') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 0%, ${safePrimary}dd 100%);"></div>
            <!-- Ribbon Banner -->
            <div style="position: absolute; top: 30px; left: -40px; width: 200px; background: ${safeSecondary}; transform: rotate(-45deg); padding: 8px 40px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
              <span class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="font-size: 12px; font-weight: 700; color: white;" contenteditable="true">${safeDiscountAmount}</span>
            </div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: flex-end;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1); margin-bottom: 15px;" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 800; color: white; margin-bottom: 15px;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                ${services.slice(0, 4).map(s => `<span style="background: rgba(255,255,255,0.2); color: white; font-size: 9px; padding: 6px 12px; border-radius: 20px;" contenteditable="true">${s}</span>`).join('')}
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; display: inline-block; max-width: fit-content; background: white; color: ${safePrimary}; padding: 12px 24px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      } else if (layout === 'cornerFold') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: white;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <!-- Folded Corner Effect -->
            <div style="position: absolute; top: 0; right: 0; width: 80px; height: 80px; background: linear-gradient(135deg, transparent 50%, ${safePrimary} 50%);"></div>
            <div style="position: absolute; top: 0; right: 0; width: 80px; height: 80px; background: linear-gradient(315deg, ${safeSecondary} 50%, transparent 50%); transform: translate(40px, -40px);"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(to right, ${safePrimary}ee 0%, ${safePrimary}99 40%, transparent 70%);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 26px; font-weight: 800; color: white; max-width: 60%;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; display: inline-block; margin-top: 15px; background: white; padding: 15px 25px; border-radius: 8px;">
                  <span style="font-size: 28px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 10px; color: ${safeSecondary}; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div class="${lc('services')}" ondblclick="toggleLock('services')">
                  ${services.slice(0, 3).map(s => `<p style="font-size: 10px; color: white; margin-bottom: 4px;"><span style="opacity: 0.7;">âœ“</span> <span contenteditable="true">${s}</span></p>`).join('')}
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 12px 20px; border-radius: 6px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'stepLadder') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: ${safePrimary};">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; right: 0; top: 0; width: 50%; height: 100%; background: url('${safePoolImage}') center/cover;"></div>
            <!-- Step Ladder Effect -->
            <div style="position: absolute; left: 48%; top: 0; height: 33%; width: 10%; background: ${safePrimary};"></div>
            <div style="position: absolute; left: 45%; top: 33%; height: 34%; width: 13%; background: ${safePrimary};"></div>
            <div style="position: absolute; left: 42%; top: 67%; height: 33%; width: 16%; background: ${safePrimary};"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; max-width: 50%;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 24px; font-weight: 800; color: white;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 4).map((s, i) => `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;"><span style="background: white; color: ${safePrimary}; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700;">${i+1}</span><span style="font-size: 10px; color: white;" contenteditable="true">${s}</span></div>`).join('')}
              </div>
              <div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; display: inline-block; background: white; padding: 10px 15px; border-radius: 6px; margin-bottom: 10px;">
                  <span style="font-size: 20px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: ${safeSecondary};" contenteditable="true"> ${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; display: block; background: ${safeSecondary}; color: white; padding: 12px 20px; border-radius: 6px; font-weight: 700; font-size: 11px; text-align: center;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'pyramidStack') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(to top, ${safePrimary}ee 0%, ${safePrimary}88 50%, transparent 100%);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; text-align: center;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1); margin-bottom: 15px;" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 26px; font-weight: 800; color: white; margin-bottom: 10px;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <!-- Pyramid of services -->
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; flex-direction: column; align-items: center; gap: 6px; margin-bottom: 15px;">
                <span style="background: white; color: ${safePrimary}; font-size: 9px; padding: 6px 15px; border-radius: 4px;" contenteditable="true">${services[0] || 'Service'}</span>
                <div style="display: flex; gap: 6px;">
                  <span style="background: white; color: ${safePrimary}; font-size: 9px; padding: 6px 12px; border-radius: 4px;" contenteditable="true">${services[1] || 'Service'}</span>
                  <span style="background: white; color: ${safePrimary}; font-size: 9px; padding: 6px 12px; border-radius: 4px;" contenteditable="true">${services[2] || 'Service'}</span>
                </div>
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: absolute; top: 15px; right: 15px; background: white; width: 110px; height: 100px; clip-path: polygon(50% 0%, 100% 100%, 0% 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 30px;">
                <span style="font-size: 18px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 9px; color: ${safeSecondary};" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 12px 30px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      // ==================== DYNAMIC CUTS (NEW 8) ====================
      } else if (layout === 'spiralCut') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: ${safePrimary};">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; right: -10%; top: -10%; width: 70%; height: 120%; background: url('${safePoolImage}') center/cover; border-radius: 50%; border: 8px solid white;"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="max-width: 50%;">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 24px; font-weight: 800; color: white;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="max-width: 45%;">
                ${services.slice(0, 3).map(s => `<p style="font-size: 10px; color: rgba(255,255,255,0.9); margin-bottom: 4px;"><span style="color: white;">â€¢</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 12px 18px; border-radius: 8px;">
                  <span style="font-size: 22px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: ${safeSecondary}; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safeSecondary}; color: white; padding: 12px 20px; border-radius: 6px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'thunderBolt') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(135deg, ${safePrimary}ee 0%, transparent 60%);"></div>
            <!-- Thunder bolt divider -->
            <svg style="position: absolute; left: 45%; top: 0; height: 100%; width: 100px;" viewBox="0 0 100 300" preserveAspectRatio="none">
              <polygon points="50,0 80,100 50,100 80,200 50,200 100,300 0,300 30,200 0,200 30,100 0,100" fill="${safePrimary}"/>
            </svg>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; max-width: 50%;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 24px; font-weight: 800; color: white;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: #fbbf24; padding: 15px 20px; clip-path: polygon(10% 0%, 100% 0%, 90% 100%, 0% 100%); text-align: center;">
                <span style="font-size: 26px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 10px; color: ${safePrimary}; display: block;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 12px 20px; border-radius: 6px; font-weight: 700; font-size: 11px; text-align: center;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      } else if (layout === 'heartCurve') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(135deg, ${safePrimary} 0%, ${safeSecondary} 100%);">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; right: 10%; top: 50%; transform: translateY(-50%); width: 45%; height: 75%; background: url('${safePoolImage}') center/cover; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; max-width: 55%;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 24px; font-weight: 800; color: white; margin-bottom: 10px;" contenteditable="true">${safeHeadlineMain}</h1>
                  <h2 style="font-size: 12px; color: rgba(255,255,255,0.9);" contenteditable="true">${safeHeadlineSub}</h2>
                </div>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 3).map(s => `<span style="display: inline-block; background: rgba(255,255,255,0.2); color: white; font-size: 9px; padding: 6px 10px; border-radius: 20px; margin-right: 6px; margin-bottom: 6px;" contenteditable="true">${s}</span>`).join('')}
              </div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 12px 18px; border-radius: 8px;">
                  <span style="font-size: 22px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: ${safeSecondary}; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 12px 20px; border-radius: 25px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'splashZone') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: radial-gradient(ellipse at bottom left, ${safePrimary}ee 0%, transparent 70%);"></div>
            <!-- Splash drops -->
            <div style="position: absolute; top: 20%; right: 20%; width: 30px; height: 30px; background: ${safeSecondary}; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; transform: rotate(-20deg); opacity: 0.8;"></div>
            <div style="position: absolute; top: 35%; right: 30%; width: 20px; height: 20px; background: ${safePrimary}; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; transform: rotate(10deg); opacity: 0.6;"></div>
            <div style="position: absolute; top: 15%; right: 35%; width: 15px; height: 15px; background: white; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; transform: rotate(-30deg); opacity: 0.7;"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="max-width: 60%;">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 800; color: white;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="max-width: 55%;">
                ${services.slice(0, 3).map(s => `<p style="font-size: 10px; color: white; margin-bottom: 4px;"><span style="color: ${safeSecondary};">ðŸ’§</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 15px 20px; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;">
                  <span style="font-size: 24px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: ${safeSecondary}; display: block; text-align: center;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safeSecondary}; color: white; padding: 12px 24px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'fireEdge') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 60%; background: linear-gradient(to top, #dc2626 0%, #f97316 30%, #fbbf24 60%, transparent 100%); opacity: 0.85;"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<span style=\\'font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 12px 18px; border-radius: 8px; text-align: center;">
                  <span style="font-size: 24px; font-weight: 900; color: #dc2626;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: #f97316; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div style="margin-top: auto;">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 900; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-top: 10px; margin-bottom: 15px;">
                  ${services.slice(0, 3).map(s => `<span style="display: inline-block; background: rgba(255,255,255,0.9); color: #dc2626; font-size: 9px; padding: 6px 10px; border-radius: 4px; margin-right: 6px;" contenteditable="true">ðŸ”¥ ${s}</span>`).join('')}
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; display: inline-block; background: white; color: #dc2626; padding: 14px 28px; border-radius: 6px; font-weight: 800; font-size: 13px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'iceShards') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; opacity: 0.3;"></div>
            <!-- Ice shard shapes -->
            <div style="position: absolute; top: -20px; right: 10%; width: 80px; height: 150px; background: rgba(255,255,255,0.3); clip-path: polygon(50% 0%, 100% 100%, 0% 100%); transform: rotate(15deg);"></div>
            <div style="position: absolute; top: 20%; right: 25%; width: 50px; height: 100px; background: rgba(255,255,255,0.2); clip-path: polygon(50% 0%, 100% 100%, 0% 100%); transform: rotate(-10deg);"></div>
            <div style="position: absolute; bottom: -10px; right: 5%; width: 60px; height: 120px; background: rgba(255,255,255,0.25); clip-path: polygon(50% 0%, 100% 100%, 0% 100%); transform: rotate(5deg);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="max-width: 65%;">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 26px; font-weight: 800; color: white;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="max-width: 60%;">
                ${services.slice(0, 3).map(s => `<p style="font-size: 10px; color: white; margin-bottom: 4px;"><span style="color: #bae6fd;">â„</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 20px 25px; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); text-align: center; min-width: 100px;">
                  <span style="font-size: 22px; font-weight: 900; color: #0284c7;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 10px; color: #0ea5e9; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: #0284c7; padding: 12px 24px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'cloudFloat') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(to bottom, #7dd3fc 0%, #38bdf8 50%, #0ea5e9 100%);">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; bottom: 0; left: 0; right: 0; height: 50%; background: url('${safePoolImage}') center/cover;"></div>
            <!-- Cloud shapes -->
            <div style="position: absolute; top: 15%; left: 5%; width: 120px; height: 40px; background: white; border-radius: 40px; opacity: 0.9;"></div>
            <div style="position: absolute; top: 10%; left: 8%; width: 50px; height: 50px; background: white; border-radius: 50%; opacity: 0.9;"></div>
            <div style="position: absolute; top: 8%; left: 2%; width: 40px; height: 40px; background: white; border-radius: 50%; opacity: 0.9;"></div>
            <div style="position: absolute; top: 25%; right: 10%; width: 100px; height: 35px; background: white; border-radius: 35px; opacity: 0.8;"></div>
            <div style="position: absolute; top: 20%; right: 12%; width: 45px; height: 45px; background: white; border-radius: 50%; opacity: 0.8;"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<span style=\\'font-weight:700;font-size:16px;color:#0369a1\\'>${safeCompanyName}</span>'">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 12px 18px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                  <span style="font-size: 22px; font-weight: 900; color: #0369a1;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: #0ea5e9; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div style="text-align: center;">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 800; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.2);" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
              </div>
              <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px;">
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 12px;">
                  ${services.slice(0, 3).map(s => `<span style="font-size: 9px; color: #0369a1;" contenteditable="true">â˜ ${s}</span>`).join('')}
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: #0ea5e9; color: white; padding: 12px 24px; border-radius: 25px; font-weight: 700; font-size: 12px; text-align: center;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'sunRays') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; opacity: 0.4;"></div>
            <!-- Sun rays -->
            <div style="position: absolute; top: -50%; left: 50%; transform: translateX(-50%); width: 200%; height: 200%;">
              ${[0, 30, 60, 90, 120, 150].map(deg => `<div style="position: absolute; top: 50%; left: 50%; width: 10px; height: 150%; background: rgba(255,255,255,0.15); transform: translate(-50%, -50%) rotate(${deg}deg);"></div>`).join('')}
            </div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 900; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; margin-top: 15px; background: white; width: 100px; height: 100px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 30px rgba(255,255,255,0.5);">
                  <span style="font-size: 26px; font-weight: 900; color: #f97316;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 10px; color: #ea580c;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-bottom: 12px;">
                  ${services.slice(0, 3).map(s => `<span style="display: inline-block; background: rgba(255,255,255,0.3); color: white; font-size: 9px; padding: 6px 12px; border-radius: 20px; margin: 0 4px;" contenteditable="true">${s}</span>`).join('')}
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: #f97316; padding: 14px 30px; border-radius: 30px; font-weight: 700; font-size: 13px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      // ==================== PREMIUM LUXURY (NEW 8) ====================
      } else if (layout === 'diamondLux') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(135deg, #1e1e1e 0%, #3d3d3d 100%);">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; opacity: 0.3;"></div>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg); width: 200px; height: 200px; border: 3px solid rgba(255,255,255,0.3);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', serif; font-size: 26px; font-weight: 300; color: white; letter-spacing: 3px; text-transform: uppercase;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; margin-top: 20px; padding: 20px 30px; border: 2px solid rgba(255,255,255,0.5); display: inline-block;">
                  <span style="font-size: 32px; font-weight: 300; color: white; letter-spacing: 2px;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 10px; color: rgba(255,255,255,0.8); display: block; letter-spacing: 1px;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: #1e1e1e; padding: 14px 35px; font-weight: 500; font-size: 11px; letter-spacing: 2px; text-transform: uppercase;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      } else if (layout === 'pearlShine') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 50%, #f5f5f5 100%);">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; right: 0; top: 0; width: 50%; height: 100%; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; right: 50%; top: 0; width: 100px; height: 100%; background: linear-gradient(to right, #f8f8f8, transparent);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; max-width: 55%;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<span style=\\'color:#333;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', serif; font-size: 26px; font-weight: 300; color: #333; line-height: 1.2;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 3).map(s => `<p style="font-size: 10px; color: #666; margin-bottom: 4px;"><span style="color: #999;">â—†</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; border: 1px solid #ddd; padding: 12px 20px; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                  <span style="font-size: 24px; font-weight: 300; color: #333;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: #888; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: #333; color: white; padding: 12px 24px; font-weight: 500; font-size: 11px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'obsidianNight') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: #0a0a0a;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; opacity: 0.4;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(45deg, rgba(0,0,0,0.9) 0%, transparent 100%);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 800; color: white;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 3).map(s => `<span style="display: inline-block; border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 9px; padding: 6px 12px; margin-right: 6px;" contenteditable="true">${s}</span>`).join('')}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; border: 2px solid white; padding: 15px 25px;">
                  <span style="font-size: 28px; font-weight: 900; color: white;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: rgba(255,255,255,0.8); display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: #0a0a0a; padding: 14px 28px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'emeraldCity') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(135deg, #065f46 0%, #047857 50%, #059669 100%);">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; opacity: 0.25;"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 15px 20px; border-radius: 8px;">
                  <span style="font-size: 26px; font-weight: 800; color: #065f46;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: #059669; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 800; color: white;" contenteditable="true">${safeHeadlineMain}</h1>
                <h2 style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 8px;" contenteditable="true">${safeHeadlineSub}</h2>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${services.slice(0, 4).map(s => `<span style="background: rgba(255,255,255,0.2); color: white; font-size: 9px; padding: 8px 14px; border-radius: 20px;" contenteditable="true">${s}</span>`).join('')}
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; display: inline-block; max-width: fit-content; background: white; color: #065f46; padding: 14px 28px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      // ==================== POOL SPECIFIC (16) ====================
      } else if (layout === 'poolsideView') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 55%; background: linear-gradient(to top, ${safePrimary}ee 0%, ${safePrimary}aa 60%, transparent 100%);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px;text-shadow:0 2px 4px rgba(0,0,0,0.3)\\'>${safeCompanyName}</span>'">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; width: 85px; height: 85px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3);">
                  <span style="font-size: 22px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: ${safeSecondary}; text-align: center;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div style="margin-top: auto;">
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 26px; font-weight: 800; color: white; margin-bottom: 10px;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-bottom: 15px;">
                  ${services.slice(0, 4).map(s => `<span style="display: inline-block; background: rgba(255,255,255,0.2); color: white; font-size: 9px; padding: 6px 10px; border-radius: 4px; margin-right: 6px; margin-bottom: 6px;" contenteditable="true">ðŸŠ ${s}</span>`).join('')}
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; display: inline-block; background: white; color: ${safePrimary}; padding: 12px 24px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'underwaterBlue') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(to bottom, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; opacity: 0.4;"></div>
            <!-- Bubble effects -->
            <div style="position: absolute; bottom: 20%; left: 15%; width: 20px; height: 20px; background: rgba(255,255,255,0.3); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: 35%; left: 25%; width: 15px; height: 15px; background: rgba(255,255,255,0.2); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: 45%; right: 20%; width: 25px; height: 25px; background: rgba(255,255,255,0.25); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: 30%; right: 30%; width: 12px; height: 12px; background: rgba(255,255,255,0.2); border-radius: 50%;"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 800; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.3);" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; margin-top: 15px; background: white; padding: 18px 30px; border-radius: 50px; display: inline-block;">
                  <span style="font-size: 28px; font-weight: 900; color: #0284c7;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 10px; color: #0ea5e9; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-bottom: 12px;">
                  ${services.slice(0, 3).map(s => `<span style="display: inline-block; background: rgba(255,255,255,0.2); color: white; font-size: 9px; padding: 6px 12px; border-radius: 20px; margin: 0 4px;" contenteditable="true">${s}</span>`).join('')}
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: #0284c7; padding: 14px 30px; border-radius: 30px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'infinityEdge') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(to right, ${safePrimary}dd 0%, ${safePrimary}88 40%, transparent 70%);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; max-width: 55%;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', serif; font-size: 26px; font-weight: 300; color: white; letter-spacing: 1px;" contenteditable="true">${safeHeadlineMain}</h1>
                <h2 style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 8px; font-style: italic;" contenteditable="true">${safeHeadlineSub}</h2>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 3).map(s => `<p style="font-size: 10px; color: white; margin-bottom: 6px;"><span style="color: rgba(255,255,255,0.7);">âˆž</span> <span contenteditable="true">${s}</span></p>`).join('')}
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 15px 22px; border-radius: 4px;">
                  <span style="font-size: 26px; font-weight: 300; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: ${safeSecondary}; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 14px 24px; border-radius: 4px; font-weight: 600; font-size: 11px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'nightSwim') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(to bottom, #1e1b4b 0%, #312e81 50%, #4338ca 100%);">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; opacity: 0.35;"></div>
            <!-- Stars -->
            ${[...Array(8)].map(() => `<div style="position: absolute; top: ${Math.random() * 40}%; left: ${Math.random() * 100}%; width: 3px; height: 3px; background: white; border-radius: 50%; opacity: ${0.4 + Math.random() * 0.6};"></div>`).join('')}
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 800; color: white;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 3).map(s => `<span style="display: inline-block; background: rgba(255,255,255,0.15); color: white; font-size: 9px; padding: 6px 12px; border-radius: 20px; margin-right: 6px;" contenteditable="true">âœ¨ ${s}</span>`).join('')}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: rgba(255,255,255,0.95); padding: 15px 22px; border-radius: 8px;">
                  <span style="font-size: 26px; font-weight: 900; color: #4338ca;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: #6366f1; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: #fbbf24; color: #1e1b4b; padding: 14px 28px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      // ==================== BOLD & IMPACTFUL (8 of 16) ====================
      } else if (layout === 'megaBold') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: ${safePrimary};">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; right: 0; top: 0; width: 45%; height: 100%; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: center;">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 36px; font-weight: 900; color: white; line-height: 0.95; max-width: 55%;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-top: 12px; max-width: 50%;">
                ${services.slice(0, 3).map(s => `<span style="display: inline-block; color: white; font-size: 10px; margin-right: 10px; opacity: 0.9;" contenteditable="true">âœ“ ${s}</span>`).join('')}
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; margin-top: 15px; display: inline-block; max-width: fit-content;">
                <span style="font-size: 42px; font-weight: 900; color: white; -webkit-text-stroke: 2px white; text-stroke: 2px white;" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 14px; color: white; display: block; font-weight: 700;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: absolute; bottom: 24px; left: 24px; background: white; color: ${safePrimary}; padding: 16px 35px; font-weight: 900; font-size: 14px;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      } else if (layout === 'neonGlow') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: #0f0f0f;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; opacity: 0.3;"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1) drop-shadow(0 0 10px ${safePrimary});" onerror="this.outerHTML='<span style=\\'color:${safePrimary};font-weight:700;font-size:16px;text-shadow:0 0 10px ${safePrimary}\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 32px; font-weight: 900; color: ${safePrimary}; text-shadow: 0 0 20px ${safePrimary}, 0 0 40px ${safePrimary};" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                ${services.slice(0, 3).map(s => `<span style="color: ${safeSecondary}; font-size: 10px; text-shadow: 0 0 5px ${safeSecondary};" contenteditable="true">âœ¦ ${s}</span>`).join('')}
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; border: 3px solid ${safeSecondary}; padding: 20px 35px; box-shadow: 0 0 20px ${safeSecondary}, inset 0 0 20px ${safeSecondary}33;">
                <span style="font-size: 36px; font-weight: 900; color: ${safeSecondary}; text-shadow: 0 0 10px ${safeSecondary};" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 11px; color: white; display: block;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 14px 30px; font-weight: 700; font-size: 12px; box-shadow: 0 0 15px ${safePrimary};" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      } else if (layout === 'flashSale') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; opacity: 0.2;"></div>
            <!-- Flash burst -->
            <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: #fbbf24; transform: rotate(45deg);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
                <div style="background: white; color: #dc2626; padding: 8px 15px; font-weight: 900; font-size: 12px; transform: rotate(5deg);">âš¡ FLASH SALE</div>
              </div>
              <div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 32px; font-weight: 900; color: white;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-top: 8px; display: flex; gap: 10px; flex-wrap: wrap;">
                  ${services.slice(0, 3).map(s => `<span style="color: #fef3c7; font-size: 10px;" contenteditable="true">âœ“ ${s}</span>`).join('')}
                </div>
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: #fbbf24; padding: 20px 30px; display: inline-block; max-width: fit-content; transform: skewX(-5deg);">
                <span style="font-size: 40px; font-weight: 900; color: #dc2626; display: block; transform: skewX(5deg);" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 12px; color: #b91c1c; transform: skewX(5deg); display: block;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: #dc2626; padding: 16px 35px; font-weight: 900; font-size: 14px; text-align: center;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      } else if (layout === 'grandOpening') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(135deg, ${safePrimary} 0%, ${safeSecondary} 100%);">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; opacity: 0.3;"></div>
            <!-- Ribbon decorations -->
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 30px; background: repeating-linear-gradient(45deg, ${safeSecondary}, ${safeSecondary} 10px, ${safePrimary} 10px, ${safePrimary} 20px);"></div>
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 30px; background: repeating-linear-gradient(-45deg, ${safeSecondary}, ${safeSecondary} 10px, ${safePrimary} 10px, ${safePrimary} 20px);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 50px 24px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
              <div style="background: white; color: ${safePrimary}; padding: 8px 20px; font-weight: 900; font-size: 14px; margin-bottom: 15px; letter-spacing: 3px;">ðŸŽ‰ GRAND OPENING ðŸŽ‰</div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 28px; font-weight: 900; color: white;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin: 10px 0;">
                ${services.slice(0, 3).map(s => `<span style="background: rgba(255,255,255,0.2); color: white; font-size: 9px; padding: 4px 10px; border-radius: 12px;" contenteditable="true">${s}</span>`).join('')}
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; margin: 15px 0; background: white; width: 120px; height: 120px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <span style="font-size: 32px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 9px; color: ${safeSecondary};" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 14px 35px; border-radius: 30px; font-weight: 700; font-size: 13px;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      // ==================== ARTISTIC (4 of 16) ====================
      } else if (layout === 'watercolor') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: #f5f5f5;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover; opacity: 0.6; filter: saturate(0.7);"></div>
            <!-- Watercolor splashes -->
            <div style="position: absolute; top: 10%; left: 5%; width: 150px; height: 100px; background: ${safePrimary}44; border-radius: 50% 60% 40% 70%; filter: blur(20px);"></div>
            <div style="position: absolute; bottom: 20%; right: 10%; width: 120px; height: 80px; background: ${safeSecondary}44; border-radius: 60% 40% 70% 50%; filter: blur(15px);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<span style=\\'color:#333;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', serif; font-size: 28px; font-weight: 400; color: #333; font-style: italic;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')">
                ${services.slice(0, 3).map(s => `<span style="display: inline-block; background: white; color: ${safePrimary}; font-size: 9px; padding: 6px 12px; border-radius: 20px; margin-right: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);" contenteditable="true">${s}</span>`).join('')}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                  <span style="font-size: 28px; font-weight: 700; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: ${safeSecondary}; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 14px 28px; border-radius: 25px; font-weight: 600; font-size: 12px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'comicBook') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: #fbbf24;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; right: 0; top: 0; width: 55%; height: 100%; background: url('${safePoolImage}') center/cover; clip-path: polygon(15% 0, 100% 0, 100% 100%, 0% 100%); border-left: 4px solid black;"></div>
            <!-- Comic dots -->
            <div style="position: absolute; inset: 0; background: radial-gradient(circle, #00000011 1px, transparent 1px); background-size: 8px 8px;"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; max-width: 50%;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<span style=\\'color:black;font-weight:900;font-size:16px\\'>${safeCompanyName}</span>'">
              <div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: 'Impact', sans-serif; font-size: 32px; font-weight: 900; color: black; text-transform: uppercase; -webkit-text-stroke: 1px black;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-top: 6px;">
                  ${services.slice(0, 3).map(s => `<span style="display: inline-block; background: white; border: 2px solid black; color: black; font-size: 10px; padding: 3px 8px; margin: 2px; font-weight: 700;" contenteditable="true">${s}</span>`).join('')}
                </div>
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; border: 4px solid black; padding: 15px 20px; transform: rotate(-3deg);">
                <span style="font-size: 32px; font-weight: 900; color: #dc2626;" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 10px; color: black; display: block; font-weight: 700;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: #dc2626; color: white; padding: 14px 28px; border: 3px solid black; font-weight: 900; font-size: 13px; text-transform: uppercase; transform: rotate(2deg);" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      } else if (layout === 'popArt') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: linear-gradient(45deg, #ec4899 25%, #f472b6 25%, #f472b6 50%, #ec4899 50%, #ec4899 75%, #f472b6 75%); background-size: 40px 40px;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; right: 5%; top: 50%; transform: translateY(-50%); width: 45%; height: 80%; background: url('${safePoolImage}') center/cover; border: 6px solid black;"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; max-width: 50%;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: drop-shadow(2px 2px 0 black);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:900;font-size:16px;text-shadow:2px 2px 0 black\\'>${safeCompanyName}</span>'">
              <div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                  <h1 style="font-family: 'Impact', sans-serif; font-size: 30px; font-weight: 900; color: #fbbf24; text-shadow: 3px 3px 0 black; text-transform: uppercase;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
                <div class="${lc('services')}" ondblclick="toggleLock('services')" style="margin-top: 6px;">
                  ${services.slice(0, 3).map(s => `<span style="display: inline-block; background: white; border: 3px solid black; color: black; font-size: 10px; padding: 3px 8px; margin: 2px; font-weight: 700; box-shadow: 2px 2px 0 black;" contenteditable="true">${s}</span>`).join('')}
                </div>
              </div>
              <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: #fbbf24; border: 4px solid black; padding: 15px 25px; box-shadow: 5px 5px 0 black;">
                <span style="font-size: 36px; font-weight: 900; color: black;" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 11px; color: black; display: block; font-weight: 700;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: black; padding: 14px 28px; border: 4px solid black; font-weight: 900; font-size: 13px; box-shadow: 4px 4px 0 black;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      // ==================== TRUST BUILDING (4 of 16) ====================
      } else if (layout === 'testimonialCard') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: white;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; top: 0; left: 0; right: 0; height: 40%; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; top: 38%; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; background: ${safePrimary}; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
              <span style="font-size: 30px; color: white;">â</span>
            </div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column;">
              <div style="flex: 1;"></div>
              <div style="background: white; padding-top: 40px; text-align: center;">
                <div class="${lc('testimonial')}" ondblclick="toggleLock('testimonial')">
                  <p style="font-family: '${font}', serif; font-size: 13px; color: #475569; font-style: italic; line-height: 1.5; margin-bottom: 10px; max-width: 90%; margin-left: auto; margin-right: auto;" contenteditable="true">"${safeTestimonialText}"</p>
                  <p style="font-size: 11px; color: ${safePrimary}; font-weight: 700;" contenteditable="true">â€” ${safeTestimonialAuthor}</p>
                </div>
                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px; align-items: center;">
                  <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: ${safePrimary}; color: white; padding: 10px 18px; border-radius: 6px;">
                    <span style="font-size: 18px; font-weight: 800;" contenteditable="true">${safeDiscountAmount}</span>
                    <span style="font-size: 10px; display: block;" contenteditable="true">${safeDiscountText}</span>
                  </div>
                  <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safeSecondary}; color: white; padding: 12px 22px; border-radius: 6px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'certifiedPro') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(135deg, ${safePrimary}ee 0%, ${safeSecondary}dd 100%);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
                <!-- Certification badges -->
                <div style="display: flex; gap: 8px;">
                  <div style="background: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">ðŸ†</div>
                  <div style="background: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">âœ“</div>
                </div>
              </div>
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 26px; font-weight: 800; color: white;" contenteditable="true">${safeHeadlineMain}</h1>
                <p style="font-size: 11px; color: rgba(255,255,255,0.9); margin-top: 8px;">Licensed â€¢ Insured â€¢ Certified</p>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="display: flex; flex-wrap: wrap; gap: 6px;">
                ${services.slice(0, 4).map(s => `<span style="background: rgba(255,255,255,0.2); color: white; font-size: 9px; padding: 6px 10px; border-radius: 4px;" contenteditable="true">âœ“ ${s}</span>`).join('')}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 15px 22px; border-radius: 8px;">
                  <span style="font-size: 26px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: ${safeSecondary}; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 14px 28px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else if (layout === 'guaranteeSeal') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden; background: white;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; left: 0; top: 0; width: 55%; height: 100%; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; left: 53%; top: 0; width: 50px; height: 100%; background: linear-gradient(to right, white, transparent);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; align-items: flex-end; text-align: right;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px;" onerror="this.outerHTML='<span style=\\'color:${safePrimary};font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="max-width: 45%;">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 22px; font-weight: 800; color: #1e293b;" contenteditable="true">${safeHeadlineMain}</h1>
              </div>
              <!-- Guarantee Seal -->
              <div data-movable="true" style="position: relative; width: 130px; height: 130px; background: linear-gradient(135deg, ${safePrimary}, ${safeSecondary}); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 4px dashed white; box-shadow: 0 0 0 4px ${safePrimary};">
                <span style="font-size: 12px; color: white; font-weight: 700;">100%</span>
                <span style="font-size: 9px; color: white; font-weight: 600;">SATISFACTION</span>
                <span style="font-size: 9px; color: white; font-weight: 600;">GUARANTEED</span>
                <div class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="margin-top: 5px;">
                  <span style="font-size: 14px; font-weight: 900; color: white;" contenteditable="true">${safeDiscountAmount}</span>
                </div>
              </div>
              <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: ${safePrimary}; color: white; padding: 14px 28px; border-radius: 6px; font-weight: 700; font-size: 12px;" contenteditable="true">${safeCta}</div>
            </div>
          </div>
        `;
      } else if (layout === 'yearsExperience') {
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; inset: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(to right, ${safePrimary}ee 0%, ${safePrimary}cc 50%, transparent 100%);"></div>
            <div style="position: relative; z-index: 1; height: 100%; padding: 24px; display: flex; flex-direction: column; justify-content: space-between;">
              <img src="${safeLogoUrl}" style="height: ${logoSize}px; filter: brightness(0) invert(1);" onerror="this.outerHTML='<span style=\\'color:white;font-weight:700;font-size:16px\\'>${safeCompanyName}</span>'">
              <div style="display: flex; align-items: flex-end; gap: 15px;">
                <div style="text-align: center;">
                  <span style="font-size: 40px; font-weight: 900; color: white; line-height: 1;">20</span>
                  <span style="display: block; font-size: 12px; color: white; font-weight: 600; text-transform: uppercase; letter-spacing: 2px;">Years</span>
                </div>
                <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="max-width: 55%;">
                  <h1 style="font-family: '${font}', ${fontFallback}; font-size: 22px; font-weight: 800; color: white;" contenteditable="true">${safeHeadlineMain}</h1>
                </div>
              </div>
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="max-width: 60%;">
                ${services.slice(0, 3).map(s => `<span style="display: inline-block; background: rgba(255,255,255,0.2); color: white; font-size: 9px; padding: 6px 10px; border-radius: 4px; margin-right: 6px; margin-bottom: 6px;" contenteditable="true">${s}</span>`).join('')}
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; background: white; padding: 12px 20px; border-radius: 6px;">
                  <span style="font-size: 22px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: ${safeSecondary}; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div data-movable="true" class="${lc('cta')}" ondblclick="event.stopPropagation(); toggleLock('cta');" style="position: relative; background: white; color: ${safePrimary}; padding: 14px 24px; border-radius: 6px; font-weight: 700; font-size: 11px;" contenteditable="true">${safeCta}</div>
              </div>
            </div>
          </div>
        `;
      } else {
        // DEFAULT FALLBACK - Full bleed visual design
        frontHTML = `
          <div style="width: 100%; height: 100%; position: relative; overflow: hidden;">
            <div class="${lc('poolImage')}" ondblclick="toggleLock('poolImage')" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('${safePoolImage}') center/cover;"></div>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.6) 100%);"></div>

            <!-- Content Layer -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; padding: 25px; display: flex; flex-direction: column; z-index: 1;">
              <!-- Top Row: Logo + Discount Badge -->
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <div data-movable="true" style="position: relative;">
                  <img src="${safeLogoUrl}" style="height: ${logoSize}px; width: auto; max-width: 200px; object-fit: contain; filter: brightness(0) invert(1);" onerror="this.outerHTML='<div style=\\'font-size:16px;font-weight:800;color:white;\\'>${safeCompanyName}</div>'">
                </div>
                <div data-movable="true" class="discount ${lc('discount')}" ondblclick="event.stopPropagation(); toggleLock('discount');" style="position: relative; width: 80px; height: 80px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.4); border: 3px solid white; flex-shrink: 0; text-align: center;">
                  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; overflow: hidden;">
                    <span style="display: block; font-size: 13px; font-weight: 900; color: white; line-height: 1; text-align: center;" contenteditable="true">${safeDiscountAmount}</span>
                    <span style="display: block; font-size: 8px; font-weight: 700; color: rgba(255,255,255,0.95); text-transform: uppercase; text-align: center; margin-top: 2px; line-height: 1.1;" contenteditable="true">${safeDiscountText}</span>
                  </div>
                </div>
              </div>

              <!-- Big Bold Headline -->
              <div class="${lc('headline')}" ondblclick="toggleLock('headline')" style="flex: 1; display: flex; flex-direction: column; justify-content: center; text-align: center;">
                <h1 style="font-family: '${font}', ${fontFallback}; font-size: 36px; font-weight: 900; color: white; line-height: 1.1; text-shadow: 0 2px 10px rgba(0,0,0,0.5); margin: 0; text-align: center;" contenteditable="true">${safeHeadlineMain}</h1>
                <p style="font-size: 15px; color: rgba(255,255,255,0.95); text-shadow: 0 1px 4px rgba(0,0,0,0.4); margin: 8px 0 0 0; text-align: center;" contenteditable="true">${safeHeadlineSub}</p>
              </div>

              <!-- Weekly Checklist -->
              <div class="${lc('services')}" ondblclick="toggleLock('services')" style="background: rgba(255,255,255,0.95); padding: 10px 12px; border-radius: 8px; margin-bottom: 10px;">
                <p style="font-size: 10px; color: ${safePrimary}; font-weight: 800; text-transform: uppercase; margin: 0 0 6px 0;">Weekly Service:</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px 12px;">
                  ${services.slice(0, 6).map(s => `<div style="display: flex; align-items: flex-start; gap: 4px; font-size: 9px; color: #374151; line-height: 1.3;"><span style="color: ${safePrimary}; flex-shrink: 0;">âœ“</span><span contenteditable="true">${s}</span></div>`).join('')}
                </div>
              </div>

              <!-- CTA Row -->
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <div class="${lc('cta')}" ondblclick="toggleLock('cta')" style="flex: 1; background: white; color: ${safePrimary}; text-align: center; padding: 12px 16px; border-radius: 6px; font-weight: 800; font-size: 12px;" contenteditable="true">${safeCta}</div>
              </div>

              <!-- Contact Footer -->
              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3); color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.3); gap: 8px;">
                <div style="flex: 1; min-width: 0;">
                  <span style="display: block; font-size: 12px; font-weight: 800;" contenteditable="true">${safePhoneDisplay}</span>
                  <span style="display: block; font-size: 9px; opacity: 0.9; margin-top: 2px;" contenteditable="true">${safeWebsite}</span>
                </div>
                <span style="display: block; font-size: 9px; opacity: 0.8; text-align: right; line-height: 1.3; flex-shrink: 0;" contenteditable="true">Locally Owned, Licensed & Insured</span>
              </div>
            </div>
          </div>
        `;
      }

      // Add logo white box style if enabled
      const logoWhiteBoxCSS = logoWhiteBox ? `
        <style>
          .postcard-front img[src="${safeLogoUrl}"],
          .postcard-back img[src="${safeLogoUrl}"] {
            background: white !important;
            padding: 8px 12px !important;
            border-radius: 6px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
          }
        </style>
      ` : '';

      const qrClass = showQRCode ? '' : ' hide-qr';
      document.getElementById('frontCard').innerHTML = `${logoWhiteBoxCSS}<div class="postcard-front${qrClass}">${frontHTML}</div>`;

      // Back side - Multiple layouts matching Vistaprint mailing templates
      // All layouts reserve bottom-right for mailing zone
      const mailZone = postcardSizes[currentSize]?.mailZone || { rightWidth: '44%', bottomHeight: '42%' };
      const backLayout = currentDesign.backLayout || 'lShape';

      // Common mailing zone HTML (used in all back layouts)
      const mailingZoneHTML = `
        <div style="position: absolute; bottom: 0; right: 0; width: ${mailZone.rightWidth}; height: ${mailZone.bottomHeight}; background: #fafafa; border-left: 2px dashed ${safePrimary}25; border-top: 2px dashed ${safePrimary}25; box-sizing: border-box;">
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; opacity: 0.35;">
            <p style="font-size: 9px; color: #666; margin: 0; font-weight: 600;">MAILING ZONE</p>
            <p style="font-size: 9px; color: #888; margin: 3px 0 0 0;">Address & Postage</p>
          </div>
        </div>
      `;

      let backHTML = '';

      if (backLayout === 'lShape') {
        // L-Shape: Content top + left, mailing bottom-right
        backHTML = `
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: calc(100% - ${mailZone.bottomHeight}); padding: 20px; box-sizing: border-box; background: linear-gradient(180deg, ${safePrimary}05 0%, white 100%);">
              <div style="display: flex; gap: 15px; height: 100%;">
                <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                  <div style="text-align: center; padding-bottom: 6px; border-bottom: 1px solid ${safePrimary}15;">
                    <img src="${safeLogoUrl}" style="height: ${Math.min(logoSize, 45)}px; width: auto; max-width: 150px;" onerror="this.style.display='none'">
                  </div>
                  <div style="background: white; border-radius: 6px; padding: 8px 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 1px solid ${safePrimary}10; flex: 1;">
                    <p style="font-size: 9px; color: #374151; line-height: 1.4; margin: 0; text-align: center;" contenteditable="true">Hi Neighbor! Your pool deserves the best care. As a locally owned business, we treat every pool like our own. Call today for your FREE quote!</p>
                  </div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; gap: 6px;">
                  <div style="display: flex; justify-content: center; align-items: center; gap: 8px;">
                    <div class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="background: ${safePrimary}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; text-align: center;">
                      <span contenteditable="true">${safeDiscountAmount}</span>
                      <span style="font-size: 9px; display: block; opacity: 0.9;" contenteditable="true">${safeDiscountText}</span>
                    </div>
                    <span style="font-size: 10px; color: ${safeSecondary}; font-weight: 600;" contenteditable="true">${safeUrgency}</span>
                  </div>
                  <div style="flex: 1;">
                    <p style="font-size: 10px; color: ${safePrimary}; font-weight: 800; text-transform: uppercase; margin: 0 0 4px 0;">Our Services:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px 6px;">
                      ${services.slice(0, 6).map(s => `<div style="display: flex; align-items: flex-start; gap: 2px; font-size: 9px; color: #374151;"><span style="color: ${safePrimary};">âœ“</span><span contenteditable="true">${s}</span></div>`).join('')}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div style="position: absolute; bottom: 0; left: 0; width: calc(100% - ${mailZone.rightWidth}); height: ${mailZone.bottomHeight}; padding: 12px 15px; box-sizing: border-box;">
              <div style="background: ${safePrimary}; padding: 10px 12px; border-radius: 6px; height: 100%; display: flex; align-items: center; gap: 10px;">
                <div data-qr-container style="width: 50px; height: 50px; border-radius: 4px; overflow: hidden; border: 2px solid white; background: white; flex-shrink: 0;">
                  <img src="${safeQrUrl}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='SCAN'">
                </div>
                <div style="color: white; text-align: left; flex: 1;">
                  <div style="font-weight: 900; font-size: 12px;" contenteditable="true">${safePhoneDisplay}</div>
                  <div style="font-size: 10px; opacity: 0.9;" contenteditable="true">${safeWebsite}</div>
                  <div style="font-size: 9px; opacity: 0.85; margin-top: 2px;" contenteditable="true">Serving ${safeCity} & Surrounding Areas</div>
                </div>
              </div>
            </div>
            ${mailingZoneHTML}
          </div>
        `;
      } else if (backLayout === 'twoColumn') {
        // Two Column: Left services, right contact
        backHTML = `
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex;">
            <div style="width: calc(100% - ${mailZone.rightWidth}); height: 100%; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column;">
              <div style="text-align: center; margin-bottom: 12px;">
                <img src="${safeLogoUrl}" style="height: ${Math.min(logoSize, 40)}px;" onerror="this.style.display='none'">
              </div>
              <div style="display: flex; gap: 15px; flex: 1;">
                <div style="flex: 1;">
                  <p style="font-size: 10px; color: ${safePrimary}; font-weight: 800; text-transform: uppercase; margin: 0 0 8px 0;">Services</p>
                  ${services.slice(0, 4).map(s => `<p style="font-size: 10px; color: #374151; margin: 0 0 4px 0;"><span style="color: ${safePrimary};">âœ“</span> <span contenteditable="true">${s}</span></p>`).join('')}
                </div>
                <div style="flex: 1;">
                  <div class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="background: ${safePrimary}; color: white; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 10px;">
                    <span style="font-size: 18px; font-weight: 900; display: block;" contenteditable="true">${safeDiscountAmount}</span>
                    <span style="font-size: 10px;" contenteditable="true">${safeDiscountText}</span>
                  </div>
                  <p style="font-size: 10px; color: #374151; text-align: center; line-height: 1.4;" contenteditable="true">Hi Neighbor! Your pool deserves the best care.</p>
                </div>
              </div>
              <div style="background: ${safePrimary}; color: white; padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; margin-top: auto;">
                <div data-qr-container style="width: 40px; height: 40px; background: white; border-radius: 4px; flex-shrink: 0;">
                  <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
                </div>
                <div>
                  <div style="font-weight: 800; font-size: 11px;" contenteditable="true">${safePhoneDisplay}</div>
                  <div style="font-size: 9px; opacity: 0.9;" contenteditable="true">${safeWebsite}</div>
                </div>
              </div>
            </div>
            ${mailingZoneHTML}
          </div>
        `;
      } else if (backLayout === 'centered') {
        // Centered: Everything centered with prominent CTA
        backHTML = `
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
            <div style="position: absolute; top: 0; left: 0; width: calc(100% - ${mailZone.rightWidth}); height: calc(100% - ${mailZone.bottomHeight}); padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
              <img src="${safeLogoUrl}" style="height: ${Math.min(logoSize, 50)}px; margin-bottom: 12px;" onerror="this.style.display='none'">
              <div class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="background: linear-gradient(135deg, ${safePrimary} 0%, ${safeSecondary} 100%); color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 12px;">
                <span style="font-size: 22px; font-weight: 900; display: block;" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 9px;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <p style="font-size: 10px; color: #374151; line-height: 1.5; max-width: 200px;" contenteditable="true">Professional pool care from your neighbors. Licensed & Insured.</p>
            </div>
            <div style="position: absolute; bottom: 0; left: 0; width: calc(100% - ${mailZone.rightWidth}); height: ${mailZone.bottomHeight}; background: ${safePrimary}; display: flex; align-items: center; justify-content: center; gap: 15px;">
              <div data-qr-container style="width: 45px; height: 45px; background: white; border-radius: 6px;">
                <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
              </div>
              <div style="color: white; text-align: left;">
                <div style="font-weight: 900; font-size: 14px;" contenteditable="true">${safePhoneDisplay}</div>
                <div style="font-size: 10px; opacity: 0.9;" contenteditable="true">${safeWebsite}</div>
              </div>
            </div>
            <div style="position: absolute; top: 0; right: 0; width: ${mailZone.rightWidth}; height: calc(100% - ${mailZone.bottomHeight}); padding: 15px; box-sizing: border-box;">
              <p style="font-size: 10px; color: ${safePrimary}; font-weight: 800; text-transform: uppercase; margin: 0 0 8px 0;">What We Do:</p>
              ${services.slice(0, 5).map(s => `<p style="font-size: 9px; color: #374151; margin: 0 0 4px 0;"><span style="color: ${safePrimary};">âœ“</span> <span contenteditable="true">${s}</span></p>`).join('')}
            </div>
            ${mailingZoneHTML}
          </div>
        `;
      } else if (backLayout === 'testimonialFocus') {
        // Testimonial Focus: Large testimonial with contact
        backHTML = `
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
            <div style="position: absolute; top: 0; left: 0; right: ${mailZone.rightWidth}; bottom: ${mailZone.bottomHeight}; padding: 20px; box-sizing: border-box;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <img src="${safeLogoUrl}" style="height: ${Math.min(logoSize, 35)}px;" onerror="this.style.display='none'">
                <div class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="background: ${safePrimary}; color: white; padding: 6px 12px; border-radius: 4px; margin-left: auto;">
                  <span style="font-size: 12px; font-weight: 800;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div style="background: ${safePrimary}08; border-left: 3px solid ${safePrimary}; padding: 12px; border-radius: 0 6px 6px 0;">
                <p style="font-size: 10px; color: #374151; font-style: italic; line-height: 1.5; margin: 0;" contenteditable="true">"${safeTestimonialText}"</p>
                <p style="font-size: 10px; color: ${safePrimary}; font-weight: 600; margin: 8px 0 0 0;" contenteditable="true">â€” ${safeTestimonialAuthor}</p>
              </div>
              <div style="display: flex; gap: 6px; margin-top: 12px; flex-wrap: wrap;">
                ${services.slice(0, 4).map(s => `<span style="font-size: 9px; background: ${safePrimary}10; color: ${safePrimary}; padding: 4px 8px; border-radius: 12px;" contenteditable="true">${s}</span>`).join('')}
              </div>
            </div>
            <div style="position: absolute; bottom: 0; left: 0; width: calc(100% - ${mailZone.rightWidth}); height: ${mailZone.bottomHeight}; background: ${safePrimary}; display: flex; align-items: center; padding: 0 20px; gap: 12px;">
              <div data-qr-container style="width: 45px; height: 45px; background: white; border-radius: 4px; flex-shrink: 0;">
                <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
              </div>
              <div style="color: white;">
                <div style="font-weight: 900; font-size: 13px;" contenteditable="true">${safePhoneDisplay}</div>
                <div style="font-size: 10px; opacity: 0.9;" contenteditable="true">${safeWebsite}</div>
              </div>
            </div>
            ${mailingZoneHTML}
          </div>
        `;
      } else if (backLayout === 'gridServices') {
        // Grid Services: Services in a clean grid
        backHTML = `
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: calc(100% - ${mailZone.bottomHeight}); padding: 15px; box-sizing: border-box;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <img src="${safeLogoUrl}" style="height: ${Math.min(logoSize, 35)}px;" onerror="this.style.display='none'">
                <div class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="background: ${safePrimary}; color: white; padding: 8px 14px; border-radius: 6px;">
                  <span style="font-size: 14px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                ${services.slice(0, 6).map(s => `
                  <div style="background: ${safePrimary}08; padding: 8px; border-radius: 6px; text-align: center;">
                    <span style="color: ${safePrimary}; font-size: 12px;">âœ“</span>
                    <p style="font-size: 9px; color: #374151; margin: 4px 0 0 0;" contenteditable="true">${s}</p>
                  </div>
                `).join('')}
              </div>
            </div>
            <div style="position: absolute; bottom: 0; left: 0; width: calc(100% - ${mailZone.rightWidth}); height: ${mailZone.bottomHeight}; background: ${safePrimary}; display: flex; align-items: center; justify-content: center; gap: 15px;">
              <div data-qr-container style="width: 45px; height: 45px; background: white; border-radius: 4px;">
                <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
              </div>
              <div style="color: white;">
                <div style="font-weight: 900; font-size: 13px;" contenteditable="true">${safePhoneDisplay}</div>
                <div style="font-size: 10px; opacity: 0.9;" contenteditable="true">${safeWebsite}</div>
              </div>
            </div>
            ${mailingZoneHTML}
          </div>
        `;
      } else if (backLayout === 'couponStyle') {
        // Coupon Style: Looks like a tear-off coupon
        backHTML = `
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: calc(100% - ${mailZone.bottomHeight}); padding: 12px; box-sizing: border-box; overflow: visible;">
              <div style="border: 2px dashed ${safePrimary}; border-radius: 8px; padding: 12px; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; justify-content: space-between; overflow: visible;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <img src="${safeLogoUrl}" style="height: ${Math.min(logoSize, 30)}px;" onerror="this.style.display='none'">
                  <div style="text-align: right;">
                    <p style="font-size: 8px; color: #666; margin: 0;">SPECIAL OFFER</p>
                    <p style="font-size: 9px; color: ${safePrimary}; font-weight: 600; margin: 2px 0 0 0;" contenteditable="true">${safeUrgency}</p>
                  </div>
                </div>
                <div class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="text-align: center; margin: 8px 0; padding: 10px; background: ${safePrimary}08; border-radius: 6px; flex-shrink: 0;">
                  <span style="font-size: 24px; font-weight: 900; color: ${safePrimary}; display: block;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px; color: ${safeSecondary};" contenteditable="true">${safeDiscountText}</span>
                </div>
                <div style="display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; overflow: visible; flex-shrink: 0;">
                  ${services.slice(0, 4).map(s => `<span style="font-size: 8px; color: #374151; padding: 2px 6px; background: white; border: 1px solid ${safePrimary}30; border-radius: 4px; white-space: nowrap;" contenteditable="true">${s}</span>`).join('')}
                </div>
              </div>
            </div>
            <div style="position: absolute; bottom: 0; left: 0; width: calc(100% - ${mailZone.rightWidth}); height: ${mailZone.bottomHeight}; background: ${safePrimary}; display: flex; align-items: center; padding: 0 20px; gap: 12px;">
              <div data-qr-container style="width: 40px; height: 40px; background: white; border-radius: 4px;">
                <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
              </div>
              <div style="color: white;">
                <div style="font-weight: 900; font-size: 12px;" contenteditable="true">${safePhoneDisplay}</div>
                <div style="font-size: 9px; opacity: 0.9;" contenteditable="true">${safeWebsite}</div>
              </div>
            </div>
            ${mailingZoneHTML}
          </div>
        `;
      } else if (backLayout === 'bold') {
        // Bold: Large typography focus
        backHTML = `
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: ${safePrimary};">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: calc(100% - ${mailZone.bottomHeight}); padding: 20px; box-sizing: border-box; color: white;">
              <img src="${safeLogoUrl}" style="height: ${Math.min(logoSize, 40)}px; filter: brightness(0) invert(1); margin-bottom: 15px;" onerror="this.style.display='none'">
              <h2 style="font-family: '${font}', ${fontFallback}; font-size: 22px; font-weight: 900; margin: 0 0 10px 0; line-height: 1.1;" contenteditable="true">Pool Care Done Right</h2>
              <p style="font-size: 10px; opacity: 0.9; line-height: 1.4; margin-bottom: 15px;" contenteditable="true">Professional service from your local pool experts. Licensed & Insured.</p>
              <div class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="display: inline-block; background: white; color: ${safePrimary}; padding: 10px 18px; border-radius: 6px;">
                <span style="font-size: 20px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 9px; display: block; color: ${safeSecondary};" contenteditable="true">${safeDiscountText}</span>
              </div>
            </div>
            <div style="position: absolute; bottom: 0; left: 0; width: calc(100% - ${mailZone.rightWidth}); height: ${mailZone.bottomHeight}; background: white; display: flex; align-items: center; padding: 0 20px; gap: 12px;">
              <div data-qr-container style="width: 45px; height: 45px; border: 2px solid ${safePrimary}; border-radius: 4px;">
                <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
              </div>
              <div style="color: ${safePrimary};">
                <div style="font-weight: 900; font-size: 14px;" contenteditable="true">${safePhoneDisplay}</div>
                <div style="font-size: 10px;" contenteditable="true">${safeWebsite}</div>
              </div>
            </div>
            <div style="position: absolute; bottom: 0; right: 0; width: ${mailZone.rightWidth}; height: ${mailZone.bottomHeight}; background: white; border-left: 2px dashed ${safePrimary}25; border-top: 2px dashed ${safePrimary}25;">
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; opacity: 0.35;">
                <p style="font-size: 9px; color: #666; margin: 0; font-weight: 600;">MAILING ZONE</p>
              </div>
            </div>
          </div>
        `;
      } else if (backLayout === 'minimal') {
        // Minimal: Clean and simple
        backHTML = `
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: calc(100% - ${mailZone.bottomHeight}); padding: 25px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <img src="${safeLogoUrl}" style="height: ${Math.min(logoSize, 45)}px;" onerror="this.style.display='none'">
                <div class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="text-align: right;">
                  <span style="font-size: 20px; font-weight: 900; color: ${safePrimary};" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 10px; color: ${safeSecondary}; display: block;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div style="text-align: center; padding: 20px 0;">
                <p style="font-size: 11px; color: #374151; line-height: 1.6;" contenteditable="true">Professional pool care from your neighbors.<br>Licensed, insured, and trusted by ${safeCity} families.</p>
              </div>
              <div style="display: flex; justify-content: center; gap: 15px;">
                ${services.slice(0, 3).map(s => `<span style="font-size: 10px; color: ${safePrimary};" contenteditable="true">â€¢ ${s}</span>`).join('')}
              </div>
            </div>
            <div style="position: absolute; bottom: 0; left: 0; width: calc(100% - ${mailZone.rightWidth}); height: ${mailZone.bottomHeight}; border-top: 1px solid ${safePrimary}20; display: flex; align-items: center; justify-content: center; gap: 20px;">
              <div data-qr-container style="width: 40px; height: 40px;">
                <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
              </div>
              <div style="color: ${safePrimary};">
                <div style="font-weight: 800; font-size: 13px;" contenteditable="true">${safePhoneDisplay}</div>
                <div style="font-size: 10px; color: #666;" contenteditable="true">${safeWebsite}</div>
              </div>
            </div>
            ${mailingZoneHTML}
          </div>
        `;
      } else if (backLayout === 'stacked') {
        // Stacked: Vertical stack of elements
        backHTML = `
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
            <div style="position: absolute; top: 0; left: 0; width: calc(100% - ${mailZone.rightWidth}); bottom: 0; display: flex; flex-direction: column;">
              <div style="padding: 15px; text-align: center; border-bottom: 1px solid ${safePrimary}15;">
                <img src="${safeLogoUrl}" style="height: ${Math.min(logoSize, 40)}px;" onerror="this.style.display='none'">
              </div>
              <div class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="background: ${safePrimary}; color: white; padding: 12px; text-align: center;">
                <span style="font-size: 18px; font-weight: 900;" contenteditable="true">${safeDiscountAmount}</span>
                <span style="font-size: 10px; margin-left: 8px;" contenteditable="true">${safeDiscountText}</span>
              </div>
              <div style="padding: 12px; flex: 1;">
                <p style="font-size: 9px; color: #374151; text-align: center; line-height: 1.5; margin-bottom: 10px;" contenteditable="true">Hi Neighbor! Professional pool care from your local experts.</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                  ${services.slice(0, 4).map(s => `<span style="font-size: 9px; color: ${safePrimary};" contenteditable="true">âœ“ ${s}</span>`).join('')}
                </div>
              </div>
              <div style="background: ${safePrimary}10; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 12px;">
                <div data-qr-container style="width: 35px; height: 35px;">
                  <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
                </div>
                <div>
                  <div style="font-weight: 900; font-size: 11px; color: ${safePrimary};" contenteditable="true">${safePhoneDisplay}</div>
                  <div style="font-size: 9px; color: #666;" contenteditable="true">${safeWebsite}</div>
                </div>
              </div>
            </div>
            ${mailingZoneHTML}
          </div>
        `;
      } else {
        // Default/Classic: Simple professional layout
        backHTML = `
          <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: calc(100% - ${mailZone.bottomHeight}); padding: 20px; box-sizing: border-box;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                <img src="${safeLogoUrl}" style="height: ${Math.min(logoSize, 45)}px;" onerror="this.style.display='none'">
                <div class="discount ${lc('discount')}" ondblclick="toggleLock('discount')" style="background: ${safePrimary}; color: white; padding: 8px 14px; border-radius: 6px; text-align: center;">
                  <span style="font-size: 16px; font-weight: 900; display: block;" contenteditable="true">${safeDiscountAmount}</span>
                  <span style="font-size: 9px;" contenteditable="true">${safeDiscountText}</span>
                </div>
              </div>
              <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                  <p style="font-size: 9px; color: #374151; line-height: 1.5; margin-bottom: 12px;" contenteditable="true">Hi Neighbor! Your pool deserves the best care. As a locally owned business, we treat every pool like our own.</p>
                  <p style="font-size: 10px; color: ${safePrimary}; font-weight: 700;" contenteditable="true">${safeUrgency}</p>
                </div>
                <div style="flex: 1;">
                  <p style="font-size: 10px; color: ${safePrimary}; font-weight: 800; margin: 0 0 6px 0;">SERVICES:</p>
                  ${services.slice(0, 4).map(s => `<p style="font-size: 9px; color: #374151; margin: 0 0 3px 0;"><span style="color: ${safePrimary};">âœ“</span> <span contenteditable="true">${s}</span></p>`).join('')}
                </div>
              </div>
            </div>
            <div style="position: absolute; bottom: 0; left: 0; width: calc(100% - ${mailZone.rightWidth}); height: ${mailZone.bottomHeight}; background: ${safePrimary}; display: flex; align-items: center; padding: 0 20px; gap: 12px;">
              <div data-qr-container style="width: 45px; height: 45px; background: white; border-radius: 4px;">
                <img src="${safeQrUrl}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">
              </div>
              <div style="color: white;">
                <div style="font-weight: 900; font-size: 13px;" contenteditable="true">${safePhoneDisplay}</div>
                <div style="font-size: 10px; opacity: 0.9;" contenteditable="true">${safeWebsite}</div>
              </div>
            </div>
            ${mailingZoneHTML}
          </div>
        `;
      }

      // Marketing fields overlay (coupon code, expiration date, call tracking)
      let marketingHTML = '';
      const couponCode = currentDesign.couponCode || '';
      const expirationDate = currentDesign.expirationDate || '';
      const callTrackingNumber = currentDesign.callTrackingNumber || '';

      if (couponCode || expirationDate || callTrackingNumber) {
        marketingHTML = `
          <div style="position: absolute; top: 5px; right: 5px; background: ${safeAccent}; color: ${safePrimary}; padding: 4px 8px; border-radius: 4px; font-size: 8px; font-weight: 700; z-index: 5; text-align: center; line-height: 1.4; word-wrap: break-word; max-width: 120px;">
            ${couponCode ? `<div>Use Code: <span style="font-size: 10px;">${couponCode}</span></div>` : ''}
            ${expirationDate ? `<div style="opacity: 0.85;">Expires: ${new Date(expirationDate).toLocaleDateString()}</div>` : ''}
            ${callTrackingNumber ? `<div style="margin-top: 2px;"><span style="font-size: 9px;">ðŸ“ž ${callTrackingNumber}</span></div>` : ''}
          </div>
        `;
      }

      // Social Media Icons
      let socialHTML = '';
      if (currentDesign.showSocialIcons && currentDesign.socialLinks) {
        const { facebook, instagram, googleReview } = currentDesign.socialLinks;
        if (facebook || instagram || googleReview) {
          socialHTML = `
            <div style="position: absolute; top: 5px; left: 5px; display: flex; gap: 4px; z-index: 5;">
              ${facebook ? `<span style="font-size: 12px;" title="Facebook">ðŸ“˜</span>` : ''}
              ${instagram ? `<span style="font-size: 12px;" title="Instagram">ðŸ“·</span>` : ''}
              ${googleReview ? `<span style="font-size: 12px;" title="Google Reviews">â­</span>` : ''}
            </div>
          `;
        }
      }

      // Certification Badges
      let certHTML = '';
      if (currentDesign.certBadges) {
        const badges = [];
        if (currentDesign.certBadges.bbb) badges.push('BBB A+');
        if (currentDesign.certBadges.angi) badges.push('Angi');
        if (currentDesign.certBadges.homeAdvisor) badges.push('HomeAdvisor');
        if (currentDesign.certBadges.yelp) badges.push('Yelp â­â­â­â­â­');
        if (currentDesign.certBadges.veteran) badges.push('ðŸŽ–ï¸ Veteran');
        if (currentDesign.certBadges.eco) badges.push('ðŸŒ¿ Eco');

        if (badges.length > 0) {
          certHTML = `
            <div style="position: absolute; bottom: 45%; right: 5px; display: flex; flex-direction: column; gap: 2px; z-index: 5;">
              ${badges.slice(0, 3).map(b => `<span style="font-size: 7px; background: white; border: 1px solid #ddd; padding: 2px 4px; border-radius: 3px; color: #333;">${b}</span>`).join('')}
            </div>
          `;
        }
      }

      // Service Area List
      let serviceAreaHTML = '';
      if (currentDesign.showServiceArea && currentDesign.serviceAreaCities) {
        serviceAreaHTML = `
          <div style="position: absolute; top: 50%; left: 5px; transform: translateY(-50%); font-size: 7px; color: #666; max-width: 80px; z-index: 5;">
            <div style="font-weight: 700; margin-bottom: 2px;">Serving:</div>
            <div style="line-height: 1.3;">${currentDesign.serviceAreaCities}</div>
          </div>
        `;
      }

      // EDDM Indicia
      let eddmHTML = '';
      if (currentDesign.eddmMode) {
        eddmHTML = `
          <div style="position: absolute; top: 5px; right: 45%; background: white; border: 1px solid #999; padding: 4px 8px; font-size: 7px; text-align: center; line-height: 1.3; z-index: 5;">
            <div style="font-weight: 700;">EDDM</div>
            <div>ECRWSS</div>
            <div style="margin-top: 2px;">LOCAL POSTAL CUSTOMER</div>
          </div>
        `;
      }

      document.getElementById('backCard').innerHTML = `
        <div class="postcard-back${qrClass}" style="background: white; position: relative; overflow: hidden; width: 100%; height: 100%; box-sizing: border-box;">
          ${backHTML}
          ${marketingHTML}
          ${socialHTML}
          ${certHTML}
          ${serviceAreaHTML}
          ${eddmHTML}
          <div id="uspsGuides" class="usps-guides">
            <div id="uspsPostage" class="usps-zone postage"><span class="usps-zone-label">Postage</span></div>
            <div id="uspsAddressing" class="usps-zone addressing"><span class="usps-zone-label">Address Area</span></div>
            <div id="uspsBarcode" class="usps-zone barcode"><span class="usps-zone-label">Barcode</span></div>
          </div>
        </div>
      `;

      // Update USPS zones if guides are visible
      if (document.getElementById('showUSPSGuides')?.checked) {
        setTimeout(updateUSPSZones, 0);
      }

      // Apply content scaling based on current size
      if (currentScale !== 1) {
        applyContentScale(currentScale);
      }

      // Remove QR codes if toggle is off
      if (!showQRCode) {
        // Hide elements with data-qr-container attribute only
        document.querySelectorAll('[data-qr-container]').forEach(el => el.style.display = 'none');
      }

      // Hide services checklist on front - moved to back per 80/20 visual rule
      document.querySelectorAll('.postcard-front').forEach(front => {
        front.querySelectorAll('[ondblclick*="services"]').forEach(el => {
          el.style.display = 'none';
        });
      });

      // Update existing trust text in ALL layouts to include shield icon
      document.querySelectorAll('.postcard-front').forEach(front => {
        // Find any existing "Licensed" text and enhance it
        front.querySelectorAll('[contenteditable="true"]').forEach(el => {
          const text = el.textContent || '';
          if (text.includes('Licensed') && !text.includes('ðŸ›¡ï¸')) {
            el.innerHTML = 'ðŸ›¡ï¸ ' + el.innerHTML;
          }
        });

        // Find text nodes containing "Licensed" in non-editable elements
        front.querySelectorAll('p, span, div').forEach(el => {
          if (el.children.length === 0 && el.textContent.includes('Licensed') && !el.textContent.includes('ðŸ›¡ï¸')) {
            el.innerHTML = 'ðŸ›¡ï¸ ' + el.innerHTML;
          }
        });
      });

      // Reapply logo size from currentDesign to ensure slider value is respected
      const logoSizeVal = currentDesign.logoSize || 40;
      document.querySelectorAll('.postcard-front img[src*="logo"], .postcard-front img[src="logo.png"], .postcard-back img[src*="logo"], .postcard-back img[src="logo.png"]').forEach(img => {
        img.style.height = logoSizeVal + 'px';
      });
      if (currentDesign.logoUrl) {
        document.querySelectorAll(`img[src="${currentDesign.logoUrl}"]`).forEach(img => {
          img.style.height = logoSizeVal + 'px';
        });
      }
      // Sync slider UI
      const logoSlider = document.getElementById('logoSizeSlider');
      const logoSizeDisplay = document.getElementById('logoSizeValue');
      if (logoSlider) logoSlider.value = logoSizeVal;
      if (logoSizeDisplay) logoSizeDisplay.textContent = logoSizeVal + 'px';

      // ===== ADD DYNAMIC OVERLAYS =====

      // Add Watermark if enabled
      document.querySelectorAll('.watermark-overlay').forEach(el => el.remove());
      if (currentDesign.showWatermark) {
        const style = currentDesign.watermarkStyle || 'diagonal';
        document.querySelectorAll('.postcard-front, .postcard-back').forEach(card => {
          const watermark = document.createElement('div');
          watermark.className = `watermark-overlay ${style}`;
          if (style === 'tiled') {
            watermark.innerHTML = '<span>PROOF</span><span>PROOF</span><span>PROOF</span><span>PROOF</span><span>PROOF</span><span>PROOF</span>';
          } else {
            watermark.innerHTML = '<span>PROOF</span>';
          }
          card.appendChild(watermark);
        });
      }

      // Add Guarantee Badge if enabled
      document.querySelectorAll('.guarantee-badge').forEach(el => el.remove());
      if (currentDesign.showGuarantee) {
        const guaranteeTexts = {
          satisfaction: '100% Satisfaction Guaranteed',
          moneyback: 'Money-Back Guarantee',
          pricematch: 'Price Match Guarantee',
          quality: 'Quality Workmanship',
          ontime: 'On-Time or Free'
        };
        const text = guaranteeTexts[currentDesign.guaranteeType] || guaranteeTexts.satisfaction;
        document.querySelectorAll('.postcard-front').forEach(card => {
          const badge = document.createElement('div');
          badge.className = 'guarantee-badge';
          badge.innerHTML = `<span style="margin-right:4px;">âœ“</span>${text}`;
          card.appendChild(badge);
        });
      }

      // Add Emergency Badge if enabled
      document.querySelectorAll('.emergency-badge').forEach(el => el.remove());
      if (currentDesign.showEmergency) {
        const emergencyTexts = {
          '247': '24/7 Emergency Service',
          'sameday': 'Same-Day Service',
          'weekend': 'Weekend Appointments',
          'rapid': 'Rapid Response'
        };
        const text = emergencyTexts[currentDesign.emergencyType] || emergencyTexts['247'];
        document.querySelectorAll('.postcard-front').forEach(card => {
          const badge = document.createElement('div');
          badge.className = 'emergency-badge';
          badge.innerHTML = `<span style="margin-right:4px;">ðŸš¨</span>${text}`;
          card.appendChild(badge);
        });
      }

      // Add Referral Box if enabled
      document.querySelectorAll('.referral-box').forEach(el => el.remove());
      if (currentDesign.showReferral) {
        const amount = currentDesign.referralAmount || '25';
        const type = currentDesign.referralType || 'both';
        let text = '';
        if (type === 'both') text = `Refer a Friend - You BOTH Get $${amount} Off!`;
        else if (type === 'referrer') text = `Refer a Friend & Get $${amount} Off!`;
        else text = `New Customers Get $${amount} Off!`;

        document.querySelectorAll('.postcard-back').forEach(card => {
          const box = document.createElement('div');
          box.className = 'referral-box';
          box.innerHTML = `<strong>ðŸŽ ${text}</strong>`;
          card.appendChild(box);
        });
      }

      // Add Bundle Deal if enabled
      document.querySelectorAll('.bundle-deal-box').forEach(el => el.remove());
      if (currentDesign.showBundleDeal) {
        const bundleTexts = {
          'weekly-chemical': 'ðŸ“¦ Weekly + Chemicals = 15% Off!',
          'cleaning-repair': 'ðŸ“¦ Cleaning + Repair = $50 Off!',
          'annual': 'ðŸ“¦ Annual Contract = 1 Month Free!',
          'custom': 'ðŸ“¦ Bundle & Save!'
        };
        const text = bundleTexts[currentDesign.bundleType] || bundleTexts['weekly-chemical'];
        document.querySelectorAll('.postcard-back').forEach(card => {
          const box = document.createElement('div');
          box.className = 'bundle-deal-box';
          box.innerHTML = text;
          card.appendChild(box);
        });
      }

      // Apply custom fonts if set
      if (currentDesign.headlineFont) {
        document.querySelectorAll('.postcard-front h1, .postcard-back h1').forEach(el => {
          el.style.fontFamily = `'${currentDesign.headlineFont}', sans-serif`;
        });
      }
      if (currentDesign.bodyFont) {
        document.querySelectorAll('.postcard-front p, .postcard-back p').forEach(el => {
          el.style.fontFamily = `'${currentDesign.bodyFont}', sans-serif`;
        });
      }

      // Apply image filters if set
      if (currentDesign.imageFilters) {
        const { brightness, contrast, saturation } = currentDesign.imageFilters;
        document.querySelectorAll('.postcard-front [style*="background: url"], .postcard-front [style*="background:url"]').forEach(el => {
          el.style.filter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%)`;
        });
      }

      // Apply border style if set
      if (currentDesign.borderStyle && currentDesign.borderStyle.style !== 'none') {
        applyBorderStyle(currentDesign.borderStyle.style);
      }

      // ===== HIDE QR CODE IF DISABLED =====
      const qrEnabled = (document.getElementById('showQRCode')?.checked ?? true) && (currentDesign.showQRCode !== false);
      if (!qrEnabled) {
        // Add hide-qr class to postcards
        document.querySelectorAll('.postcard').forEach(card => {
          card.classList.add('hide-qr');
        });
        document.querySelectorAll('.postcard-front, .postcard-back').forEach(card => {
          card.classList.add('hide-qr');
          // Also directly hide QR images and their containers
          card.querySelectorAll('img').forEach(img => {
            if (img.src && (img.src.includes('qr') || img.src.includes('QR') || img.src.endsWith('qrcode.png'))) {
              img.style.display = 'none';
              if (img.parentElement && img.parentElement.tagName === 'DIV') {
                img.parentElement.style.display = 'none';
              }
            }
          });
        });
      } else {
        // Remove hide-qr class
        document.querySelectorAll('.postcard, .postcard-front, .postcard-back').forEach(card => {
          card.classList.remove('hide-qr');
        });
      }

      // ===== AUTO-RESIZE DISCOUNT BADGES TO FIT TEXT =====
      // Use setTimeout to ensure DOM has fully rendered
      setTimeout(autoResizeDiscountBadges, 50);
      setTimeout(() => {
        autoFitText(document.querySelector('.postcard-front'));
        autoFitText(document.querySelector('.postcard-back'));
      }, 80);
    }

    // Batch read/write to avoid layout thrashing
    function autoResizeDiscountBadges() {
      const BADGE_SIZE = 85;
      const badges = document.querySelectorAll('.discount');
      if (!badges.length) return;

      // Phase 1: READ all geometry
      const measurements = [];
      for (const badge of badges) {
        const postcard = badge.closest('.postcard-front, .postcard-back');
        measurements.push({
          badge,
          postcard,
          postcardRect: postcard?.getBoundingClientRect(),
          badgeRect: badge.getBoundingClientRect(),
        });
      }

      // Phase 2: WRITE all styles (no reads)
      document.querySelectorAll('.postcard-front, .postcard-back').forEach(card => {
        card.style.setProperty('overflow', 'hidden', 'important');
        card.style.setProperty('position', 'relative', 'important');
      });

      for (const { badge, postcardRect, badgeRect } of measurements) {
        const isCircular = badge.style.borderRadius === '50%';
        const isOnFront = !!badge.closest('.postcard-front');
        if (isCircular && isOnFront) {
          badge.style.setProperty('width', BADGE_SIZE + 'px', 'important');
          badge.style.setProperty('height', BADGE_SIZE + 'px', 'important');
          badge.style.setProperty('max-width', '80px', 'important');
          badge.style.setProperty('max-height', '80px', 'important');
        }
        badge.style.setProperty('overflow', 'hidden', 'important');
        badge.style.setProperty('box-sizing', 'border-box', 'important');
        badge.style.setProperty('flex-shrink', '0', 'important');

        if (postcardRect) {
          if (badgeRect.right > postcardRect.right)
            badge.style.setProperty('right', Math.max(10, parseInt(badge.style.right) || 0) + 'px', 'important');
          if (badgeRect.left < postcardRect.left)
            badge.style.setProperty('left', '10px', 'important');
          if (badgeRect.bottom > postcardRect.bottom) {
            badge.style.setProperty('bottom', '10px', 'important');
            badge.style.removeProperty('top');
          }
          if (badgeRect.top < postcardRect.top)
            badge.style.setProperty('top', '10px', 'important');
        }

        for (const el of badge.querySelectorAll('[contenteditable="true"], span, div')) {
          if (!el.style) continue;
          el.style.cssText += ';white-space:normal!important;word-break:break-word!important;overflow:hidden!important;text-overflow:ellipsis!important;max-width:100%!important;line-height:1.1!important;display:flex!important;align-items:center!important;justify-content:center!important;text-align:center!important;';
        }
      }

      // Phase 3: Shrink text that overflows its badge
      requestAnimationFrame(() => {
        for (const badge of badges) {
          const spans = badge.querySelectorAll('span[contenteditable], div[contenteditable]');
          for (const span of spans) {
            let size = parseFloat(getComputedStyle(span).fontSize);
            const minSize = 7;
            while (span.scrollWidth > span.clientWidth + 1 && size > minSize) {
              size -= 0.5;
              span.style.fontSize = size + 'px';
            }
            while (span.scrollHeight > span.clientHeight + 1 && size > minSize) {
              size -= 0.5;
              span.style.fontSize = size + 'px';
            }
          }
        }
      });
    }

    // Toggle sidebar sections
    function toggleSection(header) {
      header.classList.toggle('collapsed');
      const content = header.nextElementSibling;
      if (content && content.classList.contains('section-content')) {
        content.classList.toggle('collapsed');
      }
    }

    window.showSide = function showSide(side, btn) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('frontCard').classList.toggle('hidden', side !== 'front');
      document.getElementById('backCard').classList.toggle('hidden', side !== 'back');
    }

    function toggleLogoWhiteBox(enabled) {
      currentDesign.logoWhiteBox = enabled;
      saveUserInfo();
      renderPostcard();
    }

    function handleLogoUpload(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          currentDesign.logoUrl = e.target.result;
          document.getElementById('logoPreview').innerHTML = '<img src="' + e.target.result + '" style="width:100%;height:100%;object-fit:contain;">';
          saveUserInfo();
          renderPostcard();
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function updateLogoSize(size) {
      const newSize = parseInt(size);
      currentDesign.logoSize = newSize;
      document.getElementById('logoSizeValue').textContent = size + 'px';

      // Directly update all logo images immediately for responsive feel
      document.querySelectorAll('.postcard-front img[src*="logo"], .postcard-front img[src="logo.png"], .postcard-back img[src*="logo"], .postcard-back img[src="logo.png"]').forEach(img => {
        img.style.height = newSize + 'px';
      });
      // Also update logos that use the logoUrl variable
      const logoUrl = currentDesign.logoUrl;
      if (logoUrl) {
        document.querySelectorAll(`img[src="${safeLogoUrl}"]`).forEach(img => {
          img.style.height = newSize + 'px';
        });
      }

      saveUserInfo();
    }

    function updateHeadlineText() {
      const mainText = document.getElementById('headlineMain').value;
      const subText = document.getElementById('headlineSub').value;

      // If both fields are cleared, unlock headline for shuffling
      if (!mainText && !subText) {
        locked.headline = false;
        savedTextContent.headlineMain = null;
        savedTextContent.headlineSub = null;
        updateLockIndicator();
        saveTextContent();
        return;
      }

      // Save whatever is typed (even partial)
      if (mainText) {
        currentDesign.headline.main = mainText;
        savedTextContent.headlineMain = mainText;
      } else {
        savedTextContent.headlineMain = null;
      }
      if (subText) {
        currentDesign.headline.sub = subText;
        savedTextContent.headlineSub = subText;
      } else {
        savedTextContent.headlineSub = null;
      }
      locked.headline = true;
      updateLockIndicator();
      saveTextContent();
      renderPostcard();
    }

    function syncHeadlineInputs() {
      const mainInput = document.getElementById('headlineMain');
      const subInput = document.getElementById('headlineSub');
      if (mainInput && currentDesign.headline) {
        // Only restore saved values if headline is locked
        if (locked.headline && savedTextContent.headlineMain) {
          mainInput.value = savedTextContent.headlineMain;
        } else {
          mainInput.value = '';
          mainInput.placeholder = currentDesign.headline.main || 'Main Headline';
        }
        if (locked.headline && savedTextContent.headlineSub) {
          subInput.value = savedTextContent.headlineSub;
        } else {
          subInput.value = '';
          subInput.placeholder = currentDesign.headline.sub || 'Sub Headline';
        }
      }
    }

    // Discount editor functions
    function updateDiscountFromSidebar() {
      // Strip newlines and extra whitespace from discount values
      const amount = document.getElementById('discountAmount').value.replace(/[\r\n]+/g, ' ').trim();
      const text = document.getElementById('discountText').value.replace(/[\r\n]+/g, ' ').trim();

      // If both fields are cleared, unlock discount for shuffling
      if (!amount && !text) {
        locked.discount = false;
        savedTextContent.discountAmount = null;
        savedTextContent.discountText = null;
        updateLockIndicator();
        saveTextContent();
        return;
      }

      // Save whatever is typed (with newlines stripped)
      if (amount) {
        currentDesign.discount.amount = amount;
        savedTextContent.discountAmount = amount;
      } else {
        savedTextContent.discountAmount = null;
      }
      if (text) {
        currentDesign.discount.text = text;
        savedTextContent.discountText = text;
      } else {
        savedTextContent.discountText = null;
      }
      locked.discount = true;
      updateLockIndicator();
      saveTextContent();
      renderPostcard();
    }

    function updateDiscountSize(value) {
      document.getElementById('discountSizeValue').textContent = value + '%';
      // Only scale circular discount badges, leave rectangular ones alone
      const scale = value / 100;
      document.querySelectorAll('.postcard-front .discount').forEach(el => {
        const style = el.getAttribute('style') || '';
        const isCircular = style.includes('border-radius: 50%') || style.includes('border-radius:50%');

        if (isCircular) {
          // Scale circular badges
          const baseSize = 80;
          const newSize = Math.round(baseSize * scale);
          el.style.width = newSize + 'px';
          el.style.height = newSize + 'px';
        }

        // Scale font sizes for all discount badges
        const amountEl = el.querySelector('span:first-child, div:first-child');
        const textEl = el.querySelector('span:last-child, div:last-child');
        if (amountEl && amountEl !== textEl) {
          const baseFontSize = parseInt(amountEl.style.fontSize) || 16;
          amountEl.style.fontSize = Math.round(baseFontSize * scale) + 'px';
        }
        if (textEl) {
          const baseFontSize = parseInt(textEl.style.fontSize) || 8;
          textEl.style.fontSize = Math.round(baseFontSize * scale) + 'px';
        }
      });
      // Re-check sizes after scaling to ensure text still fits
      setTimeout(autoResizeDiscountBadges, 50);
    }

    function syncDiscountInputs() {
      const amountInput = document.getElementById('discountAmount');
      const textInput = document.getElementById('discountText');
      if (amountInput && currentDesign.discount) {
        // Only restore saved values if discount is locked
        if (locked.discount && savedTextContent.discountAmount) {
          const cleanAmount = savedTextContent.discountAmount.replace(/[\r\n]+/g, ' ').trim();
          amountInput.value = cleanAmount;
          // Also fix the stored value and current design
          savedTextContent.discountAmount = cleanAmount;
          currentDesign.discount.amount = cleanAmount;
        } else {
          amountInput.value = '';
          amountInput.placeholder = currentDesign.discount.amount || '$50 OFF';
        }
        if (locked.discount && savedTextContent.discountText) {
          const cleanText = savedTextContent.discountText.replace(/[\r\n]+/g, ' ').trim();
          textInput.value = cleanText;
          // Also fix the stored value and current design
          savedTextContent.discountText = cleanText;
          currentDesign.discount.text = cleanText;
        } else {
          textInput.value = '';
          textInput.placeholder = currentDesign.discount.text || 'First Month';
        }
      }
    }

    // Services editor functions
    function updateServicesFromSidebar() {
      const inputs = document.querySelectorAll('.service-input');
      const filledServices = [];

      inputs.forEach(input => {
        const value = input.value.trim();
        if (value) {
          filledServices.push(value);
        }
      });

      // If all services are cleared, unlock for shuffling
      if (filledServices.length === 0) {
        locked.services = false;
        savedTextContent.services = null;
        updateLockIndicator();
        saveTextContent();
        return;
      }

      // Save exactly what user typed
      currentDesign.services = filledServices;
      savedTextContent.services = filledServices;
      locked.services = true;
      updateLockIndicator();
      saveTextContent();
      renderPostcard();
    }

    function addServiceInput() {
      const editor = document.getElementById('servicesEditor');
      const count = editor.querySelectorAll('.service-input').length;
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'compact-input service-input';
      input.placeholder = `Service ${count + 1}`;
      input.oninput = updateServicesFromSidebar;
      editor.appendChild(input);
    }

    function syncServicesInputs() {
      const inputs = document.querySelectorAll('.service-input');

      if (locked.services && savedTextContent.services && savedTextContent.services.length > 0) {
        // Restore user-typed values only if locked
        savedTextContent.services.forEach((service, i) => {
          if (inputs[i]) {
            inputs[i].value = service;
          }
        });
      } else if (currentDesign.services) {
        // Show placeholders for random services
        currentDesign.services.forEach((service, i) => {
          if (inputs[i]) {
            inputs[i].value = '';
            inputs[i].placeholder = service;
          }
        });
      }
    }

    // Testimonial editor functions
    function updateTestimonialFromSidebar() {
      const text = document.getElementById('testimonialText').value;
      const author = document.getElementById('testimonialAuthor').value;

      // If both fields are cleared, unlock for shuffling
      if (!text && !author) {
        locked.testimonial = false;
        savedTextContent.testimonialText = null;
        savedTextContent.testimonialAuthor = null;
        updateLockIndicator();
        saveTextContent();
        return;
      }

      // Save whatever is typed
      if (text) {
        currentDesign.testimonial.text = text;
        savedTextContent.testimonialText = text;
      } else {
        savedTextContent.testimonialText = null;
      }
      if (author) {
        currentDesign.testimonial.author = author;
        savedTextContent.testimonialAuthor = author;
      } else {
        savedTextContent.testimonialAuthor = null;
      }
      locked.testimonial = true;
      updateLockIndicator();
      saveTextContent();
      renderPostcard();
    }

    function syncTestimonialInputs() {
      const textInput = document.getElementById('testimonialText');
      const authorInput = document.getElementById('testimonialAuthor');
      if (textInput && currentDesign.testimonial) {
        // Only restore saved values if testimonial is locked
        if (locked.testimonial && savedTextContent.testimonialText) {
          textInput.value = savedTextContent.testimonialText;
        } else {
          textInput.value = '';
          textInput.placeholder = currentDesign.testimonial.text || 'Customer testimonial...';
        }
        if (locked.testimonial && savedTextContent.testimonialAuthor) {
          authorInput.value = savedTextContent.testimonialAuthor;
        } else {
          authorInput.value = '';
          authorInput.placeholder = currentDesign.testimonial.author || 'â€” Customer Name';
        }
      }
    }

    // Urgency & CTA editor functions
    function updateUrgencyFromSidebar() {
      const text = document.getElementById('urgencyText').value;

      // If cleared, unlock for shuffling
      if (!text) {
        locked.urgency = false;
        savedTextContent.urgency = null;
        updateLockIndicator();
        saveTextContent();
        return;
      }

      currentDesign.urgency = text;
      savedTextContent.urgency = text;
      locked.urgency = true;
      updateLockIndicator();
      saveTextContent();
      renderPostcard();
    }

    function updateCtaFromSidebar() {
      const text = document.getElementById('ctaText').value;

      // If cleared, unlock for shuffling
      if (!text) {
        locked.cta = false;
        savedTextContent.cta = null;
        updateLockIndicator();
        saveTextContent();
        return;
      }

      currentDesign.cta = text;
      savedTextContent.cta = text;
      locked.cta = true;
      updateLockIndicator();
      saveTextContent();
      renderPostcard();
    }

    function syncUrgencyCtaInputs() {
      const urgencyInput = document.getElementById('urgencyText');
      const ctaInput = document.getElementById('ctaText');
      // Only restore saved values if locked
      if (urgencyInput) {
        if (locked.urgency && savedTextContent.urgency) {
          urgencyInput.value = savedTextContent.urgency;
        } else {
          urgencyInput.value = '';
          urgencyInput.placeholder = currentDesign.urgency || 'Limited Time!';
        }
      }
      if (ctaInput) {
        if (locked.cta && savedTextContent.cta) {
          ctaInput.value = savedTextContent.cta;
        } else {
          ctaInput.value = '';
          ctaInput.placeholder = currentDesign.cta || 'Call Now!';
        }
      }
    }

    // Sync all sidebar inputs with current design
    function syncAllSidebarInputs() {
      syncHeadlineInputs();
      syncDiscountInputs();
      syncServicesInputs();
      syncTestimonialInputs();
      syncUrgencyCtaInputs();
    }

    function handleQRUpload(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          currentDesign.qrUrl = e.target.result;
          const container = document.getElementById('qrPreviewContainer');
          const display = document.getElementById('qrCodeDisplay');
          if (container) container.style.display = 'block';
          if (display) display.innerHTML = '<img src="' + e.target.result + '" style="max-width:80px;max-height:80px;">';
          saveUserInfo();
          renderPostcard();
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    // QR Code Generator
    let qrCodeInstance = null;

    function updateQRPlaceholder() {
      const type = document.getElementById('qrType').value;
      const input = document.getElementById('qrContent');

      const placeholders = {
        'url': 'https://yourwebsite.com',
        'phone': '(555) 123-4567',
        'sms': '(555) 123-4567',
        'email': 'info@yourcompany.com',
        'text': 'Your custom message here'
      };

      input.placeholder = placeholders[type] || 'Enter content';

      // Auto-fill from form fields if available
      if (type === 'url') {
        const website = document.getElementById('website').value;
        if (website && !input.value) {
          input.value = website.startsWith('http') ? website : 'https://' + website;
        }
      } else if (type === 'phone' || type === 'sms') {
        const phone = document.getElementById('phoneNumber').value;
        if (phone && !input.value) {
          input.value = phone;
        }
      }
    }

    function generateQRCode() {
      const type = document.getElementById('qrType').value;
      let content = document.getElementById('qrContent').value.trim();

      if (!content) {
        return;
      }

      // Format content based on type
      let qrData = content;
      switch (type) {
        case 'url':
          if (!content.startsWith('http://') && !content.startsWith('https://')) {
            qrData = 'https://' + content;
          }
          break;
        case 'phone':
          // Format: tel:+1234567890
          const phoneClean = content.replace(/[^\d+]/g, '');
          qrData = 'tel:' + phoneClean;
          break;
        case 'sms':
          // Format: sms:+1234567890
          const smsClean = content.replace(/[^\d+]/g, '');
          qrData = 'sms:' + smsClean;
          break;
        case 'email':
          // Format: mailto:email@example.com
          qrData = 'mailto:' + content;
          break;
        case 'text':
          qrData = content;
          break;
      }

      // Clear previous QR code
      const qrContainer = document.getElementById('qrCodeDisplay');
      qrContainer.innerHTML = '';

      // Generate new QR code
      try {
        qrCodeInstance = new QRCode(qrContainer, {
          text: qrData,
          width: 100,
          height: 100,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });

        // Show the preview container
        document.getElementById('qrPreviewContainer').style.display = 'block';

        // Wait for QR code to render, then get the image data
        setTimeout(() => {
          const qrImg = qrContainer.querySelector('img');
          if (qrImg) {
            currentDesign.qrUrl = qrImg.src;
            saveUserInfo();
            renderPostcard();
          } else {
            // Fallback to canvas
            const qrCanvas = qrContainer.querySelector('canvas');
            if (qrCanvas) {
              currentDesign.qrUrl = qrCanvas.toDataURL('image/png');
              saveUserInfo();
              renderPostcard();
            }
          }
        }, 100);

      } catch (err) {
        console.error('QR Code generation failed:', err);
        alert('Failed to generate QR code. Please check your input.');
      }
    }

    function clearQRCode() {
      document.getElementById('qrContent').value = '';
      document.getElementById('qrCodeDisplay').innerHTML = '';
      document.getElementById('qrPreviewContainer').style.display = 'none';
      currentDesign.qrUrl = '';
      renderPostcard();
    }

    // Toggle QR Code visibility on postcard
    function toggleQRCodeVisibility(show) {
      currentDesign.showQRCode = show;
      saveUserInfo();

      // Add/remove hide-qr class to postcards
      document.querySelectorAll('.postcard').forEach(card => {
        if (show) {
          card.classList.remove('hide-qr');
        } else {
          card.classList.add('hide-qr');
        }
      });

      document.querySelectorAll('.postcard-front, .postcard-back').forEach(card => {
        if (show) {
          card.classList.remove('hide-qr');
        } else {
          card.classList.add('hide-qr');
        }

        // Also directly hide/show QR elements
        card.querySelectorAll('img').forEach(img => {
          if (img.src && (img.src.includes('qr') || img.src.includes('QR') || img.src.endsWith('qrcode.png'))) {
            img.style.display = show ? '' : 'none';
            // Also hide parent container
            if (img.parentElement && img.parentElement.tagName === 'DIV') {
              img.parentElement.style.display = show ? '' : 'none';
            }
          }
        });
      });

      renderPostcard();
    }

    // Completely remove QR code
    function removeQRCode() {
      // Uncheck the show QR checkbox
      document.getElementById('showQRCode').checked = false;

      // Clear the QR content
      document.getElementById('qrContent').value = '';
      document.getElementById('qrCodeDisplay').innerHTML = '';
      document.getElementById('qrPreviewContainer').style.display = 'none';

      // Clear from design
      currentDesign.qrUrl = '';
      currentDesign.showQRCode = false;

      // Add hide-qr class
      document.querySelectorAll('.postcard').forEach(card => {
        card.classList.add('hide-qr');
      });

      // Remove from postcards - more aggressive removal
      document.querySelectorAll('.postcard-front, .postcard-back').forEach(card => {
        card.classList.add('hide-qr');

        // Find and remove ALL QR-related elements
        card.querySelectorAll('img').forEach(img => {
          if (img.src && (img.src.includes('qr') || img.src.includes('QR') || img.src.endsWith('qrcode.png'))) {
            // Remove the parent container
            const parent = img.parentElement;
            if (parent) {
              parent.style.display = 'none';
              parent.remove();
            }
          }
        });
      });

      saveUserInfo();
      renderPostcard();
    }

    let customPoolImage = null;

    function handlePoolUpload(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          customPoolImage = e.target.result;
          currentDesign.poolImage = e.target.result;
          locked.poolImage = true;
          document.getElementById('poolPreview').innerHTML = '<img src="' + e.target.result + '" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">';
          document.getElementById('poolImageIndex').textContent = 'Custom';
          updateLockIndicator();
          saveUserInfo();
          renderPostcard();
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function clearPoolImage() {
      customPoolImage = null;
      locked.poolImage = false;
      currentDesign.poolImage = random(poolImages);
      document.getElementById('poolPreview').innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M2 10h20"/></svg>';
      updateLockIndicator();
      updatePoolImageIndex();
      saveUserInfo();
      renderPostcard();
    }

    let currentPoolIndex = 0;

    function nextPoolImage() {
      if (customPoolImage) {
        clearPoolImage();
      }
      currentPoolIndex = (currentPoolIndex + 1) % poolImages.length;
      currentDesign.poolImage = poolImages[currentPoolIndex];
      updatePoolImagePreview(); // Update thumbnail immediately
      renderPostcard();
    }

    function prevPoolImage() {
      if (customPoolImage) {
        clearPoolImage();
      }
      currentPoolIndex = (currentPoolIndex - 1 + poolImages.length) % poolImages.length;
      currentDesign.poolImage = poolImages[currentPoolIndex];
      updatePoolImagePreview(); // Update thumbnail immediately
      renderPostcard();
    }

    function updatePoolImageIndex() {
      const indexEl = document.getElementById('poolImageIndex');
      if (customPoolImage) {
        indexEl.textContent = 'Custom';
      } else {
        // Find current index from poolImages array
        const idx = poolImages.indexOf(currentDesign.poolImage);
        if (idx >= 0) {
          currentPoolIndex = idx;
          indexEl.textContent = `#${idx + 1} of ${poolImages.length}`;
        } else {
          indexEl.textContent = 'Random';
        }
      }
    }

    function updatePoolImagePreview() {
      const preview = document.getElementById('poolPreview');
      const indexEl = document.getElementById('poolImageIndex');
      if (currentDesign.poolImage && !customPoolImage) {
        preview.innerHTML = '<img src="' + currentDesign.poolImage + '" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">';
        const idx = poolImages.indexOf(currentDesign.poolImage);
        indexEl.textContent = idx >= 0 ? `#${idx + 1} of ${poolImages.length}` : 'Random';
      }
    }

    // ==================== IMAGE MANAGER ====================
    // Delete the currently displayed pool image
    function deleteCurrentPoolImage() {
      if (customPoolImage) {
        // If using a custom uploaded image, just clear it
        clearPoolImage();
        return;
      }

      const currentImage = currentDesign.poolImage;
      if (!currentImage || !poolImages.includes(currentImage)) {
        return;
      }

      // Add to deleted list
      if (!deletedPoolImages.includes(currentImage)) {
        deletedPoolImages.push(currentImage);
        saveDeletedImages();
      }

      // Remove from working pool images
      const idx = poolImages.indexOf(currentImage);
      poolImages.splice(idx, 1);

      // If no images left, reset
      if (poolImages.length === 0) {
        alert('Cannot delete all images. Resetting to original pool.');
        resetPoolImages();
        return;
      }

      // Move to next image
      currentPoolIndex = currentPoolIndex % poolImages.length;
      currentDesign.poolImage = poolImages[currentPoolIndex];
      updatePoolImagePreview();
      updatePoolImageIndex();
      renderPostcard();
      renderImageManager();
    }

    // Delete a specific pool image by URL
    function deletePoolImage(url) {
      if (!poolImages.includes(url)) return;

      // Add to deleted list
      if (!deletedPoolImages.includes(url)) {
        deletedPoolImages.push(url);
        saveDeletedImages();
      }

      // Remove from working pool images
      poolImages = poolImages.filter(img => img !== url);

      // If no images left, reset
      if (poolImages.length === 0) {
        alert('Cannot delete all images. Resetting to original pool.');
        resetPoolImages();
        return;
      }

      // If current image was deleted, pick a new one
      if (currentDesign.poolImage === url) {
        currentPoolIndex = currentPoolIndex % poolImages.length;
        currentDesign.poolImage = poolImages[currentPoolIndex];
        updatePoolImagePreview();
        renderPostcard();
      }

      updatePoolImageIndex();
      renderImageManager();
    }

    // Reset all pool images back to original
    function resetPoolImages() {
      deletedPoolImages = [];
      poolImages = [...originalPoolImages];
      saveDeletedImages();
      currentPoolIndex = 0;
      currentDesign.poolImage = poolImages[currentPoolIndex];
      updatePoolImagePreview();
      updatePoolImageIndex();
      renderPostcard();
      renderImageManager();
    }

    // Save deleted images to localStorage
    function saveDeletedImages() {
      localStorage.setItem('deletedPoolImages', JSON.stringify(deletedPoolImages));
    }

    // Load deleted images from localStorage
    function loadDeletedImages() {
      const saved = localStorage.getItem('deletedPoolImages');
      if (saved) {
        try {
          deletedPoolImages = JSON.parse(saved);
          // Filter out deleted images from working pool
          poolImages = originalPoolImages.filter(img => !deletedPoolImages.includes(img));
          // Make sure we have at least some images
          if (poolImages.length === 0) {
            poolImages = [...originalPoolImages];
            deletedPoolImages = [];
            saveDeletedImages();
          }
        } catch (e) {
          console.log('Error loading deleted images:', e);
        }
      }
    }

    // Render the image manager grid in Tools panel
    function renderImageManager() {
      const container = document.getElementById('imageManager');
      const countEl = document.getElementById('imageCount');
      if (!container) return;

      countEl.textContent = poolImages.length;

      container.innerHTML = poolImages.map((url, index) => `
        <div style="position:relative;aspect-ratio:1;border-radius:4px;overflow:hidden;background:#222;">
          <img src="${url}" style="width:100%;height:100%;object-fit:cover;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2212%22>Error</text></svg>'">
          <button onclick="deletePoolImage('${url}')" style="position:absolute;top:2px;right:2px;width:18px;height:18px;border-radius:50%;background:rgba(220,53,69,0.9);border:none;color:white;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1;" title="Remove image">&times;</button>
          <span style="position:absolute;bottom:2px;left:2px;background:rgba(0,0,0,0.7);color:white;font-size:8px;padding:1px 4px;border-radius:2px;">#${index + 1}</span>
        </div>
      `).join('');
    }

    function changeLayout(layout) {
      currentDesign.layout = layout;
      locked.layout = true;
      updateLockIndicator();
      updateLayoutDisplay();
      renderPostcard();
    }

    function updateLayoutDisplay() {
      const layoutNames = {
        // Direct Mail USPS
        'clearRipples': 'Clear Ripples Pro', 'directMailPro': 'Direct Mail Pro',
        'eddmStandard': 'EDDM Standard', 'addressedMail': 'Addressed Mail',
        // Professional
        'premium': 'Premium', 'hero': 'Hero Focal', 'directResponse': 'Direct Response',
        'cleanModern': 'Clean Modern', 'luxury': 'Luxury', 'corporate': 'Corporate',
        'executive': 'Executive', 'consulting': 'Consulting',
        // Classic
        'split': 'Split', 'overlay': 'Overlay', 'diagonal': 'Diagonal', 'framed': 'Framed',
        'minimal': 'Minimal', 'centered': 'Centered', 'asymmetric': 'Asymmetric', 'thirds': 'Rule of Thirds',
        // Creative
        'magazine': 'Magazine', 'polaroid': 'Polaroid', 'geometric': 'Geometric', 'bold': 'Bold',
        'wave': 'Wave', 'collage': 'Collage', 'mosaic': 'Mosaic', 'stacked': 'Stacked',
        // Modern
        'gradient': 'Gradient', 'glassmorphism': 'Glassmorphism', 'neon': 'Neon', 'duotone': 'Duotone',
        'brutalist': 'Brutalist', 'swiss': 'Swiss', 'techno': 'Techno', 'cyber': 'Cyber',
        // Vintage
        'retro': 'Retro', 'artDeco': 'Art Deco', 'postmark': 'Postmark', 'newspaper': 'Newspaper',
        'vintage': 'Vintage', 'classic': 'Classic', 'antique': 'Antique', 'sepia': 'Sepia',
        // Marketing
        'coupon': 'Coupon', 'ticket': 'Ticket', 'ribbon': 'Ribbon', 'spotlight': 'Spotlight',
        'comparison': 'Comparison', 'testimonialFocus': 'Testimonial', 'guarantee': 'Guarantee', 'urgentSale': 'Urgent Sale',
        // Themed
        'sunset': 'Sunset', 'nature': 'Nature', 'coastal': 'Coastal', 'tropical': 'Tropical',
        'elegant': 'Elegant', 'playful': 'Playful', 'industrial': 'Industrial', 'rustic': 'Rustic',
        // Shapes & Geometric
        'hexGrid': 'Hex Grid', 'diamondCut': 'Diamond Cut', 'circleFrame': 'Circle Frame', 'triangleSlice': 'Triangle Slice',
        'chevronStack': 'Chevron Stack', 'honeycomb': 'Honeycomb', 'prism': 'Prism', 'octagon': 'Octagon',
        'pentagonPop': 'Pentagon Pop', 'starBurst': 'Star Burst', 'arrowPoint': 'Arrow Point', 'shieldBadge': 'Shield Badge',
        'ribbonBanner': 'Ribbon Banner', 'cornerFold': 'Corner Fold', 'stepLadder': 'Step Ladder', 'pyramidStack': 'Pyramid Stack',
        // Dynamic Cuts
        'slashDivide': 'Slash Divide', 'curveSweep': 'Curve Sweep', 'zigzag': 'Zigzag', 'tornEdge': 'Torn Edge',
        'liquidBlob': 'Liquid Blob', 'mountainPeak': 'Mountain Peak', 'waveStack': 'Wave Stack', 'ribbonFlow': 'Ribbon Flow',
        'spiralCut': 'Spiral Cut', 'thunderBolt': 'Thunder Bolt', 'heartCurve': 'Heart Curve', 'splashZone': 'Splash Zone',
        'fireEdge': 'Fire Edge', 'iceShards': 'Ice Shards', 'cloudFloat': 'Cloud Float', 'sunRays': 'Sun Rays',
        // Premium Luxury
        'goldAccent': 'Gold Accent', 'marbleTouch': 'Marble Touch', 'velvetLux': 'Velvet Lux', 'champagne': 'Champagne',
        'blackGold': 'Black & Gold', 'roseGold': 'Rose Gold', 'platinumEdge': 'Platinum Edge', 'crystalClear': 'Crystal Clear',
        'diamondLux': 'Diamond Lux', 'pearlShine': 'Pearl Shine', 'bronzeAge': 'Bronze Age', 'silverLining': 'Silver Lining',
        'obsidianNight': 'Obsidian Night', 'ivoryTower': 'Ivory Tower', 'sapphireBlue': 'Sapphire Blue', 'emeraldCity': 'Emerald City',
        // Photo Focus
        'photoFrame': 'Photo Frame', 'polaroidStack': 'Polaroid Stack', 'filmStrip': 'Film Strip', 'windowPane': 'Window Pane',
        'galleryWall': 'Gallery Wall', 'spotlight3D': '3D Spotlight', 'lensFocus': 'Lens Focus', 'doubleExposure': 'Double Exposure',
        'vintageLens': 'Vintage Lens', 'bokehBlur': 'Bokeh Blur', 'splitScreen': 'Split Screen', 'triPanel': 'Tri Panel',
        'circularReveal': 'Circular Reveal', 'peelBack': 'Peel Back', 'stackedPhotos': 'Stacked Photos', 'photoMontage': 'Photo Montage',
        // Typography Bold
        'bigType': 'Big Type', 'verticalText': 'Vertical Text', 'overlappingText': 'Overlapping Text', 'outlineType': 'Outline Type',
        'shadowType': 'Shadow Type', 'cutoutText': 'Cutout Text', 'neonSign': 'Neon Sign', 'retroType': 'Retro Type',
        'scriptFlow': 'Script Flow', 'blockLetters': 'Block Letters', 'gradientText': 'Gradient Text', 'glitchType': 'Glitch Type',
        'typewriter': 'Typewriter', 'stencilType': 'Stencil Type', 'embossedText': 'Embossed Text', 'stackedType': 'Stacked Type',
        // Seasonal Pool
        'summerSplash': 'Summer Splash', 'springFresh': 'Spring Fresh', 'autumnWarm': 'Autumn Warm', 'winterCrisp': 'Winter Crisp',
        'poolParty': 'Pool Party', 'tropicalParadise': 'Tropical Paradise', 'desertOasis': 'Desert Oasis', 'sunsetSwim': 'Sunset Swim',
        'beachVibes': 'Beach Vibes', 'palmSunset': 'Palm Sunset', 'oceanWave': 'Ocean Wave', 'starryNight': 'Starry Night',
        'goldenHour': 'Golden Hour', 'mistyMorning': 'Misty Morning', 'rainbowBright': 'Rainbow Bright', 'neonNight': 'Neon Night',
        // 3D & Depth
        'isometric': 'Isometric', 'floatingCards': 'Floating Cards', 'layeredDepth': 'Layered Depth', 'shadowBox': 'Shadow Box',
        'popOut': 'Pop Out', 'foldedCorner': 'Folded Corner', 'paperCraft': 'Paper Craft', 'origami': 'Origami',
        'cubeStack': 'Cube Stack', 'sphereFloat': 'Sphere Float', 'ribbonTwist': 'Ribbon Twist', 'pageFlip': 'Page Flip',
        'cardFan': 'Card Fan', 'accordion': 'Accordion', 'stairStep': 'Stair Step', 'tunnelDepth': 'Tunnel Depth',
        // Pattern Based
        'dotMatrix': 'Dot Matrix', 'lineArt': 'Line Art', 'crosshatch': 'Crosshatch', 'circuitBoard': 'Circuit Board',
        'topographic': 'Topographic', 'waterRipple': 'Water Ripple', 'palmLeaves': 'Palm Leaves', 'tiledMosaic': 'Tiled Mosaic',
        'chevronPattern': 'Chevron Pattern', 'scalePattern': 'Scale Pattern', 'brickWall': 'Brick Wall', 'fishScale': 'Fish Scale',
        'arabesque': 'Arabesque', 'plaidCheck': 'Plaid Check', 'polkaDots': 'Polka Dots', 'stripeWave': 'Stripe Wave',
        // Unique Concepts
        'splitPersonality': 'Split Personality', 'beforeAfter': 'Before/After', 'puzzlePiece': 'Puzzle Piece', 'infographic': 'Infographic',
        'timeline': 'Timeline', 'mapStyle': 'Map Style', 'badgeHeavy': 'Badge Heavy', 'iconGrid': 'Icon Grid',
        'newspaperAd': 'Newspaper Ad', 'ticketStub': 'Ticket Stub', 'recipeCard': 'Recipe Card', 'postcardVintage': 'Postcard Vintage',
        'gameCard': 'Game Card', 'idBadge': 'ID Badge', 'couponBook': 'Coupon Book', 'eventFlyer': 'Event Flyer',
        // Pool Specific
        'poolsideView': 'Poolside View', 'underwaterBlue': 'Underwater Blue', 'splashAction': 'Splash Action', 'poolFloat': 'Pool Float',
        'divingBoard': 'Diving Board', 'infinityEdge': 'Infinity Edge', 'nightSwim': 'Night Swim', 'familyFun': 'Family Fun',
        'crystalWater': 'Crystal Water', 'tiledPool': 'Tiled Pool', 'palmReflection': 'Palm Reflection', 'poolPartyNight': 'Pool Party Night',
        'lazyRiver': 'Lazy River', 'waterfallEdge': 'Waterfall Edge', 'spaRetreat': 'Spa Retreat', 'olympicLanes': 'Olympic Lanes',
        // Bold & Impactful
        'megaBold': 'Mega Bold', 'contrastPop': 'Contrast Pop', 'neonGlow': 'Neon Glow', 'electricShock': 'Electric Shock',
        'fireSale': 'Fire Sale', 'iceBreaker': 'Ice Breaker', 'thunderStrike': 'Thunder Strike', 'explosionBurst': 'Explosion Burst',
        'spotlightHero': 'Spotlight Hero', 'redCarpet': 'Red Carpet', 'vipAccess': 'VIP Access', 'limitedEdition': 'Limited Edition',
        'flashSale': 'Flash Sale', 'grandOpening': 'Grand Opening', 'lastChance': 'Last Chance', 'actNow': 'Act Now',
        // Artistic
        'watercolor': 'Watercolor', 'oilPaint': 'Oil Paint', 'sketchStyle': 'Sketch Style', 'comicBook': 'Comic Book',
        'popArt': 'Pop Art', 'abstractArt': 'Abstract Art', 'minimalistArt': 'Minimalist Art', 'geometricArt': 'Geometric Art',
        'brushStroke': 'Brush Stroke', 'inkSplash': 'Ink Splash', 'charcoalDraw': 'Charcoal Draw', 'pastelDream': 'Pastel Dream',
        'acrylicPour': 'Acrylic Pour', 'mosaicArt': 'Mosaic Art', 'stainedGlass': 'Stained Glass', 'graffiti': 'Graffiti',
        // Trust Building
        'testimonialCard': 'Testimonial Card', 'reviewHighlight': 'Review Highlight', 'awardWinner': 'Award Winner', 'certifiedPro': 'Certified Pro',
        'familyOwned': 'Family Owned', 'localHero': 'Local Hero', 'communityChoice': 'Community Choice', 'guaranteeSeal': 'Guarantee Seal',
        'beforeAfterSplit': 'Before/After Split', 'statsShowcase': 'Stats Showcase', 'teamPhoto': 'Team Photo', 'yearsExperience': 'Years Experience',
        'satisfactionBadge': 'Satisfaction Badge', 'moneyBack': 'Money Back', 'freeQuote': 'Free Quote', 'noObligation': 'No Obligation'
      };
      const display = document.getElementById('layoutDisplay');
      if (display) display.textContent = layoutNames[currentDesign.layout] || currentDesign.layout;
    }

    function changeFont(font) {
      currentDesign.font = font;
      locked.font = true;
      updateLockIndicator();
      renderPostcard();
    }

    function populateFontSelect() {
      const select = document.getElementById('fontSelect');
      select.innerHTML = fonts.map(f => `<option value="${f}" ${f === currentDesign.font ? 'selected' : ''}>${f}</option>`).join('');
    }

    // Layout categories for organized dropdown
    const layoutCategories = {
      'USPS Mail Ready': ['clearRipples', 'directMailPro', 'eddmStandard', 'addressedMail'],
      'Professional': ['premium', 'hero', 'directResponse', 'cleanModern', 'luxury', 'corporate', 'executive', 'consulting'],
      'Classic': ['split', 'overlay', 'diagonal', 'framed', 'minimal', 'centered', 'asymmetric', 'thirds'],
      'Creative': ['magazine', 'polaroid', 'geometric', 'bold', 'wave', 'collage', 'mosaic', 'stacked'],
      'Modern': ['gradient', 'glassmorphism', 'neon', 'duotone', 'brutalist', 'swiss', 'techno', 'cyber'],
      'Vintage': ['retro', 'artDeco', 'postmark', 'newspaper', 'vintage', 'classic', 'antique', 'sepia'],
      'Marketing': ['coupon', 'ticket', 'ribbon', 'spotlight', 'comparison', 'testimonialFocus', 'guarantee', 'urgentSale'],
      'Themed': ['sunset', 'nature', 'coastal', 'tropical', 'elegant', 'playful', 'industrial', 'rustic'],
      'Shapes': ['hexGrid', 'diamondCut', 'circleFrame', 'triangleSlice', 'chevronStack', 'honeycomb', 'prism', 'octagon', 'pentagonPop', 'starBurst', 'arrowPoint', 'shieldBadge', 'ribbonBanner', 'cornerFold', 'stepLadder', 'pyramidStack'],
      'Dynamic Cuts': ['slashDivide', 'curveSweep', 'zigzag', 'tornEdge', 'liquidBlob', 'mountainPeak', 'waveStack', 'ribbonFlow', 'spiralCut', 'thunderBolt', 'heartCurve', 'splashZone', 'fireEdge', 'iceShards', 'cloudFloat', 'sunRays'],
      'Premium Luxury': ['goldAccent', 'marbleTouch', 'velvetLux', 'champagne', 'blackGold', 'roseGold', 'platinumEdge', 'crystalClear', 'diamondLux', 'pearlShine', 'bronzeAge', 'silverLining', 'obsidianNight', 'ivoryTower', 'sapphireBlue', 'emeraldCity'],
      'Photo Focus': ['photoFrame', 'polaroidStack', 'filmStrip', 'windowPane', 'galleryWall', 'spotlight3D', 'lensFocus', 'doubleExposure', 'vintageLens', 'bokehBlur', 'splitScreen', 'triPanel', 'circularReveal', 'peelBack', 'stackedPhotos', 'photoMontage'],
      'Typography': ['bigType', 'verticalText', 'overlappingText', 'outlineType', 'shadowType', 'cutoutText', 'neonSign', 'retroType', 'scriptFlow', 'blockLetters', 'gradientText', 'glitchType', 'typewriter', 'stencilType', 'embossedText', 'stackedType'],
      'Seasonal': ['summerSplash', 'springFresh', 'autumnWarm', 'winterCrisp', 'poolParty', 'tropicalParadise', 'desertOasis', 'sunsetSwim', 'beachVibes', 'palmSunset', 'oceanWave', 'starryNight', 'goldenHour', 'mistyMorning', 'rainbowBright', 'neonNight'],
      '3D & Depth': ['isometric', 'floatingCards', 'layeredDepth', 'shadowBox', 'popOut', 'foldedCorner', 'paperCraft', 'origami', 'cubeStack', 'sphereFloat', 'ribbonTwist', 'pageFlip', 'cardFan', 'accordion', 'stairStep', 'tunnelDepth'],
      'Patterns': ['dotMatrix', 'lineArt', 'crosshatch', 'circuitBoard', 'topographic', 'waterRipple', 'palmLeaves', 'tiledMosaic', 'chevronPattern', 'scalePattern', 'brickWall', 'fishScale', 'arabesque', 'plaidCheck', 'polkaDots', 'stripeWave'],
      'Unique': ['splitPersonality', 'beforeAfter', 'puzzlePiece', 'infographic', 'timeline', 'mapStyle', 'badgeHeavy', 'iconGrid', 'newspaperAd', 'ticketStub', 'recipeCard', 'postcardVintage', 'gameCard', 'idBadge', 'couponBook', 'eventFlyer'],
      'Pool Specific': ['poolsideView', 'underwaterBlue', 'splashAction', 'poolFloat', 'divingBoard', 'infinityEdge', 'nightSwim', 'familyFun', 'crystalWater', 'tiledPool', 'palmReflection', 'poolPartyNight', 'lazyRiver', 'waterfallEdge', 'spaRetreat', 'olympicLanes'],
      'Bold Impact': ['megaBold', 'contrastPop', 'neonGlow', 'electricShock', 'fireSale', 'iceBreaker', 'thunderStrike', 'explosionBurst', 'spotlightHero', 'redCarpet', 'vipAccess', 'limitedEdition', 'flashSale', 'grandOpening', 'lastChance', 'actNow'],
      'Artistic': ['watercolor', 'oilPaint', 'sketchStyle', 'comicBook', 'popArt', 'abstractArt', 'minimalistArt', 'geometricArt', 'brushStroke', 'inkSplash', 'charcoalDraw', 'pastelDream', 'acrylicPour', 'mosaicArt', 'stainedGlass', 'graffiti'],
      'Trust Building': ['testimonialCard', 'reviewHighlight', 'awardWinner', 'certifiedPro', 'familyOwned', 'localHero', 'communityChoice', 'guaranteeSeal', 'beforeAfterSplit', 'statsShowcase', 'teamPhoto', 'yearsExperience', 'satisfactionBadge', 'moneyBack', 'freeQuote', 'noObligation']
    };

    function formatLayoutName(layout) {
      return layout.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()).trim();
    }

    function updateLayoutSelect() {
      // Layout is now always random - no dropdown to update
    }

    function updateFontSelect() {
      document.getElementById('fontSelect').value = currentDesign.font;
    }

    function updateColorSwatches() {
      const grid = document.getElementById('colorGrid');
      if (!grid) return;
      grid.innerHTML = colorThemes.map((t, i) => `
        <div class="color-swatch ${t === currentDesign.theme ? 'active' : ''} ${locked.theme && t === currentDesign.theme ? 'locked' : ''}"
             style="background: linear-gradient(135deg, ${t.primary}, ${t.secondary});"
             onclick="selectTheme(${i})"
             title="${t.name}"></div>
      `).join('');
    }

    function selectTheme(index) {
      currentDesign.theme = colorThemes[index];
      // Don't auto-lock - let it randomize unless user explicitly locks
      updateColorSwatches();
      updateColorPickers();
      renderPostcard();
    }

    function addBulletPoint() {
      // Add a new custom bullet point
      const newBullet = "New Service Item";
      currentDesign.services.push(newBullet);
      locked.services = true; // Auto-lock when manually modified
      updateLockIndicator();
      updateBulletCount();
      renderPostcard();
    }

    function removeBulletPoint() {
      if (currentDesign.services.length > 1) {
        currentDesign.services.pop();
        locked.services = true; // Auto-lock when manually modified
        updateLockIndicator();
        updateBulletCount();
        renderPostcard();
      }
    }

    function updateBulletCount() {
      const countEl = document.getElementById('bulletCount');
      if (countEl) {
        countEl.textContent = currentDesign.services.length;
      }
    }

    // ==================== EDIT/MOVE MODE ====================
    let editMode = false;

    // Bleed & Safe Zone toggles
    function toggleBleedZone(show) {
      document.querySelectorAll('.postcard').forEach(card => {
        let bleed = card.querySelector('.bleed-zone');
        if (show && !bleed) {
          bleed = document.createElement('div');
          bleed.className = 'bleed-zone';
          card.style.position = 'relative';
          card.appendChild(bleed);
        } else if (!show && bleed) {
          bleed.remove();
        }
      });
    }

    function toggleSafeZone(show) {
      document.querySelectorAll('.postcard').forEach(card => {
        let safe = card.querySelector('.safe-zone');
        if (show && !safe) {
          safe = document.createElement('div');
          safe.className = 'safe-zone';
          card.style.position = 'relative';
          card.appendChild(safe);
        } else if (!show && safe) {
          safe.remove();
        }
      });
    }

    function toggleUSPSGuides() {
      const show = document.getElementById('showUSPSGuides').checked;
      const uspsGuides = document.getElementById('uspsGuides');
      const uspsInfo = document.getElementById('uspsInfo');

      if (uspsGuides) {
        uspsGuides.classList.toggle('show', show);
      }
      if (uspsInfo) {
        uspsInfo.style.display = show ? 'block' : 'none';
      }

      // Update USPS zone dimensions based on current card size
      if (show) {
        updateUSPSZones();
      }
    }

    function updateUSPSZones() {
      const size = postcardSizes[currentSize];
      if (!size) return;

      // Parse actual dimensions from size label (e.g., '4" x 6"' -> height=4, width=6)
      const labelMatch = size.label.match(/([\d.]+)"\s*x\s*([\d.]+)"/);
      const actualHeight = labelMatch ? parseFloat(labelMatch[1]) : 6;
      const actualWidth = labelMatch ? parseFloat(labelMatch[2]) : 9;
      const pxPerInchW = size.width / actualWidth;
      const pxPerInchH = size.height / actualHeight;

      // USPS zones (in inches) - apply to right half of back card
      const addressingWidth = 4 * pxPerInchW;
      const addressingHeight = 2.25 * pxPerInchH;
      const postageSize = 1.25 * pxPerInchW;
      const barcodeHeight = 0.625 * pxPerInchH;

      // Position zones on the right half (mailing side)
      const addressing = document.getElementById('uspsAddressing');
      const postage = document.getElementById('uspsPostage');
      const barcode = document.getElementById('uspsBarcode');

      if (addressing) {
        addressing.style.width = addressingWidth + 'px';
        addressing.style.height = addressingHeight + 'px';
        addressing.style.right = '0';
        addressing.style.bottom = barcodeHeight + 'px';
      }
      if (postage) {
        postage.style.width = postageSize + 'px';
        postage.style.height = postageSize + 'px';
        postage.style.right = '0';
        postage.style.top = '0';
      }
      if (barcode) {
        barcode.style.width = '50%'; // Full width of mailing side
        barcode.style.height = barcodeHeight + 'px';
        barcode.style.right = '0';
        barcode.style.bottom = '0';
      }
    }

    function toggleEditMode() {
      editMode = !editMode;
      const btn = document.getElementById('editModeBtn');
      const text = document.getElementById('editModeText');

      if (editMode) {
        btn.classList.add('active');
        text.textContent = 'Done Moving';
        document.body.classList.add('move-mode-active');
        initDraggables();
      } else {
        btn.classList.remove('active');
        text.textContent = 'Move Mode';
        document.body.classList.remove('move-mode-active');
      }
    }

    function initDraggables() {
      document.querySelectorAll('[data-movable="true"]').forEach(el => {
        // Get the element's current position relative to its offset parent
        const rect = el.getBoundingClientRect();
        const parent = el.offsetParent || el.parentElement;
        const parentRect = parent.getBoundingClientRect();

        // Calculate current position relative to parent
        const currentLeft = rect.left - parentRect.left;
        const currentTop = rect.top - parentRect.top;

        // Convert to absolute positioning with left/top (remove right/bottom)
        el.style.position = 'absolute';
        el.style.left = currentLeft + 'px';
        el.style.top = currentTop + 'px';
        el.style.right = 'auto';
        el.style.bottom = 'auto';
        el.style.margin = '0';
        el.style.transform = 'none';

        // Add drag functionality
        el.onmousedown = function(e) {
          if (!editMode) return;
          // Allow clicking on editable text
          if (e.target.closest('[contenteditable="true"]') && e.target.isContentEditable) return;

          e.preventDefault();
          e.stopPropagation();

          const startX = e.clientX;
          const startY = e.clientY;
          const startLeft = parseFloat(el.style.left) || 0;
          const startTop = parseFloat(el.style.top) || 0;

          el.classList.add('dragging');

          function onMove(moveEvent) {
            const dx = moveEvent.clientX - startX;
            const dy = moveEvent.clientY - startY;
            el.style.left = (startLeft + dx) + 'px';
            el.style.top = (startTop + dy) + 'px';
          }

          function onUp() {
            el.classList.remove('dragging');
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
          }

          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
        };
      });
    }

    // ==================== SAVE/LOAD ====================
    function saveUserInfo() {
      const data = {
        companyName: document.getElementById('companyName').value,
        phoneNumber: document.getElementById('phoneNumber').value,
        website: document.getElementById('website').value,
        cityName: document.getElementById('cityName').value,
        logoUrl: currentDesign.logoUrl,
        logoSize: currentDesign.logoSize,
        logoWhiteBox: currentDesign.logoWhiteBox,
        qrUrl: currentDesign.qrUrl,
        poolImage: customPoolImage,
        poolImageLocked: locked.poolImage
      };
      localStorage.setItem('postcardUserInfo', JSON.stringify(data));
    }

    function loadUserInfo() {
      const saved = localStorage.getItem('postcardUserInfo');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data.companyName) document.getElementById('companyName').value = data.companyName;
          if (data.phoneNumber) document.getElementById('phoneNumber').value = data.phoneNumber;
          if (data.website) document.getElementById('website').value = data.website;
          if (data.cityName) document.getElementById('cityName').value = data.cityName;
          if (data.logoUrl && data.logoUrl !== 'logo.png') {
            currentDesign.logoUrl = data.logoUrl;
            document.getElementById('logoPreview').innerHTML = '<img src="' + data.logoUrl + '" style="width:100%;height:100%;object-fit:contain;">';
          }
          if (data.logoSize) {
            currentDesign.logoSize = data.logoSize;
            document.getElementById('logoSizeSlider').value = data.logoSize;
            document.getElementById('logoSizeValue').textContent = data.logoSize + 'px';
          }
          if (data.logoWhiteBox) {
            currentDesign.logoWhiteBox = data.logoWhiteBox;
            document.getElementById('logoWhiteBox').checked = data.logoWhiteBox;
          }
          if (data.qrUrl && data.qrUrl !== 'qrcode.png') {
            currentDesign.qrUrl = data.qrUrl;
            document.getElementById('qrPreviewContainer').style.display = 'block';
            document.getElementById('qrCodeDisplay').innerHTML = '<img src="' + data.qrUrl + '" style="max-width:80px;max-height:80px;">';
          }
          if (data.poolImage) {
            customPoolImage = data.poolImage;
            currentDesign.poolImage = data.poolImage;
            locked.poolImage = data.poolImageLocked !== false;
            document.getElementById('poolPreview').innerHTML = '<img src="' + data.poolImage + '" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">';
            document.getElementById('poolImageIndex').textContent = 'Custom';
          }
        } catch (e) {
          console.log('Error loading saved data:', e);
        }
      }
    }

    // ==================== TEXT AUTO-SAVE ====================
    function saveTextContent() {
      // Save both text content and locked states
      const saveData = {
        textContent: savedTextContent,
        lockedStates: {
          headline: locked.headline,
          discount: locked.discount,
          urgency: locked.urgency,
          cta: locked.cta,
          testimonial: locked.testimonial,
          trustBadge: locked.trustBadge,
          services: locked.services
        }
      };
      localStorage.setItem('postcardTextContent', JSON.stringify(saveData));
    }

    function loadTextContent() {
      const saved = localStorage.getItem('postcardTextContent');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          // Handle both old format (just textContent) and new format (with lockedStates)
          if (data.textContent) {
            Object.assign(savedTextContent, data.textContent);
            if (data.lockedStates) {
              // Restore locked states for text elements - only if there's actual saved content
              if (data.lockedStates.headline && (savedTextContent.headlineMain || savedTextContent.headlineSub)) locked.headline = true;
              if (data.lockedStates.discount && (savedTextContent.discountAmount || savedTextContent.discountText)) locked.discount = true;
              if (data.lockedStates.urgency && savedTextContent.urgency) locked.urgency = true;
              if (data.lockedStates.cta && savedTextContent.cta) locked.cta = true;
              if (data.lockedStates.testimonial && (savedTextContent.testimonialText || savedTextContent.testimonialAuthor)) locked.testimonial = true;
              if (data.lockedStates.trustBadge && savedTextContent.trustBadge) locked.trustBadge = true;
              if (data.lockedStates.services && savedTextContent.services && savedTextContent.services.length > 0) locked.services = true;
            }
          } else {
            // Old format - just text content directly
            Object.assign(savedTextContent, data);
          }
        } catch (e) {
          console.log('Error loading text content:', e);
        }
      }
    }

    function clearSavedText() {
      savedTextContent = {
        headlineMain: null,
        headlineSub: null,
        urgency: null,
        cta: null,
        discountAmount: null,
        discountText: null,
        testimonialText: null,
        testimonialAuthor: null,
        trustBadge: null,
        trustBadge2: null,
        services: null,
      };
      localStorage.removeItem('postcardTextContent');
      // Also unlock all text-related locks
      locked.headline = false;
      locked.urgency = false;
      locked.cta = false;
      locked.discount = false;
      locked.testimonial = false;
      locked.trustBadge = false;
      locked.services = false;
      updateLockIndicator();
      generateNew();
    }

    function setupTextAutoSave() {
      // Wait for DOM to be ready, then attach listeners
      setTimeout(() => {
        const frontCard = document.getElementById('frontCard');
        const backCard = document.getElementById('backCard');

        if (!frontCard) return;

        // Use event delegation for contenteditable elements
        [frontCard, backCard].forEach(card => {
          if (!card) return;

          card.addEventListener('input', (e) => {
            if (e.target.hasAttribute('contenteditable')) {
              // Identify which field was edited based on content/context
              const text = e.target.innerText.trim();
              const parent = e.target.closest('[class*="lockable"]');

              if (parent) {
                const classList = parent.className;

                if (classList.includes('headline')) {
                  if (e.target.tagName === 'H1') {
                    savedTextContent.headlineMain = text;
                    locked.headline = true;
                  } else if (e.target.tagName === 'H2') {
                    savedTextContent.headlineSub = text;
                    locked.headline = true;
                  }
                } else if (classList.includes('urgency')) {
                  savedTextContent.urgency = text;
                  locked.urgency = true;
                } else if (classList.includes('cta')) {
                  savedTextContent.cta = text;
                  locked.cta = true;
                } else if (classList.includes('testimonial')) {
                  if (e.target.style.fontStyle === 'italic' || e.target.innerText.startsWith('"')) {
                    savedTextContent.testimonialText = text.replace(/^"|"$/g, '');
                    locked.testimonial = true;
                  } else {
                    savedTextContent.testimonialAuthor = text;
                    locked.testimonial = true;
                  }
                } else if (classList.includes('trustBadge')) {
                  // Handle trust badges
                  const spans = parent.querySelectorAll('span[contenteditable="true"]');
                  const index = Array.from(spans).indexOf(e.target);
                  if (index === 0) {
                    savedTextContent.trustBadge = text;
                  } else {
                    savedTextContent.trustBadge2 = text;
                  }
                  locked.trustBadge = true;
                } else if (classList.includes('services')) {
                  // Save all services
                  const serviceSpans = parent.querySelectorAll('span[contenteditable="true"]');
                  savedTextContent.services = Array.from(serviceSpans).map(s => s.innerText.trim());
                  locked.services = true;
                } else if (classList.includes('discount')) {
                  // Handle discount - find which part was edited (amount vs text)
                  const editables = parent.querySelectorAll('[contenteditable="true"]');
                  const index = Array.from(editables).indexOf(e.target);
                  if (index === 0 || text.includes('%') || text.includes('$') || /^\d/.test(text)) {
                    savedTextContent.discountAmount = text;
                  } else {
                    savedTextContent.discountText = text;
                  }
                  locked.discount = true;
                }
              }

              // Fallback check for discount (if not found via parent class)
              if (!parent || !parent.className.includes('discount')) {
                const discountParent = e.target.closest('[class*="discount"]');
                if (discountParent) {
                  const editables = discountParent.querySelectorAll('[contenteditable="true"]');
                  const index = Array.from(editables).indexOf(e.target);
                  if (index === 0 || text.includes('%') || text.includes('$') || /^\d/.test(text)) {
                    savedTextContent.discountAmount = text;
                  } else {
                    savedTextContent.discountText = text;
                  }
                  locked.discount = true;
                }
              }

              updateLockIndicator();
              saveTextContent();
            }
          });
        });
      }, 500);
    }

    // ==================== EXPORT ====================
    async function convertImageToBase64(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          resolve(canvas.toDataURL('image/jpeg', 0.9));
        };
        img.onerror = () => resolve(url); // fallback to original
        img.src = url;
      });
    }

    // Convert all images in element to inline base64
    async function prepareElementForExport(element) {
      const allElements = element.querySelectorAll('*');
      const convertPromises = [];

      for (const el of allElements) {
        // Handle background images
        const computedStyle = window.getComputedStyle(el);
        const bgImage = computedStyle.backgroundImage;

        if (bgImage && bgImage !== 'none' && bgImage.includes('url(')) {
          const urlMatch = bgImage.match(/url\(["']?([^"')]+)["']?\)/);
          if (urlMatch && urlMatch[1] && !urlMatch[1].startsWith('data:')) {
            const url = urlMatch[1];
            convertPromises.push((async () => {
              try {
                const base64 = await convertImageToBase64(url);
                el.style.backgroundImage = `url("${base64}")`;
              } catch (e) {
                console.log('Could not convert bg:', url);
              }
            })());
          }
        }

        // Handle img elements
        if (el.tagName === 'IMG' && el.src && !el.src.startsWith('data:')) {
          convertPromises.push((async () => {
            try {
              const base64 = await convertImageToBase64(el.src);
              el.src = base64;
            } catch (e) {
              console.log('Could not convert img:', el.src);
            }
          })());
        }
      }

      await Promise.all(convertPromises);
    }

    async function exportForVistaprint() {
      const btn = event.target.closest('button');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span>Preparing...</span>';
      btn.disabled = true;

      // Hide all edit indicators and guides for export
      const style = document.createElement('style');
      style.id = 'export-style';
      style.textContent = `
        .lockable { outline: none !important; }
        .lockable::before { display: none !important; }
        .lockable:hover { outline: none !important; }
        .lockable.locked { outline: none !important; }
        .lockable.locked::before { display: none !important; }
        [contenteditable]:hover { outline: none !important; }
        [contenteditable]:focus { outline: none !important; }
        [contenteditable] {
          outline: none !important;
        }
        .usps-guides { display: none !important; }
        .postcard.show-bleed::before { display: none !important; }
        .postcard.show-safe-zone::after { display: none !important; }
        * {
          -webkit-font-smoothing: antialiased !important;
        }
      `;
      document.head.appendChild(style);

      try {
        const frontCard = document.getElementById('frontCard');
        const backCard = document.getElementById('backCard');

        // Make sure front is visible - reset any animation styles
        frontCard.classList.remove('hidden');
        frontCard.style.opacity = '1';
        frontCard.style.transform = 'none';
        frontCard.style.display = 'block';
        backCard.classList.add('hidden');

        // Blur any focused elements to prevent cursor issues
        document.activeElement?.blur();

        // Wait for styles to apply
        await new Promise(r => setTimeout(r, 300));

        // Convert ALL background images to base64 for reliable export
        btn.innerHTML = '<span>Converting images...</span>';
        await prepareElementForExport(frontCard);
        await new Promise(r => setTimeout(r, 500));

        btn.innerHTML = '<span>Exporting Front...</span>';

        // Export front - use EXACT Vistaprint dimensions at 300 DPI
        const sizeConfig = postcardSizes[currentSize];

        // Vistaprint expects TRIM SIZE at 300 DPI (they handle bleed)
        // Official Vistaprint Mailing Services sizes only
        const printDimensions = {
          '4x6': { width: 1800, height: 1200 },     // 6" x 4" at 300 DPI
          '4-25x5-5': { width: 1650, height: 1275 }, // 5.5" x 4.25" at 300 DPI
          '5x7': { width: 2100, height: 1500 },     // 7" x 5" at 300 DPI
          '5-5x8-5': { width: 2550, height: 1650 }, // 8.5" x 5.5" at 300 DPI
          '6x9': { width: 2700, height: 1800 }      // 9" x 6" at 300 DPI
        };

        const targetDims = printDimensions[currentSize] || { width: 2700, height: 1800 };
        const exportWidth = targetDims.width;
        const exportHeight = targetDims.height;
        const exportScale = exportWidth / sizeConfig.width;

        // Use toPng with clean settings
        const frontDataUrl = await domtoimage.toPng(frontCard, {
          quality: 1,
          width: exportWidth,
          height: exportHeight,
          style: {
            transform: `scale(${exportScale})`,
            transformOrigin: 'top left'
          },
          cacheBust: true
        });

        // Convert data URL to blob
        const frontResponse = await fetch(frontDataUrl);
        const frontBlob = await frontResponse.blob();

        // Ask user where to save
        let saveDirectory = null;
        let useFilePicker = false;

        if (window.showDirectoryPicker) {
          try {
            btn.innerHTML = '<span>Choose save folder...</span>';
            saveDirectory = await window.showDirectoryPicker({
              mode: 'readwrite',
              startIn: 'downloads'
            });
            useFilePicker = true;
          } catch (e) {
            // User cancelled or not supported - fall back to downloads
            console.log('Directory picker cancelled or not supported');
          }
        }

        btn.innerHTML = '<span>Saving Front...</span>';

        if (useFilePicker && saveDirectory) {
          // Save to chosen directory
          const frontFile = await saveDirectory.getFileHandle(`postcard-${currentSize}-FRONT.png`, { create: true });
          const frontWritable = await frontFile.createWritable();
          await frontWritable.write(frontBlob);
          await frontWritable.close();
        } else {
          // Fall back to downloads folder
          const frontUrl = URL.createObjectURL(frontBlob);
          const frontLink = document.createElement('a');
          frontLink.download = `postcard-${currentSize}-FRONT.png`;
          frontLink.href = frontUrl;
          frontLink.click();
          URL.revokeObjectURL(frontUrl);
        }

        btn.innerHTML = '<span>Preparing Back...</span>';
        await new Promise(r => setTimeout(r, 300));

        // Show back - reset any flip animation styles
        frontCard.classList.add('hidden');
        backCard.classList.remove('hidden');
        backCard.style.opacity = '1';
        backCard.style.transform = 'none';
        backCard.style.display = 'block';

        // Wait for styles to apply
        await new Promise(r => setTimeout(r, 300));

        // Convert back images too
        await prepareElementForExport(backCard);
        await new Promise(r => setTimeout(r, 300));

        btn.innerHTML = '<span>Exporting Back...</span>';

        // Export back - use same size dimensions with toPng
        const backDataUrl = await domtoimage.toPng(backCard, {
          quality: 1,
          width: exportWidth,
          height: exportHeight,
          style: {
            transform: `scale(${exportScale})`,
            transformOrigin: 'top left'
          },
          cacheBust: true
        });

        // Convert data URL to blob
        const backResponse = await fetch(backDataUrl);
        const backBlob = await backResponse.blob();

        btn.innerHTML = '<span>Saving Back...</span>';

        if (useFilePicker && saveDirectory) {
          // Save to chosen directory
          const backFile = await saveDirectory.getFileHandle(`postcard-${currentSize}-BACK.png`, { create: true });
          const backWritable = await backFile.createWritable();
          await backWritable.write(backBlob);
          await backWritable.close();
        } else {
          // Fall back to downloads folder
          const backUrl = URL.createObjectURL(backBlob);
          const backLink = document.createElement('a');
          backLink.download = `postcard-${currentSize}-BACK.png`;
          backLink.href = backUrl;
          backLink.click();
          URL.revokeObjectURL(backUrl);
        }

        const saveLocation = useFilePicker ? 'your chosen folder' : 'your Downloads folder';
        alert(`Done! Check ${saveLocation} for:\nâ€¢ postcard-${currentSize}-FRONT.png\nâ€¢ postcard-${currentSize}-BACK.png\n\nSize: ${sizeConfig.label} Postcard\nResolution: ${exportWidth} x ${exportHeight} px (300 DPI)\n\nUpload to Vistaprint - select "Scale to Fit" if prompted.`);

      } catch (err) {
        console.error('Export error:', err);

        // Fallback to screenshot instructions
        alert('Auto-export failed.\n\nFIX: Upload your own pool image (external URLs cause this).\n\nOR use manual screenshot:\n1. Press Windows+Shift+S\n2. Select the postcard area\n3. Save as postcard-FRONT.png\n4. Click Back Side tab, repeat\n\nEdit outlines are now hidden.');
      } finally {
        // ALWAYS restore UI state
        const frontCard = document.getElementById('frontCard');
        const backCard = document.getElementById('backCard');

        // Reset all inline styles
        frontCard.style.opacity = '';
        frontCard.style.transform = '';
        frontCard.style.display = '';
        backCard.style.opacity = '';
        backCard.style.transform = '';
        backCard.style.display = '';

        // Show front, hide back
        frontCard.classList.remove('hidden');
        backCard.classList.add('hidden');

        // Remove export style immediately
        const exportStyle = document.getElementById('export-style');
        if (exportStyle) exportStyle.remove();

        // Re-render to fix any visual issues
        renderPostcard();

        // Restore button
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    // Initialize
    loadDeletedImages(); // Load deleted images FIRST so pool is filtered before use
    populateFontSelect();
    loadUserInfo();
    loadTextContent(); // Load saved text edits
    renderImageManager(); // Show image manager in Tools panel

    // Load saved postcard size and apply scaling
    const savedSize = localStorage.getItem('postcardSize');
    if (savedSize && postcardSizes[savedSize]) {
      document.getElementById('postcardSize').value = savedSize;
      changePostcardSize(savedSize);
    } else {
      // Apply default size scaling
      changePostcardSize('6x9');
    }

    // Setup discount badge text input listeners using event delegation
    document.addEventListener('input', function(e) {
      // Check if the input is in a discount badge
      if (e.target.closest('.discount')) {
        // Debounce the resize to avoid too many calls
        clearTimeout(window.discountResizeTimeout);
        window.discountResizeTimeout = setTimeout(autoResizeDiscountBadges, 100);
      }
    });

    // Also listen for focus out to resize after editing
    document.addEventListener('focusout', function(e) {
      if (e.target.closest('.discount')) {
        autoResizeDiscountBadges();
      }
    });

    // ==================== NEW FEATURES ====================

    // Sidebar Panel Switching
    window.showSidebarPanel = function showSidebarPanel(panelName, btn) {
      // Hide all panels
      document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
      // Deactivate all tabs
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      // Show selected panel
      document.getElementById('panel-' + panelName).classList.add('active');
      // Activate clicked tab
      btn.classList.add('active');
    }

    // Extract Colors from Image (Color Palette Upload)
    function extractColorsFromImage(input) {
      if (!input.files || !input.files[0]) return;

      const file = input.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          // Create canvas to analyze image
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = 100; // Downsample for speed
          canvas.height = 100;
          ctx.drawImage(img, 0, 0, 100, 100);

          // Get image data
          const imageData = ctx.getImageData(0, 0, 100, 100).data;

          // Extract dominant colors using simple color quantization
          const colors = extractDominantColors(imageData);

          // Apply to color pickers
          if (colors.length >= 1) document.getElementById('customPrimary').value = colors[0];
          if (colors.length >= 2) document.getElementById('customSecondary').value = colors[1];
          if (colors.length >= 3) document.getElementById('customAccent').value = colors[2];

          // Update preview
          document.getElementById('palettePreview').innerHTML = `
            <div style="display:flex;gap:2px;">
              <div style="width:16px;height:16px;background:${colors[0]};border-radius:2px;"></div>
              <div style="width:16px;height:16px;background:${colors[1]};border-radius:2px;"></div>
              <div style="width:16px;height:16px;background:${colors[2]};border-radius:2px;"></div>
            </div>
          `;

          // Apply colors
          applyCustomColors();
        };
        img.src = e.target.result;
      };

      reader.readAsDataURL(file);
    }

    function extractDominantColors(imageData) {
      // Simple color extraction - collect colors and find most common
      const colorMap = {};

      for (let i = 0; i < imageData.length; i += 4) {
        const r = Math.round(imageData[i] / 32) * 32;
        const g = Math.round(imageData[i + 1] / 32) * 32;
        const b = Math.round(imageData[i + 2] / 32) * 32;

        // Skip very light colors (likely background) and very dark
        const brightness = (r + g + b) / 3;
        if (brightness < 30 || brightness > 225) continue;

        const key = `${r},${g},${b}`;
        colorMap[key] = (colorMap[key] || 0) + 1;
      }

      // Sort by frequency
      const sorted = Object.entries(colorMap)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      // Get distinct colors
      const colors = [];
      for (const [key] of sorted) {
        const [r, g, b] = key.split(',').map(Number);
        const hex = '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');

        // Check if color is distinct enough from existing
        let distinct = true;
        for (const existing of colors) {
          if (colorDistance(hex, existing) < 50) {
            distinct = false;
            break;
          }
        }

        if (distinct) {
          colors.push(hex);
          if (colors.length >= 3) break;
        }
      }

      // If we don't have 3 colors, generate complementary ones
      while (colors.length < 3) {
        if (colors.length === 0) {
          colors.push('#0891b2');
        } else {
          colors.push(adjustColor(colors[0], colors.length * 30));
        }
      }

      return colors;
    }

    function colorDistance(hex1, hex2) {
      const r1 = parseInt(hex1.slice(1, 3), 16);
      const g1 = parseInt(hex1.slice(3, 5), 16);
      const b1 = parseInt(hex1.slice(5, 7), 16);
      const r2 = parseInt(hex2.slice(1, 3), 16);
      const g2 = parseInt(hex2.slice(3, 5), 16);
      const b2 = parseInt(hex2.slice(5, 7), 16);
      return Math.sqrt((r1-r2)**2 + (g1-g2)**2 + (b1-b2)**2);
    }

    function adjustColor(hex, amount) {
      let r = parseInt(hex.slice(1, 3), 16);
      let g = parseInt(hex.slice(3, 5), 16);
      let b = parseInt(hex.slice(5, 7), 16);
      r = Math.min(255, Math.max(0, r + amount));
      g = Math.min(255, Math.max(0, g - amount));
      return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
    }

    // Generate Harmonious Color Palette
    function generateHarmoniousPalette() {
      // Generate random base hue
      const hue = Math.random() * 360;

      // Create harmonious colors (analogous scheme)
      const primary = hslToHex(hue, 70, 45);
      const secondary = hslToHex((hue + 30) % 360, 65, 50);
      const accent = hslToHex((hue + 60) % 360, 75, 55);

      document.getElementById('customPrimary').value = primary;
      document.getElementById('customSecondary').value = secondary;
      document.getElementById('customAccent').value = accent;

      applyCustomColors();
    }

    function hslToHex(h, s, l) {
      s /= 100;
      l /= 100;
      const a = s * Math.min(l, 1 - l);
      const f = n => {
        const k = (n + h / 30) % 12;
        const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
        return Math.round(255 * color).toString(16).padStart(2, '0');
      };
      return `#${f(0)}${f(8)}${f(4)}`;
    }

    // Custom Color Picker
    function applyCustomColors() {
      const primary = document.getElementById('customPrimary').value;
      const secondary = document.getElementById('customSecondary').value;
      const accent = document.getElementById('customAccent').value;

      currentDesign.theme = {
        primary: primary,
        secondary: secondary,
        accent: accent,
        name: 'Custom'
      };

      updatePostcard();
      saveToHistory();
    }

    // Update color pickers when theme changes
    function updateColorPickers() {
      document.getElementById('customPrimary').value = currentDesign.theme.primary;
      document.getElementById('customSecondary').value = currentDesign.theme.secondary;
      document.getElementById('customAccent').value = currentDesign.theme.accent;
    }

    // Auto Preview - automatically cycles through layouts
    let autoPreviewInterval = null;
    let autoPreviewIndex = 0;
    const allLayouts = Object.values(layoutCategories).flat();

    window.toggleAutoPreview = function toggleAutoPreview() {
      const btn = document.getElementById('autoPreviewBtn');
      const text = document.getElementById('autoPreviewText');

      if (autoPreviewInterval) {
        // Stop auto preview
        clearInterval(autoPreviewInterval);
        autoPreviewInterval = null;
        text.textContent = 'Auto Preview';
        btn.style.background = 'linear-gradient(135deg, var(--accent), #6366f1)';
        btn.querySelector('svg').innerHTML = '<polygon points="5 3 19 12 5 21 5 3"/>';
      } else {
        // Start auto preview
        text.textContent = 'Stop Preview';
        btn.style.background = 'linear-gradient(135deg, #ef4444, #f97316)';
        btn.querySelector('svg').innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';

        // Shuffle through layouts every 2 seconds
        autoPreviewInterval = setInterval(() => {
          autoPreviewIndex = (autoPreviewIndex + 1) % allLayouts.length;
          currentDesign.layout = allLayouts[autoPreviewIndex];
          currentDesign.theme = random(colorThemes);
          if (!locked.poolImage) {
            currentDesign.poolImage = random(poolImages);
            updatePoolImagePreview();
          }
          updateLayoutDisplay();
          updateColorSwatches();
          updateColorPickers();
          renderPostcard();
        }, 2000);
      }
    }

    // Flip Animation
    let isFlipped = false;
    window.flipPostcard = function flipPostcard() {
      const frontCard = document.getElementById('frontCard');
      const backCard = document.getElementById('backCard');

      isFlipped = !isFlipped;

      if (isFlipped) {
        frontCard.style.transition = 'transform 0.6s ease, opacity 0.3s ease';
        frontCard.style.transform = 'rotateY(180deg)';
        frontCard.style.opacity = '0';

        setTimeout(() => {
          frontCard.classList.add('hidden');
          backCard.classList.remove('hidden');
          backCard.style.transform = 'rotateY(0deg)';
          backCard.style.opacity = '1';
        }, 300);

        // Update tabs
        document.querySelectorAll('.tabs .tab').forEach((t, i) => {
          t.classList.toggle('active', i === 1);
        });
      } else {
        backCard.style.transition = 'transform 0.6s ease, opacity 0.3s ease';
        backCard.style.transform = 'rotateY(-180deg)';
        backCard.style.opacity = '0';

        setTimeout(() => {
          backCard.classList.add('hidden');
          frontCard.classList.remove('hidden');
          frontCard.style.transform = 'rotateY(0deg)';
          frontCard.style.opacity = '1';
        }, 300);

        // Update tabs
        document.querySelectorAll('.tabs .tab').forEach((t, i) => {
          t.classList.toggle('active', i === 0);
        });
      }
    }

    // Favorites System
    let favorites = JSON.parse(localStorage.getItem('postcardFavorites') || '[]');

    function toggleFavoritesDropdown() {
      const dropdown = document.getElementById('favoritesDropdown');
      dropdown.classList.toggle('show');
      renderFavoritesList();
    }

    function saveToFavorites() {
      const name = prompt('Name this design:', `${currentDesign.layout} - ${currentDesign.theme.name}`);
      if (!name) return;

      const favorite = {
        id: Date.now(),
        name: name,
        layout: currentDesign.layout,
        theme: {...currentDesign.theme},
        headline: {...currentDesign.headline},
        discount: {...currentDesign.discount},
        font: currentDesign.font
      };

      favorites.push(favorite);
      localStorage.setItem('postcardFavorites', JSON.stringify(favorites));
      updateFavoritesCount();
      alert('Design saved to favorites!');
    }

    function loadFavorite(id) {
      const favorite = favorites.find(f => f.id === id);
      if (!favorite) return;

      currentDesign.layout = favorite.layout;
      currentDesign.theme = {...favorite.theme};
      currentDesign.headline = {...favorite.headline};
      currentDesign.discount = {...favorite.discount};
      currentDesign.font = favorite.font;

      updateColorPickers();
      updatePostcard();
      toggleFavoritesDropdown();
    }

    function removeFavorite(id, event) {
      event.stopPropagation();
      favorites = favorites.filter(f => f.id !== id);
      localStorage.setItem('postcardFavorites', JSON.stringify(favorites));
      updateFavoritesCount();
      renderFavoritesList();
    }

    function renderFavoritesList() {
      const list = document.getElementById('favoritesList');
      if (favorites.length === 0) {
        list.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-muted); font-size: 12px;">No favorites yet</div>';
        return;
      }

      list.innerHTML = favorites.map(f => `
        <div class="favorites-item" onclick="loadFavorite(${f.id})">
          <span class="favorites-item-name">${f.name}</span>
          <span class="favorites-item-remove" onclick="removeFavorite(${f.id}, event)">&times;</span>
        </div>
      `).join('');
    }

    function updateFavoritesCount() {
      document.getElementById('favoritesCount').textContent = favorites.length;
    }

    // Close favorites dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('favoritesDropdown');
      const btn = document.getElementById('favoritesBtn');
      if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });

    // Image Filters
    let imageFilters = { brightness: 100, contrast: 100, saturation: 100 };

    function applyImageFilters() {
      const brightness = document.getElementById('brightnessSlider').value;
      const contrast = document.getElementById('contrastSlider').value;
      const saturation = document.getElementById('saturationSlider').value;

      imageFilters = { brightness, contrast, saturation };

      document.getElementById('brightnessValue').textContent = brightness + '%';
      document.getElementById('contrastValue').textContent = contrast + '%';
      document.getElementById('saturationValue').textContent = saturation + '%';

      // Apply filters to all pool images in the postcard
      const poolImages = document.querySelectorAll('.postcard-front [class*="poolImage"], .postcard-front [style*="background: url"]');
      const filterStyle = `brightness(${brightness/100}) contrast(${contrast/100}) saturate(${saturation/100})`;

      document.querySelectorAll('.postcard-front').forEach(front => {
        const bgDiv = front.querySelector('[style*="background: url"]');
        if (bgDiv) {
          bgDiv.style.filter = filterStyle;
        }
      });

      // Also store for future renders
      currentDesign.imageFilters = imageFilters;
    }

    function resetImageFilters() {
      document.getElementById('brightnessSlider').value = 100;
      document.getElementById('contrastSlider').value = 100;
      document.getElementById('saturationSlider').value = 100;
      imageFilters = { brightness: 100, contrast: 100, saturation: 100 };
      applyImageFilters();
    }

    // ==================== PRESET TEMPLATES ====================
    const presetTemplates = {
      summer: {
        themes: ['Summer Sun', 'Summer Sky', 'Summer Grass', 'Summer Orange', 'Ocean', 'Sky'],
        layouts: ['hero', 'split', 'overlay', 'coastal', 'tropical'],
        headlines: ['Summer Ready', 'Beat The Heat', 'Dive Right In', 'Pool Party Prep', 'Sun\'s Out'],
        discountText: 'Summer Special!'
      },
      tropical: {
        themes: ['Tropical Teal', 'Tropical Lime', 'Tropical Pink', 'Tropical Violet', 'Teal', 'Emerald'],
        layouts: ['tropical', 'wave', 'gradient', 'hero', 'coastal'],
        headlines: ['Paradise Found', 'Your Oasis Awaits', 'Backyard Bliss', 'Pool Paradise Found', 'Liquid Luxury'],
        discountText: 'Tropical Deal!'
      },
      professional: {
        themes: ['Navy', 'Slate', 'Charcoal', 'Cobalt', 'Sapphire'],
        layouts: ['corporate', 'executive', 'consulting', 'cleanModern', 'premium'],
        headlines: ['Pool Service Done Right', 'Trusted Pool Experts', 'Premium Pool Service', 'Expert Pool Care', 'Professional & Reliable'],
        discountText: 'Professional Service!'
      },
      luxury: {
        themes: ['Gold', 'Bronze', 'Onyx', 'Espresso', 'Midnight'],
        layouts: ['luxury', 'goldAccent', 'marbleTouch', 'velvetLux', 'elegant'],
        headlines: ['Pool Prestige', 'Aqua Excellence', 'Liquid Luxury', 'Premium Pool Service', 'Experience The Difference'],
        discountText: 'VIP Offer!'
      },
      spring: {
        themes: ['Spring Green', 'Spring Lilac', 'Spring Rose', 'Spring Yellow', 'Emerald'],
        layouts: ['minimal', 'clean', 'framed', 'nature', 'playful'],
        headlines: ['Spring Into Savings', 'Pool Opening Time', 'Fresh Start', 'Spring Refresh', 'Ready Set Swim'],
        discountText: 'Spring Opening!'
      },
      fall: {
        themes: ['Fall Orange', 'Fall Amber', 'Fall Gold', 'Fall Harvest', 'Rust'],
        layouts: ['warm', 'rustic', 'vintage', 'classic', 'retro'],
        headlines: ['Fall Prep Special', 'End Of Season', 'Fall Savings', 'Autumn Deal', 'Pool Closing'],
        discountText: 'Fall Closeout!'
      },
      winter: {
        themes: ['Winter Ice', 'Winter Frost', 'Winter Silver', 'Winter Night', 'Azure'],
        layouts: ['minimal', 'cleanModern', 'swiss', 'corporate', 'elegant'],
        headlines: ['Winter Prep', 'Off-Season Deal', 'Winterization Special', 'Winter Savings', 'Pool Closing'],
        discountText: 'Winter Special!'
      },
      urgent: {
        themes: ['Ruby', 'Crimson', 'Scarlet', 'Sunset', 'Tangerine'],
        layouts: ['urgentSale', 'coupon', 'bold', 'spotlight', 'directResponse'],
        headlines: ['Don\'t Miss Out', 'Limited Time', 'Act Now', 'Last Chance', 'Expires Soon'],
        discountText: 'Expires Soon!'
      }
    };

    function applyPreset(presetName) {
      const preset = presetTemplates[presetName];
      if (!preset) return;

      // Find matching theme
      const matchingTheme = colorThemes.find(t => preset.themes.includes(t.name)) || random(colorThemes.filter(t => preset.themes.some(pt => t.name.includes(pt))));
      if (matchingTheme) currentDesign.theme = matchingTheme;

      // Find matching layout
      const matchingLayout = layouts.find(l => preset.layouts.includes(l));
      if (matchingLayout) currentDesign.layout = matchingLayout;

      // Set headline
      const headlineMain = random(preset.headlines);
      currentDesign.headline = { main: headlineMain, sub: random(headlineSubParts) };

      // Set discount text
      currentDesign.discount = { amount: random(discountAmounts), text: preset.discountText };

      // Update UI
      updateColorSwatches();
      updateColorPickers();
      updateLayoutDisplay();
      renderPostcard();
      saveToHistory();
    }

    // ==================== DARK MODE PREVIEW ====================
    function toggleDarkModePreview(enabled) {
      const frontCard = document.getElementById('frontCard');
      const backCard = document.getElementById('backCard');

      if (enabled) {
        // Apply print simulation - slightly desaturated, darker
        frontCard.style.filter = 'saturate(0.85) brightness(0.92) contrast(1.05)';
        backCard.style.filter = 'saturate(0.85) brightness(0.92) contrast(1.05)';
        frontCard.style.boxShadow = 'inset 0 0 50px rgba(0,0,0,0.1)';
        backCard.style.boxShadow = 'inset 0 0 50px rgba(0,0,0,0.1)';
      } else {
        frontCard.style.filter = '';
        backCard.style.filter = '';
        frontCard.style.boxShadow = '';
        backCard.style.boxShadow = '';
      }
    }

    // ==================== BATCH EXPORT ====================
    async function batchExport() {
      const count = parseInt(document.getElementById('batchCount').value);
      const btn = event.target.closest('button');
      const originalText = btn.innerHTML;

      // Save current design
      const originalDesign = JSON.parse(JSON.stringify(currentDesign));

      btn.innerHTML = '<span>Preparing...</span>';
      btn.disabled = true;

      try {
        for (let i = 0; i < count; i++) {
          btn.innerHTML = `<span>Exporting ${i + 1}/${count}...</span>`;

          // Generate new variation
          generateNew();
          await new Promise(r => setTimeout(r, 300)); // Wait for render

          // Export front
          await exportSingleCard('front', `postcard-${i + 1}-FRONT.png`);
          await new Promise(r => setTimeout(r, 200));

          // Export back
          await exportSingleCard('back', `postcard-${i + 1}-BACK.png`);
          await new Promise(r => setTimeout(r, 200));
        }

        btn.innerHTML = '<span>âœ“ Done!</span>';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('Batch export error:', error);
        btn.innerHTML = '<span>Error!</span>';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
      }

      // Restore original design
      currentDesign = originalDesign;
      renderPostcard();
    }

    async function exportSingleCard(side, filename) {
      const card = side === 'front' ? document.getElementById('frontCard') : document.getElementById('backCard');
      const cardContent = card.querySelector('.postcard-front, .postcard-back');
      if (!cardContent) return;

      const sizeKey = currentSize;
      const dims = printDimensions[sizeKey] || printDimensions['6x9'];

      try {
        const dataUrl = await domtoimage.toPng(cardContent, {
          width: dims.width,
          height: dims.height,
          style: {
            transform: `scale(${dims.width / cardContent.offsetWidth})`,
            transformOrigin: 'top left',
            width: cardContent.offsetWidth + 'px',
            height: cardContent.offsetHeight + 'px'
          },
          quality: 1.0
        });

        const link = document.createElement('a');
        link.download = filename;
        link.href = dataUrl;
        link.click();
      } catch (error) {
        console.error('Export error:', error);
      }
    }

    // Share Design Link
    function openShareModal() {
      const modal = document.getElementById('shareModal');
      const urlInput = document.getElementById('shareUrlInput');

      // Create shareable state
      const shareState = {
        l: currentDesign.layout,
        t: encodeURIComponent(JSON.stringify(currentDesign.theme)),
        h: encodeURIComponent(currentDesign.headline.main),
        d: encodeURIComponent(currentDesign.discount.amount),
        f: currentDesign.font
      };

      const params = new URLSearchParams(shareState).toString();
      const shareUrl = window.location.origin + window.location.pathname + '?' + params;

      urlInput.value = shareUrl;
      modal.classList.add('show');
    }

    function closeShareModal() {
      document.getElementById('shareModal').classList.remove('show');
      document.getElementById('copyBtn').textContent = 'Copy Link';
      document.getElementById('copyBtn').classList.remove('copied');
    }

    function copyShareUrl() {
      const urlInput = document.getElementById('shareUrlInput');
      urlInput.select();
      document.execCommand('copy');

      const btn = document.getElementById('copyBtn');
      btn.textContent = 'Copied!';
      btn.classList.add('copied');

      setTimeout(() => {
        btn.textContent = 'Copy Link';
        btn.classList.remove('copied');
      }, 2000);
    }

    // Load from URL params
    function loadFromUrl() {
      const params = new URLSearchParams(window.location.search);
      if (params.has('l')) {
        currentDesign.layout = params.get('l');
      }
      if (params.has('t')) {
        try {
          currentDesign.theme = JSON.parse(decodeURIComponent(params.get('t')));
          updateColorPickers();
        } catch(e) {}
      }
      if (params.has('h')) {
        currentDesign.headline.main = decodeURIComponent(params.get('h'));
      }
      if (params.has('d')) {
        currentDesign.discount.amount = decodeURIComponent(params.get('d'));
      }
      if (params.has('f')) {
        currentDesign.font = params.get('f');
      }
    }

    // Bulk Text Replace
    function bulkReplaceText() {
      const findText = document.getElementById('findText').value;
      const replaceText = document.getElementById('replaceText').value;

      if (!findText) {
        document.getElementById('replaceResult').textContent = 'Enter text to find';
        return;
      }

      let count = 0;
      const editables = document.querySelectorAll('[contenteditable="true"]');

      editables.forEach(el => {
        if (el.innerHTML.includes(findText)) {
          el.innerHTML = el.innerHTML.split(findText).join(replaceText);
          count++;
        }
      });

      document.getElementById('replaceResult').textContent = count > 0
        ? `Replaced in ${count} element(s)`
        : 'No matches found';

      // Also update state
      if (currentDesign.headline.main.includes(findText)) {
        currentDesign.headline.main = currentDesign.headline.main.split(findText).join(replaceText);
      }
      if (currentDesign.headline.sub && currentDesign.headline.sub.includes(findText)) {
        currentDesign.headline.sub = currentDesign.headline.sub.split(findText).join(replaceText);
      }
    }

    // Design Tips Panel
    function toggleTipsPanel() {
      const panel = document.getElementById('tipsPanel');
      const toggle = document.getElementById('tipsToggle');
      panel.classList.toggle('show');
    }

    // Compare Mode
    let alternativeDesign = null;

    function openCompareMode() {
      const modal = document.getElementById('compareModal');
      const card1 = document.getElementById('compareCard1');

      // Clone current design to card1
      card1.innerHTML = document.getElementById('frontCard').innerHTML;

      // Generate alternative
      generateCompareAlternative();

      modal.classList.add('show');
    }

    function closeCompareMode() {
      document.getElementById('compareModal').classList.remove('show');
    }

    function generateCompareAlternative() {
      const card2 = document.getElementById('compareCard2');

      // Create alternative design
      alternativeDesign = {
        layout: random(layouts),
        theme: random(colorThemes),
        headline: random(headlines),
        discount: random(discounts),
        font: random(fonts)
      };

      // Temporarily swap and render
      const originalDesign = {...currentDesign};

      currentDesign.layout = alternativeDesign.layout;
      currentDesign.theme = alternativeDesign.theme;
      currentDesign.headline = alternativeDesign.headline;
      currentDesign.discount = alternativeDesign.discount;
      currentDesign.font = alternativeDesign.font;

      renderPostcard();
      card2.innerHTML = document.getElementById('frontCard').innerHTML;

      // Restore original
      currentDesign.layout = originalDesign.layout;
      currentDesign.theme = originalDesign.theme;
      currentDesign.headline = originalDesign.headline;
      currentDesign.discount = originalDesign.discount;
      currentDesign.font = originalDesign.font;

      renderPostcard();
    }

    function useAlternativeDesign() {
      if (!alternativeDesign) return;

      currentDesign.layout = alternativeDesign.layout;
      currentDesign.theme = alternativeDesign.theme;
      currentDesign.headline = alternativeDesign.headline;
      currentDesign.discount = alternativeDesign.discount;
      currentDesign.font = alternativeDesign.font;

      updateColorPickers();
      updatePostcard();
      saveToHistory();
      closeCompareMode();
    }

    // ==================== NEW FEATURES ====================

    // Marketing Fields Update
    function updateMarketingFields() {
      currentDesign.couponCode = document.getElementById('couponCode').value;
      currentDesign.expirationDate = document.getElementById('expirationDate').value;
      currentDesign.callTrackingNumber = document.getElementById('callTrackingNumber').value;
      saveUserInfo();
      renderPostcard();
    }

    // Custom Color Picker
    function applyCustomColors() {
      const primary = document.getElementById('customPrimary').value;
      const secondary = document.getElementById('customSecondary').value;
      const accent = document.getElementById('customAccent').value;

      currentDesign.theme = {
        primary: primary,
        secondary: secondary,
        accent: accent,
        name: 'Custom'
      };

      locked.theme = true;
      document.getElementById('lockTheme').checked = true;
      updateColorSwatches();
      renderPostcard();
      saveToHistory();
    }

    // Template Save/Load
    function saveTemplate() {
      const name = document.getElementById('templateName').value.trim();
      if (!name) {
        alert('Please enter a template name');
        return;
      }

      const templates = JSON.parse(localStorage.getItem('postcardTemplates') || '{}');
      templates[name] = {
        design: JSON.parse(JSON.stringify(currentDesign)),
        saved: new Date().toISOString()
      };
      localStorage.setItem('postcardTemplates', JSON.stringify(templates));

      document.getElementById('templateName').value = '';
      renderSavedTemplates();
      alert('Template "' + name + '" saved!');
    }

    function loadTemplate(name) {
      const templates = JSON.parse(localStorage.getItem('postcardTemplates') || '{}');
      if (templates[name]) {
        currentDesign = JSON.parse(JSON.stringify(templates[name].design));
        updateColorSwatches();
        updateLayoutSelect();
        updateFontSelect();
        renderPostcard();
        syncAllSidebarInputs();
        saveToHistory();
      }
    }

    function deleteTemplate(name) {
      if (confirm('Delete template "' + name + '"?')) {
        const templates = JSON.parse(localStorage.getItem('postcardTemplates') || '{}');
        delete templates[name];
        localStorage.setItem('postcardTemplates', JSON.stringify(templates));
        renderSavedTemplates();
      }
    }

    function renderSavedTemplates() {
      const container = document.getElementById('savedTemplatesList');
      const templates = JSON.parse(localStorage.getItem('postcardTemplates') || '{}');
      const names = Object.keys(templates);

      if (names.length === 0) {
        container.innerHTML = '<p style="font-size:10px;color:var(--text-muted);text-align:center;">No saved templates</p>';
        return;
      }

      container.innerHTML = names.map(name => `
        <div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--border);">
          <button class="quick-btn" onclick="loadTemplate('${name}')" style="flex:1;padding:4px 8px;font-size:10px;">${name}</button>
          <button onclick="deleteTemplate('${name}')" style="background:none;border:none;color:var(--danger);cursor:pointer;padding:4px;">&times;</button>
        </div>
      `).join('');
    }

    // PDF Export
    async function exportToPDF() {
      const { jsPDF } = window.jspdf;

      const btn = event.target.closest('button');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span>Generating PDF...</span>';
      btn.disabled = true;

      try {
        const sizeKey = currentSize;
        const dims = printDimensions[sizeKey] || printDimensions['6x9'];

        // Create PDF with correct dimensions (in inches, converted from pixels at 300 DPI)
        const pdfWidth = dims.width / 300;
        const pdfHeight = dims.height / 300;
        const pdf = new jsPDF({
          orientation: pdfWidth > pdfHeight ? 'landscape' : 'portrait',
          unit: 'in',
          format: [pdfWidth, pdfHeight]
        });

        // Export front
        const frontCard = document.getElementById('frontCard');
        const frontContent = frontCard.querySelector('.postcard-front');
        if (frontContent) {
          const frontDataUrl = await domtoimage.toPng(frontContent, {
            width: dims.width,
            height: dims.height,
            style: {
              transform: `scale(${dims.width / frontContent.offsetWidth})`,
              transformOrigin: 'top left',
              width: frontContent.offsetWidth + 'px',
              height: frontContent.offsetHeight + 'px'
            },
            quality: 1.0
          });
          pdf.addImage(frontDataUrl, 'PNG', 0, 0, pdfWidth, pdfHeight);
        }

        // Add second page for back
        pdf.addPage([pdfWidth, pdfHeight]);

        const backCard = document.getElementById('backCard');
        const backContent = backCard.querySelector('.postcard-back');
        if (backContent) {
          const backDataUrl = await domtoimage.toPng(backContent, {
            width: dims.width,
            height: dims.height,
            style: {
              transform: `scale(${dims.width / backContent.offsetWidth})`,
              transformOrigin: 'top left',
              width: backContent.offsetWidth + 'px',
              height: backContent.offsetHeight + 'px'
            },
            quality: 1.0
          });
          pdf.addImage(backDataUrl, 'PNG', 0, 0, pdfWidth, pdfHeight);
        }

        // Save PDF
        const companyName = document.getElementById('companyName').value || 'postcard';
        pdf.save(`${companyName.replace(/[^a-z0-9]/gi, '_')}_postcard.pdf`);

        btn.innerHTML = '<span>âœ“ PDF Created!</span>';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('PDF export error:', error);
        btn.innerHTML = '<span>Error!</span>';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
      }
    }

    // Language/Bilingual Mode
    const spanishTranslations = {
      // Headlines
      'Pool Serenity': 'Serenidad de Piscina',
      'Crystal Clear': 'Cristalino',
      'Dive Into': 'SumÃ©rjase en',
      'Pool Paradise': 'ParaÃ­so de Piscinas',
      'Splash Into': 'Chapotee en',
      'Worry Less': 'PreocÃºpese Menos',
      'Swim More': 'Nade MÃ¡s',
      'Savings': 'Ahorros',
      'Clean Pools': 'Piscinas Limpias',
      'Happy Customers': 'Clientes Felices',
      // Common phrases
      'Call Now': 'Llame Ahora',
      'Call or Text': 'Llame o EnvÃ­e Texto',
      'Free Quote': 'CotizaciÃ³n Gratis',
      'Limited Time': 'Tiempo Limitado',
      'First Service': 'Primer Servicio',
      'First Month': 'Primer Mes',
      'OFF': 'DE DESCUENTO',
      'FREE': 'GRATIS',
      // Services
      'Weekly Cleaning': 'Limpieza Semanal',
      'Chemical Balance': 'Balance QuÃ­mico',
      'Equipment Repair': 'ReparaciÃ³n de Equipos',
      'Pool Opening': 'Apertura de Piscina',
      'Pool Closing': 'Cierre de Piscina',
      'Filter Cleaning': 'Limpieza de Filtros',
      'Acid Washing': 'Lavado con Ãcido',
      'Tile Cleaning': 'Limpieza de Azulejos',
      // Trust badges
      'Licensed': 'Licenciado',
      'Insured': 'Asegurado',
      'Family Owned': 'Negocio Familiar',
      'Years Experience': 'AÃ±os de Experiencia',
      '5-Star Rated': 'CalificaciÃ³n 5 Estrellas'
    };

    function changeLanguageMode(mode) {
      currentDesign.language = mode;
      renderPostcard();

      // Update text if Spanish mode
      if (mode === 'es' || mode === 'bilingual') {
        setTimeout(() => {
          translatePostcard(mode === 'bilingual');
        }, 100);
      }
    }

    function translatePostcard(bilingual = false) {
      const editables = document.querySelectorAll('[contenteditable="true"]');
      editables.forEach(el => {
        let text = el.textContent;
        for (const [en, es] of Object.entries(spanishTranslations)) {
          if (text.includes(en)) {
            if (bilingual) {
              text = text.replace(en, `${en} / ${es}`);
            } else {
              text = text.replace(en, es);
            }
          }
        }
        el.textContent = text;
      });
    }

    // Print Cost Estimator
    function calculatePrintCost() {
      const quantity = parseInt(document.getElementById('printQuantity').value);
      const paperType = document.getElementById('paperType').value;
      const sizeKey = currentSize;

      // Base pricing per piece (approximate Vistaprint pricing)
      const basePrices = {
        '4x6': { standard: 0.08, premium: 0.12, uv: 0.14 },
        '4.25x6': { standard: 0.09, premium: 0.13, uv: 0.15 },
        '5x7': { standard: 0.12, premium: 0.16, uv: 0.19 },
        '6x9': { standard: 0.15, premium: 0.20, uv: 0.24 },
        '6x11': { standard: 0.22, premium: 0.28, uv: 0.32 }
      };

      // Volume discounts
      let volumeDiscount = 1;
      if (quantity >= 5000) volumeDiscount = 0.65;
      else if (quantity >= 2500) volumeDiscount = 0.72;
      else if (quantity >= 1000) volumeDiscount = 0.80;
      else if (quantity >= 500) volumeDiscount = 0.88;
      else if (quantity >= 250) volumeDiscount = 0.94;

      const pricePerPiece = (basePrices[sizeKey]?.[paperType] || 0.15) * volumeDiscount;
      const totalCost = Math.round(quantity * pricePerPiece);

      document.getElementById('estimatedCost').textContent = totalCost;
      document.getElementById('costPerPiece').textContent = pricePerPiece.toFixed(2);
    }

    // Before/After Toggle
    let beforeSnapshot = null;

    function toggleBeforeAfterMode(enabled) {
      const frontCard = document.getElementById('frontCard');
      const previewArea = document.querySelector('.postcard-wrapper');

      if (enabled) {
        // Take snapshot of current state
        beforeSnapshot = frontCard.innerHTML;

        // Create split view
        const splitView = document.createElement('div');
        splitView.id = 'beforeAfterSplit';
        splitView.style.cssText = 'display:flex;gap:20px;align-items:center;justify-content:center;';
        splitView.innerHTML = `
          <div style="text-align:center;">
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">BEFORE</div>
            <div class="postcard size-${currentSize}" style="transform:scale(0.6);transform-origin:top center;">${beforeSnapshot}</div>
          </div>
          <div style="font-size:24px;color:var(--text-muted);">â†’</div>
          <div style="text-align:center;">
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">AFTER</div>
            <div id="afterCard" class="postcard size-${currentSize}" style="transform:scale(0.6);transform-origin:top center;"></div>
          </div>
        `;
        previewArea.appendChild(splitView);

        // Update after card with current
        const afterCard = document.getElementById('afterCard');
        if (afterCard) afterCard.innerHTML = frontCard.innerHTML;

      } else {
        // Remove split view
        const splitView = document.getElementById('beforeAfterSplit');
        if (splitView) splitView.remove();
        beforeSnapshot = null;
      }
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', function(e) {
      // Don't trigger shortcuts when typing in inputs
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        return;
      }

      // Ctrl+Z - Undo
      if (e.ctrlKey && e.key === 'z') {
        e.preventDefault();
        goBack();
      }

      // Ctrl+Y - Redo
      if (e.ctrlKey && e.key === 'y') {
        e.preventDefault();
        goForward();
      }

      // Ctrl+S - Save Template
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        const name = prompt('Enter template name:');
        if (name) {
          document.getElementById('templateName').value = name;
          saveTemplate();
        }
      }

      // Ctrl+E - Export PNG
      if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        exportForVistaprint();
      }

      // Space - Shuffle Design
      if (e.key === ' ' || e.code === 'Space') {
        e.preventDefault();
        generateNew();
      }
    });

    // Sync marketing fields on load
    function syncMarketingFields() {
      if (currentDesign.couponCode) {
        document.getElementById('couponCode').value = currentDesign.couponCode;
      }
      if (currentDesign.expirationDate) {
        document.getElementById('expirationDate').value = currentDesign.expirationDate;
      }
      if (currentDesign.callTrackingNumber) {
        document.getElementById('callTrackingNumber').value = currentDesign.callTrackingNumber;
      }
      if (currentDesign.language) {
        document.getElementById('languageMode').value = currentDesign.language;
      }
    }

    // ==================== 12 NEW FEATURES ====================

    // 1. A/B Testing Mode
    function startABTest() {
      const modal = document.createElement('div');
      modal.id = 'abTestModal';
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;';

      // Save current design
      const designA = JSON.parse(JSON.stringify(currentDesign));

      // Generate alternative
      const designB = {
        ...designA,
        theme: random(colorThemes),
        headline: random(headlines),
        layout: random(frontLayouts),
        discount: random(discounts)
      };

      modal.innerHTML = `
        <div style="background:var(--bg-secondary);border-radius:12px;padding:24px;max-width:95vw;overflow:auto;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 style="color:var(--text-primary);margin:0;">A/B Test Comparison</h3>
            <button onclick="document.getElementById('abTestModal').remove()" style="background:none;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer;">&times;</button>
          </div>
          <div style="display:flex;gap:30px;justify-content:center;flex-wrap:wrap;">
            <div style="text-align:center;">
              <div style="background:var(--accent);color:white;padding:8px 20px;border-radius:6px;font-weight:700;margin-bottom:10px;">VERSION A</div>
              <div id="abVersionA" class="postcard size-${currentSize}" style="transform:scale(0.7);transform-origin:top center;"></div>
              <button class="btn btn-primary" onclick="useABVersion('A')" style="margin-top:10px;">Use Version A</button>
            </div>
            <div style="text-align:center;">
              <div style="background:#8b5cf6;color:white;padding:8px 20px;border-radius:6px;font-weight:700;margin-bottom:10px;">VERSION B</div>
              <div id="abVersionB" class="postcard size-${currentSize}" style="transform:scale(0.7);transform-origin:top center;"></div>
              <button class="btn btn-primary" onclick="useABVersion('B')" style="margin-top:10px;background:#8b5cf6;">Use Version B</button>
            </div>
          </div>
          <div style="text-align:center;margin-top:20px;">
            <button class="btn btn-secondary" onclick="regenerateABTest()">Regenerate Both</button>
            <button class="btn btn-success" onclick="exportABTest()" style="margin-left:10px;">Export Both for Testing</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Render version A
      document.getElementById('abVersionA').innerHTML = document.getElementById('frontCard').innerHTML;

      // Render version B
      currentDesign = designB;
      renderPostcard();
      document.getElementById('abVersionB').innerHTML = document.getElementById('frontCard').innerHTML;

      // Restore A
      currentDesign = designA;
      renderPostcard();

      // Store for later use
      window.abDesigns = { A: designA, B: designB };
    }

    function useABVersion(version) {
      if (window.abDesigns && window.abDesigns[version]) {
        currentDesign = JSON.parse(JSON.stringify(window.abDesigns[version]));
        renderPostcard();
        updateColorSwatches();
        saveToHistory();
      }
      document.getElementById('abTestModal')?.remove();
    }

    function regenerateABTest() {
      document.getElementById('abTestModal')?.remove();
      startABTest();
    }

    async function exportABTest() {
      if (!window.abDesigns) return;

      const originalDesign = JSON.parse(JSON.stringify(currentDesign));

      // Export A
      currentDesign = window.abDesigns.A;
      renderPostcard();
      await new Promise(r => setTimeout(r, 200));
      await exportSingleCard('front', 'postcard-VERSION-A.png');

      // Export B
      currentDesign = window.abDesigns.B;
      renderPostcard();
      await new Promise(r => setTimeout(r, 200));
      await exportSingleCard('front', 'postcard-VERSION-B.png');

      // Restore
      currentDesign = originalDesign;
      renderPostcard();

      alert('Both versions exported!');
    }

    // 2. ROI Calculator
    function calculateROI() {
      const quantity = parseInt(document.getElementById('roiQuantity').value) || 500;
      const responseRate = parseFloat(document.getElementById('roiResponse').value) || 2;
      const closeRate = parseFloat(document.getElementById('roiClose').value) || 50;
      const jobValue = parseFloat(document.getElementById('roiJobValue').value) || 150;

      const leads = Math.round(quantity * (responseRate / 100));
      const jobs = Math.round(leads * (closeRate / 100));
      const revenue = jobs * jobValue;

      // Estimate mailing cost (using print cost estimator values)
      const printCost = quantity * 0.15; // Approx cost per piece
      const postageCost = quantity * 0.34; // USPS Marketing Mail rate
      const totalCost = printCost + postageCost;

      const roi = totalCost > 0 ? Math.round(((revenue - totalCost) / totalCost) * 100) : 0;

      document.getElementById('roiLeads').textContent = leads;
      document.getElementById('roiJobs').textContent = jobs;
      document.getElementById('roiRevenue').textContent = '$' + revenue.toLocaleString();
      document.getElementById('roiPercent').textContent = roi + '%';
    }

    // 3. Social Media Links
    function updateSocialLinks() {
      currentDesign.socialLinks = {
        facebook: document.getElementById('facebookUrl').value,
        instagram: document.getElementById('instagramUrl').value,
        googleReview: document.getElementById('googleReviewUrl').value
      };
      if (document.getElementById('showSocialIcons').checked) {
        renderPostcard();
      }
    }

    function toggleSocialIcons(show) {
      currentDesign.showSocialIcons = show;
      renderPostcard();
    }

    // 4. Certification Badges
    function updateCertBadges() {
      currentDesign.certBadges = {
        bbb: document.getElementById('badgeBBB').checked,
        angi: document.getElementById('badgeAngi').checked,
        homeAdvisor: document.getElementById('badgeHomeAdvisor').checked,
        yelp: document.getElementById('badgeYelp').checked,
        veteran: document.getElementById('badgeVeteran').checked,
        eco: document.getElementById('badgeEco').checked
      };
      renderPostcard();
    }

    // 5. Text Effects
    function applyTextEffect() {
      const headlineEffect = document.getElementById('headlineEffect').value;
      const discountEffect = document.getElementById('discountEffect').value;

      // Apply headline effects
      document.querySelectorAll('.postcard-front h1, .postcard-front h2').forEach(el => {
        el.style.textShadow = '';
        el.style.webkitTextStroke = '';
        el.style.animation = '';

        switch(headlineEffect) {
          case 'shadow':
            el.style.textShadow = '3px 3px 6px rgba(0,0,0,0.4)';
            break;
          case 'outline':
            el.style.webkitTextStroke = '1px white';
            el.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
            break;
          case 'glow':
            el.style.textShadow = '0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor';
            break;
          case '3d':
            el.style.textShadow = '1px 1px 0 #ccc, 2px 2px 0 #bbb, 3px 3px 0 #aaa, 4px 4px 5px rgba(0,0,0,0.3)';
            break;
        }
      });

      // Apply discount effects
      document.querySelectorAll('.discount').forEach(el => {
        el.style.animation = '';
        el.style.background = '';
        el.style.position = el.style.position || 'relative';

        switch(discountEffect) {
          case 'pulse':
            el.style.animation = 'pulse 2s ease-in-out infinite';
            break;
          case 'gradient':
            el.style.background = 'linear-gradient(135deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3)';
            el.style.backgroundSize = '300% 300%';
            el.style.animation = 'gradientShift 3s ease infinite';
            break;
          case 'starburst':
            el.style.borderRadius = '0';
            el.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
            break;
        }
      });
    }

    // 6. Image Focus Point
    function setImageFocus(position) {
      const positionMap = {
        'top-left': 'top left',
        'top-center': 'top center',
        'top-right': 'top right',
        'center-left': 'center left',
        'center': 'center center',
        'center-right': 'center right',
        'bottom-left': 'bottom left',
        'bottom-center': 'bottom center',
        'bottom-right': 'bottom right'
      };

      currentDesign.imageFocus = positionMap[position] || 'center center';

      document.querySelectorAll('.postcard-front img[style*="object-fit"]').forEach(img => {
        img.style.objectPosition = currentDesign.imageFocus;
      });

      // Also update background images
      document.querySelectorAll('.postcard-front').forEach(card => {
        if (card.style.backgroundImage) {
          card.style.backgroundPosition = currentDesign.imageFocus;
        }
      });
    }

    // 7. Mailing List Import
    let mailingList = [];

    function handleCSVUpload(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const csv = e.target.result;
          const lines = csv.split('\n');
          const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

          mailingList = [];
          for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim()) {
              const values = lines[i].split(',');
              const entry = {};
              headers.forEach((header, idx) => {
                entry[header] = values[idx]?.trim() || '';
              });
              mailingList.push(entry);
            }
          }

          document.getElementById('csvStatus').textContent = `${mailingList.length} addresses loaded`;
          renderMailingListPreview();
        };
        reader.readAsText(input.files[0]);
      }
    }

    function renderMailingListPreview() {
      const container = document.getElementById('mailingListPreview');
      if (mailingList.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = mailingList.slice(0, 5).map((entry, i) => `
        <div style="padding:4px;background:var(--bg-primary);margin-bottom:2px;border-radius:3px;">
          ${entry.name || entry.first_name || ''} ${entry.last_name || ''} - ${entry.city || ''}
        </div>
      `).join('') + (mailingList.length > 5 ? `<div style="color:var(--text-muted);text-align:center;">+ ${mailingList.length - 5} more...</div>` : '');
    }

    // 8. Analytics QR Code with UTM
    function updateAnalyticsQR() {
      const enableUTM = document.getElementById('enableUTM').checked;
      if (!enableUTM) return;

      const source = document.getElementById('utmSource').value || 'postcard';
      const campaign = document.getElementById('utmCampaign').value || 'direct_mail';
      const baseUrl = document.getElementById('qrContent').value || document.getElementById('website').value;

      if (baseUrl) {
        const separator = baseUrl.includes('?') ? '&' : '?';
        const utmUrl = `${baseUrl}${separator}utm_source=${source}&utm_medium=print&utm_campaign=${campaign}`;
        document.getElementById('qrContent').value = utmUrl;
        generateQRCode();
      }
    }

    // 9. Service Area
    function updateServiceArea() {
      currentDesign.serviceAreaCities = document.getElementById('serviceAreaCities').value;
    }

    function toggleServiceArea(show) {
      currentDesign.showServiceArea = show;
      renderPostcard();
    }

    // 10. Design History Gallery
    let visualHistory = [];

    function addToVisualHistory() {
      const frontCard = document.getElementById('frontCard');
      if (!frontCard) return;

      // Create thumbnail
      const thumbnail = {
        html: frontCard.innerHTML,
        design: JSON.parse(JSON.stringify(currentDesign)),
        timestamp: Date.now()
      };

      visualHistory.unshift(thumbnail);
      if (visualHistory.length > 20) visualHistory.pop();

      renderHistoryGallery();
    }

    function renderHistoryGallery() {
      const container = document.getElementById('designHistoryGallery');
      const countEl = document.getElementById('historyCount');

      countEl.textContent = visualHistory.length;

      container.innerHTML = visualHistory.map((item, i) => `
        <div onclick="loadFromHistory(${i})" style="cursor:pointer;border:1px solid var(--border);border-radius:4px;padding:2px;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
          <div style="width:100%;aspect-ratio:1.5;overflow:hidden;border-radius:2px;background:white;">
            <div style="transform:scale(0.15);transform-origin:top left;width:666%;height:666%;pointer-events:none;">${item.html}</div>
          </div>
        </div>
      `).join('');
    }

    function loadFromHistory(index) {
      if (visualHistory[index]) {
        currentDesign = JSON.parse(JSON.stringify(visualHistory[index].design));
        updateColorSwatches();
        updateLayoutSelect();
        renderPostcard();
      }
    }

    function clearDesignHistory() {
      if (confirm('Clear all design history?')) {
        visualHistory = [];
        renderHistoryGallery();
      }
    }

    // 11. Email Preview
    function sendEmailPreview() {
      const email = document.getElementById('previewEmail').value;
      if (!email) {
        alert('Please enter an email address');
        return;
      }

      const companyName = document.getElementById('companyName').value || 'Pool Service';
      const subject = encodeURIComponent(`Postcard Preview - ${safeCompanyName}`);
      const body = encodeURIComponent(`
Here's a preview of your postcard design:

Company: ${safeCompanyName}
Headline: ${currentDesign.headline.main}
Discount: ${currentDesign.discount.amount} ${currentDesign.discount.text}
Size: ${currentSize}

To view the full design, please open the postcard generator and load your saved template.

---
Generated with Pool Service Postcard Generator
      `);

      window.open(`mailto:${email}?subject=${subject}&body=${body}`);
    }

    // 12. EDDM Mode
    function toggleEDDMMode(enabled) {
      currentDesign.eddmMode = enabled;

      if (enabled) {
        // EDDM requires minimum 6.5" x 9" for flat rate
        // Switch to 6x9 if smaller
        if (currentSize === '4x6' || currentSize === '4.25x6' || currentSize === '5x7') {
          changePostcardSize('6x9');
          document.getElementById('sizeSelect').value = '6x9';
        }
      }

      renderPostcard();
    }

    // Override renderPostcard to add new features
    const originalRenderPostcard = renderPostcard;
    // Note: We'll add social icons and cert badges in the next edit

    // Drag & Drop Reposition
    let dragDropEnabled = false;
    let draggedElement = null;
    let dragOffset = { x: 0, y: 0 };

    function toggleDragDropMode(enabled) {
      dragDropEnabled = enabled;
      const postcards = document.querySelectorAll('.postcard-front, .postcard-back');

      postcards.forEach(postcard => {
        if (enabled) {
          postcard.style.cursor = 'move';
          // Make draggable elements
          const draggables = postcard.querySelectorAll('.discount, [contenteditable="true"], img[src*="logo"]');
          draggables.forEach(el => {
            el.style.cursor = 'grab';
            el.setAttribute('draggable', 'false'); // Use mousedown instead
            el.classList.add('draggable-element');

            // Add visual indicator
            el.style.outline = '2px dashed rgba(14, 165, 233, 0.5)';
            el.style.outlineOffset = '2px';

            el.addEventListener('mousedown', startDrag);
          });
        } else {
          postcard.style.cursor = '';
          const draggables = postcard.querySelectorAll('.draggable-element');
          draggables.forEach(el => {
            el.style.cursor = '';
            el.style.outline = '';
            el.style.outlineOffset = '';
            el.classList.remove('draggable-element');
            el.removeEventListener('mousedown', startDrag);
          });
        }
      });
    }

    function startDrag(e) {
      if (!dragDropEnabled) return;
      e.preventDefault();

      draggedElement = e.target.closest('.draggable-element');
      if (!draggedElement) return;

      // Make element absolutely positioned if not already
      const rect = draggedElement.getBoundingClientRect();
      const parentRect = draggedElement.closest('.postcard-front, .postcard-back').getBoundingClientRect();

      if (getComputedStyle(draggedElement).position !== 'absolute') {
        draggedElement.style.position = 'absolute';
        draggedElement.style.left = (rect.left - parentRect.left) + 'px';
        draggedElement.style.top = (rect.top - parentRect.top) + 'px';
        draggedElement.style.margin = '0';
      }

      dragOffset.x = e.clientX - rect.left;
      dragOffset.y = e.clientY - rect.top;

      draggedElement.style.cursor = 'grabbing';
      draggedElement.style.zIndex = '100';
      draggedElement.style.opacity = '0.8';

      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', stopDrag);
    }

    function onDrag(e) {
      if (!draggedElement) return;

      const parent = draggedElement.closest('.postcard-front, .postcard-back');
      if (!parent) return;

      const parentRect = parent.getBoundingClientRect();
      const newX = e.clientX - parentRect.left - dragOffset.x;
      const newY = e.clientY - parentRect.top - dragOffset.y;

      draggedElement.style.left = Math.max(0, newX) + 'px';
      draggedElement.style.top = Math.max(0, newY) + 'px';
    }

    function stopDrag() {
      if (draggedElement) {
        draggedElement.style.cursor = 'grab';
        draggedElement.style.zIndex = '';
        draggedElement.style.opacity = '';
      }
      draggedElement = null;

      document.removeEventListener('mousemove', onDrag);
      document.removeEventListener('mouseup', stopDrag);
    }

    // Initialize new features
    updateFavoritesCount();
    renderFavoritesList();
    loadFromUrl();

    generateNew();
    syncAllSidebarInputs(); // Restore saved sidebar values after generation

    // Apply the size after generating
    changePostcardSize(currentSize);

    // Apply discount size on load
    updateDiscountSize(100);

    updatePoolImageIndex();
    updatePoolImagePreview();
    updateLayoutSelect();
    updateLayoutDisplay();
    updateFontSelect();
    updateLockIndicator();
    setupTextAutoSave();
    updateHistoryButtons();
    updateColorPickers();

    // Initialize new features (12 additions)
    renderSavedTemplates();
    calculatePrintCost();
    syncMarketingFields();

    // Initialize 12 more features
    calculateROI();
    renderHistoryGallery();

    // Hook into generateNew to save to visual history
    const originalGenerateNew = generateNew;
    window.generateNew = function() {
      originalGenerateNew();
      setTimeout(addToVisualHistory, 100);
    };

    // Toggle Color Palette (collapsible)
    function toggleColorPalette() {
      const content = document.getElementById('colorPaletteContent');
      const arrow = document.getElementById('colorPaletteArrow');

      if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
      } else {
        content.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
      }
    }

    // Toggle Tool Sections (collapsible)
    function toggleToolSection(sectionName) {
      const content = document.getElementById(sectionName + 'Content');
      const arrow = document.getElementById(sectionName + 'Arrow');

      if (!content || !arrow) {
        console.warn('Toggle section not found:', sectionName);
        return;
      }

      if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
      } else {
        content.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
      }
    }

    // ==================== 12 FINAL FEATURES ====================

    // 1. Weather-Based / Seasonal Messaging
    const seasonalMessages = {
      summer: {
        headlines: ['Beat the Heat!', 'Summer Pool Ready?', 'Hot Days, Cool Pool!', 'Dive Into Summer!'],
        urgency: ['Book Now Before Summer Rush!', 'Limited Summer Slots!', 'Hot Weather Special!'],
        discount: ['Summer Special!', 'Beat the Heat Deal!', 'Hot Weather Savings!']
      },
      spring: {
        headlines: ['Spring Pool Opening!', 'Time to Open Your Pool!', 'Spring Into Action!', 'Pool Season Starts Now!'],
        urgency: ['Early Bird Special!', 'Book Your Opening Today!', 'Spring Schedule Filling Fast!'],
        discount: ['Spring Opening Special!', 'Early Season Savings!', 'First of Season Deal!']
      },
      fall: {
        headlines: ['Winterize Your Pool!', 'Fall Pool Closing!', 'Protect Your Investment!', 'End of Season Care!'],
        urgency: ['Schedule Before First Freeze!', 'Fall Closing Spots Limited!', 'Winterize Now!'],
        discount: ['Fall Closing Special!', 'Winterization Deal!', 'End of Season Savings!']
      },
      winter: {
        headlines: ['Off-Season Maintenance!', 'Winter Pool Care!', 'Prepare for Spring!', 'Winter Specials!'],
        urgency: ['Off-Season Rates!', 'Book Spring Opening Now!', 'Pre-Season Discount!'],
        discount: ['Winter Special!', 'Off-Season Savings!', 'Pre-Book & Save!']
      }
    };

    function applySeasonalMessaging(season) {
      if (!season || !seasonalMessages[season]) return;

      const msgs = seasonalMessages[season];
      currentDesign.headline = { main: random(msgs.headlines), sub: random(msgs.urgency) };
      currentDesign.discount.text = random(msgs.discount);

      renderPostcard();
      saveToHistory();
    }

    // 2. Campaign Manager
    let campaigns = JSON.parse(localStorage.getItem('postcardCampaigns') || '{}');

    function saveCampaign() {
      const name = document.getElementById('campaignName').value.trim();
      if (!name) { alert('Enter campaign name'); return; }

      campaigns[name] = {
        design: JSON.parse(JSON.stringify(currentDesign)),
        created: new Date().toISOString(),
        trackingCode: document.getElementById('trackingCode')?.value || ''
      };
      localStorage.setItem('postcardCampaigns', JSON.stringify(campaigns));
      document.getElementById('campaignName').value = '';
      renderCampaignsList();
    }

    function loadCampaign(name) {
      if (campaigns[name]) {
        currentDesign = JSON.parse(JSON.stringify(campaigns[name].design));
        renderPostcard();
        updateColorSwatches();
      }
    }

    function renderCampaignsList() {
      const container = document.getElementById('campaignsList');
      const names = Object.keys(campaigns);
      container.innerHTML = names.length ? names.map(n => `
        <div style="display:flex;align-items:center;gap:4px;padding:3px 0;font-size:10px;">
          <button onclick="loadCampaign('${n}')" class="quick-btn" style="flex:1;padding:3px 6px;font-size:9px;">${n}</button>
          <button onclick="deleteCampaign('${n}')" style="background:none;border:none;color:var(--danger);cursor:pointer;">Ã—</button>
        </div>
      `).join('') : '<p style="font-size:9px;color:var(--text-muted);text-align:center;">No campaigns</p>';
    }

    function deleteCampaign(name) {
      delete campaigns[name];
      localStorage.setItem('postcardCampaigns', JSON.stringify(campaigns));
      renderCampaignsList();
    }

    // 3. Print Vendor Comparison
    function showVendorComparison() {
      const qty = parseInt(document.getElementById('printQuantity').value) || 500;
      const size = currentSize;

      // Approximate pricing from popular vendors
      const vendors = {
        'Vistaprint': { base: 0.12, bulk: 0.08 },
        'GotPrint': { base: 0.10, bulk: 0.06 },
        'PrintingForLess': { base: 0.14, bulk: 0.09 },
        'Moo': { base: 0.18, bulk: 0.12 },
        'Staples': { base: 0.20, bulk: 0.15 }
      };

      const container = document.getElementById('vendorPrices');
      container.style.display = 'block';
      container.innerHTML = Object.entries(vendors).map(([name, prices]) => {
        const price = qty >= 1000 ? prices.bulk : prices.base;
        const total = Math.round(qty * price);
        return `<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--border);">
          <span>${name}</span>
          <span style="font-weight:600;color:var(--success);">$${total}</span>
        </div>`;
      }).join('');
    }

    // 4. Before/After Photos
    let beforePhoto = null;
    let afterPhoto = null;

    function handleBeforePhoto(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          beforePhoto = e.target.result;
          document.getElementById('beforePhotoPreview').innerHTML = `<img src="${beforePhoto}" style="width:100%;height:100%;object-fit:cover;">`;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function handleAfterPhoto(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          afterPhoto = e.target.result;
          document.getElementById('afterPhotoPreview').innerHTML = `<img src="${afterPhoto}" style="width:100%;height:100%;object-fit:cover;">`;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function toggleBeforeAfterPhotos(show) {
      currentDesign.showBeforeAfter = show;
      currentDesign.beforePhoto = beforePhoto;
      currentDesign.afterPhoto = afterPhoto;
      renderPostcard();
    }

    // 5. Video QR Code
    function updateVideoQR() {
      currentDesign.videoUrl = document.getElementById('videoUrl').value;
    }

    function toggleVideoQR(useVideo) {
      if (useVideo && currentDesign.videoUrl) {
        document.getElementById('qrContent').value = currentDesign.videoUrl;
        generateQRCode();
      }
    }

    // 6. Google Review Snippets
    function updateReviewSnippet() {
      currentDesign.reviewSnippet = {
        text: document.getElementById('reviewSnippet').value,
        author: document.getElementById('reviewerName').value,
        stars: document.getElementById('reviewStars')?.value || 5
      };
    }

    // 7. Neighborhood Personalization
    function updateNeighborhood() {
      currentDesign.neighborhoodName = document.getElementById('neighborhoodName').value;
    }

    function toggleNeighborhoodMsg(show) {
      currentDesign.showNeighborhood = show;
      renderPostcard();
    }

    // 8. Drip Campaign / Follow-Up Series
    const dripTemplates = {
      1: { // Intro card
        headline: { main: 'Meet Your New Pool Pro!', sub: 'Introductory Offer' },
        discount: { amount: '15% OFF', text: 'First Service' },
        urgency: 'New Customer Special!'
      },
      2: { // Reminder card
        headline: { main: "Haven't Heard From You!", sub: 'Special Still Available' },
        discount: { amount: '20% OFF', text: 'Extended Offer' },
        urgency: 'Offer Expires Soon!'
      },
      3: { // Last chance card
        headline: { main: 'Last Chance!', sub: 'Final Reminder' },
        discount: { amount: '25% OFF', text: 'Final Offer' },
        urgency: 'Expires This Week!'
      }
    };

    function createDripCard(cardNum) {
      const template = dripTemplates[cardNum];
      if (!template) return;

      currentDesign.headline = template.headline;
      currentDesign.discount = { ...currentDesign.discount, ...template.discount };
      currentDesign.urgency = template.urgency;

      renderPostcard();
      saveToHistory();
    }

    async function exportDripSeries() {
      const originalDesign = JSON.parse(JSON.stringify(currentDesign));

      for (let i = 1; i <= 3; i++) {
        createDripCard(i);
        await new Promise(r => setTimeout(r, 300));
        await exportSingleCard('front', `drip-card-${i}-FRONT.png`);
        await exportSingleCard('back', `drip-card-${i}-BACK.png`);
      }

      currentDesign = originalDesign;
      renderPostcard();
      alert('All 3 drip campaign cards exported!');
    }

    // 9. Paper Texture Preview
    function applyPaperTexture(texture) {
      const cards = document.querySelectorAll('.postcard-front, .postcard-back');
      cards.forEach(card => {
        card.style.filter = '';
        card.style.backgroundImage = '';

        switch(texture) {
          case 'glossy':
            card.style.filter = 'contrast(1.05) saturate(1.1)';
            break;
          case 'matte':
            card.style.filter = 'contrast(0.95) saturate(0.9)';
            break;
          case 'uncoated':
            card.style.filter = 'contrast(0.9) saturate(0.85) brightness(0.98)';
            break;
          case 'linen':
            card.style.filter = 'contrast(0.92) saturate(0.88)';
            break;
        }
      });
    }

    // 10. Crop Marks & Color Bars
    function toggleCropMarks(show) {
      let marks = document.getElementById('cropMarksOverlay');
      if (show) {
        if (!marks) {
          marks = document.createElement('div');
          marks.id = 'cropMarksOverlay';
          marks.style.cssText = 'position:absolute;top:-10px;left:-10px;right:-10px;bottom:-10px;pointer-events:none;z-index:100;';
          marks.innerHTML = `
            <div style="position:absolute;top:0;left:10px;width:20px;height:2px;background:#000;"></div>
            <div style="position:absolute;top:10px;left:0;width:2px;height:20px;background:#000;"></div>
            <div style="position:absolute;top:0;right:10px;width:20px;height:2px;background:#000;"></div>
            <div style="position:absolute;top:10px;right:0;width:2px;height:20px;background:#000;"></div>
            <div style="position:absolute;bottom:0;left:10px;width:20px;height:2px;background:#000;"></div>
            <div style="position:absolute;bottom:10px;left:0;width:2px;height:20px;background:#000;"></div>
            <div style="position:absolute;bottom:0;right:10px;width:20px;height:2px;background:#000;"></div>
            <div style="position:absolute;bottom:10px;right:0;width:2px;height:20px;background:#000;"></div>
          `;
          document.querySelector('.postcard-wrapper').style.position = 'relative';
          document.querySelector('.postcard-wrapper').appendChild(marks);
        }
      } else if (marks) {
        marks.remove();
      }
    }

    function toggleColorBars(show) {
      let bars = document.getElementById('colorBarsOverlay');
      if (show) {
        if (!bars) {
          bars = document.createElement('div');
          bars.id = 'colorBarsOverlay';
          bars.style.cssText = 'position:absolute;top:-25px;left:0;right:0;height:15px;display:flex;z-index:100;';
          bars.innerHTML = `
            <div style="flex:1;background:#00FFFF;"></div>
            <div style="flex:1;background:#FF00FF;"></div>
            <div style="flex:1;background:#FFFF00;"></div>
            <div style="flex:1;background:#000000;"></div>
            <div style="flex:1;background:#FF0000;"></div>
            <div style="flex:1;background:#00FF00;"></div>
            <div style="flex:1;background:#0000FF;"></div>
          `;
          document.querySelector('.postcard-wrapper').style.position = 'relative';
          document.querySelector('.postcard-wrapper').appendChild(bars);
        }
      } else if (bars) {
        bars.remove();
      }
    }

    // 11. License/Insurance Credentials
    function updateCredentials() {
      currentDesign.credentials = {
        license: document.getElementById('licenseNumber').value,
        insurance: document.getElementById('insuranceInfo').value
      };
    }

    function toggleCredentials(show) {
      currentDesign.showCredentials = show;
      renderPostcard();
    }

    // 12. Response Tracking Code
    function updateTrackingCode() {
      currentDesign.trackingCode = document.getElementById('trackingCode').value;
      renderPostcard();
    }

    // ============ NEW FEATURES BATCH ============

    // 1. Watermark Mode
    function toggleWatermark(show) {
      currentDesign.showWatermark = show;
      renderPostcard();
    }

    function updateWatermarkStyle() {
      currentDesign.watermarkStyle = document.getElementById('watermarkStyle').value;
      if (currentDesign.showWatermark) renderPostcard();
    }

    // 2. Holiday/Event Themes
    const holidayThemes = {
      memorial: { headline: 'Memorial Day Pool Special!', colors: ['#002868', '#BF0A30', '#FFFFFF'], discount: '20% OFF' },
      july4th: { headline: 'July 4th Pool Party Ready!', colors: ['#FF0000', '#FFFFFF', '#0000FF'], discount: 'FREE Cleaning' },
      labor: { headline: 'End of Summer Pool Sale!', colors: ['#1E3A5F', '#FFD700', '#FFFFFF'], discount: '25% OFF' },
      poolopener: { headline: 'Pool Season Is Here!', colors: ['#00CED1', '#32CD32', '#FFD700'], discount: 'Opening Special' },
      backtoschool: { headline: 'Fall Pool Prep Special!', colors: ['#FF6600', '#8B4513', '#FFD700'], discount: '15% OFF' },
      thanksgiving: { headline: 'Thankful For Clean Pools!', colors: ['#8B4513', '#FF6600', '#FFD700'], discount: 'Holiday Deal' }
    };

    function applyHolidayTheme(theme) {
      if (!theme || !holidayThemes[theme]) return;
      const t = holidayThemes[theme];
      currentDesign.headline = t.headline;
      currentDesign.primaryColor = t.colors[0];
      currentDesign.discountText = t.discount;
      document.getElementById('headline').value = t.headline;
      document.getElementById('primaryColor').value = t.colors[0];
      renderPostcard();
    }

    // 3. Referral Program
    function toggleReferralBox(show) {
      currentDesign.showReferral = show;
      renderPostcard();
    }

    function updateReferralBox() {
      currentDesign.referralAmount = document.getElementById('referralAmount').value;
      currentDesign.referralType = document.getElementById('referralType').value;
      if (currentDesign.showReferral) renderPostcard();
    }

    // 4. Bundle Deals
    function toggleBundleDeal(show) {
      currentDesign.showBundleDeal = show;
      renderPostcard();
    }

    function updateBundleDeal() {
      currentDesign.bundleType = document.getElementById('bundleType').value;
      if (currentDesign.showBundleDeal) renderPostcard();
    }

    // 5. Font Selector
    function updateFonts() {
      currentDesign.headlineFont = document.getElementById('headlineFont').value;
      currentDesign.bodyFont = document.getElementById('bodyFont').value;

      // Load Google Fonts dynamically
      const fonts = [currentDesign.headlineFont, currentDesign.bodyFont].filter(f => f);
      fonts.forEach(font => {
        if (!document.querySelector(`link[href*="${font.replace(' ', '+')}"]`)) {
          const link = document.createElement('link');
          link.href = `https://fonts.googleapis.com/css2?family=${font.replace(' ', '+')}:wght@400;600;700&display=swap`;
          link.rel = 'stylesheet';
          document.head.appendChild(link);
        }
      });
      renderPostcard();
    }

    // 6. QR Code Customizer
    function updateQRStyle() {
      currentDesign.qrStyle = {
        fgColor: document.getElementById('qrFgColor').value,
        bgColor: document.getElementById('qrBgColor').value,
        style: document.getElementById('qrStyle').value,
        withLogo: document.getElementById('qrWithLogo').checked
      };
      renderPostcard();
    }

    // 7. Image Filters
    function applyImageFilters() {
      const brightness = document.getElementById('imgBrightness').value;
      const contrast = document.getElementById('imgContrast').value;
      const saturation = document.getElementById('imgSaturation').value;

      currentDesign.imageFilters = { brightness, contrast, saturation };

      const poolImage = document.querySelector('.pool-image');
      if (poolImage) {
        poolImage.style.filter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%)`;
      }
    }

    function resetImageFilters() {
      document.getElementById('imgBrightness').value = 100;
      document.getElementById('imgContrast').value = 100;
      document.getElementById('imgSaturation').value = 100;
      applyImageFilters();
    }

    // 8. Border/Frame Styles
    function applyBorderStyle(style) {
      const color = document.getElementById('borderColor').value;
      const width = document.getElementById('borderWidth').value;
      currentDesign.borderStyle = { style, color, width };

      const postcard = document.querySelector('.postcard');
      if (!postcard) return;

      // Remove existing border overlay
      const existing = document.getElementById('borderOverlay');
      if (existing) existing.remove();

      if (style === 'none') {
        postcard.style.border = 'none';
        return;
      }

      if (style === 'simple') {
        postcard.style.border = `${width}px solid ${color}`;
      } else if (style === 'double') {
        postcard.style.border = `${width}px double ${color}`;
      } else {
        // Decorative borders use overlay
        postcard.style.border = 'none';
        const overlay = document.createElement('div');
        overlay.id = 'borderOverlay';
        overlay.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:50;';

        if (style === 'wave') {
          overlay.style.border = `${width}px solid ${color}`;
          overlay.style.borderImage = `repeating-linear-gradient(90deg, ${color} 0px, ${color} 10px, transparent 10px, transparent 20px) 1`;
        } else if (style === 'tropical') {
          overlay.style.borderRadius = '0';
          overlay.style.boxShadow = `inset 0 0 0 ${width}px ${color}, inset ${width*2}px ${width*2}px 0 ${color}40`;
        } else if (style === 'tile') {
          overlay.style.border = `${width}px solid ${color}`;
          overlay.style.background = `repeating-linear-gradient(45deg, transparent, transparent 5px, ${color}20 5px, ${color}20 10px)`;
          overlay.style.backgroundClip = 'padding-box';
        } else if (style === 'splash') {
          overlay.style.border = `${width}px solid ${color}`;
          overlay.style.borderRadius = '50% 20% 50% 20% / 20% 50% 20% 50%';
        }

        postcard.style.position = 'relative';
        postcard.appendChild(overlay);
      }
    }

    // 9. Guarantee Badge
    function toggleGuaranteeBadge(show) {
      currentDesign.showGuarantee = show;
      renderPostcard();
    }

    function updateGuaranteeBadge() {
      currentDesign.guaranteeType = document.getElementById('guaranteeType').value;
      if (currentDesign.showGuarantee) renderPostcard();
    }

    // 10. Emergency Service Badge
    function toggleEmergencyBadge(show) {
      currentDesign.showEmergency = show;
      renderPostcard();
    }

    function updateEmergencyBadge() {
      currentDesign.emergencyType = document.getElementById('emergencyType').value;
      if (currentDesign.showEmergency) renderPostcard();
    }

    // 11. Auto-Save & Recovery
    let autoSaveInterval = null;

    function toggleAutoSave(enabled) {
      if (enabled) {
        autoSaveInterval = setInterval(autoSaveDesign, 30000); // Every 30 seconds
        autoSaveDesign(); // Save immediately
      } else {
        if (autoSaveInterval) clearInterval(autoSaveInterval);
      }
    }

    function autoSaveDesign() {
      try {
        const backup = {
          design: currentDesign,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem('postcardAutoSave', JSON.stringify(backup));

        // Update status
        const status = document.getElementById('autoSaveStatus');
        if (status) {
          const time = new Date().toLocaleTimeString();
          status.textContent = `Last saved: ${time}`;
        }
      } catch (e) {
        console.warn('Auto-save failed:', e);
      }
    }

    function recoverLastDesign() {
      try {
        const saved = localStorage.getItem('postcardAutoSave');
        if (saved) {
          const backup = JSON.parse(saved);
          currentDesign = { ...currentDesign, ...backup.design };
          renderPostcard();
          updateAllInputs();
          alert('Design recovered from ' + new Date(backup.timestamp).toLocaleString());
        } else {
          alert('No backup found');
        }
      } catch (e) {
        alert('Recovery failed: ' + e.message);
      }
    }

    function clearAutoSaves() {
      localStorage.removeItem('postcardAutoSave');
      document.getElementById('autoSaveStatus').textContent = 'Last saved: Never';
      alert('Backups cleared');
    }

    function updateAllInputs() {
      // Sync all inputs with currentDesign
      if (currentDesign.headline) document.getElementById('headline').value = currentDesign.headline;
      if (currentDesign.companyName) document.getElementById('companyName').value = currentDesign.companyName;
      if (currentDesign.phone) document.getElementById('phone').value = currentDesign.phone;
      if (currentDesign.website) document.getElementById('website').value = currentDesign.website;
      if (currentDesign.primaryColor) document.getElementById('primaryColor').value = currentDesign.primaryColor;
    }

    // Initialize auto-save on load
    if (document.getElementById('autoSaveEnabled')?.checked) {
      toggleAutoSave(true);
    }

    // Initialize new features on load
    renderCampaignsList();
  </script>
</body>
</html>
