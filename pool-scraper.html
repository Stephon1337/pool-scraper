<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https:; connect-src 'self' https:;">
  <title>AquaDesk - Scraper</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    /* Hide duplicate nav when inside AquaDesk dashboard iframe */
    .in-iframe .header .logo,
    .in-iframe .header .nav-tabs { display: none !important; }
    .in-iframe .header .tabs { border-left: none !important; margin-left: 0 !important; padding-left: 0 !important; }
    :root {
      --bg: #0a0a0f;
      --bg-card: #12121a;
      --bg-hover: #1a1a24;
      --border: #2a2a35;
      --text: #e4e4e7;
      --text-dim: #71717a;
      --accent: #06b6d4;
      --green: #22c55e;
      --orange: #f59e0b;
      --red: #ef4444;
      --cyan: #06b6d4;
    }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); font-size: 13px; }

    /* Header */
    .header { display: flex; align-items: center; padding: 8px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; gap: 12px; }
    .logo { font-weight: 700; font-size: 15px; color: var(--text); display: flex; align-items: center; gap: 8px; }
    .logo span { color: var(--accent); }
    .nav-tabs { display: flex; gap: 4px; }
    .nav-tab { padding: 6px 14px; border-radius: 6px; cursor: pointer; color: var(--text-dim); font-size: 12px; font-weight: 500; text-decoration: none; display: flex; align-items: center; gap: 6px; background: var(--bg-hover); transition: all 0.15s; }
    .nav-tab:hover { background: var(--accent); color: #000; }
    .nav-tab.active { background: var(--accent); color: #000; }
    .tabs { display: flex; gap: 4px; margin-left: 16px; border-left: 1px solid var(--border); padding-left: 16px; }
    .tab { padding: 6px 14px; border-radius: 6px; cursor: pointer; color: var(--text-dim); font-size: 12px; font-weight: 500; border: 1px solid transparent; }
    .tab:hover { background: var(--bg-hover); color: var(--text); }
    .tab.active { background: var(--bg-hover); color: var(--accent); border: 1px solid var(--border); }
    .tab .badge { background: var(--green); color: #000; font-size: 10px; padding: 1px 5px; border-radius: 8px; margin-left: 4px; }
    .header-right { margin-left: auto; display: flex; gap: 8px; align-items: center; }

    /* Layout */
    .app { display: flex; height: calc(100vh - 41px); }
    .panel-left { width: 320px; min-width: 320px; border-right: 1px solid var(--border); overflow-y: auto; background: var(--bg-card); }
    .panel-main { flex: 1; overflow-y: auto; padding: 16px; }

    /* Sections */
    .section { padding: 12px; border-bottom: 1px solid var(--border); }
    .section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-dim); margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .section-title:hover { color: var(--text); }
    .section-title .arrow { transition: transform 0.2s; }
    .section.collapsed .section-content { display: none; }
    .section.collapsed .arrow { transform: rotate(-90deg); }

    /* Drop Zone */
    .dropzone { border: 2px dashed var(--border); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .dropzone:hover, .dropzone.drag-over { border-color: var(--accent); background: rgba(99,102,241,0.1); }
    .dropzone.has-file { border-color: var(--green); background: rgba(34,197,94,0.1); }
    .dropzone-icon { font-size: 24px; margin-bottom: 6px; }
    .dropzone h4 { font-size: 13px; margin-bottom: 4px; }
    .dropzone p { font-size: 11px; color: var(--text-dim); }
    .file-info { margin-top: 8px; font-size: 11px; color: var(--green); }

    /* Form Elements */
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    .form-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }
    .form-group input, .form-group select { padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }

    .checkbox-row { display: flex; flex-wrap: wrap; gap: 8px; }
    .checkbox-item { display: flex; align-items: center; gap: 4px; font-size: 11px; }
    .checkbox-item input { accent-color: var(--accent); }

    /* Buttons */
    .btn { padding: 8px 14px; border: none; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.15s; }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-success { background: var(--green); color: #000; }
    .btn-secondary { background: var(--bg-hover); color: var(--text); border: 1px solid var(--border); }
    .btn-sm { padding: 4px 8px; font-size: 10px; }
    .btn-lg { padding: 10px 20px; font-size: 13px; width: 100%; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Stats Bar */
    .stats-bar { display: flex; gap: 12px; padding: 10px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
    .stat { text-align: center; }
    .stat-value { font-size: 18px; font-weight: 700; }
    .stat-value.green { color: var(--green); }
    .stat-value.orange { color: var(--orange); }
    .stat-value.red { color: var(--red); }
    .stat-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; }

    /* Export Bar */
    .export-bar { display: flex; align-items: center; gap: 12px; padding: 10px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
    .export-bar select, .export-bar input[type="number"] { padding: 5px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 11px; }
    .export-bar label { font-size: 11px; color: var(--text-dim); }
    .export-preview { font-size: 12px; color: var(--green); font-weight: 600; }
    .export-options { display: flex; align-items: center; gap: 12px; margin-left: auto; }
    .export-option { display: flex; align-items: center; gap: 4px; font-size: 11px; }

    /* Action Bar */
    .action-bar { display: flex; gap: 6px; padding: 10px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); flex-wrap: wrap; }

    /* Filter Bar */
    .filter-bar { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
    .search-input { flex: 1; max-width: 250px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px; }
    .filter-chips { display: flex; gap: 4px; }
    .chip { padding: 4px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; background: var(--bg-hover); color: var(--text-dim); border: 1px solid transparent; }
    .chip:hover { color: var(--text); }
    .chip.active { background: var(--accent); color: white; border-color: var(--accent); }
    .chip.orange { border-color: var(--orange); }
    .chip.green { border-color: var(--green); }
    .chip.red { border-color: var(--red); }

    /* Table */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 11px; }
    th { text-align: left; padding: 8px; background: var(--bg-card); border-bottom: 2px solid var(--border); font-size: 10px; text-transform: uppercase; color: var(--text-dim); white-space: nowrap; cursor: pointer; }
    th:hover { color: var(--text); }
    td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: var(--bg-hover); }
    .sort-icon { margin-left: 4px; opacity: 0.5; }
    .badge { padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600; }
    .badge-green { background: rgba(34,197,94,0.2); color: var(--green); }
    .badge-orange { background: rgba(245,158,11,0.2); color: var(--orange); }
    .note-input { width: 100%; padding: 4px 6px; border: 1px solid transparent; border-radius: 3px; background: transparent; color: var(--text); font-size: 11px; }
    .note-input:hover, .note-input:focus { border-color: var(--border); background: var(--bg); outline: none; }
    .row-btn { padding: 2px 6px; border: none; background: var(--bg-hover); border-radius: 3px; cursor: pointer; font-size: 10px; }
    .row-btn:hover { background: var(--accent); }
    .row-btn.danger:hover { background: var(--red); }

    /* Location Summary */
    .location-bar { padding: 10px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
    .location-bar h5 { font-size: 10px; color: var(--text-dim); margin-bottom: 6px; text-transform: uppercase; }
    .location-chips { display: flex; flex-wrap: wrap; gap: 4px; }
    .loc-chip { padding: 3px 8px; border-radius: 10px; font-size: 10px; background: var(--bg-hover); cursor: pointer; }
    .loc-chip:hover { background: var(--accent); color: white; }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal.show { display: flex; }
    .modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; width: 400px; max-width: 90%; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-header h3 { font-size: 15px; }
    .modal-close { background: none; border: none; color: var(--text-dim); font-size: 20px; cursor: pointer; }

    /* Progress */
    .progress { height: 6px; background: var(--bg-hover); border-radius: 3px; overflow: hidden; margin: 8px 0; }
    .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }
    .progress-text { font-size: 11px; color: var(--text-dim); text-align: center; }

    /* Empty State */
    .empty { text-align: center; padding: 60px 20px; color: var(--text-dim); }
    .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty h4 { font-size: 14px; margin-bottom: 6px; color: var(--text); }

    /* Secondary Panels */
    .secondary-panel { display: none; }
    .secondary-panel.active { display: block; }
    .panel-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .panel-card h3 { font-size: 14px; margin-bottom: 12px; }

    /* Toast */
    .toast { position: fixed; bottom: 20px; right: 20px; background: var(--bg-card); border: 1px solid var(--border); padding: 12px 20px; border-radius: 8px; z-index: 2000; animation: slideIn 0.3s; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } }

    /* Mailed List */
    .mailed-grid { display: grid; grid-template-columns: 1fr 50px 70px 50px; gap: 6px; font-size: 10px; font-family: monospace; }
    .mailed-header { color: var(--text-dim); font-weight: 600; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
    .mailed-row { padding: 4px 0; border-bottom: 1px solid var(--border); }
    .mailed-row.recyclable { background: rgba(34,197,94,0.1); }

    /* Collapsible mapper */
    .mapper-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .mapper-grid .form-group { margin-bottom: 0; }
    .preview-row { margin-top: 10px; padding: 8px; background: var(--bg); border-radius: 4px; font-size: 10px; color: var(--text-dim); max-height: 60px; overflow: auto; }

    .hidden { display: none !important; }
    input[type="file"] { display: none; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>
  <script>if(window.self!==window.top)document.documentElement.classList.add('in-iframe');</script>
  <!-- Header -->
  <header class="header">
    <div class="logo">üíß AquaDesk</div>
    <div class="nav-tabs" style="border-left:1px solid var(--border); margin-left:12px; padding-left:12px;">
      <a href="#" class="nav-tab active">üìã Scraper</a>
      <a href="PoolVerifier.html" class="nav-tab" onclick="saveBeforeNav(event, this.href)">üîç Identifier</a>
      <a href="postcard.html" class="nav-tab">üé® Postcard</a>
      <span id="sessionStatus" style="margin-left:10px; font-size:11px; padding:3px 8px; border-radius:4px; background:var(--bg); color:var(--text-dim);"></span>
    </div>
    <div class="tabs" style="border-left:1px solid var(--border); margin-left:12px; padding-left:12px;">
      <div class="tab active" onclick="showTab('main')">Process</div>
      <div class="tab" onclick="showTab('campaigns')">Campaigns <span class="badge" id="campaignBadge" style="display:none">0</span></div>
      <div class="tab" onclick="showTab('mailed')">Mailed <span class="badge" id="mailedBadge" style="display:none">0</span></div>
      <div class="tab" onclick="showTab('history')">History</div>
      <div class="tab" onclick="showTab('settings')">Settings</div>
      <div class="tab" onclick="showTab('help')">Help</div>
    </div>
    <div class="header-right">
      <span style="font-size:10px; color:var(--text-dim); margin-right:12px;" title="Press ? for all shortcuts">‚å®Ô∏è <kbd style="background:var(--bg); padding:2px 5px; border-radius:3px;">P</kbd>=Process <kbd style="background:var(--bg); padding:2px 5px; border-radius:3px;">E</kbd>=Export <kbd style="background:var(--bg); padding:2px 5px; border-radius:3px;">/</kbd>=Search</span>
      <button class="btn btn-secondary btn-sm" onclick="clearAll()">Clear All</button>
    </div>
  </header>

  <!-- Main Tab -->
  <div id="tab-main" class="secondary-panel active">
    <div class="app">
      <!-- Left Panel -->
      <div class="panel-left">
        <!-- Upload Section -->
        <div class="section">
          <div class="dropzone" id="dropZone">
            <div class="dropzone-icon">üìÅ</div>
            <h4>Drop files or folder here</h4>
            <p>CSV, TXT, TSV ‚Ä¢ Or upload entire data folder</p>
            <div class="file-info" id="fileInfo"></div>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <input type="file" id="fileInput" accept=".txt,.csv,.tsv" style="display:none">
            <input type="file" id="folderInput" webkitdirectory multiple style="display:none">
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('fileInput').click()">üìÑ Single File</button>
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('folderInput').click()">üìÇ Upload Folder</button>
          </div>
          <div id="detectedInfo" style="margin-top:8px; font-size:11px; color:var(--green); display:none;"></div>
          <div id="folderFilesInfo" style="margin-top:8px; font-size:11px; display:none;"></div>
        </div>

        <!-- Additional Lookup Files -->
        <div class="section" id="lookupSection" style="display:none;">
          <div class="section-title" onclick="toggleSection(this)">
            Additional Data Files <span class="arrow">‚ñº</span>
          </div>
          <div class="section-content">
            <p style="font-size:11px; color:var(--text-dim); margin-bottom:8px;">Load extra files to merge (sales, extrafeatures, subdivisions). Files are joined by Parcel ID.</p>
            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
              <div class="lookup-file" id="lookupSales" onclick="document.getElementById('salesFileInput').click()" style="padding:8px 12px; border:1px dashed var(--border); border-radius:4px; cursor:pointer; font-size:11px;">
                üìÑ Sales Data <span id="salesFileStatus" style="color:var(--text-dim);">(none)</span>
              </div>
              <div class="lookup-file" id="lookupFeatures" onclick="document.getElementById('featuresFileInput').click()" style="padding:8px 12px; border:1px dashed var(--border); border-radius:4px; cursor:pointer; font-size:11px;">
                üèä Extra Features <span id="featuresFileStatus" style="color:var(--text-dim);">(none)</span>
              </div>
              <div class="lookup-file" id="lookupSubdiv" onclick="document.getElementById('subdivFileInput').click()" style="padding:8px 12px; border:1px dashed var(--border); border-radius:4px; cursor:pointer; font-size:11px;">
                üèòÔ∏è Subdivisions <span id="subdivFileStatus" style="color:var(--text-dim);">(none)</span>
              </div>
            </div>
            <input type="file" id="salesFileInput" accept=".csv" style="display:none">
            <input type="file" id="featuresFileInput" accept=".csv" style="display:none">
            <input type="file" id="subdivFileInput" accept=".csv" style="display:none">
            <div id="lookupKeyConfig" style="display:none; margin-top:8px;">
              <div class="form-row">
                <div class="form-group"><label>Main Key Column</label><select id="mainKeyCol"><option value="-1">--</option></select></div>
                <div class="form-group"><label>Pool Filter (Features)</label><input type="text" id="poolFilterKeyword" value="POOL" placeholder="POOL"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mapper Auto-Detect Banner -->
        <div id="mapperBanner" style="display:none; padding:8px 12px; margin-bottom:6px; background:var(--surface); border:1px solid var(--border); border-radius:6px; font-size:12px;"></div>
        <!-- Column Mapping -->
        <div class="section" id="mapperSection" style="display:none;">
          <div class="section-title" onclick="toggleSection(this)">
            Column Mapping <span class="arrow">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="mapper-grid">
              <div class="form-group"><label>Name</label><select id="mapName"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Address 1</label><select id="mapPropAddress"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Address 2</label><select id="mapAddress2"><option value="-1">--</option></select></div>
              <div class="form-group"><label>City</label><select id="mapPropCity"><option value="-1">--</option></select></div>
              <div class="form-group"><label>State</label><select id="mapPropState"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Zip</label><select id="mapFilterZip"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Mail Addr</label><select id="mapAddress1"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Mail City</label><select id="mapCity"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Mail State</label><select id="mapState"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Mail Zip</label><select id="mapZip"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Filter Col</label><select id="mapFilter"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Value</label><select id="mapValue"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Year Built</label><select id="mapYearBuilt"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Prop Type</label><select id="mapPropType"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Assessed</label><select id="mapAssessedValue"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Sale Date</label><select id="mapSaleDate"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Subdivision</label><select id="mapSubdivision"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Lot SqFt</label><select id="mapLotSize"><option value="-1">--</option></select></div>
              <div class="form-group"><label>Living SqFt</label><select id="mapLivingArea"><option value="-1">--</option></select></div>
            </div>
            <div id="previewRow" class="preview-row"></div>
            <div style="display:flex; gap:6px; margin-top:8px;">
              <input type="text" id="presetName" placeholder="Preset name..." style="flex:1; padding:5px 8px; border:1px solid var(--border); border-radius:4px; background:var(--bg); color:var(--text); font-size:11px;">
              <button class="btn btn-sm btn-primary" onclick="saveCurrentPreset()">Save</button>
            </div>
          </div>
        </div>

        <!-- Location Filters -->
        <div class="section">
          <div class="section-title" onclick="toggleSection(this)">
            Location Filters <span class="arrow">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="form-row">
              <div class="form-group"><label>State</label><input type="text" id="targetState" placeholder="Auto-detect"></div>
              <div class="form-group"><label>Cities</label><input type="text" id="targetCities" placeholder="Orlando, Tampa"></div>
            </div>
            <div class="form-group"><label>Zip Codes</label><input type="text" id="targetZips" placeholder="32746, 32801"></div>
          </div>
        </div>

        <!-- Property Filters -->
        <div class="section collapsed">
          <div class="section-title" onclick="toggleSection(this)">
            Property Filters <span class="arrow">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="form-row">
              <div class="form-group"><label>Min Value</label><input type="number" id="minValue" placeholder="200000"></div>
              <div class="form-group"><label>Max Value</label><input type="number" id="maxValue" placeholder="1000000"></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Min Year</label><input type="number" id="minYear" placeholder="1970"></div>
              <div class="form-group"><label>Max Year</label><input type="number" id="maxYear" placeholder="2020"></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Min Pool Age</label><input type="number" id="minPoolAge" placeholder="5"></div>
              <div class="form-group"><label>Max Pool Age</label><input type="number" id="maxPoolAge" placeholder="30"></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Min Assessed</label><input type="number" id="minAssessed" placeholder="0"></div>
              <div class="form-group"><label>Max Assessed</label><input type="number" id="maxAssessed" placeholder="0"></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Min Days Since Sale</label><input type="number" id="minDaysSinceSale" placeholder="0"></div>
              <div class="form-group"><label>Max Days Since Sale</label><input type="number" id="maxDaysSinceSale" placeholder="730" title="e.g., 730 = 2 years"></div>
            </div>
            <div style="margin-top:10px; padding-top:8px; border-top:1px solid var(--border);">
              <label style="font-size:10px; color:var(--accent); text-transform:uppercase; font-weight:600;">Trigger Filters (flag qualifying properties)</label>
              <div class="form-row" style="margin-top:6px;">
                <div class="form-group"><label>Min Lot SqFt</label><input type="number" id="trigMinLot" placeholder="21780"></div>
                <div class="form-group"><label>Max Lot SqFt</label><input type="number" id="trigMaxLot" placeholder=""></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Min Living SqFt</label><input type="number" id="trigMinLiving" placeholder="3000"></div>
                <div class="form-group"><label>Max Living SqFt</label><input type="number" id="trigMaxLiving" placeholder=""></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Min Market Value</label><input type="number" id="trigMinValue" placeholder=""></div>
                <div class="form-group"><label>Max Market Value</label><input type="number" id="trigMaxValue" placeholder=""></div>
              </div>
            </div>
            <div style="margin-top:8px;">
              <label style="font-size:10px; color:var(--text-dim); text-transform:uppercase;">Property Types</label>
              <div class="checkbox-row" style="margin-top:4px;">
                <label class="checkbox-item"><input type="checkbox" id="allowSFR" checked> SFR</label>
                <label class="checkbox-item"><input type="checkbox" id="allowCondo" checked> Condo</label>
                <label class="checkbox-item"><input type="checkbox" id="allowMulti"> Multi</label>
                <label class="checkbox-item"><input type="checkbox" id="allowVacant"> Vacant</label>
                <label class="checkbox-item"><input type="checkbox" id="allowOther" checked> Other</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Output Options -->
        <div class="section collapsed">
          <div class="section-title" onclick="toggleSection(this)">
            Output Options <span class="arrow">‚ñº</span>
          </div>
          <div class="section-content">
            <div class="checkbox-row">
              <label class="checkbox-item"><input type="checkbox" id="removeBiz"> No Business</label>
              <label class="checkbox-item"><input type="checkbox" id="absenteeOnly"> Absentee Only</label>
              <label class="checkbox-item"><input type="checkbox" id="uppercase"> UPPERCASE</label>
              <label class="checkbox-item"><input type="checkbox" id="excludeNoPool" checked> Exclude No Pool</label>
            </div>
            <p style="font-size:10px; color:var(--text-dim); margin-top:6px;">Auto-removes: PO Box, Suite/Unit, Out-of-State, Foreign. "Exclude No Pool" removes addresses marked ‚ùå in Identifier.</p>
          </div>
        </div>

        <!-- Sample Preview -->
        <div class="section" id="samplePreviewCard" style="display:none;">
          <div class="section-title">Sample Preview</div>
          <div class="section-content">
            <table style="font-size:10px;">
              <thead><tr><th>Name</th><th>Address</th><th>City</th><th>State</th><th>Zip</th><th>Value</th><th>Year</th><th>Subdiv</th></tr></thead>
              <tbody id="samplePreviewBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Process Button -->
        <div class="section">
          <button class="btn btn-primary btn-lg" id="processBtn" disabled>Process File</button>
          <div id="progressContainer" style="display:none;">
            <div class="progress"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
            <div class="progress-text" id="progressText">Processing...</div>
          </div>
        </div>
      </div>

      <!-- Main Panel -->
      <div class="panel-main" id="resultsPanel">
        <!-- Empty State -->
        <div class="empty" id="emptyState">
          <div class="empty-icon">üìã</div>
          <h4>No Data Yet</h4>
          <div style="display:flex; flex-direction:column; gap:10px; margin-top:12px; text-align:left; max-width:320px; font-size:13px; color:var(--text-dim);">
            <div style="display:flex; gap:10px; align-items:flex-start;">
              <span style="background:var(--accent); color:#000; width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:11px; flex-shrink:0;">1</span>
              <span>Drop a parcel <strong style="color:var(--text);">CSV</strong> or <strong style="color:var(--text);">TXT</strong> file on the left panel</span>
            </div>
            <div style="display:flex; gap:10px; align-items:flex-start;">
              <span style="background:var(--accent); color:#000; width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:11px; flex-shrink:0;">2</span>
              <span>Columns auto-map to your county format ‚Äî adjust if needed</span>
            </div>
            <div style="display:flex; gap:10px; align-items:flex-start;">
              <span style="background:var(--accent); color:#000; width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:11px; flex-shrink:0;">3</span>
              <span>Click <strong style="color:var(--text);">Process</strong> to filter pool owners</span>
            </div>
          </div>
        </div>

        <!-- Results (hidden initially) -->
        <div id="resultsSection" style="display:none;">
          <!-- Stats -->
          <div class="stats-bar">
            <div class="stat"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Scanned</div></div>
            <div class="stat"><div class="stat-value green" id="statMatches">0</div><div class="stat-label">Matches</div></div>
            <div class="stat"><div class="stat-value orange" id="statDupes">0</div><div class="stat-label">Dupes</div></div>
            <div class="stat"><div class="stat-value orange" id="statBiz">0</div><div class="stat-label">Business</div></div>
            <div class="stat"><div class="stat-value red" id="statExcluded">0</div><div class="stat-label">Removed</div></div>
          </div>

          <!-- Quick Stats Card -->
          <div id="quickStatsCard" style="display:none; padding:14px 16px; margin-bottom:10px; background:linear-gradient(135deg, var(--surface) 0%, rgba(6,182,212,0.08) 100%); border:1px solid var(--border); border-radius:8px;">
            <div id="quickStatsText" style="font-size:13px; color:var(--text); margin-bottom:8px; font-weight:600;"></div>
            <div id="quickStatsSubdivs" style="font-size:11px; color:var(--text-dim); margin-bottom:12px; line-height:1.6;"></div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-success" onclick="quickVistaPrintExport()" style="font-weight:700;">‚ö° VistaPrint Export</button>
              <button class="btn" style="background:#06b6d4; color:#000; font-weight:600;" onclick="sendFilteredToVerifier()">üì§ Send to Identifier</button>
              <button class="btn btn-secondary btn-sm" onclick="document.getElementById('advancedExportSection').classList.toggle('collapsed')" style="margin-left:auto; font-size:11px;">More Options ‚ñº</button>
            </div>
          </div>

          <!-- Advanced Export (collapsed by default) -->
          <div class="section collapsed" id="advancedExportSection">
          <div class="section-content">
          <!-- Export Bar -->
          <div class="export-bar">
            <label>Export:</label>
            <select id="exportCount">
              <option value="0">All</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="250">250</option>
              <option value="500">500</option>
              <option value="1000">1000</option>
              <option value="custom">Custom</option>
            </select>
            <input type="number" id="customExportCount" placeholder="#" min="1" style="display:none; width:60px;">
            <span class="export-preview">‚Üí <span id="exportPreviewCount">0</span> records</span>
            <div class="export-options">
              <label class="export-option"><input type="checkbox" id="skipExported" checked> Skip mailed</label>
              <label class="export-option"><input type="checkbox" id="includeRecycle"> +Recyclable</label>
              <select id="recycleDays" style="width:70px;">
                <option value="14">14 days</option>
                <option value="21">21 days</option>
                <option value="30" selected>30 days</option>
                <option value="45">45 days</option>
                <option value="60">60 days</option>
                <option value="90">90 days</option>
              </select>
            </div>
          </div>

          <!-- Action Bar -->
          <div class="action-bar">
            <button class="btn btn-success" onclick="downloadCSV()">Export CSV</button>
            <button class="btn btn-primary" onclick="downloadAllCSV()">Export All</button>
            <button class="btn" style="background:#7c3aed; color:white;" onclick="exportLabels()">Labels</button>
            <button class="btn" style="background:#10b981; color:white;" onclick="sortByRoute()">üö∂ Subdiv Route</button>
            <button class="btn" style="background:#06b6d4; color:#000; font-weight:600;" onclick="sendFilteredToVerifier()">üì§ Send to Identifier</button>
          </div>
          </div><!-- end section-content -->
          </div><!-- end advancedExportSection -->

          <!-- Filter Bar -->
          <div class="filter-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="Search..." oninput="filterTable()">
            <div class="filter-chips">
              <span class="chip active" onclick="setFilter('all')">All</span>
              <span class="chip" onclick="setFilter('residential')">Residential</span>
              <span class="chip orange" onclick="setFilter('business')">Business</span>
              <span class="chip red" onclick="setFilter('absentee')">Absentee</span>
              <span class="chip green" onclick="setFilter('owner')">Owner</span>
              <span class="chip" style="border-color:#f59e0b;" onclick="setFilter('triggered')">‚ö° Triggered</span>
            </div>
          </div>

          <!-- Location Summary -->
          <div class="location-bar" id="exportSummary" style="display:none;">
            <h5>Quick Filter by Location</h5>
            <div id="citySummary" class="location-chips" style="margin-bottom:6px;"></div>
            <div id="zipSummary" class="location-chips"></div>
          </div>

          <!-- Subdivision Picker -->
          <div class="location-bar" id="subdivPicker" style="display:none;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
              <h5 style="margin:0;">üìç Pick Subdivisions to Walk</h5>
              <button class="btn" style="padding:2px 8px; font-size:10px; background:var(--accent,#06b6d4); color:#000;" onclick="toggleAllSubdivs(true)">All</button>
              <button class="btn" style="padding:2px 8px; font-size:10px; background:#333; color:#ccc;" onclick="toggleAllSubdivs(false)">None</button>
              <span id="subdivSelectedCount" style="font-size:11px; color:#71717a; margin-left:auto;">0 selected</span>
            </div>
            <div id="subdivChecklist" style="display:flex; flex-wrap:wrap; gap:4px; max-height:120px; overflow-y:auto;"></div>
          </div>

          <!-- Table -->
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:50px;">Act</th>
                  <th class="sortable" onclick="sortTable('recipient')">Recipient <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" onclick="sortTable('propertyAddress')">Prop Addr <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" onclick="sortTable('mailingAddress')">Mail Addr <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" onclick="sortTable('city')">City <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" onclick="sortTable('state')">St <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" onclick="sortTable('zipcode')">Zip <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" onclick="sortTable('propertyValue')">Value <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" onclick="sortTable('subdivision')">Subdiv <span class="sort-icon">‚Üï</span></th>
                  <th>Triggers</th>
                  <th class="sortable" onclick="sortTable('poolAge')">Age <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" onclick="sortTable('saleDate')">Sold <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" onclick="sortTable('isAbsentee')">Type <span class="sort-icon">‚Üï</span></th>
                  <th class="sortable" onclick="sortTable('mailCount')" style="width:45px;">üì¨ <span class="sort-icon">‚Üï</span></th>
                  <th style="width:120px;">Notes</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
          <!-- Pagination -->
          <div id="paginationBar" style="display:flex; align-items:center; justify-content:center; gap:8px; padding:12px 16px; background:var(--bg-card); border-top:1px solid var(--border);">
            <button class="btn btn-secondary btn-sm" onclick="goToPage(1)" id="btnFirst">‚èÆ First</button>
            <button class="btn btn-secondary btn-sm" onclick="goToPage(currentPage - 1)" id="btnPrev">‚óÄ Prev</button>
            <span style="font-size:12px; margin:0 12px;">
              Page <input type="number" id="pageInput" min="1" value="1" style="width:50px; padding:4px; border:1px solid var(--border); border-radius:4px; background:var(--bg); color:var(--text); text-align:center;" onchange="goToPage(parseInt(this.value))">
              of <span id="totalPages">1</span>
            </span>
            <button class="btn btn-secondary btn-sm" onclick="goToPage(currentPage + 1)" id="btnNext">Next ‚ñ∂</button>
            <button class="btn btn-secondary btn-sm" onclick="goToPage(totalPages)" id="btnLast">Last ‚è≠</button>
            <select id="perPageSelect" style="margin-left:12px; padding:4px 8px; border:1px solid var(--border); border-radius:4px; background:var(--bg); color:var(--text); font-size:11px;" onchange="changePerPage(this.value)">
              <option value="50">50/page</option>
              <option value="100" selected>100/page</option>
              <option value="250">250/page</option>
              <option value="500">500/page</option>
              <option value="1000">1000/page</option>
            </select>
          </div>
          <div id="tableInfo" style="padding:8px 16px; font-size:11px; color:var(--text-dim);"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Campaigns Tab -->
  <div id="tab-campaigns" class="secondary-panel">
    <div style="max-width:1200px; margin:0 auto; padding:20px;">
      <!-- Campaign Stats -->
      <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:12px; margin-bottom:20px;">
        <div class="panel-card" style="text-align:center; padding:16px;">
          <div style="font-size:28px; font-weight:700; color:var(--accent);" id="campStatTotal">0</div>
          <div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">Campaigns</div>
        </div>
        <div class="panel-card" style="text-align:center; padding:16px;">
          <div style="font-size:28px; font-weight:700; color:var(--cyan);" id="campStatSent">0</div>
          <div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">Total Sent</div>
        </div>
        <div class="panel-card" style="text-align:center; padding:16px;">
          <div style="font-size:28px; font-weight:700; color:var(--green);" id="campStatCalls">0</div>
          <div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">Responses</div>
        </div>
        <div class="panel-card" style="text-align:center; padding:16px;">
          <div style="font-size:28px; font-weight:700; color:var(--green);" id="campStatRevenue">$0</div>
          <div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">Revenue</div>
        </div>
        <div class="panel-card" style="text-align:center; padding:16px; cursor:pointer;" onclick="openRoiCalculator()">
          <div style="font-size:28px; font-weight:700; color:var(--orange);" id="campStatRoi">0%</div>
          <div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">ROI üí∞</div>
        </div>
      </div>

      <!-- Quick Log Response -->
      <div class="panel-card" style="margin-bottom:16px;" id="quickLogForm">
        <h3 style="margin-bottom:12px;">üìû Quick Log Response</h3>
        <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
          <div style="flex:1; min-width:160px;">
            <label style="font-size:10px; text-transform:uppercase; color:var(--text-dim); display:block; margin-bottom:4px;">Campaign</label>
            <select id="quickLogCampaign" style="width:100%; padding:8px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text); font-size:12px;">
              <option value="">Select campaign...</option>
            </select>
          </div>
          <div style="min-width:80px;">
            <label style="font-size:10px; text-transform:uppercase; color:var(--text-dim); display:block; margin-bottom:4px;">Calls</label>
            <input type="number" id="quickLogCalls" min="0" value="1" style="width:100%; padding:8px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text); font-size:12px;">
          </div>
          <div style="min-width:100px;">
            <label style="font-size:10px; text-transform:uppercase; color:var(--text-dim); display:block; margin-bottom:4px;">Revenue ($)</label>
            <input type="number" id="quickLogRevenue" min="0" step="0.01" placeholder="0.00" style="width:100%; padding:8px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text); font-size:12px;">
          </div>
          <button class="btn btn-primary" onclick="submitQuickLog()" style="padding:8px 16px; white-space:nowrap;">Save</button>
        </div>
      </div>

      <!-- Campaign List -->
      <div class="panel-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3>üìÆ Postcard Campaigns</h3>
          <div style="display:flex; gap:8px;">
            <a href="postcard.html" class="btn btn-primary" style="text-decoration:none;">Create in Postcard ‚Üí</a>
            <button class="btn btn-secondary btn-sm" onclick="exportCampaignsData()">Export All</button>
          </div>
        </div>

        <div id="campaignList">
          <div style="text-align:center; padding:40px; color:var(--text-dim);">
            <div style="font-size:48px; margin-bottom:12px;">üìÆ</div>
            <p>No campaigns yet</p>
            <p style="font-size:12px; margin-top:8px;">Create campaigns in the Postcard tool</p>
          </div>
        </div>
      </div>

      <!-- Ready to Resend -->
      <div class="panel-card" style="margin-top:20px;">
        <h3 style="margin-bottom:16px;">üîÑ Ready to Resend (30+ days)</h3>
        <div id="resendList">
          <p style="color:var(--text-dim); font-size:12px;">Addresses ready for another postcard will appear here</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Mailed Tab -->
  <div id="tab-mailed" class="secondary-panel">
    <div style="max-width:1000px; margin:0 auto; padding:20px;">
      <div class="panel-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3>üì¨ Mailed Address Tracker</h3>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-secondary btn-sm" onclick="exportMailedList()">Export</button>
            <button class="btn btn-secondary btn-sm" onclick="importMailedList()">Import</button>
            <button class="btn btn-sm" style="background:var(--red); color:white;" onclick="clearMailedList()">Clear</button>
          </div>
        </div>
        <div id="mailedCount" style="font-size:12px; color:var(--text-dim); margin-bottom:12px;">0 addresses tracked</div>
        <div id="mailedListPreview"></div>
        <input type="file" id="mailedFileInput" accept=".txt,.csv" onchange="handleMailedFile(this)" style="display:none;">
      </div>
    </div>
  </div>

  <!-- History Tab -->
  <div id="tab-history" class="secondary-panel">
    <div style="max-width:800px; margin:0 auto; padding:20px;">
      <div class="panel-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3>üìä Export History</h3>
          <button class="btn btn-sm" style="background:var(--red); color:white;" onclick="clearHistory()">Clear</button>
        </div>
        <div id="historyList"></div>
      </div>
    </div>
  </div>

  <!-- Settings Tab -->
  <div id="tab-settings" class="secondary-panel">
    <div style="max-width:800px; margin:0 auto; padding:20px;">
      <!-- Exclude List -->
      <div class="panel-card">
        <h3 style="margin-bottom:12px;">üö´ Exclude List</h3>
        <p style="font-size:11px; color:var(--text-dim); margin-bottom:12px;">Addresses containing these will be removed</p>
        <textarea id="excludeList" rows="4" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--bg); color:var(--text); font-size:12px; resize:vertical;"></textarea>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn btn-primary btn-sm" onclick="saveExcludeList()">Save</button>
          <span id="excludeCount" style="font-size:11px; color:var(--text-dim); align-self:center;">0 addresses</span>
        </div>
      </div>

      <!-- Saved Presets -->
      <div class="panel-card">
        <h3 style="margin-bottom:12px;">üíæ Saved Presets</h3>
        <div id="savedPresets"></div>
      </div>
    </div>
  </div>

  <!-- Help Tab -->
  <div id="tab-help" class="secondary-panel">
    <div style="max-width:900px; margin:0 auto; padding:20px;">
      <div class="panel-card">
        <h3 style="margin-bottom:16px;">‚ùì How to Use Pool Scraper Pro</h3>
        <div style="font-size:12px; line-height:1.6; color:var(--text-dim);">

          <h4 style="color:var(--text); margin:16px 0 8px;">1. Upload Data</h4>
          <p>Drag & drop or click to upload county parcel CSV/TXT files. Auto-detects Seminole and Orange County formats.</p>

          <h4 style="color:var(--text); margin:16px 0 8px;">2. Map Columns</h4>
          <p>Configure column mappings for the property address (where postcards go). Optionally map Mail Address to detect absentee owners (when mailing address differs from property).</p>

          <h4 style="color:var(--text); margin:16px 0 8px;">3. Configure Filters</h4>
          <ul style="margin-left:20px;">
            <li><strong>Location</strong> - State, cities, zip codes</li>
            <li><strong>Property Value</strong> - Min/Max market value</li>
            <li><strong>Year Built</strong> - Filter by construction year</li>
            <li><strong>Pool Age</strong> - Target pools needing service (10-15y = resurfacing, 20+y = renovation)</li>
            <li><strong>Days Since Sale</strong> - New owners (0-730 days) are hot leads</li>
            <li><strong>Property Types</strong> - SFR, Condo, Multi, Vacant</li>
          </ul>

          <h4 style="color:var(--text); margin:16px 0 8px;">4. Output Options</h4>
          <ul style="margin-left:20px;">
            <li><strong>No Business</strong> - Exclude commercial properties</li>
            <li><strong>Absentee Only</strong> - Only owners who don't live at the property</li>
            <li><strong>UPPERCASE</strong> - Format addresses in uppercase</li>
            <li><strong>Exclude No Pool</strong> - Skip addresses marked ‚ùå in Pool Identifier</li>
          </ul>

          <h4 style="color:var(--text); margin:16px 0 8px;">5. Process & Review</h4>
          <p>Click Process to filter data. The table shows:</p>
          <ul style="margin-left:20px;">
            <li><strong>Address/City</strong> - Property address (where the pool is located)</li>
            <li><strong>Type</strong> - "Absent" (orange) = absentee owner, "Owner" (green) = lives at property</li>
            <li><strong>Sold</strong> - Days/years since last sale (hover for date)</li>
            <li><strong>‚úì/‚úó</strong> - USPS validation status (after running validation)</li>
          </ul>

          <h4 style="color:var(--text); margin:16px 0 8px;">6. Export Options</h4>
          <ul style="margin-left:20px;">
            <li><strong>Export CSV</strong> - Download filtered records</li>
            <li><strong>Export All</strong> - Download all processed records</li>
            <li><strong>Recyclable Only</strong> - Re-mail addresses after 30+ days</li>
            <li><strong>Labels</strong> - Avery 5160 format for printing</li>
            <li><strong>Sync to Identifier</strong> - Send to Pool Identifier for visual confirmation</li>
            <li><strong>‚úì Validate USPS</strong> - Verify addresses are deliverable</li>
          </ul>

          <h4 style="color:var(--text); margin:16px 0 8px;">7. Route Optimization (Door-to-Door)</h4>
          <ul style="margin-left:20px;">
            <li><strong>Sort Route</strong> - Organize by Zip ‚Üí City ‚Üí Street ‚Üí House #</li>
            <li><strong>üó∫Ô∏è Open Route</strong> - Open first 10 stops in Google Maps</li>
            <li><strong>üìç Export Route</strong> - Download CSV with numbered stops</li>
          </ul>

          <h4 style="color:var(--text); margin:16px 0 8px;">8. Mailing Tracker</h4>
          <p>Track how many times each address has been mailed (1x, 2x... 7x is the magic number!). Use "Recyclable" to re-mail after 30+ days.</p>

          <h4 style="color:var(--accent); margin:16px 0 8px;">‚å®Ô∏è Keyboard Shortcuts</h4>
          <table style="width:100%; font-size:11px; border-collapse:collapse;">
            <tr><td style="padding:4px; border-bottom:1px solid var(--border);"><kbd>P</kbd></td><td style="padding:4px; border-bottom:1px solid var(--border);">Process file</td></tr>
            <tr><td style="padding:4px; border-bottom:1px solid var(--border);"><kbd>E</kbd></td><td style="padding:4px; border-bottom:1px solid var(--border);">Export CSV</td></tr>
            <tr><td style="padding:4px; border-bottom:1px solid var(--border);"><kbd>R</kbd></td><td style="padding:4px; border-bottom:1px solid var(--border);">Export Recyclable</td></tr>
            <tr><td style="padding:4px; border-bottom:1px solid var(--border);"><kbd>V</kbd></td><td style="padding:4px; border-bottom:1px solid var(--border);">Sync to Identifier</td></tr>
            <tr><td style="padding:4px; border-bottom:1px solid var(--border);"><kbd>A</kbd> / <kbd>D</kbd></td><td style="padding:4px; border-bottom:1px solid var(--border);">Previous / Next page</td></tr>
            <tr><td style="padding:4px; border-bottom:1px solid var(--border);"><kbd>/</kbd></td><td style="padding:4px; border-bottom:1px solid var(--border);">Focus search</td></tr>
            <tr><td style="padding:4px; border-bottom:1px solid var(--border);"><kbd>Esc</kbd></td><td style="padding:4px; border-bottom:1px solid var(--border);">Clear all filters</td></tr>
            <tr><td style="padding:4px;"><kbd>?</kbd></td><td style="padding:4px;">Show shortcuts help</td></tr>
          </table>

          <h4 style="color:var(--text); margin:16px 0 8px;">üí° Tips</h4>
          <ul style="margin-left:20px;">
            <li>New owners (< 2 years) are often the best leads - they inherited pool problems</li>
            <li>Absentee owners need pool service more - they can't maintain it themselves</li>
            <li>Use Pool Identifier to visually confirm pools exist before mailing</li>
            <li>Addresses marked ‚ùå No Pool in Identifier are auto-excluded</li>
            <li>1,200+ cities across all 50 states are auto-normalized</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Record</h3>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <div class="form-group" style="margin-bottom:10px;"><label>Recipient</label><input type="text" id="editRecipient"></div>
      <div class="form-group" style="margin-bottom:10px;"><label>Company</label><input type="text" id="editCompany"></div>
      <div class="form-group" style="margin-bottom:10px;"><label>Address</label><input type="text" id="editAddress"></div>
      <div class="form-row" style="margin-bottom:10px;">
        <div class="form-group"><label>City</label><input type="text" id="editCity"></div>
        <div class="form-group"><label>State</label><input type="text" id="editState"></div>
      </div>
      <div class="form-group" style="margin-bottom:16px;"><label>Zipcode</label><input type="text" id="editZipcode"></div>
      <button class="btn btn-primary btn-lg" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>

  <!-- Campaign Detail Modal -->
  <div class="modal" id="campaignDetailModal">
    <div class="modal-content" style="width:700px; max-height:80vh; overflow-y:auto;">
      <div class="modal-header">
        <h3 id="campDetailTitle">Campaign Details</h3>
        <button class="modal-close" onclick="closeCampaignDetail()">&times;</button>
      </div>
      <div id="campDetailContent"></div>
    </div>
  </div>

  <!-- ROI Calculator Modal -->
  <div class="modal" id="roiCalcModal">
    <div class="modal-content" style="width:420px;">
      <div class="modal-header">
        <h3>üí∞ ROI Calculator</h3>
        <button class="modal-close" onclick="closeRoiCalculator()">&times;</button>
      </div>
      <div class="form-group" style="margin-bottom:12px;">
        <label>Cost Per Postcard ($)</label>
        <input type="number" id="roiCostPerCard" value="0.75" step="0.01" min="0" oninput="calculateROI()">
      </div>
      <div class="form-row" style="margin-bottom:12px;">
        <div class="form-group">
          <label>Postcards Sent</label>
          <input type="number" id="roiCardsSent" value="0" min="0" oninput="calculateROI()">
        </div>
        <div class="form-group">
          <label>Calls Received</label>
          <input type="number" id="roiCalls" value="0" min="0" oninput="calculateROI()">
        </div>
      </div>
      <div class="form-group" style="margin-bottom:12px;">
        <label>Total Revenue Generated ($)</label>
        <input type="number" id="roiRevenue" value="0" step="1" min="0" oninput="calculateROI()">
      </div>
      <div style="background:var(--bg); padding:16px; border-radius:8px; margin-top:16px;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; text-align:center;">
          <div>
            <div style="font-size:10px; color:var(--text-dim); text-transform:uppercase;">Total Cost</div>
            <div style="font-size:22px; font-weight:700; color:var(--red);" id="roiResultCost">$0</div>
          </div>
          <div>
            <div style="font-size:10px; color:var(--text-dim); text-transform:uppercase;">Profit</div>
            <div style="font-size:22px; font-weight:700; color:var(--green);" id="roiResultProfit">$0</div>
          </div>
          <div>
            <div style="font-size:10px; color:var(--text-dim); text-transform:uppercase;">ROI</div>
            <div style="font-size:22px; font-weight:700; color:var(--accent);" id="roiResultRoi">0%</div>
          </div>
          <div>
            <div style="font-size:10px; color:var(--text-dim); text-transform:uppercase;">Cost Per Call</div>
            <div style="font-size:22px; font-weight:700; color:var(--orange);" id="roiResultCPC">-</div>
          </div>
        </div>
        <div style="margin-top:16px; padding-top:12px; border-top:1px solid var(--border); text-align:center;">
          <div style="font-size:10px; color:var(--text-dim); text-transform:uppercase;">Conversion Rate</div>
          <div style="font-size:18px; font-weight:700; color:var(--cyan);" id="roiResultConv">0%</div>
        </div>
      </div>
      <div style="margin-top:16px; text-align:center;">
        <button class="btn btn-secondary" onclick="closeRoiCalculator()">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" style="display:none;"></div>

<script>
    // State variables
    let fileContent = null;
    let parsedRows = [];
    let headers = [];
    let results = [];
    let filteredResults = [];
    let currentFilter = 'all';
    let editingIndex = -1;
    let currentZipFilter = null;
    let currentCityFilter = null;
    let detectedDelimiter = ',';

    // Constants
    const VERIFY_STATUS = Object.freeze({ VERIFIED: 'verified', NO_POOL: 'no-pool' });
    const TOAST_DURATION_MS = 3000;
    const PROGRESS_UPDATE_INTERVAL = 1000;
    const MIN_YEAR_BUILT = 1800;
    const EARTH_RADIUS_KM = 6371;
    const DEFAULT_RECYCLE_DAYS = 30;
    const MAX_LOCALSTORAGE_RECORDS = 5000;
    const GEOCACHE_TTL_MS = 7 * 24 * 60 * 60 * 1000; // 7 days
    const LOOKUP_TIMEOUT_MS = 10000;

    // DOR property type codes (Florida)
    const DOR_CODES = Object.freeze({
      VACANT: 0, SFR: 1, MOBILE: 2, MULTI_FAMILY: 3, CONDO: 4,
      COOP: 5, RETIREMENT: 6, MISC_RES: 7, APARTMENTS: 8, HOA_COMMON: 9
    });

    // US state name ‚Üí abbreviation map
    const STATE_NAME_TO_ABBREV = Object.freeze({
      'ALABAMA': 'AL', 'ALASKA': 'AK', 'ARIZONA': 'AZ', 'ARKANSAS': 'AR', 'CALIFORNIA': 'CA',
      'COLORADO': 'CO', 'CONNECTICUT': 'CT', 'DELAWARE': 'DE', 'FLORIDA': 'FL', 'GEORGIA': 'GA',
      'HAWAII': 'HI', 'IDAHO': 'ID', 'ILLINOIS': 'IL', 'INDIANA': 'IN', 'IOWA': 'IA',
      'KANSAS': 'KS', 'KENTUCKY': 'KY', 'LOUISIANA': 'LA', 'MAINE': 'ME', 'MARYLAND': 'MD',
      'MASSACHUSETTS': 'MA', 'MICHIGAN': 'MI', 'MINNESOTA': 'MN', 'MISSISSIPPI': 'MS', 'MISSOURI': 'MO',
      'MONTANA': 'MT', 'NEBRASKA': 'NE', 'NEVADA': 'NV', 'NEW HAMPSHIRE': 'NH', 'NEW JERSEY': 'NJ',
      'NEW MEXICO': 'NM', 'NEW YORK': 'NY', 'NORTH CAROLINA': 'NC', 'NORTH DAKOTA': 'ND', 'OHIO': 'OH',
      'OKLAHOMA': 'OK', 'OREGON': 'OR', 'PENNSYLVANIA': 'PA', 'RHODE ISLAND': 'RI', 'SOUTH CAROLINA': 'SC',
      'SOUTH DAKOTA': 'SD', 'TENNESSEE': 'TN', 'TEXAS': 'TX', 'UTAH': 'UT', 'VERMONT': 'VT',
      'VIRGINIA': 'VA', 'WASHINGTON': 'WA', 'WEST VIRGINIA': 'WV', 'WISCONSIN': 'WI', 'WYOMING': 'WY'
    });

    // HTML escape for XSS prevention
    function csvSafe(val) {
      const s = String(val == null ? '' : val).replace(/"/g, '""');
      if (/^[=+\-@\t\r]/.test(s)) return "'" + s;
      return s;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    let excludeAddresses = []; try { excludeAddresses = JSON.parse(localStorage.getItem('poolscraper_exclude') || '[]'); } catch(e){ console.warn('[scraper] exclude parse:', e.message); }
    let exportHistory = []; try { exportHistory = JSON.parse(localStorage.getItem('poolscraper_history') || '[]'); } catch(e){ console.warn('[scraper] history parse:', e.message); }
    let savedPresets = {}; try { savedPresets = JSON.parse(localStorage.getItem('poolscraper_presets') || '{}'); } catch(e){ console.warn('[scraper] presets parse:', e.message); }

    // Lookup data from additional files (keyed by parcel ID)
    let salesLookup = {};  // parcel ID -> {saleDate, salePrice, saleQual}
    let featuresLookup = {};  // parcel ID -> {hasPool: true/false, features: []}
    let subdivLookup = {};  // parcel ID -> {subdivision, neighborhood}

    // Campaign tracking
    let campaigns = []; try { campaigns = JSON.parse(localStorage.getItem('poolscraper_campaigns') || '[]'); } catch(e){ console.warn('[scraper] campaigns parse:', e.message); }

    // Mailed tracking with counts and dates
    let mailedTracker = {}; try { mailedTracker = JSON.parse(localStorage.getItem('poolscraper_mailed_v2') || '{}'); } catch(e){ console.warn('[scraper] mailed parse:', e.message); }

    // Migrate old format
    const oldMailed = JSON.parse(localStorage.getItem('poolscraper_mailed') || '[]');
    if (oldMailed.length > 0) {
      if (Object.keys(mailedTracker).length === 0) {
        const today = new Date().toISOString().slice(0, 10);
        oldMailed.forEach(addr => {
          mailedTracker[addr.toUpperCase()] = { count: 1, firstMailed: today, lastMailed: today };
        });
        localStorage.setItem('poolscraper_mailed_v2', JSON.stringify(mailedTracker));
      }
      localStorage.removeItem('poolscraper_mailed');
    }

    let mailedAddresses = Object.keys(mailedTracker);

    // Load pool verifier status (verified/no-pool)
    let verifierStatus = {};
    try { verifierStatus = JSON.parse(localStorage.getItem('poolVerifierData') || '{}'); } catch (e) { console.warn('[scraper] verifier status parse:', e.message); }

    // Sync mailedTracker across tabs (prevents phantom state when both scraper and verifier are open)
    window.addEventListener('storage', function(e) {
      if (e.key === 'poolscraper_mailed_v2' && e.newValue) {
        try {
          mailedTracker = JSON.parse(e.newValue);
          mailedAddresses = Object.keys(mailedTracker);
          if (typeof renderTable === 'function' && filteredResults.length > 0) renderTable();
        } catch (err) { console.warn('[scraper] mailed sync:', err.message); }
      }
      if (e.key === 'poolVerifierData' && e.newValue) {
        try { verifierStatus = JSON.parse(e.newValue); } catch (err) { console.warn('[scraper] verifier sync:', err.message); }
        if (typeof renderTable === 'function' && filteredResults.length > 0) renderTable();
      }
    });

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const processBtn = document.getElementById('processBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const resultsSection = document.getElementById('resultsSection');
    const tableBody = document.getElementById('tableBody');
    const emptyState = document.getElementById('emptyState');

    // City lookup
    const cityLookup = {
      'LONGWOOD': { state: 'FL', zip: '32750', normalize: 'Longwood' },
      'LAKE MARY': { state: 'FL', zip: '32746', normalize: 'Lake Mary' },
      'SANFORD': { state: 'FL', zip: '32771', normalize: 'Sanford' },
      'OVIEDO': { state: 'FL', zip: '32765', normalize: 'Oviedo' },
      'WINTER SPRINGS': { state: 'FL', zip: '32708', normalize: 'Winter Springs' },
      'WINTER SPGS': { state: 'FL', zip: '32708', normalize: 'Winter Springs' },
      'WINTER SPG': { state: 'FL', zip: '32708', normalize: 'Winter Springs' },
      'ALTAMONTE SPRINGS': { state: 'FL', zip: '32701', normalize: 'Altamonte Springs' },
      'ALTAMONTE SPGS': { state: 'FL', zip: '32701', normalize: 'Altamonte Springs' },
      'ALTAMONTE SPG': { state: 'FL', zip: '32701', normalize: 'Altamonte Springs' },
      'ALTAMONTE': { state: 'FL', zip: '32701', normalize: 'Altamonte Springs' },
      'CASSELBERRY': { state: 'FL', zip: '32707', normalize: 'Casselberry' },
      'ORLANDO': { state: 'FL', zip: '32801', normalize: 'Orlando' },
      'APOPKA': { state: 'FL', zip: '32703', normalize: 'Apopka' },
      'MAITLAND': { state: 'FL', zip: '32751', normalize: 'Maitland' },
      'WINTER PARK': { state: 'FL', zip: '32789', normalize: 'Winter Park' },
      'WINTER PK': { state: 'FL', zip: '32789', normalize: 'Winter Park' },
      'GENEVA': { state: 'FL', zip: '32732', normalize: 'Geneva' },
      'CHULUOTA': { state: 'FL', zip: '32766', normalize: 'Chuluota' },
      'FERN PARK': { state: 'FL', zip: '32730', normalize: 'Fern Park' },
      'FOREST CITY': { state: 'FL', zip: '32714', normalize: 'Forest City' },
      'HEATHROW': { state: 'FL', zip: '32746', normalize: 'Heathrow' },
      'WEKIVA SPRINGS': { state: 'FL', zip: '32779', normalize: 'Wekiva Springs' },
      'DELTONA': { state: 'FL', zip: '32725', normalize: 'Deltona' },
      'DEBARY': { state: 'FL', zip: '32713', normalize: 'DeBary' },
      'BELLE ISLE': { state: 'FL', zip: '32812', normalize: 'Belle Isle' },
      'KISSIMMEE': { state: 'FL', zip: '34741', normalize: 'Kissimmee' },
      'CLERMONT': { state: 'FL', zip: '34711', normalize: 'Clermont' },
      'WINDERMERE': { state: 'FL', zip: '34786', normalize: 'Windermere' },
      'LAKE BUENA VISTA': { state: 'FL', zip: '32830', normalize: 'Lake Buena Vista' },
      'CELEBRATION': { state: 'FL', zip: '34747', normalize: 'Celebration' },
      'DAVENPORT': { state: 'FL', zip: '33837', normalize: 'Davenport' },
      'SAINT CLOUD': { state: 'FL', zip: '34769', normalize: 'Saint Cloud' },
      'ST CLOUD': { state: 'FL', zip: '34769', normalize: 'Saint Cloud' },
      'JACKSONVILLE': { state: 'FL', zip: '32099', normalize: 'Jacksonville' },
      'TAMPA': { state: 'FL', zip: '33601', normalize: 'Tampa' },
      'MIAMI': { state: 'FL', zip: '33101', normalize: 'Miami' },
      'FORT LAUDERDALE': { state: 'FL', zip: '33301', normalize: 'Fort Lauderdale' },
      'FT LAUDERDALE': { state: 'FL', zip: '33301', normalize: 'Fort Lauderdale' },
      'WEST PALM BEACH': { state: 'FL', zip: '33401', normalize: 'West Palm Beach' },
      'PALM BEACH': { state: 'FL', zip: '33480', normalize: 'Palm Beach' },
      'BOCA RATON': { state: 'FL', zip: '33427', normalize: 'Boca Raton' },
      'SARASOTA': { state: 'FL', zip: '34230', normalize: 'Sarasota' },
      'NAPLES': { state: 'FL', zip: '34101', normalize: 'Naples' },
      'GAINESVILLE': { state: 'FL', zip: '32601', normalize: 'Gainesville' },
      'OCALA': { state: 'FL', zip: '34470', normalize: 'Ocala' },
      'DAYTONA BEACH': { state: 'FL', zip: '32114', normalize: 'Daytona Beach' },
      'PORT ORANGE': { state: 'FL', zip: '32127', normalize: 'Port Orange' },
      'NEW SMYRNA BEACH': { state: 'FL', zip: '32168', normalize: 'New Smyrna Beach' },
      'NEW SMYRNA': { state: 'FL', zip: '32168', normalize: 'New Smyrna Beach' },
      'SANTA ROSA BEACH': { state: 'FL', zip: '32459', normalize: 'Santa Rosa Beach' },
      'SANTA RSA BEACH': { state: 'FL', zip: '32459', normalize: 'Santa Rosa Beach' },
      'ORANGE PARK': { state: 'FL', zip: '32065', normalize: 'Orange Park' },
      'ORMOND BEACH': { state: 'FL', zip: '32174', normalize: 'Ormond Beach' },
      'PENSACOLA': { state: 'FL', zip: '32501', normalize: 'Pensacola' },
      'GULF BREEZE': { state: 'FL', zip: '32561', normalize: 'Gulf Breeze' },
      'MILTON': { state: 'FL', zip: '32570', normalize: 'Milton' },
      'HIGH SPRINGS': { state: 'FL', zip: '32643', normalize: 'High Springs' },
      'WILLISTON': { state: 'FL', zip: '32696', normalize: 'Williston' },
      'FLAGLER BEACH': { state: 'FL', zip: '32136', normalize: 'Flagler Beach' },
      'PALM COAST': { state: 'FL', zip: '32137', normalize: 'Palm Coast' },
      'DELAND': { state: 'FL', zip: '32720', normalize: 'DeLand' },
      'DESTIN': { state: 'FL', zip: '32541', normalize: 'Destin' },
      'FORT WALTON BEACH': { state: 'FL', zip: '32548', normalize: 'Fort Walton Beach' },
      'FT WALTON BEACH': { state: 'FL', zip: '32548', normalize: 'Fort Walton Beach' },
      'NICEVILLE': { state: 'FL', zip: '32578', normalize: 'Niceville' },
      'CRESTVIEW': { state: 'FL', zip: '32536', normalize: 'Crestview' },
      'PANAMA CITY': { state: 'FL', zip: '32401', normalize: 'Panama City' },
      'PANAMA CITY BEACH': { state: 'FL', zip: '32407', normalize: 'Panama City Beach' },
      'MARIANNA': { state: 'FL', zip: '32446', normalize: 'Marianna' },
      'TALLAHASSEE': { state: 'FL', zip: '32301', normalize: 'Tallahassee' },
      'FORT MYERS': { state: 'FL', zip: '33901', normalize: 'Fort Myers' },
      'FT MYERS': { state: 'FL', zip: '33901', normalize: 'Fort Myers' },
      'CAPE CORAL': { state: 'FL', zip: '33904', normalize: 'Cape Coral' },
      'BONITA SPRINGS': { state: 'FL', zip: '34134', normalize: 'Bonita Springs' },
      'ESTERO': { state: 'FL', zip: '33928', normalize: 'Estero' },
      'FORT PIERCE': { state: 'FL', zip: '34950', normalize: 'Fort Pierce' },
      'FT PIERCE': { state: 'FL', zip: '34950', normalize: 'Fort Pierce' },
      'PORT ST LUCIE': { state: 'FL', zip: '34952', normalize: 'Port Saint Lucie' },
      'PORT SAINT LUCIE': { state: 'FL', zip: '34952', normalize: 'Port Saint Lucie' },
      'STUART': { state: 'FL', zip: '34994', normalize: 'Stuart' },
      'VERO BEACH': { state: 'FL', zip: '32960', normalize: 'Vero Beach' },
      'SEBASTIAN': { state: 'FL', zip: '32958', normalize: 'Sebastian' },
      'MELBOURNE': { state: 'FL', zip: '32901', normalize: 'Melbourne' },
      'PALM BAY': { state: 'FL', zip: '32905', normalize: 'Palm Bay' },
      'TITUSVILLE': { state: 'FL', zip: '32780', normalize: 'Titusville' },
      'COCOA': { state: 'FL', zip: '32922', normalize: 'Cocoa' },
      'COCOA BEACH': { state: 'FL', zip: '32931', normalize: 'Cocoa Beach' },
      'MERRITT ISLAND': { state: 'FL', zip: '32952', normalize: 'Merritt Island' },
      'ROCKLEDGE': { state: 'FL', zip: '32955', normalize: 'Rockledge' },
      'SAINT AUGUSTINE': { state: 'FL', zip: '32084', normalize: 'Saint Augustine' },
      'ST AUGUSTINE': { state: 'FL', zip: '32084', normalize: 'Saint Augustine' },
      'SAINT PETERSBURG': { state: 'FL', zip: '33701', normalize: 'Saint Petersburg' },
      'ST PETERSBURG': { state: 'FL', zip: '33701', normalize: 'Saint Petersburg' },
      'CLEARWATER': { state: 'FL', zip: '33755', normalize: 'Clearwater' },
      'LARGO': { state: 'FL', zip: '33770', normalize: 'Largo' },
      'DUNEDIN': { state: 'FL', zip: '34698', normalize: 'Dunedin' },
      'TARPON SPRINGS': { state: 'FL', zip: '34689', normalize: 'Tarpon Springs' },
      'BRADENTON': { state: 'FL', zip: '34201', normalize: 'Bradenton' },
      'LAKELAND': { state: 'FL', zip: '33801', normalize: 'Lakeland' },
      'WINTER HAVEN': { state: 'FL', zip: '33880', normalize: 'Winter Haven' },
      'BARTOW': { state: 'FL', zip: '33830', normalize: 'Bartow' },
      'PLANT CITY': { state: 'FL', zip: '33563', normalize: 'Plant City' },
      'BRANDON': { state: 'FL', zip: '33510', normalize: 'Brandon' },
      'RIVERVIEW': { state: 'FL', zip: '33578', normalize: 'Riverview' },
      'VALRICO': { state: 'FL', zip: '33594', normalize: 'Valrico' },
      'WESLEY CHAPEL': { state: 'FL', zip: '33543', normalize: 'Wesley Chapel' },
      'LUTZ': { state: 'FL', zip: '33548', normalize: 'Lutz' },
      'LAND O LAKES': { state: 'FL', zip: '34638', normalize: 'Land O Lakes' },
      'NEW PORT RICHEY': { state: 'FL', zip: '34652', normalize: 'New Port Richey' },
      'PORT RICHEY': { state: 'FL', zip: '34668', normalize: 'Port Richey' },
      'SPRING HILL': { state: 'FL', zip: '34606', normalize: 'Spring Hill' },
      'BROOKSVILLE': { state: 'FL', zip: '34601', normalize: 'Brooksville' },
      'INVERNESS': { state: 'FL', zip: '34450', normalize: 'Inverness' },
      'CRYSTAL RIVER': { state: 'FL', zip: '34428', normalize: 'Crystal River' },
      'HOMOSASSA': { state: 'FL', zip: '34446', normalize: 'Homosassa' },
      'THE VILLAGES': { state: 'FL', zip: '32162', normalize: 'The Villages' },
      'LEESBURG': { state: 'FL', zip: '34748', normalize: 'Leesburg' },
      'TAVARES': { state: 'FL', zip: '32778', normalize: 'Tavares' },
      'EUSTIS': { state: 'FL', zip: '32726', normalize: 'Eustis' },
      'MOUNT DORA': { state: 'FL', zip: '32757', normalize: 'Mount Dora' },
      'MT DORA': { state: 'FL', zip: '32757', normalize: 'Mount Dora' },
      'LADY LAKE': { state: 'FL', zip: '32159', normalize: 'Lady Lake' },
      'HOWEY IN THE HILLS': { state: 'FL', zip: '34737', normalize: 'Howey In The Hills' },
      'GROVELAND': { state: 'FL', zip: '34736', normalize: 'Groveland' },
      'MASCOTTE': { state: 'FL', zip: '34753', normalize: 'Mascotte' },
      'MINNEOLA': { state: 'FL', zip: '34715', normalize: 'Minneola' },
      'MONTVERDE': { state: 'FL', zip: '34756', normalize: 'Montverde' },
      'OAKLAND': { state: 'FL', zip: '34760', normalize: 'Oakland' },
      'OCOEE': { state: 'FL', zip: '34761', normalize: 'Ocoee' },
      'WINTER GARDEN': { state: 'FL', zip: '34787', normalize: 'Winter Garden' },
      'GOTHA': { state: 'FL', zip: '34734', normalize: 'Gotha' },
      'DOCTOR PHILLIPS': { state: 'FL', zip: '32819', normalize: 'Doctor Phillips' },
      'BAY HILL': { state: 'FL', zip: '32836', normalize: 'Bay Hill' },
      'HUNTERS CREEK': { state: 'FL', zip: '32837', normalize: 'Hunters Creek' },
      'LAKE NONA': { state: 'FL', zip: '32827', normalize: 'Lake Nona' },
      'AVALON PARK': { state: 'FL', zip: '32828', normalize: 'Avalon Park' },
      'WATERFORD LAKES': { state: 'FL', zip: '32828', normalize: 'Waterford Lakes' },
      'CONWAY': { state: 'FL', zip: '32812', normalize: 'Conway' },
      'EDGEWATER': { state: 'FL', zip: '32132', normalize: 'Edgewater' },
      'OAK HILL': { state: 'FL', zip: '32759', normalize: 'Oak Hill' },
      'PORT CHARLOTTE': { state: 'FL', zip: '33948', normalize: 'Port Charlotte' },
      'PT CHARLOTTE': { state: 'FL', zip: '33948', normalize: 'Port Charlotte' },
      'PUNTA GORDA': { state: 'FL', zip: '33950', normalize: 'Punta Gorda' },
      'NORTH PORT': { state: 'FL', zip: '34286', normalize: 'North Port' },
      'VENICE': { state: 'FL', zip: '34285', normalize: 'Venice' },
      'ENGLEWOOD': { state: 'FL', zip: '34223', normalize: 'Englewood' },
      'ARCADIA': { state: 'FL', zip: '34266', normalize: 'Arcadia' },
      'SEBRING': { state: 'FL', zip: '33870', normalize: 'Sebring' },
      'AVON PARK': { state: 'FL', zip: '33825', normalize: 'Avon Park' },
      'LAKE PLACID': { state: 'FL', zip: '33852', normalize: 'Lake Placid' },
      'OKEECHOBEE': { state: 'FL', zip: '34972', normalize: 'Okeechobee' },
      'CLEWISTON': { state: 'FL', zip: '33440', normalize: 'Clewiston' },
      'LABELLE': { state: 'FL', zip: '33935', normalize: 'LaBelle' },
      'IMMOKALEE': { state: 'FL', zip: '34142', normalize: 'Immokalee' },
      'MARCO ISLAND': { state: 'FL', zip: '34145', normalize: 'Marco Island' },
      'EVERGLADES CITY': { state: 'FL', zip: '34139', normalize: 'Everglades City' },
      'KEY WEST': { state: 'FL', zip: '33040', normalize: 'Key West' },
      'KEY LARGO': { state: 'FL', zip: '33037', normalize: 'Key Largo' },
      'ISLAMORADA': { state: 'FL', zip: '33036', normalize: 'Islamorada' },
      'MARATHON': { state: 'FL', zip: '33050', normalize: 'Marathon' },
      'HOMESTEAD': { state: 'FL', zip: '33030', normalize: 'Homestead' },
      'FLORIDA CITY': { state: 'FL', zip: '33034', normalize: 'Florida City' },
      'HIALEAH': { state: 'FL', zip: '33010', normalize: 'Hialeah' },
      'MIAMI BEACH': { state: 'FL', zip: '33139', normalize: 'Miami Beach' },
      'CORAL GABLES': { state: 'FL', zip: '33134', normalize: 'Coral Gables' },
      'COCONUT GROVE': { state: 'FL', zip: '33133', normalize: 'Coconut Grove' },
      'KENDALL': { state: 'FL', zip: '33156', normalize: 'Kendall' },
      'DORAL': { state: 'FL', zip: '33166', normalize: 'Doral' },
      'AVENTURA': { state: 'FL', zip: '33180', normalize: 'Aventura' },
      'SUNNY ISLES BEACH': { state: 'FL', zip: '33160', normalize: 'Sunny Isles Beach' },
      'HOLLYWOOD': { state: 'FL', zip: '33019', normalize: 'Hollywood' },
      'PEMBROKE PINES': { state: 'FL', zip: '33024', normalize: 'Pembroke Pines' },
      'MIRAMAR': { state: 'FL', zip: '33023', normalize: 'Miramar' },
      'DAVIE': { state: 'FL', zip: '33314', normalize: 'Davie' },
      'PLANTATION': { state: 'FL', zip: '33317', normalize: 'Plantation' },
      'SUNRISE': { state: 'FL', zip: '33322', normalize: 'Sunrise' },
      'WESTON': { state: 'FL', zip: '33326', normalize: 'Weston' },
      'COOPER CITY': { state: 'FL', zip: '33328', normalize: 'Cooper City' },
      'DEERFIELD BEACH': { state: 'FL', zip: '33441', normalize: 'Deerfield Beach' },
      'POMPANO BEACH': { state: 'FL', zip: '33060', normalize: 'Pompano Beach' },
      'LIGHTHOUSE POINT': { state: 'FL', zip: '33064', normalize: 'Lighthouse Point' },
      'COCONUT CREEK': { state: 'FL', zip: '33066', normalize: 'Coconut Creek' },
      'CORAL SPRINGS': { state: 'FL', zip: '33065', normalize: 'Coral Springs' },
      'PARKLAND': { state: 'FL', zip: '33067', normalize: 'Parkland' },
      'MARGATE': { state: 'FL', zip: '33063', normalize: 'Margate' },
      'TAMARAC': { state: 'FL', zip: '33319', normalize: 'Tamarac' },
      'LAUDERHILL': { state: 'FL', zip: '33313', normalize: 'Lauderhill' },
      'LAUDERDALE LAKES': { state: 'FL', zip: '33311', normalize: 'Lauderdale Lakes' },
      'OAKLAND PARK': { state: 'FL', zip: '33334', normalize: 'Oakland Park' },
      'WILTON MANORS': { state: 'FL', zip: '33305', normalize: 'Wilton Manors' },
      'DELRAY BEACH': { state: 'FL', zip: '33444', normalize: 'Delray Beach' },
      'BOYNTON BEACH': { state: 'FL', zip: '33435', normalize: 'Boynton Beach' },
      'LAKE WORTH': { state: 'FL', zip: '33460', normalize: 'Lake Worth' },
      'GREENACRES': { state: 'FL', zip: '33463', normalize: 'Greenacres' },
      'WELLINGTON': { state: 'FL', zip: '33414', normalize: 'Wellington' },
      'ROYAL PALM BEACH': { state: 'FL', zip: '33411', normalize: 'Royal Palm Beach' },
      'LOXAHATCHEE': { state: 'FL', zip: '33470', normalize: 'Loxahatchee' },
      'PALM BEACH GARDENS': { state: 'FL', zip: '33410', normalize: 'Palm Beach Gardens' },
      'JUPITER': { state: 'FL', zip: '33458', normalize: 'Jupiter' },
      'TEQUESTA': { state: 'FL', zip: '33469', normalize: 'Tequesta' },
      'HOBE SOUND': { state: 'FL', zip: '33455', normalize: 'Hobe Sound' },
      'JENSEN BEACH': { state: 'FL', zip: '34957', normalize: 'Jensen Beach' },
      'PALATKA': { state: 'FL', zip: '32177', normalize: 'Palatka' },
      'GREEN COVE SPRINGS': { state: 'FL', zip: '32043', normalize: 'Green Cove Springs' },
      'MIDDLEBURG': { state: 'FL', zip: '32068', normalize: 'Middleburg' },
      'FLEMING ISLAND': { state: 'FL', zip: '32003', normalize: 'Fleming Island' },
      'PONTE VEDRA': { state: 'FL', zip: '32081', normalize: 'Ponte Vedra' },
      'PONTE VEDRA BEACH': { state: 'FL', zip: '32082', normalize: 'Ponte Vedra Beach' },
      'JACKSONVILLE BEACH': { state: 'FL', zip: '32250', normalize: 'Jacksonville Beach' },
      'JAX BEACH': { state: 'FL', zip: '32250', normalize: 'Jacksonville Beach' },
      'NEPTUNE BEACH': { state: 'FL', zip: '32266', normalize: 'Neptune Beach' },
      'ATLANTIC BEACH': { state: 'FL', zip: '32233', normalize: 'Atlantic Beach' },
      'FERNANDINA BEACH': { state: 'FL', zip: '32034', normalize: 'Fernandina Beach' },
      'YULEE': { state: 'FL', zip: '32097', normalize: 'Yulee' },
      'CALLAHAN': { state: 'FL', zip: '32011', normalize: 'Callahan' },
      'MACCLENNY': { state: 'FL', zip: '32063', normalize: 'Macclenny' },
      'LAKE CITY': { state: 'FL', zip: '32055', normalize: 'Lake City' },
      'LIVE OAK': { state: 'FL', zip: '32064', normalize: 'Live Oak' },
      'MADISON': { state: 'FL', zip: '32340', normalize: 'Madison' },
      'PERRY': { state: 'FL', zip: '32347', normalize: 'Perry' },
      'CROSS CITY': { state: 'FL', zip: '32628', normalize: 'Cross City' },
      'CHIEFLAND': { state: 'FL', zip: '32626', normalize: 'Chiefland' },
      'TRENTON': { state: 'FL', zip: '32693', normalize: 'Trenton' },
      'NEWBERRY': { state: 'FL', zip: '32669', normalize: 'Newberry' },
      'ALACHUA': { state: 'FL', zip: '32615', normalize: 'Alachua' },
      'ARCHER': { state: 'FL', zip: '32618', normalize: 'Archer' },
      'MICANOPY': { state: 'FL', zip: '32667', normalize: 'Micanopy' },
      'HAWTHORNE': { state: 'FL', zip: '32640', normalize: 'Hawthorne' },
      'KEYSTONE HEIGHTS': { state: 'FL', zip: '32656', normalize: 'Keystone Heights' },
      'STARKE': { state: 'FL', zip: '32091', normalize: 'Starke' },
      'DEFUNIAK SPRINGS': { state: 'FL', zip: '32433', normalize: 'DeFuniak Springs' },
      'FREEPORT': { state: 'FL', zip: '32439', normalize: 'Freeport' },
      'MIRAMAR BEACH': { state: 'FL', zip: '32550', normalize: 'Miramar Beach' },
      'MARY ESTHER': { state: 'FL', zip: '32569', normalize: 'Mary Esther' },
      'NAVARRE': { state: 'FL', zip: '32566', normalize: 'Navarre' },
      'PACE': { state: 'FL', zip: '32571', normalize: 'Pace' },
      'JAY': { state: 'FL', zip: '32565', normalize: 'Jay' },
      'CANTONMENT': { state: 'FL', zip: '32533', normalize: 'Cantonment' },
      'GONZALEZ': { state: 'FL', zip: '32560', normalize: 'Gonzalez' },
      'PERDIDO KEY': { state: 'FL', zip: '32507', normalize: 'Perdido Key' },
      'ORANGE BEACH': { state: 'AL', zip: '36561', normalize: 'Orange Beach' },
      'GULF SHORES': { state: 'AL', zip: '36542', normalize: 'Gulf Shores' },
      'FOLEY': { state: 'AL', zip: '36535', normalize: 'Foley' },
      'FAIRHOPE': { state: 'AL', zip: '36532', normalize: 'Fairhope' },
      'DAPHNE': { state: 'AL', zip: '36526', normalize: 'Daphne' },
      'MOBILE': { state: 'AL', zip: '36601', normalize: 'Mobile' },
      'SPANISH FORT': { state: 'AL', zip: '36527', normalize: 'Spanish Fort' },
      // Additional Florida Cities - A
      'ALACHUA': { state: 'FL', zip: '32615', normalize: 'Alachua' },
      'ALFORD': { state: 'FL', zip: '32420', normalize: 'Alford' },
      'ALTAMONTE': { state: 'FL', zip: '32701', normalize: 'Altamonte Springs' },
      'ALTHA': { state: 'FL', zip: '32421', normalize: 'Altha' },
      'ALTOONA': { state: 'FL', zip: '32702', normalize: 'Altoona' },
      'ALVA': { state: 'FL', zip: '33920', normalize: 'Alva' },
      'ANDREWS': { state: 'FL', zip: '32433', normalize: 'Andrews' },
      'ANNA MARIA': { state: 'FL', zip: '34216', normalize: 'Anna Maria' },
      'ANTHONY': { state: 'FL', zip: '32617', normalize: 'Anthony' },
      'APOLLO BEACH': { state: 'FL', zip: '33572', normalize: 'Apollo Beach' },
      'APALACHICOLA': { state: 'FL', zip: '32320', normalize: 'Apalachicola' },
      'ARIPEKA': { state: 'FL', zip: '34679', normalize: 'Aripeka' },
      'ASTATULA': { state: 'FL', zip: '34705', normalize: 'Astatula' },
      'ASTOR': { state: 'FL', zip: '32102', normalize: 'Astor' },
      'ATLANTIC BCH': { state: 'FL', zip: '32233', normalize: 'Atlantic Beach' },
      'AUBURNDALE': { state: 'FL', zip: '33823', normalize: 'Auburndale' },
      'AVE MARIA': { state: 'FL', zip: '34142', normalize: 'Ave Maria' },
      'AZALEA PARK': { state: 'FL', zip: '32807', normalize: 'Azalea Park' },
      // B
      'BAGDAD': { state: 'FL', zip: '32530', normalize: 'Bagdad' },
      'BAKER': { state: 'FL', zip: '32531', normalize: 'Baker' },
      'BAL HARBOUR': { state: 'FL', zip: '33154', normalize: 'Bal Harbour' },
      'BALDWIN': { state: 'FL', zip: '32234', normalize: 'Baldwin' },
      'BALM': { state: 'FL', zip: '33503', normalize: 'Balm' },
      'BARBERVILLE': { state: 'FL', zip: '32105', normalize: 'Barberville' },
      'BARTOW': { state: 'FL', zip: '33830', normalize: 'Bartow' },
      'BASCOM': { state: 'FL', zip: '32423', normalize: 'Bascom' },
      'BAY HARBOR ISLANDS': { state: 'FL', zip: '33154', normalize: 'Bay Harbor Islands' },
      'BAY LAKE': { state: 'FL', zip: '32830', normalize: 'Bay Lake' },
      'BAY PINES': { state: 'FL', zip: '33744', normalize: 'Bay Pines' },
      'BAYONET POINT': { state: 'FL', zip: '34667', normalize: 'Bayonet Point' },
      'BAYSHORE GARDENS': { state: 'FL', zip: '34207', normalize: 'Bayshore Gardens' },
      'BEACON SQUARE': { state: 'FL', zip: '34691', normalize: 'Beacon Square' },
      'BELL': { state: 'FL', zip: '32619', normalize: 'Bell' },
      'BELLAIR BEACH': { state: 'FL', zip: '33786', normalize: 'Belleair Beach' },
      'BELLEAIR': { state: 'FL', zip: '33756', normalize: 'Belleair' },
      'BELLEAIR BEACH': { state: 'FL', zip: '33786', normalize: 'Belleair Beach' },
      'BELLEAIR BLUFFS': { state: 'FL', zip: '33770', normalize: 'Belleair Bluffs' },
      'BELLEAIR SHORE': { state: 'FL', zip: '33786', normalize: 'Belleair Shore' },
      'BELLEVIEW': { state: 'FL', zip: '34420', normalize: 'Belleview' },
      'BELLVIEW': { state: 'FL', zip: '32526', normalize: 'Bellview' },
      'BEVERLY HILLS': { state: 'FL', zip: '34465', normalize: 'Beverly Hills' },
      'BIG COPPITT KEY': { state: 'FL', zip: '33040', normalize: 'Big Coppitt Key' },
      'BIG PINE KEY': { state: 'FL', zip: '33043', normalize: 'Big Pine Key' },
      'BISCAYNE PARK': { state: 'FL', zip: '33161', normalize: 'Biscayne Park' },
      'BLOUNTSTOWN': { state: 'FL', zip: '32424', normalize: 'Blountstown' },
      'BOCA GRANDE': { state: 'FL', zip: '33921', normalize: 'Boca Grande' },
      'BOKEELIA': { state: 'FL', zip: '33922', normalize: 'Bokeelia' },
      'BONIFAY': { state: 'FL', zip: '32425', normalize: 'Bonifay' },
      'BONITA SPGS': { state: 'FL', zip: '34134', normalize: 'Bonita Springs' },
      'BOSTWICK': { state: 'FL', zip: '32007', normalize: 'Bostwick' },
      'BOWLING GREEN': { state: 'FL', zip: '33834', normalize: 'Bowling Green' },
      'BOYNTON BCH': { state: 'FL', zip: '33435', normalize: 'Boynton Beach' },
      'BRADENTON BCH': { state: 'FL', zip: '34217', normalize: 'Bradenton Beach' },
      'BRADENTON BEACH': { state: 'FL', zip: '34217', normalize: 'Bradenton Beach' },
      'BRANFORD': { state: 'FL', zip: '32008', normalize: 'Branford' },
      'BRENT': { state: 'FL', zip: '32505', normalize: 'Brent' },
      'BRINY BREEZES': { state: 'FL', zip: '33435', normalize: 'Briny Breezes' },
      'BRISTOL': { state: 'FL', zip: '32321', normalize: 'Bristol' },
      'BRONSON': { state: 'FL', zip: '32621', normalize: 'Bronson' },
      'BROOKER': { state: 'FL', zip: '32622', normalize: 'Brooker' },
      'BROOKRIDGE': { state: 'FL', zip: '34602', normalize: 'Brookridge' },
      'BROWNSVILLE': { state: 'FL', zip: '33142', normalize: 'Brownsville' },
      'BRYCEVILLE': { state: 'FL', zip: '32009', normalize: 'Bryceville' },
      'BUCKHEAD RIDGE': { state: 'FL', zip: '34974', normalize: 'Buckhead Ridge' },
      'BUCKINGHAM': { state: 'FL', zip: '33905', normalize: 'Buckingham' },
      'BUNNELL': { state: 'FL', zip: '32110', normalize: 'Bunnell' },
      'BUSHNELL': { state: 'FL', zip: '33513', normalize: 'Bushnell' },
      // C
      'CALLAWAY': { state: 'FL', zip: '32404', normalize: 'Callaway' },
      'CAMPBELLTON': { state: 'FL', zip: '32426', normalize: 'Campbellton' },
      'CANAL POINT': { state: 'FL', zip: '33438', normalize: 'Canal Point' },
      'CAPE CANAVERAL': { state: 'FL', zip: '32920', normalize: 'Cape Canaveral' },
      'CAPE CORAL': { state: 'FL', zip: '33904', normalize: 'Cape Coral' },
      'CAPTIVA': { state: 'FL', zip: '33924', normalize: 'Captiva' },
      'CARRABELLE': { state: 'FL', zip: '32322', normalize: 'Carrabelle' },
      'CARYVILLE': { state: 'FL', zip: '32427', normalize: 'Caryville' },
      'CASSELBERRY': { state: 'FL', zip: '32707', normalize: 'Casselberry' },
      'CEDAR GROVE': { state: 'FL', zip: '32401', normalize: 'Cedar Grove' },
      'CEDAR KEY': { state: 'FL', zip: '32625', normalize: 'Cedar Key' },
      'CENTER HILL': { state: 'FL', zip: '33514', normalize: 'Center Hill' },
      'CENTURY': { state: 'FL', zip: '32535', normalize: 'Century' },
      'CHATTAHOOCHEE': { state: 'FL', zip: '32324', normalize: 'Chattahoochee' },
      'CHEVAL': { state: 'FL', zip: '33558', normalize: 'Cheval' },
      'CHIPLEY': { state: 'FL', zip: '32428', normalize: 'Chipley' },
      'CHOKOLOSKEE': { state: 'FL', zip: '34138', normalize: 'Chokoloskee' },
      'CHRISTMAS': { state: 'FL', zip: '32709', normalize: 'Christmas' },
      'CITRA': { state: 'FL', zip: '32113', normalize: 'Citra' },
      'CITRUS HILLS': { state: 'FL', zip: '34442', normalize: 'Citrus Hills' },
      'CITRUS PARK': { state: 'FL', zip: '33625', normalize: 'Citrus Park' },
      'CITRUS SPRINGS': { state: 'FL', zip: '34434', normalize: 'Citrus Springs' },
      'CLARCONA': { state: 'FL', zip: '32710', normalize: 'Clarcona' },
      'CLEARWATER BCH': { state: 'FL', zip: '33767', normalize: 'Clearwater Beach' },
      'CLEARWATER BEACH': { state: 'FL', zip: '33767', normalize: 'Clearwater Beach' },
      'CLOUD LAKE': { state: 'FL', zip: '33406', normalize: 'Cloud Lake' },
      'COCOA BCH': { state: 'FL', zip: '32931', normalize: 'Cocoa Beach' },
      'COCONUT CREEK': { state: 'FL', zip: '33066', normalize: 'Coconut Creek' },
      'COLEMAN': { state: 'FL', zip: '33521', normalize: 'Coleman' },
      'COLLEGE PARK': { state: 'FL', zip: '32804', normalize: 'College Park' },
      'COMBEE SETTLEMENT': { state: 'FL', zip: '33801', normalize: 'Combee Settlement' },
      'CONNERTON': { state: 'FL', zip: '34637', normalize: 'Connerton' },
      'CORAL TERRACE': { state: 'FL', zip: '33145', normalize: 'Coral Terrace' },
      'CORTEZ': { state: 'FL', zip: '34215', normalize: 'Cortez' },
      'COTTONDALE': { state: 'FL', zip: '32431', normalize: 'Cottondale' },
      'COUNTRY CLUB': { state: 'FL', zip: '33015', normalize: 'Country Club' },
      'CRAWFORDVILLE': { state: 'FL', zip: '32327', normalize: 'Crawfordville' },
      'CRESCENT BEACH': { state: 'FL', zip: '32080', normalize: 'Crescent Beach' },
      'CRESCENT CITY': { state: 'FL', zip: '32112', normalize: 'Crescent City' },
      'CRESTVIEW': { state: 'FL', zip: '32536', normalize: 'Crestview' },
      'CROOKED LAKE PARK': { state: 'FL', zip: '33898', normalize: 'Crooked Lake Park' },
      'CROSS CITY': { state: 'FL', zip: '32628', normalize: 'Cross City' },
      'CUDJOE KEY': { state: 'FL', zip: '33042', normalize: 'Cudjoe Key' },
      'CUTLER BAY': { state: 'FL', zip: '33157', normalize: 'Cutler Bay' },
      'CYPRESS GARDENS': { state: 'FL', zip: '33884', normalize: 'Cypress Gardens' },
      'CYPRESS LAKE': { state: 'FL', zip: '33919', normalize: 'Cypress Lake' },
      'CYPRESS QUARTERS': { state: 'FL', zip: '34972', normalize: 'Cypress Quarters' },
      // D
      'DADE CITY': { state: 'FL', zip: '33525', normalize: 'Dade City' },
      'DANIA': { state: 'FL', zip: '33004', normalize: 'Dania Beach' },
      'DANIA BEACH': { state: 'FL', zip: '33004', normalize: 'Dania Beach' },
      'DAYTONA BCH': { state: 'FL', zip: '32114', normalize: 'Daytona Beach' },
      'DAYTONA BEACH SHORES': { state: 'FL', zip: '32118', normalize: 'Daytona Beach Shores' },
      'DE LEON SPRINGS': { state: 'FL', zip: '32130', normalize: 'De Leon Springs' },
      'DEERFIELD BCH': { state: 'FL', zip: '33441', normalize: 'Deerfield Beach' },
      'DELEON SPRINGS': { state: 'FL', zip: '32130', normalize: 'DeLeon Springs' },
      'DELRAY BCH': { state: 'FL', zip: '33444', normalize: 'Delray Beach' },
      'DELTONA': { state: 'FL', zip: '32725', normalize: 'Deltona' },
      'DOCTORS INLET': { state: 'FL', zip: '32030', normalize: 'Doctors Inlet' },
      'DORAL': { state: 'FL', zip: '33166', normalize: 'Doral' },
      'DOVER': { state: 'FL', zip: '33527', normalize: 'Dover' },
      'DUCK KEY': { state: 'FL', zip: '33050', normalize: 'Duck Key' },
      'DUNDEE': { state: 'FL', zip: '33838', normalize: 'Dundee' },
      'DUNNELLON': { state: 'FL', zip: '34432', normalize: 'Dunnellon' },
      'DUNEDIN': { state: 'FL', zip: '34698', normalize: 'Dunedin' },
      // E
      'EAGLE LAKE': { state: 'FL', zip: '33839', normalize: 'Eagle Lake' },
      'EAST LAKE': { state: 'FL', zip: '34685', normalize: 'East Lake' },
      'EAST PALATKA': { state: 'FL', zip: '32131', normalize: 'East Palatka' },
      'EASTPOINT': { state: 'FL', zip: '32328', normalize: 'Eastpoint' },
      'EATONVILLE': { state: 'FL', zip: '32751', normalize: 'Eatonville' },
      'EAU GALLIE': { state: 'FL', zip: '32935', normalize: 'Eau Gallie' },
      'EBRO': { state: 'FL', zip: '32437', normalize: 'Ebro' },
      'EDGEWATER': { state: 'FL', zip: '32132', normalize: 'Edgewater' },
      'EGLIN AFB': { state: 'FL', zip: '32542', normalize: 'Eglin AFB' },
      'EL PORTAL': { state: 'FL', zip: '33138', normalize: 'El Portal' },
      'ELFERS': { state: 'FL', zip: '34680', normalize: 'Elfers' },
      'ELKTON': { state: 'FL', zip: '32033', normalize: 'Elkton' },
      'ELLENTON': { state: 'FL', zip: '34222', normalize: 'Ellenton' },
      'ENGLEWOOD': { state: 'FL', zip: '34223', normalize: 'Englewood' },
      'ENSLEY': { state: 'FL', zip: '32534', normalize: 'Ensley' },
      'ESTERO': { state: 'FL', zip: '33928', normalize: 'Estero' },
      'EUSTIS': { state: 'FL', zip: '32726', normalize: 'Eustis' },
      'EVINSTON': { state: 'FL', zip: '32633', normalize: 'Evinston' },
      // F
      'FAKAHATCHEE': { state: 'FL', zip: '34141', normalize: 'Fakahatchee' },
      'FEATHER SOUND': { state: 'FL', zip: '33622', normalize: 'Feather Sound' },
      'FELLSMERE': { state: 'FL', zip: '32948', normalize: 'Fellsmere' },
      'FERN PARK': { state: 'FL', zip: '32730', normalize: 'Fern Park' },
      'FERNANDINA BCH': { state: 'FL', zip: '32034', normalize: 'Fernandina Beach' },
      'FISHER ISLAND': { state: 'FL', zip: '33109', normalize: 'Fisher Island' },
      'FIVE POINTS': { state: 'FL', zip: '32257', normalize: 'Five Points' },
      'FLAGLER BCH': { state: 'FL', zip: '32136', normalize: 'Flagler Beach' },
      'FLORAL CITY': { state: 'FL', zip: '34436', normalize: 'Floral City' },
      'FLORIDA CITY': { state: 'FL', zip: '33034', normalize: 'Florida City' },
      'FORT DRUM': { state: 'FL', zip: '34972', normalize: 'Fort Drum' },
      'FORT GEORGE ISLAND': { state: 'FL', zip: '32226', normalize: 'Fort George Island' },
      'FORT GREEN SPRINGS': { state: 'FL', zip: '33834', normalize: 'Fort Green Springs' },
      'FORT MCCOY': { state: 'FL', zip: '32134', normalize: 'Fort McCoy' },
      'FORT MEADE': { state: 'FL', zip: '33841', normalize: 'Fort Meade' },
      'FORT OGDEN': { state: 'FL', zip: '34267', normalize: 'Fort Ogden' },
      'FORT WHITE': { state: 'FL', zip: '32038', normalize: 'Fort White' },
      'FOUNTAIN': { state: 'FL', zip: '32438', normalize: 'Fountain' },
      'FREEPORT': { state: 'FL', zip: '32439', normalize: 'Freeport' },
      'FROSTPROOF': { state: 'FL', zip: '33843', normalize: 'Frostproof' },
      'FRUIT COVE': { state: 'FL', zip: '32259', normalize: 'Fruit Cove' },
      'FRUITLAND PARK': { state: 'FL', zip: '34731', normalize: 'Fruitland Park' },
      'FRUITVILLE': { state: 'FL', zip: '34232', normalize: 'Fruitville' },
      'FT LAUDERDALE': { state: 'FL', zip: '33301', normalize: 'Fort Lauderdale' },
      'FT MEADE': { state: 'FL', zip: '33841', normalize: 'Fort Meade' },
      'FT WHITE': { state: 'FL', zip: '32038', normalize: 'Fort White' },
      // G
      'GAINESVILLE': { state: 'FL', zip: '32601', normalize: 'Gainesville' },
      'GIBSONTON': { state: 'FL', zip: '33534', normalize: 'Gibsonton' },
      'GIFFORD': { state: 'FL', zip: '32960', normalize: 'Gifford' },
      'GLEN RIDGE': { state: 'FL', zip: '33406', normalize: 'Glen Ridge' },
      'GLEN ST MARY': { state: 'FL', zip: '32040', normalize: 'Glen Saint Mary' },
      'GLENCOE': { state: 'FL', zip: '32066', normalize: 'Glencoe' },
      'GLENVAR HEIGHTS': { state: 'FL', zip: '33155', normalize: 'Glenvar Heights' },
      'GOLDEN BEACH': { state: 'FL', zip: '33160', normalize: 'Golden Beach' },
      'GOLDEN GATE': { state: 'FL', zip: '34116', normalize: 'Golden Gate' },
      'GOLDEN GLADES': { state: 'FL', zip: '33167', normalize: 'Golden Glades' },
      'GOLF': { state: 'FL', zip: '33436', normalize: 'Golf' },
      'GONZALEZ': { state: 'FL', zip: '32560', normalize: 'Gonzalez' },
      'GOODLAND': { state: 'FL', zip: '34140', normalize: 'Goodland' },
      'GOTHA': { state: 'FL', zip: '34734', normalize: 'Gotha' },
      'GRACEVILLE': { state: 'FL', zip: '32440', normalize: 'Graceville' },
      'GRAND ISLAND': { state: 'FL', zip: '32735', normalize: 'Grand Island' },
      'GRAND RIDGE': { state: 'FL', zip: '32442', normalize: 'Grand Ridge' },
      'GRANT': { state: 'FL', zip: '32949', normalize: 'Grant' },
      'GRANT VALKARIA': { state: 'FL', zip: '32949', normalize: 'Grant Valkaria' },
      'GREEN ACRES': { state: 'FL', zip: '33463', normalize: 'Greenacres' },
      'GREENACRES CITY': { state: 'FL', zip: '33463', normalize: 'Greenacres' },
      'GREENSBORO': { state: 'FL', zip: '32330', normalize: 'Greensboro' },
      'GREENVILLE': { state: 'FL', zip: '32331', normalize: 'Greenville' },
      'GREENWOOD': { state: 'FL', zip: '32443', normalize: 'Greenwood' },
      'GRETNA': { state: 'FL', zip: '32332', normalize: 'Gretna' },
      'GROVE CITY': { state: 'FL', zip: '34224', normalize: 'Grove City' },
      'GROVELAND': { state: 'FL', zip: '34736', normalize: 'Groveland' },
      'GULF GATE ESTATES': { state: 'FL', zip: '34231', normalize: 'Gulf Gate Estates' },
      'GULF HAMMOCK': { state: 'FL', zip: '32639', normalize: 'Gulf Hammock' },
      'GULFPORT': { state: 'FL', zip: '33707', normalize: 'Gulfport' },
      // H
      'HAINES CITY': { state: 'FL', zip: '33844', normalize: 'Haines City' },
      'HALLANDALE': { state: 'FL', zip: '33009', normalize: 'Hallandale Beach' },
      'HALLANDALE BEACH': { state: 'FL', zip: '33009', normalize: 'Hallandale Beach' },
      'HAMPTON': { state: 'FL', zip: '32044', normalize: 'Hampton' },
      'HARBOR BLUFFS': { state: 'FL', zip: '33770', normalize: 'Harbor Bluffs' },
      'HARBOUR HEIGHTS': { state: 'FL', zip: '33983', normalize: 'Harbour Heights' },
      'HARDEE': { state: 'FL', zip: '34266', normalize: 'Hardee' },
      'HARLEM': { state: 'FL', zip: '33440', normalize: 'Harlem' },
      'HAROLD': { state: 'FL', zip: '32564', normalize: 'Harold' },
      'HASTINGS': { state: 'FL', zip: '32145', normalize: 'Hastings' },
      'HAVANA': { state: 'FL', zip: '32333', normalize: 'Havana' },
      'HAVERHILL': { state: 'FL', zip: '33417', normalize: 'Haverhill' },
      'HAWTHORNE': { state: 'FL', zip: '32640', normalize: 'Hawthorne' },
      'HEATHROW': { state: 'FL', zip: '32746', normalize: 'Heathrow' },
      'HERNANDO': { state: 'FL', zip: '34442', normalize: 'Hernando' },
      'HERNANDO BEACH': { state: 'FL', zip: '34607', normalize: 'Hernando Beach' },
      'HIALEAH': { state: 'FL', zip: '33010', normalize: 'Hialeah' },
      'HIALEAH GARDENS': { state: 'FL', zip: '33018', normalize: 'Hialeah Gardens' },
      'HIGHLAND BEACH': { state: 'FL', zip: '33487', normalize: 'Highland Beach' },
      'HIGHLAND CITY': { state: 'FL', zip: '33846', normalize: 'Highland City' },
      'HIGHLAND PARK': { state: 'FL', zip: '33846', normalize: 'Highland Park' },
      'HIGHLANDS': { state: 'FL', zip: '33870', normalize: 'Highlands' },
      'HILLIARD': { state: 'FL', zip: '32046', normalize: 'Hilliard' },
      'HILLSBORO BEACH': { state: 'FL', zip: '33062', normalize: 'Hillsboro Beach' },
      'HOBE SOUND': { state: 'FL', zip: '33455', normalize: 'Hobe Sound' },
      'HOLDER': { state: 'FL', zip: '34445', normalize: 'Holder' },
      'HOLIDAY': { state: 'FL', zip: '34690', normalize: 'Holiday' },
      'HOLLEY': { state: 'FL', zip: '32566', normalize: 'Holley' },
      'HOLLY HILL': { state: 'FL', zip: '32117', normalize: 'Holly Hill' },
      'HOLLYWOOD': { state: 'FL', zip: '33019', normalize: 'Hollywood' },
      'HOLMES BEACH': { state: 'FL', zip: '34217', normalize: 'Holmes Beach' },
      'HOLT': { state: 'FL', zip: '32564', normalize: 'Holt' },
      'HOMELAND': { state: 'FL', zip: '33847', normalize: 'Homeland' },
      'HOMESTEAD': { state: 'FL', zip: '33030', normalize: 'Homestead' },
      'HOMOSASSA SPRINGS': { state: 'FL', zip: '34447', normalize: 'Homosassa Springs' },
      'HORSESHOE BEACH': { state: 'FL', zip: '32648', normalize: 'Horseshoe Beach' },
      'HOSFORD': { state: 'FL', zip: '32334', normalize: 'Hosford' },
      'HUDSON': { state: 'FL', zip: '34667', normalize: 'Hudson' },
      'HURLBURT FIELD': { state: 'FL', zip: '32544', normalize: 'Hurlburt Field' },
      'HYPOLUXO': { state: 'FL', zip: '33462', normalize: 'Hypoluxo' },
      // I
      'IMMOKALEE': { state: 'FL', zip: '34142', normalize: 'Immokalee' },
      'INDIALANTIC': { state: 'FL', zip: '32903', normalize: 'Indialantic' },
      'INDIAN HARBOUR BEACH': { state: 'FL', zip: '32937', normalize: 'Indian Harbour Beach' },
      'INDIAN LAKE ESTATES': { state: 'FL', zip: '33855', normalize: 'Indian Lake Estates' },
      'INDIAN RIVER SHORES': { state: 'FL', zip: '32963', normalize: 'Indian River Shores' },
      'INDIAN ROCKS BEACH': { state: 'FL', zip: '33785', normalize: 'Indian Rocks Beach' },
      'INDIAN SHORES': { state: 'FL', zip: '33785', normalize: 'Indian Shores' },
      'INDIANTOWN': { state: 'FL', zip: '34956', normalize: 'Indiantown' },
      'INGLIS': { state: 'FL', zip: '34449', normalize: 'Inglis' },
      'INTERLACHEN': { state: 'FL', zip: '32148', normalize: 'Interlachen' },
      'INVERNESS': { state: 'FL', zip: '34450', normalize: 'Inverness' },
      'IONA': { state: 'FL', zip: '33908', normalize: 'Iona' },
      'ISLAND GROVE': { state: 'FL', zip: '32654', normalize: 'Island Grove' },
      'ISLAMORADA': { state: 'FL', zip: '33036', normalize: 'Islamorada' },
      'ISLANDIA': { state: 'FL', zip: '33036', normalize: 'Islandia' },
      'ISLE OF PALMS': { state: 'FL', zip: '34223', normalize: 'Isle of Palms' },
      'ISTACHATTA': { state: 'FL', zip: '34636', normalize: 'Istachatta' },
      'IVES ESTATES': { state: 'FL', zip: '33179', normalize: 'Ives Estates' },
      // J
      'JACKSONVILLE BCH': { state: 'FL', zip: '32250', normalize: 'Jacksonville Beach' },
      'JACOB CITY': { state: 'FL', zip: '32431', normalize: 'Jacob City' },
      'JAMES ISLAND': { state: 'FL', zip: '34139', normalize: 'James Island' },
      'JANESVILLE': { state: 'FL', zip: '32431', normalize: 'Janesville' },
      'JASMINE ESTATES': { state: 'FL', zip: '34668', normalize: 'Jasmine Estates' },
      'JASPER': { state: 'FL', zip: '32052', normalize: 'Jasper' },
      'JAY': { state: 'FL', zip: '32565', normalize: 'Jay' },
      'JEAN LAFITTE': { state: 'FL', zip: '33326', normalize: 'Jean Lafitte' },
      'JENNINGS': { state: 'FL', zip: '32053', normalize: 'Jennings' },
      'JENSEN BCH': { state: 'FL', zip: '34957', normalize: 'Jensen Beach' },
      'JUNO BEACH': { state: 'FL', zip: '33408', normalize: 'Juno Beach' },
      'JUPITER INLET': { state: 'FL', zip: '33469', normalize: 'Jupiter Inlet' },
      'JUPITER ISLAND': { state: 'FL', zip: '33455', normalize: 'Jupiter Island' },
      // K
      'KATHLEEN': { state: 'FL', zip: '33849', normalize: 'Kathleen' },
      'KENANSVILLE': { state: 'FL', zip: '34739', normalize: 'Kenansville' },
      'KENDALL LAKES': { state: 'FL', zip: '33183', normalize: 'Kendall Lakes' },
      'KENDALL WEST': { state: 'FL', zip: '33193', normalize: 'Kendall West' },
      'KENDALE LAKES': { state: 'FL', zip: '33183', normalize: 'Kendale Lakes' },
      'KENNETH CITY': { state: 'FL', zip: '33709', normalize: 'Kenneth City' },
      'KENSINGTON PARK': { state: 'FL', zip: '34231', normalize: 'Kensington Park' },
      'KEY BISCAYNE': { state: 'FL', zip: '33149', normalize: 'Key Biscayne' },
      'KEY COLONY BEACH': { state: 'FL', zip: '33051', normalize: 'Key Colony Beach' },
      'KEY HAVEN': { state: 'FL', zip: '33040', normalize: 'Key Haven' },
      'KEY LARGO': { state: 'FL', zip: '33037', normalize: 'Key Largo' },
      'KEY WEST': { state: 'FL', zip: '33040', normalize: 'Key West' },
      'KEYSTONE': { state: 'FL', zip: '33556', normalize: 'Keystone' },
      'KEYSTONE HEIGHTS': { state: 'FL', zip: '32656', normalize: 'Keystone Heights' },
      'KINGS POINT': { state: 'FL', zip: '33467', normalize: 'Kings Point' },
      'KINGSLEY LAKE': { state: 'FL', zip: '32091', normalize: 'Kingsley Lake' },
      'KISSIMMEE': { state: 'FL', zip: '34741', normalize: 'Kissimmee' },
      // L
      'LA BELLE': { state: 'FL', zip: '33935', normalize: 'LaBelle' },
      'LA CROSSE': { state: 'FL', zip: '32658', normalize: 'La Crosse' },
      'LACOOCHEE': { state: 'FL', zip: '33537', normalize: 'Lacoochee' },
      'LADY LAKE': { state: 'FL', zip: '32159', normalize: 'Lady Lake' },
      'LAGUNA BEACH': { state: 'FL', zip: '32413', normalize: 'Laguna Beach' },
      'LAKE ALFRED': { state: 'FL', zip: '33850', normalize: 'Lake Alfred' },
      'LAKE BUTLER': { state: 'FL', zip: '32054', normalize: 'Lake Butler' },
      'LAKE CITY': { state: 'FL', zip: '32055', normalize: 'Lake City' },
      'LAKE CLARKE SHORES': { state: 'FL', zip: '33406', normalize: 'Lake Clarke Shores' },
      'LAKE COMO': { state: 'FL', zip: '32157', normalize: 'Lake Como' },
      'LAKE FOREST': { state: 'FL', zip: '33166', normalize: 'Lake Forest' },
      'LAKE HAMILTON': { state: 'FL', zip: '33851', normalize: 'Lake Hamilton' },
      'LAKE HARBOR': { state: 'FL', zip: '33459', normalize: 'Lake Harbor' },
      'LAKE HELEN': { state: 'FL', zip: '32744', normalize: 'Lake Helen' },
      'LAKE LORRAINE': { state: 'FL', zip: '32579', normalize: 'Lake Lorraine' },
      'LAKE LUCERNE': { state: 'FL', zip: '33884', normalize: 'Lake Lucerne' },
      'LAKE MACK FOREST HILLS': { state: 'FL', zip: '32757', normalize: 'Lake Mack Forest Hills' },
      'LAKE MAGDALENE': { state: 'FL', zip: '33618', normalize: 'Lake Magdalene' },
      'LAKE MARY': { state: 'FL', zip: '32746', normalize: 'Lake Mary' },
      'LAKE NONA': { state: 'FL', zip: '32827', normalize: 'Lake Nona' },
      'LAKE PANASOFFKEE': { state: 'FL', zip: '33538', normalize: 'Lake Panasoffkee' },
      'LAKE PARK': { state: 'FL', zip: '33403', normalize: 'Lake Park' },
      'LAKE PLACID': { state: 'FL', zip: '33852', normalize: 'Lake Placid' },
      'LAKE WALES': { state: 'FL', zip: '33853', normalize: 'Lake Wales' },
      'LAKE WORTH': { state: 'FL', zip: '33460', normalize: 'Lake Worth' },
      'LAKE WORTH BEACH': { state: 'FL', zip: '33460', normalize: 'Lake Worth Beach' },
      'LAKELAND HIGHLANDS': { state: 'FL', zip: '33813', normalize: 'Lakeland Highlands' },
      'LAKEPORT': { state: 'FL', zip: '33471', normalize: 'Lakeport' },
      'LAKESIDE': { state: 'FL', zip: '32073', normalize: 'Lakeside' },
      'LAKEWOOD PARK': { state: 'FL', zip: '34951', normalize: 'Lakewood Park' },
      'LAMONT': { state: 'FL', zip: '32336', normalize: 'Lamont' },
      'LAND O LAKES': { state: 'FL', zip: '34638', normalize: 'Land O Lakes' },
      'LANTANA': { state: 'FL', zip: '33462', normalize: 'Lantana' },
      'LARGO': { state: 'FL', zip: '33770', normalize: 'Largo' },
      'LAUDERDALE BY THE SEA': { state: 'FL', zip: '33308', normalize: 'Lauderdale By The Sea' },
      'LAUDERDALE LAKES': { state: 'FL', zip: '33311', normalize: 'Lauderdale Lakes' },
      'LAUDERHILL': { state: 'FL', zip: '33313', normalize: 'Lauderhill' },
      'LAUREL': { state: 'FL', zip: '34272', normalize: 'Laurel' },
      'LAUREL HILL': { state: 'FL', zip: '32567', normalize: 'Laurel Hill' },
      'LAWTEY': { state: 'FL', zip: '32058', normalize: 'Lawtey' },
      'LAYTON': { state: 'FL', zip: '33001', normalize: 'Layton' },
      'LECANTO': { state: 'FL', zip: '34461', normalize: 'Lecanto' },
      'LEE': { state: 'FL', zip: '32059', normalize: 'Lee' },
      'LEESBURG': { state: 'FL', zip: '34748', normalize: 'Leesburg' },
      'LEHIGH ACRES': { state: 'FL', zip: '33936', normalize: 'Lehigh Acres' },
      'LEISURE CITY': { state: 'FL', zip: '33033', normalize: 'Leisure City' },
      'LELY': { state: 'FL', zip: '34113', normalize: 'Lely' },
      'LEMON GROVE': { state: 'FL', zip: '32159', normalize: 'Lemon Grove' },
      'LIGHTHOUSE POINT': { state: 'FL', zip: '33064', normalize: 'Lighthouse Point' },
      'LIMESTONE': { state: 'FL', zip: '32442', normalize: 'Limestone' },
      'LISBON': { state: 'FL', zip: '32768', normalize: 'Lisbon' },
      'LITHIA': { state: 'FL', zip: '33547', normalize: 'Lithia' },
      'LIVE OAK': { state: 'FL', zip: '32064', normalize: 'Live Oak' },
      'LLOYD': { state: 'FL', zip: '32337', normalize: 'Lloyd' },
      'LOCHLOOSA': { state: 'FL', zip: '32662', normalize: 'Lochloosa' },
      'LOCKHART': { state: 'FL', zip: '32810', normalize: 'Lockhart' },
      'LONG KEY': { state: 'FL', zip: '33001', normalize: 'Long Key' },
      'LONGBOAT KEY': { state: 'FL', zip: '34228', normalize: 'Longboat Key' },
      'LONGWOOD': { state: 'FL', zip: '32750', normalize: 'Longwood' },
      'LORIDA': { state: 'FL', zip: '33857', normalize: 'Lorida' },
      'LOUGHMAN': { state: 'FL', zip: '33858', normalize: 'Loughman' },
      'LOWER GRAND LAGOON': { state: 'FL', zip: '32407', normalize: 'Lower Grand Lagoon' },
      'LOXAHATCHEE': { state: 'FL', zip: '33470', normalize: 'Loxahatchee' },
      'LOXAHATCHEE GROVES': { state: 'FL', zip: '33470', normalize: 'Loxahatchee Groves' },
      'LUTZ': { state: 'FL', zip: '33548', normalize: 'Lutz' },
      'LYNN HAVEN': { state: 'FL', zip: '32444', normalize: 'Lynn Haven' },
      // M
      'MACCLENNEY': { state: 'FL', zip: '32063', normalize: 'Macclenny' },
      'MADEIRA BEACH': { state: 'FL', zip: '33708', normalize: 'Madeira Beach' },
      'MADISON': { state: 'FL', zip: '32340', normalize: 'Madison' },
      'MAITLAND': { state: 'FL', zip: '32751', normalize: 'Maitland' },
      'MALABAR': { state: 'FL', zip: '32950', normalize: 'Malabar' },
      'MALONE': { state: 'FL', zip: '32445', normalize: 'Malone' },
      'MANALAPAN': { state: 'FL', zip: '33462', normalize: 'Manalapan' },
      'MANATEE': { state: 'FL', zip: '34221', normalize: 'Manatee' },
      'MANGO': { state: 'FL', zip: '33550', normalize: 'Mango' },
      'MANGONIA PARK': { state: 'FL', zip: '33407', normalize: 'Mangonia Park' },
      'MARATHON SHORES': { state: 'FL', zip: '33052', normalize: 'Marathon Shores' },
      'MARCO': { state: 'FL', zip: '34145', normalize: 'Marco Island' },
      'MARGATE': { state: 'FL', zip: '33063', normalize: 'Margate' },
      'MARIANNA': { state: 'FL', zip: '32446', normalize: 'Marianna' },
      'MARINELAND': { state: 'FL', zip: '32080', normalize: 'Marineland' },
      'MARTIN': { state: 'FL', zip: '34956', normalize: 'Martin' },
      'MARY ESTHER': { state: 'FL', zip: '32569', normalize: 'Mary Esther' },
      'MASCOTTE': { state: 'FL', zip: '34753', normalize: 'Mascotte' },
      'MATLACHA': { state: 'FL', zip: '33993', normalize: 'Matlacha' },
      'MAYO': { state: 'FL', zip: '32066', normalize: 'Mayo' },
      'MCALPIN': { state: 'FL', zip: '32062', normalize: 'McAlpin' },
      'MCDAVID': { state: 'FL', zip: '32568', normalize: 'McDavid' },
      'MCINTOSH': { state: 'FL', zip: '32664', normalize: 'McIntosh' },
      'MEADOW WOODS': { state: 'FL', zip: '32824', normalize: 'Meadow Woods' },
      'MEDLEY': { state: 'FL', zip: '33166', normalize: 'Medley' },
      'MELBOURNE BCH': { state: 'FL', zip: '32951', normalize: 'Melbourne Beach' },
      'MELBOURNE BEACH': { state: 'FL', zip: '32951', normalize: 'Melbourne Beach' },
      'MELBOURNE VILLAGE': { state: 'FL', zip: '32904', normalize: 'Melbourne Village' },
      'MELROSE': { state: 'FL', zip: '32666', normalize: 'Melrose' },
      'MEMPHIS': { state: 'FL', zip: '33881', normalize: 'Memphis' },
      'MERRITT ISLAND': { state: 'FL', zip: '32952', normalize: 'Merritt Island' },
      'MEXICO BEACH': { state: 'FL', zip: '32456', normalize: 'Mexico Beach' },
      'MIAMI BCH': { state: 'FL', zip: '33139', normalize: 'Miami Beach' },
      'MIAMI GARDENS': { state: 'FL', zip: '33056', normalize: 'Miami Gardens' },
      'MIAMI LAKES': { state: 'FL', zip: '33014', normalize: 'Miami Lakes' },
      'MIAMI SHORES': { state: 'FL', zip: '33138', normalize: 'Miami Shores' },
      'MIAMI SPRINGS': { state: 'FL', zip: '33166', normalize: 'Miami Springs' },
      'MICANOPY': { state: 'FL', zip: '32667', normalize: 'Micanopy' },
      'MICCO': { state: 'FL', zip: '32976', normalize: 'Micco' },
      'MICCOSUKEE': { state: 'FL', zip: '32308', normalize: 'Miccosukee' },
      'MIDDLEBURG': { state: 'FL', zip: '32068', normalize: 'Middleburg' },
      'MIDWAY': { state: 'FL', zip: '32343', normalize: 'Midway' },
      'MILTON': { state: 'FL', zip: '32570', normalize: 'Milton' },
      'MIMS': { state: 'FL', zip: '32754', normalize: 'Mims' },
      'MINNEOLA': { state: 'FL', zip: '34715', normalize: 'Minneola' },
      'MIRAMAR': { state: 'FL', zip: '33023', normalize: 'Miramar' },
      'MIRAMAR BCH': { state: 'FL', zip: '32550', normalize: 'Miramar Beach' },
      'MOLINO': { state: 'FL', zip: '32577', normalize: 'Molino' },
      'MONTICELLO': { state: 'FL', zip: '32344', normalize: 'Monticello' },
      'MONTVERDE': { state: 'FL', zip: '34756', normalize: 'Montverde' },
      'MOORE HAVEN': { state: 'FL', zip: '33471', normalize: 'Moore Haven' },
      'MORRISTON': { state: 'FL', zip: '32668', normalize: 'Morriston' },
      'MOSSY HEAD': { state: 'FL', zip: '32434', normalize: 'Mossy Head' },
      'MOUNT CARMEL': { state: 'FL', zip: '32336', normalize: 'Mount Carmel' },
      'MOUNT DORA': { state: 'FL', zip: '32757', normalize: 'Mount Dora' },
      'MOUNT PLEASANT': { state: 'FL', zip: '32352', normalize: 'Mount Pleasant' },
      'MULAT': { state: 'FL', zip: '32571', normalize: 'Mulat' },
      'MULBERRY': { state: 'FL', zip: '33860', normalize: 'Mulberry' },
      'MURDOCK': { state: 'FL', zip: '33938', normalize: 'Murdock' },
      'MYAKKA CITY': { state: 'FL', zip: '34251', normalize: 'Myakka City' },
      // N
      'NALCREST': { state: 'FL', zip: '33856', normalize: 'Nalcrest' },
      'NAPLES MANOR': { state: 'FL', zip: '34114', normalize: 'Naples Manor' },
      'NAPLES PARK': { state: 'FL', zip: '34109', normalize: 'Naples Park' },
      'NARANJA': { state: 'FL', zip: '33032', normalize: 'Naranja' },
      'NASSAU VILLAGE RATLIFF': { state: 'FL', zip: '32034', normalize: 'Nassau Village Ratliff' },
      'NAVARRE': { state: 'FL', zip: '32566', normalize: 'Navarre' },
      'NAVARRE BCH': { state: 'FL', zip: '32566', normalize: 'Navarre Beach' },
      'NAVARRE BEACH': { state: 'FL', zip: '32566', normalize: 'Navarre Beach' },
      'NEPTUNE BCH': { state: 'FL', zip: '32266', normalize: 'Neptune Beach' },
      'NEW PORT RICHEY EAST': { state: 'FL', zip: '34653', normalize: 'New Port Richey East' },
      'NEW SMYRNA': { state: 'FL', zip: '32168', normalize: 'New Smyrna Beach' },
      'NEW SMYRNA BCH': { state: 'FL', zip: '32168', normalize: 'New Smyrna Beach' },
      'NEWBERRY': { state: 'FL', zip: '32669', normalize: 'Newberry' },
      'NICEVILLE': { state: 'FL', zip: '32578', normalize: 'Niceville' },
      'NOBLETON': { state: 'FL', zip: '34661', normalize: 'Nobleton' },
      'NOCATEE': { state: 'FL', zip: '34268', normalize: 'Nocatee' },
      'NOKOMIS': { state: 'FL', zip: '34275', normalize: 'Nokomis' },
      'NOMA': { state: 'FL', zip: '32452', normalize: 'Noma' },
      'NORLAND': { state: 'FL', zip: '33169', normalize: 'Norland' },
      'NORTH BAY VILLAGE': { state: 'FL', zip: '33141', normalize: 'North Bay Village' },
      'NORTH FORT MYERS': { state: 'FL', zip: '33903', normalize: 'North Fort Myers' },
      'NORTH FT MYERS': { state: 'FL', zip: '33903', normalize: 'North Fort Myers' },
      'NORTH KEY LARGO': { state: 'FL', zip: '33037', normalize: 'North Key Largo' },
      'NORTH LAUDERDALE': { state: 'FL', zip: '33068', normalize: 'North Lauderdale' },
      'NORTH MIAMI': { state: 'FL', zip: '33161', normalize: 'North Miami' },
      'NORTH MIAMI BEACH': { state: 'FL', zip: '33162', normalize: 'North Miami Beach' },
      'NORTH PALM BEACH': { state: 'FL', zip: '33408', normalize: 'North Palm Beach' },
      'NORTH PORT': { state: 'FL', zip: '34286', normalize: 'North Port' },
      'NORTH REDINGTON BEACH': { state: 'FL', zip: '33708', normalize: 'North Redington Beach' },
      'NORTH RIVER SHORES': { state: 'FL', zip: '34994', normalize: 'North River Shores' },
      'NORTH SARASOTA': { state: 'FL', zip: '34234', normalize: 'North Sarasota' },
      'NORTHDALE': { state: 'FL', zip: '33624', normalize: 'Northdale' },
      'OAK HILL': { state: 'FL', zip: '32759', normalize: 'Oak Hill' },
      'OAK RIDGE': { state: 'FL', zip: '32809', normalize: 'Oak Ridge' },
      'OCALA': { state: 'FL', zip: '34470', normalize: 'Ocala' },
      'OCEAN BREEZE PARK': { state: 'FL', zip: '34957', normalize: 'Ocean Breeze Park' },
      'OCEAN CITY': { state: 'FL', zip: '32903', normalize: 'Ocean City' },
      'OCEAN RIDGE': { state: 'FL', zip: '33435', normalize: 'Ocean Ridge' },
      'OCHOPEE': { state: 'FL', zip: '34141', normalize: 'Ochopee' },
      'OCOEE': { state: 'FL', zip: '34761', normalize: 'Ocoee' },
      'ODESSA': { state: 'FL', zip: '33556', normalize: 'Odessa' },
      'OKAHUMPKA': { state: 'FL', zip: '34762', normalize: 'Okahumpka' },
      'OKEECHOBEE': { state: 'FL', zip: '34972', normalize: 'Okeechobee' },
      'OLD TOWN': { state: 'FL', zip: '32680', normalize: 'Old Town' },
      'OLDSMAR': { state: 'FL', zip: '34677', normalize: 'Oldsmar' },
      'OLYMPIA HEIGHTS': { state: 'FL', zip: '33165', normalize: 'Olympia Heights' },
      'ONA': { state: 'FL', zip: '33865', normalize: 'Ona' },
      'ONECO': { state: 'FL', zip: '34264', normalize: 'Oneco' },
      'OPA LOCKA': { state: 'FL', zip: '33054', normalize: 'Opa Locka' },
      'OPA-LOCKA': { state: 'FL', zip: '33054', normalize: 'Opa Locka' },
      'ORANGE CITY': { state: 'FL', zip: '32763', normalize: 'Orange City' },
      'ORANGE PARK': { state: 'FL', zip: '32065', normalize: 'Orange Park' },
      'ORANGETREE': { state: 'FL', zip: '34120', normalize: 'Orangetree' },
      'ORCHID': { state: 'FL', zip: '32963', normalize: 'Orchid' },
      'ORIENT PARK': { state: 'FL', zip: '33619', normalize: 'Orient Park' },
      'ORLANDO': { state: 'FL', zip: '32801', normalize: 'Orlando' },
      'ORLOVISTA': { state: 'FL', zip: '32835', normalize: 'Orlovista' },
      'ORMOND BCH': { state: 'FL', zip: '32174', normalize: 'Ormond Beach' },
      'ORMOND BY THE SEA': { state: 'FL', zip: '32176', normalize: 'Ormond By The Sea' },
      'OSPREY': { state: 'FL', zip: '34229', normalize: 'Osprey' },
      'OTTER CREEK': { state: 'FL', zip: '32683', normalize: 'Otter Creek' },
      'OVIEDO': { state: 'FL', zip: '32765', normalize: 'Oviedo' },
      'OXFORD': { state: 'FL', zip: '34484', normalize: 'Oxford' },
      // P
      'PACE': { state: 'FL', zip: '32571', normalize: 'Pace' },
      'PAGE PARK': { state: 'FL', zip: '33308', normalize: 'Page Park' },
      'PAHOKEE': { state: 'FL', zip: '33476', normalize: 'Pahokee' },
      'PAISLEY': { state: 'FL', zip: '32767', normalize: 'Paisley' },
      'PALATKA': { state: 'FL', zip: '32177', normalize: 'Palatka' },
      'PALM AIRE': { state: 'FL', zip: '33069', normalize: 'Palm Aire' },
      'PALM BAY': { state: 'FL', zip: '32905', normalize: 'Palm Bay' },
      'PALM BCH': { state: 'FL', zip: '33480', normalize: 'Palm Beach' },
      'PALM BEACH GARDENS': { state: 'FL', zip: '33410', normalize: 'Palm Beach Gardens' },
      'PALM BEACH SHORES': { state: 'FL', zip: '33404', normalize: 'Palm Beach Shores' },
      'PALM CITY': { state: 'FL', zip: '34990', normalize: 'Palm City' },
      'PALM COAST': { state: 'FL', zip: '32137', normalize: 'Palm Coast' },
      'PALM HARBOR': { state: 'FL', zip: '34683', normalize: 'Palm Harbor' },
      'PALM RIVER': { state: 'FL', zip: '33619', normalize: 'Palm River' },
      'PALM RIVER CLAIR MEL': { state: 'FL', zip: '33619', normalize: 'Palm River Clair Mel' },
      'PALM SHORES': { state: 'FL', zip: '32940', normalize: 'Palm Shores' },
      'PALM SPRINGS': { state: 'FL', zip: '33461', normalize: 'Palm Springs' },
      'PALM SPRINGS NORTH': { state: 'FL', zip: '33015', normalize: 'Palm Springs North' },
      'PALM VALLEY': { state: 'FL', zip: '32082', normalize: 'Palm Valley' },
      'PALMDALE': { state: 'FL', zip: '33944', normalize: 'Palmdale' },
      'PALMETTO': { state: 'FL', zip: '34221', normalize: 'Palmetto' },
      'PALMETTO BAY': { state: 'FL', zip: '33157', normalize: 'Palmetto Bay' },
      'PALMETTO ESTATES': { state: 'FL', zip: '33157', normalize: 'Palmetto Estates' },
      'PALMONA PARK': { state: 'FL', zip: '33903', normalize: 'Palmona Park' },
      'PANACEA': { state: 'FL', zip: '32346', normalize: 'Panacea' },
      'PANAMA CITY': { state: 'FL', zip: '32401', normalize: 'Panama City' },
      'PANAMA CITY BCH': { state: 'FL', zip: '32407', normalize: 'Panama City Beach' },
      'PARADISE HEIGHTS': { state: 'FL', zip: '32065', normalize: 'Paradise Heights' },
      'PARKER': { state: 'FL', zip: '32404', normalize: 'Parker' },
      'PARKLAND': { state: 'FL', zip: '33067', normalize: 'Parkland' },
      'PARRISH': { state: 'FL', zip: '34219', normalize: 'Parrish' },
      'PATRICK AFB': { state: 'FL', zip: '32925', normalize: 'Patrick AFB' },
      'PAXTON': { state: 'FL', zip: '32538', normalize: 'Paxton' },
      'PEBBLE CREEK': { state: 'FL', zip: '33647', normalize: 'Pebble Creek' },
      'PELICAN BAY': { state: 'FL', zip: '34108', normalize: 'Pelican Bay' },
      'PEMBROKE PARK': { state: 'FL', zip: '33023', normalize: 'Pembroke Park' },
      'PEMBROKE PINES': { state: 'FL', zip: '33024', normalize: 'Pembroke Pines' },
      'PENNEY FARMS': { state: 'FL', zip: '32079', normalize: 'Penney Farms' },
      'PENNICHAW': { state: 'FL', zip: '34221', normalize: 'Pennichaw' },
      'PENSACOLA BCH': { state: 'FL', zip: '32561', normalize: 'Pensacola Beach' },
      'PENSACOLA BEACH': { state: 'FL', zip: '32561', normalize: 'Pensacola Beach' },
      'PERDIDO KEY': { state: 'FL', zip: '32507', normalize: 'Perdido Key' },
      'PERRINE': { state: 'FL', zip: '33157', normalize: 'Perrine' },
      'PERRY': { state: 'FL', zip: '32347', normalize: 'Perry' },
      'PIERSON': { state: 'FL', zip: '32180', normalize: 'Pierson' },
      'PINE CASTLE': { state: 'FL', zip: '32839', normalize: 'Pine Castle' },
      'PINE HILLS': { state: 'FL', zip: '32808', normalize: 'Pine Hills' },
      'PINE ISLAND': { state: 'FL', zip: '33922', normalize: 'Pine Island' },
      'PINE ISLAND CENTER': { state: 'FL', zip: '33956', normalize: 'Pine Island Center' },
      'PINE MANOR': { state: 'FL', zip: '33907', normalize: 'Pine Manor' },
      'PINE RIDGE': { state: 'FL', zip: '34465', normalize: 'Pine Ridge' },
      'PINECREST': { state: 'FL', zip: '33156', normalize: 'Pinecrest' },
      'PINELAND': { state: 'FL', zip: '33945', normalize: 'Pineland' },
      'PINELLAS PARK': { state: 'FL', zip: '33781', normalize: 'Pinellas Park' },
      'PINEWOOD': { state: 'FL', zip: '33054', normalize: 'Pinewood' },
      'PITTMAN': { state: 'FL', zip: '33954', normalize: 'Pittman' },
      'PLACIDA': { state: 'FL', zip: '33946', normalize: 'Placida' },
      'PLANT CITY': { state: 'FL', zip: '33563', normalize: 'Plant City' },
      'PLANTATION': { state: 'FL', zip: '33317', normalize: 'Plantation' },
      'PLANTATION ISLAND': { state: 'FL', zip: '34450', normalize: 'Plantation Island' },
      'PLANTATION KEY': { state: 'FL', zip: '33036', normalize: 'Plantation Key' },
      'POINCIANA': { state: 'FL', zip: '34759', normalize: 'Poinciana' },
      'POINT BAKER': { state: 'FL', zip: '32456', normalize: 'Point Baker' },
      'POLK CITY': { state: 'FL', zip: '33868', normalize: 'Polk City' },
      'POMONA PARK': { state: 'FL', zip: '32181', normalize: 'Pomona Park' },
      'POMPANO BCH': { state: 'FL', zip: '33060', normalize: 'Pompano Beach' },
      'POMPANO BEACH HIGHLANDS': { state: 'FL', zip: '33069', normalize: 'Pompano Beach Highlands' },
      'PONCE DE LEON': { state: 'FL', zip: '32455', normalize: 'Ponce De Leon' },
      'PONCE INLET': { state: 'FL', zip: '32127', normalize: 'Ponce Inlet' },
      'PONTE VEDRA': { state: 'FL', zip: '32081', normalize: 'Ponte Vedra' },
      'PONTE VEDRA BCH': { state: 'FL', zip: '32082', normalize: 'Ponte Vedra Beach' },
      'PORT CHARLOTTE': { state: 'FL', zip: '33948', normalize: 'Port Charlotte' },
      'PORT LABELLE': { state: 'FL', zip: '33935', normalize: 'Port LaBelle' },
      'PORT ORANGE': { state: 'FL', zip: '32127', normalize: 'Port Orange' },
      'PORT RICHEY': { state: 'FL', zip: '34668', normalize: 'Port Richey' },
      'PORT SALERNO': { state: 'FL', zip: '34992', normalize: 'Port Salerno' },
      'PORT ST JOE': { state: 'FL', zip: '32456', normalize: 'Port Saint Joe' },
      'PORT ST JOHN': { state: 'FL', zip: '32927', normalize: 'Port Saint John' },
      'PORT ST LUCIE': { state: 'FL', zip: '34952', normalize: 'Port Saint Lucie' },
      'PORT SAINT JOE': { state: 'FL', zip: '32456', normalize: 'Port Saint Joe' },
      'PORT SAINT JOHN': { state: 'FL', zip: '32927', normalize: 'Port Saint John' },
      'PORT SAINT LUCIE': { state: 'FL', zip: '34952', normalize: 'Port Saint Lucie' },
      'PORT TAMPA': { state: 'FL', zip: '33616', normalize: 'Port Tampa' },
      'PUNTA GORDA': { state: 'FL', zip: '33950', normalize: 'Punta Gorda' },
      'PUNTA RASSA': { state: 'FL', zip: '33908', normalize: 'Punta Rassa' },
      // Q
      'QUINCY': { state: 'FL', zip: '32351', normalize: 'Quincy' },
      // R
      'RAIFORD': { state: 'FL', zip: '32083', normalize: 'Raiford' },
      'REDDICK': { state: 'FL', zip: '32686', normalize: 'Reddick' },
      'REDINGTON BEACH': { state: 'FL', zip: '33708', normalize: 'Redington Beach' },
      'REDINGTON SHORES': { state: 'FL', zip: '33708', normalize: 'Redington Shores' },
      'RICHMOND HEIGHTS': { state: 'FL', zip: '33157', normalize: 'Richmond Heights' },
      'RICHMOND WEST': { state: 'FL', zip: '33177', normalize: 'Richmond West' },
      'RIDGE MANOR': { state: 'FL', zip: '33523', normalize: 'Ridge Manor' },
      'RIDGECREST': { state: 'FL', zip: '33870', normalize: 'Ridgecrest' },
      'RIVER PARK': { state: 'FL', zip: '34994', normalize: 'River Park' },
      'RIVER RANCH': { state: 'FL', zip: '33867', normalize: 'River Ranch' },
      'RIVERLAND': { state: 'FL', zip: '33315', normalize: 'Riverland' },
      'RIVERVIEW': { state: 'FL', zip: '33578', normalize: 'Riverview' },
      'RIVIERA BEACH': { state: 'FL', zip: '33404', normalize: 'Riviera Beach' },
      'ROCK ISLAND': { state: 'FL', zip: '33313', normalize: 'Rock Island' },
      'ROCKLEDGE': { state: 'FL', zip: '32955', normalize: 'Rockledge' },
      'ROLLING OAKS': { state: 'FL', zip: '32308', normalize: 'Rolling Oaks' },
      'ROSELAND': { state: 'FL', zip: '32957', normalize: 'Roseland' },
      'ROTONDA': { state: 'FL', zip: '33947', normalize: 'Rotonda' },
      'ROTONDA WEST': { state: 'FL', zip: '33947', normalize: 'Rotonda West' },
      'ROYAL PALM BCH': { state: 'FL', zip: '33411', normalize: 'Royal Palm Beach' },
      'ROYAL PALM ESTATES': { state: 'FL', zip: '33415', normalize: 'Royal Palm Estates' },
      'RUSKIN': { state: 'FL', zip: '33570', normalize: 'Ruskin' },
      // S
      'SAFETY HARBOR': { state: 'FL', zip: '34695', normalize: 'Safety Harbor' },
      'SAINT AUGUSTINE': { state: 'FL', zip: '32084', normalize: 'Saint Augustine' },
      'SAINT AUGUSTINE BCH': { state: 'FL', zip: '32080', normalize: 'Saint Augustine Beach' },
      'SAINT AUGUSTINE BEACH': { state: 'FL', zip: '32080', normalize: 'Saint Augustine Beach' },
      'SAINT CLOUD': { state: 'FL', zip: '34769', normalize: 'Saint Cloud' },
      'SAINT GEORGE ISLAND': { state: 'FL', zip: '32328', normalize: 'Saint George Island' },
      'SAINT JAMES CITY': { state: 'FL', zip: '33956', normalize: 'Saint James City' },
      'SAINT LEO': { state: 'FL', zip: '33574', normalize: 'Saint Leo' },
      'SAINT LUCIE': { state: 'FL', zip: '34952', normalize: 'Saint Lucie' },
      'SAINT MARKS': { state: 'FL', zip: '32355', normalize: 'Saint Marks' },
      'SAINT PETE BCH': { state: 'FL', zip: '33706', normalize: 'Saint Pete Beach' },
      'SAINT PETE BEACH': { state: 'FL', zip: '33706', normalize: 'Saint Pete Beach' },
      'SAINT PETERSBURG': { state: 'FL', zip: '33701', normalize: 'Saint Petersburg' },
      'SALEM': { state: 'FL', zip: '32356', normalize: 'Salem' },
      'SALERNO': { state: 'FL', zip: '34997', normalize: 'Salerno' },
      'SAMSULA': { state: 'FL', zip: '32168', normalize: 'Samsula' },
      'SAMSULA SPRUCE CREEK': { state: 'FL', zip: '32168', normalize: 'Samsula Spruce Creek' },
      'SAN ANTONIO': { state: 'FL', zip: '33576', normalize: 'San Antonio' },
      'SAN CARLOS PARK': { state: 'FL', zip: '33967', normalize: 'San Carlos Park' },
      'SAN MATEO': { state: 'FL', zip: '32187', normalize: 'San Mateo' },
      'SANDERSON': { state: 'FL', zip: '32087', normalize: 'Sanderson' },
      'SANFORD': { state: 'FL', zip: '32771', normalize: 'Sanford' },
      'SANIBEL': { state: 'FL', zip: '33957', normalize: 'Sanibel' },
      'SANTA ROSA BCH': { state: 'FL', zip: '32459', normalize: 'Santa Rosa Beach' },
      'SARASOTA SPRINGS': { state: 'FL', zip: '34233', normalize: 'Sarasota Springs' },
      'SATELLITE BEACH': { state: 'FL', zip: '32937', normalize: 'Satellite Beach' },
      'SATSUMA': { state: 'FL', zip: '32189', normalize: 'Satsuma' },
      'SAWGRASS': { state: 'FL', zip: '32082', normalize: 'Sawgrass' },
      'SCHALL CIRCLE': { state: 'FL', zip: '33134', normalize: 'Schall Circle' },
      'SCOTTSMOOR': { state: 'FL', zip: '32775', normalize: 'Scottsmoor' },
      'SEA RANCH LAKES': { state: 'FL', zip: '33308', normalize: 'Sea Ranch Lakes' },
      'SEBASTIAN': { state: 'FL', zip: '32958', normalize: 'Sebastian' },
      'SEBRING': { state: 'FL', zip: '33870', normalize: 'Sebring' },
      'SEFFNER': { state: 'FL', zip: '33584', normalize: 'Seffner' },
      'SEMINOLE': { state: 'FL', zip: '33772', normalize: 'Seminole' },
      'SEMINOLE MANOR': { state: 'FL', zip: '33462', normalize: 'Seminole Manor' },
      'SEWALL POINT': { state: 'FL', zip: '34996', normalize: 'Sewalls Point' },
      'SEWALLS POINT': { state: 'FL', zip: '34996', normalize: 'Sewalls Point' },
      'SHADY HILLS': { state: 'FL', zip: '34610', normalize: 'Shady Hills' },
      'SHALIMAR': { state: 'FL', zip: '32579', normalize: 'Shalimar' },
      'SHARPES': { state: 'FL', zip: '32959', normalize: 'Sharpes' },
      'SILVER LAKE': { state: 'FL', zip: '34488', normalize: 'Silver Lake' },
      'SILVER SPRINGS': { state: 'FL', zip: '34488', normalize: 'Silver Springs' },
      'SILVER SPRINGS SHORES': { state: 'FL', zip: '34472', normalize: 'Silver Springs Shores' },
      'SKY LAKE': { state: 'FL', zip: '32809', normalize: 'Sky Lake' },
      'SNEADS': { state: 'FL', zip: '32460', normalize: 'Sneads' },
      'SOLANA': { state: 'FL', zip: '34272', normalize: 'Solana' },
      'SOPCHOPPY': { state: 'FL', zip: '32358', normalize: 'Sopchoppy' },
      'SORRENTO': { state: 'FL', zip: '32776', normalize: 'Sorrento' },
      'SOUTH APOPKA': { state: 'FL', zip: '32703', normalize: 'South Apopka' },
      'SOUTH BAY': { state: 'FL', zip: '33493', normalize: 'South Bay' },
      'SOUTH BEACH': { state: 'FL', zip: '32169', normalize: 'South Beach' },
      'SOUTH BRADENTON': { state: 'FL', zip: '34207', normalize: 'South Bradenton' },
      'SOUTH BROOKSVILLE': { state: 'FL', zip: '34601', normalize: 'South Brooksville' },
      'SOUTH DAYTONA': { state: 'FL', zip: '32119', normalize: 'South Daytona' },
      'SOUTH GATE RIDGE': { state: 'FL', zip: '34239', normalize: 'South Gate Ridge' },
      'SOUTH HIGHPOINT': { state: 'FL', zip: '33615', normalize: 'South Highpoint' },
      'SOUTH MIAMI': { state: 'FL', zip: '33143', normalize: 'South Miami' },
      'SOUTH MIAMI HEIGHTS': { state: 'FL', zip: '33157', normalize: 'South Miami Heights' },
      'SOUTH PALM BEACH': { state: 'FL', zip: '33480', normalize: 'South Palm Beach' },
      'SOUTH PASADENA': { state: 'FL', zip: '33707', normalize: 'South Pasadena' },
      'SOUTH PATRICK SHORES': { state: 'FL', zip: '32937', normalize: 'South Patrick Shores' },
      'SOUTH VENICE': { state: 'FL', zip: '34293', normalize: 'South Venice' },
      'SOUTHCHASE': { state: 'FL', zip: '32837', normalize: 'Southchase' },
      'SOUTHEAST ARCADIA': { state: 'FL', zip: '34266', normalize: 'Southeast Arcadia' },
      'SOUTHGATE': { state: 'FL', zip: '34239', normalize: 'Southgate' },
      'SOUTHWEST RANCHES': { state: 'FL', zip: '33330', normalize: 'Southwest Ranches' },
      'SPARR': { state: 'FL', zip: '32192', normalize: 'Sparr' },
      'SPRING HILL': { state: 'FL', zip: '34606', normalize: 'Spring Hill' },
      'SPRING LAKE': { state: 'FL', zip: '34602', normalize: 'Spring Lake' },
      'SPRINGFIELD': { state: 'FL', zip: '32401', normalize: 'Springfield' },
      'ST AUGUSTINE': { state: 'FL', zip: '32084', normalize: 'Saint Augustine' },
      'ST AUGUSTINE BCH': { state: 'FL', zip: '32080', normalize: 'Saint Augustine Beach' },
      'ST AUGUSTINE BEACH': { state: 'FL', zip: '32080', normalize: 'Saint Augustine Beach' },
      'ST CLOUD': { state: 'FL', zip: '34769', normalize: 'Saint Cloud' },
      'ST GEORGE ISLAND': { state: 'FL', zip: '32328', normalize: 'Saint George Island' },
      'ST JAMES CITY': { state: 'FL', zip: '33956', normalize: 'Saint James City' },
      'ST LEO': { state: 'FL', zip: '33574', normalize: 'Saint Leo' },
      'ST LUCIE': { state: 'FL', zip: '34952', normalize: 'Saint Lucie' },
      'ST MARKS': { state: 'FL', zip: '32355', normalize: 'Saint Marks' },
      'ST PETE': { state: 'FL', zip: '33701', normalize: 'Saint Petersburg' },
      'ST PETE BCH': { state: 'FL', zip: '33706', normalize: 'Saint Pete Beach' },
      'ST PETE BEACH': { state: 'FL', zip: '33706', normalize: 'Saint Pete Beach' },
      'ST PETERSBURG': { state: 'FL', zip: '33701', normalize: 'Saint Petersburg' },
      'STARKE': { state: 'FL', zip: '32091', normalize: 'Starke' },
      'STEINHATCHEE': { state: 'FL', zip: '32359', normalize: 'Steinhatchee' },
      'STOCK ISLAND': { state: 'FL', zip: '33040', normalize: 'Stock Island' },
      'STUART': { state: 'FL', zip: '34994', normalize: 'Stuart' },
      'SUGARMILL WOODS': { state: 'FL', zip: '34446', normalize: 'Sugarmill Woods' },
      'SUMATRA': { state: 'FL', zip: '32335', normalize: 'Sumatra' },
      'SUMMERFIELD': { state: 'FL', zip: '34491', normalize: 'Summerfield' },
      'SUMMERLAND KEY': { state: 'FL', zip: '33042', normalize: 'Summerland Key' },
      'SUMTERVILLE': { state: 'FL', zip: '33585', normalize: 'Sumterville' },
      'SUN CITY': { state: 'FL', zip: '33573', normalize: 'Sun City' },
      'SUN CITY CENTER': { state: 'FL', zip: '33573', normalize: 'Sun City Center' },
      'SUNCOAST ESTATES': { state: 'FL', zip: '33917', normalize: 'Suncoast Estates' },
      'SUNNY ISLES': { state: 'FL', zip: '33160', normalize: 'Sunny Isles Beach' },
      'SUNNY ISLES BCH': { state: 'FL', zip: '33160', normalize: 'Sunny Isles Beach' },
      'SUNRISE': { state: 'FL', zip: '33322', normalize: 'Sunrise' },
      'SUNSET': { state: 'FL', zip: '33173', normalize: 'Sunset' },
      'SURFSIDE': { state: 'FL', zip: '33154', normalize: 'Surfside' },
      'SWEETWATER': { state: 'FL', zip: '33172', normalize: 'Sweetwater' },
      'SUWANNEE': { state: 'FL', zip: '32692', normalize: 'Suwannee' },
      'SYDNEY': { state: 'FL', zip: '33587', normalize: 'Sydney' },
      // T
      'TALLAHASSEE': { state: 'FL', zip: '32301', normalize: 'Tallahassee' },
      'TAMARAC': { state: 'FL', zip: '33319', normalize: 'Tamarac' },
      'TAMIAMI': { state: 'FL', zip: '33175', normalize: 'Tamiami' },
      'TAMPA': { state: 'FL', zip: '33601', normalize: 'Tampa' },
      'TANGERINE': { state: 'FL', zip: '32777', normalize: 'Tangerine' },
      'TARPON SPRINGS': { state: 'FL', zip: '34689', normalize: 'Tarpon Springs' },
      'TAVARES': { state: 'FL', zip: '32778', normalize: 'Tavares' },
      'TAVERNIER': { state: 'FL', zip: '33070', normalize: 'Tavernier' },
      'TAYLOR CREEK': { state: 'FL', zip: '34972', normalize: 'Taylor Creek' },
      'TEMPLE TERRACE': { state: 'FL', zip: '33617', normalize: 'Temple Terrace' },
      'TEQUESTA': { state: 'FL', zip: '33469', normalize: 'Tequesta' },
      'THE ACREAGE': { state: 'FL', zip: '33470', normalize: 'The Acreage' },
      'THE CROSSINGS': { state: 'FL', zip: '33186', normalize: 'The Crossings' },
      'THE HAMMOCKS': { state: 'FL', zip: '33196', normalize: 'The Hammocks' },
      'THE MEADOWS': { state: 'FL', zip: '34235', normalize: 'The Meadows' },
      'THE VILLAGES': { state: 'FL', zip: '32162', normalize: 'The Villages' },
      'THONOTOSASSA': { state: 'FL', zip: '33592', normalize: 'Thonotosassa' },
      'THREE LAKES': { state: 'FL', zip: '33018', normalize: 'Three Lakes' },
      'THREE OAKS': { state: 'FL', zip: '33912', normalize: 'Three Oaks' },
      'TICE': { state: 'FL', zip: '33905', normalize: 'Tice' },
      'TIERRA VERDE': { state: 'FL', zip: '33715', normalize: 'Tierra Verde' },
      'TILDENVILLE': { state: 'FL', zip: '34787', normalize: 'Tildenville' },
      'TIMBER PINES': { state: 'FL', zip: '34606', normalize: 'Timber Pines' },
      'TITUSVILLE': { state: 'FL', zip: '32780', normalize: 'Titusville' },
      'TOWN N COUNTRY': { state: 'FL', zip: '33615', normalize: 'Town N Country' },
      'TREASURE ISLAND': { state: 'FL', zip: '33706', normalize: 'Treasure Island' },
      'TRENTON': { state: 'FL', zip: '32693', normalize: 'Trenton' },
      'TRILBY': { state: 'FL', zip: '33593', normalize: 'Trilby' },
      'TRINITY': { state: 'FL', zip: '34655', normalize: 'Trinity' },
      'TROPICAL GULF ACRES': { state: 'FL', zip: '33980', normalize: 'Tropical Gulf Acres' },
      // U
      'UMATILLA': { state: 'FL', zip: '32784', normalize: 'Umatilla' },
      'UNION PARK': { state: 'FL', zip: '32817', normalize: 'Union Park' },
      'UNIVERSITY': { state: 'FL', zip: '33615', normalize: 'University' },
      'UNIVERSITY PARK': { state: 'FL', zip: '34201', normalize: 'University Park' },
      'UPPER GRAND LAGOON': { state: 'FL', zip: '32408', normalize: 'Upper Grand Lagoon' },
      // V
      'VALPARAISO': { state: 'FL', zip: '32580', normalize: 'Valparaiso' },
      'VALRICO': { state: 'FL', zip: '33594', normalize: 'Valrico' },
      'VAMO': { state: 'FL', zip: '34231', normalize: 'Vamo' },
      'VENICE': { state: 'FL', zip: '34285', normalize: 'Venice' },
      'VENICE GARDENS': { state: 'FL', zip: '34293', normalize: 'Venice Gardens' },
      'VENUS': { state: 'FL', zip: '33960', normalize: 'Venus' },
      'VERO BCH': { state: 'FL', zip: '32960', normalize: 'Vero Beach' },
      'VERO BEACH SOUTH': { state: 'FL', zip: '32962', normalize: 'Vero Beach South' },
      'VIERA': { state: 'FL', zip: '32940', normalize: 'Viera' },
      'VIERA EAST': { state: 'FL', zip: '32940', normalize: 'Viera East' },
      'VIERA WEST': { state: 'FL', zip: '32940', normalize: 'Viera West' },
      'VILLAGE OF GOLF': { state: 'FL', zip: '33436', normalize: 'Village of Golf' },
      'VILLAGES': { state: 'FL', zip: '32162', normalize: 'The Villages' },
      'VILLANO BEACH': { state: 'FL', zip: '32084', normalize: 'Villano Beach' },
      'VILLAS': { state: 'FL', zip: '33907', normalize: 'Villas' },
      'VINEYARDS': { state: 'FL', zip: '34119', normalize: 'Vineyards' },
      'VIRGINIA GARDENS': { state: 'FL', zip: '33166', normalize: 'Virginia Gardens' },
      // W
      'WABASSO': { state: 'FL', zip: '32970', normalize: 'Wabasso' },
      'WABASSO BEACH': { state: 'FL', zip: '32963', normalize: 'Wabasso Beach' },
      'WACISSA': { state: 'FL', zip: '32344', normalize: 'Wacissa' },
      'WAHNETA': { state: 'FL', zip: '33880', normalize: 'Wahneta' },
      'WALDO': { state: 'FL', zip: '32694', normalize: 'Waldo' },
      'WARM MINERAL SPRINGS': { state: 'FL', zip: '34287', normalize: 'Warm Mineral Springs' },
      'WARRINGTON': { state: 'FL', zip: '32507', normalize: 'Warrington' },
      'WASHINGTON PARK': { state: 'FL', zip: '33405', normalize: 'Washington Park' },
      'WATERFORD LAKES': { state: 'FL', zip: '32828', normalize: 'Waterford Lakes' },
      'WATERTOWN': { state: 'FL', zip: '32327', normalize: 'Watertown' },
      'WAUCHULA': { state: 'FL', zip: '33873', normalize: 'Wauchula' },
      'WAUSAU': { state: 'FL', zip: '32463', normalize: 'Wausau' },
      'WEBSTER': { state: 'FL', zip: '33597', normalize: 'Webster' },
      'WEDGEFIELD': { state: 'FL', zip: '32833', normalize: 'Wedgefield' },
      'WEEKI WACHEE': { state: 'FL', zip: '34607', normalize: 'Weeki Wachee' },
      'WEEKI WACHEE GARDENS': { state: 'FL', zip: '34607', normalize: 'Weeki Wachee Gardens' },
      'WEIRSDALE': { state: 'FL', zip: '32195', normalize: 'Weirsdale' },
      'WEKIVA SPRINGS': { state: 'FL', zip: '32779', normalize: 'Wekiva Springs' },
      'WEKIWA SPRINGS': { state: 'FL', zip: '32779', normalize: 'Wekiwa Springs' },
      'WELAKA': { state: 'FL', zip: '32193', normalize: 'Welaka' },
      'WELLINGTON': { state: 'FL', zip: '33414', normalize: 'Wellington' },
      'WESLEY CHAPEL': { state: 'FL', zip: '33543', normalize: 'Wesley Chapel' },
      'WEST AND EAST LEALMAN': { state: 'FL', zip: '33714', normalize: 'West And East Lealman' },
      'WEST BRADENTON': { state: 'FL', zip: '34209', normalize: 'West Bradenton' },
      'WEST DELAND': { state: 'FL', zip: '32720', normalize: 'West DeLand' },
      'WEST GATE': { state: 'FL', zip: '33405', normalize: 'West Gate' },
      'WEST LITTLE RIVER': { state: 'FL', zip: '33147', normalize: 'West Little River' },
      'WEST MELBOURNE': { state: 'FL', zip: '32904', normalize: 'West Melbourne' },
      'WEST MIAMI': { state: 'FL', zip: '33144', normalize: 'West Miami' },
      'WEST PALM BCH': { state: 'FL', zip: '33401', normalize: 'West Palm Beach' },
      'WEST PALM BEACH': { state: 'FL', zip: '33401', normalize: 'West Palm Beach' },
      'WEST PARK': { state: 'FL', zip: '33023', normalize: 'West Park' },
      'WEST PENSACOLA': { state: 'FL', zip: '32505', normalize: 'West Pensacola' },
      'WEST PERRINE': { state: 'FL', zip: '33190', normalize: 'West Perrine' },
      'WEST SAMOSET': { state: 'FL', zip: '34208', normalize: 'West Samoset' },
      'WEST VERO CORRIDOR': { state: 'FL', zip: '32966', normalize: 'West Vero Corridor' },
      'WESTCHASE': { state: 'FL', zip: '33626', normalize: 'Westchase' },
      'WESTCHESTER': { state: 'FL', zip: '33165', normalize: 'Westchester' },
      'WESTON': { state: 'FL', zip: '33326', normalize: 'Weston' },
      'WESTVIEW': { state: 'FL', zip: '33167', normalize: 'Westview' },
      'WESTVILLE': { state: 'FL', zip: '32464', normalize: 'Westville' },
      'WESTWOOD LAKES': { state: 'FL', zip: '33155', normalize: 'Westwood Lakes' },
      'WEWAHITCHKA': { state: 'FL', zip: '32465', normalize: 'Wewahitchka' },
      'WHITE CITY': { state: 'FL', zip: '34945', normalize: 'White City' },
      'WHITE SPRINGS': { state: 'FL', zip: '32096', normalize: 'White Springs' },
      'WHITFIELD': { state: 'FL', zip: '34243', normalize: 'Whitfield' },
      'WILDWOOD': { state: 'FL', zip: '34785', normalize: 'Wildwood' },
      'WILLIAMSBURG': { state: 'FL', zip: '32821', normalize: 'Williamsburg' },
      'WILLISTON': { state: 'FL', zip: '32696', normalize: 'Williston' },
      'WILLISTON HIGHLANDS': { state: 'FL', zip: '32696', normalize: 'Williston Highlands' },
      'WILTON MANORS': { state: 'FL', zip: '33305', normalize: 'Wilton Manors' },
      'WIMAUMA': { state: 'FL', zip: '33598', normalize: 'Wimauma' },
      'WINDERMERE': { state: 'FL', zip: '34786', normalize: 'Windermere' },
      'WINTER BEACH': { state: 'FL', zip: '32971', normalize: 'Winter Beach' },
      'WINTER GARDEN': { state: 'FL', zip: '34787', normalize: 'Winter Garden' },
      'WINTER HAVEN': { state: 'FL', zip: '33880', normalize: 'Winter Haven' },
      'WINTER PARK': { state: 'FL', zip: '32789', normalize: 'Winter Park' },
      'WINTER SPRINGS': { state: 'FL', zip: '32708', normalize: 'Winter Springs' },
      'WISCON': { state: 'FL', zip: '33597', normalize: 'Wiscon' },
      'WOODVILLE': { state: 'FL', zip: '32362', normalize: 'Woodville' },
      'WORLD GOLF VILLAGE': { state: 'FL', zip: '32092', normalize: 'World Golf Village' },
      'WORTHINGTON SPRINGS': { state: 'FL', zip: '32697', normalize: 'Worthington Springs' },
      'WULFERT': { state: 'FL', zip: '33957', normalize: 'Wulfert' },
      // Y
      'YALAHA': { state: 'FL', zip: '34797', normalize: 'Yalaha' },
      'YANKEETOWN': { state: 'FL', zip: '34498', normalize: 'Yankeetown' },
      'YOUNGSTOWN': { state: 'FL', zip: '32466', normalize: 'Youngstown' },
      'YULEE': { state: 'FL', zip: '32097', normalize: 'Yulee' },
      // Z
      'ZELLWOOD': { state: 'FL', zip: '32798', normalize: 'Zellwood' },
      'ZEPHYRHILLS': { state: 'FL', zip: '33540', normalize: 'Zephyrhills' },
      'ZEPHYRHILLS NORTH': { state: 'FL', zip: '33540', normalize: 'Zephyrhills North' },
      'ZEPHYRHILLS SOUTH': { state: 'FL', zip: '33541', normalize: 'Zephyrhills South' },
      'ZEPHYRHILLS WEST': { state: 'FL', zip: '33541', normalize: 'Zephyrhills West' },
      'ZOLFO SPRINGS': { state: 'FL', zip: '33890', normalize: 'Zolfo Springs' },

      // === ALABAMA ===
      'MONTGOMERY': { state: 'AL', zip: '36104', normalize: 'Montgomery' },
      'BIRMINGHAM': { state: 'AL', zip: '35203', normalize: 'Birmingham' },
      'HUNTSVILLE': { state: 'AL', zip: '35801', normalize: 'Huntsville' },
      'MOBILE': { state: 'AL', zip: '36602', normalize: 'Mobile' },
      'TUSCALOOSA': { state: 'AL', zip: '35401', normalize: 'Tuscaloosa' },

      // === ALASKA ===
      'JUNEAU': { state: 'AK', zip: '99801', normalize: 'Juneau' },
      'ANCHORAGE': { state: 'AK', zip: '99501', normalize: 'Anchorage' },
      'FAIRBANKS': { state: 'AK', zip: '99701', normalize: 'Fairbanks' },

      // === ARIZONA ===
      'PHOENIX': { state: 'AZ', zip: '85001', normalize: 'Phoenix' },
      'TUCSON': { state: 'AZ', zip: '85701', normalize: 'Tucson' },
      'MESA': { state: 'AZ', zip: '85201', normalize: 'Mesa' },
      'SCOTTSDALE': { state: 'AZ', zip: '85251', normalize: 'Scottsdale' },
      'CHANDLER': { state: 'AZ', zip: '85224', normalize: 'Chandler' },
      'GILBERT': { state: 'AZ', zip: '85233', normalize: 'Gilbert' },
      'GLENDALE': { state: 'AZ', zip: '85301', normalize: 'Glendale' },
      'TEMPE': { state: 'AZ', zip: '85281', normalize: 'Tempe' },
      'PEORIA': { state: 'AZ', zip: '85345', normalize: 'Peoria' },
      'SURPRISE': { state: 'AZ', zip: '85374', normalize: 'Surprise' },

      // === ARKANSAS ===
      'LITTLE ROCK': { state: 'AR', zip: '72201', normalize: 'Little Rock' },
      'FORT SMITH': { state: 'AR', zip: '72901', normalize: 'Fort Smith' },
      'FT SMITH': { state: 'AR', zip: '72901', normalize: 'Fort Smith' },
      'FAYETTEVILLE': { state: 'AR', zip: '72701', normalize: 'Fayetteville' },
      'SPRINGDALE': { state: 'AR', zip: '72762', normalize: 'Springdale' },

      // === CALIFORNIA ===
      'SACRAMENTO': { state: 'CA', zip: '95814', normalize: 'Sacramento' },
      'LOS ANGELES': { state: 'CA', zip: '90001', normalize: 'Los Angeles' },
      'SAN DIEGO': { state: 'CA', zip: '92101', normalize: 'San Diego' },
      'SAN JOSE': { state: 'CA', zip: '95101', normalize: 'San Jose' },
      'SAN FRANCISCO': { state: 'CA', zip: '94102', normalize: 'San Francisco' },
      'FRESNO': { state: 'CA', zip: '93701', normalize: 'Fresno' },
      'LONG BEACH': { state: 'CA', zip: '90802', normalize: 'Long Beach' },
      'OAKLAND': { state: 'CA', zip: '94601', normalize: 'Oakland' },
      'BAKERSFIELD': { state: 'CA', zip: '93301', normalize: 'Bakersfield' },
      'ANAHEIM': { state: 'CA', zip: '92801', normalize: 'Anaheim' },
      'SANTA ANA': { state: 'CA', zip: '92701', normalize: 'Santa Ana' },
      'RIVERSIDE': { state: 'CA', zip: '92501', normalize: 'Riverside' },
      'IRVINE': { state: 'CA', zip: '92602', normalize: 'Irvine' },
      'STOCKTON': { state: 'CA', zip: '95202', normalize: 'Stockton' },

      // === COLORADO ===
      'DENVER': { state: 'CO', zip: '80202', normalize: 'Denver' },
      'COLORADO SPRINGS': { state: 'CO', zip: '80903', normalize: 'Colorado Springs' },
      'AURORA': { state: 'CO', zip: '80010', normalize: 'Aurora' },
      'FORT COLLINS': { state: 'CO', zip: '80521', normalize: 'Fort Collins' },
      'FT COLLINS': { state: 'CO', zip: '80521', normalize: 'Fort Collins' },
      'LAKEWOOD': { state: 'CO', zip: '80226', normalize: 'Lakewood' },

      // === CONNECTICUT ===
      'HARTFORD': { state: 'CT', zip: '06103', normalize: 'Hartford' },
      'BRIDGEPORT': { state: 'CT', zip: '06601', normalize: 'Bridgeport' },
      'NEW HAVEN': { state: 'CT', zip: '06510', normalize: 'New Haven' },
      'STAMFORD': { state: 'CT', zip: '06901', normalize: 'Stamford' },
      'WATERBURY': { state: 'CT', zip: '06702', normalize: 'Waterbury' },

      // === DELAWARE ===
      'DOVER': { state: 'DE', zip: '19901', normalize: 'Dover' },
      'WILMINGTON': { state: 'DE', zip: '19801', normalize: 'Wilmington' },
      'NEWARK': { state: 'DE', zip: '19711', normalize: 'Newark' },

      // === GEORGIA ===
      'ATLANTA': { state: 'GA', zip: '30301', normalize: 'Atlanta' },
      'AUGUSTA': { state: 'GA', zip: '30901', normalize: 'Augusta' },
      'COLUMBUS': { state: 'GA', zip: '31901', normalize: 'Columbus' },
      'SAVANNAH': { state: 'GA', zip: '31401', normalize: 'Savannah' },
      'MACON': { state: 'GA', zip: '31201', normalize: 'Macon' },
      'ROSWELL': { state: 'GA', zip: '30075', normalize: 'Roswell' },
      'MARIETTA': { state: 'GA', zip: '30060', normalize: 'Marietta' },
      'ALPHARETTA': { state: 'GA', zip: '30004', normalize: 'Alpharetta' },

      // === HAWAII ===
      'HONOLULU': { state: 'HI', zip: '96813', normalize: 'Honolulu' },
      'HILO': { state: 'HI', zip: '96720', normalize: 'Hilo' },
      'KAILUA': { state: 'HI', zip: '96734', normalize: 'Kailua' },

      // === IDAHO ===
      'BOISE': { state: 'ID', zip: '83702', normalize: 'Boise' },
      'MERIDIAN': { state: 'ID', zip: '83642', normalize: 'Meridian' },
      'NAMPA': { state: 'ID', zip: '83651', normalize: 'Nampa' },
      'IDAHO FALLS': { state: 'ID', zip: '83401', normalize: 'Idaho Falls' },

      // === ILLINOIS ===
      'SPRINGFIELD': { state: 'IL', zip: '62701', normalize: 'Springfield' },
      'CHICAGO': { state: 'IL', zip: '60601', normalize: 'Chicago' },
      'AURORA IL': { state: 'IL', zip: '60505', normalize: 'Aurora' },
      'NAPERVILLE': { state: 'IL', zip: '60540', normalize: 'Naperville' },
      'ROCKFORD': { state: 'IL', zip: '61101', normalize: 'Rockford' },
      'JOLIET': { state: 'IL', zip: '60431', normalize: 'Joliet' },

      // === INDIANA ===
      'INDIANAPOLIS': { state: 'IN', zip: '46204', normalize: 'Indianapolis' },
      'FORT WAYNE': { state: 'IN', zip: '46802', normalize: 'Fort Wayne' },
      'FT WAYNE': { state: 'IN', zip: '46802', normalize: 'Fort Wayne' },
      'EVANSVILLE': { state: 'IN', zip: '47708', normalize: 'Evansville' },
      'SOUTH BEND': { state: 'IN', zip: '46601', normalize: 'South Bend' },

      // === IOWA ===
      'DES MOINES': { state: 'IA', zip: '50309', normalize: 'Des Moines' },
      'CEDAR RAPIDS': { state: 'IA', zip: '52401', normalize: 'Cedar Rapids' },
      'DAVENPORT': { state: 'IA', zip: '52801', normalize: 'Davenport' },

      // === KANSAS ===
      'TOPEKA': { state: 'KS', zip: '66603', normalize: 'Topeka' },
      'WICHITA': { state: 'KS', zip: '67202', normalize: 'Wichita' },
      'OVERLAND PARK': { state: 'KS', zip: '66204', normalize: 'Overland Park' },
      'KANSAS CITY KS': { state: 'KS', zip: '66101', normalize: 'Kansas City' },

      // === KENTUCKY ===
      'FRANKFORT': { state: 'KY', zip: '40601', normalize: 'Frankfort' },
      'LOUISVILLE': { state: 'KY', zip: '40202', normalize: 'Louisville' },
      'LEXINGTON': { state: 'KY', zip: '40507', normalize: 'Lexington' },
      'BOWLING GREEN': { state: 'KY', zip: '42101', normalize: 'Bowling Green' },

      // === LOUISIANA ===
      'BATON ROUGE': { state: 'LA', zip: '70801', normalize: 'Baton Rouge' },
      'NEW ORLEANS': { state: 'LA', zip: '70112', normalize: 'New Orleans' },
      'SHREVEPORT': { state: 'LA', zip: '71101', normalize: 'Shreveport' },
      'LAFAYETTE': { state: 'LA', zip: '70501', normalize: 'Lafayette' },

      // === MAINE ===
      'AUGUSTA ME': { state: 'ME', zip: '04330', normalize: 'Augusta' },
      'PORTLAND ME': { state: 'ME', zip: '04101', normalize: 'Portland' },
      'BANGOR': { state: 'ME', zip: '04401', normalize: 'Bangor' },

      // === MARYLAND ===
      'ANNAPOLIS': { state: 'MD', zip: '21401', normalize: 'Annapolis' },
      'BALTIMORE': { state: 'MD', zip: '21202', normalize: 'Baltimore' },
      'FREDERICK': { state: 'MD', zip: '21701', normalize: 'Frederick' },
      'ROCKVILLE': { state: 'MD', zip: '20850', normalize: 'Rockville' },
      'SILVER SPRING': { state: 'MD', zip: '20901', normalize: 'Silver Spring' },

      // === MASSACHUSETTS ===
      'BOSTON': { state: 'MA', zip: '02101', normalize: 'Boston' },
      'WORCESTER': { state: 'MA', zip: '01601', normalize: 'Worcester' },
      'CAMBRIDGE': { state: 'MA', zip: '02139', normalize: 'Cambridge' },
      'LOWELL': { state: 'MA', zip: '01851', normalize: 'Lowell' },

      // === MICHIGAN ===
      'LANSING': { state: 'MI', zip: '48933', normalize: 'Lansing' },
      'DETROIT': { state: 'MI', zip: '48226', normalize: 'Detroit' },
      'GRAND RAPIDS': { state: 'MI', zip: '49503', normalize: 'Grand Rapids' },
      'WARREN': { state: 'MI', zip: '48089', normalize: 'Warren' },
      'ANN ARBOR': { state: 'MI', zip: '48104', normalize: 'Ann Arbor' },

      // === MINNESOTA ===
      'SAINT PAUL': { state: 'MN', zip: '55101', normalize: 'Saint Paul' },
      'ST PAUL': { state: 'MN', zip: '55101', normalize: 'Saint Paul' },
      'MINNEAPOLIS': { state: 'MN', zip: '55401', normalize: 'Minneapolis' },
      'ROCHESTER MN': { state: 'MN', zip: '55901', normalize: 'Rochester' },
      'DULUTH': { state: 'MN', zip: '55802', normalize: 'Duluth' },

      // === MISSISSIPPI ===
      'JACKSON MS': { state: 'MS', zip: '39201', normalize: 'Jackson' },
      'GULFPORT': { state: 'MS', zip: '39501', normalize: 'Gulfport' },
      'BILOXI': { state: 'MS', zip: '39530', normalize: 'Biloxi' },
      'HATTIESBURG': { state: 'MS', zip: '39401', normalize: 'Hattiesburg' },

      // === MISSOURI ===
      'JEFFERSON CITY': { state: 'MO', zip: '65101', normalize: 'Jefferson City' },
      'KANSAS CITY': { state: 'MO', zip: '64106', normalize: 'Kansas City' },
      'SAINT LOUIS': { state: 'MO', zip: '63101', normalize: 'Saint Louis' },
      'ST LOUIS': { state: 'MO', zip: '63101', normalize: 'Saint Louis' },

      // === MONTANA ===
      'HELENA': { state: 'MT', zip: '59601', normalize: 'Helena' },
      'BILLINGS': { state: 'MT', zip: '59101', normalize: 'Billings' },
      'MISSOULA': { state: 'MT', zip: '59801', normalize: 'Missoula' },
      'GREAT FALLS': { state: 'MT', zip: '59401', normalize: 'Great Falls' },

      // === NEBRASKA ===
      'LINCOLN NE': { state: 'NE', zip: '68508', normalize: 'Lincoln' },
      'OMAHA': { state: 'NE', zip: '68102', normalize: 'Omaha' },
      'BELLEVUE NE': { state: 'NE', zip: '68005', normalize: 'Bellevue' },

      // === NEVADA ===
      'CARSON CITY': { state: 'NV', zip: '89701', normalize: 'Carson City' },
      'LAS VEGAS': { state: 'NV', zip: '89101', normalize: 'Las Vegas' },
      'HENDERSON': { state: 'NV', zip: '89002', normalize: 'Henderson' },
      'RENO': { state: 'NV', zip: '89501', normalize: 'Reno' },
      'NORTH LAS VEGAS': { state: 'NV', zip: '89030', normalize: 'North Las Vegas' },

      // === NEW HAMPSHIRE ===
      'CONCORD NH': { state: 'NH', zip: '03301', normalize: 'Concord' },
      'MANCHESTER NH': { state: 'NH', zip: '03101', normalize: 'Manchester' },
      'NASHUA': { state: 'NH', zip: '03060', normalize: 'Nashua' },

      // === NEW JERSEY ===
      'TRENTON': { state: 'NJ', zip: '08608', normalize: 'Trenton' },
      'NEWARK NJ': { state: 'NJ', zip: '07102', normalize: 'Newark' },
      'JERSEY CITY': { state: 'NJ', zip: '07302', normalize: 'Jersey City' },
      'PATERSON': { state: 'NJ', zip: '07501', normalize: 'Paterson' },
      'ELIZABETH': { state: 'NJ', zip: '07201', normalize: 'Elizabeth' },

      // === NEW MEXICO ===
      'SANTA FE': { state: 'NM', zip: '87501', normalize: 'Santa Fe' },
      'ALBUQUERQUE': { state: 'NM', zip: '87101', normalize: 'Albuquerque' },
      'LAS CRUCES': { state: 'NM', zip: '88001', normalize: 'Las Cruces' },
      'RIO RANCHO': { state: 'NM', zip: '87124', normalize: 'Rio Rancho' },

      // === NEW YORK ===
      'ALBANY': { state: 'NY', zip: '12207', normalize: 'Albany' },
      'NEW YORK': { state: 'NY', zip: '10001', normalize: 'New York' },
      'NEW YORK CITY': { state: 'NY', zip: '10001', normalize: 'New York' },
      'BUFFALO': { state: 'NY', zip: '14202', normalize: 'Buffalo' },
      'ROCHESTER': { state: 'NY', zip: '14604', normalize: 'Rochester' },
      'YONKERS': { state: 'NY', zip: '10701', normalize: 'Yonkers' },
      'SYRACUSE': { state: 'NY', zip: '13202', normalize: 'Syracuse' },

      // === NORTH CAROLINA ===
      'RALEIGH': { state: 'NC', zip: '27601', normalize: 'Raleigh' },
      'CHARLOTTE': { state: 'NC', zip: '28202', normalize: 'Charlotte' },
      'GREENSBORO': { state: 'NC', zip: '27401', normalize: 'Greensboro' },
      'DURHAM': { state: 'NC', zip: '27701', normalize: 'Durham' },
      'WINSTON SALEM': { state: 'NC', zip: '27101', normalize: 'Winston-Salem' },
      'WINSTON-SALEM': { state: 'NC', zip: '27101', normalize: 'Winston-Salem' },
      'FAYETTEVILLE NC': { state: 'NC', zip: '28301', normalize: 'Fayetteville' },
      'CARY': { state: 'NC', zip: '27511', normalize: 'Cary' },

      // === NORTH DAKOTA ===
      'BISMARCK': { state: 'ND', zip: '58501', normalize: 'Bismarck' },
      'FARGO': { state: 'ND', zip: '58102', normalize: 'Fargo' },
      'GRAND FORKS': { state: 'ND', zip: '58201', normalize: 'Grand Forks' },

      // === OHIO ===
      'COLUMBUS OH': { state: 'OH', zip: '43215', normalize: 'Columbus' },
      'CLEVELAND': { state: 'OH', zip: '44114', normalize: 'Cleveland' },
      'CINCINNATI': { state: 'OH', zip: '45202', normalize: 'Cincinnati' },
      'TOLEDO': { state: 'OH', zip: '43604', normalize: 'Toledo' },
      'AKRON': { state: 'OH', zip: '44308', normalize: 'Akron' },
      'DAYTON': { state: 'OH', zip: '45402', normalize: 'Dayton' },

      // === OKLAHOMA ===
      'OKLAHOMA CITY': { state: 'OK', zip: '73102', normalize: 'Oklahoma City' },
      'TULSA': { state: 'OK', zip: '74103', normalize: 'Tulsa' },
      'NORMAN': { state: 'OK', zip: '73069', normalize: 'Norman' },
      'BROKEN ARROW': { state: 'OK', zip: '74012', normalize: 'Broken Arrow' },

      // === OREGON ===
      'SALEM OR': { state: 'OR', zip: '97301', normalize: 'Salem' },
      'PORTLAND OR': { state: 'OR', zip: '97201', normalize: 'Portland' },
      'EUGENE': { state: 'OR', zip: '97401', normalize: 'Eugene' },
      'BEND': { state: 'OR', zip: '97701', normalize: 'Bend' },

      // === PENNSYLVANIA ===
      'HARRISBURG': { state: 'PA', zip: '17101', normalize: 'Harrisburg' },
      'PHILADELPHIA': { state: 'PA', zip: '19102', normalize: 'Philadelphia' },
      'PITTSBURGH': { state: 'PA', zip: '15222', normalize: 'Pittsburgh' },
      'ALLENTOWN': { state: 'PA', zip: '18101', normalize: 'Allentown' },
      'ERIE': { state: 'PA', zip: '16501', normalize: 'Erie' },

      // === RHODE ISLAND ===
      'PROVIDENCE': { state: 'RI', zip: '02903', normalize: 'Providence' },
      'WARWICK': { state: 'RI', zip: '02886', normalize: 'Warwick' },
      'CRANSTON': { state: 'RI', zip: '02910', normalize: 'Cranston' },

      // === SOUTH CAROLINA ===
      'COLUMBIA SC': { state: 'SC', zip: '29201', normalize: 'Columbia' },
      'CHARLESTON': { state: 'SC', zip: '29401', normalize: 'Charleston' },
      'NORTH CHARLESTON': { state: 'SC', zip: '29405', normalize: 'North Charleston' },
      'GREENVILLE SC': { state: 'SC', zip: '29601', normalize: 'Greenville' },
      'MYRTLE BEACH': { state: 'SC', zip: '29577', normalize: 'Myrtle Beach' },

      // === SOUTH DAKOTA ===
      'PIERRE': { state: 'SD', zip: '57501', normalize: 'Pierre' },
      'SIOUX FALLS': { state: 'SD', zip: '57104', normalize: 'Sioux Falls' },
      'RAPID CITY': { state: 'SD', zip: '57701', normalize: 'Rapid City' },

      // === TENNESSEE ===
      'NASHVILLE': { state: 'TN', zip: '37201', normalize: 'Nashville' },
      'MEMPHIS': { state: 'TN', zip: '38103', normalize: 'Memphis' },
      'KNOXVILLE': { state: 'TN', zip: '37902', normalize: 'Knoxville' },
      'CHATTANOOGA': { state: 'TN', zip: '37402', normalize: 'Chattanooga' },
      'MURFREESBORO': { state: 'TN', zip: '37130', normalize: 'Murfreesboro' },

      // === TEXAS ===
      'AUSTIN': { state: 'TX', zip: '78701', normalize: 'Austin' },
      'HOUSTON': { state: 'TX', zip: '77001', normalize: 'Houston' },
      'SAN ANTONIO': { state: 'TX', zip: '78205', normalize: 'San Antonio' },
      'DALLAS': { state: 'TX', zip: '75201', normalize: 'Dallas' },
      'FORT WORTH': { state: 'TX', zip: '76102', normalize: 'Fort Worth' },
      'FT WORTH': { state: 'TX', zip: '76102', normalize: 'Fort Worth' },
      'EL PASO': { state: 'TX', zip: '79901', normalize: 'El Paso' },
      'ARLINGTON TX': { state: 'TX', zip: '76010', normalize: 'Arlington' },
      'PLANO': { state: 'TX', zip: '75023', normalize: 'Plano' },
      'FRISCO': { state: 'TX', zip: '75034', normalize: 'Frisco' },
      'MCKINNEY': { state: 'TX', zip: '75069', normalize: 'McKinney' },
      'CORPUS CHRISTI': { state: 'TX', zip: '78401', normalize: 'Corpus Christi' },

      // === UTAH ===
      'SALT LAKE CITY': { state: 'UT', zip: '84101', normalize: 'Salt Lake City' },
      'WEST VALLEY CITY': { state: 'UT', zip: '84119', normalize: 'West Valley City' },
      'PROVO': { state: 'UT', zip: '84601', normalize: 'Provo' },
      'WEST JORDAN': { state: 'UT', zip: '84084', normalize: 'West Jordan' },
      'OREM': { state: 'UT', zip: '84057', normalize: 'Orem' },
      'SANDY UT': { state: 'UT', zip: '84070', normalize: 'Sandy' },
      'ST GEORGE': { state: 'UT', zip: '84770', normalize: 'St. George' },

      // === VERMONT ===
      'MONTPELIER': { state: 'VT', zip: '05602', normalize: 'Montpelier' },
      'BURLINGTON VT': { state: 'VT', zip: '05401', normalize: 'Burlington' },
      'SOUTH BURLINGTON': { state: 'VT', zip: '05403', normalize: 'South Burlington' },

      // === VIRGINIA ===
      'RICHMOND': { state: 'VA', zip: '23219', normalize: 'Richmond' },
      'VIRGINIA BEACH': { state: 'VA', zip: '23451', normalize: 'Virginia Beach' },
      'NORFOLK': { state: 'VA', zip: '23510', normalize: 'Norfolk' },
      'CHESAPEAKE': { state: 'VA', zip: '23320', normalize: 'Chesapeake' },
      'ARLINGTON VA': { state: 'VA', zip: '22201', normalize: 'Arlington' },
      'ALEXANDRIA': { state: 'VA', zip: '22314', normalize: 'Alexandria' },

      // === WASHINGTON ===
      'OLYMPIA': { state: 'WA', zip: '98501', normalize: 'Olympia' },
      'SEATTLE': { state: 'WA', zip: '98101', normalize: 'Seattle' },
      'SPOKANE': { state: 'WA', zip: '99201', normalize: 'Spokane' },
      'TACOMA': { state: 'WA', zip: '98402', normalize: 'Tacoma' },
      'VANCOUVER WA': { state: 'WA', zip: '98660', normalize: 'Vancouver' },
      'BELLEVUE WA': { state: 'WA', zip: '98004', normalize: 'Bellevue' },

      // === WEST VIRGINIA ===
      'CHARLESTON WV': { state: 'WV', zip: '25301', normalize: 'Charleston' },
      'HUNTINGTON WV': { state: 'WV', zip: '25701', normalize: 'Huntington' },
      'MORGANTOWN': { state: 'WV', zip: '26505', normalize: 'Morgantown' },

      // === WISCONSIN ===
      'MADISON WI': { state: 'WI', zip: '53703', normalize: 'Madison' },
      'MILWAUKEE': { state: 'WI', zip: '53202', normalize: 'Milwaukee' },
      'GREEN BAY': { state: 'WI', zip: '54301', normalize: 'Green Bay' },
      'KENOSHA': { state: 'WI', zip: '53140', normalize: 'Kenosha' },

      // === WYOMING ===
      'CHEYENNE': { state: 'WY', zip: '82001', normalize: 'Cheyenne' },
      'CASPER': { state: 'WY', zip: '82601', normalize: 'Casper' },
      'LARAMIE': { state: 'WY', zip: '82070', normalize: 'Laramie' },

      // === DISTRICT OF COLUMBIA ===
      'WASHINGTON': { state: 'DC', zip: '20001', normalize: 'Washington' },
      'WASHINGTON DC': { state: 'DC', zip: '20001', normalize: 'Washington' }
    };
    const MULTI_STATE_CITIES = new Set(['BOWLING GREEN', 'DOVER', 'OAKLAND', 'GULFPORT']);
    const knownCities = Object.keys(cityLookup).sort((a, b) => b.length - a.length);
    const knownCityPatterns = knownCities.map(c => ({
      name: c,
      pattern: new RegExp('\\b' + c.replace(/\s+/g, '\\s+') + '\\b', 'i')
    }));

    // State abbreviations
    const stateMap = {
      'ALABAMA': 'AL', 'ALASKA': 'AK', 'ARIZONA': 'AZ', 'ARKANSAS': 'AR',
      'CALIFORNIA': 'CA', 'COLORADO': 'CO', 'CONNECTICUT': 'CT', 'DELAWARE': 'DE',
      'FLORIDA': 'FL', 'GEORGIA': 'GA', 'HAWAII': 'HI', 'IDAHO': 'ID',
      'ILLINOIS': 'IL', 'INDIANA': 'IN', 'IOWA': 'IA', 'KANSAS': 'KS',
      'KENTUCKY': 'KY', 'LOUISIANA': 'LA', 'MAINE': 'ME', 'MARYLAND': 'MD',
      'MASSACHUSETTS': 'MA', 'MICHIGAN': 'MI', 'MINNESOTA': 'MN', 'MISSISSIPPI': 'MS',
      'MISSOURI': 'MO', 'MONTANA': 'MT', 'NEBRASKA': 'NE', 'NEVADA': 'NV',
      'NEW HAMPSHIRE': 'NH', 'NEW JERSEY': 'NJ', 'NEW MEXICO': 'NM', 'NEW YORK': 'NY',
      'NORTH CAROLINA': 'NC', 'NORTH DAKOTA': 'ND', 'OHIO': 'OH', 'OKLAHOMA': 'OK',
      'OREGON': 'OR', 'PENNSYLVANIA': 'PA', 'RHODE ISLAND': 'RI', 'SOUTH CAROLINA': 'SC',
      'SOUTH DAKOTA': 'SD', 'TENNESSEE': 'TN', 'TEXAS': 'TX', 'UTAH': 'UT',
      'VERMONT': 'VT', 'VIRGINIA': 'VA', 'WASHINGTON': 'WA', 'WEST VIRGINIA': 'WV',
      'WISCONSIN': 'WI', 'WYOMING': 'WY', 'DISTRICT OF COLUMBIA': 'DC'
    };

    // Initialize
    document.getElementById('excludeList').value = excludeAddresses.join('\n');
    document.getElementById('excludeCount').textContent = `${excludeAddresses.length} addresses`;
    renderHistory();
    renderSavedPresets();
    renderMailedList();
    updateMailedBadge();

    // Tab switching
    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.secondary-panel').forEach(p => p.classList.remove('active'));
      document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
      document.getElementById('tab-' + tabId).classList.add('active');
    }

    // Section toggle
    function toggleSection(el) {
      el.parentElement.classList.toggle('collapsed');
    }

    // Toast
    let _toastTimer = null;
    function showToast(msg, durationOrType) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.display = 'block';
      // Support both duration (number) and type string ('error', 'success')
      let duration;
      if (typeof durationOrType === 'string') {
        toast.style.borderColor = durationOrType === 'error' ? 'var(--red)' : 'var(--green)';
        duration = TOAST_DURATION_MS;
      } else {
        toast.style.borderColor = '';
        duration = durationOrType;
      }
      if (_toastTimer) clearTimeout(_toastTimer);
      if (duration !== 0) _toastTimer = setTimeout(() => toast.style.display = 'none', duration || TOAST_DURATION_MS);
    }

    // File handling
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      // Check if it's multiple files (folder drop)
      if (e.dataTransfer.files.length > 1) {
        handleFolderFiles(e.dataTransfer.files);
      } else if (e.dataTransfer.files[0]) {
        handleFile(e.dataTransfer.files[0]);
      }
    });
    fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

    // Folder upload handler
    document.getElementById('folderInput').addEventListener('change', e => {
      if (e.target.files.length > 0) handleFolderFiles(e.target.files);
    });

    // Handle multiple files from folder upload
    function handleFolderFiles(files) {
      const fileList = Array.from(files);
      const csvFiles = fileList.filter(f => f.name.toLowerCase().endsWith('.csv') || f.name.toLowerCase().endsWith('.txt'));

      if (csvFiles.length === 0) {
        showToast('No CSV files found in folder');
        return;
      }

      // Pattern matching for file types
      const patterns = {
        main: /(parcel|property|owner|tax|nal)/i,
        sales: /(sale|sold|transfer|deed)/i,
        features: /(feature|extra|xf|improvement|pool)/i,
        subdiv: /(subdiv|plat|neighborhood|legal)/i
      };

      let mainFile = null, salesFile = null, featuresFile = null, subdivFile = null;

      // First pass: exact name matches
      for (const file of csvFiles) {
        const name = file.name.toLowerCase();
        if (name.includes('parcel') || name.includes('nal.') || name === 'parcels.csv') mainFile = file;
        else if (name.includes('allsale') || name.includes('sales.csv') || name.includes('salesqual')) salesFile = file;
        else if (name.includes('extrafeature') || name.includes('xfcode') || name.includes('feature')) featuresFile = file;
        else if (name.includes('subdiv') || name.includes('subdivision')) subdivFile = file;
      }

      // Second pass: pattern matching for unmatched
      for (const file of csvFiles) {
        if (!mainFile && patterns.main.test(file.name)) mainFile = file;
        else if (!salesFile && patterns.sales.test(file.name)) salesFile = file;
        else if (!featuresFile && patterns.features.test(file.name)) featuresFile = file;
        else if (!subdivFile && patterns.subdiv.test(file.name)) subdivFile = file;
      }

      // If still no main file, use largest CSV
      if (!mainFile) {
        mainFile = csvFiles.reduce((a, b) => a.size > b.size ? a : b);
      }

      // Show detected files
      const folderInfo = document.getElementById('folderFilesInfo');
      let infoHtml = '<strong>Detected Files:</strong><br>';
      infoHtml += `üìÑ Main: ${mainFile ? escapeHtml(mainFile.name) : '<span style="color:var(--red)">Not found</span>'}<br>`;
      infoHtml += `üìä Sales: ${salesFile ? escapeHtml(salesFile.name) : '<span style="color:var(--text-dim)">-</span>'}<br>`;
      infoHtml += `üèä Features: ${featuresFile ? escapeHtml(featuresFile.name) : '<span style="color:var(--text-dim)">-</span>'}<br>`;
      infoHtml += `üèòÔ∏è Subdivisions: ${subdivFile ? escapeHtml(subdivFile.name) : '<span style="color:var(--text-dim)">-</span>'}`;
      folderInfo.innerHTML = infoHtml;
      folderInfo.style.display = 'block';

      // Load main file first
      if (mainFile) {
        handleFile(mainFile);
        dropZone.classList.add('has-file');
        fileInfo.innerHTML = `<strong>${escapeHtml(mainFile.name)}</strong> (${(mainFile.size / 1024).toFixed(1)} KB)`;
      }

      // Load lookup files after a short delay to let main file process
      setTimeout(() => {
        if (salesFile) handleLookupFile(salesFile, 'sales');
        if (featuresFile) handleLookupFile(featuresFile, 'features');
        if (subdivFile) handleLookupFile(subdivFile, 'subdiv');
        showToast(`Loaded ${[mainFile, salesFile, featuresFile, subdivFile].filter(Boolean).length} files from folder`);
      }, 500);
    }

    // Lookup file handlers
    document.getElementById('salesFileInput').addEventListener('change', e => { if (e.target.files[0]) handleLookupFile(e.target.files[0], 'sales'); });
    document.getElementById('featuresFileInput').addEventListener('change', e => { if (e.target.files[0]) handleLookupFile(e.target.files[0], 'features'); });
    document.getElementById('subdivFileInput').addEventListener('change', e => { if (e.target.files[0]) handleLookupFile(e.target.files[0], 'subdiv'); });

    function handleLookupFile(file, type) {
      const reader = new FileReader();
      reader.onload = e => {
        const content = e.target.result;
        const lines = content.split(/\r?\n/).filter(l => l.trim());
        if (lines.length < 2) return;

        const delim = lines[0].includes('\t') ? '\t' : ',';
        const headers = parseCSVLine(lines[0], delim).map(h => h.toUpperCase().replace(/[^A-Z0-9]/g, ''));

        // Find key column (PARCELID, PARCEL_ID, PARID, etc.)
        const keyIdx = headers.findIndex(h => ['PARCELID', 'PARCEL', 'PARID', 'ID', 'ACCOUNTNO', 'ACCT'].includes(h));
        if (keyIdx === -1) {
          showToast('Could not find parcel ID column in ' + file.name);
          return;
        }

        let count = 0;
        if (type === 'sales') {
          salesLookup = {};
          const saleDateIdx = headers.findIndex(h => h.includes('SALEDATE') || h.includes('SALEDT') || h === 'QUALDATE');
          const salePriceIdx = headers.findIndex(h => h.includes('SALEPRICE') || h.includes('SALEAMT') || h === 'PRICE');
          const saleQualIdx = headers.findIndex(h => h.includes('QUAL') || h.includes('SALEQUAL'));

          for (let i = 1; i < lines.length; i++) {
            const row = parseCSVLine(lines[i], delim);
            const key = (row[keyIdx] || '').trim().toUpperCase();
            if (!key) continue;
            salesLookup[key] = {
              saleDate: saleDateIdx >= 0 ? row[saleDateIdx] : '',
              salePrice: salePriceIdx >= 0 ? row[salePriceIdx] : '',
              saleQual: saleQualIdx >= 0 ? row[saleQualIdx] : ''
            };
            count++;
          }
          document.getElementById('salesFileStatus').textContent = `(${count.toLocaleString()})`;
          document.getElementById('salesFileStatus').style.color = 'var(--green)';
        }
        else if (type === 'features') {
          featuresLookup = {};
          const codeIdx = headers.findIndex(h => h.includes('CODE') || h.includes('XFCODE') || h.includes('FEATURE'));
          const descIdx = headers.findIndex(h => h.includes('DESC') || h.includes('DESCRIPTION'));
          const poolKeyword = (document.getElementById('poolFilterKeyword').value || 'POOL').toUpperCase();

          for (let i = 1; i < lines.length; i++) {
            const row = parseCSVLine(lines[i], delim);
            const key = (row[keyIdx] || '').trim().toUpperCase();
            if (!key) continue;
            const code = codeIdx >= 0 ? (row[codeIdx] || '').toUpperCase() : '';
            const desc = descIdx >= 0 ? (row[descIdx] || '').toUpperCase() : '';
            const isPool = code.includes(poolKeyword) || desc.includes(poolKeyword);

            if (!featuresLookup[key]) featuresLookup[key] = { hasPool: false, features: [] };
            if (isPool) featuresLookup[key].hasPool = true;
            featuresLookup[key].features.push(code || desc);
            count++;
          }
          const poolCount = Object.values(featuresLookup).filter(f => f.hasPool).length;
          document.getElementById('featuresFileStatus').textContent = `(${poolCount.toLocaleString()} pools)`;
          document.getElementById('featuresFileStatus').style.color = 'var(--green)';
        }
        else if (type === 'subdiv') {
          subdivLookup = {};
          const subdivIdx = headers.findIndex(h => h.includes('SUBDIV') || h.includes('SUBDIVISION') || h.includes('SUBNAME'));
          const neighborIdx = headers.findIndex(h => h.includes('NEIGHBOR') || h.includes('HOOD') || h.includes('AREA'));

          for (let i = 1; i < lines.length; i++) {
            const row = parseCSVLine(lines[i], delim);
            const key = (row[keyIdx] || '').trim().toUpperCase();
            if (!key) continue;
            subdivLookup[key] = {
              subdivision: subdivIdx >= 0 ? (row[subdivIdx] || '').trim() : '',
              neighborhood: neighborIdx >= 0 ? (row[neighborIdx] || '').trim() : ''
            };
            count++;
          }
          document.getElementById('subdivFileStatus').textContent = `(${count.toLocaleString()})`;
          document.getElementById('subdivFileStatus').style.color = 'var(--green)';
        }

        showToast(`Loaded ${count.toLocaleString()} records from ${file.name}`);
      };
      reader.readAsText(file);
    }

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = e => {
        fileContent = e.target.result;
        dropZone.classList.add('has-file');
        fileInfo.innerHTML = `<strong>${escapeHtml(file.name)}</strong> (${(file.size / 1024).toFixed(1)} KB)`;
        parseFile();
      };
      reader.readAsText(file);
    }

    function parseFile() {
      if (!fileContent) return;
      const lines = fileContent.split(/\r?\n/).filter(l => l.trim());
      if (lines.length === 0) return;

      // Detect delimiter
      const firstLine = lines[0];
      if (firstLine.includes('~')) detectedDelimiter = '~';
      else if (firstLine.includes('\t')) detectedDelimiter = '\t';
      else detectedDelimiter = ',';

      headers = parseCSVLine(lines[0], detectedDelimiter);
      parsedRows = [];

      for (let i = 1; i < lines.length; i++) {
        const row = parseCSVLine(lines[i], detectedDelimiter);
        if (row.length > 0) parsedRows.push(row);
      }

      // First populate the dropdowns
      populateMappers();

      // Then auto-detect format and map columns
      let detectedFormat = 'Unknown';
      const headerUpper = headers.map(h => h.toUpperCase());

      // Detect NAL format (has OWN_NAME, CO_NO, PARCEL_ID columns)
      if (headerUpper.includes('OWN_NAME') && headerUpper.includes('CO_NO')) {
        detectedFormat = 'County NAL';
        autoMapNAL();
      }
      // Detect parcel format with Pool column
      else if (headers.some(h => h.toUpperCase().includes('POOL'))) {
        detectedFormat = 'Parcel Export';
        autoMapByName();
      }
      // Detect tilde-delimited county export
      else if (detectedDelimiter === '~' && headers.length > 30) {
        detectedFormat = 'County Export';
        autoMapByIndex();
      }
      // Generic auto-detection for any CSV
      else {
        detectedFormat = 'Auto-Detected';
        autoMapGeneric();
      }

      // Count how many columns were mapped
      const mappedCount = countMappedColumns();
      const requiredMapped = checkRequiredMapped();

      let statusHtml = `<strong>Format:</strong> ${detectedFormat} | <strong>Rows:</strong> ${parsedRows.length.toLocaleString()} | <strong>Cols:</strong> ${headers.length}`;
      statusHtml += ` | <strong>Mapped:</strong> ${mappedCount} columns`;
      if (requiredMapped) {
        statusHtml += ' | <span style="color:var(--green)">‚úì Ready to process</span>';
      }
      document.getElementById('detectedInfo').innerHTML = statusHtml;
      document.getElementById('detectedInfo').style.display = 'block';

      // Restore last used filter settings
      restoreFilterSettings();

      document.getElementById('mapperSection').style.display = 'block';
      document.getElementById('lookupSection').style.display = 'block';

      // Auto-collapse mapper if format was recognized (not Unknown)
      if (detectedFormat !== 'Unknown' && requiredMapped) {
        document.getElementById('mapperSection').classList.add('collapsed');
        document.getElementById('mapperBanner').innerHTML = `<span style="color:var(--green);">‚úì ${detectedFormat}</span> ‚Äî ${mappedCount} columns mapped. <span style="color:var(--green); font-weight:600;">Ready to process</span> <a href="#" onclick="event.preventDefault(); document.getElementById('mapperSection').classList.remove('collapsed'); this.parentElement.style.display='none';" style="color:var(--accent); margin-left:8px;">Customize</a>`;
        document.getElementById('mapperBanner').style.display = 'block';
      } else {
        document.getElementById('mapperBanner').style.display = 'none';
      }

      // Populate main key column selector for lookup joins and auto-select parcel ID
      const keySelect = document.getElementById('mainKeyCol');
      keySelect.innerHTML = '<option value="-1">--</option>';
      let foundKeyIdx = -1;
      headers.forEach((h, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = h.substring(0, 25);
        keySelect.appendChild(opt);

        // Auto-detect parcel ID column (check various naming patterns)
        if (foundKeyIdx === -1) {
          const upper = h.toUpperCase().replace(/[^A-Z0-9]/g, '');
          const isParcelId = upper === 'PARCELID' || upper === 'PARCEL' || upper === 'PARID' ||
            upper === 'PARCELNUMBER' || upper === 'PARCELNO' || upper === 'PARCELNUM' ||
            upper === 'ACCOUNTNO' || upper === 'ACCOUNTNUMBER' || upper === 'ACCTNO' ||
            upper === 'FOESSION' || upper === 'APN' || upper === 'PIN' ||
            upper.includes('PARCELID') || upper.includes('PARID') ||
            (upper.includes('PARCEL') && upper.includes('ID')) ||
            (upper.includes('PARCEL') && upper.includes('NO')) ||
            (upper.includes('ACCOUNT') && upper.includes('NO'));
          if (isParcelId) {
            foundKeyIdx = i;
          }
        }
      });

      // Set the auto-detected key column
      if (foundKeyIdx !== -1) {
        keySelect.value = foundKeyIdx;
        document.getElementById('lookupKeyConfig').style.display = 'block';
      }

      processBtn.disabled = false;
      updateSamplePreview();
    }

    function parseCSVLine(line, delimiter) {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === delimiter && !inQuotes) { result.push(current.trim()); current = ''; }
        else current += char;
      }
      result.push(current.trim());
      return result;
    }

    function populateMappers() {
      const selects = ['mapName', 'mapAddress1', 'mapAddress2', 'mapCity', 'mapState', 'mapZip', 'mapFilter', 'mapFilterZip', 'mapValue', 'mapYearBuilt', 'mapPropAddress', 'mapPropCity', 'mapPropState', 'mapPropType', 'mapAssessedValue', 'mapSaleDate', 'mapSubdivision', 'mapLotSize', 'mapLivingArea'];
      selects.forEach(id => {
        const select = document.getElementById(id);
        const val = select.value;
        select.innerHTML = '<option value="-1">--</option>';
        headers.forEach((h, i) => {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = h.substring(0, 25);
          select.appendChild(opt);
        });
        select.value = val;
      });
    }

    function autoMapByName() {
      // Map column names to their index
      const colMap = {};
      headers.forEach((h, i) => { colMap[h.toUpperCase().replace(/[^A-Z]/g, '')] = i; });

      // Direct mappings for Seminole County format
      const mappings = {
        mapName: ['OWNERNAME', 'OWNNAME', 'NAME', 'OWNER', 'OWNNM', 'OWNERNM'],
        mapAddress1: ['MAILINGADDRESS', 'MAILADDRESS', 'ADDRESS', 'STREETADDRESS', 'STREET', 'ADDRESS1', 'ADDR', 'ADDR1', 'OWNERADDRESS', 'OWNADDR', 'MAILADDR', 'MAILINGADDR'],
        mapCity: ['MAILINGCITY', 'MAILCITY', 'CITY', 'OWNERCITY', 'OWNCITY', 'MAILCTY', 'CTY'],
        mapState: ['MAILINGSTATE', 'MAILSTATE', 'STATE', 'OWNERSTATE', 'OWNSTATE', 'MAILST', 'ST'],
        mapZip: ['MAILINGZIP', 'MAILZIP', 'ZIP', 'ZIPCODE', 'POSTALCODE', 'OWNERZIP', 'OWNZIP', 'MAILZIPCODE', 'ZIPCD'],
        mapPropAddress: ['PRIMARYADDRESS', 'SITEADDRESS', 'PROPERTYADDRESS', 'PROPADDRESS', 'PHYSICALADDRESS', 'LOCADDRESS', 'SITEADDR', 'PROPADDR'],
        mapPropCity: ['SITECITY', 'PRIMARYCITY', 'PROPERTYCITY', 'PHYSICALCITY', 'LOCCITY', 'SITECTY', 'PROPCITY'],
        mapPropState: ['SITESTATE', 'PRIMARYSTATE', 'PROPERTYSTATE', 'PHYSICALSTATE', 'LOCSTATE', 'SITEST', 'PROPSTATE'],
        mapFilterZip: ['SITEZIP', 'PRIMARYZIP', 'PROPERTYZIP', 'PHYSICALZIP', 'LOCZIP', 'PROPZIP', 'SITEZIPCODE'],
        mapPropType: ['DORCODE', 'DOR', 'DORUC', 'USECODE', 'PROPERTYUSE', 'PROPTYPE', 'LANDUSE', 'PROPCLASS'],
        mapYearBuilt: ['YEARBUILT', 'YRBUILT', 'YRBLT', 'ACTUALYEARBUILT', 'ACTYRBLT', 'EFFYRBLT'],
        mapValue: ['TOTALJUSTVALUE', 'JUSTVALUE', 'TOTALVALUE', 'VALUE', 'MARKETVALUE', 'JV', 'TOTALMARKETVALUE'],
        mapAssessedValue: ['ASSESSEDVALUE', 'ASSESSED', 'AV', 'TOTALASSESSED'],
        mapFilter: ['POOL', 'HASPOOL', 'POOLIND', 'SWIMMINGPOOL'],
        mapSubdivision: ['SUBDIVISION', 'SUBDIV', 'SUBDIVISIONNAME', 'SUBNAME', 'LEGAL', 'LEGALSUBDIV'],
        mapLotSize: ['LANDSQFT', 'LAND_SQFT', 'LOTSIZE', 'LOT_SIZE', 'LOTSQFT', 'LOT_SQFT', 'LANDAREA', 'LAND_AREA', 'NO_LAND_UNITS'],
        mapLivingArea: ['TOT_LVG_AREA', 'TOTLVGAREA', 'HEATEDAREA', 'HEATED_AREA', 'LIVINGSQFT', 'LIVING_SQFT', 'LIVINGAREA', 'LIVING_AREA', 'BLDG_SQFT'],
        mainKeyCol: ['PARCELID', 'PARID', 'PARCEL', 'PARCELNUMBER', 'ACCOUNTNO', 'ACCTNO', 'APN', 'FOESSION', 'ALTKEY', 'ACCOUNTNUM']
      };

      for (const [selectId, searches] of Object.entries(mappings)) {
        const el = document.getElementById(selectId);
        if (!el) continue;
        for (const search of searches) {
          if (colMap[search] !== undefined) {
            el.value = String(colMap[search]);
            break;
          }
        }
      }

      // Show lookup config if key column was found
      if (document.getElementById('mainKeyCol').value !== '-1') {
        document.getElementById('lookupKeyConfig').style.display = 'block';
      }
    }

    function autoMapByIndex() {
      const indices = { mapName: 21, mapAddress1: 22, mapCity: 23, mapState: 24, mapZip: 25, mapFilter: 39, mapFilterZip: 10, mapValue: 18, mapYearBuilt: 14, mapPropAddress: 4 };
      Object.entries(indices).forEach(([id, idx]) => {
        if (idx < headers.length) document.getElementById(id).value = idx;
      });
    }

    function autoMapNAL() {
      // Map column names to their index for Orange County NAL format
      const colMap = {};
      headers.forEach((h, i) => { colMap[h.toUpperCase()] = i; });

      // Direct mappings for Orange County NAL format
      const mappings = {
        mapName: ['OWN_NAME'],
        mapAddress1: ['OWN_ADDR1'],
        mapAddress2: ['OWN_ADDR2'],
        mapCity: ['OWN_CITY'],
        mapState: ['OWN_STATE'],
        mapZip: ['OWN_ZIPCD'],
        mapPropAddress: ['PHY_ADDR1'],
        mapPropCity: ['PHY_CITY', 'PROP_CITY', 'SITE_CITY'],
        mapPropState: ['PHY_STATE', 'PROP_STATE', 'SITE_STATE'],
        mapFilterZip: ['PHY_ZIPCD'],
        mapPropType: ['DOR_UC', 'PA_UC'],
        mapYearBuilt: ['ACT_YR_BLT', 'EFF_YR_BLT'],
        mapValue: ['JV', 'TV_SD'],
        mapAssessedValue: ['AV_SD', 'AV_NSD'],
        mapFilter: ['S_LEGAL'],  // Pool keywords will be searched in legal description
        mapSaleDate: ['SALE_DATE', 'SALEDT', 'S_DATE', 'SALE_DT', 'LAST_SALE_DATE', 'QUAL_SALE_DATE'],
        mapSubdivision: ['SUBDIVISION', 'SUBDIV', 'S_LEGAL', 'LEGAL_DESC'],
        mapLotSize: ['LAND_SQFT', 'NO_LAND_UNITS'],
        mapLivingArea: ['TOT_LVG_AREA'],
        mainKeyCol: ['PARCEL_ID', 'PARCELID', 'PARID', 'PARCEL', 'CO_NO', 'APN']
      };

      for (const [selectId, searches] of Object.entries(mappings)) {
        const el = document.getElementById(selectId);
        if (!el) continue;
        for (const search of searches) {
          if (colMap[search] !== undefined) {
            el.value = String(colMap[search]);
            break;
          }
        }
      }

      // Show lookup config if key column was found
      if (document.getElementById('mainKeyCol').value !== '-1') {
        document.getElementById('lookupKeyConfig').style.display = 'block';
      }
    }

    // Generic auto-mapper using fuzzy matching for any CSV format
    function autoMapGeneric() {
      const colMap = {};
      headers.forEach((h, i) => {
        // Normalize: uppercase, remove special chars
        colMap[h.toUpperCase().replace(/[^A-Z0-9]/g, '')] = i;
      });

      // Comprehensive mappings with fuzzy patterns
      const mappings = {
        mapName: ['OWNERNAME', 'OWNNAME', 'NAME', 'OWNER', 'OWNNM', 'OWNERNM', 'FULLNAME', 'PROPERTYOWNER', 'TAXPAYER', 'GRANTEE'],
        mapAddress1: ['MAILINGADDRESS', 'MAILADDRESS', 'OWNERADDRESS', 'ADDRESS', 'STREETADDRESS', 'STREET', 'ADDRESS1', 'ADDR', 'ADDR1', 'MAILADDR', 'MAILINGADDR', 'OWNERADDR', 'MAILSTREET'],
        mapAddress2: ['ADDRESS2', 'ADDR2', 'MAILADDR2', 'OWNERADDR2', 'UNIT', 'APT', 'SUITE'],
        mapCity: ['MAILINGCITY', 'MAILCITY', 'OWNERCITY', 'CITY', 'OWNCITY', 'MAILCTY', 'CTY', 'OWNERCTY'],
        mapState: ['MAILINGSTATE', 'MAILSTATE', 'OWNERSTATE', 'STATE', 'OWNSTATE', 'MAILST', 'ST', 'OWNERST'],
        mapZip: ['MAILINGZIP', 'MAILZIP', 'OWNERZIP', 'ZIP', 'ZIPCODE', 'POSTALCODE', 'OWNZIP', 'MAILZIPCODE', 'ZIPCD', 'POSTAL', 'OWNERPOSTAL'],
        mapPropAddress: ['PRIMARYADDRESS', 'SITEADDRESS', 'PROPERTYADDRESS', 'PROPADDRESS', 'PHYSICALADDRESS', 'LOCADDRESS', 'SITEADDR', 'PROPADDR', 'LOCATIONADDRESS', 'PARCELADDRESS', 'STREETADDR'],
        mapPropCity: ['SITECITY', 'PRIMARYCITY', 'PROPERTYCITY', 'PHYSICALCITY', 'LOCCITY', 'SITECTY', 'PROPCITY', 'LOCATIONCITY'],
        mapPropState: ['SITESTATE', 'PRIMARYSTATE', 'PROPERTYSTATE', 'PHYSICALSTATE', 'LOCSTATE', 'SITEST', 'PROPSTATE'],
        mapFilterZip: ['SITEZIP', 'PRIMARYZIP', 'PROPERTYZIP', 'PHYSICALZIP', 'LOCZIP', 'PROPZIP', 'SITEZIPCODE', 'LOCATIONZIP'],
        mapPropType: ['DORCODE', 'DOR', 'DORUC', 'USECODE', 'PROPERTYUSE', 'PROPTYPE', 'LANDUSE', 'PROPCLASS', 'USETYPE', 'LANDUSECODE', 'PROPERTYTYPE', 'ZONING'],
        mapYearBuilt: ['YEARBUILT', 'YRBUILT', 'YRBLT', 'ACTUALYEARBUILT', 'ACTYRBLT', 'EFFYRBLT', 'BUILTYR', 'YEARCONSTRUCT', 'CONSTRUCTIONYEAR'],
        mapValue: ['TOTALJUSTVALUE', 'JUSTVALUE', 'TOTALVALUE', 'VALUE', 'MARKETVALUE', 'JV', 'TOTALMARKETVALUE', 'ASSESSEDVALUE', 'APPRAISEDVALUE', 'TOTALAPPRAISAL', 'LANDVALUE'],
        mapAssessedValue: ['ASSESSEDVALUE', 'ASSESSED', 'AV', 'TOTALASSESSED', 'TAXABLEVALUE'],
        mapFilter: ['POOL', 'HASPOOL', 'POOLIND', 'SWIMMINGPOOL', 'POOLYN', 'LEGAL', 'SLEGAL', 'LEGALDESCRIPTION'],
        mapSubdivision: ['SUBDIVISION', 'SUBDIV', 'SUBDIVISIONNAME', 'SUBNAME', 'LEGAL', 'LEGALSUBDIV', 'PLAT', 'PLATNAME', 'NEIGHBORHOOD', 'NBHD'],
        mapSaleDate: ['SALEDATE', 'SALESDATE', 'LASTSALEDATE', 'DATESOLD', 'SOLDDATE', 'QUALSALEDATE', 'RECORDDATE', 'DEEDDATE'],
        mainKeyCol: ['PARCELID', 'PARID', 'PARCEL', 'PARCELNUMBER', 'ACCOUNTNO', 'ACCTNO', 'APN', 'FOESSION', 'ALTKEY', 'ACCOUNTNUM', 'PIN', 'TAXID', 'PROPERTYID', 'FOLESSION', 'PARCELNUM']
      };

      // Try exact matches first
      for (const [selectId, searches] of Object.entries(mappings)) {
        const el = document.getElementById(selectId);
        if (!el) continue;
        for (const search of searches) {
          if (colMap[search] !== undefined) {
            el.value = String(colMap[search]);
            break;
          }
        }
      }

      // Second pass: fuzzy matching for unmapped fields
      for (const [selectId, searches] of Object.entries(mappings)) {
        const el = document.getElementById(selectId);
        if (!el || el.value !== '-1') continue; // Skip if already mapped

        // Try partial matching
        for (const [normalized, idx] of Object.entries(colMap)) {
          for (const search of searches) {
            if (normalized.includes(search) || search.includes(normalized)) {
              el.value = String(idx);
              break;
            }
          }
          if (el.value !== '-1') break;
        }
      }

      // Show lookup config if key column was found
      if (document.getElementById('mainKeyCol').value !== '-1') {
        document.getElementById('lookupKeyConfig').style.display = 'block';
      }
    }

    // Count how many columns are mapped
    function countMappedColumns() {
      const selects = ['mapName', 'mapAddress1', 'mapCity', 'mapState', 'mapZip', 'mapPropAddress', 'mapValue', 'mapYearBuilt', 'mapPropType', 'mapSubdivision', 'mapSaleDate', 'mainKeyCol'];
      return selects.filter(id => {
        const el = document.getElementById(id);
        return el && el.value !== '-1';
      }).length;
    }

    // Check if minimum required columns are mapped (name + address)
    function checkRequiredMapped() {
      const nameEl = document.getElementById('mapName');
      const addrEl = document.getElementById('mapAddress1');
      const propAddrEl = document.getElementById('mapPropAddress');
      const hasName = nameEl && nameEl.value !== '-1';
      const hasAddr = (addrEl && addrEl.value !== '-1') || (propAddrEl && propAddrEl.value !== '-1');
      return hasName && hasAddr;
    }

    // Save filter settings to localStorage
    function saveFilterSettings() {
      const settings = {
        targetState: document.getElementById('targetState').value,
        removeBiz: document.getElementById('removeBiz').checked,
        allowSFR: document.getElementById('allowSFR').checked,
        allowCondo: document.getElementById('allowCondo').checked,
        allowMulti: document.getElementById('allowMulti').checked,
        allowVacant: document.getElementById('allowVacant').checked,
        allowOther: document.getElementById('allowOther').checked,
        absenteeOnly: document.getElementById('absenteeOnly').checked
      };
      localStorage.setItem('poolscraper_filters', JSON.stringify(settings));
    }

    // Restore filter settings from localStorage
    function restoreFilterSettings() {
      const saved = localStorage.getItem('poolscraper_filters');
      if (!saved) return;
      try {
        const settings = JSON.parse(saved);
        if (settings.targetState) document.getElementById('targetState').value = settings.targetState;
        if (settings.removeBiz !== undefined) document.getElementById('removeBiz').checked = settings.removeBiz;
        if (settings.allowSFR !== undefined) document.getElementById('allowSFR').checked = settings.allowSFR;
        if (settings.allowCondo !== undefined) document.getElementById('allowCondo').checked = settings.allowCondo;
        if (settings.allowMulti !== undefined) document.getElementById('allowMulti').checked = settings.allowMulti;
        if (settings.allowVacant !== undefined) document.getElementById('allowVacant').checked = settings.allowVacant;
        if (settings.allowOther !== undefined) document.getElementById('allowOther').checked = settings.allowOther;
        if (settings.absenteeOnly !== undefined) document.getElementById('absenteeOnly').checked = settings.absenteeOnly;
      } catch (e) { console.warn('[scraper] settings restore:', e.message); }
    }

    function updateSamplePreview() {
      const nameIdx = parseInt(document.getElementById('mapName').value);
      const addr1Idx = parseInt(document.getElementById('mapAddress1').value);
      const cityIdx = parseInt(document.getElementById('mapCity').value);
      const stateIdx = parseInt(document.getElementById('mapState').value);
      const zipIdx = parseInt(document.getElementById('mapZip').value);
      const valueIdx = parseInt(document.getElementById('mapValue').value);
      const yearIdx = parseInt(document.getElementById('mapYearBuilt').value);
      const subdivIdx = parseInt(document.getElementById('mapSubdivision').value);

      // Check if we need to auto-parse addresses (city/state/zip columns not mapped)
      const needsAddressParsing = cityIdx < 0 && stateIdx < 0 && zipIdx < 0;

      const samples = [];
      const startIdx = parsedRows.length > 0 && parsedRows[0].every(c => c === '') ? 1 : 0;

      for (let i = startIdx; i < parsedRows.length && samples.length < 5; i++) {
        const row = parsedRows[i];
        if (!row || row.length < 3) continue;
        const name = nameIdx >= 0 ? (row[nameIdx] || '') : '';
        const addr = addr1Idx >= 0 ? (row[addr1Idx] || '') : '';
        if (!name && !addr) continue;

        let city = '', state = '', zip = '', street = addr;

        // If city/state/zip columns exist, use them
        if (!needsAddressParsing) {
          city = cityIdx >= 0 ? (row[cityIdx] || '') : '';
          state = stateIdx >= 0 ? (row[stateIdx] || '') : '';
          zip = zipIdx >= 0 ? (row[zipIdx] || '') : '';
        } else if (addr) {
          // Try to parse city/state/zip from address field
          const parsed = parseFullAddress(addr);
          if (parsed.city || parsed.state || parsed.zip) {
            street = parsed.street || addr;
            city = parsed.city;
            state = parsed.state;
            zip = parsed.zip;
          }
        }

        samples.push({
          name: toTitleCase(name.replace(/"/g, '').trim()),
          address: toTitleCase(street),
          city: toTitleCase(city),
          state: state.toUpperCase(),
          zip: zip.substring(0, 5),
          value: valueIdx >= 0 ? (row[valueIdx] || '') : '',
          year: yearIdx >= 0 ? (row[yearIdx] || '') : '',
          subdiv: subdivIdx >= 0 ? toTitleCase((row[subdivIdx] || '').substring(0, 20)) : ''
        });
      }

      const tbody = document.getElementById('samplePreviewBody');
      if (samples.length > 0) {
        tbody.innerHTML = samples.map(s => `<tr><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.address)}</td><td>${escapeHtml(s.city)}</td><td>${escapeHtml(s.state)}</td><td>${escapeHtml(s.zip)}</td><td>${escapeHtml(s.value)}</td><td>${escapeHtml(s.year)}</td><td>${escapeHtml(s.subdiv)}</td></tr>`).join('');
        document.getElementById('samplePreviewCard').style.display = 'block';
      } else {
        document.getElementById('samplePreviewCard').style.display = 'none';
      }
    }

    // Add change listeners for mappers
    ['mapName', 'mapAddress1', 'mapAddress2', 'mapCity', 'mapState', 'mapZip', 'mapPropAddress', 'mapPropCity', 'mapPropState', 'mapValue', 'mapYearBuilt', 'mapSubdivision'].forEach(id => {
      document.getElementById(id).addEventListener('change', updateSamplePreview);
    });

    // Show lookup config when key column is selected
    document.getElementById('mainKeyCol').addEventListener('change', function() {
      document.getElementById('lookupKeyConfig').style.display = this.value !== '-1' ? 'block' : 'none';
    });

    // Preset functions
    function saveCurrentPreset() {
      const name = document.getElementById('presetName').value.trim();
      if (!name) { showToast('Enter a preset name'); return; }
      const preset = {};
      ['mapName', 'mapAddress1', 'mapAddress2', 'mapCity', 'mapState', 'mapZip', 'mapFilter', 'mapFilterZip', 'mapValue', 'mapYearBuilt', 'mapPropAddress', 'mapPropCity', 'mapPropState', 'mapPropType', 'mapAssessedValue', 'mapSaleDate', 'mapSubdivision', 'mapLotSize', 'mapLivingArea'].forEach(id => {
        preset[id] = document.getElementById(id).value;
      });
      savedPresets[name] = preset;
      localStorage.setItem('poolscraper_presets', JSON.stringify(savedPresets));
      renderSavedPresets();
      showToast('Preset saved');
    }

    function loadPreset(name) {
      const preset = savedPresets[name];
      if (!preset) return;
      Object.entries(preset).forEach(([id, val]) => {
        const el = document.getElementById(id);
        if (el && val !== undefined) el.value = val;
      });
      updateSamplePreview();
      showToast('Preset loaded');
    }

    function deletePreset(name) {
      delete savedPresets[name];
      localStorage.setItem('poolscraper_presets', JSON.stringify(savedPresets));
      renderSavedPresets();
      showToast('Preset deleted');
    }

    function renderSavedPresets() {
      const container = document.getElementById('savedPresets');
      const keys = Object.keys(savedPresets);
      if (keys.length === 0) {
        container.innerHTML = '<p style="color:var(--text-dim); font-size:12px;">No saved presets</p>';
        return;
      }
      container.innerHTML = keys.map(name => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:var(--bg); border-radius:4px; margin-bottom:6px;">
          <span style="font-size:12px;">${escapeHtml(name)}</span>
          <div style="display:flex; gap:4px;">
            <button class="btn btn-sm btn-primary" onclick="loadPreset('${escapeHtml(name)}')">Load</button>
            <button class="btn btn-sm" style="background:var(--red); color:white;" onclick="deletePreset('${escapeHtml(name)}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Export count controls
    document.getElementById('exportCount').addEventListener('change', function() {
      const customInput = document.getElementById('customExportCount');
      if (this.value === 'custom') { customInput.style.display = 'inline-block'; customInput.focus(); }
      else customInput.style.display = 'none';
      updateExportPreview();
    });

    document.getElementById('customExportCount').addEventListener('input', updateExportPreview);
    document.getElementById('skipExported').addEventListener('change', updateExportPreview);
    document.getElementById('includeRecycle').addEventListener('change', updateExportPreview);
    document.getElementById('recycleDays').addEventListener('change', function() {
      updateExportPreview();
      renderMailedList();
    });

    // Process file
    processBtn.addEventListener('click', processFile);

    async function processFile() {
      if (parsedRows.length === 0) return;

      // Save filter settings for next time
      saveFilterSettings();

      const nameIdx = parseInt(document.getElementById('mapName').value);
      const addr1Idx = parseInt(document.getElementById('mapAddress1').value);
      const addr2Idx = parseInt(document.getElementById('mapAddress2').value);
      const cityIdx = parseInt(document.getElementById('mapCity').value);
      const stateIdx = parseInt(document.getElementById('mapState').value);
      const zipIdx = parseInt(document.getElementById('mapZip').value);
      const filterIdx = parseInt(document.getElementById('mapFilter').value);
      const filterZipIdx = parseInt(document.getElementById('mapFilterZip').value);
      const valueIdx = parseInt(document.getElementById('mapValue').value);
      const yearIdx = parseInt(document.getElementById('mapYearBuilt').value);
      const propAddrIdx = parseInt(document.getElementById('mapPropAddress').value);
      const propCityIdx = parseInt(document.getElementById('mapPropCity').value);
      const propStateIdx = parseInt(document.getElementById('mapPropState').value);
      const propTypeIdx = parseInt(document.getElementById('mapPropType').value);
      const assessedIdx = parseInt(document.getElementById('mapAssessedValue').value);
      const saleDateIdx = parseInt(document.getElementById('mapSaleDate').value);
      const subdivisionIdx = parseInt(document.getElementById('mapSubdivision').value);
      const lotSizeIdx = parseInt(document.getElementById('mapLotSize').value);
      const livingAreaIdx = parseInt(document.getElementById('mapLivingArea').value);
      const mainKeyIdx = parseInt(document.getElementById('mainKeyCol').value);

      // Trigger thresholds
      const trigMinLot = parseInt(document.getElementById('trigMinLot').value) || 0;
      const trigMaxLot = parseInt(document.getElementById('trigMaxLot').value) || Infinity;
      const trigMinLiving = parseInt(document.getElementById('trigMinLiving').value) || 0;
      const trigMaxLiving = parseInt(document.getElementById('trigMaxLiving').value) || Infinity;
      const trigMinValue = parseInt(document.getElementById('trigMinValue').value) || 0;
      const trigMaxValue = parseInt(document.getElementById('trigMaxValue').value) || Infinity;
      const hasTriggerFilters = trigMinLot > 0 || trigMaxLot < Infinity || trigMinLiving > 0 || trigMaxLiving < Infinity || trigMinValue > 0 || trigMaxValue < Infinity;

      // Check if we have lookup data loaded
      const hasLookupData = Object.keys(salesLookup).length > 0 || Object.keys(featuresLookup).length > 0 || Object.keys(subdivLookup).length > 0;

      let targetState = document.getElementById('targetState').value.toUpperCase().trim();

      // Auto-detect primary state from data if not specified
      if (!targetState && stateIdx >= 0 && parsedRows.length > 1) {
        const stateCounts = {};
        const sampleRows = parsedRows.slice(1, Math.min(101, parsedRows.length));
        for (const row of sampleRows) {
          const s = (row[stateIdx] || '').toUpperCase().trim();
          const abbrev = s.length === 2 ? s : (STATE_NAME_TO_ABBREV[s] || '');
          if (abbrev) stateCounts[abbrev] = (stateCounts[abbrev] || 0) + 1;
        }
        const detected = Object.entries(stateCounts).sort((a, b) => b[1] - a[1])[0];
        if (detected) {
          targetState = detected[0];
          document.getElementById('targetState').value = targetState;
          showToast(`Auto-detected state: ${targetState}`);
        }
      }
      const targetCities = document.getElementById('targetCities').value.split(',').map(c => c.trim().toUpperCase()).filter(c => c);
      const targetZips = document.getElementById('targetZips').value.split(',').map(z => z.trim()).filter(z => z);

      const minValue = parseInt(document.getElementById('minValue').value) || 0;
      const maxValue = parseInt(document.getElementById('maxValue').value) || Infinity;
      const minYear = parseInt(document.getElementById('minYear').value) || 0;
      const maxYear = parseInt(document.getElementById('maxYear').value) || 9999;
      const minPoolAge = parseInt(document.getElementById('minPoolAge').value) || 0;
      const maxPoolAge = parseInt(document.getElementById('maxPoolAge').value) || 999;
      const minAssessed = parseInt(document.getElementById('minAssessed').value) || 0;
      const maxAssessed = parseInt(document.getElementById('maxAssessed').value) || Infinity;
      const minDaysSinceSale = parseInt(document.getElementById('minDaysSinceSale').value) || 0;
      const maxDaysSinceSale = parseInt(document.getElementById('maxDaysSinceSale').value) || Infinity;

      // Built-in filters (always enabled)
      const removePOBox = true;
      const removeSuite = true;
      const removeOutOfState = true;
      const removeBiz = document.getElementById('removeBiz').checked;
      const standardize = true; // Always standardize addresses
      const uppercase = document.getElementById('uppercase').checked;
      const absenteeOnly = document.getElementById('absenteeOnly').checked;
      const excludeNoPool = document.getElementById('excludeNoPool').checked;
      const skipMailed = false; // Handled in export controls instead

      // Load "No Pool" addresses from Identifier
      const verifierData = JSON.parse(localStorage.getItem('poolVerifierData') || '{}');
      const noPoolSet = new Set();
      if (excludeNoPool) {
        Object.entries(verifierData).forEach(([key, data]) => {
          if (data.status === VERIFY_STATUS.NO_POOL) {
            noPoolSet.add(key);
          }
        });
        if (noPoolSet.size > 0) {
          showToast(`Excluding ${noPoolSet.size} "No Pool" addresses from Identifier`);
        }
      }

      const allowSFR = document.getElementById('allowSFR').checked;
      const allowCondo = document.getElementById('allowCondo').checked;
      const allowMulti = document.getElementById('allowMulti').checked;
      const allowVacant = document.getElementById('allowVacant').checked;
      const allowOther = document.getElementById('allowOther').checked;

      const currentYear = new Date().getFullYear();
      const mailedSet = new Set(mailedAddresses.map(a => a.toUpperCase()));
      const excludeSet = new Set(excludeAddresses.map(a => a.toUpperCase()));

      results = [];
      let dupeCount = 0, bizCount = 0, excludedCount = 0, mailedSkipped = 0;
      const seen = new Set();

      progressContainer.style.display = 'block';
      progressFill.style.width = '0%';

      const startIdx = parsedRows.length > 0 && parsedRows[0].every(c => c === '') ? 1 : 0;
      const total = parsedRows.length - startIdx;

      for (let i = startIdx; i < parsedRows.length; i++) {
        if (i % PROGRESS_UPDATE_INTERVAL === 0) {
          progressFill.style.width = `${((i - startIdx) / total * 100).toFixed(0)}%`;
          progressText.textContent = `Processing ${i.toLocaleString()} of ${parsedRows.length.toLocaleString()}...`;
          await new Promise(r => setTimeout(r, 0));
        }

        const row = parsedRows[i];
        if (!row || row.length < 3) continue;

        // Get parcel ID for lookup joins
        const parcelId = mainKeyIdx >= 0 ? (row[mainKeyIdx] || '').trim().toUpperCase() : '';

        // Filter column check (or use extra features lookup for pool detection)
        let hasPool = false;
        if (filterIdx >= 0) {
          const filterVal = (row[filterIdx] || '').toUpperCase();
          // Accept: TRUE/YES/1 (boolean), or contains POOL/PLSC (keyword)
          const isTrue = filterVal === 'TRUE' || filterVal === 'YES' || filterVal === '1';
          const hasKeyword = filterVal.includes('POOL') || filterVal.includes('PLSC');
          hasPool = isTrue || hasKeyword;
        }
        // If no filter column but we have features lookup, check there
        if (!hasPool && parcelId && featuresLookup[parcelId]) {
          hasPool = featuresLookup[parcelId].hasPool;
        }
        // Skip if no pool found (when filtering is enabled)
        if (filterIdx >= 0 || Object.keys(featuresLookup).length > 0) {
          if (!hasPool) continue;
        }

        // Target zips check
        if (filterZipIdx >= 0 && targetZips.length > 0) {
          const propZip = (row[filterZipIdx] || '').substring(0, 5);
          if (!targetZips.includes(propZip)) continue;
        }

        // Property value check
        if (valueIdx >= 0 && (minValue > 0 || maxValue < Infinity)) {
          const propValue = parseInt((row[valueIdx] || '0').replace(/[^0-9]/g, '')) || 0;
          if (propValue < minValue || propValue > maxValue) continue;
        }

        // Year built check
        if (yearIdx >= 0 && (minYear > 0 || maxYear < 9999)) {
          const yearBuilt = parseInt((row[yearIdx] || '0').replace(/[^0-9]/g, '')) || 0;
          if (yearBuilt < minYear || yearBuilt > maxYear) continue;
        }

        // Pool age check
        const minPoolAgeSet = document.getElementById('minPoolAge').value !== '';
        const maxPoolAgeSet = document.getElementById('maxPoolAge').value !== '';
        if (yearIdx >= 0 && (minPoolAgeSet || maxPoolAgeSet)) {
          const yearBuilt = parseInt((row[yearIdx] || '0').replace(/[^0-9]/g, '')) || 0;
          if (yearBuilt > MIN_YEAR_BUILT) {
            const poolAge = currentYear - yearBuilt;
            if (poolAge < minPoolAge || poolAge > maxPoolAge) continue;
          }
        }

        // Assessed value check
        if (assessedIdx >= 0 && (minAssessed > 0 || maxAssessed < Infinity)) {
          const assessedValue = parseInt((row[assessedIdx] || '0').replace(/[^0-9]/g, '')) || 0;
          if (assessedValue < minAssessed || assessedValue > maxAssessed) continue;
        }

        // Property type / DOR code check
        if (propTypeIdx >= 0) {
          const propType = (row[propTypeIdx] || '').toUpperCase().trim();
          const dorCode = parseInt(propType.replace(/[^0-9]/g, '')) || -1;

          // Florida DOR Codes:
          // 01 = Single Family Residential
          // 00 = Vacant Residential
          // 02 = Mobile Home
          // 03 = Multi-family (2-9 units)
          // 04 = Condominium
          // 05-08 = Various residential (cooperatives, retirement, misc, apartments)
          // 09 = Residential Common Area / HOA
          // 10+ = Commercial, Industrial, Agricultural, etc.

          const isSFR = dorCode === DOR_CODES.SFR || propType.includes('SINGLE') || propType.includes('SFR');
          const isCondo = dorCode === DOR_CODES.CONDO || dorCode === DOR_CODES.COOP || propType.includes('CONDO') || propType.includes('COOP');
          const isMulti = dorCode === DOR_CODES.MOBILE || dorCode === DOR_CODES.MULTI_FAMILY || dorCode === DOR_CODES.RETIREMENT || dorCode === DOR_CODES.MISC_RES || dorCode === DOR_CODES.APARTMENTS ||
            propType.includes('MULTI') || propType.includes('DUPLEX') || propType.includes('MOBILE');
          const isVacant = dorCode === DOR_CODES.VACANT || propType.includes('VACANT');

          // Commercial/Business property types (DOR 09 = HOA common area, 10+ = commercial)
          const isCommercial = dorCode === DOR_CODES.HOA_COMMON || dorCode >= 10;
          const isBusinessType = propType.includes('COMMERCIAL') || propType.includes('INDUSTRIAL') ||
            propType.includes('OFFICE') || propType.includes('RETAIL') || propType.includes('APARTMENT') ||
            propType.includes('HOTEL') || propType.includes('MOTEL') || propType.includes('WAREHOUSE') ||
            propType.includes('INSTITUTION') || propType.includes('GOVERNMENT') || propType.includes('HOA') ||
            propType.includes('COMMON') || propType.includes('ASSOC');

          // Skip commercial properties when "No Business" is checked
          if (removeBiz && (isCommercial || isBusinessType)) continue;

          // Apply checkbox filters
          if (isSFR && !allowSFR) continue;
          if (isCondo && !allowCondo) continue;
          if (isMulti && !allowMulti) continue;
          if (isVacant && !allowVacant) continue;
          if (!isSFR && !isCondo && !isMulti && !isVacant && !allowOther) continue;
        }

        let name = nameIdx >= 0 ? (row[nameIdx] || '') : '';

        // Get property address (where the pool is - primary address for postcards)
        let propAddr = propAddrIdx >= 0 ? (row[propAddrIdx] || '').replace(/"/g, '').trim() : '';
        let propCity = propCityIdx >= 0 ? (row[propCityIdx] || '').trim() : '';
        let propState = propStateIdx >= 0 ? (row[propStateIdx] || '').trim() : '';
        let propZip = filterZipIdx >= 0 ? (row[filterZipIdx] || '').trim() : '';
        let addr2 = addr2Idx >= 0 ? (row[addr2Idx] || '').replace(/"/g, '').trim() : '';

        // Get mailing address (owner's address - used for absentee detection)
        let mailAddr = addr1Idx >= 0 ? (row[addr1Idx] || '').replace(/"/g, '').trim() : '';
        let mailCity = cityIdx >= 0 ? (row[cityIdx] || '').trim() : '';

        // Use property address (where the pool is), fall back to mail address if not available
        let address1, address2, city, state, zip;

        if (propAddr) {
          // Use property address (where the pool is)
          address1 = propAddr;
          address2 = addr2;
          city = propCity;
          state = propState;
          zip = propZip;
        } else if (mailAddr) {
          // Fall back to mailing address
          address1 = mailAddr;
          address2 = addr2;
          city = mailCity;
          state = stateIdx >= 0 ? (row[stateIdx] || '').trim() : '';
          zip = zipIdx >= 0 ? (row[zipIdx] || '').trim() : '';
        } else {
          // No address available
          continue;
        }

        name = name.replace(/"/g, '').trim();

        if (!address1) continue;

        const isPOBox = /^P\.?O\.?\s*BOX|POST\s*OFFICE/i.test(address1);
        if (isPOBox && removePOBox) { excludedCount++; continue; }

        const hasSuiteUnit = /\b(STE|SUITE|UNIT|APT)\s*[\dA-Z-]+/i.test(address1) || /\b(STE|SUITE|UNIT|APT)\s*[\dA-Z-]+/i.test(address2) || /#\s*\d+/i.test(address1) || /#\s*\d+/i.test(address2);
        if (hasSuiteUnit && removeSuite) { excludedCount++; continue; }

        address1 = fixStuckCityName(address1);

        if (!city || cityIdx < 0) {
          const parsed = parseFullAddress(address1);
          address1 = parsed.street;
          if (!city) city = parsed.city;
          if (!state) state = parsed.state;
          if (!zip) zip = parsed.zip;
        }

        if (!city) {
          for (const { name: cityName, pattern: cityPattern } of knownCityPatterns) {
            if (MULTI_STATE_CITIES.has(cityName)) continue;
            if (cityPattern.test(address1)) {
              const lookup = cityLookup[cityName];
              city = (lookup && lookup.normalize) ? lookup.normalize : cityName;
              address1 = address1.replace(cityPattern, '').replace(/\s+/g, ' ').trim();
              if (lookup) {
                if (!state) state = lookup.state;
                if (!zip) zip = lookup.zip;
              }
              break;
            }
          }
        }

        if (isForeignAddress(address1, city)) { excludedCount++; continue; }

        let fullAddress = address1;
        if (address2) fullAddress += ' ' + address2;

        state = normalizeState(state);

        // Exclude US territories (Puerto Rico, Guam, Virgin Islands, etc.)
        const excludedTerritories = ['PR', 'GU', 'VI', 'AS', 'MP', 'FM', 'MH', 'PW'];
        if (state && excludedTerritories.includes(state.toUpperCase())) { excludedCount++; continue; }

        if (state && targetState && state !== targetState && removeOutOfState) { excludedCount++; continue; }

        if (city && !isValidCity(city)) { excludedCount++; continue; }

        if (targetCities.length > 0 && !targetCities.includes(city.toUpperCase())) continue;

        zip = zip.replace(/[^\d-]/g, '').substring(0, 10);
        if (zip.length > 5 && !zip.includes('-')) zip = zip.substring(0, 5) + '-' + zip.substring(5);

        // Auto-lookup zip from cityLookup if missing or incomplete
        if ((!zip || zip.length < 5) && city) {
          const cityUpper = city.toUpperCase().trim();
          // Direct lookup
          if (cityLookup[cityUpper] && cityLookup[cityUpper].zip) {
            zip = cityLookup[cityUpper].zip;
          } else {
            // Try partial match (e.g., "WINTER SPRINGS" matches "WINTER SPGS")
            for (const knownCity of Object.keys(cityLookup)) {
              if (cityUpper.includes(knownCity) || knownCity.includes(cityUpper)) {
                zip = cityLookup[knownCity].zip;
                break;
              }
            }
          }
        }

        const formatted = formatName(name);
        const isBusiness = isBusinessName(formatted.company || formatted.recipient);
        if (isBusiness) bizCount++;

        if (removeBiz && isBusiness) { excludedCount++; continue; }

        // Clean up city name (remove garbage prefixes, expand abbreviations)
        city = cleanupCity(city);
        propCity = cleanupCity(propCity);

        if (standardize) {
          fullAddress = standardizeAddress(fullAddress);
          city = standardizeAddress(city);
          propCity = standardizeAddress(propCity);
        }

        if (!uppercase) {
          formatted.recipient = toTitleCase(formatted.recipient);
          formatted.company = toTitleCase(formatted.company);
          fullAddress = toTitleCase(fullAddress);
          city = toTitleCase(city);
          propCity = toTitleCase(propCity);
        } else {
          formatted.recipient = formatted.recipient.toUpperCase();
          formatted.company = formatted.company.toUpperCase();
          fullAddress = fullAddress.toUpperCase();
          city = city.toUpperCase();
          propCity = propCity.toUpperCase();
        }

        const key = `${fullAddress}|${city}|${zip}`.toUpperCase();
        if (seen.has(key)) { dupeCount++; continue; }
        seen.add(key);

        if (skipMailed && mailedSet.has(key)) { mailedSkipped++; continue; }

        // Check if address was marked "No Pool" in Verifier
        if (excludeNoPool && noPoolSet.size > 0) {
          const verifierKey = `${fullAddress}, ${city}, ${state || targetState} ${zip}`.toUpperCase().replace(/[^A-Z0-9]/g, '');
          if (noPoolSet.has(verifierKey)) { excludedCount++; continue; }
        }

        if (excludeSet.has(fullAddress.toUpperCase())) { excludedCount++; continue; }

        const flags = [];
        if (isBusiness) flags.push('BIZ');

        let propValue = '';
        let yearBuilt = '';
        let poolAge = '';
        if (valueIdx >= 0) {
          propValue = (row[valueIdx] || '').replace(/[^0-9.]/g, '');
          if (propValue) propValue = '$' + parseInt(propValue).toLocaleString();
        }
        if (yearIdx >= 0) {
          yearBuilt = (row[yearIdx] || '').replace(/[^0-9]/g, '');
          if (yearBuilt && parseInt(yearBuilt) > 1800) {
            poolAge = currentYear - parseInt(yearBuilt);
          }
        }

        let propType = '';
        if (propTypeIdx >= 0) {
          propType = (row[propTypeIdx] || '').trim();
          if (!uppercase) propType = toTitleCase(propType);
        }

        let assessedValue = '';
        if (assessedIdx >= 0) {
          assessedValue = (row[assessedIdx] || '').replace(/[^0-9.]/g, '');
          if (assessedValue) assessedValue = '$' + parseInt(assessedValue).toLocaleString();
        }

        let saleDate = '';
        let daysSinceSale = null;
        if (saleDateIdx >= 0) {
          saleDate = (row[saleDateIdx] || '').trim();
          // Try to format as date if it looks like one
          if (saleDate && /\d/.test(saleDate)) {
            // Handle various date formats: YYYYMMDD, MM/DD/YYYY, YYYY-MM-DD, etc.
            const cleaned = saleDate.replace(/[^\d]/g, '');
            if (cleaned.length === 8) {
              // Assume YYYYMMDD or MMDDYYYY
              let year, month, day;
              if (cleaned.startsWith('19') || cleaned.startsWith('20')) {
                year = cleaned.substring(0,4);
                month = cleaned.substring(4,6);
                day = cleaned.substring(6,8);
                saleDate = month + '/' + day + '/' + year;
              } else {
                month = cleaned.substring(0,2);
                day = cleaned.substring(2,4);
                year = cleaned.substring(4,8);
                saleDate = month + '/' + day + '/' + year;
              }
              // Calculate days since sale
              const saleDateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
              if (!isNaN(saleDateObj.getTime())) {
                daysSinceSale = Math.floor((new Date() - saleDateObj) / (1000 * 60 * 60 * 24));
              }
            }
          }
        }

        // Filter by days since sale
        if (daysSinceSale !== null && (minDaysSinceSale > 0 || maxDaysSinceSale < Infinity)) {
          if (daysSinceSale < minDaysSinceSale || daysSinceSale > maxDaysSinceSale) continue;
        }

        // Determine if absentee: mailing address differs from property address
        let isAbsentee = false;

        if (mailAddr && propAddr) {
          // Normalize street suffixes for comparison
          const normAddr = (s) => {
            return s.toUpperCase()
              .replace(/\bCIRCLE\b/g, 'CIR').replace(/\bDRIVE\b/g, 'DR')
              .replace(/\bSTREET\b/g, 'ST').replace(/\bAVENUE\b/g, 'AVE')
              .replace(/\bBOULEVARD\b/g, 'BLVD').replace(/\bLANE\b/g, 'LN')
              .replace(/\bROAD\b/g, 'RD').replace(/\bCOURT\b/g, 'CT')
              .replace(/\bPLACE\b/g, 'PL').replace(/\bTERRACE\b/g, 'TER')
              .replace(/\bPARKWAY\b/g, 'PKWY').replace(/\bWAY\b/g, 'WAY')
              .replace(/\bTRAIL\b/g, 'TRL').replace(/\bPOINT\b/g, 'PT')
              .replace(/[^A-Z0-9]/g, '');
          };

          const mailNorm = normAddr(mailAddr);
          const propNorm = normAddr(propAddr);
          const mailZipVal = zipIdx >= 0 ? (row[zipIdx] || '').trim().substring(0, 5) : '';
          const propZipVal = (propZip || '').substring(0, 5);

          // PO Box in same zip = likely lives at property
          const isPOBox = /^P\.?O\.?\s*BOX|POST\s*OFFICE/i.test(mailAddr);

          if (mailNorm === propNorm) {
            isAbsentee = false;
          } else if (isPOBox && mailZipVal && propZipVal && mailZipVal === propZipVal) {
            // PO Box in same zip code ‚Äî owner likely lives at property
            isAbsentee = false;
          } else if (mailNorm.substring(0, 12) === propNorm.substring(0, 12)) {
            // First 12 chars match after normalization ‚Äî likely same address with formatting diff
            isAbsentee = false;
          } else {
            isAbsentee = true;
          }
        }

        if (absenteeOnly && !isAbsentee) continue;

        if (isAbsentee) flags.push('ABSENTEE');

        // Get subdivision from column or lookup
        let subdivision = '';
        if (subdivisionIdx >= 0) {
          subdivision = (row[subdivisionIdx] || '').trim();
        }
        // Override with lookup if available and empty
        if (!subdivision && parcelId && subdivLookup[parcelId]) {
          subdivision = subdivLookup[parcelId].subdivision || subdivLookup[parcelId].neighborhood || '';
        }
        if (!uppercase && subdivision) subdivision = toTitleCase(subdivision);
        // Expand common subdivision abbreviations
        subdivision = expandSubdivisionAbbrevs(subdivision);

        // Merge sales lookup data if available
        if (parcelId && salesLookup[parcelId]) {
          const salesData = salesLookup[parcelId];
          if (!saleDate && salesData.saleDate) {
            saleDate = salesData.saleDate;
            // Try to calculate days since sale
            const cleaned = saleDate.replace(/[^\d]/g, '');
            if (cleaned.length === 8) {
              let year, month, day;
              if (cleaned.startsWith('19') || cleaned.startsWith('20')) {
                year = cleaned.substring(0,4);
                month = cleaned.substring(4,6);
                day = cleaned.substring(6,8);
              } else {
                month = cleaned.substring(0,2);
                day = cleaned.substring(2,4);
                year = cleaned.substring(4,8);
              }
              const saleDateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
              if (!isNaN(saleDateObj.getTime())) {
                daysSinceSale = Math.floor((new Date() - saleDateObj) / (1000 * 60 * 60 * 24));
              }
            }
          }
        }

        // Parse lot size and living area
        const lotSizeRaw = lotSizeIdx >= 0 ? parseInt((row[lotSizeIdx] || '0').replace(/[^0-9]/g, '')) || 0 : 0;
        const livingAreaRaw = livingAreaIdx >= 0 ? parseInt((row[livingAreaIdx] || '0').replace(/[^0-9]/g, '')) || 0 : 0;
        const marketValueRaw = valueIdx >= 0 ? parseInt((row[valueIdx] || '0').replace(/[^0-9]/g, '')) || 0 : 0;

        // Build trigger reasons
        const triggers = [];
        if (hasTriggerFilters) {
          if (lotSizeRaw > 0 && lotSizeRaw >= trigMinLot && lotSizeRaw <= trigMaxLot)
            triggers.push(`Lot ${lotSizeRaw.toLocaleString()} sqft`);
          if (livingAreaRaw > 0 && livingAreaRaw >= trigMinLiving && livingAreaRaw <= trigMaxLiving)
            triggers.push(`Living ${livingAreaRaw.toLocaleString()} sqft`);
          if (marketValueRaw > 0 && marketValueRaw >= trigMinValue && marketValueRaw <= trigMaxValue)
            triggers.push(`Value $${marketValueRaw.toLocaleString()}`);
        }

        results.push({
          recipient: formatted.recipient,
          company: formatted.company,
          address: fullAddress,
          city: city,
          state: state || targetState,
          zipcode: zip,
          propertyValue: propValue,
          yearBuilt: yearBuilt,
          poolAge: poolAge,
          propertyType: propType,
          assessedValue: assessedValue,
          saleDate: saleDate,
          daysSinceSale: daysSinceSale,
          isAbsentee: isAbsentee,
          propertyAddress: propAddr ? (uppercase ? propAddr.toUpperCase() : toTitleCase(propAddr)) : '',
          mailingAddress: mailAddr ? (uppercase ? mailAddr.toUpperCase() : toTitleCase(mailAddr)) : '',
          subdivision: subdivision,
          lotSize: lotSizeRaw,
          livingArea: livingAreaRaw,
          triggers: triggers,
          flags: flags,
          notes: ''
        });
      }

      progressFill.style.width = '100%';
      progressText.textContent = 'Complete! Looking up missing address info...';

      // Show results first
      setTimeout(async () => {
        showResults({ total, matches: results.length, dupes: dupeCount, biz: bizCount, excluded: excludedCount });

        // Auto-lookup missing address components (city, state, zip)
        const needsLookup = results.filter(r =>
          !r.zipcode || r.zipcode.length < 5 ||
          !r.city || r.city.length < 2 ||
          !r.state || r.state.length < 2
        );

        if (needsLookup.length > 0) {
          progressText.textContent = `Looking up ${needsLookup.length} incomplete addresses...`;
          let foundCity = 0, foundState = 0, foundZip = 0;

          for (let i = 0; i < needsLookup.length; i += 5) {
            const batch = needsLookup.slice(i, i + 5);
            await Promise.all(batch.map(async (record) => {
              try {
                const result = await lookupAddress(record.address, record.city, record.state);
                if (result) {
                  // Fill in missing city
                  if ((!record.city || record.city.length < 2) && result.city) {
                    record.city = result.city;
                    foundCity++;
                  }
                  // Fill in missing state
                  if ((!record.state || record.state.length < 2) && result.state) {
                    record.state = result.state;
                    foundState++;
                  }
                  // Fill in missing zip
                  if ((!record.zipcode || record.zipcode.length < 5) && result.zip) {
                    record.zipcode = result.zip;
                    foundZip++;
                  }
                }
              } catch (e) { console.warn('[scraper] address lookup failed:', e.message); }
            }));
            progressText.textContent = `Lookup: ${i + batch.length}/${needsLookup.length}`;
            await new Promise(r => setTimeout(r, 50));
          }

          const totalFound = foundCity + foundState + foundZip;
          if (totalFound > 0) {
            applyFilter();
            const parts = [];
            if (foundCity > 0) parts.push(`${foundCity} cities`);
            if (foundState > 0) parts.push(`${foundState} states`);
            if (foundZip > 0) parts.push(`${foundZip} zips`);
            showToast(`Auto-filled: ${parts.join(', ')}`);
          }
        }

        progressContainer.style.display = 'none';
        processBtn.disabled = false;
      }, 500);
    }

    // Helper functions
    // Build dynamic city fix patterns from the top 80 longest city names (avoids regex explosion)
    const _fixCities = knownCities.slice(0, 80).map(c => c.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
    const _fixStates = Object.values(stateMap).join('|') + '|' + Object.keys(stateMap).join('|');
    const _stuckSuffixPattern = new RegExp(`\\b(DR|ST|AVE|LN|CT|CIR|WAY|BLVD|RD|PL|TER)(${_fixCities})\\b`, 'gi');
    const _stuckStatePattern = new RegExp(`\\b(${_fixCities})(${_fixStates})\\b`, 'gi');

    function fixStuckCityName(addr) {
      let result = addr;
      result = result.replace(_stuckSuffixPattern, '$1 $2');
      result = result.replace(_stuckStatePattern, '$1 $2');
      return result;
    }

    function parseFullAddress(fullAddr) {
      const result = { street: '', city: '', state: '', zip: '' };
      if (!fullAddr) return result;
      let addr = fullAddr.trim().toUpperCase().replace(/,/g, ' ').replace(/\s+/g, ' ');

      // Extract ZIP code from end
      const zipMatch = addr.match(/\b(\d{5}(-\d{4})?)\s*$/);
      if (zipMatch) { result.zip = zipMatch[1]; addr = addr.replace(zipMatch[0], '').trim(); }

      // Extract state abbreviation from end (all US state abbrevs)
      const allStates = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC'];
      const stateMatch = addr.match(/\b([A-Z]{2})\s*$/);
      if (stateMatch && allStates.includes(stateMatch[1])) {
        result.state = stateMatch[1];
        addr = addr.replace(stateMatch[0], '').trim();
      }

      // Try to find known cities at end
      let foundCity = false;
      for (const cityName of knownCities) {
        if (MULTI_STATE_CITIES.has(cityName)) continue;
        const pattern = new RegExp('\\b' + cityName.replace(/\s+/g, '\\s+') + '\\s*$', 'i');
        if (pattern.test(addr)) {
          const lookup = cityLookup[cityName];
          result.city = (lookup && lookup.normalize) ? lookup.normalize : cityName;
          addr = addr.replace(pattern, '').trim();
          if (!result.state && lookup) result.state = lookup.state;
          foundCity = true;
          break;
        }
      }

      // If no known city found, try to extract city from end of address
      if (!foundCity) {
        // Street suffix patterns - include numbers for highways (HWY 28, ROUTE 66)
        const suffixPattern = /\b(ROAD|RD|DRIVE|DR|STREET|ST|AVENUE|AVE|BOULEVARD|BLVD|LANE|LN|COURT|CT|CIRCLE|CIR|WAY|PLACE|PL|TERRACE|TER|TRAIL|TRL|HIGHWAY|HWY|PARKWAY|PKWY|LOOP|RUN|PATH|PASS|GLEN|GLN|COVE|CV|POINT|PT|ISLE?|BEACH|BCH|BEND|BND|VIEW|VW|HILL?|HLS?|SQUARE|SQ|PLAZA|PLZ|CROSSING|XING|ROUTE|RT)(\s+\d+)?\b/gi;
        let lastMatch = null;
        let match;
        while ((match = suffixPattern.exec(addr)) !== null) {
          lastMatch = match;
        }
        if (lastMatch) {
          let afterSuffix = addr.substring(lastMatch.index + lastMatch[0].length).trim();
          // Skip leading directions (N, S, E, W, NE, NW, SE, SW)
          afterSuffix = afterSuffix.replace(/^(N|S|E|W|NE|NW|SE|SW)\b\s*/i, '').trim();
          // Skip unit numbers that might come after
          afterSuffix = afterSuffix.replace(/^#?\d+[A-Z]?\s*/i, '').trim();
          // Check if there's something remaining that could be a city
          if (afterSuffix && afterSuffix.length > 1 && !/^\d/.test(afterSuffix) && !/^(APT|STE|SUITE|UNIT|BLDG|BUILDING|#|LOT|SPACE|FLOOR|FL)\b/i.test(afterSuffix)) {
            // Make sure it's not just a direction or number
            if (!/^(N|S|E|W|NE|NW|SE|SW|\d+)$/i.test(afterSuffix)) {
              result.city = afterSuffix;
              addr = addr.substring(0, lastMatch.index + lastMatch[0].length).trim();
            }
          }
        }

        // Try another approach: if address has words after numbers, and no suffix found
        // Pattern: "123 MAIN CITYNAME" where CITYNAME has no numbers
        if (!result.city) {
          const words = addr.split(/\s+/);
          if (words.length >= 3) {
            // Check if last word(s) look like a city (no numbers, not a direction)
            let potentialCity = [];
            for (let i = words.length - 1; i >= 2; i--) {
              const word = words[i];
              // Stop if we hit a number, direction, or common street word
              if (/\d/.test(word) || /^(N|S|E|W|NE|NW|SE|SW)$/i.test(word) ||
                  /^(RD|DR|ST|AVE|BLVD|LN|CT|CIR|WAY|PL|TER|TRL|HWY|PKWY)$/i.test(word)) {
                break;
              }
              potentialCity.unshift(word);
            }
            if (potentialCity.length > 0 && potentialCity.length <= 3) {
              const cityCandidate = potentialCity.join(' ');
              // Make sure it's a reasonable city name (2+ chars, no weird characters)
              if (cityCandidate.length >= 2 && /^[A-Z\s]+$/i.test(cityCandidate)) {
                result.city = cityCandidate;
                addr = words.slice(0, words.length - potentialCity.length).join(' ');
              }
            }
          }
        }
      }

      result.street = addr;
      return result;
    }

    function normalizeState(state) {
      if (!state) return '';
      state = state.toUpperCase().trim();
      if (state.length === 2) return state;
      return stateMap[state] || state;
    }

    const FOREIGN_PATTERNS = [
      // Country names
      /\bCANADA\b/, /\bONTARIO\b/, /\bQUEBEC\b/, /\bALBERTA\b/, /\bBRITISH COLUMBIA\b/,
      /\bUNITED KINGDOM\b/, /\bENGLAND\b/, /\bSCOTLAND\b/, /\bWALES\b/, /\bIRELAND\b/,
      /\bGERMANY\b/, /\bDEUTSCHLAND\b/, /\bFRANCE\b/, /\bITALY\b/, /\bITALIA\b/,
      /\bSPAIN\b/, /\bESPANA\b/, /\bPORTUGAL\b/, /\bMEXICO\b/, /\bBRASIL\b/, /\bBRAZIL\b/,
      /\bCHINA\b/, /\bJAPAN\b/, /\bKOREA\b/, /\bINDIA\b/, /\bPHILIPPINES\b/,
      /\bAUSTRALIA\b/, /\bNEW ZEALAND\b/, /\bISRAEL\b/, /\bHUNGARY\b/, /\bBUDAPEST\b/i,
      /\bNETHERLANDS\b/, /\bBELGIUM\b/, /\bSWITZERLAND\b/, /\bAUSTRIA\b/, /\bPOLAND\b/,
      /\bRUSSIA\b/, /\bUKRAINE\b/, /\bGREECE\b/, /\bTURKEY\b/, /\bVENEZUELA\b/, /\bCOLOMBIA\b/,
      /\bARGENTINA\b/, /\bCHILE\b/, /\bPERU\b/, /\bPUERTO RICO\b/, /\bCZECH\b/, /\bSLOVAK\b/,
      // Puerto Rico cities and patterns
      /\bBAYAMON\b/i, /\bSAN JUAN\b/i, /\bPONCE\b/i, /\bCAGUAS\b/i, /\bMAYAGUEZ\b/i,
      /\bARECIBO\b/i, /\bAGUADILLA\b/i, /\bCAROLINA\b/i, /\bGUAYNABO\b/i,
      /\bPR\s*\d{5}/, /\b00[6-9]\d{2}\b/, // PR zip codes start with 006-009
      // French West Indies / Caribbean
      /\bFWI\b/i, /\bSAINT MARTIN\b/i, /\bST MARTIN\b/i, /\bGUADELOUPE\b/i,
      /\bMARTINIQUE\b/i, /\bGALISBAY\b/i, /\b97\d{3}\b/, // French overseas postal codes
      // US Territories to exclude
      /\bGUAM\b/i, /\bVIRGIN ISLANDS\b/i, /\bUSVI\b/i, /\bAMERICAN SAMOA\b/i,
      // Foreign postal codes - Canadian
      /\b[A-Z]\d[A-Z]\s*\d[A-Z]\d\b/,
      // UK postal codes
      /\b[A-Z]{1,2}\d{1,2}\s*\d[A-Z]{2}\b/,
      // Foreign address patterns
      /\bVIA\s+[A-Z]+/i, // Italian "Via" streets
      /\bRUE\s+[A-Z]+/i, // French "Rue" streets
      /\bAVENIDA\s+[A-Z]+/i, // Spanish/Portuguese "Avenida"
      /\bCALLE\s+[A-Z]+/i, // Spanish "Calle"
      /\bSTRASSE\b/i, // German "Strasse"
      /\bSTR\s+\d/i, /\bSTR\.\s*\d/i, // German/European "Str 14" or "Str. 14"
      /\bVERCSE\b/i, // Hungarian street
      /\bUTCA\b/i, /\bUT\.\b/i, /\bKRT\b/i, // Hungarian street types
      /\bURB\s+[A-Z]+/i, // Spanish "Urbanizacion"
      /\bCONDOMINIO\b/i, // Spanish/Portuguese
      /\bCEP\s*\d{5}/i, // Brazilian postal code
      /\bEDO\s+[A-Z]+/i, // Spanish state abbreviation
      /\bCHAPELLE\b/i, // French
      /\bLAZIO\b/i, /\bROMA\b/i, /\bMILANO\b/i, // Italian regions
      /\bCENTRE COMMERCIAL\b/i, // French shopping center
      // Patterns ending with country-like suffixes (merged into address)
      /SWITZERLAND$/i, /FRANCE$/i, /ITALY$/i, /TALY$/i, /HUNGARY$/i,
      /WITZERLAND$/i, /RANCE$/i, /UNGARY$/i,
      // Foreign city names embedded (including merged)
      /BUDAPEST/i, /\bPARIS\b/, /\bLONDON\b/,
      /\bBARHALTEN\b/i, /\bNIKLAUSEN\b/i, /\bTHOUARAULT\b/i, /\bMERIDA\b/i,
      // Pattern: number + city merged like "14budapest" or "Fwi97150"
      /\d+[A-Z]{4,}/i, /[A-Z]{3,}\d{5}/i
    ];

    function isForeignAddress(address, city) {
      const upper = (address + ' ' + city).toUpperCase();
      return FOREIGN_PATTERNS.some(p => p.test(upper));
    }

    function isValidCity(city) {
      if (!city) return true;
      const upper = city.toUpperCase().trim();
      if (upper.length < 2 || upper.length > 35) return false;
      if (/^\d+$/.test(upper)) return false;
      if (/\d{4,}/.test(upper)) return false;
      // Reject incomplete/generic city fragments
      const invalidCities = ['SPRINGS', 'BEACH', 'PARK', 'CITY', 'HEIGHTS', 'HILLS', 'LAKE', 'VILLAGE', 'SHORES', 'ISLE', 'ISLAND', 'POINT', 'BAY', 'COVE', 'PR', 'FWI'];
      if (invalidCities.includes(upper)) return false;
      // Reject if ends with common foreign indicators
      if (/\s+(PR|FWI|UK|MX)$/i.test(upper)) return false;
      return true;
    }

    function cleanupCity(city) {
      if (!city) return '';
      let cleaned = city.trim();
      // Remove leading garbage: #, numbers, letter-number combos like "A1a", "C-207", "# L"
      cleaned = cleaned.replace(/^[#@*!\s]+/, '').trim();
      cleaned = cleaned.replace(/^[A-Z]?\d+[A-Z]?\s*/i, '').trim(); // A1a, A104, C-207
      cleaned = cleaned.replace(/^[A-Z]-?\d+\s*/i, '').trim(); // C-207
      cleaned = cleaned.replace(/^#\s*[A-Z]?\s*/i, '').trim(); // # L, # C
      // Remove trailing state abbreviations (e.g., "Flagler Beach Fl" -> "Flagler Beach")
      cleaned = cleaned.replace(/\s+(FL|GA|AL|CA|NY|TX|NC|SC|VA|TN|OH|MI|PA|IL|NJ|MD|PR|FWI)$/i, '').trim();
      // Remove leading state abbreviations that got stuck
      cleaned = cleaned.replace(/^(FL|GA|AL)\s+/i, '').trim();
      // Fix common corrupted city names
      cleaned = cleaned.replace(/^AGLER\s+BEACH$/i, 'Flagler Beach');
      cleaned = cleaned.replace(/^LAGLER\s+BEACH$/i, 'Flagler Beach');
      cleaned = cleaned.replace(/\bSANTA\s+RSA\b/gi, 'Santa Rosa');
      cleaned = cleaned.replace(/\bNEW\s+SMYRNA$/i, 'New Smyrna Beach');
      cleaned = cleaned.replace(/\bPT\s+CHARLOTTE\b/gi, 'Port Charlotte');
      cleaned = cleaned.replace(/\bFT\s+MYERS\b/gi, 'Fort Myers');
      cleaned = cleaned.replace(/\bFT\s+PIERCE\b/gi, 'Fort Pierce');
      cleaned = cleaned.replace(/\bFT\s+WALTON\b/gi, 'Fort Walton');
      cleaned = cleaned.replace(/\bST\s+AUGUSTINE\b/gi, 'Saint Augustine');
      cleaned = cleaned.replace(/\bST\s+PETE\b/gi, 'Saint Petersburg');
      cleaned = cleaned.replace(/\bST\s+PETERSBURG\b/gi, 'Saint Petersburg');
      cleaned = cleaned.replace(/\bJAX\b/gi, 'Jacksonville');
      cleaned = cleaned.replace(/\bPCOLA\b/gi, 'Pensacola');
      cleaned = cleaned.replace(/\bPNS\b/gi, 'Pensacola');
      // Expand common abbreviations
      cleaned = cleaned.replace(/\bSPG\b/gi, 'Springs');
      cleaned = cleaned.replace(/\bSPGS\b/gi, 'Springs');
      cleaned = cleaned.replace(/\bBCH\b/gi, 'Beach');
      cleaned = cleaned.replace(/\bPK\b/gi, 'Park');
      cleaned = cleaned.replace(/\bHTS\b/gi, 'Heights');
      cleaned = cleaned.replace(/\bMTN\b/gi, 'Mountain');
      cleaned = cleaned.replace(/\bVLG\b/gi, 'Village');
      cleaned = cleaned.replace(/\bISL\b/gi, 'Isle');
      return cleaned;
    }

    function formatName(rawName) {
      let name = (rawName || '').replace(/"/g, '').trim().toUpperCase();
      if (!name) return { recipient: 'Current Resident', company: '' };

      // Step 1: Clean the name - remove all junk
      name = cleanName(name);
      if (!name || name.length < 2) return { recipient: 'Current Resident', company: '' };

      // Step 2: Check if business
      if (isBusinessName(name)) return { recipient: '', company: rawName.trim() };

      // Step 3: Handle multiple owners with & - only use PRIMARY (first) owner
      if (name.includes('&')) {
        const parts = name.split(/\s*&\s*/).map(p => cleanName(p)).filter(p => p && p.length >= 2);
        // Just use the first owner
        name = parts[0] || '';
        if (!name) return { recipient: 'Current Resident', company: '' };
      }

      // Step 4: Single owner
      const owner = parseSingleName(name, false);
      if (owner.first && owner.last) {
        return { recipient: toTitleCase(owner.first + ' ' + owner.last), company: '' };
      }
      const finalName = toTitleCase(owner.first || owner.last || name);
      if (!finalName || finalName.length < 2) {
        return { recipient: 'Current Resident', company: '' };
      }
      return { recipient: finalName, company: '' };
    }

    // Clean all junk from a name
    function cleanName(name) {
      if (!name) return '';

      // Remove leading junk: #, numbers, &, -, etc
      name = name.replace(/^[^A-Za-z]+/, '');

      // Remove these words completely (legal/garbage terms)
      const removeWords = [
        'ENH', 'EST', 'ESTATE', 'LIFE', 'TRUST', 'LIVING', 'REVOCABLE', 'IRREVOCABLE',
        'REV', 'IRREV', 'TRUSTEE', 'FBO', 'ETAL', 'TR', 'FAMILY', 'JOINT',
        'NUMBER', 'LAND', 'SUCC', 'SUCCESSOR', 'JTRS', 'JTWROS', 'TIC', 'WROS'
      ];
      let words = name.split(/\s+/);
      words = words.filter(w => {
        const upper = w.toUpperCase();
        if (removeWords.includes(upper)) return false;
        if (/^\d+$/.test(w)) return false; // Pure numbers
        if (/^[^A-Za-z]/.test(w)) return false; // Starts with non-letter
        return true;
      });

      // Remove duplicate consecutive words
      const clean = [];
      for (let i = 0; i < words.length; i++) {
        if (i === 0 || words[i].toUpperCase() !== words[i-1].toUpperCase()) {
          clean.push(words[i]);
        }
      }

      // Remove single letter words and hyphenated initials like J-K
      const result = clean.filter(w => {
        if (/^[A-Z]-[A-Z]$/i.test(w)) return false; // J-K
        if (/^[A-Z]$/i.test(w)) return false; // Single letters
        if (w.length < 2) return false; // Too short
        return true;
      });

      return result.join(' ').trim();
    }

    // Parse a single person's name
    // fromAmpersand = true means this came from a & split (likely FIRSTNAME LASTNAME format)
    function parseSingleName(name, isSecondary, fromAmpersand = false) {
      if (!name) return { first: '', last: '' };

      // Clean it first
      name = cleanName(name);
      if (!name) return { first: '', last: '' };

      // Handle LASTNAME, FIRSTNAME format (has comma)
      if (name.includes(',')) {
        const parts = name.split(',').map(p => p.trim());
        const last = parts[0];
        // Only take FIRST word after comma (no middle names)
        const firstParts = parts.slice(1).join(' ').trim().split(/\s+/);
        const first = firstParts[0] || '';
        return { first: first, last: last };
      }

      // No comma - split by space
      const parts = name.split(/\s+/).filter(p => p);
      if (parts.length === 0) return { first: '', last: '' };
      if (parts.length === 1) return { first: '', last: parts[0] };

      // Check for suffix at end
      const lastWord = parts[parts.length - 1].toUpperCase();
      let suffix = '';
      if (['JR', 'SR', 'II', 'III', 'IV', 'V', 'VI'].includes(lastWord)) {
        suffix = ' ' + parts.pop();
      }

      if (parts.length < 2) {
        return { first: '', last: parts[0] + suffix };
      }

      // Default: assume LASTNAME FIRSTNAME (Seminole county format)
      // First word is last name, second word is first name (ignore middle names)
      return { first: parts[1], last: parts[0] + suffix };
    }

    function isBusinessName(name) {
      if (!name) return false;
      const upper = name.toUpperCase();
      // Direct business keywords
      const bizKeywords = ['LLC', 'INC', 'CORP', 'LTD', 'HOLDINGS', 'REDEVELOPMENT', 'PROPERTIES', 'INVESTMENTS', 'GROUP', 'ASSOCIATION', 'PARTNERS', 'ENTERPRISES', 'BANK', 'MORTGAGE', 'REALTY', 'COMPANY', 'CO\\.', 'SERVICES', 'MANAGEMENT', 'DEVELOPMENT', 'APARTMENTS', 'ASSN', 'FOUNDATION', 'MINISTRY', 'CHURCH', 'SCHOOL', 'UNIVERSITY', 'COLLEGE', 'HOSPITAL', 'CLINIC', 'HOA', 'HOMEOWNERS', 'CONDOMINIUM', 'CONDO ASSOC'];
      if (bizKeywords.some(kw => new RegExp('\\b' + kw + '\\b').test(upper))) return true;
      // Business-like patterns
      const bizPatterns = [
        /\bFLORIDA\s+(COMMUNITY|STATE|CENTRAL)\s+\w+/i, // "FLORIDA COMMUNITY PROPERTY"
        /\b(COUNTY|STATE|CITY)\s+OF\b/i, // Government entities
        /\bTHE\s+\w+\s+(OF|FOR)\b/i, // "THE ESTATE OF", "THE BANK OF"
        /^\d{4}\s+\w+/, // Starts with 4-digit year
        /^(ESTATE|HEIRS)\s+OF\b/i // "ESTATE OF", "HEIRS OF"
      ];
      return bizPatterns.some(p => p.test(upper));
    }

    function standardizeAddress(addr) {
      if (!addr) return '';
      const abbrevs = { 'STREET': 'ST', 'AVENUE': 'AVE', 'DRIVE': 'DR', 'ROAD': 'RD', 'BOULEVARD': 'BLVD', 'LANE': 'LN', 'COURT': 'CT', 'CIRCLE': 'CIR', 'PLACE': 'PL', 'TERRACE': 'TER', 'NORTH': 'N', 'SOUTH': 'S', 'EAST': 'E', 'WEST': 'W', 'NORTHEAST': 'NE', 'NORTHWEST': 'NW', 'SOUTHEAST': 'SE', 'SOUTHWEST': 'SW', 'APARTMENT': 'APT', 'SUITE': 'STE' };
      let result = addr.toUpperCase();
      Object.entries(abbrevs).forEach(([full, abbr]) => {
        result = result.replace(new RegExp('\\b' + full + '\\b', 'g'), abbr);
      });
      return result;
    }

    // Expand common Florida subdivision abbreviations
    function expandSubdivisionAbbrevs(str) {
      if (!str) return '';
      const abbrevs = {
        // Common Florida subdivision abbreviations
        'Brs ': "Bear's ", 'Brs$': "Bear's",
        'Lk ': 'Lake ', 'Lk.': 'Lake', 'Lks ': 'Lakes ',
        'Est ': 'Estates ', 'Est.': 'Estates', 'Ests ': 'Estates ',
        'Hts ': 'Heights ', 'Hts.': 'Heights', 'Hgts ': 'Heights ',
        'Spgs ': 'Springs ', 'Spgs.': 'Springs', 'Sprgs ': 'Springs ', 'Spr ': 'Spring ',
        'Crk ': 'Creek ', 'Crk.': 'Creek', 'Ck ': 'Creek ',
        'Vlg ': 'Village ', 'Vlg.': 'Village', 'Vllg ': 'Village ', 'Vil ': 'Village ',
        'Mnr ': 'Manor ', 'Mnr.': 'Manor',
        'Pnt ': 'Point ', 'Pnt.': 'Point', 'Pt ': 'Point ', 'Pt.': 'Point', 'Pte ': 'Pointe ',
        'Pns ': 'Pines ', 'Pne ': 'Pine ',
        'Gdn ': 'Garden ', 'Gdns ': 'Gardens ',
        'Grv ': 'Grove ', 'Grvs ': 'Groves ',
        'Plc ': 'Place ', 'Plc.': 'Place', 'Pl ': 'Place ',
        'Cir ': 'Circle ', 'Crcl ': 'Circle ',
        'Ter ': 'Terrace ', 'Ter.': 'Terrace',
        'Trce ': 'Trace ', 'Trc ': 'Trace ',
        'Xing ': 'Crossing ', 'Xing.': 'Crossing', 'Crssng ': 'Crossing ',
        'Ldg ': 'Landing ', 'Ldg.': 'Landing', 'Lndg ': 'Landing ',
        'Rdg ': 'Ridge ', 'Rdg.': 'Ridge',
        'Vly ': 'Valley ', 'Vly.': 'Valley', 'Vally ': 'Valley ',
        'Vw ': 'View ', 'Vw.': 'View', 'Vws ': 'Views ',
        'Hls ': 'Hills ', 'Hls.': 'Hills', 'Hl ': 'Hill ', 'Hl.': 'Hill',
        'Rnch ': 'Ranch ', 'Rch ': 'Ranch ',
        'Pln ': 'Plain ', 'Plns ': 'Plains ',
        'Mdw ': 'Meadow ', 'Mdws ': 'Meadows ', 'Mead ': 'Meadow ',
        'Oks ': 'Oaks ', 'Ok ': 'Oak ',
        'Wds ': 'Woods ', 'Wds.': 'Woods', 'Wd ': 'Wood ',
        'Frst ': 'Forest ', 'Fst ': 'Forest ', 'For ': 'Forest ',
        'Pk ': 'Park ', 'Pk.': 'Park', 'Prk ': 'Park ',
        'Ctr ': 'Center ', 'Ctr.': 'Center', 'Cntr ': 'Center ', 'Cen ': 'Center ',
        'Shrs ': 'Shores ', 'Shrs.': 'Shores', 'Shr ': 'Shore ',
        'Bch ': 'Beach ', 'Bch.': 'Beach',
        'Isl ': 'Isle ', 'Isl.': 'Isle', 'Is ': 'Island ', 'Isld ': 'Island ',
        'Twn ': 'Town ', 'Twn.': 'Town',
        'Comm ': 'Commons ', 'Cmns ': 'Commons ',
        'Res ': 'Reserve ', 'Rsrv ': 'Reserve ', 'Rsv ': 'Reserve ',
        'Plnt ': 'Plantation ', 'Plntn ': 'Plantation ', 'Plt ': 'Plantation ',
        // Florida-specific
        'Cov ': 'Cove ', 'Cv ': 'Cove ',
        'Cyp ': 'Cypress ', 'Cypr ': 'Cypress ',
        'Plm ': 'Palm ', 'Plms ': 'Palms ',
        'Pnta ': 'Punta ', 'Pta ': 'Punta ',
        'Boca ': 'Boca ',
        'Cabo ': 'Cabo ',
        'Cayo ': 'Cayo ',
        'Costa ': 'Costa ',
        'Del ': 'Del ',
        'Hmk ': 'Hammock ', 'Hmmck ': 'Hammock ', 'Hmck ': 'Hammock ',
        'Hbr ': 'Harbor ', 'Hrbr ': 'Harbor ', 'Harb ': 'Harbor ',
        'Key ': 'Key ', 'Ky ': 'Key ',
        'Bnd ': 'Bend ',
        'Byp ': 'Bayou ', 'Bay ': 'Bay ',
        'Blf ': 'Bluff ', 'Blfs ': 'Bluffs ',
        'Brk ': 'Brook ', 'Brks ': 'Brooks ',
        'Clf ': 'Cliff ', 'Clfs ': 'Cliffs ',
        'Ct ': 'Court ', 'Cts ': 'Courts ',
        'Cv ': 'Cove ', 'Cvs ': 'Coves ',
        'Dl ': 'Dale ',
        'Fld ': 'Field ', 'Flds ': 'Fields ',
        'Flt ': 'Flat ', 'Flts ': 'Flats ',
        'Gln ': 'Glen ', 'Glns ': 'Glens ',
        'Grn ': 'Green ', 'Grns ': 'Greens ',
        'Hvn ': 'Haven ',
        'Holw ': 'Hollow ', 'Hlw ': 'Hollow ',
        'Inlt ': 'Inlet ',
        'Knl ': 'Knoll ', 'Knls ': 'Knolls ',
        'Lgt ': 'Light ',
        'Lks ': 'Lakes ',
        'Ln ': 'Lane ',
        'Mntn ': 'Mountain ', 'Mtn ': 'Mountain ',
        'Orch ': 'Orchard ',
        'Ovl ': 'Oval ',
        'Pky ': 'Parkway ', 'Pkwy ': 'Parkway ',
        'Pass ': 'Pass ',
        'Pnes ': 'Pines ',
        'Prt ': 'Port ',
        'Rpds ': 'Rapids ',
        'Rvr ': 'River ', 'Riv ': 'River ',
        'Rw ': 'Row ',
        'Smt ': 'Summit ',
        'Sta ': 'Station ',
        'Strm ': 'Stream ',
        'Trl ': 'Trail ', 'Tr ': 'Trail ',
        'Tunl ': 'Tunnel ',
        'Wl ': 'Well ', 'Wls ': 'Wells ',
        'Wy ': 'Way ',
        // Legal/Plat abbreviations
        'Addn ': 'Addition ', 'Add ': 'Addition ',
        'Amd ': 'Amended ', 'Amnd ': 'Amended ',
        'Blk ': 'Block ',
        'Lot ': 'Lot ',
        'Replat ': 'Replat ', 'Rplt ': 'Replat ', 'Rp ': 'Replat ',
        'Sec ': 'Section ', 'Sect ': 'Section ',
        'Sub ': 'Subdivision ', 'Subd ': 'Subdivision ', 'Subdiv ': 'Subdivision ',
        'Un ': 'Unit ', 'Ut ': 'Unit '
      };

      // Build word-level lookup (strip trailing spaces/dots from keys)
      const wordMap = {};
      for (const [abbr, full] of Object.entries(abbrevs)) {
        const key = abbr.replace(/[\s.$]+$/, '').toUpperCase();
        wordMap[key] = full.trim();
      }

      // Replace each word if it matches an abbreviation
      let result = str.replace(/\b([A-Za-z]+)\b/g, (match) => {
        const upper = match.toUpperCase();
        if (wordMap[upper]) {
          // Preserve original casing style (title case)
          const expanded = wordMap[upper];
          return expanded.charAt(0).toUpperCase() + expanded.slice(1).toLowerCase();
        }
        return match;
      });
      return result.trim();
    }

    function toTitleCase(str) {
      if (!str) return '';
      // Fix MC CALL -> MCCALL before processing
      let result = str.replace(/\bMC\s+([A-Z])/gi, 'MC$1');
      result = result.replace(/\bILL\b/gi, 'III').replace(/\bIL\b/gi, 'II');
      result = result.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
      result = result.replace(/\bIi\b/g, 'II').replace(/\bIii\b/g, 'III').replace(/\bIv\b/g, 'IV').replace(/\bVi\b/g, 'VI').replace(/\bVii\b/g, 'VII').replace(/\bViii\b/g, 'VIII');
      result = result.replace(/\bIll\b/g, 'III').replace(/\bIl\b/g, 'II');
      result = result.replace(/\bMc([a-z])/g, (_, c) => 'Mc' + c.toUpperCase());
      result = result.replace(/\bO'([a-z])/g, (_, c) => "O'" + c.toUpperCase());
      // Also fix "Mc Call" -> "McCall" (space after Mc)
      result = result.replace(/\bMc\s+([A-Z])/g, (_, c) => 'Mc' + c);
      return result;
    }

    // Results display
    let isRestoring = false;

    function showResults(stats) {
      document.getElementById('statTotal').textContent = (stats.total || 0).toLocaleString();
      document.getElementById('statMatches').textContent = (stats.matches || results.length).toLocaleString();
      document.getElementById('statDupes').textContent = (stats.dupes || 0).toLocaleString();
      document.getElementById('statBiz').textContent = (stats.biz || 0).toLocaleString();
      document.getElementById('statExcluded').textContent = (stats.excluded || 0).toLocaleString();

      emptyState.style.display = 'none';
      resultsSection.style.display = 'block';

      // Default sort by sale date (oldest first) if not restoring
      if (!isRestoring) {
        sortColumn = 'saleDate';
        sortDir = 1; // 1 = ascending (oldest first)
        results.sort((a, b) => {
          const parseDate = (d) => {
            if (!d) return 0;
            const parts = d.split('/');
            if (parts.length === 3) return new Date(parts[2], parts[0] - 1, parts[1]).getTime() || 0;
            return 0;
          };
          return (parseDate(a.saleDate) - parseDate(b.saleDate)) * sortDir;
        });
      }

      applyFilter();
      generateExportSummary();
      populateQuickStats();

      // Auto-save session so data persists when switching to Identifier (but not when restoring)
      if (!isRestoring) {
        saveSession(stats);
      }
    }

    function populateQuickStats() {
      // Use subdivision-filtered results so stats respect picker selections
      updateSelectedStats();
      document.getElementById('quickStatsCard').style.display = 'block';
    }

    // IndexedDB helpers for large dataset persistence (localStorage caps at ~5MB)
    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open('PoolScraperDB', 1);
        req.onupgradeneeded = () => req.result.createObjectStore('sessions');
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function saveToIDB(data) {
      try {
        const db = await openDB();
        const tx = db.transaction('sessions', 'readwrite');
        tx.objectStore('sessions').put(data, 'current');
        await new Promise((res, rej) => { tx.oncomplete = res; tx.onerror = rej; });
        db.close();
      } catch (e) { console.warn('[scraper] IDB save:', e.message); }
    }
    async function loadFromIDB() {
      try {
        const db = await openDB();
        const tx = db.transaction('sessions', 'readonly');
        const req = tx.objectStore('sessions').get('current');
        const result = await new Promise((res, rej) => { req.onsuccess = () => res(req.result); req.onerror = rej; });
        db.close();
        return result || null;
      } catch (e) { console.warn('[scraper] IDB load:', e.message); return null; }
    }

    // Save session data to localStorage + IndexedDB
    function saveSession(stats) {
      if (results.length === 0) return;

      try {
        // Only save essential fields to reduce size
        const slimResults = results.map(r => ({
          recipient: r.recipient,
          company: r.company,
          address: r.address,
          city: r.city,
          state: r.state,
          zipcode: r.zipcode,
          propertyValue: r.propertyValue,
          yearBuilt: r.yearBuilt,
          poolAge: r.poolAge,
          propertyType: r.propertyType,
          saleDate: r.saleDate,
          daysSinceSale: r.daysSinceSale,
          isAbsentee: r.isAbsentee,
          propertyAddress: r.propertyAddress || '',
          mailingAddress: r.mailingAddress || '',
          subdivision: r.subdivision,
          lotSize: r.lotSize || 0,
          livingArea: r.livingArea || 0,
          triggers: r.triggers || [],
          flags: r.flags || [],
          notes: r.notes
        }));

        const session = {
          results: slimResults,
          stats: stats || { total: 0, matches: results.length, dupes: 0, biz: 0, excluded: 0 },
          timestamp: new Date().toISOString(),
          cityFilter: currentCityFilter || null,
          zipFilter: currentZipFilter || null,
          activeFilter: currentFilter || 'all'
        };

        const sessionJson = JSON.stringify(session);
        localStorage.setItem('poolscraper_session', sessionJson);
        sessionStorage.setItem('poolscraper_session', sessionJson);
        // Also save to IndexedDB for large datasets
        saveToIDB(session);
      } catch (e) {
        // localStorage full ‚Äî save full dataset to IndexedDB (no size limit)
        if (e.name === 'QuotaExceededError') {
          const historyBackup = localStorage.getItem('poolscraper_history');
          localStorage.removeItem('poolscraper_history');
          try {
            const partialSession = JSON.stringify({
              results: results.slice(0, MAX_LOCALSTORAGE_RECORDS),
              stats: stats,
              timestamp: new Date().toISOString()
            });
            localStorage.setItem('poolscraper_session', partialSession);
            sessionStorage.setItem('poolscraper_session', partialSession);
            showToast('Large dataset ‚Äî saved to IndexedDB + partial localStorage');
          } catch (e2) {
            if (historyBackup) {
              try { localStorage.setItem('poolscraper_history', historyBackup); } catch (_) { /* truly full */ }
            }
            showToast('Saved to IndexedDB (localStorage full)');
          }
        }
      }
    }

    // Apply a parsed session object to app state
    function applySession(session, source) {
      if (!session || !session.results || session.results.length === 0) return false;
      isRestoring = true;
      results = session.results;

      let bizCount = 0;
      results.forEach(r => {
        if (!r.flags) {
          r.flags = [];
          const isBusiness = isBusinessName(r.company || r.recipient);
          if (isBusiness) { r.flags.push('BIZ'); bizCount++; }
          if (r.isAbsentee) r.flags.push('ABSENTEE');
        } else if (r.flags.includes('BIZ')) { bizCount++; }
      });

      currentCityFilter = session.cityFilter || null;
      currentZipFilter = session.zipFilter || null;
      currentFilter = session.activeFilter || 'all';
      filteredResults = [...results];
      const stats = session.stats || { total: 0, matches: results.length, dupes: 0, biz: bizCount, excluded: 0 };
      if (!session.results[0]?.flags) stats.biz = bizCount;
      showResults(stats);
      showToast(`Restored ${results.length} records (${source})`);
      isRestoring = false;
      return true;
    }

    // Restore session: sessionStorage ‚Üí localStorage ‚Üí IndexedDB
    async function restoreSession() {
      // Try sync sources first
      let saved = sessionStorage.getItem('poolscraper_session');
      let source = 'session';
      if (!saved) {
        saved = localStorage.getItem('poolscraper_session');
        source = 'local';
      }

      if (saved) {
        try {
          if (applySession(JSON.parse(saved), source)) return true;
        } catch (e) {
          console.warn('[scraper] sync restore failed:', e.message);
        }
      }

      // Fall back to IndexedDB for large datasets
      try {
        const idbSession = await loadFromIDB();
        if (idbSession && applySession(idbSession, 'IndexedDB')) return true;
      } catch (e) {
        console.warn('[scraper] IDB restore failed:', e.message);
      }

      return false;
    }

    // Clear session when clearing all (from both storages)
    function clearSession() {
      localStorage.removeItem('poolscraper_session');
      sessionStorage.removeItem('poolscraper_session');
      document.getElementById('sessionStatus').textContent = '';
    }

    function generateExportSummary() {
      const cityCounts = {};
      const zipCounts = {};

      results.forEach(r => {
        const city = r.city || 'Unknown';
        const zip = r.zipcode ? r.zipcode.substring(0, 5) : 'Unknown';
        cityCounts[city] = (cityCounts[city] || 0) + 1;
        zipCounts[zip] = (zipCounts[zip] || 0) + 1;
      });

      const sortedCities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]);
      const sortedZips = Object.entries(zipCounts).sort((a, b) => b[1] - a[1]);

      document.getElementById('citySummary').innerHTML = '<span class="loc-chip" onclick="filterByCity(null)">All</span> ' +
        sortedCities.slice(0, 12).map(([city, count]) => `<span class="loc-chip" onclick="filterByCity('${escapeHtml(city)}')">${escapeHtml(city)}: ${count}</span>`).join(' ');

      document.getElementById('zipSummary').innerHTML = '<span class="loc-chip" onclick="filterByZip(null)">All</span> ' +
        sortedZips.slice(0, 12).map(([zip, count]) => `<span class="loc-chip" onclick="filterByZip('${escapeHtml(zip)}')">${escapeHtml(zip)}: ${count}</span>`).join(' ');

      document.getElementById('exportSummary').style.display = 'block';

      // Populate subdivision picker
      populateSubdivPicker();
    }

    function filterByZip(zip) {
      currentZipFilter = zip;
      currentCityFilter = null;
      applyFilter();
      if (zip) showToast(`Filtered to ${zip}`);
    }

    function filterByCity(city) {
      currentCityFilter = city;
      currentZipFilter = null;
      applyFilter();
      if (city) showToast(`Filtered to ${city}`);
    }

    function filterTable() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      applyFilter(query);
    }

    function applyFilter(searchQuery = '') {
      filteredResults = results.filter(r => {
        if (currentZipFilter && r.zipcode !== currentZipFilter) return false;
        if (currentCityFilter && r.city.toUpperCase() !== currentCityFilter.toUpperCase()) return false;
        if (searchQuery) {
          const searchStr = `${r.recipient} ${r.address} ${r.propertyAddress || ''} ${r.mailingAddress || ''} ${r.city} ${r.zipcode} ${r.subdivision || ''} ${r.notes || ''}`.toLowerCase();
          if (!searchStr.includes(searchQuery)) return false;
        }
        if (currentFilter === 'residential' && r.flags.includes('BIZ')) return false;
        if (currentFilter === 'business' && !r.flags.includes('BIZ')) return false;
        if (currentFilter === 'absentee' && !r.isAbsentee) return false;
        if (currentFilter === 'owner' && r.isAbsentee) return false;
        if (currentFilter === 'triggered' && (!r.triggers || r.triggers.length === 0)) return false;
        return true;
      });

      currentPage = 1; // Reset to first page when filtering
      renderTable();

      const info = document.getElementById('tableInfo');
      let filterText = `Showing ${filteredResults.length.toLocaleString()} of ${results.length.toLocaleString()}`;
      if (currentZipFilter) filterText += ` in ${currentZipFilter}`;
      if (currentCityFilter) filterText += ` in ${currentCityFilter}`;
      info.textContent = filterText;

      updateExportPreview();
      populateSubdivPicker();
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      document.querySelector(`.chip[onclick="setFilter('${filter}')"]`)?.classList.add('active');
      applyFilter(document.getElementById('searchInput').value.toLowerCase());
    }

    function renderTable() {
      // Refresh verifier status on each render
      try { verifierStatus = JSON.parse(localStorage.getItem('poolVerifierData') || '{}'); } catch (e) { console.warn('[scraper] verifier refresh:', e.message); }
      // Use subdivision-filtered view so table reflects picker selections
      const displayResults = getSubdivFilteredResults();
      // Calculate pagination
      totalPages = Math.ceil(displayResults.length / perPage) || 1;
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      const startIdx = (currentPage - 1) * perPage;
      const endIdx = startIdx + perPage;
      const pageResults = displayResults.slice(startIdx, endIdx);

      // Pre-build reference map for O(1) index lookup
      const filteredIdxMap = new Map();
      filteredResults.forEach((r, idx) => filteredIdxMap.set(r, idx));

      tableBody.innerHTML = pageResults.map((r, i) => {
        const globalIdx = filteredIdxMap.get(r) ?? -1; // O(1) lookup for edit/delete
        const key = `${r.address}|${r.city}|${r.zipcode}`.toUpperCase();
        const tracker = mailedTracker[key];
        const mailCount = tracker ? tracker.count : 0;
        const mailColor = mailCount >= 7 ? '#f59e0b' : mailCount >= 3 ? '#22c55e' : mailCount > 0 ? '#60a5fa' : '#555';
        // Check verifier status
        const vKey = `${r.address}, ${r.city}, ${r.state || ''} ${r.zipcode}`.toUpperCase().replace(/[^A-Z0-9]/g, '');
        const vStatus = verifierStatus[vKey];
        const vBadge = vStatus ? (vStatus.status === VERIFY_STATUS.VERIFIED ? '<span style="font-size:9px;padding:1px 4px;border-radius:3px;background:#22c55e;color:#000;font-weight:600;margin-left:4px;">‚úì Pool</span>' : vStatus.status === VERIFY_STATUS.NO_POOL ? '<span style="font-size:9px;padding:1px 4px;border-radius:3px;background:#ef4444;color:#fff;font-weight:600;margin-left:4px;">‚úó No Pool</span>' : '') : '';

        return `<tr>
          <td><button class="row-btn" onclick="openEditModal(${globalIdx})">‚úèÔ∏è</button> <button class="row-btn danger" onclick="removeRow(${globalIdx})">üóëÔ∏è</button></td>
          <td title="${escapeHtml(r.recipient || 'Current Resident')}">${escapeHtml(r.recipient || 'Current Resident')}${vBadge}</td>
          <td title="${escapeHtml(r.propertyAddress || '')}">${r.validated !== undefined ? (r.validated ? '<span style="color:#22c55e">‚úì</span> ' : '<span style="color:#ef4444">‚úó</span> ') : ''}${escapeHtml(r.propertyAddress || '')}</td>
          <td title="${escapeHtml(r.mailingAddress || '')}">${escapeHtml(r.mailingAddress || '')}</td>
          <td>${escapeHtml(r.city)}</td>
          <td>${escapeHtml(r.state || '')}</td>
          <td>${escapeHtml(r.zipcode)}</td>
          <td>${escapeHtml(r.propertyValue || '')}</td>
          <td title="${escapeHtml(r.subdivision || '')}">${escapeHtml((r.subdivision || '').substring(0, 20))}</td>
          <td title="${escapeHtml((r.triggers || []).join(', '))}">${(r.triggers || []).length > 0 ? '<span style="color:#f59e0b;">‚ö°</span> ' + escapeHtml((r.triggers || []).join(', ').substring(0, 30)) : ''}</td>
          <td>${r.poolAge ? r.poolAge + 'y' : ''}</td>
          <td title="${escapeHtml(r.saleDate || '')}">${r.daysSinceSale !== null ? (r.daysSinceSale < 365 ? r.daysSinceSale + 'd' : Math.floor(r.daysSinceSale/365) + 'y') : escapeHtml(r.saleDate || '')}</td>
          <td><span class="badge ${r.isAbsentee ? 'badge-orange' : 'badge-green'}" style="cursor:pointer;" onclick="toggleAbsentee(${globalIdx})" title="Click to toggle">${r.isAbsentee ? 'Absent' : 'Owner'}</span></td>
          <td style="text-align:center; color:${mailColor}; font-weight:${mailCount > 0 ? 'bold' : 'normal'};">${mailCount > 0 ? mailCount + 'x' : '-'}</td>
          <td><input type="text" class="note-input" value="${escapeHtml(r.notes || '')}" onchange="updateNote(${globalIdx}, this.value)" placeholder="..."></td>
        </tr>`;
      }).join('');

      // Update pagination controls
      updatePaginationControls();
    }

    function updatePaginationControls() {
      document.getElementById('pageInput').value = currentPage;
      document.getElementById('pageInput').max = totalPages;
      document.getElementById('totalPages').textContent = totalPages;
      document.getElementById('btnFirst').disabled = currentPage <= 1;
      document.getElementById('btnPrev').disabled = currentPage <= 1;
      document.getElementById('btnNext').disabled = currentPage >= totalPages;
      document.getElementById('btnLast').disabled = currentPage >= totalPages;
    }

    function goToPage(page) {
      page = parseInt(page) || 1;
      if (page < 1) page = 1;
      if (page > totalPages) page = totalPages;
      currentPage = page;
      renderTable();
      // Scroll to top of table
      document.querySelector('.table-wrap')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function changePerPage(value) {
      perPage = parseInt(value) || 100;
      currentPage = 1; // Reset to first page
      renderTable();
    }

    function updateNote(index, note) {
      if (filteredResults[index]) {
        filteredResults[index].notes = note;
        const original = results.find(r => r.address === filteredResults[index].address && r.zipcode === filteredResults[index].zipcode);
        if (original) original.notes = note;
      }
    }

    // Pagination
    let currentPage = 1;
    let perPage = 100;
    let totalPages = 1;

    // Sorting
    let sortColumn = null;
    let sortDir = 1;

    function sortTable(column) {
      if (sortColumn === column) sortDir *= -1;
      else { sortColumn = column; sortDir = 1; }

      // Define column types for proper sorting
      const numericColumns = ['poolAge', 'yearBuilt', 'propertyValue', 'assessedValue', 'mailCount', 'daysSinceSale', 'lotSize', 'livingArea'];
      const dateColumns = ['saleDate'];
      const alphaColumns = ['recipient', 'company', 'propertyAddress', 'mailingAddress', 'city', 'state', 'subdivision', 'propertyType', 'notes'];

      filteredResults.sort((a, b) => {
        // Special handling for mail count (computed field)
        if (column === 'mailCount') {
          const aKey = `${a.address}|${a.city}|${a.zipcode}`.toUpperCase();
          const bKey = `${b.address}|${b.city}|${b.zipcode}`.toUpperCase();
          return ((mailedTracker[aKey]?.count || 0) - (mailedTracker[bKey]?.count || 0)) * sortDir;
        }

        let aVal = a[column];
        let bVal = b[column];

        // Handle null/undefined - push to end
        if (aVal == null || aVal === '') aVal = '';
        if (bVal == null || bVal === '') bVal = '';

        // Date columns - sort chronologically
        if (dateColumns.includes(column)) {
          const parseDate = (d) => {
            if (!d) return 0;
            let str = String(d).trim();

            // Strip time portion if present (e.g., "2/1/1995 12:00:00 AM" -> "2/1/1995")
            const spaceIdx = str.indexOf(' ');
            if (spaceIdx > 0) str = str.substring(0, spaceIdx);

            // Try MM/DD/YYYY format
            const slashParts = str.split('/');
            if (slashParts.length === 3) {
              const [m, day, y] = slashParts;
              const year = y.length === 2 ? (parseInt(y) > 50 ? '19' + y : '20' + y) : y;
              return new Date(parseInt(year), parseInt(m) - 1, parseInt(day)).getTime() || 0;
            }

            // Try YYYY-MM-DD format
            const dashParts = str.split('-');
            if (dashParts.length === 3 && dashParts[0].length === 4) {
              return new Date(dashParts[0], parseInt(dashParts[1]) - 1, parseInt(dashParts[2])).getTime() || 0;
            }

            // Try YYYYMMDD format (8 digits)
            const digits = str.replace(/[^\d]/g, '');
            if (digits.length === 8) {
              if (digits.startsWith('19') || digits.startsWith('20')) {
                // YYYYMMDD
                return new Date(digits.slice(0,4), parseInt(digits.slice(4,6)) - 1, parseInt(digits.slice(6,8))).getTime() || 0;
              } else {
                // MMDDYYYY
                return new Date(digits.slice(4,8), parseInt(digits.slice(0,2)) - 1, parseInt(digits.slice(2,4))).getTime() || 0;
              }
            }

            // Try native Date parse as fallback
            const parsed = Date.parse(str);
            return isNaN(parsed) ? 0 : parsed;
          };

          const aDate = parseDate(aVal);
          const bDate = parseDate(bVal);

          // Push empty dates to end
          if (aDate === 0 && bDate === 0) return 0;
          if (aDate === 0) return sortDir; // a goes to end
          if (bDate === 0) return -sortDir; // b goes to end

          return (aDate - bDate) * sortDir;
        }

        // Numeric columns - sort numerically
        if (numericColumns.includes(column)) {
          const aNum = parseFloat(String(aVal).replace(/[^0-9.-]/g, '')) || 0;
          const bNum = parseFloat(String(bVal).replace(/[^0-9.-]/g, '')) || 0;
          return (aNum - bNum) * sortDir;
        }

        // Zipcode - sort numerically (it's a number even though stored as string)
        if (column === 'zipcode') {
          const aNum = parseInt(String(aVal).replace(/[^0-9]/g, '')) || 0;
          const bNum = parseInt(String(bVal).replace(/[^0-9]/g, '')) || 0;
          return (aNum - bNum) * sortDir;
        }

        // Boolean columns (isAbsentee)
        if (column === 'isAbsentee') {
          return ((a.isAbsentee ? 1 : 0) - (b.isAbsentee ? 1 : 0)) * sortDir;
        }

        // Alphabetical columns - sort alphabetically (case-insensitive)
        return String(aVal).toLowerCase().localeCompare(String(bVal).toLowerCase()) * sortDir;
      });

      renderTable();
    }

    // Edit modal
    function openEditModal(index) {
      editingIndex = index;
      const r = filteredResults[index];
      document.getElementById('editRecipient').value = r.recipient || 'Current Resident';
      document.getElementById('editCompany').value = r.company;
      document.getElementById('editAddress').value = r.address;
      document.getElementById('editCity').value = r.city;
      document.getElementById('editState').value = r.state;
      document.getElementById('editZipcode').value = r.zipcode;
      document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      editingIndex = -1;
    }

    function saveEdit() {
      if (editingIndex < 0) return;
      const r = filteredResults[editingIndex];
      r.recipient = document.getElementById('editRecipient').value;
      r.company = document.getElementById('editCompany').value;
      r.address = document.getElementById('editAddress').value;
      r.city = document.getElementById('editCity').value;
      r.state = document.getElementById('editState').value;
      r.zipcode = document.getElementById('editZipcode').value;
      // Sync edit back to main results array
      const orig = results.find(o => o === r) || results.find(o => o.address === r.address && o.zipcode === r.zipcode);
      if (orig && orig !== r) {
        orig.recipient = r.recipient; orig.company = r.company;
        orig.address = r.address; orig.city = r.city;
        orig.state = r.state; orig.zipcode = r.zipcode;
      }
      closeEditModal();
      renderTable();
      showToast('Record updated');
    }

    function toggleAbsentee(i) {
      const r = filteredResults[i];
      r.isAbsentee = !r.isAbsentee;
      // Also update in main results array
      const orig = results.find(o => o.address === r.address && o.zipcode === r.zipcode);
      if (orig) orig.isAbsentee = r.isAbsentee;
      renderTable();
      showToast(`${r.recipient || 'Record'} ‚Üí ${r.isAbsentee ? 'Absent' : 'Owner'}`);
    }

    function removeRow(i) {
      const removed = filteredResults[i];
      const idx = results.indexOf(removed);
      if (idx >= 0) results.splice(idx, 1);
      filteredResults.splice(i, 1);
      renderTable();
      document.getElementById('statMatches').textContent = results.length.toLocaleString();
    }

    // Quick VistaPrint export ‚Äî one click, 6 columns, skip mailed
    function quickVistaPrintExport() {
      // Get records from selected subdivisions, skip already-mailed
      const exportable = getSubdivFilteredResults().filter(r => {
        const key = `${r.address}|${r.city}|${r.zipcode}`.toUpperCase();
        return !mailedTracker[key];
      });

      if (exportable.length === 0) {
        showToast('No unmailed addresses to export', 'error');
        return;
      }

      const headers = ['Recipient', 'Company', 'Address', 'City', 'State', 'Zipcode'];
      const rows = exportable.map(r => [
        `"${csvSafe(r.recipient || 'Current Resident')}"`,
        `"${csvSafe(r.company || '')}"`,
        `"${csvSafe(r.address || '')}"`,
        `"${csvSafe(r.city || '')}"`,
        `"${csvSafe(r.state || '')}"`,
        `"${csvSafe(r.zipcode || '')}"`
      ].join(','));
      const csv = [headers.join(','), ...rows].join('\n');

      // Auto-name with top subdivision
      const subdivCounts = {};
      exportable.forEach(r => {
        const s = (r.subdivision || '').trim();
        if (s) subdivCounts[s] = (subdivCounts[s] || 0) + 1;
      });
      const topSubdiv = Object.entries(subdivCounts).sort((a, b) => b[1] - a[1])[0];
      const subdivName = topSubdiv ? topSubdiv[0].replace(/\s+/g, '_') : 'Mixed';
      const date = new Date().toISOString().slice(0, 10);
      const fileName = `VistaPrint_${subdivName}_${exportable.length}_${date}.csv`;

      downloadFile(csv, fileName);

      // Log to history with subdivision info
      const subdivList = Object.entries(subdivCounts).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([n, c]) => `${n} (${c})`);
      addToHistory(exportable.length, 'VistaPrint', subdivList, fileName);
      showToast(`Exported ${exportable.length} addresses for VistaPrint ‚Üí ${fileName}`);
    }

    // Export functions - VistaPrint format
    function generateCSV(data) {
      const headers = ['Recipient', 'Company', 'Address', 'City', 'State', 'Zipcode', 'Subdivision', 'Type', 'Value', 'Lot SqFt', 'Living SqFt', 'Pool Age', 'Sale Date', 'Days Since Sale', 'Triggers'];
      const rows = data.map(r => {
        return [
          `"${csvSafe(r.recipient || 'Current Resident')}"`,
          `"${csvSafe(r.company || '')}"`,
          `"${csvSafe(r.address || '')}"`,
          `"${csvSafe(r.city || '')}"`,
          `"${csvSafe(r.state || '')}"`,
          `"${csvSafe(r.zipcode || '')}"`,
          `"${csvSafe(r.subdivision || '')}"`,
          `"${r.isAbsentee ? 'Absentee' : 'Owner'}"`,
          `"${csvSafe(r.propertyValue || '')}"`,
          `"${r.lotSize || ''}"`,
          `"${r.livingArea || ''}"`,
          `"${r.poolAge || ''}"`,
          `"${csvSafe(r.saleDate || '')}"`,
          `"${r.daysSinceSale !== null ? r.daysSinceSale : ''}"`,
          `"${csvSafe((r.triggers || []).join('; '))}"`
        ].join(',');
      });
      return [headers.join(','), ...rows].join('\n');
    }

    function getExportCount() {
      const select = document.getElementById('exportCount');
      const customInput = document.getElementById('customExportCount');
      if (select.value === 'custom') return parseInt(customInput.value) || 0;
      return parseInt(select.value) || 0;
    }

    function getSubdivFilteredResults() {
      if (selectedSubdivisions.size === 0) return filteredResults;
      return filteredResults.filter(r => {
        const sub = (r.subdivision || '').trim();
        return sub && selectedSubdivisions.has(sub);
      });
    }

    function getExportableRecords() {
      const skipMailed = document.getElementById('skipExported').checked;
      const includeRecycle = document.getElementById('includeRecycle').checked;
      const recycleDays = parseInt(document.getElementById('recycleDays').value) || DEFAULT_RECYCLE_DAYS;
      let exportable = getSubdivFilteredResults();

      if (skipMailed) {
        exportable = exportable.filter(r => {
          const key = `${r.address}|${r.city}|${r.zipcode}`.toUpperCase();
          const tracker = mailedTracker[key];
          if (!tracker) return true;
          if (includeRecycle) {
            const daysSince = Math.floor((new Date() - new Date(tracker.lastMailed)) / (1000 * 60 * 60 * 24));
            return daysSince >= recycleDays;
          }
          return false;
        });
      }

      // Prepend deferred records from last batch so they go out first
      try {
        const deferredData = JSON.parse(localStorage.getItem('poolscraper_deferred') || 'null');
        if (deferredData && Array.isArray(deferredData.records) && deferredData.records.length > 0) {
          const deferredKeys = new Set(deferredData.records.map(r => `${r.address}|${r.city}|${r.zipcode}`.toUpperCase()));
          // Remove deferred from the main list to avoid duplicates, then prepend
          const withoutDeferred = exportable.filter(r => !deferredKeys.has(`${r.address}|${r.city}|${r.zipcode}`.toUpperCase()));
          exportable = [...deferredData.records, ...withoutDeferred];
        }
      } catch (e) { console.warn('[scraper] deferred load:', e.message); }

      const count = getExportCount();
      if (count > 0) exportable = exportable.slice(0, count);
      return exportable;
    }

    // Returns records that didn't make the export count cut
    function getDeferredRecords() {
      const skipMailed = document.getElementById('skipExported').checked;
      const includeRecycle = document.getElementById('includeRecycle').checked;
      const recycleDays = parseInt(document.getElementById('recycleDays').value) || DEFAULT_RECYCLE_DAYS;
      let exportable = getSubdivFilteredResults();

      if (skipMailed) {
        exportable = exportable.filter(r => {
          const key = `${r.address}|${r.city}|${r.zipcode}`.toUpperCase();
          const tracker = mailedTracker[key];
          if (!tracker) return true;
          if (includeRecycle) {
            const daysSince = Math.floor((new Date() - new Date(tracker.lastMailed)) / (1000 * 60 * 60 * 24));
            return daysSince >= recycleDays;
          }
          return false;
        });
      }

      const count = getExportCount();
      if (count > 0 && exportable.length > count) {
        return exportable.slice(count);
      }
      return [];
    }

    // Save deferred records and show report after send/export
    function trackDeferredAfterExport() {
      const deferred = getDeferredRecords();
      if (deferred.length === 0) {
        localStorage.removeItem('poolscraper_deferred');
        return;
      }
      try {
        localStorage.setItem('poolscraper_deferred', JSON.stringify({
          records: deferred,
          timestamp: new Date().toISOString(),
          count: deferred.length
        }));
      } catch (e) { console.warn('[scraper] deferred save:', e.message); }

      const subdivCounts = {};
      deferred.forEach(r => {
        const sub = (r.subdivision || 'Unknown').trim();
        subdivCounts[sub] = (subdivCounts[sub] || 0) + 1;
      });
      const breakdown = Object.entries(subdivCounts).map(([s, c]) => `${s}: ${c}`).join(', ');
      showToast(`${deferred.length} addresses deferred to next batch (${breakdown})`, 0);
    }

    function updateExportPreview() {
      const exportable = getExportableRecords();
      const deferred = getDeferredRecords();
      let text = exportable.length.toLocaleString();
      if (deferred.length > 0) text += ` (+${deferred.length} deferred)`;
      document.getElementById('exportPreviewCount').textContent = text;
    }

    function downloadCSV() {
      const exportable = getExportableRecords();
      if (exportable.length === 0) { showToast('No data to export'); return; }

      let filename = 'mailing_list';
      if (currentCityFilter) filename += `_${currentCityFilter.replace(/\s+/g, '_')}`;
      if (currentZipFilter) filename += `_${currentZipFilter}`;
      filename += `_${exportable.length}_${new Date().toISOString().slice(0,10)}.csv`;

      const csv = generateCSV(exportable);
      downloadFile(csv, filename);
      addToHistory(exportable.length);
      const addedCount = addToMailedList(exportable);
      showToast(`Exported ${exportable.length} records`);
      trackDeferredAfterExport();
      updateExportPreview();
    }

    function downloadAllCSV() {
      if (results.length === 0) { showToast('No data'); return; }
      const csv = generateCSV(results);
      downloadFile(csv, `mailing_list_ALL_${new Date().toISOString().slice(0,10)}.csv`);
      addToHistory(results.length);
      addToMailedList(results);
      showToast(`Exported ${results.length} records`);
    }

    function exportRecyclable() {
      const recycleDays = parseInt(document.getElementById('recycleDays').value) || 30;
      const count = getExportCount();

      let recyclable = filteredResults.filter(r => {
        const key = `${r.address}|${r.city}|${r.zipcode}`.toUpperCase();
        const tracker = mailedTracker[key];
        if (!tracker) return false;
        const daysSince = Math.floor((new Date() - new Date(tracker.lastMailed)) / (1000 * 60 * 60 * 24));
        return daysSince >= recycleDays;
      });

      if (recyclable.length === 0) { showToast(`No recyclable addresses (${recycleDays}+ days)`); return; }
      if (count > 0) recyclable = recyclable.slice(0, count);

      const csv = generateCSV(recyclable);
      downloadFile(csv, `recycle_${recyclable.length}_${new Date().toISOString().slice(0,10)}.csv`);
      addToHistory(recyclable.length, 'Recycle');
      addToMailedList(recyclable);
      showToast(`Exported ${recyclable.length} recyclable records`);
      updateExportPreview();
    }

    function downloadFile(content, filename) {
      const blob = new Blob([content], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function copyCSV() {
      const exportable = getExportableRecords();
      if (exportable.length === 0) { showToast('No data'); return; }
      const csv = generateCSV(exportable);
      navigator.clipboard.writeText(csv).then(() => showToast(`Copied ${exportable.length} records`));
    }

    function exportLabels() {
      const exportable = getExportableRecords();
      if (exportable.length === 0) { showToast('No data'); return; }

      let html = `<!DOCTYPE html><html><head><title>Labels</title><style>
        @page { margin: 0.5in 0.1875in; size: letter; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; font-size: 10pt; }
        .page { page-break-after: always; }
        .label-row { display: flex; }
        .label { width: 2.625in; height: 1in; padding: 0.1in; display: flex; flex-direction: column; justify-content: center; }
        .label-name { font-weight: bold; font-size: 10pt; }
        .label-addr { font-size: 9pt; }
        @media print { .no-print { display: none; } }
      </style></head><body>
      <div class="no-print" style="padding:20px; background:#eee; margin-bottom:20px;">
        <h2>Print Labels (${exportable.length})</h2>
        <p>Set margins to None, disable headers/footers</p>
        <button onclick="window.print()" style="padding:10px 20px; margin-top:10px;">Print</button>
      </div>`;

      let labelCount = 0;
      let rowLabels = [];

      for (const r of exportable) {
        if (labelCount % 30 === 0 && labelCount > 0) html += '</div>';
        if (labelCount % 30 === 0) html += '<div class="page">';

        rowLabels.push(`<div class="label"><div class="label-name">${escapeHtml(r.recipient || 'Current Resident')}</div><div class="label-addr">${escapeHtml(r.address)}</div><div class="label-addr">${escapeHtml(r.city)}, ${escapeHtml(r.state)} ${escapeHtml(r.zipcode)}</div></div>`);

        if (rowLabels.length === 3) {
          html += '<div class="label-row">' + rowLabels.join('') + '</div>';
          rowLabels = [];
        }
        labelCount++;
      }

      if (rowLabels.length > 0) {
        while (rowLabels.length < 3) rowLabels.push('<div class="label"></div>');
        html += '<div class="label-row">' + rowLabels.join('') + '</div>';
      }

      html += '</div></body></html>';

      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showToast('Popup blocked - please allow popups');
        return;
      }
      printWindow.document.open();
      printWindow.document.write(html);
      printWindow.document.close();

      addToHistory(exportable.length, 'Labels');
      addToMailedList(exportable);
      showToast(`Generated ${exportable.length} labels`);
      updateExportPreview();
    }

    // ‚îÄ‚îÄ Geo-sorted walking route ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function loadGeoCache() {
      try {
        const raw = JSON.parse(localStorage.getItem('poolscraper_geoCache') || '{}');
        // Invalidate entries older than TTL
        if (raw._timestamp && (Date.now() - raw._timestamp > GEOCACHE_TTL_MS)) {
          localStorage.removeItem('poolscraper_geoCache');
          return {};
        }
        return raw;
      } catch { return {}; }
    }
    function saveGeoCache(cache) {
      cache._timestamp = Date.now();
      try { localStorage.setItem('poolscraper_geoCache', JSON.stringify(cache)); }
      catch (e) { console.warn('Geo cache save failed:', e); }
    }
    function clearGeoCache() {
      localStorage.removeItem('poolscraper_geoCache');
      showToast('Geo cache cleared ‚Äî next sort will re-geocode');
    }
    function geoCacheKey(subdiv, city) {
      return `${(subdiv || '').toUpperCase().trim()}|${(city || '').toUpperCase().trim()}`;
    }

    async function geocodeSingleAddress(record) {
      const street = (record.propertyAddress || record.address || '').replace(/[#,]/g, '').trim();
      const city = (record.city || '').trim();
      const state = (record.state || 'FL').trim();
      if (!street || !city) return null;
      const params = new URLSearchParams({
        street, city, state, benchmark: 'Public_AR_Current', format: 'json'
      });
      const resp = await fetch(`https://geocoding.geo.census.gov/geocoder/locations/address?${params}`);
      if (!resp.ok) return null;
      const data = await resp.json();
      const match = data.result?.addressMatches?.[0];
      if (!match?.coordinates?.x || !match?.coordinates?.y) return null;
      return { lat: match.coordinates.y, lng: match.coordinates.x };
    }

    function haversineDistance(lat1, lng1, lat2, lng2) {
      const R = EARTH_RADIUS_KM;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLng / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function buildNearestNeighborChain(geoItems) {
      if (geoItems.length <= 1) return geoItems.map(g => g.name);
      const valid = geoItems.filter(g => g.lat != null && g.lng != null);
      const noGeo = geoItems.filter(g => g.lat == null || g.lng == null).map(g => g.name);
      if (valid.length === 0) return geoItems.map(g => g.name);

      const visited = new Set();
      const chain = [];
      let cur = valid[0];
      chain.push(cur.name);
      visited.add(cur.name);

      while (chain.length < valid.length) {
        let best = null, bestDist = Infinity;
        for (const c of valid) {
          if (visited.has(c.name)) continue;
          const d = haversineDistance(cur.lat, cur.lng, c.lat, c.lng);
          if (d < bestDist) { bestDist = d; best = c; }
        }
        if (!best) break;
        chain.push(best.name);
        visited.add(best.name);
        cur = best;
      }
      return chain.concat(noGeo);
    }

    function sortByRouteAlphabetical() {
      filteredResults.sort((a, b) => {
        const sa = (a.subdivision || '').toLowerCase(), sb = (b.subdivision || '').toLowerCase();
        if (sa !== sb) return sa.localeCompare(sb);
        const za = (a.zipcode || '').substring(0, 5), zb = (b.zipcode || '').substring(0, 5);
        if (za !== zb) return za.localeCompare(zb);
        const stA = (a.address || '').replace(/^\d+\s*/, '').toLowerCase();
        const stB = (b.address || '').replace(/^\d+\s*/, '').toLowerCase();
        if (stA !== stB) return stA.localeCompare(stB);
        return parseInt((a.address || '').match(/^\d+/)?.[0] || '0') -
               parseInt((b.address || '').match(/^\d+/)?.[0] || '0');
      });
    }

    async function sortByRoute() {
      const routeSource = getSubdivFilteredResults();
      if (routeSource.length === 0) { showToast('No data'); return; }

      // Extract unique subdivisions with a representative record
      const subdivMap = new Map();
      for (const r of routeSource) {
        const name = (r.subdivision || 'UNKNOWN').trim();
        if (!subdivMap.has(name)) subdivMap.set(name, r);
      }
      const subdivs = Array.from(subdivMap.entries()).map(([name, rec]) => ({ name, rec }));
      const total = subdivs.length;

      if (total <= 1) {
        sortByRouteAlphabetical();
        renderTable();
        showToast('Sorted (single subdivision)');
        return;
      }

      showToast(`Geocoding ${total} subdivisions...`, 0);

      try {
        const cache = loadGeoCache();
        let geocoded = 0;

        for (let i = 0; i < subdivs.length; i++) {
          const { name, rec } = subdivs[i];
          const key = geoCacheKey(name, rec.city);
          if (cache[key]) { geocoded++; continue; }

          showToast(`Geocoding (${i + 1}/${total}): ${name.substring(0, 30)}`, 0);
          try {
            const geo = await geocodeSingleAddress(rec);
            if (geo) {
              cache[key] = { lat: geo.lat, lng: geo.lng, ts: Date.now() };
              geocoded++;
            }
          } catch (e) { console.warn('[scraper] geocoding failed for subdivision:', name, e.message); }
          if (i < subdivs.length - 1) await new Promise(r => setTimeout(r, 50));
        }
        saveGeoCache(cache);

        // Build geo items for chaining
        const geoItems = subdivs.map(({ name, rec }) => {
          const c = cache[geoCacheKey(name, rec.city)];
          return { name, lat: c?.lat ?? null, lng: c?.lng ?? null };
        });

        const ordered = buildNearestNeighborChain(geoItems);

        // Build priority map and sort
        const priority = new Map();
        ordered.forEach((n, i) => priority.set(n, i));

        filteredResults = [...filteredResults].sort((a, b) => {
          const pa = priority.get((a.subdivision || 'UNKNOWN').trim()) ?? priority.size;
          const pb = priority.get((b.subdivision || 'UNKNOWN').trim()) ?? priority.size;
          if (pa !== pb) return pa - pb;
          const za = (a.zipcode || '').substring(0, 5), zb = (b.zipcode || '').substring(0, 5);
          if (za !== zb) return za.localeCompare(zb);
          const stA = (a.address || '').replace(/^\d+\s*/, '').toLowerCase();
          const stB = (b.address || '').replace(/^\d+\s*/, '').toLowerCase();
          if (stA !== stB) return stA.localeCompare(stB);
          return parseInt((a.address || '').match(/^\d+/)?.[0] || '0') -
                 parseInt((b.address || '').match(/^\d+/)?.[0] || '0');
        });
        renderTable();
        showToast(`Sorted ${total} subdivisions by walking route (${geocoded} geocoded)`);
      } catch (err) {
        console.error('Geo sort failed:', err);
        showToast('Geocoding failed ‚Äî falling back to alphabetical');
        sortByRouteAlphabetical();
        renderTable();
      }
    }

    // Open current page addresses in Google Maps for driving route
    function openGoogleMapsRoute() {
      // Get current page addresses (property addresses for door-to-door)
      const pageSize = parseInt(document.getElementById('perPageSelect').value) || 50;
      const startIdx = (currentPage - 1) * pageSize;
      const pageResults = filteredResults.slice(startIdx, startIdx + pageSize);

      if (pageResults.length === 0) {
        showToast('No addresses on this page');
        return;
      }

      // Google Maps supports up to 10 waypoints (9 stops + destination)
      const maxStops = 10;
      const addresses = pageResults.slice(0, maxStops).map(r => {
        return encodeURIComponent(`${r.address}, ${r.city}, ${r.state} ${r.zipcode}`);
      });

      if (addresses.length === 0) {
        showToast('No valid addresses');
        return;
      }

      // Build Google Maps directions URL
      // Format: https://www.google.com/maps/dir/origin/waypoint1/waypoint2/.../destination
      const mapsUrl = 'https://www.google.com/maps/dir/' + addresses.join('/');

      window.open(mapsUrl, '_blank');
      showToast(`Opened ${addresses.length} stops in Google Maps`);
    }

    // Export route as CSV with optimized order
    function exportRouteCSV() {
      if (filteredResults.length === 0) { showToast('No data'); return; }

      // Sort by route first
      const sorted = [...filteredResults].sort((a, b) => {
        const zipA = (a.zipcode || '').substring(0, 5);
        const zipB = (b.zipcode || '').substring(0, 5);
        if (zipA !== zipB) return zipA.localeCompare(zipB);
        if (a.city !== b.city) return (a.city || '').localeCompare(b.city || '');
        const streetA = (a.address || '').replace(/^\d+\s*/, '');
        const streetB = (b.address || '').replace(/^\d+\s*/, '');
        if (streetA !== streetB) return streetA.localeCompare(streetB);
        const numA = parseInt((a.address || '').match(/^\d+/)?.[0] || '0');
        const numB = parseInt((b.address || '').match(/^\d+/)?.[0] || '0');
        return numA - numB;
      });

      // Generate CSV with stop numbers
      const headers = ['Stop #', 'Name', 'Address', 'City', 'State', 'Zip', 'Value', 'Notes'];
      const rows = sorted.map((r, i) => {
        return [
          i + 1,
          `"${(r.recipient || 'Current Resident').replace(/"/g, '""')}"`,
          `"${(r.address || '').replace(/"/g, '""')}"`,
          `"${(r.city || '').replace(/"/g, '""')}"`,
          `"${(r.state || '').replace(/"/g, '""')}"`,
          `"${(r.zipcode || '').replace(/"/g, '""')}"`,
          `"${(r.propertyValue || '').replace(/"/g, '""')}"`,
          `"${(r.notes || '').replace(/"/g, '""')}"`
        ].join(',');
      });

      const csv = [headers.join(','), ...rows].join('\n');
      downloadFile(csv, `route_${sorted.length}_stops_${new Date().toISOString().slice(0,10)}.csv`);
      showToast(`Exported ${sorted.length} stops`);
    }

    // Mailed List Functions
    function addToMailedList(records, campaignId) {
      const today = new Date().toISOString().slice(0, 10);
      let addedCount = 0;

      records.forEach(r => {
        const key = `${r.address}|${r.city}|${r.zipcode}`.toUpperCase();
        if (mailedTracker[key]) {
          mailedTracker[key].count++;
          mailedTracker[key].lastMailed = today;
        } else {
          mailedTracker[key] = { count: 1, firstMailed: today, lastMailed: today };
          addedCount++;
        }
        if (campaignId) mailedTracker[key].lastCampaign = campaignId;
      });

      mailedAddresses = Object.keys(mailedTracker);
      try {
        localStorage.setItem('poolscraper_mailed_v2', JSON.stringify(mailedTracker));
      } catch (e) {
        showToast('Warning: Could not save mailed tracker ‚Äî storage full', 'error');
        console.warn('[scraper] mailed tracker save failed:', e.message);
      }
      updateMailedBadge();
      return addedCount;
    }

    function getRecyclableCount(recycleDays = DEFAULT_RECYCLE_DAYS) {
      let count = 0;
      const today = new Date();
      Object.values(mailedTracker).forEach(data => {
        const daysSince = Math.floor((today - new Date(data.lastMailed)) / (1000 * 60 * 60 * 24));
        if (daysSince >= recycleDays) count++;
      });
      return count;
    }

    function clearMailedList() {
      if (!confirm('Clear all mailed addresses?')) return;
      mailedTracker = {};
      mailedAddresses = [];
      localStorage.setItem('poolscraper_mailed_v2', '{}');
      updateMailedBadge();
      renderMailedList();
      showToast('Mailed list cleared');
    }

    function exportMailedList() {
      if (mailedAddresses.length === 0) { showToast('No mailed addresses'); return; }
      const lines = Object.entries(mailedTracker).map(([key, data]) => `${key}\t${data.count}\t${data.firstMailed}\t${data.lastMailed}`);
      const content = ['ADDRESS|CITY|ZIP\tCOUNT\tFIRST\tLAST', ...lines].join('\n');
      downloadFile(content, `mailed_tracker_${new Date().toISOString().slice(0,10)}.txt`);
      showToast(`Exported ${mailedAddresses.length} addresses`);
    }

    function importMailedList() {
      document.getElementById('mailedFileInput').click();
    }

    function handleMailedFile(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const lines = e.target.result.split('\n').map(l => l.trim()).filter(l => l);
        const today = new Date().toISOString().slice(0, 10);
        let addedCount = 0;

        lines.forEach(line => {
          if (line.startsWith('ADDRESS')) return;
          const parts = line.split('\t');
          const addr = parts[0].toUpperCase();
          if (!addr) return;
          if (!mailedTracker[addr]) {
            if (parts.length >= 4) {
              mailedTracker[addr] = { count: parseInt(parts[1]) || 1, firstMailed: parts[2] || today, lastMailed: parts[3] || today };
            } else {
              mailedTracker[addr] = { count: 1, firstMailed: today, lastMailed: today };
            }
            addedCount++;
          }
        });

        mailedAddresses = Object.keys(mailedTracker);
        localStorage.setItem('poolscraper_mailed_v2', JSON.stringify(mailedTracker));
        updateMailedBadge();
        renderMailedList();
        showToast(`Imported ${addedCount} addresses`);
      };
      reader.readAsText(file);
      input.value = '';
    }

    function renderMailedList() {
      const container = document.getElementById('mailedListPreview');
      const recycleDays = parseInt(document.getElementById('recycleDays')?.value) || 30;
      const recyclableCount = getRecyclableCount(recycleDays);

      document.getElementById('mailedCount').textContent = `${mailedAddresses.length.toLocaleString()} addresses tracked | ${recyclableCount} recyclable (${recycleDays}+ days)`;

      if (mailedAddresses.length === 0) {
        container.innerHTML = '<p style="color:var(--text-dim); padding:20px; text-align:center;">No mailed addresses yet</p>';
        return;
      }

      const sorted = Object.entries(mailedTracker).sort((a, b) => new Date(b[1].lastMailed) - new Date(a[1].lastMailed)).slice(0, 100);
      const today = new Date();

      container.innerHTML = `
        <div class="mailed-grid">
          <div class="mailed-header">Address</div>
          <div class="mailed-header">Count</div>
          <div class="mailed-header">Last</div>
          <div class="mailed-header">Days</div>
          ${sorted.map(([addr, data]) => {
            const daysSince = Math.floor((today - new Date(data.lastMailed)) / (1000 * 60 * 60 * 24));
            const isRecyclable = daysSince >= recycleDays;
            const countColor = data.count >= 7 ? '#f59e0b' : data.count >= 3 ? '#22c55e' : '#fff';
            return `
              <div class="mailed-row ${isRecyclable ? 'recyclable' : ''}" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeHtml(addr)}">${escapeHtml(addr.substring(0, 40))}...</div>
              <div class="mailed-row ${isRecyclable ? 'recyclable' : ''}" style="color:${countColor}; font-weight:bold;">${data.count}x</div>
              <div class="mailed-row ${isRecyclable ? 'recyclable' : ''}">${escapeHtml(data.lastMailed)}</div>
              <div class="mailed-row ${isRecyclable ? 'recyclable' : ''}" style="color:${isRecyclable ? '#22c55e' : '#888'};">${daysSince}d</div>
            `;
          }).join('')}
        </div>
      `;
    }

    function updateMailedBadge() {
      const badge = document.getElementById('mailedBadge');
      if (mailedAddresses.length > 0) {
        badge.textContent = mailedAddresses.length > 999 ? '999+' : mailedAddresses.length;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    // History functions
    function addToHistory(count, type = 'Export', subdivisions = [], fileName = '') {
      exportHistory.unshift({ date: new Date().toISOString(), count, type, subdivisions, fileName });
      if (exportHistory.length > 50) exportHistory.pop();
      localStorage.setItem('poolscraper_history', JSON.stringify(exportHistory));
      renderHistory();
    }

    function renderHistory() {
      const container = document.getElementById('historyList');
      if (exportHistory.length === 0) {
        container.innerHTML = '<p style="color:var(--text-dim); text-align:center; padding:20px;">No exports yet</p>';
        return;
      }
      container.innerHTML = exportHistory.slice(0, 20).map(h => {
        const subdivText = h.subdivisions && h.subdivisions.length > 0
          ? `<div style="font-size:10px; color:var(--text-dim); margin-top:2px;">${escapeHtml(h.subdivisions.join(' ¬∑ '))}</div>` : '';
        const fileText = h.fileName ? `<div style="font-size:10px; color:var(--accent); margin-top:1px;">${escapeHtml(h.fileName)}</div>` : '';
        return `<div style="padding:8px; background:var(--bg); border-radius:4px; margin-bottom:6px; font-size:12px;">
          <div style="display:flex; justify-content:space-between;">
            <span><strong>${escapeHtml(h.type)}</strong>: ${h.count.toLocaleString()} records</span>
            <span style="color:var(--text-dim);">${new Date(h.date).toLocaleDateString()}</span>
          </div>
          ${subdivText}${fileText}
        </div>`;
      }).join('');
    }

    function clearHistory() {
      if (!confirm('Clear history?')) return;
      exportHistory = [];
      localStorage.setItem('poolscraper_history', '[]');
      renderHistory();
      showToast('History cleared');
    }

    // Exclude list
    function saveExcludeList() {
      excludeAddresses = document.getElementById('excludeList').value.split('\n').map(l => l.trim()).filter(l => l);
      localStorage.setItem('poolscraper_exclude', JSON.stringify(excludeAddresses));
      document.getElementById('excludeCount').textContent = `${excludeAddresses.length} addresses`;
      showToast('Exclude list saved');
    }

    // Clear all
    function clearAll() {
      clearInterval(_autoSaveInterval);
      fileContent = null;
      parsedRows = [];
      headers = [];
      results = [];
      filteredResults = [];
      dropZone.classList.remove('has-file');
      fileInfo.innerHTML = '';
      document.getElementById('detectedInfo').style.display = 'none';
      document.getElementById('mapperSection').style.display = 'none';
      document.getElementById('samplePreviewCard').style.display = 'none';
      processBtn.disabled = true;
      resultsSection.style.display = 'none';
      emptyState.style.display = 'block';
      clearSession();
      localStorage.removeItem('poolscraper_batches');
      localStorage.removeItem('poolscraper_filtered');
      showToast('Cleared');
    }

    // ==================== SUBDIVISION PICKER ====================
    let selectedSubdivisions = new Set();
    try {
      const _saved = JSON.parse(localStorage.getItem('poolscraper_subdivSelections') || '[]');
      if (Array.isArray(_saved) && _saved.length > 0) selectedSubdivisions = new Set(_saved);
    } catch (e) { console.warn('[scraper] subdiv restore:', e.message); }

    let subdivPickerInitialized = false;

    function populateSubdivPicker() {
      // Count from filteredResults so it reflects current zip/city/status filters
      const subdivCounts = {};
      filteredResults.forEach(r => {
        const sub = (r.subdivision || '').trim();
        if (sub) subdivCounts[sub] = (subdivCounts[sub] || 0) + 1;
      });

      const sorted = Object.entries(subdivCounts).sort((a, b) => b[1] - a[1]);
      const picker = document.getElementById('subdivPicker');
      if (sorted.length === 0) {
        picker.style.display = 'none';
        return;
      }

      // On first run, select all only if nothing was restored from localStorage.
      if (!subdivPickerInitialized && selectedSubdivisions.size === 0) {
        selectedSubdivisions = new Set(sorted.map(([name]) => name));
      }
      subdivPickerInitialized = true;
      // Remove stale selections that no longer exist in the FULL dataset
      // (not filteredResults ‚Äî city/zip filters should not permanently erase selections)
      const allSubdivNames = new Set(results.map(r => (r.subdivision || '').trim()).filter(Boolean));
      let _staleRemoved = false;
      for (const s of selectedSubdivisions) {
        if (!allSubdivNames.has(s)) { selectedSubdivisions.delete(s); _staleRemoved = true; }
      }
      if (_staleRemoved) persistSubdivSelections();

      const container = document.getElementById('subdivChecklist');
      container.textContent = '';
      sorted.forEach(([name, count]) => {
        const label = document.createElement('label');
        label.style.cssText = 'display:flex; align-items:center; gap:4px; padding:3px 8px; background:#1a1a24; border:1px solid #2a2a35; border-radius:4px; font-size:11px; cursor:pointer; white-space:nowrap;';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = selectedSubdivisions.has(name);
        cb.dataset.subdiv = name; // Raw name, no HTML escaping needed on dataset property
        cb.addEventListener('change', function() { onSubdivToggle(this); });
        label.appendChild(cb);
        label.appendChild(document.createTextNode(` ${name} `));
        const span = document.createElement('span');
        span.style.color = '#71717a';
        span.textContent = `(${count})`;
        label.appendChild(span);
        container.appendChild(label);
      });

      picker.style.display = 'block';
      updateSubdivCount();
    }

    function persistSubdivSelections() {
      try { localStorage.setItem('poolscraper_subdivSelections', JSON.stringify([...selectedSubdivisions])); } catch (e) { console.warn('[scraper] subdiv persist:', e.message); showToast('Warning: Could not save subdivision selections ‚Äî storage full', 'error'); }
    }

    function onSubdivToggle(cb) {
      const name = cb.dataset.subdiv;
      if (cb.checked) selectedSubdivisions.add(name);
      else selectedSubdivisions.delete(name);
      updateSubdivCount();
      updateSelectedStats();
      currentPage = 1;
      renderTable();
      persistSubdivSelections();
    }

    function toggleAllSubdivs(selectAll) {
      document.querySelectorAll('#subdivChecklist input[type="checkbox"]').forEach(cb => {
        cb.checked = selectAll;
        if (selectAll) selectedSubdivisions.add(cb.dataset.subdiv);
        else selectedSubdivisions.delete(cb.dataset.subdiv);
      });
      updateSubdivCount();
      updateSelectedStats();
      currentPage = 1;
      renderTable();
      persistSubdivSelections();
    }

    function updateSubdivCount() {
      const el = document.getElementById('subdivSelectedCount');
      const visible = document.querySelectorAll('#subdivChecklist input[type="checkbox"]').length;
      if (el) el.textContent = `${selectedSubdivisions.size} of ${visible} selected`;
    }

    function updateSelectedStats() {
      const selected = getSubdivFilteredResults();

      const subdivCounts = {};
      selected.forEach(r => {
        const s = (r.subdivision || '').trim();
        if (s) subdivCounts[s] = (subdivCounts[s] || 0) + 1;
      });
      const sorted = Object.entries(subdivCounts).sort((a, b) => b[1] - a[1]);

      document.getElementById('quickStatsText').textContent = `${selected.length} leads across ${sorted.length} subdivision${sorted.length !== 1 ? 's' : ''}`;
      document.getElementById('quickStatsSubdivs').innerHTML = sorted.slice(0, 8).map(([name, count]) =>
        `<span style="display:inline-block; padding:2px 8px; margin:2px 4px 2px 0; background:var(--bg); border:1px solid var(--border); border-radius:12px;">${escapeHtml(name)} <strong style="color:var(--accent);">${count}</strong></span>`
      ).join('') + (sorted.length > 8 ? `<span style="color:var(--text-dim);"> +${sorted.length - 8} more</span>` : '');

      // Keep export preview in sync with subdivision selection
      if (typeof updateExportPreview === 'function') updateExportPreview();
    }

    // Sync to Pool Identifier
    // Send filtered results to Verifier ‚Äî only sends checked subdivisions
    function sendFilteredToVerifier() {
      if (filteredResults.length === 0) {
        showToast('No filtered data to send. Apply filters first.', 'error');
        return;
      }

      let toSend = getExportableRecords();

      if (toSend.length === 0) {
        showToast('No addresses match selected subdivisions. Check at least one.', 'error');
        return;
      }

      const verifierData = toSend.map(r => ({
        recipient: r.recipient || 'Current Resident',
        company: r.company || '',
        address: r.address,
        city: r.city,
        state: r.state || 'FL',
        zipcode: r.zipcode,
        subdivision: r.subdivision || '',
        propertyValue: r.propertyValue || '',
        yearBuilt: r.yearBuilt || '',
        poolAge: r.poolAge || '',
        saleDate: r.saleDate || '',
        propertyAddress: r.propertyAddress || '',
        mailingAddress: r.mailingAddress || '',
        lotSize: r.lotSize || 0,
        livingArea: r.livingArea || 0,
        triggers: r.triggers || []
      }));

      try {
        // Group by subdivision ‚Äî each gets its own batch
        const bySubdiv = {};
        for (const r of verifierData) {
          const sub = (r.subdivision || '').trim() || 'Uncategorized';
          if (!bySubdiv[sub]) bySubdiv[sub] = [];
          bySubdiv[sub].push(r);
        }

        // Fresh batches ‚Äî always overwrite to prevent stale accumulation
        const batches = {};
        let totalSent = 0;
        const summary = [];

        for (const [subdiv, records] of Object.entries(bySubdiv)) {
          const batchKey = subdiv.replace(/\s+/g, '_');

          // Dedup within this send only
          const seenKeys = new Set();
          const unique = [];
          for (const r of records) {
            const key = `${(r.address || '').toUpperCase()}|${(r.city || '').toUpperCase()}|${r.zipcode}`;
            if (!seenKeys.has(key)) {
              unique.push(r);
              seenKeys.add(key);
            }
          }

          batches[batchKey] = { name: subdiv, results: unique, timestamp: new Date().toISOString(), count: unique.length };
          totalSent += unique.length;
          summary.push(`${subdiv} (${unique.length})`);
        }

        const allResults = Object.values(batches).flatMap(b => b.results);
        localStorage.setItem('poolscraper_transfer', JSON.stringify({
          version: 2,
          results: allResults,
          timestamp: new Date().toISOString(),
          count: allResults.length
        }));
        // Remove legacy keys to prevent stale fallback reads
        localStorage.removeItem('poolscraper_filtered');
        localStorage.removeItem('poolscraper_batches');

        let msg = `Sent ${totalSent} addresses across ${Object.keys(bySubdiv).length} subdivisions`;
        msg += `\n${summary.join(' ¬∑ ')}`;
        showToast(msg);
        trackDeferredAfterExport();
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          showToast('Too much data. Filter to fewer addresses.', 'error');
        } else {
          showToast('Failed: ' + e.message, 'error');
        }
      }
    }

    // ============== CAMPAIGN MANAGEMENT ==============

    function saveCampaigns() {
      try {
        localStorage.setItem('poolscraper_campaigns', JSON.stringify(campaigns));
      } catch (e) {
        showToast('Warning: Could not save campaigns ‚Äî storage full', 'error');
        console.warn('[scraper] campaign save failed:', e.message);
      }
      updateCampaignBadge();
      renderCampaignList();
      updateCampaignStats();
    }

    function updateCampaignBadge() {
      const badge = document.getElementById('campaignBadge');
      if (campaigns.length > 0) {
        badge.textContent = campaigns.length;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    function updateCampaignStats() {
      const totalCampaigns = campaigns.length;
      const totalSent = campaigns.reduce((sum, c) => sum + (c.addresses?.length || 0), 0);
      const totalCalls = campaigns.reduce((sum, c) => sum + (c.calls || 0), 0);
      const totalRevenue = campaigns.reduce((sum, c) => sum + (c.revenue || 0), 0);

      // Estimate cost (default $0.75 per postcard)
      const costPerCard = 0.75;
      const totalCost = totalSent * costPerCard;
      const profit = totalRevenue - totalCost;
      const roi = totalCost > 0 ? Math.round((profit / totalCost) * 100) : 0;

      document.getElementById('campStatTotal').textContent = totalCampaigns;
      document.getElementById('campStatSent').textContent = totalSent.toLocaleString();
      document.getElementById('campStatCalls').textContent = totalCalls;
      document.getElementById('campStatRevenue').textContent = '$' + totalRevenue.toLocaleString();

      const roiEl = document.getElementById('campStatRoi');
      roiEl.textContent = roi + '%';
      roiEl.style.color = roi >= 0 ? 'var(--green)' : 'var(--red)';
    }

    // ROI Calculator
    function openRoiCalculator() {
      // Pre-fill with campaign data
      const totalSent = campaigns.reduce((sum, c) => sum + (c.addresses?.length || 0), 0);
      const totalCalls = campaigns.reduce((sum, c) => sum + (c.calls || 0), 0);
      const totalRevenue = campaigns.reduce((sum, c) => sum + (c.revenue || 0), 0);

      document.getElementById('roiCardsSent').value = totalSent;
      document.getElementById('roiCalls').value = totalCalls;
      document.getElementById('roiRevenue').value = totalRevenue;

      document.getElementById('roiCalcModal').classList.add('show');
      calculateROI();
    }

    function closeRoiCalculator() {
      document.getElementById('roiCalcModal').classList.remove('show');
    }

    function calculateROI() {
      const costPerCard = parseFloat(document.getElementById('roiCostPerCard').value) || 0;
      const cardsSent = parseInt(document.getElementById('roiCardsSent').value) || 0;
      const calls = parseInt(document.getElementById('roiCalls').value) || 0;
      const revenue = parseFloat(document.getElementById('roiRevenue').value) || 0;

      const totalCost = costPerCard * cardsSent;
      const profit = revenue - totalCost;
      const roi = totalCost > 0 ? ((profit / totalCost) * 100) : 0;
      const costPerCall = calls > 0 ? (totalCost / calls) : 0;
      const conversionRate = cardsSent > 0 ? ((calls / cardsSent) * 100) : 0;

      document.getElementById('roiResultCost').textContent = '$' + totalCost.toFixed(2);
      document.getElementById('roiResultProfit').textContent = '$' + profit.toFixed(2);
      document.getElementById('roiResultProfit').style.color = profit >= 0 ? 'var(--green)' : 'var(--red)';
      document.getElementById('roiResultRoi').textContent = roi.toFixed(1) + '%';
      document.getElementById('roiResultRoi').style.color = roi >= 0 ? 'var(--green)' : 'var(--red)';
      document.getElementById('roiResultCPC').textContent = calls > 0 ? ('$' + costPerCall.toFixed(2)) : '-';
      document.getElementById('roiResultConv').textContent = conversionRate.toFixed(2) + '%';
    }

    // Campaign creation moved to Postcard generator
    // Campaigns tab now shows campaigns created in Postcard

    function exportCampaignCSV(campaign) {
      const headers = ['Recipient', 'Company', 'Address', 'City', 'State', 'Zipcode', 'Campaign', 'PromoCode'];
      const rows = campaign.addresses.map(r => [
        `"${csvSafe(r.recipient || 'Current Resident')}"`,
        `""`,
        `"${csvSafe(r.address || '')}"`,
        `"${csvSafe(r.city || '')}"`,
        `"${csvSafe(r.state || '')}"`,
        `"${csvSafe(r.zipcode || '')}"`,
        `"${csvSafe(campaign.name)}"`,
        `"${csvSafe(campaign.promoCode)}"`
      ].join(','));

      const csv = [headers.join(','), ...rows].join('\n');
      const filename = `Campaign_${campaign.name.replace(/[^a-zA-Z0-9]/g, '_')}_${campaign.addresses.length}.csv`;
      downloadFile(csv, filename);
    }

    function renderCampaignList() {
      const container = document.getElementById('campaignList');

      if (campaigns.length === 0) {
        container.innerHTML = `
          <div style="text-align:center; padding:40px; color:var(--text-dim);">
            <div style="font-size:48px; margin-bottom:12px;">üìÆ</div>
            <p>No campaigns yet</p>
            <p style="font-size:12px; margin-top:8px;">Create your first campaign to start tracking postcards</p>
          </div>`;
        return;
      }

      container.innerHTML = `
        <table style="width:100%; font-size:12px;">
          <thead>
            <tr style="border-bottom:2px solid var(--border);">
              <th style="text-align:left; padding:8px;">Campaign</th>
              <th style="text-align:left; padding:8px;">Promo Code</th>
              <th style="text-align:center; padding:8px;">Sent</th>
              <th style="text-align:center; padding:8px;">Calls</th>
              <th style="text-align:right; padding:8px;">Revenue</th>
              <th style="text-align:center; padding:8px;">Date</th>
              <th style="text-align:center; padding:8px;">Resend</th>
              <th style="text-align:center; padding:8px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${campaigns.map(c => {
              const sentDate = new Date(c.dateCreated);
              const daysSince = Math.floor((new Date() - sentDate) / (1000 * 60 * 60 * 24));
              const readyToResend = daysSince >= 30;
              const resendStatus = readyToResend
                ? `<span style="color:var(--green);">‚úì Ready</span>`
                : `<span style="color:var(--text-dim);">${30 - daysSince}d</span>`;

              return `
                <tr style="border-bottom:1px solid var(--border);">
                  <td style="padding:8px;">
                    <div style="font-weight:600;">${escapeHtml(c.name)}</div>
                    <div style="font-size:10px; color:var(--text-dim);">${escapeHtml(c.targetArea || '')}${c.designId ? ' <span style="color:var(--accent);font-size:9px;">üé® Linked</span>' : ''}</div>
                  </td>
                  <td style="padding:8px;"><code style="background:var(--bg); padding:2px 6px; border-radius:3px;">${escapeHtml(c.promoCode || '-')}</code></td>
                  <td style="text-align:center; padding:8px; color:var(--cyan);">${c.addresses?.length || 0}</td>
                  <td style="text-align:center; padding:8px; color:var(--green);">${c.calls || 0}</td>
                  <td style="text-align:right; padding:8px; color:var(--green);">$${(c.revenue || 0).toLocaleString()}</td>
                  <td style="text-align:center; padding:8px; color:var(--text-dim);">${sentDate.toLocaleDateString()}</td>
                  <td style="text-align:center; padding:8px;">${resendStatus}</td>
                  <td style="text-align:center; padding:8px;">
                    <button class="btn btn-sm btn-secondary" onclick="openCampaignDetail('${c.id}')" title="View Details">üìã</button>
                    <button class="btn btn-sm" style="background:var(--green); color:#000;" onclick="logCampaignCall('${c.id}')" title="Log Call">üìû+</button>
                    <button class="btn btn-sm" style="background:var(--orange); color:#000;" onclick="logCampaignRevenue('${c.id}')" title="Log Revenue">üí∞+</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      // Update resend list and quick-log dropdown
      renderResendList();
      populateQuickLogDropdown();
    }

    function renderResendList() {
      const container = document.getElementById('resendList');
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

      // Find addresses ready to resend
      const readyAddresses = [];
      Object.entries(mailedTracker).forEach(([key, data]) => {
        if (new Date(data.lastMailed) < thirtyDaysAgo) {
          const [address, city, zip] = key.split('|');
          const lastCampaign = campaigns.find(c => c.id === data.lastCampaign);
          readyAddresses.push({
            address, city, zip,
            lastMailed: data.lastMailed,
            mailCount: data.count,
            lastCampaignName: lastCampaign?.name || 'Unknown'
          });
        }
      });

      if (readyAddresses.length === 0) {
        container.innerHTML = `<p style="color:var(--text-dim); font-size:12px;">No addresses ready for resend yet</p>`;
        return;
      }

      container.innerHTML = `
        <p style="font-size:12px; color:var(--green); margin-bottom:12px;">${readyAddresses.length} addresses ready for another postcard</p>
        <div style="max-height:200px; overflow-y:auto;">
          <table style="width:100%; font-size:11px;">
            <thead>
              <tr style="border-bottom:1px solid var(--border);">
                <th style="text-align:left; padding:6px;">Address</th>
                <th style="text-align:left; padding:6px;">Last Campaign</th>
                <th style="text-align:center; padding:6px;">Times Mailed</th>
                <th style="text-align:center; padding:6px;">Last Mailed</th>
              </tr>
            </thead>
            <tbody>
              ${readyAddresses.slice(0, 50).map(a => `
                <tr style="border-bottom:1px solid var(--border);">
                  <td style="padding:6px;">${escapeHtml(a.address)}, ${escapeHtml(a.city)}</td>
                  <td style="padding:6px; color:var(--text-dim);">${escapeHtml(a.lastCampaignName)}</td>
                  <td style="text-align:center; padding:6px;">${a.mailCount}x</td>
                  <td style="text-align:center; padding:6px; color:var(--text-dim);">${escapeHtml(a.lastMailed)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function openCampaignDetail(campaignId) {
      const campaign = campaigns.find(c => c.id === campaignId);
      if (!campaign) return;

      document.getElementById('campDetailTitle').textContent = campaign.name;

      const sentDate = new Date(campaign.dateCreated);
      const daysSince = Math.floor((new Date() - sentDate) / (1000 * 60 * 60 * 24));

      document.getElementById('campDetailContent').innerHTML = `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
          <div>
            <div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">Promo Code</div>
            <div style="font-size:16px; font-weight:600;">${escapeHtml(campaign.promoCode) || '-'}</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">Tracking Link</div>
            <div style="font-size:14px;">${campaign.trackingLink ? `<a href="${/^https?:\/\//i.test(campaign.trackingLink) ? escapeHtml(campaign.trackingLink) : '#'}" target="_blank" rel="noopener noreferrer" style="color:var(--cyan);">${escapeHtml(campaign.trackingLink)}</a>` : '-'}</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">Target Area</div>
            <div style="font-size:14px;">${escapeHtml(campaign.targetArea) || '-'}</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">Date Sent</div>
            <div style="font-size:14px;">${sentDate.toLocaleDateString()} (${daysSince} days ago)</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">Postcards Sent</div>
            <div style="font-size:16px; font-weight:600; color:var(--cyan);">${campaign.addresses?.length || 0}</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">Responses / Revenue</div>
            <div style="font-size:16px; font-weight:600; color:var(--green);">${campaign.calls || 0} calls / $${(campaign.revenue || 0).toLocaleString()}</div>
          </div>
        </div>

        ${campaign.notes ? `<div style="margin-bottom:20px; padding:12px; background:var(--bg); border-radius:6px;"><strong>Notes:</strong> ${escapeHtml(campaign.notes)}</div>` : ''}

        <div style="display:flex; gap:10px; margin-bottom:20px;">
          <button class="btn btn-success" onclick="logCampaignCall('${campaign.id}'); openCampaignDetail('${campaign.id}');">üìû Log Call (+1)</button>
          <button class="btn" style="background:var(--orange); color:#000;" onclick="promptCampaignRevenue('${campaign.id}')">üí∞ Add Revenue</button>
          <button class="btn btn-secondary" onclick="reexportCampaign('${campaign.id}')">üì• Re-export CSV</button>
          <button class="btn" style="background:var(--red); color:white;" onclick="deleteCampaign('${campaign.id}')">üóëÔ∏è Delete</button>
        </div>

        <h4 style="margin-bottom:12px;">Addresses (${campaign.addresses?.length || 0})</h4>
        <div style="max-height:300px; overflow-y:auto; border:1px solid var(--border); border-radius:6px;">
          <table style="width:100%; font-size:11px;">
            <thead>
              <tr style="border-bottom:1px solid var(--border); background:var(--bg);">
                <th style="text-align:left; padding:8px;">Recipient</th>
                <th style="text-align:left; padding:8px;">Address</th>
                <th style="text-align:left; padding:8px;">City</th>
                <th style="text-align:left; padding:8px;">Zip</th>
              </tr>
            </thead>
            <tbody>
              ${(campaign.addresses || []).map(a => `
                <tr style="border-bottom:1px solid var(--border);">
                  <td style="padding:8px;">${escapeHtml(a.recipient || 'Current Resident')}</td>
                  <td style="padding:8px;">${escapeHtml(a.address)}</td>
                  <td style="padding:8px;">${escapeHtml(a.city)}</td>
                  <td style="padding:8px;">${escapeHtml(a.zipcode)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      document.getElementById('campaignDetailModal').classList.add('show');
    }

    function closeCampaignDetail() {
      document.getElementById('campaignDetailModal').classList.remove('show');
    }

    function populateQuickLogDropdown() {
      const sel = document.getElementById('quickLogCampaign');
      if (!sel) return;
      const current = sel.value;
      sel.innerHTML = '<option value="">Select campaign...</option>' +
        campaigns.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
      if (current) sel.value = current;
    }

    function submitQuickLog() {
      const campaignId = document.getElementById('quickLogCampaign').value;
      if (!campaignId) { showToast('Select a campaign', 'error'); return; }
      const campaign = campaigns.find(c => c.id === campaignId);
      if (!campaign) return;

      const calls = parseInt(document.getElementById('quickLogCalls').value) || 0;
      const revenue = parseFloat(document.getElementById('quickLogRevenue').value) || 0;

      if (calls <= 0 && revenue <= 0) { showToast('Enter calls or revenue', 'error'); return; }

      if (calls > 0) campaign.calls = (campaign.calls || 0) + calls;
      if (revenue > 0) campaign.revenue = (campaign.revenue || 0) + revenue;

      saveCampaigns();

      const parts = [];
      if (calls > 0) parts.push(`${calls} call${calls > 1 ? 's' : ''}`);
      if (revenue > 0) parts.push(`$${revenue.toLocaleString()}`);
      showToast(`Logged ${parts.join(' + ')} for "${campaign.name}"`);

      document.getElementById('quickLogCalls').value = '1';
      document.getElementById('quickLogRevenue').value = '';
    }

    function logCampaignCall(campaignId) {
      const campaign = campaigns.find(c => c.id === campaignId);
      if (!campaign) return;
      campaign.calls = (campaign.calls || 0) + 1;
      saveCampaigns();
      showToast(`Logged call for "${campaign.name}" (${campaign.calls} total)`);
    }

    function logCampaignRevenue(campaignId) {
      promptCampaignRevenue(campaignId);
    }

    function promptCampaignRevenue(campaignId) {
      const amount = prompt('Enter revenue amount ($):');
      if (amount === null) return;

      const value = parseFloat(amount.replace(/[^0-9.]/g, ''));
      if (isNaN(value) || value <= 0) {
        showToast('Invalid amount', 'error');
        return;
      }

      const campaign = campaigns.find(c => c.id === campaignId);
      if (!campaign) return;

      campaign.revenue = (campaign.revenue || 0) + value;
      saveCampaigns();
      showToast(`Added $${value.toLocaleString()} to "${campaign.name}" ($${campaign.revenue.toLocaleString()} total)`);

      // Refresh detail view if open
      if (document.getElementById('campaignDetailModal').classList.contains('show')) {
        openCampaignDetail(campaignId);
      }
    }

    function reexportCampaign(campaignId) {
      const campaign = campaigns.find(c => c.id === campaignId);
      if (!campaign) return;
      exportCampaignCSV(campaign);
      showToast(`Re-exported ${campaign.addresses?.length || 0} addresses`);
    }

    function deleteCampaign(campaignId) {
      if (!confirm('Delete this campaign? This cannot be undone.')) return;
      campaigns = campaigns.filter(c => c.id !== campaignId);
      saveCampaigns();
      closeCampaignDetail();
      showToast('Campaign deleted');
    }

    function exportCampaignsData() {
      if (campaigns.length === 0) {
        showToast('No campaigns to export');
        return;
      }

      const data = campaigns.map(c => ({
        name: c.name,
        promoCode: c.promoCode,
        targetArea: c.targetArea,
        dateCreated: c.dateCreated,
        addressCount: c.addresses?.length || 0,
        calls: c.calls || 0,
        revenue: c.revenue || 0,
        notes: c.notes
      }));

      const headers = ['Campaign', 'Promo Code', 'Target Area', 'Date', 'Sent', 'Calls', 'Revenue', 'Notes'];
      const rows = data.map(d => [
        `"${d.name}"`,
        `"${d.promoCode}"`,
        `"${d.targetArea}"`,
        `"${d.dateCreated}"`,
        d.addressCount,
        d.calls,
        d.revenue,
        `"${d.notes || ''}"`
      ].join(','));

      const csv = [headers.join(','), ...rows].join('\n');
      downloadFile(csv, `Campaigns_Summary_${new Date().toISOString().slice(0,10)}.csv`);
      showToast('Exported campaign summary');
    }

    // Initialize campaigns on load
    function initCampaigns() {
      updateCampaignBadge();
      renderCampaignList();
      updateCampaignStats();
    }

    // ============== END CAMPAIGN MANAGEMENT ==============

    // Look up full address using Census Geocoder API (returns city, state, zip)
    async function lookupAddress(street, city, state) {
      if (!street) return null;

      // Clean the address
      const cleanStreet = street.replace(/[#,]/g, '').trim();
      const cleanCity = (city || '').trim();
      const cleanState = (state || (typeof targetState !== 'undefined' && targetState) || 'FL').trim();

      // Build the URL for Census Geocoder
      const baseUrl = 'https://geocoding.geo.census.gov/geocoder/locations/address';
      const params = new URLSearchParams({
        street: cleanStreet,
        benchmark: 'Public_AR_Current',
        format: 'json'
      });

      // Add city and state if available
      if (cleanCity) params.append('city', cleanCity);
      if (cleanState) params.append('state', cleanState);

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), LOOKUP_TIMEOUT_MS);
        const response = await fetch(`${baseUrl}?${params}`, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!response.ok) return null;

        const data = await response.json();

        if (data.result && data.result.addressMatches && data.result.addressMatches.length > 0) {
          const match = data.result.addressMatches[0];
          const components = match.addressComponents || {};

          // Build result object
          const result = {
            city: null,
            state: null,
            zip: null
          };

          // Get city
          if (components.city) {
            result.city = toTitleCase(components.city);
          }

          // Get state
          if (components.state) {
            result.state = components.state.toUpperCase();
          }

          // Get zip
          if (components.zip) {
            result.zip = components.zip;
          } else {
            // Try to extract from matched address
            const matchedAddr = match.matchedAddress || '';
            const zipMatch = matchedAddr.match(/\b(\d{5})(-\d{4})?\b/);
            if (zipMatch) {
              result.zip = zipMatch[1];
            }
          }

          return result;
        }

        return null;
      } catch (e) {
        return null;
      }
    }

    // Validate addresses using Census Geocoder
    async function validateAddresses() {
      if (results.length === 0) {
        showToast('No addresses to validate');
        return;
      }

      // Only validate unvalidated addresses
      let toValidate = results.filter(r => r.validated === undefined);
      if (toValidate.length === 0) {
        showToast('All addresses already validated');
        return;
      }

      // Get selected count
      const countSelect = document.getElementById('validateCount').value;
      const maxCount = countSelect === 'all' ? toValidate.length : parseInt(countSelect);
      toValidate = toValidate.slice(0, maxCount);

      showToast(`Validating ${toValidate.length} addresses...`);

      let validated = 0;
      let invalid = 0;

      // Process in batches to avoid overwhelming the API
      for (let i = 0; i < toValidate.length; i++) {
        const r = toValidate[i];

        try {
          const result = await lookupAddress(r.address, r.city, r.state);

          if (result) {
            r.validated = true;
            r.validatedCity = result.city;
            r.validatedZip = result.zip;
            validated++;
          } else {
            r.validated = false;
            invalid++;
          }
        } catch (e) {
          r.validated = false;
          invalid++;
        }

        // Update progress every 10 addresses
        if (i % 10 === 0) {
          progressFill.style.width = `${((i + 1) / toValidate.length * 100).toFixed(0)}%`;
          progressText.textContent = `Validating ${i + 1} of ${toValidate.length}...`;
          await new Promise(resolve => setTimeout(resolve, 100)); // Small delay to avoid rate limiting
        }
      }

      progressFill.style.width = '100%';
      progressText.textContent = `Validation complete!`;

      showToast(`‚úì ${validated} valid, ‚úó ${invalid} invalid`);
      renderTable();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Don't trigger shortcuts when typing in inputs
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        if (e.key === 'Escape') {
          e.target.blur();
        }
        return;
      }

      switch(e.key.toLowerCase()) {
        case 'p':
          // Process file
          if (parsedRows.length > 0) {
            processBtn.click();
            showToast('Processing... (P)');
          }
          break;
        case 'e':
          // Export CSV
          if (results.length > 0) {
            downloadCSV();
          }
          break;
        case 'a':
        case 'arrowleft':
          // Previous page
          if (currentPage > 1) {
            currentPage--;
            renderTable();
          }
          break;
        case 'd':
        case 'arrowright':
          // Next page
          if (currentPage < totalPages) {
            currentPage++;
            renderTable();
          }
          break;
        case '/':
          // Focus search
          e.preventDefault();
          document.getElementById('searchInput').focus();
          break;
        case 'escape':
          // Clear filters
          document.getElementById('searchInput').value = '';
          currentFilter = 'all';
          currentCityFilter = null;
          currentZipFilter = null;
          applyFilter();
          showToast('Filters cleared (Esc)');
          break;
        case 'r':
          // Export recyclable only
          if (results.length > 0) {
            exportRecyclable();
          }
          break;
        case 'v':
          // Sync to verifier
          if (results.length > 0) {
            sendFilteredToVerifier();
          }
          break;
        case '?':
          // Show shortcuts help
          showToast('Shortcuts: P=Process, E=Export, A/D=Prev/Next, /=Search, Esc=Clear, R=Recyclable, V=Identifier');
          break;
      }
    });

    // Save to both localStorage AND sessionStorage for reliability
    function saveSessionBoth(reason) {
      if (results.length === 0) return false;

      const slimResults = results.map(r => ({
          recipient: r.recipient,
          company: r.company,
          address: r.address,
          city: r.city,
          state: r.state,
          zipcode: r.zipcode,
          propertyValue: r.propertyValue,
          yearBuilt: r.yearBuilt,
          poolAge: r.poolAge,
          propertyType: r.propertyType,
          saleDate: r.saleDate,
          daysSinceSale: r.daysSinceSale,
          isAbsentee: r.isAbsentee,
          propertyAddress: r.propertyAddress || '',
          mailingAddress: r.mailingAddress || '',
          subdivision: r.subdivision,
          lotSize: r.lotSize || 0,
          livingArea: r.livingArea || 0,
          triggers: r.triggers || [],
          flags: r.flags || [],
          notes: r.notes
        }));
      const session = {
        results: slimResults,
        stats: { total: results.length, matches: results.length, dupes: 0, biz: 0, excluded: 0 },
        timestamp: new Date().toISOString(),
        cityFilter: currentCityFilter || null,
        zipFilter: currentZipFilter || null,
        activeFilter: currentFilter || 'all'
      };

      // Always save to IndexedDB (no size limit)
      saveToIDB(session);

      try {
        const json = JSON.stringify(session);
        localStorage.setItem('poolscraper_session', json);
        sessionStorage.setItem('poolscraper_session', json);
        return true;
      } catch (e) {
        console.warn('[scraper] saveSessionBoth localStorage:', e.message);
        return false;
      }
    }

    // Save session and then navigate
    function saveBeforeNav(event, url) {
      event.preventDefault();
      event.stopPropagation();

      const statusEl = document.getElementById('sessionStatus');

      if (results.length > 0) {
        statusEl.textContent = '‚è≥ Saving...';
        statusEl.style.color = 'var(--orange)';

        // Save synchronously to both storage mechanisms
        const saved = saveSessionBoth('nav');

        if (saved) {
          // Double-verify the save worked
          const verifyLocal = localStorage.getItem('poolscraper_session');
          const verifySession = sessionStorage.getItem('poolscraper_session');

          if (verifyLocal || verifySession) {
            statusEl.textContent = '‚úì Saved';
            statusEl.style.color = 'var(--green)';
          } else {
            statusEl.textContent = '‚ö†Ô∏è Save unclear';
            statusEl.style.color = 'var(--orange)';
          }
        } else {
          statusEl.textContent = '‚úó Save failed';
          statusEl.style.color = 'var(--red)';
        }
      }

      // Navigate after a longer delay to ensure save completes
      setTimeout(() => {
        window.location.href = url;
      }, 250);

      return false; // Extra safety to prevent navigation
    }

    // Also save on page unload as backup
    window.addEventListener('beforeunload', () => {
      if (results.length > 0) {
        saveSessionBoth('unload');
      }
    });

    // Also save on visibility change (when tab is hidden)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && results.length > 0) {
        saveSessionBoth('visibility');
      }
    });

    // Auto-save every 30 seconds if there's data
    let _autoSaveInterval = setInterval(() => {
      if (results.length > 0) {
        saveSessionBoth('auto');
      }
    }, 30000);

    // Test storage availability
    function testLocalStorage() {
      try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        sessionStorage.setItem('test', 'test');
        sessionStorage.removeItem('test');
        return true;
      } catch (e) {
        return false;
      }
    }

    // Initialize on page load
    setTimeout(async () => {
      if (!testLocalStorage()) {
        showToast('Warning: Browser storage disabled - data will not persist');
      }
      const statusEl = document.getElementById('sessionStatus');
      statusEl.textContent = '‚è≥ Restoring...';
      statusEl.style.color = 'var(--orange)';
      const restored = await restoreSession();
      if (restored) {
        statusEl.textContent = `‚úì Restored ${results.length} records`;
        statusEl.style.color = 'var(--green)';
      } else {
        statusEl.textContent = 'No saved session ‚Äî upload CSV';
        statusEl.style.color = 'var(--text-muted)';
      }
      initCampaigns();
    }, 100);
</script>
</body>
</html>
